{% extends "calendario/base.html" %}

{% block title %}Configuración de reglas operativas{% endblock %}

{% block content %}
  <div class="flex flex-col gap-8">
    <div class="rounded-lg border border-slate-200 bg-white/90 p-5 text-sm text-slate-600">
      <h1 class="text-lg font-semibold text-slate-900">Configura reglas de descanso y sobrecarga</h1>
      <p class="mt-2">Actualiza estas políticas únicamente cuando cambien las condiciones laborales. Los calendarios generados toman estos parámetros como fuente única de verdad.</p>
      <p class="mt-2 text-xs text-slate-500">Las reglas aplican a todos los calendarios generados después de la actualización.</p>
    </div>

    <div
      id="configurator-app"
      class="space-y-8"
      data-view="rules"
      data-metadata-url="{% url 'calendario-api:calendar-metadata' %}"
      data-generate-url="{% url 'calendario-api:calendar-generate' %}"
      data-summary-url-template="{% url 'calendario-api:calendar-summary' 0 %}"
      data-assignments-url-template="{% url 'calendario-api:calendar-assignments' 0 %}"
      data-eligible-url-template="{% url 'calendario-api:calendar-eligible-operators' 0 %}"
      data-calendar-detail-url-template="{% url 'calendario:calendar-detail' 0 %}"
      data-dashboard-url="{% url 'calendario:dashboard' %}"
      data-positions-url="{% url 'calendario-api:calendar-positions' %}"
      data-position-detail-url-template="{% url 'calendario-api:calendar-position-detail' 0 %}"
      data-position-reorder-url="{% url 'calendario-api:calendar-position-reorder' %}"
      data-capabilities-url="{% url 'calendario-api:calendar-capabilities' %}"
      data-capability-detail-url-template="{% url 'calendario-api:calendar-capability-detail' 0 %}"
      data-operators-url="{% url 'calendario-api:calendar-operators' %}"
      data-operator-detail-url-template="{% url 'calendario-api:calendar-operator-detail' 0 %}"
      data-rest-rules-url="{% url 'calendario-api:calendar-rest-rules' %}"
      data-rest-rule-detail-url-template="{% url 'calendario-api:calendar-rest-rule-detail' 0 %}"
      data-overload-rules-url="{% url 'calendario-api:calendar-overload-rules' %}"
      data-overload-rule-detail-url-template="{% url 'calendario-api:calendar-overload-rule-detail' 0 %}"
    >
      <div id="metadata-status" class="rounded border border-slate-200 bg-slate-50 px-4 py-2 text-xs text-slate-500">Cargando información…</div>

      <section data-step-index="1" class="space-y-6 rounded-xl border border-slate-200 bg-white/95 p-6 shadow-sm">
        <header class="flex flex-col gap-1">
          <h2 class="text-xl font-semibold text-slate-900">Reglas activas</h2>
          <p class="text-sm text-slate-600">Gestiona descansos obligatorios por rol y los márgenes de sobrecarga por categoría. Los cambios aplican inmediatamente al motor de generación.</p>
        </header>

        <div class="flex flex-wrap gap-2">
          <button type="button" id="rest-rule-add-btn" class="rounded border border-emerald-300 px-3 py-1 text-sm font-medium text-emerald-700 hover:bg-emerald-100">Nueva regla de descanso</button>
          <button type="button" id="overload-add-btn" class="rounded border border-blue-300 px-3 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100">Nueva regla de sobrecarga</button>
        </div>

        <div class="grid gap-6 lg:grid-cols-2">
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-slate-800">Reglas de descanso</h3>
              <span id="rest-rule-count" class="text-xs text-slate-500">0 reglas</span>
            </div>
            <div id="rest-rules-list" class="space-y-3 text-sm text-slate-600">
              <p class="rounded border border-slate-200 bg-slate-50 px-4 py-3 text-slate-500">Sin información disponible.</p>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-slate-800">Reglas de sobrecarga</h3>
              <span id="overload-count" class="text-xs text-slate-500">0 reglas</span>
            </div>
            <div id="overload-list" class="space-y-3 text-sm text-slate-600">
              <p class="rounded border border-slate-200 bg-slate-50 px-4 py-3 text-slate-500">Sin información disponible.</p>
            </div>
            <div class="rounded border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600">
              <p class="font-semibold text-slate-700">¿Cómo funcionan?</p>
              <p class="mt-2">Cada categoría hereda un límite base (3 días para turnos diurnos, 2 para nocturnos). Las reglas aquí registradas permiten ajustar ese límite para un turno en particular y definir cuántos puntos suma cada día adicional.</p>
            </div>
          </div>
        </div>

        <div id="rest-rule-form-wrapper" class="hidden rounded-lg border border-emerald-200 bg-emerald-50 p-4 text-sm">
          <form id="rest-rule-form" class="grid gap-4 md:grid-cols-2">
            <input type="hidden" id="rest-rule-id" />

            <label class="flex flex-col text-sm text-slate-700">
              Rol
              <select id="rest-rule-role" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand"></select>
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Turno
              <select id="rest-rule-shift" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand"></select>
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Descanso cada (días)
              <input id="rest-rule-min-frequency" type="number" min="1" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Mínimo consecutivos
              <input id="rest-rule-min-consecutive" type="number" min="1" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Máximo consecutivos
              <input id="rest-rule-max-consecutive" type="number" min="1" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Descanso post turno
              <input id="rest-rule-post-shift" type="number" min="0" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Descansos mensuales
              <input id="rest-rule-monthly-rest" type="number" min="1" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
            </label>

            <label class="flex items-center gap-2 text-sm text-slate-700">
              <input id="rest-rule-enforce" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-brand focus:ring-brand" />
              Exigir descanso adicional cuando se supere el máximo consecutivo
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Vigente desde
              <input id="rest-rule-active-from" type="date" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Vigente hasta
              <input id="rest-rule-active-until" type="date" class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
            </label>

            <div id="rest-rule-preferences" class="md:col-span-2 grid gap-3 rounded-lg border border-white/60 bg-white/50 p-3 text-xs text-slate-600"></div>

            <div id="rest-rule-form-message" class="hidden md:col-span-2 rounded border px-3 py-2 text-sm"></div>

            <div class="flex items-center justify-end gap-2 md:col-span-2">
              <button type="button" id="rest-rule-cancel-btn" class="rounded border border-slate-300 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">Cancelar</button>
              <button type="submit" class="inline-flex items-center rounded bg-brand px-4 py-2 text-sm font-semibold text-white shadow hover:bg-brand-dark">Guardar regla de descanso</button>
            </div>
          </form>
        </div>

        <div id="overload-form-wrapper" class="hidden rounded-lg border border-blue-200 bg-blue-50 p-4 text-sm">
          <form id="overload-form" class="grid gap-4 md:grid-cols-2">
            <input type="hidden" id="overload-id" />

            <label class="flex flex-col text-sm text-slate-700">
              Categoría
              <select id="overload-category" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand"></select>
              <span id="overload-category-hint" class="mt-1 text-xs text-slate-500"></span>
            </label>

            <div class="flex flex-col text-sm text-slate-700">
              Turno asociado
              <span id="overload-shift-label" class="mt-1 inline-flex items-center rounded border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600"></span>
              <span class="mt-1 text-xs text-slate-500">El turno se define automáticamente según la categoría seleccionada.</span>
            </div>

            <label class="flex flex-col text-sm text-slate-700">
              Máximo días extra consecutivos
              <input id="overload-max-extra" type="number" min="1" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
              <span id="overload-max-extra-hint" class="mt-1 text-xs text-slate-500"></span>
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Puntos por día extra
              <input id="overload-points" type="number" min="1" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand" />
            </label>

            <label class="flex flex-col text-sm text-slate-700">
              Nivel de alerta
              <select id="overload-alert" required class="mt-1 rounded border border-slate-300 px-3 py-2 focus:border-brand focus:outline-none focus:ring-1 focus:ring-brand"></select>
            </label>

            <div id="overload-form-message" class="hidden md:col-span-2 rounded border px-3 py-2 text-sm"></div>

            <div class="flex items-center justify-end gap-2 md:col-span-2">
              <button type="button" id="overload-cancel-btn" class="rounded border border-slate-300 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">Cancelar</button>
              <button type="submit" class="inline-flex items-center rounded bg-brand px-4 py-2 text-sm font-semibold text-white shadow hover:bg-brand-dark">Guardar regla de sobrecarga</button>
            </div>
          </form>
        </div>

        <div class="grid gap-3 rounded-lg border border-sky-200 bg-sky-50 p-4 text-sm text-sky-800">
          <p class="font-semibold">Recomendación</p>
          <p>Valida cambios con el equipo legal o de seguridad laboral antes de aplicar nuevas reglas. Puedes volver en cualquier momento para ajustar vigencias.</p>
        </div>

        <div class="flex flex-wrap gap-2">
          <a href="{% url 'calendario:configurator' %}" class="rounded border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">Ir al generador de calendarios</a>
          <a href="{% url 'calendario:dashboard' %}" class="rounded border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">Volver al panel</a>
        </div>
      </section>
    </div>
  </div>

  {% include "calendario/partials/configurator_app_scripts.html" %}
{% endblock %}
