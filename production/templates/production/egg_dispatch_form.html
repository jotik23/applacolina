{% extends "calendario/base.html" %}
{% load humanize form_extras %}

{% block title %}{{ page_title|default:"Despachos" }}{% endblock %}

{% block content %}
  {% include "production/_submenu.html" with active=active_submenu %}

  <div class="space-y-6">
    <header class="rounded-2xl border border-slate-200/70 bg-white px-5 py-4 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600">Cadena log√≠stica</p>
      <h1 class="text-2xl font-semibold text-slate-900">{{ page_title|default:"Registrar despacho" }}</h1>
      <p class="text-sm text-slate-500">
        Cada despacho descuenta cartones clasificados disponibles. Verifica la disponibilidad antes de confirmar.
      </p>
    </header>

    <div class="grid gap-6 lg:grid-cols-12">
      <form method="post" class="space-y-5 rounded-2xl border border-slate-200/70 bg-white px-5 py-4 shadow-sm lg:col-span-7">
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm font-semibold text-rose-700">
            {% for error in form.non_field_errors %}
              <p>{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}

        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label for="{{ form.date.id_for_label }}" class="text-sm font-semibold text-slate-700">Fecha</label>
            {{ form.date }}
            {% for error in form.date.errors %}
              <p class="text-xs text-rose-600">{{ error }}</p>
            {% endfor %}
          </div>
          <div>
            <label for="{{ form.destination.id_for_label }}" class="text-sm font-semibold text-slate-700">Destino</label>
            {{ form.destination }}
            {% for error in form.destination.errors %}
              <p class="text-xs text-rose-600">{{ error }}</p>
            {% endfor %}
          </div>
          <div>
            <label for="{{ form.driver.id_for_label }}" class="text-sm font-semibold text-slate-700">Conductor</label>
            {{ form.driver }}
            {% for error in form.driver.errors %}
              <p class="text-xs text-rose-600">{{ error }}</p>
            {% endfor %}
          </div>
          <div>
            <label for="{{ form.seller.id_for_label }}" class="text-sm font-semibold text-slate-700">Vendedor responsable</label>
            {{ form.seller }}
            {% for error in form.seller.errors %}
              <p class="text-xs text-rose-600">{{ error }}</p>
            {% endfor %}
          </div>
        </div>

        <section class="rounded-2xl border border-slate-100 bg-slate-50/60 p-4">
          <header class="flex items-center justify-between border-b border-slate-200 pb-2">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Detalle del despacho</p>
              <h2 class="text-sm font-semibold text-slate-900">Cartones por tipo</h2>
            </div>
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Inventario total: {{ inventory_total|cartons }} cart
            </span>
          </header>
          <div class="overflow-x-auto">
            <table class="mt-3 w-full border-collapse text-sm text-slate-600">
              <thead>
                <tr class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                  <th class="px-3 py-2 text-left">Tipo</th>
                  <th class="px-3 py-2 text-right">Disponible</th>
                  <th class="px-3 py-2 text-right">Cartones a despachar</th>
                </tr>
              </thead>
              <tbody>
                {% for row in type_rows %}
                  <tr class="border-t border-slate-100">
                    <td class="px-3 py-2 font-semibold text-slate-900">{{ row.label }}</td>
                    <td class="px-3 py-2 text-right text-sm text-slate-500">{{ row.available|cartons }} cart</td>
                    <td class="px-3 py-2 text-right">
                      {{ row.field }}
                      {% for error in row.field.errors %}
                        <p class="text-xs text-rose-600">{{ error }}</p>
                      {% endfor %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>

        <div>
          <label for="{{ form.notes.id_for_label }}" class="text-sm font-semibold text-slate-700">Notas</label>
          {{ form.notes }}
          {% for error in form.notes.errors %}
            <p class="text-xs text-rose-600">{{ error }}</p>
          {% endfor %}
        </div>

        <div class="flex flex-wrap items-center justify-between gap-3">
          <a
            href="{{ cancel_url }}"
            class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-800"
          >
            Cancelar
          </a>
          <button
            type="submit"
            class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500"
          >
            {{ submit_label|default:"Guardar" }}
          </button>
        </div>
      </form>

      <aside class="space-y-4 rounded-2xl border border-slate-200/70 bg-white px-5 py-4 shadow-sm lg:col-span-5">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Inventario disponible</p>
          <h3 class="text-lg font-semibold text-slate-900">{{ inventory_total|cartons }} cart</h3>
        </div>
        {% if inventory_rows %}
          <table class="w-full border-collapse text-sm text-slate-600">
            <tbody>
              {% for row in inventory_rows %}
                <tr class="border-t border-slate-100">
                  <td class="px-3 py-2 font-semibold text-slate-900">{{ row.label }}</td>
                  <td class="px-3 py-2 text-right font-semibold text-slate-800">{{ row.cartons|cartons }} cart</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-sm text-slate-500">No hay inventario disponible para despacho.</p>
        {% endif %}
      </aside>
    </div>
  </div>
{% endblock %}
