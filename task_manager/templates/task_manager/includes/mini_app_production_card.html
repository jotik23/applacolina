{% load humanize %}

{% if mini_app_card_permissions.production %}
            {% with production=telegram_mini_app.production %}
              {% if production %}
                {% with production_has_records=production.has_records %}
                  {% with card_tone=production_has_records|yesno:'border border-emerald-200 bg-gradient-to-br from-white via-emerald-50/90 to-slate-50/80 shadow-emerald-200/60,border border-rose-200 bg-gradient-to-br from-white via-rose-50/95 to-amber-50/80 shadow-rose-200/70' overlay_tone=production_has_records|yesno:'from-emerald-100/70 via-transparent to-transparent,from-rose-100/80 via-transparent to-transparent' headline_tone=production_has_records|yesno:'text-emerald-600,text-rose-600' %}
                    {% with button_classes=production_has_records|yesno:'inline-flex w-full items-center justify-center gap-3 rounded-2xl border border-emerald-200 bg-emerald-600 px-6 py-3 text-base font-semibold text-white shadow-lg shadow-emerald-200/70 transition hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-300/70,inline-flex w-full items-center justify-center gap-3 rounded-2xl border border-rose-200 bg-rose-600 px-6 py-3 text-base font-semibold text-white shadow-lg shadow-rose-200/70 transition hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-300/70' chip_classes=production_has_records|yesno:'inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-600,inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-100 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-rose-700 shadow-sm shadow-rose-200/60' section_shadow=production_has_records|yesno:'shadow-emerald-100/60,shadow-rose-100/60' field_focus=production_has_records|yesno:'focus:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200/60,focus:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-200/60' %}
                      <article
                        class="relative overflow-hidden rounded-3xl {{ card_tone }} p-5"
                        data-task-card
                        data-task-title="Registro de producci贸n diario"
                        data-production-card
                        data-production-active-hens="{{ telegram_mini_app.production_reference.active_hens|default:'' }}"
                        data-production-date="{{ production.date|default:'' }}"
                        data-production-submit-url="{{ production.submit_url|default:'' }}"
                      >
                        <div class="pointer-events-none absolute inset-y-0 right-0 hidden w-32 bg-gradient-to-l {{ overlay_tone }} sm:block"></div>
                        <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                          <div class="space-y-2">
                            <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide {{ headline_tone }}">
                              <span aria-hidden="true">{% if production_has_records %}{% else %}{% endif %}</span>
                              {% if production_has_records %}Registro actualizado{% else %}Tarea cr铆tica del d铆a{% endif %}
                            </p>
                            <h3 class="text-lg font-semibold text-slate-900">Registro de producci贸n diario</h3>
                            <p class="text-xs text-slate-600">
                              {{ production.weekday_label|default:'' }} 路 {{ production.date_label|default:'' }}
                              {% if production.position_label %} 路 {{ production.position_label }}{% endif %}
                              {% if production.chicken_house %} 路 {{ production.chicken_house }}{% endif %}
                            </p>
                          </div>
                          <div class="flex flex-col items-start gap-2 text-left sm:items-end sm:text-right">
                            <span class="{{ chip_classes }}">
                              <span class="h-2.5 w-2.5 rounded-full bg-current" aria-hidden="true"></span>
                              {% if production_has_records %}Datos registrados{% else %}Prioridad m谩xima{% endif %}
                            </span>
                            {% if production.farm %}
                              <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                                {{ production.farm }}
                              </span>
                            {% endif %}
                          </div>
                        </header>
                        <p class="mt-3 hidden text-xs font-semibold text-emerald-600" data-task-feedback></p>
                        {% if production.lots %}
                          <div class="mt-4 space-y-4">
                            {% for lot in production.lots %}
                              <section
                                class="rounded-2xl border border-white/60 bg-white/80 p-4 shadow-sm {{ section_shadow }}"
                                data-production-lot
                                data-batch-id="{{ lot.id }}"
                              >
                                <header class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
                                  <div>
                                    <h4 class="text-sm font-semibold text-slate-900">{{ lot.label }}</h4>
                                    <p class="text-xs text-slate-500">
                                      {% if lot.chicken_house %}{{ lot.chicken_house }}{% endif %}
                                      {% if lot.room_labels %} 路 Salones: {{ lot.room_labels|join:", " }}{% endif %}
                                      路 {{ lot.birds|intcomma }} aves
                                    </p>
                                  </div>
                                  <div class="text-xs text-slate-500 sm:text-right" data-production-lot-summary>
                                    <p>
                                      Producci贸n: <span class="font-semibold text-slate-900" data-production-total-label="production">{{ lot.record.production|default_if_none:0|floatformat:0 }}</span> huevos
                                    </p>
                                    <p>
                                      Consumo: <span class="font-semibold text-slate-900" data-production-total-label="consumption">{{ lot.record.consumption|default_if_none:0|floatformat:0 }}</span> kg
                                    </p>
                                    <p>
                                      Mortalidad: <span class="font-semibold text-slate-900" data-production-total-label="mortality">{{ lot.record.mortality|default:"0" }}</span> aves 路 Descarte: <span class="font-semibold text-slate-900" data-production-total-label="discard">{{ lot.record.discard|default:"0" }}</span>
                                    </p>
                                  </div>
                                </header>
                                <div class="mt-4 space-y-3" data-production-room-list>
                                  {% for room in lot.rooms %}
                                    <article
                                      class="rounded-xl border border-slate-200 bg-white/90 p-3 shadow-inner shadow-slate-100/60"
                                      data-production-room
                                      data-room-id="{{ room.id }}"
                                      data-room-label="{{ room.label }}"
                                      data-room-birds="{{ room.birds }}"
                                    >
                                      <header class="flex items-start justify-between gap-2">
                                        <div>
                                          <p class="text-sm font-semibold text-slate-900">{{ room.label }}</p>
                                          <p class="text-xs text-slate-500">{{ room.birds|intcomma }} aves asignadas</p>
                                        </div>
                                      </header>
                                      <div class="mt-3 grid gap-3 sm:grid-cols-2">
                                        <label class="flex flex-col gap-1 text-xs font-semibold text-slate-600">
                                          <span class="text-[11px] uppercase tracking-wide text-slate-400">
                                            Producci贸n (huevos)
                                            <span class="text-rose-500" aria-hidden="true">*</span>
                                            <span class="sr-only"> (requerido)</span>
                                          </span>
                                          <input
                                            type="number"
                                            step="1"
                                            min="0"
                                            inputmode="numeric"
                                            pattern="[0-9]*"
                                            class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 {{ field_focus }}"
                                            data-production-room-field="production"
                                            value="{{ room.production|default:'' }}"
                                    />
                                  </label>
                                        <label class="flex flex-col gap-1 text-xs font-semibold text-slate-600">
                                          <span class="text-[11px] uppercase tracking-wide text-slate-400">
                                            Consumo (kg)
                                            <span class="text-rose-500" aria-hidden="true">*</span>
                                            <span class="sr-only"> (requerido)</span>
                                          </span>
                                          <input
                                            type="number"
                                            step="1"
                                            min="0"
                                      inputmode="numeric"
                                      pattern="[0-9]*"
                                      class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 {{ field_focus }}"
                                      data-production-room-field="consumption"
                                      value="{{ room.consumption|default:'' }}"
                                    />
                                  </label>
                                        <label class="flex flex-col gap-1 text-xs font-semibold text-slate-600">
                                          <span class="text-[11px] uppercase tracking-wide text-slate-400">Mortalidad (aves)</span>
                                          <input
                                            type="number"
                                            step="1"
                                            min="0"
                                            inputmode="numeric"
                                            class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 {{ field_focus }}"
                                            data-production-room-field="mortality"
                                            value="{{ room.mortality|default:'' }}"
                                          />
                                        </label>
                                        <label class="flex flex-col gap-1 text-xs font-semibold text-slate-600">
                                          <span class="text-[11px] uppercase tracking-wide text-slate-400">Descarte (aves)</span>
                                          <input
                                            type="number"
                                            step="1"
                                            min="0"
                                            inputmode="numeric"
                                            class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 {{ field_focus }}"
                                            data-production-room-field="discard"
                                            value="{{ room.discard|default:'' }}"
                                          />
                                        </label>
                                      </div>
                                    </article>
                                  {% endfor %}
                                </div>
                                <div class="mt-4 grid gap-3 sm:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] sm:items-center">
                                  <label class="flex flex-col gap-1 text-xs font-semibold text-slate-600">
                                    <span class="text-[11px] uppercase tracking-wide text-slate-400">Peso promedio del huevo (g)</span>
                                    <input
                                      type="number"
                                      step="1"
                                      min="0"
                                      inputmode="numeric"
                                      pattern="[0-9]*"
                                      class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 {{ field_focus }}"
                                      data-production-average
                                      value="{{ lot.record.average_egg_weight|default:'' }}"
                                    />
                                  </label>
                                  <p class="text-xs text-slate-500" data-production-last>
                                    {% if lot.record %}
                                      ltima actualizaci贸n: <span data-production-last-label>{{ lot.record.last_updated_label }}</span>
                                      {% if lot.record.last_actor %} 路 <span data-production-last-user>{{ lot.record.last_actor }}</span>{% endif %}
                                    {% else %}
                                      Sin registros previos para este lote.
                                    {% endif %}
                                  </p>
                                </div>
                              </section>
                            {% endfor %}
                          </div>
                        {% else %}
                          <div class="mt-4 rounded-2xl border border-dashed border-rose-300 bg-white/80 p-6 text-center text-sm text-rose-600">
                            <p class="font-semibold text-rose-700">Sin lotes asignados</p>
                            <p class="mt-1 text-xs text-rose-500">
                              No encontramos lotes activos asociados a tu posici贸n hoy. Si crees que es un error, contacta a tu l铆der.
                            </p>
                          </div>
                        {% endif %}
                        <div class="mt-6">
                          <button
                            type="button"
                            class="{{ button_classes }}"
                            data-task-action="complete-production"
                            data-production-submit-button
                          >
                            <span aria-hidden="true" data-production-button-icon></span>
                            <span data-production-button-label>Guardar</span>
                          </button>
                        </div>
                        <div
                          class="mt-4 hidden rounded-2xl border border-emerald-200 bg-emerald-50/90 p-3 text-xs text-emerald-700 shadow-inner shadow-emerald-100/60"
                          data-production-complete-banner
                        >
                          <p class="font-semibold text-emerald-700">隆Registro listo!</p>
                          <p>Datos guardados correctamente. Si necesitas cambios, actualiza los valores y guarda nuevamente.</p>
                        </div>
                      </article>
                    {% endwith %}
                  {% endwith %}
                {% endwith %}
              {% endif %}
            {% endwith %}
          {% endif %}
