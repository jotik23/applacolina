{% load humanize %}

{% with purchases=telegram_mini_app.purchases %}
{% if purchases %}
{% if mini_app_card_permissions.purchase_overview or mini_app_card_permissions.purchase_management %}
<section class="space-y-3" id="tm-purchases">
  <div class="flex items-center justify-between gap-3 text-sm text-slate-600">
    <div>
      <h2 class="text-base font-semibold text-slate-900">Gesti√≥n de compras</h2>
      <p class="text-xs text-slate-600">Crea solicitudes, sigue el estado y marca la gesti√≥n sin salir del mini app.</p>
    </div>
    <div class="flex items-center gap-2">
      {% if purchases.composer %}
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-brand/30 bg-brand/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-brand transition hover:border-brand/50 hover:bg-brand/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
        data-purchase-request-launch
      >
        <span aria-hidden="true">Ôºã</span>
        <span>Solicitar compra</span>
      </button>
      {% endif %}
    </div>
  </div>

  {% if purchases.composer %}
  {{ purchases.composer|json_script:"tm-purchase-composer-data" }}
  <div class="space-y-4" data-purchase-compose-root data-composer-source="tm-purchase-composer-data">
    <div class="space-y-4" data-purchase-compose-container></div>
    <template data-purchase-compose-template>
      <article
        class="rounded-3xl border border-brand/20 bg-gradient-to-br from-white via-brand/5 to-indigo-50/40 p-5 shadow-xl shadow-brand/10"
        data-purchase-compose-card
        data-compose-purchase-id=""
      >
        <header class="flex flex-wrap items-start justify-between gap-3">
          <div>
            <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-brand">
              <span aria-hidden="true">üìù</span>
              Solicitar compra
            </p>
            <h3 class="text-lg font-semibold text-slate-900" data-compose-title>Nueva solicitud</h3>
            <p class="text-xs text-slate-600" data-compose-subtitle>Captura el requerimiento, agrega los √≠tems y guarda sin salir del mini app.</p>
          </div>
          <div class="flex items-center gap-2 text-xs text-slate-500">
            <span class="hidden sm:inline-flex" data-compose-reference></span>
            <button
              type="button"
              class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-500 hover:border-slate-300 hover:text-slate-900"
              data-compose-close
            >
              Cerrar
            </button>
          </div>
        </header>
        <form class="mt-4 space-y-4" data-purchase-compose-form autocomplete="off">
          <div class="grid gap-3 sm:grid-cols-2">
            <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
              Nombre del requerimiento
              <input
                type="text"
                class="mt-1 w-full rounded-2xl border border-white/60 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
                placeholder="Ej. Insumos bioseguridad"
                data-compose-field="summary"
              >
              <span class="mt-1 hidden text-[11px] font-semibold text-rose-600" data-compose-error="summary"></span>
            </label>
            <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
              Categor√≠a
              <select
                class="mt-1 w-full rounded-2xl border border-white/60 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
                data-compose-field="expense_type_id"
              >
                <option value="">Selecciona una categor√≠a</option>
              </select>
              <span class="mt-1 hidden text-[11px] font-semibold text-rose-600" data-compose-error="expense_type_id"></span>
            </label>
          </div>
          <div class="grid gap-3 lg:grid-cols-2">
            <div class="grid gap-3 sm:grid-cols-2">
              <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                √Årea
                <select
                  class="mt-1 w-full rounded-2xl border border-white/60 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
                  data-compose-field="scope"
                >
                  <option value="">Selecciona el alcance</option>
                </select>
                <span class="mt-1 hidden text-[11px] font-semibold text-rose-600" data-compose-error="scope_area"></span>
              </label>
              <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                Gestor asignado
                <select
                  class="mt-1 w-full rounded-2xl border border-white/60 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
                  data-compose-field="assigned_manager_id"
                >
                  <option value="">Selecciona un gestor</option>
                </select>
              </label>
            </div>
            <div class="grid gap-3 sm:grid-cols-2" data-compose-area-fields>
              <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500" data-area-field="farm_id">
                Granja
                <select
                  class="mt-1 w-full rounded-2xl border border-white/60 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
                  data-area-input
                >
                  <option value="">Selecciona la granja</option>
                </select>
              </label>
              <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500" data-area-field="chicken_house_id">
                Galp√≥n
                <select
                  class="mt-1 w-full rounded-2xl border border-white/60 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
                  data-area-input
                >
                  <option value="">Selecciona el galp√≥n</option>
                </select>
              </label>
            </div>
          </div>
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
            Proveedor
            <select
              class="mt-1 w-full rounded-2xl border border-white/60 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
              data-compose-field="supplier_id"
            >
              <option value="">Selecciona un proveedor</option>
            </select>
            <span class="mt-1 hidden text-[11px] font-semibold text-rose-600" data-compose-error="supplier_id"></span>
          </label>
          <section class="rounded-2xl border border-slate-200 bg-white/95 p-4 shadow-inner shadow-slate-100" data-compose-items-root>
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">√çtems solicitados</p>
                <p class="text-xs text-slate-500">Mant√©n los valores compactos y evita duplicados.</p>
              </div>
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 hover:border-slate-300 hover:text-slate-900"
                data-compose-add-item
              >
                <span aria-hidden="true">Ôºã</span>
                Agregar √≠tem
              </button>
            </div>
            <div class="mt-3 space-y-3" data-compose-items-container></div>
            <span class="mt-2 hidden text-[11px] font-semibold text-rose-600" data-compose-error="items"></span>
          </section>
          <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-slate-50/80 px-4 py-3">
            <div>
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Total estimado</p>
              <p class="text-lg font-semibold text-slate-900" data-compose-total>$¬†0</p>
            </div>
            <div class="flex flex-col gap-2 sm:flex-row">
              <button
                type="button"
                class="inline-flex items-center justify-center rounded-full border border-slate-300 px-4 py-2 text-[11px] font-semibold uppercase tracking-wide text-slate-600 hover:border-slate-400 hover:text-slate-900"
                data-compose-action="save_draft"
              >
                Guardar solicitud
              </button>
              <button
                type="button"
                class="inline-flex items-center justify-center rounded-full border border-brand bg-brand px-4 py-2 text-[11px] font-semibold uppercase tracking-wide text-white shadow-sm shadow-brand/40 hover:bg-brand/90"
                data-compose-action="send_workflow"
              >
                Enviar a aprobaci√≥n
              </button>
            </div>
          </div>
          <p class="hidden text-[11px] font-semibold" data-compose-feedback></p>
        </form>
      </article>
    </template>
    <template data-purchase-compose-item-template>
      <article class="rounded-2xl border border-slate-100 bg-white/95 p-3 shadow-inner shadow-slate-50" data-compose-item-row>
        <input type="hidden" data-item-field="id">
        <div class="flex flex-wrap items-start justify-between gap-2">
          <label class="grow text-[11px] font-semibold uppercase tracking-wide text-slate-500">
            Descripci√≥n
            <input
              type="text"
              class="mt-1 w-full rounded-xl border border-slate-100 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
              placeholder="Ej. Guantes nitrilo"
              data-item-field="description"
            >
            <span class="mt-1 hidden text-[11px] font-semibold text-rose-600" data-item-error="description"></span>
          </label>
          <button
            type="button"
            class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-500 hover:border-slate-300 hover:text-slate-900"
            data-compose-remove-item
          >
            Quitar
          </button>
        </div>
        <div class="mt-3 grid gap-3 sm:grid-cols-3">
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
            Cantidad
            <input
              type="number"
              step="0.01"
              min="0"
              class="mt-1 w-full rounded-xl border border-slate-100 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
              data-item-field="quantity"
            >
            <span class="mt-1 hidden text-[11px] font-semibold text-rose-600" data-item-error="quantity"></span>
          </label>
          <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
            Valor unitario
            <input
              type="number"
              step="0.01"
              min="0"
              class="mt-1 w-full rounded-xl border border-slate-100 bg-white px-3 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-brand/40 focus:outline-none"
              data-item-field="unit_value"
            >
            <span class="mt-1 hidden text-[11px] font-semibold text-rose-600" data-item-error="estimated_amount"></span>
          </label>
          <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50/70 px-3 py-2 text-sm text-slate-600">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Subtotal</p>
            <p class="mt-1 text-base font-semibold text-slate-900" data-item-subtotal>$¬†0</p>
          </div>
        </div>
      </article>
    </template>
  </div>
  {% endif %}

  <div class="space-y-4">
    {% if mini_app_card_permissions.purchase_overview and purchases.overview %}
    {% with overview=purchases.overview %}
    <article class="rounded-3xl border border-slate-200 bg-white/95 p-5 shadow-lg shadow-slate-200/60" data-purchase-requests-card>
      <header class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
            <span aria-hidden="true">üìã</span>
            Mis compras
          </p>
          <h3 class="text-lg font-semibold text-slate-900">{{ overview.title }}</h3>
          <p class="text-xs text-slate-600">{{ overview.subtitle }}</p>
        </div>
      </header>

      <div class="mt-4 space-y-3" data-purchase-requests-list>
        {% if overview.entries %}
          {% for entry in overview.entries %}
          <article
            class="rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-inner shadow-slate-50"
            data-purchase-request-entry
            data-entry-id="{{ entry.id }}"
            data-entry-can-edit="{{ entry.can_edit|yesno:'true,false' }}"
          >
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400" data-entry-code>{{ entry.code }}</p>
                <h4 class="text-sm font-semibold text-slate-900" data-entry-name>{{ entry.name }}</h4>
                <p class="text-xs text-slate-500" data-entry-area>{{ entry.area_label }}</p>
              </div>
              <div class="flex flex-col items-end gap-2" data-entry-actions>
                <span
                  class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {% if entry.stage_is_alert %}border-rose-200 bg-rose-50 text-rose-700{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}"
                  data-entry-stage-chip
                  data-entry-stage-alert="{{ entry.stage_is_alert|yesno:'true,false' }}"
                >
                  {{ entry.stage_label }}
                </span>
                <span
                  class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {% if entry.status_theme == 'amber' %}border-amber-200 bg-amber-50 text-amber-700{% elif entry.status_theme == 'brand' %}border-brand/40 bg-brand/10 text-brand{% elif entry.status_theme == 'indigo' %}border-indigo-200 bg-indigo-50 text-indigo-700{% elif entry.status_theme == 'emerald' %}border-emerald-200 bg-emerald-50 text-emerald-700{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}"
                  data-entry-status-chip
                >
                  {{ entry.status_label }}
                </span>
                {% if entry.can_edit %}
                <button
                  type="button"
                  class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 hover:border-brand/40 hover:text-brand"
                  data-purchase-request-edit
                >
                  Editar
                </button>
                {% endif %}
              </div>
            </div>
            <dl class="mt-3 grid grid-cols-1 gap-3 text-xs text-slate-600 sm:grid-cols-3">
              <div>
                <dt class="font-semibold uppercase tracking-wide text-slate-500">Proveedor</dt>
                <dd class="mt-0.5 text-slate-900" data-entry-supplier>{{ entry.supplier_label }}</dd>
              </div>
              <div>
                <dt class="font-semibold uppercase tracking-wide text-slate-500">Categor√≠a</dt>
                <dd class="mt-0.5 text-slate-900" data-entry-category>{{ entry.category_label }}</dd>
              </div>
              <div>
                <dt class="font-semibold uppercase tracking-wide text-slate-500">Monto estimado</dt>
                <dd class="mt-0.5">
                  <span
                    class="inline-flex items-center rounded-xl bg-slate-100 px-2 py-1 text-sm font-semibold text-slate-900"
                    data-entry-amount
                  >
                    {{ entry.amount_label }}
                  </span>
                </dd>
              </div>
            </dl>
            <p class="mt-2 text-[11px] text-slate-500" data-entry-updated>{{ entry.updated_label }}</p>
            <details class="mt-3 rounded-2xl border border-slate-100 bg-white/80 p-3" data-purchase-entry-details>
              <summary
                class="flex cursor-pointer list-none items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 shadow-sm shadow-slate-100 transition hover:border-slate-300 hover:text-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-200"
              >
                <span aria-hidden="true">‚ñº</span>
                <span>Ver detalle</span>
              </summary>
              <div class="mt-3 space-y-4 rounded-2xl border border-slate-100 bg-slate-50/70 p-4">
                <section>
                  <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">√çtems solicitados</p>
                  <div class="mt-2 space-y-2" data-entry-items></div>
                </section>
                <section data-entry-payment-details>
                  <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Datos de pago</p>
                  <dl class="mt-2 grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
                    <div>
                      <dt class="uppercase tracking-wide text-slate-500">Condici√≥n</dt>
                      <dd class="mt-0.5 font-semibold text-slate-900" data-entry-payment-payment_condition></dd>
                    </div>
                    <div>
                      <dt class="uppercase tracking-wide text-slate-500">Medio</dt>
                      <dd class="mt-0.5 font-semibold text-slate-900" data-entry-payment-payment_method></dd>
                    </div>
                    <div>
                      <dt class="uppercase tracking-wide text-slate-500">Cuenta destino</dt>
                      <dd class="mt-0.5 font-semibold text-slate-900" data-entry-payment-payment_account></dd>
                    </div>
                    <div>
                      <dt class="uppercase tracking-wide text-slate-500">Fecha de pago</dt>
                      <dd class="mt-0.5 font-semibold text-slate-900" data-entry-payment-payment_date></dd>
                    </div>
                  </dl>
                </section>
                <section data-entry-reception-details>
                  <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Recepci√≥n y entrega</p>
                  <dl class="mt-2 grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
                    <div>
                      <dt class="uppercase tracking-wide text-slate-500">Condici√≥n de entrega</dt>
                      <dd class="mt-0.5 font-semibold text-slate-900" data-entry-reception-delivery_condition></dd>
                    </div>
                    <div>
                      <dt class="uppercase tracking-wide text-slate-500">ETA</dt>
                      <dd class="mt-0.5 font-semibold text-slate-900" data-entry-reception-eta></dd>
                    </div>
                    <div class="sm:col-span-2">
                      <dt class="uppercase tracking-wide text-slate-500">Notas de entrega</dt>
                      <dd class="mt-0.5 text-slate-700" data-entry-reception-delivery_notes></dd>
                    </div>
                    <div class="sm:col-span-2">
                      <dt class="uppercase tracking-wide text-slate-500">Notas de recepci√≥n</dt>
                      <dd class="mt-0.5 text-slate-700" data-entry-reception-reception_notes></dd>
                    </div>
                    <div class="sm:col-span-2 hidden" data-entry-reception-alert>
                      <dt class="uppercase tracking-wide text-slate-500">Alertas</dt>
                      <dd class="mt-0.5 font-semibold text-rose-600" data-entry-reception-status_hint></dd>
                    </div>
                  </dl>
                </section>
              </div>
            </details>
          </article>
          {% endfor %}
        {% else %}
          <div
            class="rounded-2xl border border-dashed border-slate-200 bg-slate-50/60 px-4 py-5 text-center text-sm text-slate-500"
            data-purchase-requests-empty
          >
            <p class="font-semibold">{{ overview.empty_state.title }}</p>
            <p class="text-xs text-slate-500">{{ overview.empty_state.description }}</p>
          </div>
        {% endif %}
      </div>

      <template data-purchase-request-entry-template>
        <article class="rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-inner shadow-slate-50" data-purchase-request-entry data-entry-can-edit="false">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400" data-entry-code></p>
              <h4 class="text-sm font-semibold text-slate-900" data-entry-name></h4>
              <p class="text-xs text-slate-500" data-entry-area></p>
            </div>
            <div class="flex flex-col items-end gap-2" data-entry-actions>
              <span
                class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide border-slate-200 bg-slate-50 text-slate-600"
                data-entry-stage-chip
              ></span>
              <span class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide border-slate-200 bg-slate-50 text-slate-600" data-entry-status-chip></span>
              <button
                type="button"
                class="hidden inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 hover:border-brand/40 hover:text-brand"
                data-purchase-request-edit
              >
                Editar
              </button>
            </div>
          </div>
          <dl class="mt-3 grid grid-cols-1 gap-3 text-xs text-slate-600 sm:grid-cols-3">
            <div>
              <dt class="font-semibold uppercase tracking-wide text-slate-500">Proveedor</dt>
              <dd class="mt-0.5 text-slate-900" data-entry-supplier></dd>
            </div>
            <div>
              <dt class="font-semibold uppercase tracking-wide text-slate-500">Categor√≠a</dt>
              <dd class="mt-0.5 text-slate-900" data-entry-category></dd>
            </div>
            <div>
              <dt class="font-semibold uppercase tracking-wide text-slate-500">Monto estimado</dt>
              <dd class="mt-0.5">
                <span
                  class="inline-flex items-center rounded-xl bg-slate-100 px-2 py-1 text-sm font-semibold text-slate-900"
                  data-entry-amount
                ></span>
              </dd>
            </div>
          </dl>
          <p class="mt-2 text-[11px] text-slate-500" data-entry-updated></p>
          <details class="mt-3 rounded-2xl border border-slate-100 bg-white/80 p-3" data-purchase-entry-details>
            <summary
              class="flex cursor-pointer list-none items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 shadow-sm shadow-slate-100 transition hover:border-slate-300 hover:text-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-200"
            >
              <span aria-hidden="true">‚ñº</span>
              <span>Ver detalle</span>
            </summary>
            <div class="mt-3 space-y-4 rounded-2xl border border-slate-100 bg-slate-50/70 p-4">
              <section>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">√çtems solicitados</p>
                <div class="mt-2 space-y-2" data-entry-items></div>
              </section>
              <section data-entry-payment-details>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Datos de pago</p>
                <dl class="mt-2 grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
                  <div>
                    <dt class="uppercase tracking-wide text-slate-500">Condici√≥n</dt>
                    <dd class="mt-0.5 font-semibold text-slate-900" data-entry-payment-payment_condition></dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-slate-500">Medio</dt>
                    <dd class="mt-0.5 font-semibold text-slate-900" data-entry-payment-payment_method></dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-slate-500">Cuenta destino</dt>
                    <dd class="mt-0.5 font-semibold text-slate-900" data-entry-payment-payment_account></dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-slate-500">Fecha de pago</dt>
                    <dd class="mt-0.5 font-semibold text-slate-900" data-entry-payment-payment_date></dd>
                  </div>
                </dl>
              </section>
              <section data-entry-reception-details>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Recepci√≥n y entrega</p>
                <dl class="mt-2 grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
                  <div>
                    <dt class="uppercase tracking-wide text-slate-500">Condici√≥n de entrega</dt>
                    <dd class="mt-0.5 font-semibold text-slate-900" data-entry-reception-delivery_condition></dd>
                  </div>
                  <div>
                    <dt class="uppercase tracking-wide text-slate-500">ETA</dt>
                    <dd class="mt-0.5 font-semibold text-slate-900" data-entry-reception-eta></dd>
                  </div>
                  <div class="sm:col-span-2">
                    <dt class="uppercase tracking-wide text-slate-500">Notas de entrega</dt>
                    <dd class="mt-0.5 text-slate-700" data-entry-reception-delivery_notes></dd>
                  </div>
                  <div class="sm:col-span-2">
                    <dt class="uppercase tracking-wide text-slate-500">Notas de recepci√≥n</dt>
                    <dd class="mt-0.5 text-slate-700" data-entry-reception-reception_notes></dd>
                  </div>
                </dl>
              </section>
            </div>
          </details>
        </article>
      </template>
    </article>
    {% endwith %}
    {% endif %}

    {% if mini_app_card_permissions.purchase_approval and purchases.approvals %}
    {% with approval=purchases.approvals %}
    <article
      class="rounded-3xl border border-amber-100 bg-gradient-to-br from-white via-amber-50/40 to-slate-50 p-5 shadow-xl shadow-amber-100/70"
      data-purchase-approval-card
    >
      <header class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <h3 class="text-lg font-semibold text-slate-900">Aprueba y asigna gesti√≥n en minutos</h3>
          <p class="text-xs text-slate-600">
            Revisa la solicitud y asigna el gestor responsable.
          </p>
        </div>
      </header>

      <div class="mt-4 space-y-4" data-purchase-approval-list>
        {% if approval.entries %}
          {% for entry in approval.entries %}
          <article
            class="space-y-4"
            data-purchase-approval-entry
            data-entry-id="{{ entry.id }}"
            data-decision-url="{{ entry.decision_url }}"
          >
            <header class="space-y-2">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-amber-600">
                  <span aria-hidden="true">‚è≥</span>
                  Aprobaci√≥n pendiente
                </p>
                <span
                  class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {% if entry.status_theme == 'amber' %}border-amber-200 bg-amber-50 text-amber-700{% elif entry.status_theme == 'brand' %}border-brand/40 bg-brand/10 text-brand{% elif entry.status_theme == 'emerald' %}border-emerald-200 bg-emerald-50 text-emerald-700{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}"
                  data-entry-status
                >
                  {{ entry.status_label }}
                </span>
              </div>
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div>
                  <h4 class="text-base font-semibold text-slate-900" data-entry-name>{{ entry.name }}</h4>
                  <p class="text-xs text-slate-600">
                    <span class="font-semibold" data-entry-code>{{ entry.code }}</span>
                    ¬∑ <span data-entry-area>{{ entry.area_label }}</span>
                  </p>
                  <p class="text-[11px] text-slate-500" data-entry-role>Rol: {{ entry.role_label }}</p>
                  <p class="text-[11px] text-slate-500" data-entry-updated>{{ entry.updated_label }}</p>
                </div>
              </div>
            </header>
            <div class="mt-3 grid gap-2 text-xs text-slate-600 sm:grid-cols-2">
              <div class="rounded-2xl border border-white/70 bg-white/90 px-3 py-2 shadow-inner shadow-slate-100">
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Proveedor</p>
                <p class="text-sm font-semibold text-slate-900" data-entry-supplier>{{ entry.supplier_label }}</p>
              </div>
              <div class="rounded-2xl border border-white/70 bg-white/90 px-3 py-2 text-right shadow-inner shadow-slate-100">
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Monto estimado</p>
                <p class="text-lg font-semibold text-slate-900" data-entry-amount>{{ entry.amount_label }}</p>
                <p class="text-[11px] text-slate-500">C√≥digo <span data-entry-code-inline>{{ entry.code }}</span></p>
              </div>
            </div>
            <section class="mt-3 rounded-2xl border border-slate-100 bg-white/85 p-3 shadow-inner shadow-slate-50">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">√çtems solicitados</p>
              <div class="mt-2 space-y-2" data-entry-items>
                {% if entry.items %}
                  {% for item in entry.items %}
                  <article class="rounded-2xl border border-slate-100 bg-white px-3 py-2 text-xs text-slate-600 shadow-sm shadow-slate-100" data-approval-item>
                    <div class="flex items-start justify-between gap-2">
                      <p class="text-sm font-semibold text-slate-900" data-item-description>{{ item.description|default:"√çtem solicitado" }}</p>
                      {% if item.product_label %}
                      <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500" data-item-product>{{ item.product_label }}</p>
                      {% endif %}
                    </div>
                    <dl class="mt-2 grid gap-2 text-[11px] uppercase tracking-wide text-slate-500 sm:grid-cols-3">
                      <div>
                        <dt>Cantidad</dt>
                        <dd class="mt-0.5 text-base font-semibold normal-case text-slate-900" data-item-quantity>{{ item.requested_label }}</dd>
                      </div>
                      <div>
                        <dt>Valor unitario</dt>
                        <dd class="mt-0.5 text-base font-semibold normal-case text-slate-900" data-item-unit>{{ item.unit_value_label }}</dd>
                      </div>
                      <div>
                        <dt>Subtotal</dt>
                        <dd class="mt-0.5 text-base font-semibold normal-case text-slate-900" data-item-subtotal>{{ item.subtotal_label }}</dd>
                      </div>
                    </dl>
                  </article>
                  {% endfor %}
                {% else %}
                  <p class="text-xs text-slate-500" data-entry-items-empty>Sin √≠tems registrados.</p>
                {% endif %}
              </div>
            </section>
            <div class="mt-4 space-y-3">
              <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">
                Gestor asignado
                <select
                  class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-amber-300 focus:outline-none focus:ring-2 focus:ring-amber-100"
                  data-approval-manager-select
                >
                  <option value="">Selecciona un gestor</option>
                  {% for manager in approval.manager_options %}
                  <option value="{{ manager.id }}" {% if manager.id == entry.assigned_manager_id %}selected{% endif %}>
                    {{ manager.label }}
                  </option>
                  {% endfor %}
                </select>
              </label>
              <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">
                Nota (opcional)
                <textarea
                  rows="2"
                  class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-amber-300 focus:outline-none focus:ring-2 focus:ring-amber-100"
                  placeholder="Comentarios para el solicitante"
                  data-approval-note
                ></textarea>
              </label>
            </div>
            <p class="hidden text-[11px] font-semibold" data-approval-feedback></p>
            <div class="mt-3 flex flex-wrap gap-3">
              <button
                type="button"
                class="inline-flex flex-1 items-center justify-center rounded-full border border-rose-200 px-4 py-2 text-sm font-semibold text-rose-700 transition hover:border-rose-300 hover:text-rose-800 focus-visible:ring-2 focus-visible:ring-rose-100 sm:flex-none sm:px-5"
                data-approval-action="reject"
              >
                Rechazar solicitud
              </button>
              <button
                type="button"
                class="inline-flex flex-1 items-center justify-center rounded-full border border-emerald-200 bg-emerald-600/90 px-4 py-2 text-sm font-semibold text-white shadow-sm shadow-emerald-200 transition hover:bg-emerald-600 focus-visible:ring-2 focus-visible:ring-emerald-200 sm:flex-none sm:px-5"
                data-approval-action="approve"
              >
                Aprobar solicitud
              </button>
            </div>
          </article>
          {% endfor %}
        {% endif %}
      </div>

      <template data-purchase-approval-entry-template>
        <article class="space-y-4" data-purchase-approval-entry>
          <header class="space-y-2">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-amber-600">
                <span aria-hidden="true">‚è≥</span>
                Aprobaci√≥n pendiente
              </p>
              <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600" data-entry-status></span>
            </div>
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <h4 class="text-base font-semibold text-slate-900" data-entry-name></h4>
                <p class="text-xs text-slate-600">
                  <span class="font-semibold" data-entry-code></span>
                  ¬∑ <span data-entry-area></span>
                </p>
                <p class="text-[11px] text-slate-500" data-entry-role></p>
                <p class="text-[11px] text-slate-500" data-entry-updated></p>
              </div>
            </div>
          </header>
          <div class="mt-3 grid gap-2 text-xs text-slate-600 sm:grid-cols-2">
            <div class="rounded-2xl border border-white/70 bg-white/90 px-3 py-2 shadow-inner shadow-slate-100">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Proveedor</p>
              <p class="text-sm font-semibold text-slate-900" data-entry-supplier></p>
            </div>
            <div class="rounded-2xl border border-white/70 bg-white/90 px-3 py-2 text-right shadow-inner shadow-slate-100">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Monto estimado</p>
              <p class="text-lg font-semibold text-slate-900" data-entry-amount></p>
              <p class="text-[11px] text-slate-500">C√≥digo <span data-entry-code-inline></span></p>
            </div>
          </div>
          <section class="mt-3 rounded-2xl border border-slate-100 bg-white/85 p-3 shadow-inner shadow-slate-50">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">√çtems solicitados</p>
            <div class="mt-2 space-y-2" data-entry-items></div>
          </section>
          <div class="mt-4 space-y-3">
            <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">
              Gestor asignado
              <select
                class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-amber-300 focus:outline-none focus:ring-2 focus:ring-amber-100"
                data-approval-manager-select
              >
                <option value="">Selecciona un gestor</option>
              </select>
            </label>
            <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">
              Nota (opcional)
              <textarea
                rows="2"
                class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-900 shadow-inner shadow-slate-50 focus:border-amber-300 focus:outline-none focus:ring-2 focus:ring-amber-100"
                placeholder="Comentarios para el solicitante"
                data-approval-note
              ></textarea>
            </label>
          </div>
          <p class="hidden text-[11px] font-semibold" data-approval-feedback></p>
          <div class="mt-3 flex flex-wrap gap-3">
            <button
              type="button"
              class="inline-flex flex-1 items-center justify-center rounded-full border border-rose-200 px-4 py-2 text-sm font-semibold text-rose-700 transition hover:border-rose-300 hover:text-rose-800 focus-visible:ring-2 focus-visible:ring-rose-100 sm:flex-none sm:px-5"
              data-approval-action="reject"
            >
              Rechazar solicitud
            </button>
            <button
              type="button"
              class="inline-flex flex-1 items-center justify-center rounded-full border border-emerald-200 bg-emerald-600/90 px-4 py-2 text-sm font-semibold text-white shadow-sm shadow-emerald-200 transition hover:bg-emerald-600 focus-visible:ring-2 focus-visible:ring-emerald-200 sm:flex-none sm:px-5"
              data-approval-action="approve"
            >
              Aprobar solicitud
            </button>
          </div>
        </article>
      </template>
    </article>
    {% endwith %}
    {% endif %}

    {% if mini_app_card_permissions.purchase_management and purchases.management %}
    {% with management=purchases.management %}
    <article
      class="{% if not management.has_purchase or not management.purchase %}hidden {% endif %}rounded-3xl border border-indigo-100 bg-gradient-to-br from-white via-indigo-50/40 to-slate-50 p-5 shadow-xl shadow-indigo-100/70"
      data-purchase-management-card
      data-request-modify-url="{{ management.request_modification_url|default:'' }}"
      data-finalize-url="{{ management.finalize_url|default:'' }}"
      data-order-url="{{ management.order_url|default:'' }}"
      data-allows-finalize="{{ management.allow_finalize|yesno:'true,false' }}"
      data-allows-modification="{{ management.allow_modification|yesno:'true,false' }}"
    >
      {% with purchase=management.purchase %}
      <div data-management-view="detail" class="{% if not management.has_purchase or not purchase %}hidden{% endif %}">
      <header class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-indigo-600">
            <span aria-hidden="true">üßæ</span>
            Gesti√≥n actual
          </p>
          <h3 class="text-lg font-semibold text-slate-900" data-management-name>{{ purchase.name }}</h3>
          <p class="text-xs text-slate-600" data-management-location>{{ purchase.area_label }}</p>
        </div>
        <span
          class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {% if purchase.status_theme == 'indigo' %}border-indigo-200 bg-indigo-50 text-indigo-700{% elif purchase.status_theme == 'emerald' %}border-emerald-200 bg-emerald-50 text-emerald-700{% elif purchase.status_theme == 'brand' %}border-brand/40 bg-brand/10 text-brand{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}"
          data-management-status
        >
          {{ purchase.status_label }}
        </span>
      </header>
      <div class="mt-3 grid gap-2 text-xs text-slate-600 sm:grid-cols-2">
        <div class="rounded-2xl border border-white/70 bg-white/90 px-3 py-2 shadow-inner shadow-slate-100">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Proveedor</p>
          <p class="text-sm font-semibold text-slate-900" data-management-supplier>{{ purchase.supplier_label }}</p>
          <p class="text-[11px] text-slate-500" data-management-updated>{{ purchase.updated_label }}</p>
        </div>
        <div class="rounded-2xl border border-white/70 bg-white/90 px-3 py-2 text-right shadow-inner shadow-slate-100">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Monto estimado</p>
          <p class="text-lg font-semibold text-slate-900" data-management-amount>{{ purchase.amount_label }}</p>
          <p class="text-[11px] text-slate-500">C√≥digo <span data-management-code>{{ purchase.code }}</span></p>
        </div>
      </div>
      <section class="mt-3 rounded-2xl border border-slate-100 bg-white/85 p-3 shadow-inner shadow-slate-50">
        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">√çtems solicitados</p>
        <div class="mt-2 space-y-2">
          {% if purchase.items %}
            {% for item in purchase.items %}
            <article class="rounded-2xl border border-slate-100 bg-white px-3 py-2 text-xs text-slate-600 shadow-sm shadow-slate-100">
              <div class="flex items-start justify-between gap-2">
                <p class="text-sm font-semibold text-slate-900">{{ item.description|default:"√çtem solicitado" }}</p>
                {% if item.product_label %}
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">{{ item.product_label }}</p>
                {% endif %}
              </div>
              <dl class="mt-2 grid gap-2 text-[11px] uppercase tracking-wide text-slate-500 sm:grid-cols-4">
                <div>
                  <dt>Solicitado</dt>
                  <dd class="mt-0.5 text-base font-semibold normal-case text-slate-900">{{ item.requested_label }}</dd>
                </div>
                <div>
                  <dt>Recibido</dt>
                  <dd class="mt-0.5 text-base font-semibold normal-case text-slate-900">{{ item.received_label }}</dd>
                </div>
                <div>
                  <dt>Valor unitario</dt>
                  <dd class="mt-0.5 text-base font-semibold normal-case text-slate-900">{{ item.unit_value_label }}</dd>
                </div>
                <div>
                  <dt>Subtotal</dt>
                  <dd class="mt-0.5 text-base font-semibold normal-case text-slate-900">{{ item.subtotal_label }}</dd>
                </div>
              </dl>
            </article>
            {% endfor %}
          {% else %}
            <p class="text-xs text-slate-500">Sin √≠tems registrados.</p>
          {% endif %}
        </div>
      </section>

      <form class="mt-3 space-y-3 text-xs text-slate-700" data-management-form novalidate>
        <div class="grid gap-2 sm:grid-cols-2">
          <label class="flex flex-col gap-1 rounded-2xl border border-white/70 bg-white/90 px-3 py-2 shadow-inner shadow-slate-100">
            <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Fecha de compra</span>
            <input
              type="date"
              class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
              value="{{ purchase.form.purchase_date }}"
              data-management-field="purchase_date"
            />
            <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="purchase_date"></p>
          </label>
          <label class="flex flex-col gap-1 rounded-2xl border border-white/70 bg-white/90 px-3 py-2 shadow-inner shadow-slate-100">
            <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Condici√≥n de pago</span>
            <select
              class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
              data-management-field="payment_condition"
            >
              <option value="">Selecciona</option>
              {% for option in purchase.form.payment_conditions %}
              <option value="{{ option.id }}" {% if option.id == purchase.form.payment_condition %}selected{% endif %}>{{ option.label }}</option>
              {% endfor %}
            </select>
            <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="payment_condition"></p>
          </label>
          <label class="flex flex-col gap-1 rounded-2xl border border-white/70 bg-white/90 px-3 py-2 shadow-inner shadow-slate-100">
            <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Medio de pago</span>
            <select
              class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
              data-management-field="payment_method"
            >
              <option value="">Selecciona</option>
              {% for option in purchase.form.payment_methods %}
              <option value="{{ option.id }}" {% if option.id == purchase.form.payment_method %}selected{% endif %}>{{ option.label }}</option>
              {% endfor %}
            </select>
            <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="payment_method"></p>
          </label>
          <label class="flex flex-col gap-1 rounded-2xl border border-white/70 bg-white/90 px-3 py-2 shadow-inner shadow-slate-100">
            <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Condici√≥n de entrega</span>
            <select
              class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
              data-management-field="delivery_condition"
            >
              {% for option in purchase.form.delivery_conditions %}
              <option value="{{ option.id }}" {% if option.id == purchase.form.delivery_condition %}selected{% endif %}>{{ option.label }}</option>
              {% endfor %}
            </select>
            <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="delivery_condition"></p>
          </label>
        </div>
        <div
          class="grid gap-2 sm:grid-cols-2"
          data-management-shipping-fields
          {% if purchase.form.delivery_condition != 'shipping' %}hidden style="display:none"{% endif %}
        >
          <label class="flex flex-col gap-1 rounded-2xl border border-dashed border-indigo-100 bg-white px-3 py-2">
            <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Fecha estimada de llegada</span>
            <input
              type="date"
              class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
              value="{{ purchase.form.shipping_eta }}"
              data-management-field="shipping_eta"
            />
            <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="shipping_eta"></p>
          </label>
          <label class="flex flex-col gap-1 rounded-2xl border border-dashed border-indigo-100 bg-white px-3 py-2 sm:col-span-1">
            <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Notas de env√≠o</span>
            <textarea
              rows="2"
              class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
              data-management-field="shipping_notes"
            >{{ purchase.form.shipping_notes|default_if_none:'' }}</textarea>
          </label>
        </div>
        <details
          class="rounded-2xl border border-indigo-100 bg-white/90 px-3 py-2 text-slate-600 shadow-inner shadow-indigo-50"
          data-management-bank-panel
          {% if purchase.form.payment_method == 'transferencia' %}open{% else %}hidden style="display:none"{% endif %}
        >
          <summary class="flex cursor-pointer items-center justify-between gap-2 text-[11px] font-semibold uppercase tracking-wide text-indigo-600">
            <span>Datos bancarios del proveedor</span>
            <span aria-hidden="true">‚ñº</span>
          </summary>
          <div class="mt-3 grid gap-2 sm:grid-cols-2">
            <label class="flex flex-col gap-1">
              <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Titular</span>
              <input
                type="text"
                class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
                value="{{ purchase.form.supplier_account_holder_name }}"
                data-management-field="supplier_account_holder_name"
              />
              <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="supplier_account_holder_name"></p>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Identificaci√≥n</span>
              <input
                type="text"
                class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
                value="{{ purchase.form.supplier_account_holder_id }}"
                data-management-field="supplier_account_holder_id"
              />
              <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="supplier_account_holder_id"></p>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Tipo de cuenta</span>
              <select
                class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
                data-management-field="supplier_account_type"
              >
                <option value="">Selecciona</option>
                {% for option in purchase.form.account_types %}
                <option value="{{ option.id }}" {% if option.id == purchase.form.supplier_account_type %}selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
              </select>
              <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="supplier_account_type"></p>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">N√∫mero de cuenta</span>
              <input
                type="text"
                class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
                value="{{ purchase.form.supplier_account_number }}"
                data-management-field="supplier_account_number"
              />
              <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="supplier_account_number"></p>
            </label>
            <label class="flex flex-col gap-1 sm:col-span-2">
              <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Banco</span>
              <input
                type="text"
                class="rounded-xl border border-slate-200 px-2 py-1 text-sm text-slate-900"
                value="{{ purchase.form.supplier_bank_name }}"
                data-management-field="supplier_bank_name"
              />
              <p class="hidden text-[10px] font-semibold text-rose-600" data-management-error="supplier_bank_name"></p>
            </label>
          </div>
          <p class="mt-2 text-[10px] text-slate-500">Se sincronizan con la ficha del proveedor cuando guardas.</p>
        </details>
      </form>

      {% if purchase.notes %}
      <div class="mt-3 space-y-2">
        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Notas recientes</p>
        <ul class="space-y-2 text-xs text-slate-600" data-management-notes>
          {% for note in purchase.notes %}
          <li class="rounded-2xl border border-slate-100 bg-white/80 px-3 py-2 shadow-inner shadow-slate-50">{{ note }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <details class="mt-3 rounded-2xl border border-indigo-100 bg-white/85 px-3 py-2 text-xs text-slate-600 shadow-inner shadow-indigo-50">
        <summary class="flex cursor-pointer items-center justify-between gap-2 text-[11px] font-semibold uppercase tracking-wide text-indigo-600">
          <span>Solicitar modificaci√≥n</span>
          <span aria-hidden="true">‚ñº</span>
        </summary>
        <div class="mt-3 space-y-2">
          <label class="flex flex-col gap-1 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
            Motivo
            <textarea
              rows="2"
              class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-100"
              placeholder="Explica qu√© debe ajustarse (cantidad, proveedor, entrega, etc.)."
              data-purchase-modification-note
            ></textarea>
          </label>
          <div class="flex justify-end">
            <button
              type="button"
              class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 shadow-sm shadow-slate-100 transition hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:opacity-40"
              data-purchase-management-action="modify"
              {% if not management.allow_modification %}disabled{% endif %}
            >
              Solicitar modificar
            </button>
          </div>
        </div>
      </details>
      <p class="text-[11px] font-semibold text-indigo-600 hidden" data-purchase-management-feedback></p>

      <div class="mt-3 flex flex-wrap items-center justify-between gap-2">
        <div class="flex flex-wrap gap-2">
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-4 py-2 text-xs font-semibold text-emerald-700 shadow-sm hover:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200 disabled:opacity-50"
            data-purchase-management-action="save"
            data-management-intent="save_order"
          >
            Guardar cambios
          </button>
        </div>
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-indigo-600 px-4 py-2 text-xs font-semibold text-white shadow shadow-indigo-200/70 transition hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300/60 disabled:opacity-40"
          data-purchase-management-action="finalize"
          {% if not management.allow_finalize %}disabled{% endif %}
        >
          Finalizar gesti√≥n
        </button>
      </div>
      </div>
      {% endwith %}
      <div
        class="rounded-2xl border border-dashed border-slate-200 bg-white/70 px-4 py-5 text-center text-sm text-slate-500 {% if management.has_purchase and management.purchase %}hidden{% endif %}"
        data-management-view="empty"
      >
        <p class="font-semibold" data-management-empty-message>{{ management.message }}</p>
        <p class="text-xs text-slate-500">Cuando tengas una solicitud aprobada aparecer√° aqu√≠ para continuar con la gesti√≥n.</p>
      </div>
    </article>
    {% endwith %}
    {% endif %}
  </div>
</section>
{% endif %}
{% endif %}
{% endwith %}
