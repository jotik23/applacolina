{% for row in rows %}
  <tr
    id="task-definition-{{ row.id }}"
    data-task-definition-row="{{ row.id }}"
    data-display-order="{{ row.display_order }}"
    data-sort-name="{{ row.name|default_if_none:''|escape }}"
    data-sort-order="{{ row.display_order }}"
    data-sort-scope="{{ row.scope_label|default_if_none:''|escape }}"
    data-sort-schedule="{{ row.schedule_detail|default_if_none:''|escape }}"
    data-sort-responsible="{{ row.responsible_main|default_if_none:''|escape }}"
    data-sort-created="{{ row.created_on_display|default_if_none:''|escape }}"
    data-group-status-key="{{ row.group_status.key }}"
    data-group-status-label="{{ row.group_status.label|escape }}"
    data-group-status-subtitle="{{ row.group_status.subtitle|default_if_none:''|escape }}"
    data-group-category-key="{{ row.group_category.key }}"
    data-group-category-label="{{ row.group_category.label|escape }}"
    data-group-category-subtitle="{{ row.group_category.subtitle|default_if_none:''|escape }}"
    data-group-scope-key="{{ row.group_scope.key }}"
    data-group-scope-label="{{ row.group_scope.label|escape }}"
    data-group-scope-subtitle="{{ row.group_scope.subtitle|default_if_none:''|escape }}"
    data-group-scope-level="{{ row.scope_level }}"
    data-group-responsible-key="{{ row.group_responsible.key }}"
    data-group-responsible-label="{{ row.group_responsible.label|escape }}"
    data-group-responsible-subtitle="{{ row.group_responsible.subtitle|default_if_none:''|escape }}"
    data-group-task-type-key="{{ row.group_task_type.key }}"
    data-group-task-type-label="{{ row.group_task_type.label|escape }}"
    data-group-task-type-subtitle="{{ row.group_task_type.subtitle|default_if_none:''|escape }}"
    data-group-evidence-key="{{ row.group_evidence.key }}"
    data-group-evidence-label="{{ row.group_evidence.label|escape }}"
    data-group-evidence-subtitle="{{ row.group_evidence.subtitle|default_if_none:''|escape }}"
    data-group-mandatory-key="{{ row.group_mandatory.key }}"
    data-group-mandatory-label="{{ row.group_mandatory.label|escape }}"
    data-group-mandatory-subtitle="{{ row.group_mandatory.subtitle|default_if_none:''|escape }}"
    data-group-criticality-key="{{ row.group_criticality.key }}"
    data-group-criticality-label="{{ row.group_criticality.label|escape }}"
    data-group-criticality-subtitle="{{ row.group_criticality.subtitle|default_if_none:''|escape }}"
    class="align-top transform transition hover:-translate-y-[1px] odd:bg-white even:bg-slate-50/40 hover:bg-slate-100 border-l-4 border-transparent {% if row.is_one_time %}border-rose-200 hover:bg-rose-50/70{% endif %}"
  >
    <td class="px-5 py-5 align-top">
      <div class="flex items-start gap-3">
        <button
          type="button"
          class="tm-row-handle"
          data-task-drag-handle
          aria-label="Reordenar {{ row.name|escape }}"
        >
          <span class="tm-row-handle-icon" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </button>
        <div class="flex flex-1 flex-col gap-3">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div data-task-description-wrapper class="relative flex flex-col gap-1">
              <div class="flex flex-wrap items-center gap-2">
                <p class="text-base font-semibold text-slate-900 sm:text-lg">{{ row.name }}</p>
                {% if row.description %}
                  <button
                    type="button"
                    class="inline-flex items-center gap-1 rounded-full border border-brand/40 bg-brand/5 px-2.5 py-1 text-xs font-semibold uppercase tracking-wide text-brand transition hover:border-brand hover:bg-brand/10 hover:text-brand-dark focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/30 hidden"
                    data-task-description-toggle
                    data-target="task-description-{{ row.id }}"
                    aria-expanded="false"
                  >
                    <span data-toggle-text>Descripción</span>
                    <svg class="h-3 w-3 text-brand transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-toggle-icon>
                      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.24 4.24a.75.75 0 01-1.08 0l-4.24-4.24a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                  </button>
                {% endif %}
              </div>
              {% if row.description %}
                <p
                  id="task-description-{{ row.id }}"
                  class="hidden text-sm leading-relaxed text-slate-500 whitespace-pre-line"
                  data-task-description
                  data-state="collapsed"
                >
                  {{ row.description|linebreaksbr }}
                </p>
              {% endif %}
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2 text-xs font-semibold sm:text-[0.78rem]">
            <span class="inline-flex items-center gap-1 rounded-full border px-2.5 py-0.5 {% if row.status_is_active %}border-emerald-200 bg-emerald-50 text-emerald-700{% else %}border-slate-200 bg-slate-100 text-slate-500{% endif %}">
              <span class="h-1.5 w-1.5 rounded-full {% if row.status_is_active %}bg-emerald-500{% else %}bg-slate-400{% endif %}"></span>
              {{ row.status_label }}
            </span>
            <span class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-2.5 py-0.5 text-slate-600">
              {{ row.category_label }}
            </span>
            <span class="{{ row.mandatory_badge_class }}">
              {{ row.mandatory_label }}
            </span>
            <span class="{{ row.criticality_badge_class }}">
              {{ row.criticality_label }}
            </span>
            <span class="text-xs font-medium text-slate-400">Creada {{ row.created_on_display }}</span>
          </div>
        </div>
      </div>
    </td>
    <td class="px-5 py-5 align-top">
      <div class="flex flex-col gap-2 text-xs text-slate-600 sm:text-sm">
        <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-semibold {% if row.scope_level == 'general' %}border border-slate-200 bg-slate-50 text-slate-600{% elif row.scope_level == 'farm' %}border border-emerald-200 bg-emerald-50 text-emerald-700{% elif row.scope_level == 'house' %}border border-sky-200 bg-sky-50 text-sky-700{% else %}border border-purple-200 bg-purple-50 text-purple-700{% endif %}">
          {{ row.scope_badge_label }}
        </span>
        <p class="text-sm leading-relaxed text-slate-600">{{ row.scope_label }}</p>
      </div>
    </td>
    <td class="px-5 py-5 align-top text-xs text-slate-600 sm:text-sm" title="{{ row.schedule_summary }}">
      <div class="flex flex-col gap-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-500 sm:text-[0.8rem]">{{ row.task_type_label }}</span>
        <span class="text-sm font-medium {% if row.is_one_time %}text-rose-600{% else %}text-slate-500{% endif %}">
          {{ row.schedule_detail }}
        </span>
      </div>
    </td>
    <td class="px-5 py-5 align-top">
      <div class="space-y-1 text-xs text-slate-600 sm:text-sm">
        <p class="font-semibold text-slate-900">{{ row.responsible_main }}</p>
        {% if row.responsible_secondary %}
          <p class="text-slate-500">{{ row.responsible_secondary }}</p>
        {% endif %}
      </div>
    </td>
    <td class="px-5 py-5 align-top">
      <div class="flex items-center gap-3 text-xs font-semibold text-slate-600 sm:text-sm">
        <button
          type="button"
          class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white p-2 text-slate-500 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/30"
          data-task-action="edit"
          data-task-definition-id="{{ row.id }}"
          data-task-definition-detail-url="{{ row.detail_url }}"
          data-task-definition-update-url="{{ row.update_url }}"
          data-task-definition-name="{{ row.name|escape }}"
          aria-label="Editar {{ row.name }}"
        >
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path d="M13.586 2.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM12.172 4l-8.01 8.01a2 2 0 00-.533.96l-.611 2.922a.5.5 0 00.588.588l2.922-.611a2 2 0 00.96-.533L14 7.828 12.172 6l-.707.707 1.414 1.414-6.647 6.647a1 1 0 01-.48.267l-1.987.416.416-1.987a1 1 0 01.267-.48l6.647-6.647 1.414 1.414.707-.707L12.172 4z" />
          </svg>
        </button>
        <form method="post" action="{{ row.duplicate_url }}" class="contents">
          {% csrf_token %}
          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white p-2 text-slate-500 transition hover:border-emerald-300 hover:text-emerald-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-200"
            aria-label="Duplicar {{ row.name }}"
          >
            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M7 4a3 3 0 00-3 3v7a3 3 0 003 3h7a3 3 0 003-3V7a3 3 0 00-3-3H7zm0 1.5h7A1.5 1.5 0 0115.5 7v7a1.5 1.5 0 01-1.5 1.5H7A1.5 1.5 0 015.5 14V7A1.5 1.5 0 017 5.5z" />
              <path d="M5 2.5A2.5 2.5 0 002.5 5v8A2.5 2.5 0 005 15.5h1.25a.75.75 0 000-1.5H5A1 1 0 014 13V5a1 1 0 011-1h8a1 1 0 011 1v1.25a.75.75 0 001.5 0V5A2.5 2.5 0 0013 2.5H5z" />
            </svg>
          </button>
        </form>
        <form method="post" action="{% url 'task_manager:definition-delete' row.id %}" class="contents" data-confirmation>
          {% csrf_token %}
          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-full border border-rose-200 bg-white p-2 text-rose-600 transition hover:border-rose-300 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200"
            data-confirmation-trigger
            aria-label="Eliminar {{ row.name }}"
          >
            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M8.75 3a2 2 0 00-1.997 1.85l-.143 1.287H5a.75.75 0 000 1.5h.56l.69 7.416A2.25 2.25 0 008.491 17h3.018a2.25 2.25 0 002.24-1.947L14.44 7.637H15a.75.75 0 000-1.5h-1.61l-.143-1.287A2 2 0 0011.25 3h-2.5zm-.248 1.35a.5.5 0 01.498-.45h2.5a.5.5 0 01.499.45l.112 1.012H8.39l.112-1.012zm-.74 2.512a.75.75 0 011.496.076l-.257 5.318a.75.75 0 11-1.498-.075l.259-5.319zm4.477.076a.75.75 0 10-1.497.076l.26 5.318a.75.75 0 101.496-.075l-.259-5.319z" clip-rule="evenodd" />
            </svg>
          </button>
          <div class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-confirmation-overlay>
            <div class="w-full max-w-sm rounded-xl border border-slate-200 bg-white p-4 text-left text-sm shadow-lg">
              <p class="font-semibold text-slate-900">¿Eliminar esta tarea?</p>
              <p class="mt-1 text-xs text-slate-500">
                "{{ row.name }}" se eliminará y no estará disponible para nuevas asignaciones.
              </p>
              <div class="mt-3 flex justify-end gap-2">
                <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-confirmation-cancel data-confirmation-focus>Cancelar</button>
                <button type="button" class="inline-flex items-center rounded-full bg-rose-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-1" data-confirmation-confirm>Eliminar</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </td>
  </tr>
{% endfor %}
