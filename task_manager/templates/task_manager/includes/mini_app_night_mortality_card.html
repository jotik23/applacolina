{% load humanize %}

{% if mini_app_card_permissions.night_mortality %}
  {% with mortality=telegram_mini_app.night_mortality %}
    {% if mortality %}
      {% with has_records=mortality.has_records %}
        {% with card_tone=has_records|yesno:'border border-emerald-200 bg-gradient-to-br from-white via-emerald-50/90 to-slate-50/80 shadow-emerald-200/60,border border-slate-200 bg-white shadow-slate-200/50' %}
          <article
            class="relative overflow-hidden rounded-3xl {{ card_tone }} p-5"
            data-night-mortality-card
            data-night-mortality-date="{{ mortality.date|default:'' }}"
            data-night-mortality-submit-url="{{ mortality.submit_url|default:'' }}"
          >
            <div class="pointer-events-none absolute inset-y-0 right-0 hidden w-32 bg-gradient-to-l from-amber-50/60 via-transparent to-transparent sm:block"></div>
            <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
              <div>
                <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                  <span aria-hidden="true">üåô</span>
                  Registro nocturno
                </p>
                <h3 class="text-lg font-semibold text-slate-900">
                  {{ mortality.weekday_label }} ¬∑ {{ mortality.date_label }}
                </h3>
                <p class="text-xs text-slate-600">
                  {{ mortality.farm|default:"Granja sin nombre" }}
                  {% if mortality.shift_label %} ¬∑ {{ mortality.shift_label }}{% endif %}
                </p>
              </div>
              <div class="flex flex-col items-start gap-2 text-left sm:items-end sm:text-right">
                <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                  <span aria-hidden="true">üêî</span>
                  {{ mortality.total_birds|intcomma }} aves monitoreadas
                </span>
                {% if has_records %}
                  <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-700">
                    <span aria-hidden="true">‚úÖ</span>
                    Mortalidad registrada
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-rose-700">
                    <span aria-hidden="true">‚ö†Ô∏è</span>
                    Datos pendientes
                  </span>
                {% endif %}
              </div>
            </header>

            <p class="mt-2 hidden text-xs font-semibold text-emerald-600" data-night-mortality-feedback></p>

            <div class="mt-4 space-y-4" data-night-mortality-lots>
              {% for lot in mortality.lots %}
                <section
                  class="rounded-2xl border border-slate-200 bg-white/70 p-4 shadow-sm"
                  data-night-mortality-lot
                  data-batch-id="{{ lot.id }}"
                >
                  <header class="flex flex-wrap items-start justify-between gap-2">
                    <div>
                      <p class="text-sm font-semibold text-slate-900">{{ lot.label }}</p>
                      <p class="text-xs text-slate-500">
                        {{ lot.houses|join:", " }}
                      </p>
                    </div>
                    <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                      <span aria-hidden="true">üêî</span>
                      {{ lot.birds|intcomma }} aves
                    </span>
                  </header>
                  <div class="mt-3 space-y-3" data-night-mortality-rooms>
                    {% for room in lot.rooms %}
                      <article
                        class="rounded-2xl border border-slate-200 bg-white/90 p-3"
                        data-night-mortality-room
                        data-room-id="{{ room.id }}"
                        data-room-label="{{ room.label }}"
                      >
                        <div class="flex flex-wrap items-start justify-between gap-2">
                          <div>
                            <p class="text-sm font-semibold text-slate-900">{{ room.label }}</p>
                            <p class="text-xs text-slate-500">
                              {{ room.house|default:"Galp√≥n sin nombre" }} ¬∑ {{ room.birds|intcomma }} aves
                            </p>
                          </div>
                        </div>
                        <div class="mt-3 grid gap-3 text-xs font-semibold text-slate-600 sm:grid-cols-3">
                          <label class="flex flex-col gap-1">
                            <span class="text-[11px] uppercase tracking-wide text-slate-400">Mortalidad (aves)</span>
                            <input
                              type="number"
                              step="1"
                              min="0"
                              inputmode="numeric"
                              pattern="[0-9]*"
                              class="w-full rounded-lg border border-slate-200 bg-white px-2 py-2 text-sm text-slate-900 focus:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200/60"
                              data-night-mortality-room-field="mortality"
                              value="{{ room.mortality|default:'' }}"
                            />
                          </label>
                          <label class="flex flex-col gap-1">
                            <span class="text-[11px] uppercase tracking-wide text-slate-400">Descarte (aves)</span>
                            <input
                              type="number"
                              step="1"
                              min="0"
                              inputmode="numeric"
                              pattern="[0-9]*"
                              class="w-full rounded-lg border border-slate-200 bg-white px-2 py-2 text-sm text-slate-900 focus:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200/60"
                              data-night-mortality-room-field="discard"
                              value="{{ room.discard|default:'' }}"
                            />
                          </label>
                          <label class="flex flex-col gap-1">
                            <span class="text-[11px] uppercase tracking-wide text-slate-400">Consumo (kg)</span>
                            <input
                              type="number"
                              step="0.1"
                              min="0"
                              inputmode="numeric"
                              pattern="[0-9]+(\.[0-9]+)?"
                              class="w-full rounded-lg border border-slate-200 bg-white px-2 py-2 text-sm text-slate-900 focus:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200/60"
                              data-night-mortality-room-field="consumption"
                              value="{{ room.consumption|default:'' }}"
                            />
                          </label>
                        </div>
                      </article>
                    {% endfor %}
                  </div>
                </section>
              {% endfor %}
            </div>

            <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <div
                class="hidden rounded-2xl border border-emerald-200 bg-emerald-50/80 px-4 py-3 text-sm font-semibold text-emerald-800 shadow-inner shadow-emerald-100/70"
                data-night-mortality-complete-banner
              >
                <span aria-hidden="true">üéâ</span>
                Mortalidad nocturna actualizada.
              </div>
              <button
                type="button"
                class="inline-flex w-full items-center justify-center gap-2 rounded-2xl border border-rose-200 bg-rose-600 px-6 py-3 text-base font-semibold text-white shadow-lg shadow-rose-200/70 transition hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-300/70 sm:w-auto"
                data-night-mortality-submit-button
              >
                <span data-night-mortality-button-icon aria-hidden="true">üíæ</span>
                <span data-night-mortality-button-label>Guardar registros</span>
              </button>
            </div>
          </article>
        {% endwith %}
      {% endwith %}
    {% endif %}
  {% endwith %}
{% endif %}
