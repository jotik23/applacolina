{% load humanize %}

{% if mini_app_card_permissions.feed_plan and telegram_mini_app.feed_plan %}
  {% with feed_plan=telegram_mini_app.feed_plan %}
    <article
      class="rounded-3xl border border-amber-200 bg-gradient-to-br from-white via-amber-50/70 to-emerald-50/60 p-5 shadow-xl shadow-amber-200/50"
      data-feed-plan-card
    >
      <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <div class="space-y-1">
          <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-amber-600">
            <span aria-hidden="true">ィ</span>
            Dosificaci贸n de alimento
          </p>
          <h3 class="text-lg font-semibold text-slate-900">Plan diario 路 {{ feed_plan.date_label }}</h3>
          <p class="text-xs text-slate-600">
            {{ feed_plan.weekday_label }} 路 {{ feed_plan.position_label|default:"Posici贸n sin nombre" }}{% if feed_plan.chicken_house %} 路 {{ feed_plan.chicken_house }}{% endif %}{% if feed_plan.farm %} 路 {{ feed_plan.farm }}{% endif %}
          </p>
        </div>
        <div class="flex flex-col items-start gap-2 text-left sm:items-end sm:text-right">
          <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white/90 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-600 shadow-sm shadow-emerald-100/60">
            <span aria-hidden="true"></span>
            {{ feed_plan.totals.birds|intcomma }} aves vivas
          </span>
          <span class="inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/90 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-amber-700 shadow-sm shadow-amber-100/60">
            <span aria-hidden="true">锔</span>
            {{ feed_plan.totals.feed_kg|floatformat:1 }} kg 路 {{ feed_plan.totals.feed_bags|floatformat:2 }} bultos
          </span>
        </div>
      </header>

      {% with distribution=feed_plan.distribution %}
          <section class="mt-4 grid gap-4 lg:grid-cols-2">
            <div class="rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-inner shadow-amber-50/80">
              <div class="flex items-center justify-between gap-3">
                <h4 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Consumo exacto</h4>
                <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-[11px] font-semibold text-slate-600">
                  {{ distribution.exact.total_bags|floatformat:2 }} bultos
                </span>
              </div>
              <p class="mt-2 text-base font-semibold text-slate-900">
                {{ distribution.exact.total_kg|floatformat:1 }} kg ({{ distribution.exact.total_bags|floatformat:2 }} bultos de {{ feed_plan.reference.bag_weight_kg|floatformat:0 }} kg)
              </p>
              <dl class="mt-3 grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
                <div class="rounded-xl border border-slate-100 bg-slate-50/80 p-3">
                  <dt class="font-semibold uppercase tracking-wide text-slate-500">Ma帽ana 路 {{ distribution.exact.morning_percentage|floatformat:0 }}%</dt>
                  <dd class="mt-1 text-sm font-semibold text-slate-900">
                    {{ distribution.exact.morning_kg|floatformat:1 }} kg
                    <span class="text-[11px] font-semibold text-slate-500">({{ distribution.exact.morning_bags|floatformat:2 }} bultos)</span>
                  </dd>
                </div>
                <div class="rounded-xl border border-slate-100 bg-slate-50/80 p-3">
                  <dt class="font-semibold uppercase tracking-wide text-slate-500">Tarde 路 {{ distribution.exact.afternoon_percentage|floatformat:0 }}%</dt>
                  <dd class="mt-1 text-sm font-semibold text-slate-900">
                    {{ distribution.exact.afternoon_kg|floatformat:1 }} kg
                    <span class="text-[11px] font-semibold text-slate-500">({{ distribution.exact.afternoon_bags|floatformat:2 }} bultos)</span>
                  </dd>
                </div>
              </dl>
            </div>

            <div class="rounded-2xl border border-emerald-200 bg-emerald-50/90 p-4 shadow-inner shadow-emerald-100/70">
              <div class="flex items-center justify-between gap-3">
                <h4 class="text-sm font-semibold uppercase tracking-wide text-emerald-700">Ajuste a bultos completos</h4>
                <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white/90 px-3 py-1 text-[11px] font-semibold text-emerald-700">
                  {% if distribution.recommended %}
                    {% if distribution.recommended.direction == "up" %}Hacia arriba{% else %}Hacia abajo{% endif %}
                  {% else %}
                    Exacto
                  {% endif %}
                </span>
              </div>
              {% if distribution.recommended %}
                <p class="mt-2 text-base font-semibold text-emerald-800">
                  {{ distribution.recommended.total_bags }} bultos 路 {{ distribution.recommended.total_kg|floatformat:1 }} kg
                </p>
                <p class="text-xs font-semibold {% if distribution.recommended.delta_kg >= 0 %}text-emerald-700{% else %}text-rose-600{% endif %}">
                  Diferencial {% if distribution.recommended.delta_kg >= 0 %}+{% endif %}{{ distribution.recommended.delta_bags|floatformat:2 }} bultos ({% if distribution.recommended.delta_kg >= 0 %}+{% endif %}{{ distribution.recommended.delta_kg|floatformat:1 }} kg)
                </p>
                <dl class="mt-3 grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
                  <div class="rounded-xl border border-emerald-100 bg-white/90 p-3 shadow-sm shadow-emerald-100/60">
                    <dt class="font-semibold uppercase tracking-wide text-emerald-600">
                      Ma帽ana 路 {{ distribution.recommended.morning_percentage|floatformat:0 }}%
                    </dt>
                    <dd class="mt-1 text-sm font-semibold text-slate-900">
                      {{ distribution.recommended.morning_kg|floatformat:1 }} kg
                      <span class="text-[11px] font-semibold text-slate-500">({{ distribution.recommended.morning_bags }} bultos)</span>
                    </dd>
                  </div>
                  <div class="rounded-xl border border-emerald-100 bg-white/90 p-3 shadow-sm shadow-emerald-100/60">
                    <dt class="font-semibold uppercase tracking-wide text-emerald-600">
                      Tarde 路 {{ distribution.recommended.afternoon_percentage|floatformat:0 }}%
                    </dt>
                    <dd class="mt-1 text-sm font-semibold text-slate-900">
                      {{ distribution.recommended.afternoon_kg|floatformat:1 }} kg
                      <span class="text-[11px] font-semibold text-slate-500">({{ distribution.recommended.afternoon_bags }} bulto{{ distribution.recommended.afternoon_bags|pluralize }})</span>
                    </dd>
                  </div>
                </dl>
              {% else %}
                <p class="mt-2 text-sm text-slate-700">
                  El consumo exacto ya coincide con bultos completos. Sirve la d贸sis con el esquema base (65% ma帽ana / 35% tarde).
                </p>
              {% endif %}
            </div>
          </section>

          {% if distribution.options %}
            <div class="mt-3 space-y-2 rounded-2xl border border-white/50 bg-white/80 p-4 text-xs text-slate-600 shadow-inner shadow-slate-100/60">
              <p class="font-semibold uppercase tracking-wide text-slate-500">Escenarios alternos</p>
              <div class="flex flex-wrap gap-2">
                {% for option in distribution.options %}
                  <div class="space-y-1 rounded-2xl border border-slate-200 bg-slate-50/80 px-3 py-2">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      {% if option.direction == "up" %}Hacia arriba{% else %}Hacia abajo{% endif %}
                    </p>
                    <p class="text-sm font-semibold text-slate-900">{{ option.total_bags }} bultos 路 {{ option.total_kg|floatformat:1 }} kg</p>
                    <p class="text-[11px] {% if option.delta_kg >= 0 %}text-emerald-600{% else %}text-rose-600{% endif %}">
                      {% if option.delta_kg >= 0 %}+{% endif %}{{ option.delta_bags|floatformat:2 }} bultos ({% if option.delta_kg >= 0 %}+{% endif %}{{ option.delta_kg|floatformat:1 }} kg)
                    </p>
                    <p class="text-[11px] text-slate-500">
                      AM: {{ option.morning_bags }} bulto{{ option.morning_bags|pluralize }} 路 PM: {{ option.afternoon_bags }} bulto{{ option.afternoon_bags|pluralize }}
                    </p>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endwith %}

        <section class="mt-5 space-y-4">
          {% for house in feed_plan.houses %}
            <section class="rounded-2xl border border-emerald-100 bg-white/95 p-4 shadow-sm shadow-emerald-50/80">
              <header class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-wide text-emerald-500">
                    {{ house.label }}{% if house.farm %} 路 {{ house.farm }}{% endif %}
                  </p>
                  <p class="text-sm text-slate-600">
                    {{ house.summary.birds|intcomma }} aves 路 {{ house.summary.feed_kg|floatformat:1 }} kg ({{ house.summary.feed_bags|floatformat:2 }} bultos)
                  </p>
                </div>
              </header>
              <div class="mt-3 grid gap-3 sm:grid-cols-2">
                {% for room in house.rooms %}
                  <article class="rounded-xl border border-slate-200 bg-slate-50/80 p-3">
                    <p class="text-sm font-semibold text-slate-900">
                      {{ room.label }}
                      <span class="text-[11px] font-medium text-slate-500">({{ room.lot_label }})</span>
                    </p>
                    <p class="text-xs text-slate-500">{{ room.birds|intcomma }} aves 路 {{ room.grams_per_bird|floatformat:1 }} g/ave</p>
                    <p class="text-sm font-semibold text-slate-900">
                      {{ room.feed_kg|floatformat:2 }} kg
                      <span class="text-[11px] font-semibold text-slate-500">({{ room.feed_bags|floatformat:2 }} bultos)</span>
                    </p>
                  </article>
                {% empty %}
                  <p class="rounded-xl border border-dashed border-slate-200 bg-white/80 p-3 text-xs text-slate-500">
                    Sin salones asignados en este galp贸n.
                  </p>
                {% endfor %}
              </div>
            </section>
          {% endfor %}
        </section>

        <section class="mt-5 grid gap-4 lg:grid-cols-[2fr_1fr]">
          <div class="rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-inner shadow-slate-100/70">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Referencia por lote</p>
            <div class="mt-3 divide-y divide-slate-100 text-xs text-slate-600">
              {% for lot in feed_plan.reference.lots %}
                <div class="flex items-center justify-between gap-3 py-2 first:pt-0 last:pb-0">
                  <div>
                    <p class="text-sm font-semibold text-slate-900">{{ lot.label }}</p>
                    <p>{{ lot.breed|default:"Raza no definida" }} 路 Sem {{ lot.age_weeks }} 路 {{ lot.birds|intcomma }} aves</p>
                  </div>
                  <div class="text-right">
                    <p class="text-sm font-semibold text-slate-900">{{ lot.feed_kg|floatformat:1 }} kg</p>
                    <p class="text-[11px] text-slate-500">{{ lot.grams_per_bird|floatformat:1 }} g/ave</p>
                  </div>
                </div>
              {% empty %}
                <p class="py-3 text-sm text-slate-500">Sin lotes activos asociados.</p>
              {% endfor %}
            </div>
          </div>
          <div class="rounded-2xl border border-amber-200 bg-amber-50/90 p-4 shadow-inner shadow-amber-100/60">
            <p class="text-xs font-semibold uppercase tracking-wide text-amber-700">Gramos por ave</p>
            <div class="mt-2 space-y-2 text-sm text-amber-900">
              <p class="font-semibold">
                Referencia: {{ feed_plan.reference.grams_per_bird|floatformat:1 }} g/ave
              </p>
              {% if feed_plan.reference.rounded_grams_per_bird %}
                <p>
                  Con ajuste: {{ feed_plan.reference.rounded_grams_per_bird|floatformat:1 }} g/ave
                  {% with diff=feed_plan.reference.grams_difference %}
                    {% if diff is not None %}
                      <span class="text-[11px] font-semibold {% if diff >= 0 %}text-emerald-700{% else %}text-rose-600{% endif %}">
                        {% if diff >= 0 %}+{% endif %}{{ diff|floatformat:1 }} g
                      </span>
                    {% endif %}
                  {% endwith %}
                </p>
              {% else %}
                <p>Recomendaci贸n: usa la misma dosis exacta, no se requieren ajustes.</p>
              {% endif %}
              <p class="text-[11px] text-amber-700">* Bultos de {{ feed_plan.reference.bag_weight_kg|floatformat:0 }} kg divididos 65% ma帽ana / 35% tarde.</p>
            </div>
          </div>
        </section>
    </article>
  {% endwith %}
{% endif %}
