{% load humanize %}

{% if mini_app_card_permissions.feed_plan and telegram_mini_app.feed_plan %}
  {% with feed_plan=telegram_mini_app.feed_plan %}
    <article
      class="rounded-3xl border border-amber-200 bg-gradient-to-br from-white via-amber-50/70 to-emerald-50/60 p-5 shadow-xl shadow-amber-200/50"
      data-feed-plan-card
    >
      <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="space-y-1">
          <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-amber-600">
            <span aria-hidden="true">游볶</span>
            Dosificaci칩n de alimento
          </p>
          <h3 class="text-lg font-semibold text-slate-900">
                {{ feed_plan.weekday_label }}. {{ feed_plan.date_label }}
          </h3>
          <div class="mt-2 flex flex-wrap items-center gap-2 text-[11px] text-slate-500">
            {% if feed_plan.reference.grams_per_bird %}
              <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-0.5 font-semibold text-emerald-700">
                {{ feed_plan.reference.grams_per_bird|floatformat:0 }} g ave/d칤a 췅 gu칤a actual
              </span>
            {% endif %}
            {% for lot in feed_plan.reference.lots %}
              <span class="inline-flex items-center gap-1 rounded-full bg-white/70 px-2 py-0.5 text-slate-600 ring-1 ring-slate-200">
                {{ lot.label }} 췅 semana {{ lot.age_weeks }}
              </span>
            {% endfor %}
          </div>
        </div>
      </header>

      <section class="mt-5 space-y-4">
        {% for house in feed_plan.houses %}
          <section class="rounded-2xl border border-emerald-100 bg-white/95 p-4 shadow-sm shadow-emerald-50/80">
            <header class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600">
                  {{ house.label }}{% if house.farm %} 췅 {{ house.farm }}{% endif %}
                </p>
              </div>
            </header>
            <div class="mt-3 overflow-x-auto">
              <table class="min-w-full border-separate border-spacing-0 text-xs text-slate-600">
                <thead>
                  <tr class="text-[11px] uppercase tracking-wide text-slate-600">
                    <th class="rounded-tl-2xl bg-emerald-50/80 px-2 py-2 text-left align-bottom font-semibold text-emerald-700">
                      Sal칩n
                    </th>
                    <th
                      class="bg-gradient-to-r from-emerald-50 to-emerald-100 px-2 py-2 text-center font-semibold text-emerald-700"
                      colspan="3"
                    >
                      <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2 py-0.5 text-[10px] font-bold">
                        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                        AM
                      </span>
                    </th>
                    <th
                      class="rounded-tr-2xl bg-gradient-to-r from-sky-50 to-sky-100 px-2 py-2 text-center font-semibold text-sky-700"
                      colspan="3"
                    >
                      <span class="inline-flex items-center gap-1 rounded-full bg-sky-100 px-2 py-0.5 text-[10px] font-bold">
                        <span class="h-2 w-2 rounded-full bg-sky-500"></span>
                        PM
                      </span>
                    </th>
                  </tr>
                  <tr class="text-[11px] uppercase tracking-wide text-slate-500">
                    <th class="bg-emerald-50/40 px-2 py-1 text-left font-medium text-emerald-700"> </th>
                    <th class="bg-emerald-50/50 px-2 py-1 text-center font-medium text-emerald-600">M칤n.</th>
                    <th class="bg-amber-50/90 px-2 py-1 text-center font-semibold text-amber-700">Ideal</th>
                    <th class="bg-emerald-50/50 px-2 py-1 text-center font-medium text-emerald-600">M치x.</th>
                    <th class="bg-sky-50/50 px-2 py-1 text-center font-medium text-sky-600">M칤n.</th>
                    <th class="bg-amber-50/90 px-2 py-1 text-center font-semibold text-amber-700">Ideal</th>
                    <th class="bg-sky-50/50 px-2 py-1 text-center font-medium text-sky-600">M치x.</th>
                  </tr>
                </thead>
                <tbody>
                  {% for room in house.rooms %}
                    {% with dosing=room.dosing %}
                      <tr class="border-t border-slate-100 text-slate-600 transition hover:bg-amber-50/30">
                        <td class="rounded-l-2xl border-y border-l border-emerald-100/70 bg-emerald-50/60 px-3 py-3 align-top shadow-inner">
                          <p class="text-sm font-semibold text-emerald-900">{{ room.label }}</p>
                          <p class="text-[11px] text-emerald-700/80">{{ room.birds|intcomma }} aves vivas</p>
                        </td>
                        <td class="border-y border-slate-100/70 bg-emerald-50/40 px-2 py-3 text-center">
                          <p class="text-sm font-semibold text-slate-900">{{ dosing.min.am.bags|floatformat:0 }} bl</p>
                          <p class="text-[11px] text-slate-500">{{ dosing.min.am.kg|floatformat:1 }} kg</p>
                        </td>
                        <td class="border-y border-slate-100/70 bg-gradient-to-br from-amber-50 via-amber-50 to-amber-100 px-2 py-3 text-center ring-1 ring-inset ring-amber-200 shadow-sm">
                          <p class="text-sm font-semibold text-amber-900">{{ dosing.ideal.am.bags|floatformat:2 }} bl</p>
                          <p class="text-[11px] text-amber-700">{{ dosing.ideal.am.kg|floatformat:1 }} kg</p>
                        </td>
                        <td class="border-y border-slate-100/70 bg-emerald-50/40 px-2 py-3 text-center">
                          <p class="text-sm font-semibold text-slate-900">{{ dosing.max.am.bags|floatformat:0 }} bl</p>
                          <p class="text-[11px] text-slate-500">{{ dosing.max.am.kg|floatformat:1 }} kg</p>
                        </td>
                        <td class="border-y border-slate-100/70 bg-sky-50/40 px-2 py-3 text-center">
                          <p class="text-sm font-semibold text-slate-900">{{ dosing.min.pm.bags|floatformat:0 }} bl</p>
                          <p class="text-[11px] text-slate-500">{{ dosing.min.pm.kg|floatformat:1 }} kg</p>
                        </td>
                        <td class="border-y border-slate-100/70 bg-gradient-to-br from-amber-50 via-amber-50 to-amber-100 px-2 py-3 text-center ring-1 ring-inset ring-amber-200 shadow-sm">
                          <p class="text-sm font-semibold text-amber-900">{{ dosing.ideal.pm.bags|floatformat:2 }} bl</p>
                          <p class="text-[11px] text-amber-700">{{ dosing.ideal.pm.kg|floatformat:1 }} kg</p>
                        </td>
                        <td class="rounded-r-2xl border-y border-r border-slate-100/70 bg-sky-50/40 px-2 py-3 text-center shadow-inner">
                          <p class="text-sm font-semibold text-slate-900">{{ dosing.max.pm.bags|floatformat:0 }} bl</p>
                          <p class="text-[11px] text-slate-500">{{ dosing.max.pm.kg|floatformat:1 }} kg</p>
                        </td>
                      </tr>
                    {% endwith %}
                  {% empty %}
                    <tr>
                      <td class="px-2 py-3 text-center text-xs text-slate-500" colspan="7">
                        Sin salones asignados en este galp칩n.
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </section>
        {% endfor %}
      </section>

      <p class="mt-4 text-[11px] text-slate-500">
        bl = bulto de {{ feed_plan.reference.bag_weight_kg|floatformat:0 }} kg. Ideal = c치lculo exacto, M칤n./M치x. se redondean a bultos completos.
      </p>
    </article>
  {% endwith %}
{% endif %}
