{% load i18n %}

{% with roster=roster %}
{% if roster and roster.days %}
<div class="rounded-3xl border border-slate-200/60 bg-gradient-to-br from-white via-slate-50 to-amber-50 p-5 shadow-xl shadow-amber-100/60">
  <header class="flex flex-wrap items-center justify-between gap-4">
    <div class="space-y-1">
      <span class="inline-flex items-center gap-2 rounded-full border border-brand/20 bg-brand/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-brand-dark">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.16 0 4.15.76 5.71 2.03" />
        </svg>
        {% trans "Mi calendario de turnos" %}
      </span>
      <h2 class="text-xl font-semibold text-slate-900">{% trans "Plan de los pr√≥ximos d√≠as" %}</h2>
    </div>
    {% if roster.initial_day %}
    <div class="flex flex-col items-end gap-2 text-right">
      <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600 shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l3.5 2" />
        </svg>
        {{ roster.initial_day.weekday_label }} ¬∑ {{ roster.initial_day.date_label }}
      </span>
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-amber-300 bg-white/90 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-amber-700 shadow-sm transition hover:border-amber-400 hover:text-amber-800 focus:outline-none focus:ring-2 focus:ring-amber-200/70 disabled:opacity-40"
        data-rest-suggestion-trigger
        aria-haspopup="dialog"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 8.25h7.5m-7.5 3h4.5m4.5 8.25-4.72-4.72a.75.75 0 0 0-.53-.22H6a2.25 2.25 0 0 1-2.25-2.25V6A2.25 2.25 0 0 1 6 3.75h12A2.25 2.25 0 0 1 20.25 6v12a.75.75 0 0 1-1.28.53Z" />
        </svg>
        {% trans "Reportar descanso" %}
      </button>
    </div>
    {% endif %}
  </header>

  {% trans "Sin rol asignado" as fallback_role %}
  <ul class="mt-6 grid grid-cols-1 gap-3 text-xs sm:grid-cols-2 lg:grid-cols-3">
    {% for day in roster.days %}
    <li
      class="group relative overflow-hidden rounded-3xl border p-4 transition duration-150 {% if day.is_rest %}border-emerald-200 bg-emerald-50/80 text-emerald-800 shadow-inner shadow-emerald-100{% else %}border-slate-200 bg-white text-slate-600 shadow-sm hover:shadow-md{% endif %} {% if day.is_today %}ring-2 ring-brand/40{% endif %}"
    >
      <div class="flex items-start justify-between gap-3">
        <div class="space-y-1">
          <span class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide {% if day.is_rest %}text-emerald-600{% else %}text-slate-500{% endif %}">
            {{ day.weekday_label }}
            {% if day.is_today %}
            <span class="rounded-full bg-brand/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-brand-dark shadow-sm">
              {% trans "Hoy" %}
            </span>
            {% endif %}
          </span>
          <p class="text-2xl font-semibold text-slate-900">{{ day.date_label }}</p>
        </div>
        <div class="flex flex-col items-end gap-2">
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-[10px] font-semibold uppercase tracking-wide {{ day.calendar_status_badge_class }}">
            {{ day.calendar_status }}
          </span>
          {% if day.calendar_status_key == "manual" %}
          <span class="text-[10px] font-medium uppercase tracking-wide text-emerald-600">{% trans "Acuerdo manual" %}</span>
          {% endif %}
        </div>
      </div>
      {% if day.is_rest %}
      <div class="mt-3 space-y-3">
        <div class="flex items-start gap-2 text-sm font-semibold text-emerald-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="mt-0.5 h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75h4.5M3 18h18M4.5 18V9.75a4.5 4.5 0 0 1 4.5-4.5h6a4.5 4.5 0 0 1 4.5 4.5V18" />
          </svg>
          <div>
            <p>{{ day.rest_label }}</p>
            {% if day.rest_notes %}
            <p class="mt-1 text-[11px] font-normal text-emerald-600">{{ day.rest_notes }}</p>
            {% endif %}
          </div>
        </div>
        <div
          class="flex flex-wrap gap-2"
          data-rest-suggestion-state
          data-rest-date="{{ day.date_iso }}"
          data-rest-calendar-id="{{ day.calendar_id|default:'' }}"
        >
          {% if day.rest_suggestion %}
          <span class="inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-50/80 px-3 py-1 text-[11px] font-semibold text-rose-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4.5c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            {% trans "Solicitud enviada" %} ¬∑ {{ day.rest_suggestion.status_label }}
          </span>
          {% elif day.calendar_id %}
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 shadow-sm transition hover:border-brand hover:text-brand focus:outline-none focus:ring-2 focus:ring-brand/20"
            data-rest-suggestion-day
            data-rest-date="{{ day.date_iso }}"
            data-rest-calendar-id="{{ day.calendar_id }}"
            data-rest-weekday="{{ day.weekday_label }}"
            data-rest-label="{{ day.date_label }}"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            {% trans "Sugerir otro d√≠a" %}
          </button>
          {% else %}
          <p class="text-[11px] font-medium text-slate-500">{% trans "Descanso manual, rep√≥rtalo a tu l√≠der." %}</p>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="mt-3 space-y-3">
        <div class="space-y-1">
          <p class="text-base font-semibold text-slate-900">{{ day.role_label|default:fallback_role }}</p>
          {% if day.location_label %}
          <p class="text-[12px] text-slate-500">{{ day.location_label }}</p>
          {% elif day.farm_label or day.barn_label %}
          <p class="text-[12px] text-slate-500">
            {% if day.farm_label %}{{ day.farm_label }}{% if day.barn_label %} ¬∑ {{ day.barn_label }}{% endif %}{% elif day.barn_label %}{{ day.barn_label }}{% endif %}
          </p>
          {% endif %}
        </div>
        {% if day.shift_type_label %}
        <span class="inline-flex items-center gap-2 rounded-full border border-brand/30 bg-brand/10 px-3 py-1 text-[10px] font-semibold uppercase tracking-wide text-brand-dark">
          {{ day.shift_type_label }}
        </span>
        {% endif %}
        {% if day.assignment_notes %}
        <p class="text-[11px] text-slate-500">{{ day.assignment_notes }}</p>
        {% endif %}
        {% if day.alerts %}
        <div class="space-y-1">
          {% for alert in day.alerts %}
          <div class="inline-flex items-center gap-2 rounded-2xl border border-amber-200 bg-amber-50/80 px-3 py-1 text-[11px] font-medium text-amber-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4.5c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            {{ alert }}
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  <div
    class="fixed inset-0 z-40 hidden items-center justify-center bg-slate-900/60 px-4 py-6"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    data-rest-suggestion-modal
    data-rest-suggestion-endpoint="{% url 'task_manager:mini-app-rest-suggestions' %}"
  >
    <button type="button" class="absolute inset-0 h-full w-full" data-rest-suggestion-dismiss aria-hidden="true"></button>
    <div class="relative w-full max-w-md rounded-3xl border border-slate-100 bg-white p-5 text-slate-700 shadow-2xl shadow-slate-900/20">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-wide text-amber-600">
            {% trans "Cont√°ctanos" %}
          </p>
          <h3 class="text-lg font-semibold text-slate-900">{% trans "¬øEn qu√© d√≠a prefieres descansar?" %}</h3>
          <p class="text-sm text-slate-500">{% trans "Cu√©ntanos el contexto y propondremos el ajuste al equipo de programaci√≥n." %}</p>
        </div>
        <button
          type="button"
          class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 text-slate-400 transition hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200"
          aria-label="{% trans 'Cerrar' %}"
          data-rest-suggestion-dismiss
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6m0 12L6 6" />
          </svg>
        </button>
      </div>
      <div class="mt-4 hidden rounded-2xl border border-rose-200 bg-rose-50/70 px-3 py-2 text-xs font-medium text-rose-600" data-rest-suggestion-errors></div>
      <div class="mt-4 hidden rounded-2xl border border-emerald-200 bg-emerald-50/80 px-3 py-2 text-sm text-emerald-700" data-rest-suggestion-success>
        {% trans "Gracias, registramos tu solicitud. Te avisaremos cuando se actualice el calendario." %}
      </div>
      <form class="mt-4 space-y-4" data-rest-suggestion-form>
        <div class="space-y-1">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
            {% trans "Descanso programado" %}
          </label>
          <select
            class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-semibold text-slate-700 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/20"
            data-rest-scheduled-select
          >
            <option value="">{% trans "Selecciona un d√≠a de descanso" %}</option>
          </select>
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rest-suggested-date">
            {% trans "D√≠a que propones" %}
          </label>
          <input
            id="rest-suggested-date"
            type="date"
            class="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/30"
            data-rest-suggested-input
          />
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rest-suggestion-reason">
            {% trans "Motivo" %}
          </label>
          <textarea
            id="rest-suggestion-reason"
            rows="3"
            maxlength="600"
            placeholder="{% trans 'Ej. Necesito acompa√±ar una cita m√©dica y me sirve reprogramar al viernes.' %}"
            class="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/30"
            data-rest-reason-input
          ></textarea>
        </div>
        <div class="flex items-center gap-2 text-[11px] text-slate-400">
          <span aria-hidden="true">üõ°</span>
          {% trans "Tu l√≠der recibir√° esta nota como alerta cr√≠tica del calendario." %}
        </div>
        <div class="flex items-center justify-end gap-2">
          <button
            type="button"
            class="inline-flex items-center rounded-full border border-slate-200 px-4 py-1.5 text-xs font-semibold uppercase tracking-wide text-slate-500 hover:text-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-200"
            data-rest-suggestion-dismiss
          >
            {% trans "Cancelar" %}
          </button>
          <button
            type="submit"
            class="inline-flex items-center gap-2 rounded-full bg-brand px-5 py-2 text-xs font-semibold uppercase tracking-wide text-slate-900 shadow focus:outline-none focus:ring-2 focus:ring-brand/50 disabled:opacity-50"
            data-rest-suggestion-submit
          >
            {% trans "Guardar" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endwith %}
