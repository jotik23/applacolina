{% load static humanize i18n %}
<!DOCTYPE html>
<html lang="es" class="h-full bg-gradient-to-br from-sky-50 via-white to-amber-50">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Granjas La Colina</title>
    <link
      rel="manifest"
      href="{% static 'task_manager/pwa/manifest.json' %}"
      crossorigin="use-credentials"
    />
    <meta name="theme-color" content="#d1fae5" />
    <meta name="application-name" content="Granjas La Colina" />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="{% static 'task_manager/pwa/icons/icon-192.png' %}"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{% static 'task_manager/pwa/icons/icon-180.png' %}"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                DEFAULT: '#f59e0b',
                dark: '#d97706'
              }
            }
          }
        }
      }
    </script>
    <style>
      :root {
        color-scheme: only light;
        --tm-viewport-height: 100vh;
        --tm-viewport-bottom-offset: 0px;
      }
      @supports (height: 100dvh) {
        :root {
          --tm-viewport-height: 100dvh;
        }
      }
      body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      .mini-app-blur {
        backdrop-filter: blur(18px);
      }
      .tm-review-filter {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        border-radius: 9999px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background-color: rgba(255, 255, 255, 0.95);
        padding: 0.45rem 0.9rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(71, 85, 105, 0.95);
        transition: border-color 150ms ease, background-color 150ms ease, color 150ms ease, box-shadow 150ms ease;
      }
      .tm-review-filter:hover,
      .tm-review-filter:focus-visible {
        outline: none;
        border-color: rgba(59, 130, 246, 0.45);
        color: rgb(30, 64, 175);
        box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.12);
      }
      .tm-review-filter[data-active='true'] {
        border-color: rgba(245, 158, 11, 0.6);
        background-color: rgba(253, 230, 138, 0.55);
        color: rgb(120, 53, 15);
        box-shadow: inset 0 0 0 1px rgba(245, 158, 11, 0.25);
      }
      .tm-review-filter-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5rem;
        padding: 0.1rem 0.45rem;
        border-radius: 9999px;
        background-color: rgba(255, 255, 255, 0.85);
        font-size: 0.7rem;
        font-weight: 700;
        color: rgba(71, 85, 105, 0.85);
      }
      .tm-review-filter[data-active='true'] .tm-review-filter-count {
        background-color: rgba(255, 255, 255, 0.92);
        color: rgb(120, 53, 15);
      }
      .tm-review-status-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        border-radius: 9999px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background-color: rgba(248, 250, 252, 0.95);
        color: rgba(71, 85, 105, 0.95);
        padding: 0.3rem 0.8rem;
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        transition: background-color 160ms ease, color 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
      }
      .tm-review-status-chip[data-state='awaiting'],
      .tm-review-status-chip[data-state='missing'],
      .tm-review-status-chip[data-state='not-started'] {
        border-color: rgba(245, 158, 11, 0.45);
        background-color: rgba(253, 230, 138, 0.45);
        color: rgb(133, 77, 14);
      }
      .tm-review-status-chip[data-state='approved'] {
        border-color: rgba(16, 185, 129, 0.4);
        background-color: rgba(209, 250, 229, 0.7);
        color: rgb(6, 95, 70);
      }
      .tm-review-status-chip[data-state='rejected'] {
        border-color: rgba(244, 63, 94, 0.45);
        background-color: rgba(254, 226, 226, 0.7);
        color: rgb(159, 18, 57);
      }
      .tm-review-status-chip[data-state='approved'] .tm-review-status-dot {
        background-color: rgb(16, 185, 129);
      }
      .tm-review-status-chip[data-state='rejected'] .tm-review-status-dot {
        background-color: rgb(244, 63, 94);
      }
      .tm-review-status-chip[data-state='awaiting'] .tm-review-status-dot,
      .tm-review-status-chip[data-state='missing'] .tm-review-status-dot,
      .tm-review-status-chip[data-state='not-started'] .tm-review-status-dot {
        background-color: rgb(245, 158, 11);
      }
      .tm-review-status-dot {
        display: inline-flex;
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
        background-color: currentColor;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.65);
      }
      .tm-review-reason {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        border: 1px solid rgba(244, 63, 94, 0.35);
        background-color: rgba(255, 255, 255, 0.95);
        padding: 0.35rem 0.75rem;
        font-size: 0.7rem;
        font-weight: 600;
        color: rgb(190, 24, 93);
        transition: border-color 150ms ease, background-color 150ms ease, color 150ms ease, box-shadow 150ms ease;
      }
      .tm-review-reason:hover,
      .tm-review-reason:focus-visible {
        outline: none;
        border-color: rgba(244, 63, 94, 0.55);
        box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.12);
      }
      .tm-review-reason[data-selected='true'] {
        background-color: rgba(244, 63, 94, 0.2);
        border-color: rgba(244, 63, 94, 0.6);
        color: rgb(159, 18, 57);
        box-shadow: inset 0 0 0 1px rgba(244, 63, 94, 0.2);
      }
      .tm-review-feedback {
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background-color: rgba(255, 255, 255, 0.95);
        padding: 0.75rem 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: rgba(71, 85, 105, 0.95);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
      }
      .tm-review-status-chip--flash {
        animation: tmReviewChipFlash 0.32s ease-out;
      }
      @keyframes tmReviewChipFlash {
        from {
          transform: scale(0.9);
          opacity: 0.75;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .tm-purchase-card-grid {
        grid-template-columns: repeat(auto-fit, minmax(11rem, 1fr));
        gap: min(0.85rem, 3vw);
      }
      .tm-purchase-card-panel {
        border-radius: 1.25rem;
        padding: min(1rem, 3.5vw);
      }
      .tm-purchase-card-panel--amount {
        text-align: right;
      }
      .tm-purchase-card-label {
        font-size: clamp(0.65rem, 2vw, 0.7rem);
        letter-spacing: 0.18em;
      }
      .tm-purchase-card-value {
        font-size: clamp(0.85rem, 2.6vw, 0.95rem);
      }
      .tm-purchase-card-amount {
        font-size: clamp(1.05rem, 3.2vw, 1.25rem);
      }
      .tm-purchase-card-meta {
        font-size: clamp(0.65rem, 1.8vw, 0.75rem);
      }
      @media (max-width: 420px) {
        .tm-purchase-card-grid {
          grid-template-columns: repeat(2, minmax(8.5rem, 1fr));
          gap: 0.5rem;
        }
        .tm-purchase-card-panel {
          padding: 0.75rem;
        }
      }
      .tm-card-title {
        font-size: clamp(1.1rem, 3.6vw, 1.4rem);
        line-height: 1.3;
      }
      .tm-card-subtitle {
        font-size: clamp(0.78rem, 2.4vw, 0.9rem);
      }
      .tm-card-chip {
        font-size: clamp(0.6rem, 1.8vw, 0.75rem);
        letter-spacing: 0.18em;
      }
      .tm-card-chip--status {
        padding-inline: clamp(0.65rem, 2vw, 0.85rem);
        padding-block: clamp(0.2rem, 1vw, 0.35rem);
      }
      .tm-card-entry-title {
        font-size: clamp(0.95rem, 3vw, 1.15rem);
        line-height: 1.35;
      }
      .tm-card-entry-meta {
        font-size: clamp(0.72rem, 2.2vw, 0.85rem);
      }
      .tm-card-entry-meta--muted {
        font-size: clamp(0.68rem, 2vw, 0.78rem);
      }
      .tm-mini-app-shell {
        min-height: var(--tm-viewport-height, 100vh);
      }
      .tm-floating-action {
        bottom: calc(var(--tm-viewport-bottom-offset, 0px) + 1rem);
      }
    </style>
    <script>
      (function updateViewportMetrics() {
        const docEl = document.documentElement;
        const supportsVisualViewport = 'visualViewport' in window;
        function refreshViewportVars() {
          if (supportsVisualViewport && window.visualViewport) {
            const viewport = window.visualViewport;
            docEl.style.setProperty('--tm-viewport-height', viewport.height + 'px');
            const bottomOffset = Math.max(window.innerHeight - viewport.height - viewport.offsetTop, 0);
            docEl.style.setProperty('--tm-viewport-bottom-offset', bottomOffset + 'px');
            return;
          }
          docEl.style.setProperty('--tm-viewport-height', window.innerHeight + 'px');
          docEl.style.setProperty('--tm-viewport-bottom-offset', '0px');
        }
        refreshViewportVars();
        if (supportsVisualViewport && window.visualViewport) {
          window.visualViewport.addEventListener('resize', refreshViewportVars);
          window.visualViewport.addEventListener('scroll', refreshViewportVars);
        } else {
          window.addEventListener('resize', refreshViewportVars);
          window.addEventListener('orientationchange', refreshViewportVars);
        }
      })();
    </script>
  </head>
  <body
    class="min-h-full bg-gradient-to-br from-sky-50 via-white to-amber-50 text-slate-900"
    data-app-timezone="{{ APP_TIME_ZONE }}"
    data-app-timezone-offset="{{ APP_TIME_ZONE_OFFSET_MINUTES }}"
  >
    <main class="mx-auto flex max-w-xl flex-col gap-5 px-5 pt-6 pb-32 tm-mini-app-shell">
      {% if mini_app_access_granted and telegram_mini_app %}
      <header class="relative rounded-3xl border border-slate-200/80 bg-gradient-to-br from-white/95 via-sky-50/90 to-amber-50/90 p-4 shadow-xl shadow-slate-200/70 mini-app-blur sm:p-5">
        <div class="flex flex-nowrap items-center gap-4 sm:gap-6">
          <div class="flex flex-1 items-center gap-4 sm:gap-5 min-w-0">
            <div class="flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-2xl border border-white/70 bg-white/90 p-2 shadow-inner shadow-white/40 sm:h-20 sm:w-20">
              <img
                src="{% static 'task_manager/img/mini_app_motivation_placeholder.png' %}"
                alt="La Colina Granjas"
                class="h-12 w-12 cursor-pointer object-contain drop-shadow-md transition hover:scale-105 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white sm:h-16 sm:w-16"
                role="button"
                tabindex="0"
                title="Recargar la mini app"
                aria-label="Recargar la mini app"
                data-mini-app-reload-trigger
              />
            </div>
            <div class="min-w-0 text-left">
              <p class="text-[11px] font-semibold uppercase tracking-[0.24em] text-slate-500">
                {{ telegram_mini_app.user.role }}
              </p>
              <h1 data-telegram-display-name class="truncate text-xl font-semibold text-slate-900 sm:text-2xl">
                {{ telegram_mini_app.user.display_name }}
              </h1>
            </div>
          </div>
          <div class="ml-auto flex items-center gap-4">
            <div class="flex flex-col items-center gap-1 text-center">
              <button
                type="button"
                class="inline-flex h-11 w-11 items-center justify-center rounded-full border border-rose-200 bg-white/95 text-rose-600 shadow shadow-rose-100/70 transition hover:border-rose-300 hover:text-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-200 disabled:cursor-not-allowed"
                data-enable-push
                data-label-default="Notificaciones desactivadas"
                aria-live="polite"
              >
                <span class="sr-only" data-push-label>Notificaciones desactivadas</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="h-5 w-5"
                  aria-hidden="true"
                  data-push-icon
                >
                  <path d="M8 10V8a4 4 0 0 1 8 0v2" />
                  <path d="M6 10.5C6 7 8 4 12 4s6 3 6 6.5v3.5l1.5 1.5a1 1 0 0 1-.7 1.7H5.2a1 1 0 0 1-.7-1.7L6 14v-3.5z" />
                  <path d="M10 19a2 2 0 0 0 4 0" />
                </svg>
              </button>
              <button
                type="button"
                class="text-[10px] font-semibold uppercase tracking-wide text-slate-500 transition hover:text-rose-600 focus:outline-none"
                data-disable-push
              >
                Suspender
              </button>
            </div>
            {% if mini_app_logout_url %}
            <form
              method="post"
              action="{{ mini_app_logout_url }}"
              class="flex flex-col items-center gap-1 text-[10px] font-semibold uppercase tracking-wide text-slate-500"
              data-mini-app-logout-form
            >
              {% csrf_token %}
              <button
                type="submit"
                class="group flex h-11 w-11 items-center justify-center rounded-full border border-slate-200 bg-white/90 text-slate-500 shadow-sm shadow-amber-100 transition hover:border-rose-200 hover:bg-rose-50 hover:text-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-200/70"
                data-mini-app-finish-trigger
              >
                <span class="sr-only">Cerrar sesi√≥n</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="h-4 w-4"
                  aria-hidden="true"
                >
                  <path d="M9 6a3 3 0 0 1 6 0v3" />
                  <path d="M19 10a7 7 0 1 1-14 0" />
                  <path d="M12 14v3" />
                </svg>
              </button>
            </form>
            {% endif %}
          </div>
        </div>
      </header>
{% include "task_manager/includes/shift_confirmation_card.html" with shift=telegram_mini_app.shift_confirmation shift_empty=telegram_mini_app.shift_confirmation_empty %}
      <div
        data-mini-app-content
        class="flex flex-col gap-5{% if telegram_mini_app.shift_confirmation and telegram_mini_app.shift_confirmation.requires_confirmation and not telegram_mini_app.shift_confirmation.confirmed %} pointer-events-none opacity-60 blur-sm{% elif telegram_mini_app.shift_confirmation_empty and mini_app_card_permissions.shift_confirmation %} pointer-events-none opacity-60 blur-sm{% endif %}"
        aria-disabled="{% if telegram_mini_app.shift_confirmation and telegram_mini_app.shift_confirmation.requires_confirmation and not telegram_mini_app.shift_confirmation.confirmed %}true{% elif telegram_mini_app.shift_confirmation_empty and mini_app_card_permissions.shift_confirmation %}true{% else %}false{% endif %}"
        data-guard-locked="{% if telegram_mini_app.shift_confirmation and telegram_mini_app.shift_confirmation.requires_confirmation and not telegram_mini_app.shift_confirmation.confirmed %}true{% elif telegram_mini_app.shift_confirmation_empty and mini_app_card_permissions.shift_confirmation %}true{% else %}false{% endif %}"
      >
      {% with telegram_mini_app.goals as goals %}
      {% with telegram_mini_app.scorecard as scorecard %}
      {% if goals and goals.headline %}
        {% if mini_app_card_permissions.goals_selection or mini_app_card_permissions.goals_overview %}
      <section class="space-y-3">
        {% if goals.selection and goals.selection.is_open and mini_app_card_permissions.goals_selection %}
        <article
          class="rounded-3xl border border-rose-200 bg-gradient-to-br from-rose-50 via-amber-50 to-white p-5 shadow-2xl shadow-rose-200/70"
          data-goal-selector
          data-selected-id="{{ goals.selection.selected_option_id }}"
        >
          <header class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <p class="flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-rose-600">
                <span aria-hidden="true">üèÜ</span>
                Escoge tu plan de premio
              </p>
              <h2 class="text-lg font-semibold text-slate-900">{{ goals.selection.window_label }}</h2>
              <p class="mt-1 text-xs font-semibold uppercase tracking-wide text-rose-500">Tu recompensa mensual</p>
            </div>
            <span
              class="inline-flex items-center gap-2 rounded-full bg-rose-50/80 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-rose-600 shadow shadow-rose-200/60"
            >
              <span aria-hidden="true">üïí</span>
              Ventana activa
            </span>
          </header>
          <p class="mt-2 text-sm text-slate-700">{{ goals.selection.window_description }}</p>

          <div class="mt-4 rounded-2xl border border-amber-100 bg-white/80 p-4 shadow-inner shadow-amber-200/40">
            <div class="flex items-center justify-between gap-3">
              <button
                type="button"
                class="flex h-8 w-8 items-center justify-center rounded-full border border-amber-200 text-amber-600 transition hover:border-amber-400 hover:text-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-300/60"
                data-goal-nav="prev"
                aria-label="Meta anterior"
              >
                <span aria-hidden="true">‚Üê</span>
              </button>
              <div class="w-full flex-1">
                {% for option in goals.selection.options %}
                  <article
                    class="{% if option.id != goals.selection.selected_option_id %}hidden{% endif %} space-y-3 text-left"
                    data-goal-option
                    data-goal-option-id="{{ option.id }}"
                    data-goal-option-label="{{ option.title }}"
                  >
                    <div class="flex flex-wrap items-start justify-between gap-3">
                      <div>
                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Opci√≥n {{ forloop.counter }} de {{ goals.selection.options|length }}</p>
                        <h3 class="text-sm font-semibold text-slate-900">{{ option.title }}</h3>
                      </div>
                      <span
                        class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-600"
                      >
                        Premio
                        <span class="text-slate-900">{{ option.reward_label }}</span>
                      </span>
                    </div>
                    <p class="text-sm text-slate-700">{{ option.summary }}</p>
                    <ul class="space-y-1 text-xs text-slate-600">
                      <li>
                        <span class="font-semibold text-slate-800">Puntos requeridos:</span>
                        {{ option.points_required }}
                      </li>
                      <li>
                        <span class="font-semibold text-slate-800">Enfoque sugerido:</span>
                        {{ option.effort_label }}
                      </li>
                    </ul>
                    {% if option.badges %}
                      <div class="flex flex-wrap gap-2 text-[11px] font-semibold uppercase tracking-wide">
                        {% for badge in option.badges %}
                          <span
                            class="rounded-full px-2 py-0.5 {% if badge.theme == 'brand' %}bg-amber-100 text-amber-700{% elif badge.theme == 'success' %}bg-emerald-100 text-emerald-700{% else %}bg-slate-100 text-slate-600{% endif %}"
                          >
                            {{ badge.label }}
                          </span>
                        {% endfor %}
                      </div>
                    {% endif %}
                    <div class="flex flex-wrap gap-2">
                      {% for action in option.actions %}
                        <button
                          type="button"
                          class="rounded-full px-3 py-1 text-xs font-semibold transition {% if action.action == 'select' %}bg-brand text-slate-900 shadow shadow-amber-200/70 hover:bg-brand-dark{% else %}border border-slate-200 text-slate-600 hover:border-brand hover:text-brand{% endif %}"
                          data-goal-action="{{ action.action }}"
                          data-goal-option-id="{{ option.id }}"
                        >
                          {{ action.label }}
                        </button>
                      {% endfor %}
                    </div>
                  </article>
                {% endfor %}
              </div>
              <button
                type="button"
                class="flex h-8 w-8 items-center justify-center rounded-full border border-amber-200 text-amber-600 transition hover:border-amber-400 hover:text-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-300/60"
                data-goal-nav="next"
                aria-label="Meta siguiente"
              >
                <span aria-hidden="true">‚Üí</span>
              </button>
            </div>
            <div class="mt-3 flex items-center justify-between text-[11px] text-slate-500">
              <p data-goal-selection-label>
                Selecci√≥n actual:
                <span class="font-semibold text-slate-900" data-goal-selection-value>
                  {% for option in goals.selection.options %}
                    {% if option.id == goals.selection.selected_option_id %}
                      {{ option.title }}
                    {% endif %}
                  {% endfor %}
                </span>
              </p>
              <div class="flex items-center gap-1">
                {% for option in goals.selection.options %}
                  <span
                    class="h-2.5 w-2.5 rounded-full bg-slate-200"
                    data-goal-indicator
                    data-goal-option-id="{{ option.id }}"
                  ></span>
                {% endfor %}
              </div>
            </div>
          </div>
        </article>
        {% endif %}
        {% if mini_app_card_permissions.goals_overview %}
        <article class="relative overflow-hidden rounded-3xl border border-amber-100 bg-gradient-to-br from-amber-50/90 via-white to-emerald-50/80 p-5 shadow-xl shadow-amber-200/60">
          <div class="pointer-events-none absolute -right-6 -top-6 h-24 w-24 rounded-full bg-amber-200/40 blur-3xl"></div>
          <header class="flex flex-wrap items-start justify-between gap-3">
            <div class="flex flex-col gap-1">
              <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-amber-600">
                <span aria-hidden="true">üéØ</span>
                Tus metas activas
              </p>
              <h2 class="text-base font-semibold text-slate-900">{{ goals.headline.title }}</h2>
              <p class="text-xs font-semibold text-emerald-600">{{ goals.headline.progress_mood|default:"¬°Vas genial, sigue as√≠!" }}</p>
            </div>
            <div class="text-right">
              <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">
                <span aria-hidden="true">‚ú®</span>
                {{ goals.headline.progress_percent }}% cumplido
              </span>
              <p class="mt-1 text-[11px] text-slate-500">{{ goals.headline.deadline }}</p>
            </div>
          </header>
          <p class="mt-2 text-sm text-slate-700">{{ goals.headline.description }}</p>
          <div class="mt-4">
            <div class="flex flex-wrap items-center justify-between gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
              <span>{{ goals.headline.progress_label }}</span>
              <span>{{ goals.headline.points_gap_label }}</span>
            </div>
            <div class="mt-2 h-2 w-full rounded-full bg-white/70 shadow-inner shadow-amber-100/40">
              <div
                class="h-2 rounded-full bg-gradient-to-r from-amber-400 via-brand to-emerald-500"
                style="width: {{ goals.headline.progress_percent|default:0 }}%;"
                aria-hidden="true"
              ></div>
            </div>
          </div>
          <ul class="mt-4 space-y-2 text-xs text-slate-700">
            <li class="flex items-center justify-between">
              <span>Puntos validados</span>
              <span class="text-sm font-semibold text-slate-900">{{ scorecard.points }}</span>
            </li>
            {% if scorecard.next_reward %}
              <li class="flex items-center justify-between text-amber-700">
                <span>{{ scorecard.next_reward }}</span>
                <span class="rounded-full bg-amber-50 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide">Objetivo</span>
              </li>
            {% endif %}
            <li class="flex items-center justify-between">
              <span>{{ scorecard.streak }}</span>
              <span class="rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-700">Racha</span>
            </li>
            <li class="flex items-center justify-between">
              <span>{{ scorecard.extras }}</span>
              <span class="rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Extra</span>
            </li>
            {% if scorecard.penalties %}
              <li class="flex items-center justify-between text-rose-600">
                <span>{{ scorecard.penalties }}</span>
                <span class="rounded-full bg-rose-50 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide">Revisa</span>
              </li>
            {% endif %}
          </ul>
          <p class="mt-4 text-xs font-semibold text-brand">{{ scorecard.message }}</p>
          <details class="mt-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-4 text-xs text-slate-700">
            <summary class="flex cursor-pointer items-center justify-between text-[11px] font-semibold uppercase tracking-wide text-brand hover:text-brand-dark">
              <span>Ver m√°s metas y plan de puntos</span>
              <span aria-hidden="true">‚Üí</span>
            </summary>
            <div class="mt-3 space-y-3">
              {% if goals.items %}
                <div>
                  <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Focos de esta semana</p>
                  <ul class="mt-2 space-y-2">
                    {% for item in goals.items %}
                      <li class="rounded-2xl border border-slate-200 bg-white px-3 py-2">
                        <div class="flex items-center justify-between text-xs font-semibold text-slate-800">
                          <span>{{ item.title }}</span>
                          <span>{{ item.progress_percent }}%</span>
                        </div>
                        <div class="mt-2 h-1.5 w-full rounded-full bg-slate-100">
                          <div
                            class="h-1.5 rounded-full bg-emerald-400/80"
                            style="width: {{ item.progress_percent|default:0 }}%;"
                            aria-hidden="true"
                          ></div>
                        </div>
                        <p class="mt-2 text-[11px] text-slate-600">{{ item.progress_label }}</p>
                        <p class="text-[11px] font-semibold text-emerald-700">{{ item.impact }}</p>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
              <div class="rounded-2xl border border-slate-200 bg-white px-3 py-2">
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Rendimiento reciente</p>
                <ul class="mt-2 space-y-1">
                  <li>{{ scorecard.streak }}</li>
                  <li>{{ scorecard.extras }}</li>
                  {% if scorecard.penalties %}
                    <li class="text-rose-600">{{ scorecard.penalties }}</li>
                  {% endif %}
                  <li class="text-slate-600">Recuerda: cada incumplimiento resta el doble que una tarea completada.</li>
                </ul>
              </div>
              {% if telegram_mini_app.history %}
                <div class="rounded-2xl border border-slate-200 bg-white px-3 py-2">
                  <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Hist√≥rico r√°pido</p>
                  <ul class="mt-2 divide-y divide-slate-100 text-[11px] text-slate-600">
                    {% for item in telegram_mini_app.history %}
                      <li class="flex items-center justify-between py-2 first:pt-0 last:pb-0">
                        <span class="pr-3 font-semibold text-slate-900">{{ item.label }}</span>
                        <span class="text-right text-xs text-slate-500">{{ item.summary }}</span>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </div>
          </details>
        </article>
        {% endif %}
      </section>
        {% endif %}
      {% endif %}
      {% endwith %}
      {% endwith %}

{% include "task_manager/includes/mini_app_purchase_cards.html" %}

      <section class="space-y-3" data-daily-tasks-section>

        <div class="space-y-4">
          {% include "task_manager/includes/mini_app_production_card.html" %}

          {% with pending=telegram_mini_app.pending_classification %}
          {% if pending and mini_app_card_permissions.pending_classification %}
            <article
              class="rounded-3xl border border-slate-200 bg-gradient-to-br from-white via-slate-50/85 to-rose-50/65 p-5 shadow-xl shadow-slate-200/60"
              data-pending-classification-card
            >
              <header class="flex flex-wrap items-start justify-between gap-3">
                <div>
                  <p class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-100/80 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                    <span aria-hidden="true">üóÇÔ∏è</span>
                    Producciones por clasificar
                  </p>
                  <h3 class="text-lg font-semibold text-slate-900">{{ pending.title }}</h3>
                  {% if pending.description %}
                    <p class="mt-1 text-sm text-slate-600">{{ pending.description }}</p>
                  {% endif %}
                </div>
                <div class="flex flex-col items-end gap-2 text-right">
                  <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-100 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                    <span aria-hidden="true">üì¶</span>
                    {{ pending.total_cartons|intcomma }} cartones
                  </span>
                  <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-600">
                    <span aria-hidden="true">ü•ö</span>
                    {{ pending.total_eggs|intcomma }} huevos
                  </span>
                </div>
              </header>
              {% if pending.status_counts %}
                <div class="mt-4 flex flex-wrap items-center gap-2 text-[11px] font-semibold uppercase tracking-wide">
                  {% for status in pending.status_counts %}
                    <span
                      class="inline-flex items-center gap-2 rounded-full border px-3 py-1 {% if status.id == 'pending' %}border-rose-200 bg-rose-50 text-rose-700{% elif status.id == 'in_progress' %}border-amber-200 bg-amber-50 text-amber-700{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}"
                    >
                      {{ status.label }}: {{ status.count }}
                    </span>
                  {% endfor %}
                </div>
              {% endif %}
              {% if pending.alerts %}
                <div class="mt-3 rounded-2xl border border-rose-200 bg-rose-50/80 p-3 text-[11px] text-rose-700 shadow-inner shadow-rose-100/60">
                  <p class="font-semibold uppercase tracking-wide">Alertas</p>
                  <ul class="mt-1 space-y-1">
                    {% for alert in pending.alerts %}
                      <li class="flex items-start gap-2">
                        <span aria-hidden="true">‚ö†Ô∏è</span>
                        <span>{{ alert }}</span>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
              <div class="mt-4 space-y-3" data-pending-classification-list>
                {% for entry in pending.entries %}
                  <article class="rounded-2xl border px-4 py-3 text-sm text-slate-700 shadow-sm {% if entry.is_priority %}border-rose-200 bg-rose-50/80 shadow-rose-100/50{% else %}border-slate-200 bg-white/95 shadow-slate-200/50{% endif %}">
                    <header class="flex flex-wrap items-start justify-between gap-3">
                      <div>
                        <p class="text-sm font-semibold text-slate-900">{{ entry.farm }}</p>
                        <p class="text-[11px] uppercase tracking-wide text-slate-500">{{ entry.barn }}</p>
                      </div>
                      <div class="text-right">
                        <span class="inline-flex items-center gap-1 rounded-full bg-white/80 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-slate-500">
                          <span aria-hidden="true">üìÖ</span>
                          {{ entry.production_date_label }}
                        </span>
                      </div>
                    </header>
                    <div class="mt-3 flex flex-wrap items-center gap-2">
                      <span class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[10px] font-semibold uppercase tracking-wide {% if entry.status_theme == 'rose' %}border-rose-200 bg-rose-50 text-rose-700{% elif entry.status_theme == 'brand' %}border-amber-200 bg-amber-50 text-amber-700{% else %}border-slate-200 bg-slate-50 text-slate-600{% endif %}">
                        <span aria-hidden="true">‚óè</span>
                        {{ entry.status_label }}
                      </span>
                      {% if entry.responsible %}
                        <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[10px] font-semibold uppercase tracking-wide text-slate-600">
                          <span aria-hidden="true">üë•</span>
                          {{ entry.responsible }}
                        </span>
                      {% endif %}
                      {% if entry.is_priority %}
                        <span class="inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-100 px-3 py-1 text-[10px] font-semibold uppercase tracking-wide text-rose-700">
                          <span aria-hidden="true">‚ö†Ô∏è</span>
                          Trabajar primero
                        </span>
                      {% endif %}
                    </div>
                    <dl class="mt-3 grid gap-2 text-[11px] uppercase tracking-wide text-slate-500 sm:grid-cols-3">
                      <div>
                        <dt>Cartones</dt>
                        <dd class="mt-0.5 text-base font-semibold text-slate-900">{{ entry.cartons|intcomma }}</dd>
                      </div>
                      <div>
                        <dt>Huevos estimados</dt>
                        <dd class="mt-0.5 text-base font-semibold text-slate-900">{{ entry.eggs|intcomma }}</dd>
                      </div>
                      <div>
                        <dt>Espera</dt>
                        <dd class="mt-0.5 text-base font-semibold {% if entry.is_priority %}text-rose-600{% else %}text-slate-900{% endif %}">{{ entry.age_label }}</dd>
                      </div>
                    </dl>
                    {% if entry.alerts %}
                      <ul class="mt-3 space-y-1 text-[11px] text-rose-700">
                        {% for alert in entry.alerts %}
                          <li class="flex items-start gap-2">
                            <span aria-hidden="true">‚Üí</span>
                            <span>{{ alert }}</span>
                          </li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                    <div class="mt-4 flex flex-wrap items-center justify-end gap-2">
                      <button
                        type="button"
                        class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-white shadow-sm shadow-emerald-200/60 transition hover:bg-emerald-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300/60"
                        data-select-egg-stage="classification"
                      >
                        <span aria-hidden="true">ü•ö</span>
                        Clasificar
                      </button>
                    </div>
                  </article>
                {% endfor %}
              </div>
            </article>
          {% endif %}
        {% endwith %}

        {% with queue=telegram_mini_app.transport_queue %}
          {% if queue and mini_app_card_permissions.transport_queue %}
            <article
              class="rounded-3xl border border-slate-200 bg-gradient-to-br from-slate-50 via-white to-slate-100 p-5 shadow-lg shadow-slate-200/70"
              data-transport-queue-card
              data-default-expected-date="{{ queue.default_expected_date_iso }}"
            >
              <header class="flex flex-wrap items-start justify-between gap-3">
                <div>
                  <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                    <span aria-hidden="true">üöö</span>
                    Transporte interno pendiente
                  </p>
                  <h3 class="text-base font-semibold text-slate-900">
                    {{ queue.title|default:"Producciones listas para transporte" }}
                  </h3>
                </div>
                <div class="flex flex-col items-end gap-2 text-right">
                  <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-700 shadow-sm shadow-slate-200/70">
                    {{ queue.pending_count }} producciones /
                    {{ queue.total_cartons|intcomma }} cartones
                  </span>
                </div>
              </header>
              <p class="mt-3 text-xs text-slate-500">
                {{ queue.instructions }}
              </p>
              <form
                class="mt-4 space-y-4"
                data-transport-form
                {% if queue.submit_url %}data-transport-submit-url="{{ queue.submit_url }}"{% endif %}
              >
                <div class="space-y-3" data-transport-production-list>
                  {% for production in queue.productions %}
                      <label
                        class="relative flex flex-col gap-3 rounded-2xl border border-slate-200 bg-white/85 p-4 pl-12 shadow-sm shadow-slate-100/40 transition hover:border-slate-300 data-[state=authorized]:border-emerald-200 data-[state=authorized]:bg-emerald-50 data-[state=authorized]:shadow-emerald-100/60 data-[state=in_transit]:border-sky-200 data-[state=in_transit]:bg-sky-50 data-[state=in_transit]:shadow-sky-100/60"
                        data-transport-production-row
                        data-production-id="{{ production.id }}"
                        {% if production.state %}data-state="{{ production.state }}"{% endif %}
                      >
                      <input
                        type="checkbox"
                        class="absolute left-4 top-4 h-5 w-5 rounded border-slate-300 text-slate-600 focus:ring-slate-400"
                        value="{{ production.id }}"
                        data-transport-production-input
                        data-cartons="{{ production.cartons }}"
                        data-production-label="{{ production.label }}"
                        data-production-date="{{ production.production_date_iso }}"
                        data-production-date-label="{{ production.production_date_label }}"
                      />
                      <div class="flex items-start justify-between gap-3">
                        <div>
                          <h4 class="text-sm font-semibold text-slate-900">{{ production.label }}</h4>
                          <p class="text-xs text-slate-500">{{ production.farm }}</p>
                          <p class="text-xs text-slate-500">
                            Destino: {{ production.destination|default:"‚Äî" }}
                          </p>
                          {% if production.transporter_label or production.expected_date_label %}
                            <p class="text-[11px] text-slate-500">
                              {% if production.transporter_label %}
                                Transportador: {{ production.transporter_label }}
                              {% endif %}
                              {% if production.expected_date_label %}
                                {% if production.transporter_label %} ¬∑ {% endif %}
                                Salida estimada: {{ production.expected_date_label }}
                              {% endif %}
                            </p>
                          {% endif %}
                        </div>
                        <div class="flex flex-col items-end gap-2">
                          <span class="{% if production.state %}inline-flex{% else %}hidden{% endif %} items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide {% if production.state == 'in_transit' %}border-sky-200 bg-sky-50 text-sky-700{% else %}border-emerald-200 bg-emerald-50 text-emerald-700{% endif %}"
                                data-transport-production-status>
                            {{ production.state_label|default:"Autorizada" }}
                          </span>
                        </div>
                      </div>
                      <dl class="grid gap-2 text-[11px] text-slate-600 sm:grid-cols-3">
                        <div>
                          <dt class="uppercase tracking-wide text-slate-500">Producci√≥n</dt>
                          <dd class="mt-0.5 font-semibold text-slate-900">{{ production.production_date_label }}</dd>
                        </div>
                        <div>
                          <dt class="uppercase tracking-wide text-slate-500">Cartones</dt>
                          <dd class="mt-0.5 font-semibold text-slate-900">{{ production.cartons|intcomma }}</dd>
                        </div>
                        <div>
                          <dt class="uppercase tracking-wide text-slate-500">Salas</dt>
                          <dd class="mt-0.5 font-semibold text-slate-900">
                            {% if production.rooms %}
                              {{ production.rooms|join:", " }}
                            {% else %}
                              ‚Äî
                            {% endif %}
                          </dd>
                        </div>
                      </dl>
                    </label>
                  {% empty %}
                    <p class="rounded-2xl border border-emerald-200 bg-emerald-50/80 px-4 py-3 text-sm text-emerald-700">
                      No tienes producciones pendientes por transportar. ¬°Buen trabajo!
                    </p>
                  {% endfor %}
                </div>
                {% if queue.productions %}
                  <div class="grid gap-3 sm:grid-cols-2">
                    <label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white/90 p-4 text-xs text-slate-600">
                      <span class="text-xs font-semibold text-slate-700">Transportador</span>
                      <select
                        class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-amber-300 focus:outline-none focus:ring-2 focus:ring-amber-200/60"
                        data-transport-transporter
                      >
                        <option value="">Selecciona el transportador</option>
                        {% for transporter in queue.transporters %}
                          <option
                            value="{{ transporter.id }}"
                            {% if queue.default_transporter_id and transporter.id == queue.default_transporter_id %}selected{% endif %}
                          >
                            {{ transporter.label }}
                          </option>
                        {% endfor %}
                      </select>
                    </label>
                    <label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white/90 p-4 text-xs text-slate-600">
                      <span class="text-xs font-semibold text-slate-700">Fecha estimada de transporte</span>
                      <input
                        type="date"
                        class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-amber-300 focus:outline-none focus:ring-2 focus:ring-amber-200/60"
                        value="{{ queue.default_expected_date_iso }}"
                        data-transport-date
                      />
                    </label>
                  </div>
                  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <p class="hidden text-xs text-rose-600 sm:text-right" data-transport-feedback></p>
                    <button
                      type="submit"
                      class="inline-flex items-center gap-2 rounded-full bg-amber-600 px-4 py-2 text-xs font-semibold text-white shadow-sm shadow-amber-200/60 transition hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-300/60 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
                      data-transport-authorize
                      disabled
                    >
                      <span aria-hidden="true">üöõ</span>
                      Autorizar transporte
                    </button>
                  </div>
                {% endif %}
              </form>
              <div
                class="mt-4 hidden rounded-2xl border border-emerald-200 bg-emerald-50/90 p-4 text-xs text-emerald-700 shadow-inner shadow-emerald-100/60"
                data-transport-success
              >
                <p class="font-semibold">Transporte autorizado</p>
                <p data-transport-success-text></p>
              </div>
            </article>
          {% endif %}
        {% endwith %}

        {% with egg_flow=telegram_mini_app.egg_workflow %}
          {% if egg_flow and egg_flow.stages %}
            <div class="space-y-4" data-egg-stage-list>
              {% for stage in egg_flow.stages %}
                <article
                  class="rounded-3xl border bg-white p-5 shadow-lg shadow-slate-200/60{% if stage.tone == 'brand' %} border-amber-200 shadow-amber-200/60{% elif stage.tone == 'emerald' %} border-emerald-200 shadow-emerald-200/60{% elif stage.tone == 'sky' %} border-sky-200 shadow-sky-200/60{% elif stage.tone == 'slate' %} border-slate-200 shadow-slate-200/50{% endif %}"
                  data-egg-stage-card
                  data-egg-stage="{{ stage.id }}"
                  {% if stage.progress_url %}data-egg-stage-progress-url="{{ stage.progress_url }}"{% endif %}
                  {% if stage.progress %}
                    data-egg-stage-progress-index="{{ stage.progress.step_index }}"
                    data-egg-stage-progress-id="{{ stage.progress.step_id }}"
                  {% endif %}
                >
                  <header class="flex flex-wrap items-start justify-between gap-3">
                    <div class="flex items-start gap-3">
                      <span class="text-xl" aria-hidden="true">{{ stage.icon }}</span>
                      <div>
                        {% if stage.id != 'inventory_ready' and stage.id != 'dispatches' %}
                          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Etapa {{ forloop.counter }}</p>
                        {% endif %}
                        <h4 class="text-base font-semibold text-slate-900">{{ stage.title }}</h4>
                      </div>
                    </div>
                    {% if stage.id != 'inventory_ready' and stage.id != 'dispatches' %}
                      <span
                        class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide{% if stage.tone == 'brand' %} border-amber-300 bg-amber-50 text-amber-700{% elif stage.tone == 'emerald' %} border-emerald-300 bg-emerald-50 text-emerald-700{% elif stage.tone == 'sky' %} border-sky-300 bg-sky-50 text-sky-700{% elif stage.tone == 'slate' %} border-slate-300 bg-slate-100 text-slate-700{% else %} border-slate-200 bg-slate-50 text-slate-600{% endif %}"
                        data-egg-stage-chip
                      >
                        Pendiente
                      </span>
                    {% endif %}
                  </header>
                  {% if stage.summary %}
                    <p class="mt-3 text-sm text-slate-700">
                      {{ stage.summary }}
                    </p>
                  {% endif %}

                  {% if stage.id == 'verification' %}
                    {% if stage.entries %}
                      <form
                        class="mt-4 space-y-3"
                        data-egg-verification-form
                        {% if stage.submit_url %}data-egg-verification-submit-url="{{ stage.submit_url }}"{% endif %}
                      >
                        <p class="text-xs text-slate-600">
                          Confirma los cartones que sube cada transportador antes de cerrar el manifiesto.
                        </p>
                        <ul class="space-y-2">
                          {% for entry in stage.entries %}
                            <li class="rounded-2xl border border-sky-100 bg-white/80 p-3 shadow-sm shadow-sky-100/40">
                              <div class="flex items-start justify-between gap-2">
                                <div>
                                  <p class="text-sm font-semibold text-slate-900">{{ entry.label }}</p>
                                  <p class="text-[11px] text-slate-500">
                                    {{ entry.production_date_label }} ¬∑ {{ entry.destination|default:"Centro" }}
                                  </p>
                                </div>
                                <span class="text-xs font-semibold text-slate-500">{{ entry.cartons|intcomma }} cart</span>
                              </div>
                              <label class="mt-3 block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                                Cartones a transportar
                                <input
                                  type="number"
                                  min="0"
                                  step="1"
                                  inputmode="numeric"
                                  value="{{ entry.verified_cartons|default:entry.cartons }}"
                                  class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200/60"
                                  data-egg-stage-input
                                  data-egg-verification-input
                                  data-entry-id="{{ entry.id }}"
                                />
                              </label>
                            </li>
                          {% endfor %}
                        </ul>
                        <p class="hidden text-xs text-rose-600" data-egg-verification-feedback></p>
                        <div class="flex justify-end">
                          <button
                            type="submit"
                            class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-4 py-2 text-xs font-semibold text-white shadow-sm shadow-sky-200/60 transition hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-300/60"
                            data-egg-verification-submit
                          >
                            <span aria-hidden="true">üì¶</span>
                            Registrar verificaci√≥n
                          </button>
                        </div>
                      </form>
                    {% else %}
                      <p class="mt-4 text-xs text-slate-500">No hay producciones esperando verificaci√≥n.</p>
                    {% endif %}
                  {% endif %}
                    
                  {% if stage.id == 'transport' and stage.manifest %}
                    <form
                      class="mt-4 space-y-2"
                      data-transport-manifest-form
                      {% if stage.manifest.has_confirmable and stage.confirmation_url %}
                        data-transport-confirm-form
                        data-transport-confirm-url="{{ stage.confirmation_url }}"
                      {% endif %}
                    >
                      <div class="flex flex-wrap items-center justify-between gap-2">
                        <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                          {{ stage.manifest.entries|length }} lotes ¬∑ {{ stage.manifest.total_cartons|intcomma }} cartones
                        </span>
                      </div>
                      <ul class="grid gap-2 text-xs text-slate-600 sm:grid-cols-2" data-transport-manifest>
                        {% for entry in stage.manifest.entries %}
                          <li class="rounded-2xl border border-amber-100 bg-white/90 p-3 shadow-sm shadow-amber-100/40">
                            <div class="flex items-start justify-between gap-2">
                              <div>
                                <p class="text-sm font-semibold text-slate-900">{{ entry.label }}</p>
                                <p class="text-[11px] uppercase tracking-wide text-slate-500">{{ entry.production_date_label }}</p>
                              </div>
                            </div>
                            <dl class="mt-3 grid gap-2 text-[11px] uppercase tracking-wide text-slate-500">
                              <div>
                                <dt>Cartones</dt>
                                <dd class="mt-0.5 text-base font-semibold normal-case text-slate-900">
                                  {{ entry.cartons|intcomma }}
                                </dd>
                              </div>
                              <div>
                                <dt>Destino</dt>
                                <dd class="mt-0.5 text-sm font-semibold normal-case text-slate-800">
                                  {{ entry.destination|default:"‚Äî" }}
                                </dd>
                              </div>
                              <div>
                                <dt>Salas</dt>
                                <dd class="mt-0.5 text-sm font-semibold normal-case text-slate-800">
                                  {% if entry.rooms %}
                                    {{ entry.rooms|join:", " }}
                                  {% else %}
                                    ‚Äî
                                  {% endif %}
                                </dd>
                              </div>
                              <div>
                                <dt>Transportador</dt>
                                <dd class="mt-0.5 text-sm font-semibold normal-case text-slate-800">
                                  {{ entry.transporter|default:"Pendiente" }}
                                </dd>
                              </div>
                              <div>
                                <dt>Salida estimada</dt>
                                <dd class="mt-0.5 text-sm font-semibold normal-case text-slate-800">
                                  {{ entry.expected_date_label|default:"‚Äî" }}
                                </dd>
                              </div>
                              {% if entry.confirmed_cartons %}
                                <div>
                                  <dt>Confirmado</dt>
                                  <dd class="mt-0.5 text-sm font-semibold text-emerald-700">
                                    {{ entry.confirmed_cartons|intcomma }} cartones
                                  </dd>
                                </div>
                              {% endif %}
                            </dl>
                            {% if entry.can_confirm %}
                              <div class="mt-3 rounded-xl border border-slate-100 bg-slate-50/80 p-3">
                                <label class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                                  Cartones cargados por el transportador
                                  <input
                                    type="number"
                                    min="0"
                                    step="1"
                                    inputmode="numeric"
                                    value="{{ entry.confirmed_cartons|default:entry.cartons }}"
                                    class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                                    data-transport-confirm-input
                                    data-entry-id="{{ entry.id }}"
                                  />
                                </label>
                                <p class="mt-1 text-[11px] text-slate-500">Asignado: {{ entry.cartons|intcomma }} cartones.</p>
                              </div>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                      {% if stage.manifest.has_confirmable %}
                        <div class="flex flex-col gap-2 rounded-2xl border border-slate-100 bg-white/80 p-3 sm:flex-row sm:items-center sm:justify-between">
                          <p class="hidden text-xs text-rose-600" data-transport-confirm-feedback></p>
                          <button
                            type="submit"
                            class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 text-xs font-semibold text-white shadow-sm shadow-emerald-200/60 transition hover:bg-emerald-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300/60 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500"
                            data-transport-confirm-submit
                            disabled
                          >
                            <span aria-hidden="true">üì¶</span>
                            Registrar cargue
                          </button>
                        </div>
                      {% endif %}
                    </form>
                  {% endif %}

                  {% if stage.id == 'inspection' and stage.overview %}
                    <section class="mt-4 space-y-3" data-inspection-overview>
                      <div class="flex flex-wrap gap-2 text-xs font-semibold uppercase tracking-wide text-slate-600">
                        <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/90 px-3 py-1 shadow-sm shadow-slate-100/40">
                          <span aria-hidden="true">üóì</span>
                          {{ stage.overview.metadata_label }}
                        </span>
                      </div>
                      <div class="grid gap-2 text-sm text-slate-700 sm:grid-cols-4">
                        <div class="rounded-2xl border border-slate-200 bg-amber-50/70 p-3 text-center shadow-sm shadow-amber-100/40">
                          <p class="text-[11px] font-semibold uppercase tracking-wide text-amber-600">Producci√≥n inicial</p>
                          <p class="mt-1 text-lg font-semibold text-slate-900">
                            {{ stage.overview.initial_cartons|intcomma }}
                            <span class="ml-1 text-xs font-semibold uppercase tracking-wide text-slate-500">cartones</span>
                          </p>
                        </div>
                        <div class="rounded-2xl border border-slate-200 bg-white/85 p-3 text-center shadow-sm shadow-slate-100/40">
                          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Transportado</p>
                          <p class="mt-1 text-lg font-semibold text-slate-900">
                            {{ stage.overview.transported_cartons|intcomma }}
                            <span class="ml-1 text-xs font-semibold uppercase tracking-wide text-slate-500">cartones</span>
                          </p>
                        </div>
                        <div class="rounded-2xl border border-slate-200 bg-emerald-50/70 p-3 text-center shadow-sm shadow-emerald-100/40">
                          <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600">Aptos clasificados</p>
                          <p class="mt-1 text-lg font-semibold text-slate-900">
                            {{ stage.overview.classified_cartons|intcomma }}
                            <span class="ml-1 text-xs font-semibold uppercase tracking-wide text-slate-500">cartones</span>
                          </p>
                        </div>
                        <div class="rounded-2xl border border-slate-200 bg-rose-50/70 p-3 text-center shadow-sm shadow-rose-100/40">
                          <p class="text-[11px] font-semibold uppercase tracking-wide text-rose-600">No aptos</p>
                          <p class="mt-1 text-lg font-semibold text-rose-600">
                            {{ stage.overview.discarded_cartons|intcomma }}
                            <span class="ml-1 text-xs font-semibold uppercase tracking-wide text-rose-500">cartones</span>
                          </p>
                        </div>
                      </div>
                    </section>
                  {% endif %}

                  {% if stage.id == 'inspection' and stage.inspection_categories %}
                    <section class="mt-4 space-y-3 rounded-2xl border border-slate-200 bg-slate-50/80 p-4" data-inspection-input-panel>
                      <header class="flex flex-wrap items-center justify-between gap-3">
                        <div>
                          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Detalle cartones aptos vs no aptos</p>
                          <p class="text-xs text-slate-500">Compara con lo clasificado y ajusta lo que encuentres realmente en bodega.</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 text-[11px] font-semibold uppercase tracking-wide">
                          <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-3 py-1 text-emerald-700 shadow-inner shadow-emerald-100/60">
                            Aptos: {{ stage.overview.classified_cartons|intcomma }}
                          </span>
                          <span class="inline-flex items-center gap-1 rounded-full bg-rose-100 px-3 py-1 text-rose-600 shadow-inner shadow-rose-100/60">
                            No aptos: {{ stage.overview.discarded_cartons|intcomma }}
                          </span>
                        </div>
                      </header>
                      <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white">
                        <table class="min-w-full divide-y divide-slate-200 text-sm text-slate-700">
                          <thead class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                            <tr>
                              <th scope="col" class="px-4 py-3 text-left">Tipo</th>
                              <th scope="col" class="px-4 py-3 text-right">Clasificado</th>
                              <th scope="col" class="px-4 py-3 text-right">Confirmado</th>
                            </tr>
                          </thead>
                          <tbody class="divide-y divide-slate-100">
                            {% for category in stage.inspection_categories %}
                              <tr>
                                <td class="px-4 py-3">
                                  <div class="flex items-center justify-between gap-3">
                                    <span class="text-sm font-semibold text-slate-900">{{ category.label }}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide {% if category.kind == 'discard' %}border-rose-200 bg-rose-50 text-rose-600{% else %}border-emerald-200 bg-emerald-50 text-emerald-600{% endif %}">
                                      {% if category.kind == 'discard' %}No apto{% else %}Apto{% endif %}
                                    </span>
                                  </div>
                                </td>
                                <td class="px-4 py-3 text-right text-sm font-semibold text-slate-600">
                                  {{ category.cartons|intcomma }}
                                </td>
                                <td class="px-4 py-3 text-right">
                                  <input
                                    type="number"
                                    min="0"
                                    step="1"
                                    inputmode="numeric"
                                    placeholder="{{ category.cartons }}"
                                    value="{{ category.cartons }}"
                                    class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                                    data-egg-stage-input
                                    data-stage="{{ stage.id }}"
                                    data-field="caliber_{{ category.id }}_cartons"
                                    data-inspection-caliber-input
                                    data-category="{{ category.id }}"
                                    data-kind="{{ category.kind }}"
                                  />
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                      <div
                        class="rounded-2xl border border-slate-200 bg-white/95 p-3 text-xs text-slate-600"
                        data-inspection-summary
                        data-expected-cartons="{{ stage.overview.classified_cartons }}"
                      >
                        <p data-inspection-summary-total>Aptos confirmados: 0 cartones</p>
                        <p data-inspection-summary-discard>No aptos confirmados: 0 cartones</p>
                        <p class="mt-1 text-[11px] text-slate-500" data-inspection-summary-feedback>Ingresa los totales por tipo para validar la disponibilidad.</p>
                      </div>
                    </section>
                  {% endif %}

                  {% if stage.metrics %}
                    {% with metrics_count=stage.metrics|length %}
                      <dl class="mt-4 grid gap-3 text-sm text-slate-700 {% if metrics_count == 1 %}sm:grid-cols-1{% elif metrics_count == 2 %}sm:grid-cols-2{% else %}sm:grid-cols-3{% endif %}">
                        {% for metric in stage.metrics %}
                          <div class="rounded-2xl border border-slate-100 bg-slate-50/70 p-3">
                            <dt class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">{{ metric.label }}</dt>
                            <dd class="mt-1 text-lg font-semibold text-slate-900">
                              {{ metric.value|intcomma }}
                              <span class="ml-1 text-xs font-semibold uppercase tracking-wide text-slate-500">{{ metric.unit }}</span>
                            </dd>
                          </div>
                        {% endfor %}
                      </dl>
                    {% endwith %}
                  {% endif %}

                  {% if stage.id == 'inventory_ready' and stage.inventory %}
                    <section class="mt-4 space-y-4" data-inventory-ready>
                      {% if stage.inventory.alerts %}
                        <div class="rounded-2xl border border-rose-200 bg-rose-50/80 p-4 text-xs text-rose-700 shadow-inner shadow-rose-100/60">
                          <p class="text-[11px] font-semibold uppercase tracking-wide">Alertas</p>
                          <ul class="mt-2 space-y-1">
                            {% for alert in stage.inventory.alerts %}
                              <li class="flex items-start gap-2">
                                <span aria-hidden="true">‚ö†Ô∏è</span>
                                <span>{{ alert }}</span>
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% endif %}
                      <div class="overflow-hidden rounded-2xl border border-emerald-100 bg-white shadow-inner shadow-emerald-100/60">
                        <table class="min-w-full divide-y divide-emerald-100 text-sm text-slate-700">
                          <thead class="bg-emerald-50 text-xs font-semibold uppercase tracking-wide text-emerald-700">
                            <tr>
                              <th scope="col" class="px-3 py-2 text-left text-sm">Tipo</th>
                              <th scope="col" class="px-3 py-2 text-right text-sm">Clasificado</th>
                              <th scope="col" class="px-3 py-2 text-right text-sm">Reservado</th>
                              <th scope="col" class="px-3 py-2 text-right text-sm">Disponible</th>
                            </tr>
                          </thead>
                          <tbody class="divide-y divide-emerald-50">
                            {% for item in stage.inventory.breakdown %}
                              <tr{% if item.available_cartons == 0 %} class="bg-rose-50/50"{% endif %}>
                                <td class="px-3 py-2 text-base font-semibold text-slate-900">
                                  {{ item.label }}
                                </td>
                                <td class="px-3 py-2 text-right text-base font-semibold text-slate-700">
                                  {{ item.cartons|intcomma }}
                                </td>
                                <td class="px-3 py-2 text-right text-base font-semibold text-amber-700">
                                  {{ item.reserved_cartons|intcomma }}
                                </td>
                                <td class="px-3 py-2 text-right text-base font-semibold {% if item.available_cartons == 0 %}text-rose-600{% else %}text-emerald-700{% endif %}">
                                  {{ item.available_cartons|intcomma }}
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                      <div class="space-y-3">
                        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                          Reservas activas para pr√≥ximos pedidos
                        </p>
                        <div class="grid gap-3 lg:grid-cols-2">
                          {% for reservation in stage.inventory.reservations %}
                            <article class="rounded-2xl border border-emerald-100 bg-white/95 p-4 text-xs text-slate-600 shadow-sm shadow-emerald-100/60">
                              <header class="flex flex-wrap items-start justify-between gap-2">
                                <div>
                                  <p class="text-sm font-semibold text-slate-900">{{ reservation.vendor }}</p>
                                  <p class="text-[11px] uppercase tracking-wide text-emerald-600">{{ reservation.channel }}</p>
                                  {% if reservation.contact %}
                                    <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">{{ reservation.contact }}</p>
                                  {% endif %}
                                </div>
                                <div class="text-right">
                                  <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-emerald-700">
                                    <span aria-hidden="true">üìÖ</span>
                                    {{ reservation.delivery_date_label }}
                                  </span>
                                  <p class="mt-1 text-[10px] font-semibold uppercase tracking-wide text-slate-500">{{ reservation.status }}</p>
                                </div>
                              </header>
                              <ul class="mt-3 space-y-2 text-slate-700">
                                {% for item in reservation.items %}
                                  <li class="flex items-center justify-between gap-3 rounded-xl border border-slate-100 bg-slate-50/70 px-3 py-2">
                                    <span class="text-sm font-semibold text-slate-900">{{ item.label }}</span>
                                    <span class="text-right text-xs font-semibold text-slate-600">
                                      {{ item.cartons|intcomma }} cartones
                                      <span class="block text-[11px] font-semibold uppercase tracking-wide text-emerald-600">{{ item.carton_price_label }}</span>
                                    </span>
                                  </li>
                                {% endfor %}
                              </ul>
                              <p class="mt-3 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                                Total reservado: {{ reservation.total_cartons|intcomma }} cartones ¬∑ {{ reservation.total_amount_label }}
                              </p>
                            </article>
                          {% endfor %}
                        </div>
                      </div>
                      <div class="rounded-2xl border border-dashed border-emerald-200 bg-emerald-50/60 p-4 text-sm text-emerald-700 shadow-inner shadow-emerald-100/50">
                        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                          <p class="text-sm text-emerald-700">
                            Usa el inventario disponible para programar un despacho directo a ventas.
                          </p>
                          <button
                            type="button"
                            class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white shadow shadow-emerald-200/70 transition hover:bg-emerald-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400/70"
                            data-dispatch-create-trigger
                          >
                            <span aria-hidden="true">‚ûï</span>
                            Crear despacho
                          </button>
                        </div>
                      </div>
                    </section>
                  {% endif %}

                  {% if stage.id == 'dispatches' %}
                    <section class="mt-4 space-y-4" data-dispatch-board>
                      <div class="flex flex-wrap items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-slate-600">
                          <span aria-hidden="true">üë•</span>
                          Vendedores activos: {{ stage.vendors_count }}
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-slate-600">
                          <span aria-hidden="true">üì¶</span>
                          Tipos monitoreados: {{ stage.type_catalog|length }}
                        </span>
                      </div>
                      {% if stage.pending_badges %}
                        <div class="flex flex-wrap gap-2">
                          {% for badge in stage.pending_badges %}
                            <span class="inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-rose-600">
                              <span aria-hidden="true">‚ö†Ô∏è</span>
                              {{ badge }}
                            </span>
                          {% endfor %}
                        </div>
                      {% endif %}
                      <div class="space-y-3" data-dispatch-list>
                        {% for dispatch in stage.dispatches %}
                          <article
                            class="rounded-2xl border border-slate-200 bg-white/90 p-4 text-sm text-slate-700 shadow-sm shadow-slate-200/50"
                            data-dispatch-row
                            data-dispatch-id="{{ dispatch.id }}"
                            data-dispatch-status="{{ dispatch.status }}"
                          >
                            <header class="flex flex-wrap items-start justify-between gap-3">
                              <div class="space-y-1">
                                <p class="text-base font-semibold text-slate-900">
                                  {{ dispatch.vendor.name }}
                                </p>
                                <div class="flex flex-wrap items-center gap-2 text-[10px] font-semibold uppercase tracking-wide">
                                  <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-slate-600">
                                    {{ dispatch.vendor.channel }}
                                  </span>
                                  <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-slate-600">
                                    {{ dispatch.seller }}
                                  </span>
                                </div>
                              </div>
                              <div class="flex flex-col items-end gap-2 text-right">
                                <span class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-white shadow shadow-slate-300/70">
                                  <span aria-hidden="true">üìÖ</span>
                                  {{ dispatch.scheduled_date_label }}
                                </span>
                                <span
                                  class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {% if dispatch.status_theme == 'emerald' %}border-emerald-300 bg-emerald-50 text-emerald-700{% elif dispatch.status_theme == 'brand' %}border-amber-300 bg-amber-50 text-amber-700{% elif dispatch.status_theme == 'rose' %}border-rose-300 bg-rose-50 text-rose-600{% elif dispatch.status_theme == 'sky' %}border-sky-300 bg-sky-50 text-sky-700{% else %}border-slate-300 bg-slate-50 text-slate-600{% endif %}"
                                  data-dispatch-status-chip
                                  data-dispatch-id="{{ dispatch.id }}"
                                  data-dispatch-status="{{ dispatch.status }}"
                                >
                                  {{ dispatch.status_label }}
                                </span>
                              </div>
                            </header>
                            <dl class="mt-3 grid gap-3 text-xs text-slate-600 sm:grid-cols-3">
                              <div class="rounded-xl border border-slate-100 bg-white/80 p-3">
                                <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Conductor</dt>
                                <dd class="mt-1 text-sm font-semibold text-slate-900">{{ dispatch.driver.name }}</dd>
                                <dd class="text-[11px] text-slate-500">{{ dispatch.driver.phone }}</dd>
                              </div>
                              <div class="rounded-xl border border-slate-100 bg-white/80 p-3">
                                <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Veh√≠culo</dt>
                                <dd class="mt-1 text-sm font-semibold text-slate-900">{{ dispatch.vehicle.label }}</dd>
                                <dd class="text-[11px] text-slate-500">Placa {{ dispatch.vehicle.plate }}</dd>
                              </div>
                              <div class="rounded-xl border border-slate-100 bg-white/80 p-3">
                                <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Contacto</dt>
                                <dd class="mt-1 text-sm font-semibold text-slate-900">{{ dispatch.contact }}</dd>
                                {% if dispatch.notes %}
                                  <dd class="mt-1 text-[11px] text-slate-500">
                                    {{ dispatch.notes }}
                                  </dd>
                                {% endif %}
                              </div>
                            </dl>
                            <ul class="mt-4 divide-y divide-slate-100 rounded-xl border border-slate-100 bg-white/80" data-dispatch-items>
                                {% for item in dispatch.items %}
                                  <li
                                    class="flex flex-wrap items-center justify-between gap-2 px-3 py-2"
                                    data-dispatch-item
                                    data-dispatch-id="{{ dispatch.id }}"
                                    data-item-type="{{ item.type_id }}"
                                    data-unit="{{ item.unit }}"
                                    data-unit-label="{{ item.unit_label }}"
                                  >
                                    <div class="flex items-center gap-2">
                                      <span class="text-sm font-semibold text-slate-900">{{ item.label }}</span>
                                    </div>
                                    <div class="flex flex-col items-end gap-1 text-xs text-slate-500">
                                      <div class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-emerald-600">
                                        Confirmado <span data-dispatch-item-confirmed>{{ item.confirmed|intcomma }}</span> {% if item.unit == 'cartons' %}cart{% else %}{{ item.unit_label }}{% endif %}
                                      </div>
                                      <span
                                        class="inline-flex items-center gap-1 whitespace-nowrap rounded-full border px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide {% if item.difference %}border-rose-200 bg-rose-50 text-rose-600{% else %}hidden{% endif %}"
                                        data-dispatch-item-difference
                                      >
                                        {% if item.difference %}
                                          - {{ item.difference|intcomma }} {% if item.unit == 'cartons' %}cart{% else %}{{ item.unit_label }}{% endif %}
                                        {% endif %}
                                      </span>
                                    </div>
                                </li>
                              {% endfor %}
                            </ul>
                            <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-xs text-slate-600">
                              <div class="grid w-full gap-2 text-[11px] font-semibold uppercase tracking-wide text-slate-600 md:grid-cols-2">
                                <div class="flex items-center justify-between gap-3 rounded-lg bg-slate-100 px-3 py-1">
                                  <span>Cartones solicitados</span>
                                  <span class="text-slate-900">{{ dispatch.totals.requested_cartons|intcomma }}</span>
                                </div>
                                <div class="flex items-center justify-between gap-3 rounded-lg bg-emerald-50 px-3 py-1">
                                  <span class="text-emerald-700">Cartones confirmados</span>
                                  <span class="text-emerald-700" data-dispatch-summary-cartons data-dispatch-id="{{ dispatch.id }}">
                                    {{ dispatch.totals.confirmed_cartons|intcomma }}
                                  </span>
                                </div>
                                <div class="flex items-center justify-between gap-3 rounded-lg bg-slate-100 px-3 py-1">
                                  <span>Aves solicitadas</span>
                                  <span class="text-slate-900">{{ dispatch.totals.requested_hens|intcomma }}</span>
                                </div>
                                <div class="flex items-center justify-between gap-3 rounded-lg bg-emerald-50 px-3 py-1">
                                  <span class="text-emerald-700">Aves confirmadas</span>
                                  <span class="text-emerald-700" data-dispatch-summary-hens data-dispatch-id="{{ dispatch.id }}">
                                    {{ dispatch.totals.confirmed_hens|intcomma }}
                                  </span>
                                </div>
                              </div>
                              <div class="flex flex-wrap gap-2">
                                <button
                                  type="button"
                                  class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                                  data-dispatch-detail-trigger
                                  data-dispatch-id="{{ dispatch.id }}"
                                >
                                  Ver detalle
                                </button>
                                <button
                                  type="button"
                                  class="rounded-full bg-brand px-3 py-1 text-xs font-semibold text-slate-900 shadow shadow-amber-200/60 transition hover:bg-brand-dark focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                                  data-dispatch-edit-trigger
                                  data-dispatch-id="{{ dispatch.id }}"
                                >
                                  Editar
                                </button>
                              </div>
                            </div>
                          </article>
                        {% empty %}
                          <div class="rounded-2xl border border-slate-200 bg-white/70 p-4 text-sm text-slate-600">
                            No hay despachos programados. Usa el bot√≥n de crear para iniciar uno.
                          </div>
                        {% endfor %}
                      </div>
                    </section>
                  {% endif %}

                  {% if stage.id == 'classification' %}
                    <div
                      class="mt-4 rounded-2xl border border-emerald-200 bg-emerald-50/70 p-4"
                      data-classification-panel
                    >
                      <header class="flex flex-wrap items-center justify-between gap-3">
                        <div>
                          <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600">Tipos esperados</p>
                          <p class="text-sm text-slate-600">Verifica que la sumatoria coincida con el lote recibido.</p>
                        </div>
                        <span class="inline-flex items-center gap-2 rounded-full bg-white/80 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-700 shadow-sm shadow-emerald-200/60">
                          Meta: {{ egg_flow.batch.produced_cartons|intcomma }} cartones
                        </span>
                      </header>
                      <div class="mt-4 space-y-3" data-classification-rows>
                        {% for category in stage.categories %}
                          <div
                            class="rounded-2xl border border-emerald-100 bg-white/90 p-3"
                            data-classification-row
                            data-category-id="{{ category.id }}"
                            data-expected-cartons="{{ category.cartons }}"
                            data-eggs-per-carton="{{ egg_flow.cartons_per_pack }}"
                          >
                            <div class="flex flex-wrap items-center justify-between gap-3">
                              <div>
                                <p class="text-sm font-semibold text-slate-900">{{ category.label }}</p>
                                <p class="text-xs text-slate-500">{{ category.cartons|intcomma }} cartones ¬∑ {{ category.eggs|intcomma }} huevos ¬∑ {{ category.percentage }}%</p>
                              </div>
                              <span class="inline-flex items-center gap-2 rounded-full border px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide{% if category.theme == 'emerald' %} border-emerald-200 bg-emerald-50 text-emerald-600{% elif category.theme == 'amber' %} border-amber-200 bg-amber-50 text-amber-600{% elif category.theme == 'sky' %} border-sky-200 bg-sky-50 text-sky-600{% elif category.theme == 'slate' %} border-slate-200 bg-slate-100 text-slate-600{% elif category.theme == 'violet' %} border-violet-200 bg-violet-50 text-violet-600{% elif category.theme == 'brand' %} border-amber-200 bg-amber-50 text-amber-700{% elif category.theme == 'rose' %} border-rose-200 bg-rose-50 text-rose-600{% else %} border-slate-200 bg-slate-100 text-slate-600{% endif %}">
                                Meta
                              </span>
                            </div>
                            <div class="mt-3 grid gap-3 sm:grid-cols-3">
                              <div>
                                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Equivalencia esperada</p>
                                <p class="mt-1 text-sm font-semibold text-emerald-700">{{ category.eggs|intcomma }} huevos</p>
                              </div>
                              <label class="block" data-classification-input-wrapper>
                                <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Cartones registrados</span>
                                <input
                                  type="number"
                                  min="0"
                                  step="1"
                                  placeholder="{{ category.cartons }}"
                                  class="mt-1 w-full rounded-lg border border-emerald-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200/60"
                                  data-classification-input
                                  data-category-id="{{ category.id }}"
                                />
                              </label>
                              <div>
                                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Huevos registrados</p>
                                <p class="mt-1 text-sm font-semibold text-slate-900" data-classification-eggs data-category-id="{{ category.id }}">0 huevos</p>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                      <div class="mt-4 space-y-2 rounded-2xl border border-emerald-200 bg-white/90 p-3 text-xs text-emerald-700">
                        <p class="font-semibold">Totales esperados: {{ egg_flow.batch.produced_cartons|intcomma }} cartones ({{ egg_flow.batch.produced_eggs|intcomma }} huevos)</p>
                        <p
                          data-classification-summary
                          data-expected-cartons="{{ egg_flow.batch.produced_cartons }}"
                          data-expected-eggs="{{ egg_flow.batch.produced_eggs }}"
                          data-eggs-per-carton="{{ egg_flow.cartons_per_pack }}"
                        >
                          Totales registrados: 0 cartones (0 huevos)
                        </p>
                        <p class="text-[11px] text-emerald-600" data-classification-feedback>
                          Si hay diferencia, revisa los descartes o ajusta el transporte antes de liberar el lote.
                        </p>
                      </div>
                    </div>
                  {% endif %}

                  {% if stage.fields %}
                    <div class="mt-4" data-egg-stage-form>
                      <div class="{% if stage.id == 'verification' %}grid gap-3 sm:grid-cols-2{% else %}space-y-3{% endif %}">
                      {% for field in stage.fields %}
                          <label
                            class="block{% if stage.id == 'verification' %} rounded-2xl border border-slate-200 bg-white/80 p-3 shadow-sm shadow-slate-100/60{% endif %}"
                            data-egg-stage-field="{{ field.id }}"
                          >
                            <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                              {{ field.label }}
                            </span>
                          {% if field.multiline %}
                            <textarea
                              rows="3"
                              placeholder="{{ field.placeholder }}"
                              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                              data-egg-stage-input
                              data-stage="{{ stage.id }}"
                              data-field="{{ field.id }}"
                            ></textarea>
                          {% else %}
                            <input
                              type="{{ field.input_type|default:'text' }}"
                              placeholder="{{ field.placeholder }}"
                              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                              data-egg-stage-input
                              data-stage="{{ stage.id }}"
                              data-field="{{ field.id }}"
                            />
                          {% endif %}
                        </label>
                      {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  {% if stage.checkpoints %}
                    <ul class="mt-4 space-y-2 rounded-2xl border border-slate-100 bg-slate-50/70 p-4 text-xs text-slate-600">
                      {% for checkpoint in stage.checkpoints %}
                        <li class="flex items-start gap-2">
                          <span aria-hidden="true">‚Ä¢</span>
                          <span>{{ checkpoint }}</span>
                        </li>
                      {% endfor %}
                    </ul>
                  {% endif %}

                  {% if stage.id == 'transport' %}
                    <div class="mt-5 space-y-3">
                      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500" data-egg-stage-status>Selecciona el estado actual del transporte.</p>
                      {% if stage.progress_steps %}
                        <div class="flex flex-wrap gap-2" data-egg-stage-progress data-stage="{{ stage.id }}">
                          {% for step in stage.progress_steps %}
                            <button
                              type="button"
                              class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/50"
                              data-egg-stage-progress-step
                              data-stage="{{ stage.id }}"
                              data-step-index="{{ forloop.counter0 }}"
                              data-step-id="{{ step.id }}"
                              data-step-label="{{ step.label }}"
                            >
                              {{ step.label }}
                            </button>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  {% else %}
                    {% if stage.id == 'verification' %}
                      <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500" data-egg-stage-status>Listo para registrar</p>
                        <button
                          type="button"
                          class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/90 px-4 py-2 text-xs font-semibold text-slate-700 shadow-sm shadow-slate-100/60 transition hover:border-slate-300 hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-200/70"
                          data-egg-stage-complete
                          data-stage="{{ stage.id }}"
                          data-auto-complete="true"
                        >
                          Guardar
                        </button>
                      </div>
                    {% elif stage.id == 'inspection' %}
                      <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500" data-egg-stage-status>Confirma inspecci√≥n y guarda resultados.</p>
                        <button
                          type="button"
                          class="rounded-full bg-brand px-5 py-2 text-xs font-semibold text-slate-900 shadow shadow-amber-200/60 transition hover:bg-brand-dark focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                          data-egg-stage-save
                          data-completes-stage
                          data-stage="{{ stage.id }}"
                        >
                          Guardar
                        </button>
                      </div>
                    {% elif stage.id == 'inventory_ready' %}
                      {# sin acciones para un card informativo #}
                    {% elif stage.id == 'dispatches' %}
                      <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500" data-egg-stage-status>
                          Gestiona los despachos con los botones del listado.
                        </p>
                      </div>
                    {% else %}
                    <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500" data-egg-stage-status>Esperando registro</p>
                      <div class="flex flex-wrap gap-2">
                        <button
                          type="button"
                          class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/50"
                          data-egg-stage-save
                          data-stage="{{ stage.id }}"
                        >
                          Guardar etapa
                        </button>
                        <button
                          type="button"
                          class="rounded-full bg-brand px-4 py-2 text-xs font-semibold text-slate-900 shadow shadow-amber-200/60 transition hover:bg-brand-dark focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                          data-egg-stage-complete
                          data-stage="{{ stage.id }}"
                        >
                          Guardar
                        </button>
                      </div>
                    </div>
                    {% endif %}
                  {% endif %}

                  <div
                    class="mt-4 hidden rounded-2xl border border-emerald-200 bg-emerald-50/80 p-3 text-xs text-emerald-700"
                    data-egg-stage-complete-banner
                  >
                    <p class="font-semibold">Etapa registrada</p>
                    <p>Tu informaci√≥n qued√≥ guardada. Puedes actualizarla en cualquier momento.</p>
                  </div>
                </article>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% with dispatch_summary=telegram_mini_app.egg_workflow.dispatch_summary %}
          {% if dispatch_summary %}
            {% if mini_app_card_permissions.dispatch_form or mini_app_card_permissions.dispatch_detail %}
            <div class="mt-5 space-y-4" data-dispatch-panels>
              {% if mini_app_card_permissions.dispatch_form %}
              <article
                class="hidden rounded-3xl border border-slate-200 bg-white p-5 shadow-xl shadow-slate-200/70"
                data-dispatch-form-card
              >
                <header class="flex items-start justify-between gap-3">
                  <div class="space-y-1">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-brand">
                      Programar despacho
                    </p>
                  </div>
                  <button
                    type="button"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-500 transition hover:text-slate-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-200/70"
                    data-dispatch-close
                    aria-label="Cerrar panel de gesti√≥n de despacho"
                  >
                    ‚úï
                  </button>
                </header>
                <div class="mt-4 space-y-4" data-dispatch-form-container>
                  <div
                    class="hidden rounded-2xl border border-dashed border-slate-200 bg-slate-50/60 p-4"
                    data-dispatch-form
                    data-dispatch-id="new"
                    data-dispatch-mode="create"
                  >
                    <header class="flex items-start justify-between gap-3">
                      <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Nuevo despacho</p>
                    </header>
                    <form class="mt-4 space-y-4" data-dispatch-form-body>
                      <div class="grid gap-3 sm:grid-cols-2">
                        <label class="block text-sm font-semibold text-slate-600">
                          Fecha programada
                          <input
                            type="date"
                            value="{{ dispatch_summary.form.scheduled_date_value }}"
                            class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                            data-dispatch-input
                            data-field="scheduled_date"
                          />
                        </label>
                        <label class="block text-sm font-semibold text-slate-600">
                          Conductor
                          <select
                            class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                            data-dispatch-input
                            data-field="driver"
                          >
                            {% for driver in dispatch_summary.form.drivers %}
                              <option value="{{ driver.id }}">{{ driver.name }} ¬∑ {{ driver.phone }}</option>
                            {% endfor %}
                          </select>
                        </label>
                        <label class="block text-sm font-semibold text-slate-600">
                          Vendedor
                          <select
                            class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                            data-dispatch-input
                            data-field="vendor"
                          >
                            {% for vendor in dispatch_summary.form.vendors %}
                              <option value="{{ vendor.id }}">{{ vendor.name }} ¬∑ {{ vendor.channel }}</option>
                            {% endfor %}
                          </select>
                        </label>
                        <label class="block text-sm font-semibold text-slate-600">
                          Veh√≠culo
                          <select
                            class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                            data-dispatch-input
                            data-field="vehicle"
                          >
                            {% for vehicle in dispatch_summary.form.vehicles %}
                              <option value="{{ vehicle.id }}">{{ vehicle.label }} ¬∑ {{ vehicle.plate }}</option>
                            {% endfor %}
                          </select>
                        </label>
                      </div>
                      <div class="overflow-hidden rounded-2xl border border-slate-200">
                        <table class="min-w-full divide-y divide-slate-200 text-sm text-slate-700">
                          <thead class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                            <tr>
                              <th scope="col" class="px-3 py-2 text-left">Tipo</th>
                              <th scope="col" class="px-3 py-2 text-left">Unidad</th>
                              <th scope="col" class="px-3 py-2 text-right">Solicitado</th>
                            </tr>
                          </thead>
                          <tbody class="divide-y divide-slate-100">
                            {% for type_entry in dispatch_summary.form.type_catalog %}
                              <tr>
                                <td class="px-3 py-2 text-sm font-semibold text-slate-900">{{ type_entry.label }}</td>
                                <td class="px-3 py-2 text-xs uppercase tracking-wide text-slate-500">{{ type_entry.unit }}</td>
                                <td class="px-3 py-2 text-right">
                                  <input
                                    type="number"
                                    min="0"
                                    step="1"
                                    value="0"
                                    class="w-full rounded-lg border border-slate-200 px-2 py-1 text-right text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                                    data-dispatch-input
                                    data-field="requested"
                                    data-type="{{ type_entry.id }}"
                                    data-unit="{{ type_entry.unit_key }}"
                                  />
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                      <div class="rounded-2xl border border-slate-200 bg-white/90 p-3 text-xs text-slate-600" data-dispatch-total-summary>
                        <p class="text-sm font-semibold text-slate-900">
                          Cartones solicitados:
                          <span data-dispatch-total-cartons data-summary-kind="requested">0</span>
                        </p>
                        <p class="text-sm font-semibold text-slate-900">
                          Aves solicitadas:
                          <span data-dispatch-total-hens data-summary-kind="requested">0</span>
                        </p>
                      </div>
                      <label class="block text-sm font-semibold text-slate-600">
                        Notas para transporte
                        <textarea
                          rows="3"
                          placeholder="Detalla puntos de entrega, ventanas horarias o restricciones."
                          class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                          data-dispatch-input
                          data-field="notes"
                        ></textarea>
                      </label>
                      <div class="flex flex-wrap items-center justify-end gap-2">
                        <button
                          type="button"
                          class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-slate-300 hover:text-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-200/70"
                          data-dispatch-close
                        >
                          Cancelar
                        </button>
                        <button
                          type="button"
                          class="rounded-full bg-brand px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-900 shadow shadow-amber-200/70 transition hover:bg-brand-dark focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                          data-dispatch-submit
                        >
                          Guardar borrador
                        </button>
                      </div>
                    </form>
                  </div>
                  {% for dispatch in dispatch_summary.dispatches %}
                    <div
                      class="hidden rounded-2xl border border-slate-200 bg-slate-50/60 p-4"
                      data-dispatch-form
                      data-dispatch-id="{{ dispatch.id }}"
                      data-dispatch-mode="edit"
                    >
                      <header class="flex items-start justify-between gap-3">
                        <div>
                          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                            Editar despacho ¬∑ {{ dispatch.code }}
                          </p>
                          <h5 class="text-base font-semibold text-slate-900">{{ dispatch.vendor.name }}</h5>
                        </div>
                        <span class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-white shadow shadow-slate-200/70">
                          {{ dispatch.scheduled_date_label }}
                        </span>
                      </header>
                      <form class="mt-4 space-y-4" data-dispatch-form-body>
                        <div class="grid gap-3 sm:grid-cols-2">
                          <label class="block text-sm font-semibold text-slate-600">
                            Fecha programada
                            <input
                              type="date"
                              value="{{ dispatch.scheduled_date_iso }}"
                              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                              data-dispatch-input
                              data-field="scheduled_date"
                            />
                          </label>
                          <label class="block text-sm font-semibold text-slate-600">
                            Conductor
                            <select
                              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                              data-dispatch-input
                              data-field="driver"
                            >
                              {% for driver in dispatch_summary.form.drivers %}
                                <option value="{{ driver.id }}"{% if driver.id == dispatch.driver.id %} selected{% endif %}>
                                  {{ driver.name }} ¬∑ {{ driver.phone }}
                                </option>
                              {% endfor %}
                            </select>
                          </label>
                          <label class="block text-sm font-semibold text-slate-600">
                            Vendedor
                            <select
                              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                              data-dispatch-input
                              data-field="vendor"
                            >
                              {% for vendor in dispatch_summary.form.vendors %}
                                <option value="{{ vendor.id }}"{% if vendor.id == dispatch.vendor.id %} selected{% endif %}>
                                  {{ vendor.name }} ¬∑ {{ vendor.channel }}
                                </option>
                              {% endfor %}
                            </select>
                          </label>
                          <label class="block text-sm font-semibold text-slate-600">
                            Veh√≠culo
                            <select
                              class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                              data-dispatch-input
                              data-field="vehicle"
                            >
                              {% for vehicle in dispatch_summary.form.vehicles %}
                                <option value="{{ vehicle.id }}"{% if vehicle.id == dispatch.vehicle.id %} selected{% endif %}>
                                  {{ vehicle.label }} ¬∑ {{ vehicle.plate }}
                                </option>
                              {% endfor %}
                            </select>
                          </label>
                        </div>
                        <div class="overflow-hidden rounded-2xl border border-slate-200">
                          <table class="min-w-full divide-y divide-slate-200 text-sm text-slate-700">
                            <thead class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                              <tr>
                                <th scope="col" class="px-3 py-2 text-left">Tipo</th>
                                <th scope="col" class="px-3 py-2 text-left">Unidad</th>
                                <th scope="col" class="px-3 py-2 text-right">Solicitado</th>
                              </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                              {% for row in dispatch.catalog_rows %}
                                <tr>
                                  <td class="px-3 py-2 text-sm font-semibold text-slate-900">{{ row.label }}</td>
                                  <td class="px-3 py-2 text-xs uppercase tracking-wide text-slate-500">{{ row.unit_label }}</td>
                                  <td class="px-3 py-2 text-right">
                                    <input
                                      type="number"
                                      min="0"
                                      step="1"
                                      value="{{ row.requested }}"
                                      class="w-full rounded-lg border border-slate-200 px-2 py-1 text-right text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                                      data-dispatch-input
                                      data-field="requested"
                                      data-type="{{ row.type_id }}"
                                      data-unit="{{ row.unit }}"
                                    />
                                  </td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                        <div class="rounded-2xl border border-slate-200 bg-white/90 p-3 text-xs text-slate-600" data-dispatch-total-summary>
                          <p class="text-sm font-semibold text-slate-900">
                            Cartones solicitados:
                            <span data-dispatch-total-cartons data-summary-kind="requested">{{ dispatch.totals.requested_cartons|intcomma }}</span>
                          </p>
                          <p class="text-sm font-semibold text-slate-900">
                            Aves solicitadas:
                            <span data-dispatch-total-hens data-summary-kind="requested">{{ dispatch.totals.requested_hens|intcomma }}</span>
                          </p>
                        </div>
                    <label class="block text-sm font-semibold text-slate-600">
                      Notas para transporte
                      <textarea
                        rows="3"
                        class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                            data-dispatch-input
                            data-field="notes"
                          >{{ dispatch.notes }}</textarea>
                        </label>
                        <div class="flex flex-wrap items-center justify-end gap-2">
                          <button
                            type="button"
                            class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-slate-300 hover:text-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-200/70"
                            data-dispatch-close
                          >
                            Cancelar
                          </button>
                          <button
                            type="button"
                            class="rounded-full bg-brand px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-900 shadow shadow-amber-200/70 transition hover:bg-brand-dark focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                            data-dispatch-submit
                          >
                            Guardar cambios
                          </button>
                        </div>
                      </form>
                    </div>
                  {% endfor %}
                </div>
              </article>

              {% endif %}
              {% if mini_app_card_permissions.dispatch_detail %}
              <article
                class="hidden rounded-3xl border border-slate-200 bg-white p-5 shadow-xl shadow-slate-200/70"
                data-dispatch-detail-card
              >
                <header class="flex items-start justify-between gap-3">
                  <div class="space-y-1">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-brand">
                      Confirmar despacho
                    </p>
                    <h4 class="text-lg font-semibold text-slate-900">Detalle de env√≠o</h4>
                    <p class="text-sm text-slate-600">
                      Revisa cantidades finales antes de liberar el transporte.
                    </p>
                  </div>
                  <button
                    type="button"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-500 transition hover:text-slate-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-200/70"
                    data-dispatch-close
                    aria-label="Cerrar panel de detalle de despacho"
                  >
                    ‚úï
                  </button>
                </header>
                <div class="mt-4 space-y-4" data-dispatch-detail-container>
                  {% for dispatch in dispatch_summary.dispatches %}
                    <section
                      class="hidden rounded-2xl border border-slate-200 bg-slate-50/70 p-4"
                      data-dispatch-detail
                      data-dispatch-id="{{ dispatch.id }}"
                      data-dispatch-mode="detail"
                      data-dispatch-status="{{ dispatch.status }}"
                    >
                      <header class="flex flex-wrap items-start justify-between gap-3">
                        <div>
                          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                            {{ dispatch.code }}
                          </p>
                          <h5 class="text-base font-semibold text-slate-900">
                            {{ dispatch.vendor.name }}
                          </h5>
                          <p class="text-sm text-slate-600">
                            {{ dispatch.vendor.channel }} ¬∑ {{ dispatch.seller }}
                          </p>
                        </div>
                        <div class="flex flex-col items-end gap-2 text-right">
                          <span class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-white shadow shadow-slate-200/70">
                            {{ dispatch.scheduled_date_label }}
                          </span>
                          <span
                            class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {% if dispatch.status_theme == 'emerald' %}border-emerald-300 bg-emerald-50 text-emerald-700{% elif dispatch.status_theme == 'brand' %}border-amber-300 bg-amber-50 text-amber-700{% elif dispatch.status_theme == 'rose' %}border-rose-300 bg-rose-50 text-rose-600{% elif dispatch.status_theme == 'sky' %}border-sky-300 bg-sky-50 text-sky-700{% else %}border-slate-300 bg-slate-50 text-slate-600{% endif %}"
                            data-dispatch-status-chip
                            data-dispatch-id="{{ dispatch.id }}"
                            data-dispatch-status="{{ dispatch.status }}"
                          >
                            {{ dispatch.status_label }}
                          </span>
                        </div>
                      </header>
                      <dl class="mt-3 grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
                        <div class="rounded-xl border border-slate-100 bg-white/80 p-3">
                          <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Conductor</dt>
                          <dd class="mt-1 text-sm font-semibold text-slate-900">{{ dispatch.driver.name }}</dd>
                          <dd class="text-[11px] text-slate-500">Tel√©fono {{ dispatch.driver.phone }}</dd>
                        </div>
                        <div class="rounded-xl border border-slate-100 bg-white/80 p-3">
                          <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Veh√≠culo asignado</dt>
                          <dd class="mt-1 text-sm font-semibold text-slate-900">{{ dispatch.vehicle.label }}</dd>
                          <dd class="text-[11px] text-slate-500">Placa {{ dispatch.vehicle.plate }}</dd>
                        </div>
                      </dl>
                      {% if dispatch.contact or dispatch.notes %}
                        <div class="mt-2 space-y-1 text-xs text-slate-500">
                          {% if dispatch.contact %}
                            <p>
                              Contacto log√≠stica: <span class="font-semibold text-slate-900">{{ dispatch.contact }}</span>
                            </p>
                          {% endif %}
                          {% if dispatch.notes %}
                            <p>
                              Notas programadas: <span class="font-semibold text-slate-900">{{ dispatch.notes }}</span>
                            </p>
                          {% endif %}
                        </div>
                      {% endif %}
                      <div class="mt-3">
                        <label class="block text-sm font-semibold text-slate-600">
                          <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Estado del despacho</span>
                          <select
                            class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                            data-dispatch-status-input
                            data-dispatch-id="{{ dispatch.id }}"
                          >
                            {% for option in dispatch_summary.status_options %}
                              <option value="{{ option.id }}"{% if option.id == dispatch.status %} selected{% endif %}>
                                {{ option.label }}
                              </option>
                            {% endfor %}
                          </select>
                        </label>
                      </div>
                      <div class="overflow-hidden rounded-2xl border border-slate-200">
                        <table class="min-w-full divide-y divide-slate-200 text-sm text-slate-700">
                          <thead class="bg-slate-100 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                            <tr>
                              <th scope="col" class="px-3 py-2 text-left">Tipo</th>
                              <th scope="col" class="px-3 py-2 text-right">Solicitado</th>
                              <th scope="col" class="px-3 py-2 text-right">Confirmado</th>
                              <th scope="col" class="px-3 py-2 text-right">Pendiente</th>
                            </tr>
                          </thead>
                          <tbody class="divide-y divide-slate-100">
                            {% for row in dispatch.catalog_rows %}
                              <tr
                                data-dispatch-detail-row
                                data-requested="{{ row.requested }}"
                                data-unit="{{ row.unit }}"
                                data-unit-label="{{ row.unit_label }}"
                                data-item-type="{{ row.type_id }}"
                              >
                                <td class="px-3 py-2 text-sm font-semibold text-slate-900">{{ row.label }}</td>
                                <td class="px-3 py-2 text-right">
                                  <span class="font-semibold text-slate-900">{{ row.requested|intcomma }}</span>
                                  <span class="text-xs text-slate-500">{{ row.unit_label }}</span>
                                </td>
                                <td class="px-3 py-2 text-right">
                                  <input
                                    type="number"
                                    min="0"
                                    step="1"
                                    value="{{ row.confirmed }}"
                                    class="w-full rounded-lg border border-slate-200 px-2 py-1 text-right text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                                    data-dispatch-input
                                    data-field="confirmed"
                                    data-type="{{ row.type_id }}"
                                    data-unit="{{ row.unit }}"
                                  />
                                </td>
                                <td class="px-3 py-2 text-right">
                                  <span
                                    class="inline-flex items-center gap-1 whitespace-nowrap rounded-full border px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide"
                                    data-dispatch-difference
                                  >
                                    ‚Äî
                                  </span>
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                      <div class="mt-4 space-y-2 rounded-2xl border border-slate-200 bg-white/80 p-3 text-xs text-slate-600">
                        <div class="flex items-center justify-between gap-3 text-sm font-semibold text-slate-900">
                          <span>Cartones solicitados</span>
                          <span>{{ dispatch.totals.requested_cartons|intcomma }}</span>
                        </div>
                        <div class="flex items-center justify-between gap-3 text-sm font-semibold text-slate-900">
                          <span>Cartones confirmados</span>
                          <span data-dispatch-total-cartons data-summary-kind="confirmed">
                            {{ dispatch.totals.confirmed_cartons|intcomma }}
                          </span>
                        </div>
                        <div class="flex items-center justify-between gap-3 text-sm font-semibold text-slate-900">
                          <span>Aves solicitadas</span>
                          <span>{{ dispatch.totals.requested_hens|intcomma }}</span>
                        </div>
                        <div class="flex items-center justify-between gap-3 text-sm font-semibold text-slate-900">
                          <span>Aves confirmadas</span>
                          <span data-dispatch-total-hens data-summary-kind="confirmed">
                            {{ dispatch.totals.confirmed_hens|intcomma }}
                          </span>
                        </div>
                        <label class="block text-sm font-semibold text-slate-600">
                          Notas adicionales
                          <textarea
                            rows="3"
                            class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                            placeholder="Registra novedades del cargue o ajustes finales antes de despachar."
                            data-dispatch-detail-notes
                          ></textarea>
                        </label>
                      </div>
                      <div class="mt-4 flex flex-wrap items-center justify-end gap-2">
                        <button
                          type="button"
                          class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-slate-300 hover:text-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-200/70"
                          data-dispatch-close
                        >
                          Volver
                        </button>
                        <button
                          type="button"
                          class="rounded-full bg-emerald-600 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white shadow shadow-emerald-200/70 transition hover:bg-emerald-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400/70"
                          data-dispatch-confirm
                        >
                          Confirmar salida
                        </button>
                      </div>
                    </section>
                  {% endfor %}
                </div>
              </article>
              {% endif %}
            </div>
            {% endif %}
          {% endif %}
        {% endwith %}

        {% if mini_app_card_permissions.task %}
        {% for task in telegram_mini_app.tasks %}
          <article
            class="rounded-3xl border border-slate-200 bg-white p-4 shadow-lg shadow-slate-200/60 transition"
            data-task-card
            data-task-id="{{ task.assignment_id|default:'' }}"
            data-task-title="{{ task.title }}"
            data-task-complete-url="{{ task.complete_url|default:'' }}"
            data-task-reset-url="{{ task.reset_url|default:'' }}"
            data-task-evidence-url="{{ task.evidence_upload_url|default:'' }}"
            data-task-requires-evidence="{% if task.requires_evidence %}true{% else %}false{% endif %}"
            data-task-evidence-count="{{ task.evidence_count|default:0 }}"
            data-task-status="{{ task.status.state|default:'' }}"
            data-task-status-label="{{ task.status.label|default:'' }}"
            data-task-status-theme="{{ task.status.theme|default:'' }}"
            data-task-completed-on="{{ task.completed_on_iso|default:'' }}"
            data-task-note-value="{{ task.completion_note|default:'' }}"
            data-task-reset-label="{% trans 'Marcar como No Completada' %}"
          >
              <header class="flex flex-col gap-2">
                <div class="flex items-start justify-between gap-3">
                  <h3 class="text-sm font-semibold text-slate-900">{{ task.title }}</h3>
                  <span
                    class="h-2.5 w-2.5 rounded-full {% if task.tone == 'brand' %}bg-amber-400{% elif task.tone == 'critical' %}bg-rose-400{% elif task.tone == 'success' %}bg-emerald-400{% else %}bg-slate-400{% endif %}"
                    aria-hidden="true"
                  ></span>
                </div>
                <div class="flex flex-wrap items-center gap-2 text-[10px] font-semibold uppercase tracking-wide">
                  <div class="flex flex-wrap items-center gap-2" data-task-badges>
                    {% for badge in task.badges %}
                      <span
                        class="rounded-full border px-2 py-0.5 {% if badge.theme == 'brand' %}border-amber-300 bg-amber-50 text-amber-700{% elif badge.theme == 'critical' %}border-rose-300 bg-rose-50 text-rose-700{% elif badge.theme == 'success' %}border-emerald-300 bg-emerald-50 text-emerald-700{% elif badge.theme == 'amber' %}border-amber-300 bg-amber-50 text-amber-700{% elif badge.theme == 'sky' %}border-sky-300 bg-sky-50 text-sky-700{% elif badge.theme == 'rose' %}border-rose-300 bg-rose-50 text-rose-700{% else %}border-slate-300 bg-slate-100 text-slate-700{% endif %}"
                        {% if badge.kind == "evidence" %}data-task-evidence-badge{% endif %}
                      >
                        {{ badge.label }}
                      </span>
                    {% endfor %}
                  </div>
                  <span
                    class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-2 py-0.5 text-slate-600"
                  >
                    <span aria-hidden="true">üóì</span>
                    <span data-task-due-label>{{ task.due_compact_label }}</span>
                  </span>
                </div>
              </header>
              {% with task_state=task.status.state|default:'' %}
              <div class="mt-3 space-y-3 {% if task_state == 'completed' %}rounded-2xl border border-white/70 bg-gradient-to-br from-white/95 via-white/70 to-transparent px-3 py-3 shadow-inner shadow-white/30{% endif %}">
                <p class="m-0 text-sm leading-relaxed text-slate-700">
                  {{ task.description }}
                </p>
                <p class="{% if not task.status.details %}hidden{% endif %} text-xs text-slate-500" data-task-status-details>
                  {{ task.status.details }}
                </p>
                <div class="space-y-1 text-xs text-slate-500">
                  <label class="inline-flex items-center gap-2 text-[11px] font-semibold text-slate-500">
                    {% trans "Nota r√°pida" %}
                    <span class="text-[10px] font-normal text-slate-400">{% trans "Opcional" %}</span>
                  </label>
                  <input
                    type="text"
                    maxlength="280"
                    class="w-full rounded-2xl border border-slate-200 bg-white/90 px-3 py-2 text-xs text-slate-700 placeholder:text-slate-400 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    data-task-note-input
                    placeholder="{% trans 'Comparte un hallazgo breve' %}"
                    value="{{ task.completion_note|default:'' }}"
                    {% if task_state == 'completed' %}readonly{% endif %}
                  />
                </div>
                <p class="hidden text-xs font-semibold text-emerald-600" data-task-feedback></p>
              </div>
              {% endwith %}
              <input
                type="file"
                accept="image/*,video/*"
                capture="environment"
                class="hidden"
                data-task-evidence-input
                multiple
              />
              <div class="mt-4 flex flex-wrap gap-2" data-task-action-list>
                {% for action in task.actions %}
                  <button
                    type="button"
                    class="rounded-full px-3 py-1 text-xs font-semibold transition {% if action.disabled %}border border-slate-200 text-slate-400 opacity-60 cursor-not-allowed{% elif forloop.first %}bg-brand text-slate-900 shadow shadow-amber-200/70 hover:bg-brand-dark{% else %}border border-slate-200 text-slate-600 hover:border-brand hover:text-brand{% endif %}"
                    data-task-action="{{ action.action }}"
                    data-task-disabled="{% if action.disabled %}true{% else %}false{% endif %}"
                    {% if action.disabled %}disabled{% endif %}
                  >
                    {{ action.label }}
                  </button>
                {% endfor %}
              </div>
            </article>
          {% endfor %}
        {% endif %}

        {% include "task_manager/includes/mini_app_night_mortality_card.html" %}

        {% if mini_app_card_permissions.weight_registry %}
        {% with weight_registry=telegram_mini_app.weight_registry %}
        {% if weight_registry %}
          <article
            class="rounded-3xl border border-sky-200 bg-gradient-to-br from-white/90 via-sky-50/80 to-blue-100/80 p-5 shadow-2xl shadow-sky-100/70"
            data-weight-card
            data-weight-unit="{{ weight_registry.unit_label|default:'g' }}"
            data-weight-tolerance="{{ weight_registry.uniformity_tolerance_percent|default:10 }}"
            data-weight-minimum="{{ weight_registry.min_sample_size|default:30 }}"
            data-weight-submit-url="{{ weight_registry.submit_url|default:'' }}"
            data-weight-date="{{ weight_registry.date|default:'' }}"
          >
            <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
              <div class="space-y-2">
                <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-sky-600">
                  <span aria-hidden="true">‚öñÔ∏è</span>
                  Control de pesos
                </p>
                <h3 class="text-lg font-semibold text-slate-900">
                  {{ weight_registry.title }}
                </h3>
                {% if weight_registry.subtitle %}
                  <p class="text-sm text-slate-600">
                    {{ weight_registry.subtitle }}
                  </p>
                {% endif %}
              </div>
              {% if weight_registry.resume_hint %}
                <div class="inline-flex items-center gap-2 rounded-2xl border border-sky-200 bg-white/90 px-3 py-2 text-[11px] font-semibold uppercase tracking-wide text-sky-700 shadow-inner shadow-sky-100/70">
                  <span aria-hidden="true">‚è∏Ô∏è</span>
                  {{ weight_registry.resume_hint }}
                </div>
              {% endif %}
            </header>

            <div class="mt-4 space-y-5">
              <section class="space-y-2">
                {% with weight_registry_locations=weight_registry.locations %}
                <div class="space-y-3" data-weight-location-list>
                  {% if weight_registry_locations %}
                    {% regroup weight_registry_locations by farm as weight_registry_farms %}
                    {% for farm in weight_registry_farms %}
                      <section
                        class="space-y-2 rounded-2xl border border-sky-200/70 bg-white/90 p-3 shadow-inner shadow-sky-100/60"
                        data-weight-farm
                        data-weight-farm-label="{{ farm.grouper|default:_('Sin granja') }}"
                      >
                        <header class="flex items-center justify-between gap-2">
                          <p class="text-sm font-semibold text-sky-800">
                            {{ farm.grouper|default:_('Sin granja asignada') }}
                          </p>
                        </header>
                        {% regroup farm.list by barn as weight_registry_barns %}
                        <div class="space-y-2" data-weight-barn-collection>
                          {% for barn in weight_registry_barns %}
                            <article
                              class="space-y-2 rounded-xl border border-sky-200/70 bg-sky-50/60 p-3 shadow-inner shadow-sky-100/50"
                              data-weight-barn
                              data-weight-barn-label="{{ barn.grouper|default:_('Sin galp√≥n') }}"
                            >
                              <header class="flex items-center justify-between gap-2">
                                <p class="text-xs font-semibold uppercase tracking-wide text-sky-600">
                                  {{ barn.grouper|default:_('Sin galp√≥n asignado') }}
                                </p>
                              </header>
                              <div class="flex flex-wrap gap-2" data-weight-room-list>
                                {% for location in barn.list %}
                                  <button
                                    type="button"
                                    class="group inline-flex min-w-[8.5rem] flex-1 items-center justify-between gap-3 rounded-xl border border-sky-200/60 bg-white/90 px-3 py-2 text-left text-xs font-semibold text-sky-700 shadow-sm shadow-sky-100/40 transition hover:border-sky-400 hover:text-sky-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-200/60 sm:max-w-xs"
                                    data-weight-location="{{ location.id }}"
                                    data-weight-location-label="{{ location.label }}"
                                    data-weight-location-room="{{ location.room|default:location.label }}"
                                    data-weight-location-barn="{{ location.barn|default:'' }}"
                                    data-weight-location-farm="{{ location.farm|default:'' }}"
                                    data-weight-location-birds="{{ location.birds|default:'' }}"
                                    data-weight-location-room-id="{{ location.room_id|default:'' }}"
                                  >
                                    <span class="inline-flex flex-col items-start leading-tight text-sky-800">
                                      <span class="text-sm font-semibold">
                                        {{ location.room|default:location.label }}
                                      </span>
                                    <span
                                      class="flex flex-wrap items-center gap-2 text-[10px] font-semibold uppercase tracking-wide text-sky-500"
                                      data-weight-location-meta
                                    >
                                      <span data-weight-location-birds-label>
                                        {% if location.birds %}
                                          {{ location.birds|intcomma }} aves
                                        {% else %}
                                          ‚Äî
                                        {% endif %}
                                      </span>
                                    </span>
                                  </span>
                                  </button>
                                {% empty %}
                                  <p class="text-xs text-slate-500">
                                    {% trans "Sin salones asignados en este galp√≥n." %}
                                  </p>
                                {% endfor %}
                              </div>
                            </article>
                          {% empty %}
                            <p class="text-xs text-slate-500">
                              {% trans "Sin galpones asignados para esta granja." %}
                            </p>
                          {% endfor %}
                        </div>
                      </section>
                    {% endfor %}
                  {% else %}
                    <p class="text-xs text-slate-500" data-weight-location-empty>
                      {% trans "No hay salones asignados para tu turno." %}
                    </p>
                  {% endif %}
                </div>
                {% endwith %}
              </section>

              <section class="space-y-2" data-weight-idle-actions>
                <div class="flex flex-wrap gap-2">
                  <button
                    type="button"
                    class="rounded-full bg-sky-600 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white shadow-lg shadow-sky-200/70 transition hover:bg-sky-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-300/70"
                    data-weight-start
                  >
                    Iniciar muestreo
                  </button>
                  <button
                    type="button"
                    class="hidden rounded-full border border-sky-200 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-wide text-sky-700 shadow-sm shadow-sky-100/70 transition hover:border-sky-400 hover:text-sky-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-200/70"
                    data-weight-resume
                  >
                    Continuar registro
                  </button>
                </div>
                <p class="text-xs text-slate-600" data-weight-selection-hint>
                  Selecciona al menos un sal√≥n para comenzar.
                </p>
              </section>

              <section
                class="hidden space-y-4 rounded-2xl border border-sky-100 bg-white/90 px-4 py-4 shadow-inner shadow-sky-100/60"
               data-weight-panel
             >
                <header class="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-sky-600">
                      Captura en vivo
                    </p>
                    <p class="text-xs text-slate-500" data-weight-active-salons>‚Äî</p>
                  </div>
                  <div class="inline-flex items-center gap-2 rounded-full border border-sky-200 bg-sky-50 px-3 py-1 text-[10px] font-semibold uppercase tracking-wide text-sky-600">
                    <span aria-hidden="true">üë•</span>
                    <span data-weight-total-count>0 aves</span>
                  </div>
                </header>

                <div class="space-y-3 rounded-2xl border border-sky-100 bg-sky-50/70 p-3 shadow-inner shadow-sky-100/40">
                  <label class="flex flex-col gap-2 text-xs font-semibold text-sky-700">
                    <span>Nuevo peso</span>
                    <div class="flex items-center gap-2">
                      <input
                        type="number"
                        inputmode="decimal"
                        step="0.01"
                        min="0"
                        placeholder="Ej: 1.820 o 1820"
                        class="w-full rounded-xl border border-sky-200 bg-white px-3 py-2 text-sm font-medium text-slate-900 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200/70"
                        data-weight-input
                      />
                      <button
                        type="button"
                        class="rounded-xl bg-sky-600 px-3 py-2 text-xs font-semibold text-white shadow shadow-sky-200/60 transition hover:bg-sky-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-300/70"
                        data-weight-add
                      >
                        Agregar
                      </button>
                    </div>
                 </label>
               </div>

                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-sky-600">Pesos registrados</p>
                    <div class="flex flex-wrap items-center gap-2">
                      <button
                        type="button"
                        class="rounded-full border border-transparent px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-sky-600 transition hover:border-sky-200 hover:bg-sky-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-200/70"
                        data-weight-copy
                      >
                        Copiar pesos
                      </button>
                      <button
                        type="button"
                        class="rounded-full border border-transparent px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-sky-600 transition hover:border-sky-200 hover:bg-sky-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-200/70"
                        data-weight-reset
                      >
                        Reiniciar lista
                      </button>
                    </div>
                  </div>
                  <div
                    class="rounded-2xl border border-dashed border-sky-200 bg-sky-50/70 p-3 text-xs text-sky-700 shadow-inner shadow-sky-100/50"
                    data-weight-empty-state
                  >
                    Agrega pesos para ver los indicadores.
                  </div>
                  <div
                    class="hidden w-full max-h-36 flex flex-wrap gap-2 overflow-y-auto rounded-2xl border border-sky-100 bg-white/90 p-3 shadow-inner shadow-sky-50/70 sm:max-h-40"
                    data-weight-list
                  ></div>
                </div>

                <section
                  class="hidden rounded-2xl border border-sky-100 bg-sky-50/70 p-3 text-xs text-slate-600 shadow-inner shadow-sky-100/50"
                  data-weight-summary
                >
                  <p class="text-[11px] font-semibold uppercase tracking-wide text-sky-600">Indicadores en vivo</p>
                  <dl class="mt-2 grid gap-3 sm:grid-cols-2">
                    <div>
                      <dt class="text-[11px] uppercase tracking-wide text-slate-500">Aves muestreadas</dt>
                      <dd class="mt-1 text-lg font-semibold text-slate-900" data-weight-count>‚Äî</dd>
                    </div>
                    <div>
                      <dt class="text-[11px] uppercase tracking-wide text-slate-500">Promedio</dt>
                      <dd class="mt-1 text-lg font-semibold text-slate-900" data-weight-average>‚Äî</dd>
                    </div>
                    <div>
                      <dt class="text-[11px] uppercase tracking-wide text-slate-500">Uniformidad (¬±{{ weight_registry.uniformity_tolerance_percent|default:10 }}%)</dt>
                      <dd class="mt-1 text-lg font-semibold text-slate-900" data-weight-uniformity>‚Äî</dd>
                    </div>
                    <div>
                      <dt class="text-[11px] uppercase tracking-wide text-slate-500">Varianza</dt>
                      <dd class="mt-1 text-lg font-semibold text-slate-900" data-weight-variance>‚Äî</dd>
                    </div>
                    <div>
                      <dt class="text-[11px] uppercase tracking-wide text-slate-500">Rango</dt>
                      <dd class="mt-1 text-lg font-semibold text-slate-900" data-weight-range>‚Äî</dd>
                    </div>
                  </dl>
                  <p
                    class="mt-3 hidden rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-[10px] font-semibold uppercase tracking-wide text-amber-600 shadow-inner shadow-amber-100/60"
                    data-weight-sample-warning
                  >
                    Captura al menos {{ weight_registry.min_sample_size|default:30 }} aves para un dato consistente.
                  </p>
                </section>

                <footer class="flex flex-wrap items-center justify-between gap-3">
                  <div class="flex flex-wrap gap-2">
                    <button
                      type="button"
                      class="rounded-full border border-sky-200 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-wide text-sky-600 shadow-sm shadow-sky-100/60 transition hover:border-sky-400 hover:text-sky-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-200/70"
                      data-weight-pause
                    >
                      Guardar y pausar
                    </button>
                    <button
                      type="button"
                      class="rounded-full bg-sky-600 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white shadow-lg shadow-sky-200/70 transition hover:bg-sky-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-300/70"
                      data-weight-finish
                    >
                      Enviar registro
                    </button>
                  </div>
                  <span class="text-[10px] font-semibold uppercase tracking-wide text-slate-400" data-weight-status>Sin cambios</span>
                </footer>
              </section>
            </div>
            {{ weight_registry.sessions|json_script:"weight-registry-sessions" }}
          </article>
        {% endif %}
        {% endwith %}
        {% endif %}

      {% if mini_app_card_permissions.production or mini_app_card_permissions.weight_registry %}
      <div
        data-mini-app-report
        class="hidden flex flex-col gap-5"
      >
        <section class="rounded-3xl border border-brand/40 bg-gradient-to-br from-white via-amber-50 to-sky-50 p-5 shadow-2xl shadow-amber-200/70">
          <div class="flex items-start justify-between gap-3">
            <div class="space-y-2">
              <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-brand">
                <span aria-hidden="true">üìù</span>
                Reportar tarea completada
              </p>
              <h2 class="text-xl font-semibold text-slate-900">Cu√©ntanos qu√© lograste</h2>
              <p class="text-sm text-slate-600">
                Toma menos de un minuto. Usa una sugerencia o escribe la tarea tal como la realizaste para que podamos celebrarla contigo.
              </p>
            </div>
            <button
              type="button"
              class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-transparent bg-white/70 text-slate-400 shadow-sm shadow-amber-100 transition hover:bg-slate-100 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200/70"
              data-report-cancel
              aria-label="Cancelar y volver"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="h-4 w-4"
                aria-hidden="true"
              >
                <path d="M6 18 18 6m0 12L6 6" />
              </svg>
            </button>
          </div>

          <div class="mt-5 space-y-6" data-report-view>
            <div data-report-step="form" class="space-y-6">
              <div class="space-y-3">
                <div class="flex items-center justify-between gap-2 text-xs">
                  <p class="font-semibold uppercase tracking-wide text-slate-500">Sugerencias r√°pidas</p>
                  <span class="rounded-full bg-white/70 px-2 py-1 text-[11px] text-slate-400">
                    Toca una opci√≥n para autocompletar
                  </span>
                </div>
                <div class="flex flex-wrap gap-2">
                  {% for task in telegram_mini_app.tasks %}
                    <button
                      type="button"
                      class="group rounded-full border border-transparent bg-white/80 px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm shadow-amber-100 transition hover:border-brand hover:bg-brand/90 hover:text-slate-900 focus:outline-none focus:ring-2 focus:ring-brand/40"
                      data-report-suggestion
                      data-report-task="{{ task.title }}"
                      data-report-points="{{ task.reward_points|default:'15' }}"
                    >
                      <span class="inline-flex items-center gap-2">
                        <span aria-hidden="true">‚ú®</span>
                        {{ task.title }}
                      </span>
                    </button>
                  {% empty %}
                    <p class="rounded-2xl border border-dashed border-slate-200 bg-white/60 px-4 py-3 text-xs text-slate-500">
                      Por ahora no hay tareas sugeridas, escr√≠bela directamente abajo.
                    </p>
                  {% endfor %}
                </div>
              </div>

              <form class="space-y-4" data-report-form>
                <div class="space-y-2">
                  <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500" for="mini-app-report-task">
                    Nombre de la tarea
                  </label>
                  <input
                    id="mini-app-report-task"
                    name="task"
                    type="text"
                    inputmode="text"
                    autocomplete="off"
                    placeholder="Ej. Checklist apertura galp√≥n"
                    class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 shadow-inner shadow-amber-100/50 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40"
                    data-report-input
                  />
                  <p class="hidden text-xs text-rose-600" data-report-error>Cu√©ntame al menos el nombre de la tarea para registrarla.</p>
                  <p class="text-[11px] text-slate-500" data-report-suggestion-label>
                    Sugerencia aplicada: <span class="font-semibold text-slate-700" data-report-suggestion-value>‚Äî</span>
                  </p>
                </div>

                <div class="flex flex-col-reverse gap-2 sm:flex-row sm:justify-end">
                  <button
                    type="button"
                    class="rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus:outline-none focus:ring-2 focus:ring-slate-200/70"
                    data-report-cancel
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    class="rounded-full bg-gradient-to-r from-brand via-amber-400 to-emerald-400 px-6 py-2.5 text-sm font-semibold text-slate-900 shadow-lg shadow-amber-200/70 transition hover:shadow-amber-300/80 focus:outline-none focus:ring-2 focus:ring-brand/50"
                    data-report-submit
                  >
                    Reportar avance
                  </button>
                </div>
              </form>
            </div>

            <div data-report-step="success" class="hidden space-y-5">
              <div class="rounded-3xl border border-emerald-200 bg-gradient-to-br from-white via-emerald-50 to-sky-50 p-5 shadow-inner shadow-emerald-200/50">
                <p class="inline-flex items-center gap-2 text-[11px] font-semibold uppercase tracking-wide text-emerald-600">
                  <span aria-hidden="true">üå±</span>
                  ¬°Gracias por levantar la mano!
                </p>
                <h3 class="mt-2 text-lg font-semibold text-slate-900" data-report-success-greeting>¬°Gracias!</h3>
                <p class="mt-2 text-sm text-slate-700">
                  Tu reporte de <span class="font-semibold text-slate-900" data-report-success-task></span> inspira confianza en todo el equipo.
                </p>
                <p class="mt-3 hidden text-sm text-emerald-700" data-report-success-impact>
                  Cuando sea validado sumar√°s <span class="font-semibold" data-report-success-points></span> directos a tus metas, est√°s construyendo resultados brillantes.
                </p>
                <p class="mt-3 hidden text-sm text-slate-600" data-report-success-recognition>
                  Este gesto mantiene al equipo alineado y refuerza lo que ya haces tan bien: cuidar cada detalle.
                </p>
                <p class="mt-4 text-[11px] uppercase tracking-wide text-slate-400">
                  Sigue compartiendo tus logros, estamos acompa√±√°ndote en cada paso.
                </p>
              </div>
              <div class="flex flex-col gap-2 sm:flex-row sm:justify-end">
                <button
                  type="button"
                  class="rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus:outline-none focus:ring-2 focus:ring-slate-200/70"
                  data-report-again
                >
                  Registrar otra tarea
                </button>
                <button
                  type="button"
                  class="rounded-full bg-brand px-6 py-2.5 text-sm font-semibold text-slate-900 shadow-lg shadow-amber-200/70 transition hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand/50"
                  data-report-done
                >
                  Volver al inicio
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
      {% endif %}

      <section class="space-y-4" data-weekly-calendar-section>
        {% with roster=telegram_mini_app.daily_assignments %}
          {% include "task_manager/includes/mini_app_next_days_card.html" with roster=roster %}
        {% endwith %}

        {% with roster=telegram_mini_app.daily_assignments %}
        {% if roster and roster.days and mini_app_card_permissions.daily_roster %}
        <div
          class="rounded-3xl border border-slate-200 bg-white p-4 shadow-lg shadow-slate-200/60"
          data-daily-roster-card
          data-initial-index="{{ roster.initial_index|default:0 }}"
        >
          <header class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h2 class="text-sm font-semibold text-slate-900">Asignaciones del d√≠a</h2>
            </div>
            <div class="flex items-center gap-2 text-xs text-slate-500">
              <button
                type="button"
                class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition hover:border-brand hover:text-brand focus:outline-none focus:ring-2 focus:ring-slate-200/70"
                data-roster-prev
                aria-label="D√≠a anterior"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
              </button>
              <div class="text-right">
                <span class="block text-[11px] font-semibold uppercase tracking-wide text-slate-400" data-roster-weekday>
                  {% if roster.initial_day %}{{ roster.initial_day.weekday_label }}{% else %}‚Äî{% endif %}
                </span>
                <span class="block text-sm font-semibold text-slate-900" data-roster-date>
                  {% if roster.initial_day %}{{ roster.initial_day.date_label }}{% else %}‚Äî{% endif %}
                </span>
              </div>
              <button
                type="button"
                class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition hover:border-brand hover:text-brand focus:outline-none focus:ring-2 focus:ring-slate-200/70"
                data-roster-next
                aria-label="D√≠a siguiente"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5 15.75 12l-7.5 7.5" />
                </svg>
              </button>
            </div>
          </header>
          <div class="mt-4 space-y-4" data-roster-days>
            {% trans "Sin rol asignado" as fallback_role %}
            {% trans "No hay asignaciones pr√≥ximas." as no_assignments_message %}
            {% if roster.days %}
              {% for day in roster.days %}
              <article
                data-roster-day
                data-index="{{ forloop.counter0 }}"
                data-date="{{ day.date_iso }}"
                data-weekday="{{ day.weekday_label }}"
                data-date-label="{{ day.date_label }}"
                class="space-y-4{% if forloop.counter0 != roster.initial_index %} hidden{% endif %}"
              >
                <div class="flex flex-wrap items-start justify-between gap-3">
                  <div>
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">{{ day.weekday_label }}</p>
                    <p class="text-sm font-semibold text-slate-900">{{ day.date_label }}</p>
                  </div>
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-[10px] font-semibold uppercase tracking-wide {{ day.calendar_status_badge_class }}">
                    {{ day.calendar_status }}
                  </span>
                </div>
                {% if day.is_rest %}
                  <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-3 text-emerald-700">
                    <p class="text-sm font-semibold">{{ day.rest_label }}</p>
                    {% if day.rest_notes %}
                      <p class="mt-1 text-xs">{{ day.rest_notes }}</p>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
                    <p class="text-sm font-semibold text-slate-900">{{ day.role_label|default:fallback_role }}</p>
                    {% if day.location_label %}
                      <p class="mt-1 text-xs text-slate-500">{{ day.location_label }}</p>
                    {% else %}
                      {% if day.farm_label or day.barn_label %}
                      <p class="mt-1 text-xs text-slate-500">
                        {% if day.farm_label %}{{ day.farm_label }}{% if day.barn_label %} ¬∑ {{ day.barn_label }}{% endif %}{% elif day.barn_label %}{{ day.barn_label }}{% endif %}
                      </p>
                      {% endif %}
                    {% endif %}
                    {% if day.shift_type_label %}
                      <p class="text-xs text-slate-500">{{ day.shift_type_label }}</p>
                    {% endif %}
                    {% if day.assignment_notes %}
                      <p class="mt-2 text-xs text-slate-500">{{ day.assignment_notes }}</p>
                    {% endif %}
                  </div>
                {% endif %}
                {% if day.alerts %}
                <div class="rounded-2xl border border-amber-200 bg-amber-50 p-3">
                  <ul class="list-disc space-y-1 pl-4 text-xs text-amber-700">
                    {% for alert in day.alerts %}
                    <li>{{ alert }}</li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
              </article>
              {% endfor %}
            {% else %}
              <p class="text-xs text-slate-500">{{ no_assignments_message }}</p>
            {% endif %}
          </div>
        </div>
        {% endif %}
        {% endwith %}

      {% with review=telegram_mini_app.leader_review %}
      {% if review and mini_app_card_permissions.leader_review %}
      <section class="space-y-5 rounded-3xl border border-slate-200/80 bg-white/85 p-5 shadow-xl shadow-slate-200/70 mini-app-blur" data-leader-review>
        <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
          <div class="space-y-2">
            <span class="inline-flex items-center gap-2 rounded-full border border-brand/40 bg-brand/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-brand-dark">
              Seguimiento l√≠der
            </span>
            <h2 class="text-base font-semibold text-slate-900">{{ review.title }}</h2>
            <p class="text-xs text-slate-600">{{ review.subtitle }}</p>
          </div>
          <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 sm:justify-end">
            <div class="text-center">
              <p class="text-3xl font-semibold text-slate-900" data-review-summary-total>{{ review.summary.total }}</p>
            </div>
          </div>
        </header>
        <div class="grid grid-cols-1 gap-3 sm:grid-cols-3" data-review-summary>
          <div class="rounded-2xl border border-amber-200 bg-gradient-to-br from-amber-50 via-white to-amber-100/70 p-4 shadow-md shadow-amber-200/60">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-amber-600">En revisi√≥n</p>
            <p class="mt-1 text-2xl font-semibold text-amber-700" data-review-summary-awaiting>{{ review.summary.awaiting }}</p>
            <p class="mt-1 text-xs text-slate-600">Tareas que esperan tu verificaci√≥n.</p>
          </div>
          <div class="rounded-2xl border border-rose-200 bg-gradient-to-br from-rose-50 via-white to-rose-100/70 p-4 shadow-md shadow-rose-200/60">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-rose-600">Vencidas</p>
            <p class="mt-1 text-2xl font-semibold text-rose-600" data-review-summary-overdue>{{ review.summary.overdue }}</p>
            <p class="mt-1 text-xs text-slate-600">Asignaciones que necesitan priorizaci√≥n.</p>
          </div>
          <div class="rounded-2xl border border-emerald-200 bg-gradient-to-br from-emerald-50 via-white to-emerald-100/70 p-4 shadow-md shadow-emerald-200/60">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Aprobadas</p>
            <p class="mt-1 text-2xl font-semibold text-emerald-700" data-review-summary-approved>{{ review.summary.approved }}</p>
            <p class="mt-1 text-xs text-slate-600">Revisiones cerradas recientemente.</p>
          </div>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-white/90 p-4 shadow-inner shadow-slate-100/60" data-review-filters>
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="space-y-1">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Filtros r√°pidos</p>
              <p class="text-xs text-slate-600">Enfoca la lista por turno, granja y galp√≥n.</p>
            </div>
            <button
              type="button"
              class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
              data-review-reset
            >
              Reiniciar filtros
            </button>
          </div>
          <div class="mt-4 space-y-4">
            <div class="space-y-2">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Turnos</p>
              <div class="flex flex-wrap gap-2" data-review-filter-group="shift">
                {% for option in review.filters.shifts %}
                  <button
                    type="button"
                    class="tm-review-filter"
                    data-review-filter
                    data-filter-type="shift"
                    data-filter-value="{{ option.id }}"
                    data-active="{{ option.is_default|yesno:'true,false' }}"
                  >
                    <span>{{ option.label }}</span>
                    <span class="tm-review-filter-count">{{ option.count }}</span>
                  </button>
                {% endfor %}
              </div>
            </div>
            <div class="space-y-2">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Granjas</p>
              <div class="flex flex-wrap gap-2" data-review-filter-group="farm">
                {% for option in review.filters.farms %}
                  <button
                    type="button"
                    class="tm-review-filter"
                    data-review-filter
                    data-filter-type="farm"
                    data-filter-value="{{ option.id }}"
                    data-active="{{ option.is_default|default_if_none:False|yesno:'true,false' }}"
                  >
                    <span>{{ option.label }}</span>
                    <span class="tm-review-filter-count">{{ option.count }}</span>
                  </button>
                {% endfor %}
              </div>
            </div>
            <div class="space-y-2">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Galpones</p>
              <div class="flex flex-wrap gap-2" data-review-filter-group="barn">
                {% for option in review.filters.barns %}
                  <button
                    type="button"
                    class="tm-review-filter"
                    data-review-filter
                    data-filter-type="barn"
                    data-filter-value="{{ option.id }}"
                    data-active="{{ option.is_default|default_if_none:False|yesno:'true,false' }}"
                  >
                    <span>{{ option.label }}</span>
                    <span class="tm-review-filter-count">{{ option.count }}</span>
                  </button>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% if review.tips %}
        <div class="rounded-3xl border border-slate-200 bg-slate-50/80 p-4">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Tips r√°pidos</p>
          <ul class="mt-2 space-y-1 text-xs text-slate-600">
            {% for tip in review.tips %}
            <li class="flex items-start gap-2">
              <span class="mt-0.5 text-brand">‚Ä¢</span>
              <span>{{ tip }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        <div class="hidden rounded-3xl border border-slate-200 bg-white/90 p-4 text-sm text-slate-600" data-review-empty>
          No encontramos tareas para los filtros seleccionados. Ajusta la b√∫squeda para continuar revisando.
        </div>
        <div class="space-y-4" data-review-days>
          {% for day in review.days %}
          <article class="rounded-3xl border border-slate-200 bg-white/95 p-4 shadow-lg shadow-slate-200/60" data-review-day data-day="{{ day.date_iso }}">
            <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
              <div>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                  {{ day.weekday_label }} ¬∑ {{ day.date_label }}
                </p>
              </div>
            </header>
            <div class="mt-4 space-y-4">
              {% for location in day.locations %}
              <div
                class="rounded-2xl border border-slate-200 bg-slate-50/80 p-4 shadow-inner shadow-slate-100/40"
                data-review-location
                data-shift="{{ location.shift_label|default:''|slugify }}"
                data-farm="{{ location.farm|default:''|slugify }}"
                data-barn="{{ location.barn|default:''|slugify }}"
              >
                <header class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
                  <div>
                    <h3 class="text-sm font-semibold text-slate-900">{{ location.label }}</h3>
                  </div>
                </header>
                <div class="mt-4 space-y-3">
                  {% for task in location.tasks %}
                  <article
                    class="rounded-2xl border border-white/60 bg-white/95 p-4 shadow-sm shadow-slate-100/60"
                    data-review-task
                    data-review-task-state="{{ task.review.state|default:'awaiting' }}"
                    data-review-execution-state="{{ task.status.state|default:'pending' }}"
                  >
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                      <div class="space-y-1">
                        <h4 class="text-sm font-semibold text-slate-900">{{ task.title }}</h4>
                        <div class="flex flex-wrap items-center gap-2 text-[10px] font-semibold uppercase tracking-wide">
                          <span
                            class="rounded-full border px-2 py-0.5 {% if task.priority.theme == 'critical' %}border-rose-300 bg-rose-50 text-rose-700{% elif task.priority.theme == 'success' %}border-emerald-300 bg-emerald-50 text-emerald-700{% elif task.priority.theme == 'brand' %}border-amber-300 bg-amber-50 text-amber-700{% else %}border-slate-300 bg-slate-100 text-slate-700{% endif %}"
                          >
                            {{ task.priority.label }}
                          </span>
                          {% if task.tags %}
                            {% for tag in task.tags %}
                              <span class="rounded-full border border-slate-200 bg-white/80 px-2 py-0.5 text-slate-500">{{ tag }}</span>
                            {% endfor %}
                          {% endif %}
                        </div>
                      </div>
                      <span
                        class="tm-review-status-chip"
                        data-review-status-chip
                        data-state="{{ task.review.state|default:'awaiting' }}"
                      >
                        <span class="tm-review-status-dot" aria-hidden="true"></span>
                        <span data-review-status-label>{{ task.review.label }}</span>
                      </span>
                    </div>
                    <dl class="mt-3 grid grid-cols-1 gap-2 text-xs text-slate-600 sm:grid-cols-2">
                      <div>
                        <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Responsable</dt>
                        <dd class="mt-1 font-semibold text-slate-900">{{ task.responsible }}</dd>
                      </div>
                      <div>
                        <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Estado de ejecuci√≥n</dt>
                        <dd class="mt-1 text-slate-600">
                          <span class="font-semibold text-slate-900">{{ task.status.label }}</span>
                          {% if task.status.details %}
                            ¬∑ {{ task.status.details }}
                          {% endif %}
                          {% if task.status.overdue_days %}
                            <span class="ml-1 inline-flex items-center gap-1 rounded-full bg-rose-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-rose-700">
                              {{ task.status.overdue_days }} {% if task.status.overdue_days == 1 %}d√≠a vencido{% else %}d√≠as vencidos{% endif %}
                            </span>
                          {% endif %}
                        </dd>
                      </div>
                      <div>
                        <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Estado de revisi√≥n</dt>
                        <dd class="mt-1 text-slate-600" data-review-status-details>{{ task.review.details }}</dd>
                      </div>
                      <div>
                        <dt class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Evidencias</dt>
                        <dd class="mt-1 text-slate-600">
                          {{ task.evidence_count }} {% if task.evidence_count == 1 %}archivo{% else %}archivos{% endif %}
                        </dd>
                      </div>
                    </dl>
                    {% if task.alerts %}
                      <div class="mt-3 space-y-1">
                        {% for alert in task.alerts %}
                          <p class="inline-flex items-center gap-2 rounded-full bg-rose-50 px-3 py-1 text-[11px] font-semibold text-rose-600">
                            <span aria-hidden="true">‚ö†Ô∏è</span>
                            {{ alert }}
                          </p>
                        {% endfor %}
                      </div>
                    {% endif %}
                    <div class="mt-4 flex flex-wrap gap-2">
                      <button
                        type="button"
                        class="rounded-full bg-emerald-500 px-3 py-1.5 text-xs font-semibold text-white shadow shadow-emerald-200/70 transition hover:bg-emerald-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300/60"
                        data-review-approve
                      >
                        Aprobar
                      </button>
                      <button
                        type="button"
                        class="rounded-full border border-rose-300 px-3 py-1.5 text-xs font-semibold text-rose-600 transition hover:border-rose-500 hover:text-rose-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-200/60"
                        data-review-reject
                      >
                        Devolver
                      </button>
                    </div>
                    <div
                      class="mt-3 hidden space-y-3 rounded-2xl border border-emerald-200 bg-emerald-50/80 p-3 text-xs text-emerald-700"
                      data-review-comment-panel
                      data-type="approve"
                    >
                      <div class="space-y-1">
                        <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Recomendaciones al aprobar</p>
                        <textarea
                          rows="2"
                          class="w-full rounded-xl border border-emerald-200 bg-white/95 p-2 text-xs text-slate-700 shadow-inner shadow-emerald-100/60 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200/60"
                          placeholder="{{ task.recommendation_placeholder }}"
                          data-review-comment
                        ></textarea>
                      </div>
                      <div class="flex justify-end gap-2">
                        <button
                          type="button"
                          class="rounded-full border border-emerald-200 px-3 py-1 text-xs font-semibold text-emerald-700 hover:border-emerald-400"
                          data-review-cancel="approve"
                        >
                          Cancelar
                        </button>
                        <button
                          type="button"
                          class="rounded-full bg-emerald-600 px-3 py-1 text-xs font-semibold text-white shadow shadow-emerald-200/70 hover:bg-emerald-700"
                          data-review-confirm="approve"
                        >
                          Confirmar aprobaci√≥n
                        </button>
                      </div>
                    </div>
                    <div
                      class="mt-3 hidden space-y-3 rounded-2xl border border-rose-200 bg-rose-50/80 p-3 text-xs text-rose-700"
                      data-review-comment-panel
                      data-type="reject"
                    >
                      <div class="space-y-2">
                        <p class="text-[11px] font-semibold uppercase tracking-wide text-rose-600">Selecciona motivo</p>
                        <div class="flex flex-wrap gap-2">
                          {% for reason in review.reject_reasons %}
                            <button
                              type="button"
                              class="tm-review-reason"
                              data-review-reject-reason
                              data-value="{{ reason.id }}"
                            >
                              {{ reason.label }}
                            </button>
                          {% endfor %}
                        </div>
                      </div>
                      <textarea
                        rows="2"
                        class="w-full rounded-xl border border-rose-200 bg-white/95 p-2 text-xs text-slate-700 shadow-inner shadow-rose-100/60 focus:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-200/60"
                        placeholder="Describe qu√© debe ajustar antes de aprobar."
                        data-review-comment
                      ></textarea>
                      <div class="flex justify-end gap-2">
                        <button
                          type="button"
                          class="rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600 hover:border-rose-400"
                          data-review-cancel="reject"
                        >
                          Cancelar
                        </button>
                        <button
                          type="button"
                          class="rounded-full bg-rose-500 px-3 py-1 text-xs font-semibold text-white shadow shadow-rose-200/70 hover:bg-rose-600"
                          data-review-confirm="reject"
                        >
                          Enviar devoluci√≥n
                        </button>
                      </div>
                    </div>
                    <div class="mt-3 hidden tm-review-feedback" data-review-feedback></div>
                  </article>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            </div>
          </article>
          {% endfor %}
        </div>
      </section>
      {% endif %}
      {% endwith %}

      </section>

      <footer class="mt-10 flex justify-center px-5 pb-6 sm:px-6 tm-floating-action" data-mini-app-floating-action>
        <div class="w-full max-w-xl">
          <button
            type="button"
            class="w-full rounded-full bg-brand px-5 py-3 text-sm font-semibold text-slate-900 shadow-xl shadow-amber-200/70 transition hover:bg-brand-dark"
            data-telegram-main-action
            data-login-url="{% url 'task_manager:telegram-mini-app' %}"
            {% if mini_app_logout_url %}data-logout-url="{{ mini_app_logout_url }}"{% endif %}
            data-mini-app-finish-trigger
          >
            Finalizar mi turno
          </button>
        </div>
      </footer>

      <div
        data-mini-app-flow-dialog-root
        class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4 py-6 sm:py-12"
        aria-hidden="true"
      >
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="relative z-10 w-full max-w-sm space-y-4">
          <article
            data-mini-app-dialog="confirm"
            class="hidden flex flex-col gap-5 rounded-3xl border border-slate-200 bg-white/95 p-6 text-center shadow-2xl shadow-slate-900/20 backdrop-blur"
            role="dialog"
            aria-modal="true"
            aria-labelledby="tm-flow-confirm-title"
            aria-describedby="tm-flow-confirm-description"
            aria-hidden="true"
          >
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-brand/10 text-brand-dark">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l3.5 2" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
            </div>
            <div>
              <h2 id="tm-flow-confirm-title" class="text-lg font-semibold text-slate-900">¬øListo para cerrar tu turno?</h2>
            </div>
            <div class="rounded-2xl border border-amber-100 bg-amber-50/70 px-4 py-3 text-xs text-amber-700">
              <p class="font-semibold uppercase tracking-wide">Antes de salir</p>
              <p class="mt-1 text-slate-600">
                Aseg√∫rate de haber reportado las tareas completadas. El equipo continuar√° con base en tu registro.
              </p>
            </div>
            <div class="space-y-3">
              <div data-flow-confirm-status class="hidden">
                <div class="flex items-center justify-center gap-2 rounded-2xl bg-slate-100 px-3 py-2 text-xs text-slate-500">
                  <span class="inline-flex h-2.5 w-2.5 animate-ping rounded-full bg-brand"></span>
                  <span class="font-medium">Cerrando tu turno...</span>
                </div>
              </div>
              <p data-flow-confirm-error class="hidden rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-600"></p>
              <div class="flex flex-col gap-2">
                <button
                  type="button"
                  data-flow-action="confirm-accept"
                  class="inline-flex items-center justify-center gap-2 rounded-full bg-brand px-4 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-amber-200/70 transition hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand/40 focus:ring-offset-0"
                >
                  S√≠, cerrar mi turno
                </button>
                <button
                  type="button"
                  data-flow-action="confirm-cancel"
                  class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-200/60 focus:ring-offset-0"
                >
                  Seguir en mi turno
                </button>
              </div>
            </div>
          </article>

          <article
            data-mini-app-dialog="gratitude"
            class="hidden flex flex-col gap-5 rounded-3xl border border-emerald-200 bg-white/95 p-6 text-center shadow-2xl shadow-emerald-200/40 backdrop-blur"
            role="dialog"
            aria-modal="true"
            aria-labelledby="tm-flow-gratitude-title"
            aria-describedby="tm-flow-gratitude-description"
            aria-hidden="true"
          >
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 shadow-inner shadow-emerald-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
              </svg>
            </div>
            <div>
              <h2 id="tm-flow-gratitude-title" class="text-lg font-semibold text-slate-900">¬°Turno completado!</h2>
              <p id="tm-flow-gratitude-description" class="mt-2 text-sm text-slate-600">
                Gracias por tu compromiso hoy. Tu registro qued√≥ guardado y el equipo de Granjas la Colina seguir√° sobre esa base.
              </p>
            </div>
            <div class="rounded-2xl border border-emerald-100 bg-emerald-50/60 px-4 py-3 text-xs text-emerald-700">
              <p class="font-semibold uppercase tracking-wide">Progreso asegurado</p>
              <p class="mt-1 text-slate-600">
                Ma√±ana retomaremos contigo desde donde lo dejaste. ¬°Vamos por un nuevo turno impecable!
              </p>
            </div>
            <button
              type="button"
              data-flow-action="gratitude-accept"
              class="inline-flex items-center justify-center gap-2 rounded-full bg-emerald-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-emerald-200 transition hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-400/70 focus:ring-offset-0"
            >
              Volver a iniciar sesi√≥n
            </button>
          </article>
        </div>
      </div>
      </div>
      {% else %}
      <section class="rounded-3xl border border-slate-200/80 bg-white/80 p-6 shadow-xl shadow-slate-200/70 mini-app-blur">
        <header class="space-y-3 text-center">
          <span
            class="inline-flex items-center justify-center gap-2 rounded-full border border-brand/50 bg-brand/10 px-4 py-1.5 text-[11px] font-semibold uppercase tracking-[0.2em] text-brand-dark"
          >
            Granjas la Colina
          </span>
          <h1 class="text-xl font-semibold text-slate-900">Identif√≠cate para continuar</h1>
          <p class="text-sm text-slate-600">
            {% if mini_app_client == 'telegram' %}
              No recibimos la confirmaci√≥n autom√°tica de Telegram. Ingresa con tus credenciales para continuar.
            {% elif mini_app_client == 'embedded' %}
              Usa las credenciales de la mini app para validar tu sesi√≥n en la app m√≥vil.
            {% else %}
              Accede con la c√©dula y la clave asignadas por el equipo administrativo.
            {% endif %}
          </p>
        </header>

        {% if telegram_auth_error %}
          <div class="mt-5 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-xs text-rose-700">
            {{ telegram_auth_error }}
          </div>
        {% endif %}

        {% if mini_app_form %}
        <form method="post" class="mt-6 space-y-4">
          {% csrf_token %}
          {% if mini_app_form.non_field_errors %}
            <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-xs text-rose-700">
              {% for error in mini_app_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <div class="space-y-2">
            <label for="{{ mini_app_form.username.id_for_label }}" class="block text-xs font-semibold uppercase tracking-wide text-slate-500">
              {{ mini_app_form.username.label }}
            </label>
            {{ mini_app_form.username }}
            {% if mini_app_form.username.errors %}
              <div class="text-[11px] text-rose-600">
                {% for error in mini_app_form.username.errors %}
                  <p>{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="space-y-2">
            <label for="{{ mini_app_form.password.id_for_label }}" class="block text-xs font-semibold uppercase tracking-wide text-slate-500">
              {{ mini_app_form.password.label }}
            </label>
            {{ mini_app_form.password }}
            {% if mini_app_form.password.errors %}
              <div class="text-[11px] text-rose-600">
                {% for error in mini_app_form.password.errors %}
                  <p>{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <button type="submit" class="w-full rounded-2xl bg-brand px-4 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-amber-200/70 transition hover:bg-brand-dark">
            Ingresar
          </button>
        </form>
        {% endif %}

        <p class="mt-6 text-center text-[11px] text-slate-500">
          Contacta a tu l√≠der m√°s pr√≥ximo si necesitas acceso al panel completo.
        </p>
      </section>
      {% endif %}
    </main>

    <script>
      (function () {
        var card = document.querySelector('[data-shift-confirmation-card]');
        if (!card) {
          return;
        }
        var requires = card.getAttribute('data-requires-confirmation') === 'true';
        var isConfirmed = card.getAttribute('data-confirmed') === 'true';
        var storageKey = card.getAttribute('data-storage-key');
        var storedState = null;
        try {
          storedState = storageKey ? window.sessionStorage.getItem(storageKey) : null;
        } catch (error) {
          storedState = null;
        }

        if (storedState === 'confirmed') {
          isConfirmed = true;
        }

        var content = document.querySelector('[data-mini-app-content]');
        var confirmButton = card.querySelector('[data-confirm-shift]');
        var pendingLabel = card.querySelector('[data-shift-pending-label]');
        var confirmedLabel = card.querySelector('[data-shift-confirmed-label]');
        var contentParent = content ? content.parentNode : null;
        var tasksSection = content ? content.querySelector('[data-daily-tasks-section]') : null;
        var calendarSection = content ? content.querySelector('[data-weekly-calendar-section]') : null;

        function clearShiftConfirmationStorage() {
          try {
            var storage = window.sessionStorage;
            if (!storage) {
              return;
            }
            var keysToClear = [];
            for (var index = 0; index < storage.length; index += 1) {
              var key = storage.key(index);
              if (key && key.indexOf('miniapp-shift-confirm::') === 0) {
                keysToClear.push(key);
              }
            }
            keysToClear.forEach(function (key) {
              storage.removeItem(key);
            });
          } catch (error) {
            // Storage cleanup is best-effort only.
          }
        }

        window.__miniAppShiftConfirmation = window.__miniAppShiftConfirmation || {};
        window.__miniAppShiftConfirmation.clear = clearShiftConfirmationStorage;

        function moveCardBeforeContent() {
          if (!contentParent || !content) {
            return;
          }
          contentParent.insertBefore(card, content);
        }

        function moveCardAfterTasks() {
          if (calendarSection && calendarSection.parentNode) {
            calendarSection.parentNode.insertBefore(card, calendarSection);
            return;
          }
          if (tasksSection && tasksSection.parentNode) {
            var parent = tasksSection.parentNode;
            var next = tasksSection.nextElementSibling;
            if (next) {
              parent.insertBefore(card, next);
            } else {
              parent.appendChild(card);
            }
          }
        }

        function lockInterface() {
          if (!content) {
            return;
          }
          content.classList.add('pointer-events-none', 'opacity-60', 'blur-sm');
          content.setAttribute('aria-disabled', 'true');
          content.setAttribute('data-guard-locked', 'true');
        }

        function unlockInterface() {
          if (!content) {
            return;
          }
          content.classList.remove('pointer-events-none', 'opacity-60', 'blur-sm');
          content.setAttribute('aria-disabled', 'false');
          content.setAttribute('data-guard-locked', 'false');
        }

        function renderState() {
          if (isConfirmed) {
            moveCardAfterTasks();
          } else {
            moveCardBeforeContent();
          }

          if (pendingLabel) {
            pendingLabel.classList.toggle('hidden', isConfirmed);
          }
          if (confirmedLabel) {
            confirmedLabel.classList.toggle('hidden', !isConfirmed);
          }
          if (confirmButton) {
            confirmButton.disabled = isConfirmed;
            confirmButton.classList.toggle('opacity-60', isConfirmed);
            confirmButton.classList.toggle('cursor-not-allowed', isConfirmed);
            confirmButton.textContent = isConfirmed ? 'Turno confirmado' : 'Confirmar mi turno';
          }

          if (isConfirmed) {
            unlockInterface();
            if (storageKey) {
              try {
                window.sessionStorage.setItem(storageKey, 'confirmed');
              } catch (error) {
                // Ignore storage failures (e.g., private mode).
              }
            }
          } else if (requires) {
            lockInterface();
            if (storageKey) {
              try {
                window.sessionStorage.removeItem(storageKey);
              } catch (error) {
                // Ignore storage failures.
              }
            }
          } else {
            unlockInterface();
            if (storageKey) {
              try {
                window.sessionStorage.removeItem(storageKey);
              } catch (error) {
                // Ignore storage failures.
              }
            }
          }
        }

        if (requires && !isConfirmed && storedState !== 'confirmed') {
          lockInterface();
        }

        renderState();

        if (confirmButton && requires) {
          confirmButton.addEventListener('click', function () {
            if (isConfirmed) {
              return;
            }
            isConfirmed = true;
            renderState();
          });
        }
      })();
    </script>

    <script>
      (function () {
        var reloadTrigger = document.querySelector('[data-mini-app-reload-trigger]');
        if (!reloadTrigger) {
          return;
        }

        function reloadMiniApp() {
          try {
            window.location.reload();
          } catch (error) {
            window.location.href = window.location.href;
          }
        }

        reloadTrigger.addEventListener('click', function (event) {
          event.preventDefault();
          reloadMiniApp();
        });

        reloadTrigger.addEventListener('keydown', function (event) {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            reloadMiniApp();
          }
        });
      })();
    </script>

    <script>
      (function () {
        var content = document.querySelector('[data-mini-app-content]');
        var rosterCard = content
          ? content.querySelector('[data-daily-roster-card]')
          : document.querySelector('[data-daily-roster-card]');
        if (!rosterCard) {
          return;
        }

        var dayNodes = Array.prototype.slice.call(rosterCard.querySelectorAll('[data-roster-day]'));
        if (!dayNodes.length) {
          return;
        }

        var prevButton = rosterCard.querySelector('[data-roster-prev]');
        var nextButton = rosterCard.querySelector('[data-roster-next]');
        var dateLabel = rosterCard.querySelector('[data-roster-date]');
        var weekdayLabel = rosterCard.querySelector('[data-roster-weekday]');
        var telegramApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

        var initialIndex = parseInt(rosterCard.getAttribute('data-initial-index') || '0', 10);
        if (Number.isNaN(initialIndex)) {
          initialIndex = 0;
        }

        function clampIndex(index) {
          if (index < 0) {
            return 0;
          }
          if (index >= dayNodes.length) {
            return dayNodes.length - 1;
          }
          return index;
        }

        function applyNavState(activeIndex) {
          if (prevButton) {
            var isDisabled = activeIndex === 0;
            prevButton.disabled = isDisabled;
            prevButton.setAttribute('aria-disabled', isDisabled ? 'true' : 'false');
            prevButton.classList.toggle('opacity-50', isDisabled);
            prevButton.classList.toggle('cursor-not-allowed', isDisabled);
          }
          if (nextButton) {
            var isNextDisabled = activeIndex === dayNodes.length - 1;
            nextButton.disabled = isNextDisabled;
            nextButton.setAttribute('aria-disabled', isNextDisabled ? 'true' : 'false');
            nextButton.classList.toggle('opacity-50', isNextDisabled);
            nextButton.classList.toggle('cursor-not-allowed', isNextDisabled);
          }
        }

        function renderActiveDay(targetIndex) {
          var newIndex = clampIndex(targetIndex);
          dayNodes.forEach(function (node, index) {
            if (index === newIndex) {
              node.classList.remove('hidden');
              node.setAttribute('data-state', 'active');
            } else {
              node.classList.add('hidden');
              node.removeAttribute('data-state');
            }
          });

          var activeDay = dayNodes[newIndex];
          if (activeDay) {
            if (dateLabel) {
              dateLabel.textContent = activeDay.getAttribute('data-date-label') || '';
            }
            if (weekdayLabel) {
              weekdayLabel.textContent = activeDay.getAttribute('data-weekday') || '';
            }
          }

          rosterCard.setAttribute('data-current-index', String(newIndex));
          applyNavState(newIndex);

          if (telegramApp && telegramApp.HapticFeedback && telegramApp.HapticFeedback.selectionChanged) {
            telegramApp.HapticFeedback.selectionChanged();
          }
        }

        if (prevButton) {
          prevButton.addEventListener('click', function () {
            var currentIndex = parseInt(rosterCard.getAttribute('data-current-index') || String(initialIndex), 10);
            if (Number.isNaN(currentIndex)) {
              currentIndex = 0;
            }
            renderActiveDay(currentIndex - 1);
          });
        }

        if (nextButton) {
          nextButton.addEventListener('click', function () {
            var currentIndex = parseInt(rosterCard.getAttribute('data-current-index') || String(initialIndex), 10);
            if (Number.isNaN(currentIndex)) {
              currentIndex = 0;
            }
            renderActiveDay(currentIndex + 1);
          });
        }

        renderActiveDay(initialIndex);
      })();
    </script>

    <script>
      (function () {
        var root = document.querySelector('[data-goal-selector]');
        if (!root) {
          return;
        }

        var storageKey = 'miniapp-goal-choice';
        var optionNodes = Array.prototype.slice.call(root.querySelectorAll('[data-goal-option]'));
        if (!optionNodes.length) {
          return;
        }

        var indicators = Array.prototype.slice.call(root.querySelectorAll('[data-goal-indicator]'));
        var selectionValue = root.querySelector('[data-goal-selection-value]');
        var selectionLabel = root.querySelector('[data-goal-selection-label]');
        var navNodes = Array.prototype.slice.call(root.querySelectorAll('[data-goal-nav]'));

        function findIndexById(optionId) {
          return optionNodes.findIndex(function (node) {
            return node.getAttribute('data-goal-option-id') === optionId;
          });
        }

        var storedId = null;
        try {
          storedId = window.sessionStorage.getItem(storageKey);
        } catch (error) {
          storedId = null;
        }

        var initialId =
          storedId ||
          root.getAttribute('data-selected-id') ||
          optionNodes[0].getAttribute('data-goal-option-id');
        var activeIndex = findIndexById(initialId);
        if (activeIndex === -1) {
          activeIndex = 0;
          initialId = optionNodes[0].getAttribute('data-goal-option-id');
        }
        var selectedId = initialId;
        var hasStoredSelection = Boolean(storedId);

        function updateIndicators() {
          indicators.forEach(function (indicator, index) {
            var isActive = index === activeIndex;
            indicator.classList.toggle('bg-brand', isActive);
            indicator.classList.toggle('bg-slate-200', !isActive);
            indicator.style.transform = isActive ? 'scale(1.1)' : 'scale(1)';
            indicator.style.opacity = isActive ? '1' : '0.5';
            indicator.setAttribute('aria-current', isActive ? 'true' : 'false');
          });
        }

        function updateSelectionLabel(highlight) {
          if (!selectionValue) {
            return;
          }
          var labelIndex = findIndexById(selectedId);
          var label = labelIndex >= 0 ? optionNodes[labelIndex].getAttribute('data-goal-option-label') : '';
          selectionValue.textContent = label;

          if (!selectionLabel) {
            return;
          }
          if (!selectionLabel.dataset.baseClass) {
            selectionLabel.dataset.baseClass = selectionLabel.className;
          }
          if (highlight) {
            selectionLabel.classList.remove('text-slate-500');
            selectionLabel.classList.add('text-emerald-600');
          } else if (selectionLabel.dataset.baseClass) {
            selectionLabel.className = selectionLabel.dataset.baseClass;
          }
        }

        function refreshSelectButtons() {
          optionNodes.forEach(function (node) {
            var selectButton = node.querySelector('[data-goal-action="select"]');
            if (!selectButton) {
              return;
            }
            var nodeId = node.getAttribute('data-goal-option-id');
            var isSelected = nodeId === selectedId;
            if (!selectButton.dataset.defaultLabel) {
              selectButton.dataset.defaultLabel = selectButton.textContent.trim();
            }
            selectButton.disabled = isSelected;
            selectButton.classList.toggle('opacity-60', isSelected);
            selectButton.classList.toggle('cursor-not-allowed', isSelected);
            selectButton.textContent = isSelected ? 'Meta elegida' : selectButton.dataset.defaultLabel;
          });
        }

        function showOption(index) {
          if (optionNodes.length === 1) {
            index = 0;
          } else if (index < 0) {
            index = optionNodes.length - 1;
          } else if (index >= optionNodes.length) {
            index = 0;
          }

          activeIndex = index;

          optionNodes.forEach(function (node, nodeIndex) {
            node.classList.toggle('hidden', nodeIndex !== activeIndex);
          });
          updateIndicators();
        }

        function selectOption(optionId, highlight) {
          var index = findIndexById(optionId);
          if (index === -1) {
            return;
          }
          selectedId = optionId;
          root.setAttribute('data-selected-id', selectedId);

          try {
            window.sessionStorage.setItem(storageKey, optionId);
          } catch (error) {
            // Ignore storage errors (e.g., private mode).
          }

          showOption(index);
          updateSelectionLabel(highlight);
          refreshSelectButtons();
        }

        if (optionNodes.length <= 1) {
          navNodes.forEach(function (node) {
            node.disabled = true;
            node.style.opacity = '0.5';
            node.style.cursor = 'not-allowed';
          });
        } else {
          navNodes.forEach(function (node) {
            node.addEventListener('click', function (event) {
              var direction = event.currentTarget.getAttribute('data-goal-nav');
              var nextIndex = direction === 'next' ? activeIndex + 1 : activeIndex - 1;
              showOption(nextIndex);
            });
          });
        }

        root.addEventListener('click', function (event) {
          var actionButton = event.target.closest('[data-goal-action]');
          if (!actionButton || !root.contains(actionButton)) {
            return;
          }
          var action = actionButton.getAttribute('data-goal-action');
          var optionId = actionButton.getAttribute('data-goal-option-id');
          if (!optionId) {
            return;
          }

          if (action === 'select') {
            selectOption(optionId, true);
            var telegram = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
              telegram.HapticFeedback.notificationOccurred('success');
            }
            var selectedIndex = findIndexById(optionId);
            var selectedLabel =
              selectedIndex >= 0 ? optionNodes[selectedIndex].getAttribute('data-goal-option-label') : optionId;
            if (telegram && telegram.sendData) {
              telegram.sendData(
                JSON.stringify({
                  action: 'select-goal',
                  goal: optionId,
                  label: selectedLabel,
                })
              );
            } else {
              console.info('Meta seleccionada:', selectedLabel);
            }
          } else if (action === 'details') {
            var optionIndex = findIndexById(optionId);
            var optionLabel =
              optionIndex >= 0 ? optionNodes[optionIndex].getAttribute('data-goal-option-label') : '';
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.sendData) {
              window.Telegram.WebApp.sendData(
                JSON.stringify({
                  action: 'open-goal-details',
                  goal: optionId,
                  label: optionLabel,
                })
              );
            } else {
              console.info('Detalle de meta:', optionLabel || optionId);
            }
          }
        });

        showOption(activeIndex);
        updateSelectionLabel(hasStoredSelection);
        refreshSelectButtons();
      })();
    </script>

    <script>
      (function () {
        var section = document.querySelector('[data-leader-review]');
        if (!section) {
          return;
        }

        var filterState = { shift: 'all', farm: 'all', barn: 'all' };
        var filterGroups = Array.prototype.slice.call(section.querySelectorAll('[data-review-filter-group]'));
        var locationNodes = Array.prototype.slice.call(section.querySelectorAll('[data-review-location]'));
        var dayNodes = Array.prototype.slice.call(section.querySelectorAll('[data-review-day]'));
        var resetButton = section.querySelector('[data-review-reset]');
        var emptyState = section.querySelector('[data-review-empty]');
        var summaryTotal = section.querySelector('[data-review-summary-total]');
        var summaryAwaiting = section.querySelector('[data-review-summary-awaiting]');
        var summaryOverdue = section.querySelector('[data-review-summary-overdue]');
        var summaryApproved = section.querySelector('[data-review-summary-approved]');

        filterGroups.forEach(function (group) {
          var type = group.getAttribute('data-review-filter-group');
          var activeButton = group.querySelector('[data-review-filter][data-active="true"]');
          if (activeButton) {
            filterState[type] = activeButton.getAttribute('data-filter-value') || 'all';
          }
        });

        function updateCount(countNode, value) {
          if (!countNode) {
            return;
          }
          countNode.textContent = value;
        }

        function applyFilters() {
          var hasVisible = false;
          locationNodes.forEach(function (location) {
            var matches = true;
            if (filterState.shift !== 'all' && location.getAttribute('data-shift') !== filterState.shift) {
              matches = false;
            }
            if (filterState.farm !== 'all' && location.getAttribute('data-farm') !== filterState.farm) {
              matches = false;
            }
            if (filterState.barn !== 'all' && location.getAttribute('data-barn') !== filterState.barn) {
              matches = false;
            }
            location.classList.toggle('hidden', !matches);
            if (matches) {
              hasVisible = true;
            }
          });

          dayNodes.forEach(function (dayNode) {
            var visibleLocation = dayNode.querySelector('[data-review-location]:not(.hidden)');
            dayNode.classList.toggle('hidden', !visibleLocation);
          });

          if (emptyState) {
            emptyState.classList.toggle('hidden', hasVisible);
          }
        }

        function collectVisibleTasks() {
          var tasks = [];
          locationNodes.forEach(function (location) {
            if (location.classList.contains('hidden')) {
              return;
            }
            tasks = tasks.concat(Array.prototype.slice.call(location.querySelectorAll('[data-review-task]')));
          });
          return tasks;
        }

        function refreshMetrics() {
          var visibleTasks = collectVisibleTasks();
          var counts = {
            total: visibleTasks.length,
            awaiting: 0,
            approved: 0,
            rejected: 0,
            overdue: 0,
          };

          visibleTasks.forEach(function (task) {
            var state = task.getAttribute('data-review-task-state') || 'awaiting';
            var execState = task.getAttribute('data-review-execution-state') || '';
            if (execState === 'overdue') {
              counts.overdue += 1;
            }
            if (state === 'approved') {
              counts.approved += 1;
            } else if (state === 'rejected') {
              counts.rejected += 1;
            } else {
              counts.awaiting += 1;
            }
          });

          if (summaryTotal) {
            summaryTotal.textContent = counts.total;
          }
          if (summaryAwaiting) {
            summaryAwaiting.textContent = counts.awaiting;
          }
          if (summaryOverdue) {
            summaryOverdue.textContent = counts.overdue;
          }
          if (summaryApproved) {
            summaryApproved.textContent = counts.approved;
          }

          dayNodes.forEach(function (dayNode) {
            var locationList = Array.prototype.slice.call(dayNode.querySelectorAll('[data-review-location]'));
            var dayTasks = [];
            locationList.forEach(function (location) {
              if (location.classList.contains('hidden')) {
                return;
              }
              dayTasks = dayTasks.concat(Array.prototype.slice.call(location.querySelectorAll('[data-review-task]')));
            });
            var dayCounts = { total: dayTasks.length, awaiting: 0, approved: 0, overdue: 0 };
            dayTasks.forEach(function (task) {
              var state = task.getAttribute('data-review-task-state') || 'awaiting';
              var execState = task.getAttribute('data-review-execution-state') || '';
              if (execState === 'overdue') {
                dayCounts.overdue += 1;
              }
              if (state === 'approved') {
                dayCounts.approved += 1;
              } else if (state === 'rejected') {
                // omit from awaiting
              } else {
                dayCounts.awaiting += 1;
              }
            });
            updateCount(dayNode.querySelector('[data-review-day-total] [data-review-count]'), dayCounts.total);
            updateCount(dayNode.querySelector('[data-review-day-awaiting] [data-review-count]'), dayCounts.awaiting);
            updateCount(dayNode.querySelector('[data-review-day-overdue] [data-review-count]'), dayCounts.overdue);
          });

          locationNodes.forEach(function (locationNode) {
            var tasks = Array.prototype.slice.call(locationNode.querySelectorAll('[data-review-task]'));
            if (locationNode.classList.contains('hidden')) {
              updateCount(locationNode.querySelector('[data-review-location-total] [data-review-count]'), 0);
              updateCount(locationNode.querySelector('[data-review-location-awaiting] [data-review-count]'), 0);
              updateCount(locationNode.querySelector('[data-review-location-approved] [data-review-count]'), 0);
              updateCount(locationNode.querySelector('[data-review-location-overdue] [data-review-count]'), 0);
              return;
            }
            var locCounts = { total: tasks.length, awaiting: 0, approved: 0, overdue: 0 };
            tasks.forEach(function (task) {
              var state = task.getAttribute('data-review-task-state') || 'awaiting';
              var execState = task.getAttribute('data-review-execution-state') || '';
              if (execState === 'overdue') {
                locCounts.overdue += 1;
              }
              if (state === 'approved') {
                locCounts.approved += 1;
              } else if (state === 'rejected') {
                // skip
              } else {
                locCounts.awaiting += 1;
              }
            });
            updateCount(locationNode.querySelector('[data-review-location-total] [data-review-count]'), locCounts.total);
            updateCount(locationNode.querySelector('[data-review-location-awaiting] [data-review-count]'), locCounts.awaiting);
            updateCount(locationNode.querySelector('[data-review-location-approved] [data-review-count]'), locCounts.approved);
            updateCount(locationNode.querySelector('[data-review-location-overdue] [data-review-count]'), locCounts.overdue);
          });
        }

        filterGroups.forEach(function (group) {
          var type = group.getAttribute('data-review-filter-group');
          group.addEventListener('click', function (event) {
            var button = event.target.closest('[data-review-filter]');
            if (!button || !group.contains(button)) {
              return;
            }
            var value = button.getAttribute('data-filter-value') || 'all';
            var activeButton = group.querySelector('[data-review-filter][data-active="true"]');
            if (activeButton === button) {
              return;
            }
            if (activeButton) {
              activeButton.setAttribute('data-active', 'false');
            }
            button.setAttribute('data-active', 'true');
            filterState[type] = value;
            applyFilters();
            refreshMetrics();
          });
        });

        if (resetButton) {
          resetButton.addEventListener('click', function () {
            filterGroups.forEach(function (group) {
              var type = group.getAttribute('data-review-filter-group');
              var activeButton = group.querySelector('[data-review-filter][data-active="true"]');
              if (activeButton) {
                activeButton.setAttribute('data-active', 'false');
              }
              var fallback =
                group.querySelector('[data-review-filter][data-filter-value="all"]') ||
                group.querySelector('[data-review-filter]');
              if (fallback) {
                fallback.setAttribute('data-active', 'true');
                filterState[type] = fallback.getAttribute('data-filter-value') || 'all';
              } else {
                filterState[type] = 'all';
              }
            });
            applyFilters();
            refreshMetrics();
          });
        }

        function togglePanel(card, type) {
          var panel = card.querySelector('[data-review-comment-panel][data-type="' + type + '"]');
          if (!panel) {
            return;
          }
          var alternateType = type === 'approve' ? 'reject' : 'approve';
          var alternatePanel = card.querySelector('[data-review-comment-panel][data-type="' + alternateType + '"]');
          if (alternatePanel) {
            alternatePanel.classList.add('hidden');
          }
          var isVisible = !panel.classList.contains('hidden');
          panel.classList.toggle('hidden', isVisible);
          if (!isVisible) {
            var textarea = panel.querySelector('textarea');
            if (textarea) {
              var storedKey = type === 'approve' ? 'data-review-last-approve' : 'data-review-last-reject';
              var storedValue = card.getAttribute(storedKey);
              if (storedValue && !textarea.value) {
                textarea.value = storedValue;
              }
              textarea.focus();
            }
          }
        }

        section.addEventListener('click', function (event) {
          var descriptionToggle = event.target.closest('[data-review-description-toggle]');
          if (descriptionToggle) {
            var descriptionCard = descriptionToggle.closest('[data-review-task]');
            if (!descriptionCard) {
              return;
            }
            var description = descriptionCard.querySelector('[data-review-description]');
            if (!description) {
              return;
            }
            var expanded = descriptionToggle.getAttribute('aria-expanded') === 'true';
            var labelNode = descriptionToggle.querySelector('[data-review-description-label]');
            var openLabel = descriptionToggle.getAttribute('data-label-open') || 'Ver descripci√≥n';
            var closeLabel = descriptionToggle.getAttribute('data-label-close') || 'Ocultar descripci√≥n';
            descriptionToggle.setAttribute('aria-expanded', expanded ? 'false' : 'true');
            description.classList.toggle('hidden', expanded);
            if (labelNode) {
              labelNode.textContent = expanded ? openLabel : closeLabel;
            }
            return;
          }

          var approveButton = event.target.closest('[data-review-approve]');
          if (approveButton) {
            var approveCard = approveButton.closest('[data-review-task]');
            if (approveCard) {
              togglePanel(approveCard, 'approve');
            }
            return;
          }

          var rejectButton = event.target.closest('[data-review-reject]');
          if (rejectButton) {
            var rejectCard = rejectButton.closest('[data-review-task]');
            if (rejectCard) {
              togglePanel(rejectCard, 'reject');
            }
            return;
          }

          var cancelButton = event.target.closest('[data-review-cancel]');
          if (cancelButton) {
            var cancelType = cancelButton.getAttribute('data-review-cancel');
            var cancelCard = cancelButton.closest('[data-review-task]');
            if (!cancelType || !cancelCard) {
              return;
            }
            var cancelPanel = cancelCard.querySelector('[data-review-comment-panel][data-type="' + cancelType + '"]');
            if (cancelPanel) {
              cancelPanel.classList.add('hidden');
              if (cancelType === 'reject') {
                Array.prototype.slice
                  .call(cancelPanel.querySelectorAll('[data-review-reject-reason]'))
                  .forEach(function (reasonNode) {
                    reasonNode.setAttribute('data-selected', 'false');
                  });
              }
            }
            return;
          }

          var reasonButton = event.target.closest('[data-review-reject-reason]');
          if (reasonButton) {
            var reasonPanel = reasonButton.closest('[data-review-comment-panel]');
            var textarea = reasonPanel ? reasonPanel.querySelector('textarea') : null;
            var isSelected = reasonButton.getAttribute('data-selected') === 'true';
            var reasonText = reasonButton.textContent ? reasonButton.textContent.trim() : '';
            var lines = textarea
              ? textarea.value
                  .split(/\n+/)
                  .map(function (line) {
                    return line.trim();
                  })
                  .filter(Boolean)
              : [];
            if (isSelected) {
              reasonButton.setAttribute('data-selected', 'false');
              if (textarea) {
                lines = lines.filter(function (line) {
                  return line !== reasonText;
                });
                textarea.value = lines.join('\n');
              }
            } else {
              reasonButton.setAttribute('data-selected', 'true');
              if (textarea && reasonText) {
                if (lines.indexOf(reasonText) === -1) {
                  lines.unshift(reasonText);
                }
                textarea.value = lines.join('\n');
              }
            }
            return;
          }

          var confirmButton = event.target.closest('[data-review-confirm]');
          if (confirmButton) {
            var action = confirmButton.getAttribute('data-review-confirm');
            var actionCard = confirmButton.closest('[data-review-task]');
            if (!action || !actionCard) {
              return;
            }
            var panel = actionCard.querySelector(
              '[data-review-comment-panel][data-type="' + (action === 'approve' ? 'approve' : 'reject') + '"]'
            );
            if (panel) {
              panel.classList.add('hidden');
              if (action === 'reject') {
                Array.prototype.slice
                  .call(panel.querySelectorAll('[data-review-reject-reason]'))
                  .forEach(function (reasonNode) {
                    reasonNode.setAttribute('data-selected', 'false');
                  });
              }
              var textarea = panel.querySelector('textarea');
              if (textarea) {
                actionCard.setAttribute(
                  action === 'approve' ? 'data-review-last-approve' : 'data-review-last-reject',
                  textarea.value.trim()
                );
              }
            }
            var feedback = actionCard.querySelector('[data-review-feedback]');
            if (feedback) {
              var isApprove = action === 'approve';
              feedback.textContent = isApprove
                ? 'Tarea aprobada y enviada.'
                : 'Devolviste la tarea con comentarios.';
              feedback.classList.remove('hidden');
              feedback.classList.toggle('bg-emerald-50', isApprove);
              feedback.classList.toggle('border-emerald-200', isApprove);
              feedback.classList.toggle('text-emerald-700', isApprove);
              feedback.classList.toggle('bg-rose-50', !isApprove);
              feedback.classList.toggle('border-rose-200', !isApprove);
              feedback.classList.toggle('text-rose-700', !isApprove);
            }
            var statusChip = actionCard.querySelector('[data-review-status-chip]');
            var statusLabel = actionCard.querySelector('[data-review-status-label]');
            var statusDetails = actionCard.querySelector('[data-review-status-details]');
            var newState = action === 'approve' ? 'approved' : 'rejected';
            actionCard.setAttribute('data-review-task-state', newState);
            if (statusChip) {
              statusChip.setAttribute('data-state', newState);
              statusChip.classList.remove('tm-review-status-chip--flash');
              void statusChip.offsetWidth;
              statusChip.classList.add('tm-review-status-chip--flash');
            }
            if (statusLabel) {
              statusLabel.textContent = action === 'approve' ? 'Aprobada' : 'Devuelta';
            }
            if (statusDetails) {
              statusDetails.textContent = action === 'approve'
                ? 'Aprobada hace instantes'
                : 'Devuelta para ajustes';
            }
            refreshMetrics();
            return;
          }
        });

        applyFilters();
        refreshMetrics();
      })();
    </script>

    <script>
      (function () {
        var content = document.querySelector('[data-mini-app-content]');
        if (!content) {
          return;
        }

        var reportView = content.querySelector('[data-mini-app-report]');
        if (!reportView) {
          return;
        }

        var telegram = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        var backButton = telegram && telegram.BackButton ? telegram.BackButton : null;
        var userNameNode = document.querySelector('[data-telegram-display-name]');
        var userName = userNameNode ? userNameNode.textContent.trim() : 'equipo';

        var openButtons = Array.prototype.slice.call(document.querySelectorAll('[data-report-trigger]'));
        var suggestionButtons = Array.prototype.slice.call(reportView.querySelectorAll('[data-report-suggestion]'));
        var suggestionLabel = reportView.querySelector('[data-report-suggestion-label]');
        var suggestionValue = reportView.querySelector('[data-report-suggestion-value]');
        var form = reportView.querySelector('[data-report-form]');
        var input = reportView.querySelector('[data-report-input]');
        var errorText = reportView.querySelector('[data-report-error]');
        var formStep = reportView.querySelector('[data-report-step="form"]');
        var successStep = reportView.querySelector('[data-report-step="success"]');
        var cancelButtons = Array.prototype.slice.call(reportView.querySelectorAll('[data-report-cancel]'));
        var doneButton = reportView.querySelector('[data-report-done]');
        var againButton = reportView.querySelector('[data-report-again]');
        var successGreeting = reportView.querySelector('[data-report-success-greeting]');
        var successTask = reportView.querySelector('[data-report-success-task]');
        var successImpact = reportView.querySelector('[data-report-success-impact]');
        var successPoints = reportView.querySelector('[data-report-success-points]');
        var successRecognition = reportView.querySelector('[data-report-success-recognition]');

        var state = {
          suggestionTitle: '',
          suggestionPoints: null,
        };

        var homeSections = [];

        function collectHomeSections() {
          homeSections = Array.prototype.slice
            .call(content.children)
            .filter(function (node) {
              if (node === reportView) {
                return false;
              }
              if (node.hasAttribute('data-mini-app-flow-dialog-root')) {
                return false;
              }
              return true;
            });
        }

        function parsePoints(value) {
          if (value === null || value === undefined || value === '') {
            return null;
          }
          var numeric = parseInt(value, 10);
          if (isNaN(numeric)) {
            return null;
          }
          return numeric;
        }

        function clearError() {
          if (errorText) {
            errorText.classList.add('hidden');
          }
          if (input) {
            input.classList.remove('border-rose-300');
          }
        }

        function showError() {
          if (errorText) {
            errorText.classList.remove('hidden');
          }
          if (input) {
            input.classList.add('border-rose-300');
          }
        }

        function highlightSuggestionButtons() {
          if (!suggestionButtons.length) {
            return;
          }
          var matchedPoints = null;
          suggestionButtons.forEach(function (button) {
            var title = button.getAttribute('data-report-task') || '';
            var isMatch = state.suggestionTitle && title === state.suggestionTitle;
            button.classList.toggle('report-suggestion-active', Boolean(isMatch));
            button.setAttribute('aria-pressed', isMatch ? 'true' : 'false');
            if (isMatch) {
              matchedPoints = parsePoints(button.getAttribute('data-report-points'));
            }
          });
          state.suggestionPoints = matchedPoints;
        }

        function updateSuggestionLabel() {
          if (!suggestionLabel || !suggestionValue) {
            return;
          }
          if (state.suggestionTitle) {
            suggestionLabel.classList.remove('text-slate-400');
            suggestionValue.textContent = state.suggestionTitle;
          } else {
            suggestionLabel.classList.add('text-slate-400');
            suggestionValue.textContent = 'Personalizada';
          }
        }

        function setSuggestion(title, points, focusInput) {
          state.suggestionTitle = title ? title.trim() : '';
          state.suggestionPoints = typeof points === 'number' ? points : parsePoints(points);
          if (input) {
            input.value = state.suggestionTitle;
            if (focusInput) {
              window.requestAnimationFrame(function () {
                input.focus();
                var length = input.value.length;
                if (typeof input.setSelectionRange === 'function') {
                  input.setSelectionRange(length, length);
                }
              });
            }
          }
          updateSuggestionLabel();
          highlightSuggestionButtons();
          clearError();
        }

        function showFormStep() {
          if (formStep) {
            formStep.classList.remove('hidden');
          }
          if (successStep) {
            successStep.classList.add('hidden');
          }
          clearError();
        }

        function showSuccessStep(title, points) {
          if (formStep) {
            formStep.classList.add('hidden');
          }
          if (successStep) {
            successStep.classList.remove('hidden');
          }
          var displayName = userName || 'equipo';
          if (successGreeting) {
            successGreeting.textContent = '¬°Gracias, ' + displayName + '!';
          }
          if (successTask) {
            successTask.textContent = title || 'tu labor de hoy';
          }
          if (points && successImpact && successPoints) {
            successImpact.classList.remove('hidden');
            successPoints.textContent = '+' + points + ' pts';
          } else if (successImpact) {
            successImpact.classList.add('hidden');
          }
          if (successRecognition) {
            if (points) {
              successRecognition.classList.add('hidden');
            } else {
              successRecognition.textContent =
                'Tu dedicaci√≥n en ' +
                (title || 'esta tarea') +
                ' mantiene al equipo alineado y demuestra tu liderazgo silencioso.';
              successRecognition.classList.remove('hidden');
            }
          }
        }

        function handleBackButton() {
          switchToHome();
        }

        function showReportView(initialSuggestion) {
          collectHomeSections();
          homeSections.forEach(function (node) {
            node.classList.add('hidden');
          });
          reportView.classList.remove('hidden');
          showFormStep();
          setSuggestion(initialSuggestion.title, initialSuggestion.points, true);
          if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
            telegram.HapticFeedback.selectionChanged();
          }
          if (backButton) {
            if (typeof backButton.offClick === 'function') {
              backButton.offClick(handleBackButton);
            }
            if (typeof backButton.onClick === 'function') {
              backButton.onClick(handleBackButton);
            }
            if (typeof backButton.show === 'function') {
              backButton.show();
            }
          }
          if (content && typeof content.scrollIntoView === 'function') {
            content.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }

        function switchToHome() {
          reportView.classList.add('hidden');
          collectHomeSections();
          homeSections.forEach(function (node) {
            node.classList.remove('hidden');
          });
          showFormStep();
          setSuggestion('', null, false);
          if (input) {
            input.value = '';
          }
          if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.impactOccurred) {
            telegram.HapticFeedback.impactOccurred('light');
          }
          if (backButton) {
            if (typeof backButton.offClick === 'function') {
              backButton.offClick(handleBackButton);
            }
            if (typeof backButton.hide === 'function') {
              backButton.hide();
            }
          }
        }

        function getInitialSuggestion(details) {
          var suggestion =
            details && (details.title || details.points !== undefined)
              ? {
                  title: details.title || '',
                  points: parsePoints(details.points),
                }
              : null;
          if (!suggestion || (!suggestion.title && suggestion.points === null)) {
            if (suggestionButtons.length) {
              var first = suggestionButtons[0];
              suggestion = {
                title: first.getAttribute('data-report-task') || '',
                points: parsePoints(first.getAttribute('data-report-points')),
              };
            } else {
              suggestion = { title: '', points: null };
            }
          }
          return suggestion;
        }

        collectHomeSections();
        highlightSuggestionButtons();
        updateSuggestionLabel();

        openButtons.forEach(function (button) {
          button.addEventListener('click', function (event) {
            var source = event.currentTarget;
            var title = source.getAttribute('data-report-task') || '';
            var points = parsePoints(source.getAttribute('data-report-points'));
            var suggestion = getInitialSuggestion({ title: title, points: points });
            showReportView(suggestion);
          });
        });

        suggestionButtons.forEach(function (button) {
          button.addEventListener('click', function (event) {
            var btn = event.currentTarget;
            var title = btn.getAttribute('data-report-task') || '';
            var points = parsePoints(btn.getAttribute('data-report-points'));
            setSuggestion(title, points, true);
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.impactOccurred) {
              telegram.HapticFeedback.impactOccurred('soft');
            }
          });
        });

        if (input) {
          input.addEventListener('input', function () {
            clearError();
            state.suggestionTitle = input.value.trim();
            highlightSuggestionButtons();
            updateSuggestionLabel();
          });
        }

        cancelButtons.forEach(function (button) {
          button.addEventListener('click', function () {
            switchToHome();
          });
        });

        if (doneButton) {
          doneButton.addEventListener('click', function () {
            switchToHome();
          });
        }

        if (againButton) {
          againButton.addEventListener('click', function () {
            showFormStep();
            var suggestion = getInitialSuggestion({});
            setSuggestion(suggestion.title, suggestion.points, true);
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
              telegram.HapticFeedback.selectionChanged();
            }
          });
        }

        if (form) {
          form.addEventListener('submit', function (event) {
            event.preventDefault();
            if (!input) {
              return;
            }
            var value = input.value.trim();
            if (!value) {
              showError();
              input.focus();
              return;
            }
            state.suggestionTitle = value;
            highlightSuggestionButtons();
            var points = state.suggestionPoints;
            showSuccessStep(value, points);
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
              telegram.HapticFeedback.notificationOccurred('success');
            }
            if (telegram && typeof telegram.sendData === 'function') {
              try {
                telegram.sendData(
                  JSON.stringify({
                    action: 'report-task',
                    title: value,
                    points: points,
                  })
                );
              } catch (error) {
                console.info('No se pudo enviar el reporte a Telegram:', error);
              }
            }
          });
        }
      })();
    </script>

    {% if telegram_mini_app %}
    {{ telegram_mini_app|json_script:"tm-mini-app-config" }}
    {% endif %}
    {% if telegram_mini_app %}
    <script>
      (function () {
        const dataScript = document.getElementById('tm-mini-app-config');
        let payload = null;
        if (dataScript) {
          try {
            payload = JSON.parse(dataScript.textContent);
          } catch (error) {
            console.warn('No se pudo analizar la configuracion inicial del mini app.', error);
          }
        }

        const telegram = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        if (telegram && typeof telegram.ready === 'function') {
          try {
            telegram.ready();
          } catch (error) {
            console.warn('Telegram WebApp no pudo inicializarse correctamente.', error);
          }
        }
        const eggWorkflow = payload && payload.egg_workflow ? payload.egg_workflow : null;
        const productionReference = payload && payload.production_reference ? payload.production_reference : null;
        const tmMiniApp = window.tmMiniApp || (window.tmMiniApp = {});
        const eggStageDefinitions = {};
        if (eggWorkflow && Array.isArray(eggWorkflow.stages)) {
          eggWorkflow.stages.forEach(function (stage) {
            if (stage && stage.id) {
              eggStageDefinitions[stage.id] = stage;
            }
          });
        }
        const confirmMessageText = '¬øDeseas finalizar tu turno y cerrar sesi√≥n?';
        const mainAction = document.querySelector('[data-telegram-main-action]');
        const fallbackActionContainer = document.querySelector('[data-mini-app-floating-action]');
        const finishTriggers = Array.prototype.slice.call(
          document.querySelectorAll('[data-mini-app-finish-trigger]')
        );
        const mainButton = telegram && telegram.MainButton ? telegram.MainButton : null;
        const loginUrl =
          mainAction && mainAction.getAttribute('data-login-url')
            ? mainAction.getAttribute('data-login-url')
            : window.location.pathname;
        const logoutUrl =
          mainAction && mainAction.getAttribute('data-logout-url')
            ? mainAction.getAttribute('data-logout-url')
            : null;
        const logoutForm = document.querySelector('[data-mini-app-logout-form]');
        const csrfTokenInput = logoutForm ? logoutForm.querySelector('input[name="csrfmiddlewaretoken"]') : null;
        const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;
        tmMiniApp.csrfToken = csrfToken;
        tmMiniApp.telegram = telegram;
        tmMiniApp.purchases = (payload && payload.purchases) || {};

        const dialogRoot = document.querySelector('[data-mini-app-flow-dialog-root]');
        const confirmDialog = dialogRoot ? dialogRoot.querySelector('[data-mini-app-dialog="confirm"]') : null;
        const gratitudeDialog = dialogRoot ? dialogRoot.querySelector('[data-mini-app-dialog="gratitude"]') : null;
        const confirmAcceptButton = confirmDialog ? confirmDialog.querySelector('[data-flow-action="confirm-accept"]') : null;
        const confirmCancelButton = confirmDialog ? confirmDialog.querySelector('[data-flow-action="confirm-cancel"]') : null;
        const confirmStatusNode = confirmDialog ? confirmDialog.querySelector('[data-flow-confirm-status]') : null;
        const confirmErrorNode = confirmDialog ? confirmDialog.querySelector('[data-flow-confirm-error]') : null;
        const gratitudeAcceptButton = gratitudeDialog
          ? gratitudeDialog.querySelector('[data-flow-action="gratitude-accept"]')
          : null;

        const confirmAcceptDefaultLabel = confirmAcceptButton ? confirmAcceptButton.textContent.trim() : '';
        const confirmCancelDefaultLabel = confirmCancelButton ? confirmCancelButton.textContent.trim() : '';

        let isProcessingMainAction = false;
        let activeDialog = null;
        let lastFocusedElement = null;

        const weightCard = document.querySelector('[data-weight-card]');
        const weightSubmitUrl = weightCard ? weightCard.getAttribute('data-weight-submit-url') || '' : '';
        const weightDate = weightCard ? weightCard.getAttribute('data-weight-date') || '' : '';

        const pendingClassificationCard = document.querySelector('[data-pending-classification-card]');
        const pendingClassificationStageButtons = pendingClassificationCard
          ? Array.prototype.slice.call(pendingClassificationCard.querySelectorAll('[data-select-egg-stage]'))
          : [];

        const transportCard = document.querySelector('[data-transport-queue-card]');
        const transportForm = transportCard ? transportCard.querySelector('[data-transport-form]') : null;
        const transportProductionInputs = transportCard
          ? Array.prototype.slice.call(transportCard.querySelectorAll('[data-transport-production-input]'))
          : [];
        const transportSubmitUrl = transportForm
          ? transportForm.getAttribute('data-transport-submit-url') || ''
          : '';
        const transportAuthorizeButton = transportCard
          ? transportCard.querySelector('[data-transport-authorize]')
          : null;
        const transportSelectionSummary = transportCard
          ? transportCard.querySelector('[data-transport-selection-summary]')
          : null;
        const transportFeedbackNode = transportCard ? transportCard.querySelector('[data-transport-feedback]') : null;
        const transportSuccessNode = transportCard ? transportCard.querySelector('[data-transport-success]') : null;
        const transportSuccessText = transportCard ? transportCard.querySelector('[data-transport-success-text]') : null;
        const transporterField = transportCard ? transportCard.querySelector('[data-transport-transporter]') : null;
        const expectedDateField = transportCard ? transportCard.querySelector('[data-transport-date]') : null;
        const transportDefaultDate = transportCard
          ? transportCard.getAttribute('data-default-expected-date') || ''
          : '';
        const transportConfirmForm = document.querySelector('[data-transport-confirm-form]');
        const transportConfirmInputs = transportConfirmForm
          ? Array.prototype.slice.call(transportConfirmForm.querySelectorAll('[data-transport-confirm-input]'))
          : [];
        const transportConfirmButton = transportConfirmForm
          ? transportConfirmForm.querySelector('[data-transport-confirm-submit]')
          : null;
        const transportConfirmFeedback = transportConfirmForm
          ? transportConfirmForm.querySelector('[data-transport-confirm-feedback]')
          : null;
        const transportConfirmUrl = transportConfirmForm
          ? transportConfirmForm.getAttribute('data-transport-confirm-url') || ''
          : '';

        const eggStageCards = Array.prototype.slice.call(document.querySelectorAll('[data-egg-stage-card]'));
        const eggStageSaveButtons = Array.prototype.slice.call(document.querySelectorAll('[data-egg-stage-save]'));
        const eggStageCompleteButtons = Array.prototype.slice.call(document.querySelectorAll('[data-egg-stage-complete]'));
        const eggStageInputs = Array.prototype.slice.call(document.querySelectorAll('[data-egg-stage-input]'));
        const stageProgressContainers = {};
        const classificationPanel = document.querySelector('[data-classification-panel]');
        const classificationRows = classificationPanel
          ? Array.prototype.slice.call(classificationPanel.querySelectorAll('[data-classification-row]'))
          : [];
        const classificationInputs = classificationPanel
          ? Array.prototype.slice.call(classificationPanel.querySelectorAll('[data-classification-input]'))
          : [];
        const classificationSummaryNode = classificationPanel
          ? classificationPanel.querySelector('[data-classification-summary]')
          : null;
        const classificationFeedbackNode = classificationPanel
          ? classificationPanel.querySelector('[data-classification-feedback]')
          : null;
        const classificationEggsPerCarton =
          classificationSummaryNode && classificationSummaryNode.hasAttribute('data-eggs-per-carton')
            ? Number(classificationSummaryNode.getAttribute('data-eggs-per-carton')) || 0
            : 0;
        const classificationExpectedCartons =
          classificationSummaryNode && classificationSummaryNode.hasAttribute('data-expected-cartons')
            ? Number(classificationSummaryNode.getAttribute('data-expected-cartons')) || 0
            : 0;
        const classificationExpectedEggs =
          classificationSummaryNode && classificationSummaryNode.hasAttribute('data-expected-eggs')
            ? Number(classificationSummaryNode.getAttribute('data-expected-eggs')) || 0
            : classificationExpectedCartons * (classificationEggsPerCarton || 0);
        const inspectionCard = document.querySelector('[data-egg-stage-card][data-egg-stage="inspection"]');
        const inspectionInputs = inspectionCard
          ? Array.prototype.slice.call(inspectionCard.querySelectorAll('[data-inspection-caliber-input]'))
          : [];
        const inspectionSummaryNode = inspectionCard
          ? inspectionCard.querySelector('[data-inspection-summary]')
          : null;
        const inspectionSummaryTotalNode = inspectionSummaryNode
          ? inspectionSummaryNode.querySelector('[data-inspection-summary-total]')
          : null;
        const inspectionSummaryDiscardNode = inspectionSummaryNode
          ? inspectionSummaryNode.querySelector('[data-inspection-summary-discard]')
          : null;
        const inspectionSummaryFeedbackNode = inspectionSummaryNode
          ? inspectionSummaryNode.querySelector('[data-inspection-summary-feedback]')
          : null;
        const inspectionExpectedCartons =
          inspectionSummaryNode && inspectionSummaryNode.hasAttribute('data-expected-cartons')
            ? Number(inspectionSummaryNode.getAttribute('data-expected-cartons')) || 0
            : 0;

        const dispatchStageCard = document.querySelector('[data-egg-stage-card][data-egg-stage="dispatches"]');
        const dispatchFormCard = document.querySelector('[data-dispatch-form-card]');
        const dispatchDetailCard = document.querySelector('[data-dispatch-detail-card]');
        const dispatchFormContainer = dispatchFormCard
          ? dispatchFormCard.querySelector('[data-dispatch-form-container]')
          : null;
        const dispatchDetailContainer = dispatchDetailCard
          ? dispatchDetailCard.querySelector('[data-dispatch-detail-container]')
          : null;
        const dispatchCreateTriggers = Array.prototype.slice.call(
          document.querySelectorAll('[data-dispatch-create-trigger]')
        );
        const dispatchEditTriggers = Array.prototype.slice.call(
          document.querySelectorAll('[data-dispatch-edit-trigger]')
        );
        const dispatchDetailTriggers = Array.prototype.slice.call(
          document.querySelectorAll('[data-dispatch-detail-trigger]')
        );
        const dispatchCloseTriggers = Array.prototype.slice.call(document.querySelectorAll('[data-dispatch-close]'));
        const dispatchSubmitButtons = Array.prototype.slice.call(document.querySelectorAll('[data-dispatch-submit]'));
        const dispatchConfirmButtons = Array.prototype.slice.call(document.querySelectorAll('[data-dispatch-confirm]'));
        const dispatchCartonsPerPack =
          eggWorkflow && typeof eggWorkflow.cartons_per_pack === 'number' ? eggWorkflow.cartons_per_pack : 30;
        const dispatchFormPanels = dispatchFormContainer
          ? Array.prototype.slice.call(dispatchFormContainer.querySelectorAll('[data-dispatch-form]'))
          : [];
        const dispatchDetailPanels = dispatchDetailContainer
          ? Array.prototype.slice.call(dispatchDetailContainer.querySelectorAll('[data-dispatch-detail]'))
          : [];
        const dispatchSummary = eggWorkflow && eggWorkflow.dispatch_summary ? eggWorkflow.dispatch_summary : null;
        const dispatchStatusOptions =
          dispatchSummary && Array.isArray(dispatchSummary.status_options) ? dispatchSummary.status_options : [];
        const dispatchStatusMap = {};
        dispatchStatusOptions.forEach(function (option) {
          if (option && option.id) {
            dispatchStatusMap[option.id] = option;
          }
        });
        const statusThemeClasses = {
          slate: ['border-slate-300', 'bg-slate-50', 'text-slate-600'],
          brand: ['border-amber-300', 'bg-amber-50', 'text-amber-700'],
          rose: ['border-rose-300', 'bg-rose-50', 'text-rose-600'],
          emerald: ['border-emerald-300', 'bg-emerald-50', 'text-emerald-700'],
          sky: ['border-sky-300', 'bg-sky-50', 'text-sky-700'],
        };
        const allStatusThemeClasses = [];
        Object.keys(statusThemeClasses).forEach(function (key) {
          const themeClasses = statusThemeClasses[key];
          themeClasses.forEach(function (cls) {
            if (allStatusThemeClasses.indexOf(cls) === -1) {
              allStatusThemeClasses.push(cls);
            }
          });
        });
        const differenceThemeClasses = {
          positive: ['border-rose-200', 'bg-rose-50', 'text-rose-600'],
          negative: ['border-amber-200', 'bg-amber-50', 'text-amber-600'],
          neutral: ['border-emerald-200', 'bg-emerald-50', 'text-emerald-600'],
        };
        const allDifferenceThemeClasses = [];
        Object.keys(differenceThemeClasses).forEach(function (key) {
          const diffClasses = differenceThemeClasses[key];
          diffClasses.forEach(function (cls) {
            if (allDifferenceThemeClasses.indexOf(cls) === -1) {
              allDifferenceThemeClasses.push(cls);
            }
          });
        });
        const dispatchStatusSelects = Array.prototype.slice.call(
          document.querySelectorAll('[data-dispatch-status-input]')
        );

        const eggStageState = {};
        let highlightedStageId = null;
        let stageHighlightResetTimer = null;

        const verificationForm = document.querySelector('[data-egg-verification-form]');
        const verificationInputs = verificationForm
          ? Array.prototype.slice.call(verificationForm.querySelectorAll('[data-egg-verification-input]'))
          : [];
        const verificationSubmitUrl = verificationForm
          ? verificationForm.getAttribute('data-egg-verification-submit-url') || ''
          : '';
        const verificationFeedback = verificationForm
          ? verificationForm.querySelector('[data-egg-verification-feedback]')
          : null;

        const appTimeZone = document.body.getAttribute('data-app-timezone') || 'America/Bogota';
        const hasIntl = typeof Intl !== 'undefined' && typeof Intl.NumberFormat === 'function';
        const numberFormatter = hasIntl ? new Intl.NumberFormat('es-CO', { maximumFractionDigits: 2 }) : null;
        const integerFormatter = hasIntl ? new Intl.NumberFormat('es-CO', { maximumFractionDigits: 0 }) : null;
        const weightFormatter = hasIntl
          ? new Intl.NumberFormat('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 3 })
          : null;
        const percentageFormatter = hasIntl
          ? new Intl.NumberFormat('es-CO', { maximumFractionDigits: 2, minimumFractionDigits: 0 })
          : null;
        const dateFormatter =
          typeof Intl !== 'undefined' && typeof Intl.DateTimeFormat === 'function'
            ? new Intl.DateTimeFormat('es-CO', {
                weekday: 'short',
                day: '2-digit',
                month: 'short',
                timeZone: appTimeZone,
              })
            : null;

        function normalizeNumber(value) {
          if (value === null || value === undefined || value === '') {
            return null;
          }
          const numeric = Number(value);
          return Number.isFinite(numeric) ? numeric : null;
        }

        function formatNumber(value) {
          if (!Number.isFinite(value)) {
            return '‚Äî';
          }
          if (!numberFormatter) {
            return String(value);
          }
          return numberFormatter.format(value);
        }

        function formatPercentage(value) {
          if (!Number.isFinite(value)) {
            return '‚Äî';
          }
          if (percentageFormatter) {
            return percentageFormatter.format(value) + ' %';
          }
          const fixed = value.toFixed(2);
          return fixed.replace(/\.?0+$/, '') + ' %';
        }



        function formatDateLabel(value) {
          if (!value) {
            return 'Sin fecha';
          }
          const parsed = Date.parse(value);
          if (Number.isNaN(parsed)) {
            return value;
          }
          if (dateFormatter) {
            return dateFormatter.format(new Date(parsed));
          }
          return new Date(parsed).toISOString().slice(0, 10);
        }

        function hideTransportMessages() {
          if (transportFeedbackNode) {
            transportFeedbackNode.classList.add('hidden');
            transportFeedbackNode.textContent = '';
          }
          if (transportSuccessNode) {
            transportSuccessNode.classList.add('hidden');
            if (transportSuccessText) {
              transportSuccessText.textContent = '';
            }
          }
        }

        function showTransportFeedback(message) {
          if (!transportFeedbackNode) {
            return;
          }
          transportFeedbackNode.textContent = message;
          transportFeedbackNode.classList.remove('hidden');
          if (transportSelectionSummary) {
            transportSelectionSummary.classList.add('text-rose-600');
          }
          if (transportSuccessNode) {
            transportSuccessNode.classList.add('hidden');
            if (transportSuccessText) {
              transportSuccessText.textContent = '';
            }
          }
        }

        function focusDispatchCard(cardNode) {
          if (!cardNode) {
            return;
          }
          if (typeof cardNode.scrollIntoView === 'function') {
            cardNode.scrollIntoView({
              behavior: 'smooth',
              block: 'start',
            });
          }
        }

        function hideDispatchForms() {
          if (!dispatchFormContainer) {
            return;
          }
          Array.prototype.slice
            .call(dispatchFormContainer.querySelectorAll('[data-dispatch-form]'))
            .forEach(function (panel) {
              panel.classList.add('hidden');
            });
        }

        function hideDispatchDetails() {
          if (!dispatchDetailContainer) {
            return;
          }
          Array.prototype.slice
            .call(dispatchDetailContainer.querySelectorAll('[data-dispatch-detail]'))
            .forEach(function (panel) {
              panel.classList.add('hidden');
            });
        }

        function showDispatchForm(dispatchId) {
          if (!dispatchFormCard || !dispatchFormContainer) {
            return;
          }
          const targetPanel = dispatchFormContainer.querySelector(
            '[data-dispatch-form][data-dispatch-id="' + dispatchId + '"]'
          );
          if (!targetPanel) {
            return;
          }
          if (dispatchDetailCard) {
            dispatchDetailCard.classList.add('hidden');
          }
          hideDispatchDetails();
          hideDispatchForms();
          dispatchFormCard.classList.remove('hidden');
          targetPanel.classList.remove('hidden');
          focusDispatchCard(dispatchFormCard);
          updateDispatchPanelTotals(targetPanel);
        }

        function showDispatchDetail(dispatchId) {
          if (!dispatchDetailCard || !dispatchDetailContainer) {
            return;
          }
          const targetPanel = dispatchDetailContainer.querySelector(
            '[data-dispatch-detail][data-dispatch-id="' + dispatchId + '"]'
          );
          if (!targetPanel) {
            return;
          }
          if (dispatchFormCard) {
            dispatchFormCard.classList.add('hidden');
          }
          hideDispatchForms();
          hideDispatchDetails();
          dispatchDetailCard.classList.remove('hidden');
          targetPanel.classList.remove('hidden');
          updateDispatchPanelTotals(targetPanel);
          focusDispatchCard(dispatchDetailCard);
        }

        function closeDispatchCard(cardNode) {
          if (!cardNode) {
            return;
          }
          if (cardNode === dispatchFormCard) {
            hideDispatchForms();
          }
          if (cardNode === dispatchDetailCard) {
            hideDispatchDetails();
          }
          cardNode.classList.add('hidden');
          if (dispatchStageCard) {
            focusDispatchCard(dispatchStageCard);
          }
        }

        function updateDispatchPanelTotals(panel) {
          if (!panel) {
            return;
          }
          const mode = panel.getAttribute('data-dispatch-mode') || '';
          const summaryField = mode === 'create' || mode === 'edit' ? 'requested' : 'confirmed';
          const inputs = Array.prototype.slice.call(
            panel.querySelectorAll('[data-dispatch-input][data-field="' + summaryField + '"]')
          );
          let totalCartons = 0;
          let totalHens = 0;
          inputs.forEach(function (input) {
            const unit = input.getAttribute('data-unit') || 'cartons';
            const value = normalizeNumber(input.value);
            const safeValue = value !== null && value >= 0 ? value : 0;
            if (unit === 'hens') {
              totalHens += safeValue;
            } else {
              totalCartons += safeValue;
            }
          });
          const cartonNodes = Array.prototype.slice.call(panel.querySelectorAll('[data-dispatch-total-cartons]'));
          cartonNodes.forEach(function (node) {
            const kind = node.getAttribute('data-summary-kind') || summaryField;
            if (kind === summaryField) {
              node.textContent = formatNumber(totalCartons);
            }
          });
          const henNodes = Array.prototype.slice.call(panel.querySelectorAll('[data-dispatch-total-hens]'));
          henNodes.forEach(function (node) {
            const kind = node.getAttribute('data-summary-kind') || summaryField;
            if (kind === summaryField) {
              node.textContent = formatNumber(totalHens);
            }
          });
          if (mode !== 'create' && mode !== 'edit') {
            const dispatchId = panel.getAttribute('data-dispatch-id') || '';
            const detailRows = Array.prototype.slice.call(panel.querySelectorAll('[data-dispatch-detail-row]'));
            detailRows.forEach(function (row) {
              const requestedValue = normalizeNumber(row.getAttribute('data-requested'));
              const requested = requestedValue !== null && requestedValue >= 0 ? requestedValue : 0;
              const unitLabel = row.getAttribute('data-unit-label') || '';
              const unitShort = row.getAttribute('data-unit') === 'cartons' ? 'cart' : unitLabel;
              const itemType = row.getAttribute('data-item-type') || '';
              const input = row.querySelector('[data-dispatch-input][data-field="confirmed"]');
              const confirmedValue = input ? normalizeNumber(input.value) : null;
              const confirmed = confirmedValue !== null && confirmedValue >= 0 ? confirmedValue : 0;
              const diff = requested - confirmed;
              const differenceNode = row.querySelector('[data-dispatch-difference]');
              if (differenceNode) {
                differenceNode.classList.remove('hidden');
                allDifferenceThemeClasses.forEach(function (cls) {
                  differenceNode.classList.remove(cls);
                });
                let themeKey = 'neutral';
                let textContent = 'OK';
                if (diff > 0) {
                  themeKey = 'positive';
                  textContent = '- ' + formatNumber(diff) + ' ' + unitShort;
                } else if (diff < 0) {
                  themeKey = 'negative';
                  textContent = '+ ' + formatNumber(Math.abs(diff)) + ' ' + unitShort;
                }
                const classes = differenceThemeClasses[themeKey] || differenceThemeClasses.neutral;
                classes.forEach(function (cls) {
                  differenceNode.classList.add(cls);
                });
                differenceNode.textContent = textContent;
              }
              if (dispatchId && itemType) {
                const stageItem = document.querySelector(
                  '[data-dispatch-item][data-dispatch-id="' + dispatchId + '"][data-item-type="' + itemType + '"]'
                );
                if (stageItem) {
                  const confirmedNode = stageItem.querySelector('[data-dispatch-item-confirmed]');
                  if (confirmedNode) {
                    confirmedNode.textContent = formatNumber(confirmed);
                  }
                  const stageDifferenceNode = stageItem.querySelector('[data-dispatch-item-difference]');
                  if (stageDifferenceNode) {
                    allDifferenceThemeClasses.forEach(function (cls) {
                      stageDifferenceNode.classList.remove(cls);
                    });
                    if (diff === 0) {
                      stageDifferenceNode.classList.add('hidden');
                      stageDifferenceNode.textContent = '';
                    } else {
                      stageDifferenceNode.classList.remove('hidden');
                      const stageTheme = diff > 0 ? 'positive' : 'negative';
                      const stageClasses = differenceThemeClasses[stageTheme] || differenceThemeClasses.neutral;
                      stageClasses.forEach(function (cls) {
                        stageDifferenceNode.classList.add(cls);
                      });
                      stageDifferenceNode.textContent =
                        (diff > 0 ? '- ' : '+ ') + formatNumber(Math.abs(diff)) + ' ' + unitShort;
                    }
                  }
                }
              }
            });
            if (dispatchId) {
              const summaryCartonsNode = document.querySelector(
                '[data-dispatch-summary-cartons][data-dispatch-id="' + dispatchId + '"]'
              );
              if (summaryCartonsNode) {
                summaryCartonsNode.textContent = formatNumber(totalCartons);
              }
              const summaryHensNode = document.querySelector(
                '[data-dispatch-summary-hens][data-dispatch-id="' + dispatchId + '"]'
              );
              if (summaryHensNode) {
                summaryHensNode.textContent = formatNumber(totalHens);
              }
            }
          }
        }

        function updateAllDispatchTotals() {
          dispatchFormPanels.forEach(function (panel) {
            updateDispatchPanelTotals(panel);
          });
          dispatchDetailPanels.forEach(function (panel) {
            updateDispatchPanelTotals(panel);
          });
        }

        function applyDispatchStatusVisuals(dispatchId, statusId) {
          if (!dispatchId) {
            return;
          }
          const statusData = dispatchStatusMap[statusId] || null;
          const statusLabel =
            statusData && statusData.label ? statusData.label : statusId ? statusId.toUpperCase() : '‚Äî';
          const theme = statusData && statusData.theme ? statusData.theme : 'slate';
          const themeClasses = statusThemeClasses[theme] || statusThemeClasses.slate;
          const chips = Array.prototype.slice.call(
            document.querySelectorAll('[data-dispatch-status-chip][data-dispatch-id="' + dispatchId + '"]')
          );
          chips.forEach(function (chip) {
            allStatusThemeClasses.forEach(function (cls) {
              chip.classList.remove(cls);
            });
            themeClasses.forEach(function (cls) {
              chip.classList.add(cls);
            });
            chip.textContent = statusLabel;
            chip.setAttribute('data-dispatch-status', statusId);
          });
          const listRow = document.querySelector('[data-dispatch-row][data-dispatch-id="' + dispatchId + '"]');
          if (listRow) {
            listRow.setAttribute('data-dispatch-status', statusId);
          }
          const detailPanel = document.querySelector('[data-dispatch-detail][data-dispatch-id="' + dispatchId + '"]');
          if (detailPanel) {
            detailPanel.setAttribute('data-dispatch-status', statusId);
          }
        }

        function showTransportSuccess(message) {
          if (!transportSuccessNode) {
            return;
          }
          if (transportFeedbackNode) {
            transportFeedbackNode.classList.add('hidden');
            transportFeedbackNode.textContent = '';
          }
          transportSuccessNode.classList.remove('hidden');
          if (transportSuccessText) {
            transportSuccessText.textContent = message;
          }
        }

        function getSelectedTransportProductions() {
          return transportProductionInputs.filter(function (input) {
            return !input.disabled && input.checked;
          });
        }

        function computeTransportTotals() {
          const selected = getSelectedTransportProductions();
          let totalCartons = 0;
          const productions = selected.map(function (input) {
            const rawCartons = normalizeNumber(input.getAttribute('data-cartons'));
            const cartons = Number.isFinite(rawCartons) && rawCartons > 0 ? rawCartons : 0;
            if (cartons > 0) {
              totalCartons += cartons;
            }
            return {
              id: input.value,
              label: input.getAttribute('data-production-label') || input.value,
              cartons: cartons,
              productionDate: input.getAttribute('data-production-date') || null,
              productionDateLabel: input.getAttribute('data-production-date-label') || null,
            };
          });
          return { inputs: selected, productions: productions, totalCartons: totalCartons };
        }

        function updateTransportSelectionSummary() {
          if (!transportSelectionSummary) {
            return;
          }
          const totals = computeTransportTotals();
          if (totals.productions.length) {
            const productionLabel =
              totals.productions.length === 1
                ? '1 producci√≥n'
                : totals.productions.length + ' producciones';
            const cartonLabel = formatNumber(Math.max(totals.totalCartons, 0)) + ' cartones';
            transportSelectionSummary.textContent = 'Seleccionados: ' + productionLabel + ' ¬∑ ' + cartonLabel;
            transportSelectionSummary.classList.remove('text-rose-600');
          }
          if (transportAuthorizeButton) {
            const transporterReady = transporterField && transporterField.value;
            const hasDate = expectedDateField && expectedDateField.value;
            transportAuthorizeButton.disabled = !(totals.productions.length && transporterReady && hasDate);
          }
        }

        function renderList(node, lines, options) {
          if (!node) {
            return;
          }
          const normalizedLines = Array.isArray(lines)
            ? lines
                .map(function (line) {
                  return line === null || line === undefined ? '' : String(line);
                })
                .filter(function (line) {
                  return line.trim() !== '';
                })
            : [];
          node.innerHTML = '';
          if (normalizedLines.length) {
            normalizedLines.forEach(function (line) {
              const li = document.createElement('li');
              li.textContent = line;
              node.appendChild(li);
            });
            return;
          }
          if (options && options.emptyMessage) {
            const li = document.createElement('li');
            if (options.emptyClass) {
              li.className = options.emptyClass;
            }
            li.textContent = options.emptyMessage;
            node.appendChild(li);
          }
        }

        function getStageDefinition(stageId) {
          if (!stageId) {
            return null;
          }
          return Object.prototype.hasOwnProperty.call(eggStageDefinitions, stageId)
            ? eggStageDefinitions[stageId]
            : null;
        }

        function updateTransportStatusLabel(stageId) {
          if (stageId !== 'transport') {
            return;
          }
          const card = getStageCard(stageId);
          if (!card) {
            return;
          }
          const statusNode = card.querySelector('[data-egg-stage-status]');
          if (!statusNode) {
            return;
          }
          const state = ensureStageState(stageId);
          const progress = state.data && state.data.progress ? state.data.progress : null;
          const stepIndex = progress && typeof progress.stepIndex === 'number' ? progress.stepIndex : -1;
          const definition = getStageDefinition(stageId);
          const steps = definition && Array.isArray(definition.progress_steps) ? definition.progress_steps : [];
          if (stepIndex >= 0 && steps[stepIndex]) {
            statusNode.textContent = 'Estado actual: ' + steps[stepIndex].label;
          } else {
            statusNode.textContent = 'Selecciona el estado actual del transporte.';
          }
        }

        function updateTransportButtons(stageId) {
          if (stageId !== 'transport') {
            return;
          }
          const containerEntry = stageProgressContainers[stageId];
          if (!containerEntry || !Array.isArray(containerEntry.buttons)) {
            return;
          }
          const state = ensureStageState(stageId);
          const progress = state.data && state.data.progress ? state.data.progress : null;
          const activeIndex = progress && typeof progress.stepIndex === 'number' ? progress.stepIndex : -1;
          containerEntry.buttons.forEach(function (button, index) {
            button.classList.remove(
              'bg-brand',
              'text-slate-900',
              'border-brand',
              'bg-emerald-500',
              'text-white',
              'border-emerald-500',
              'opacity-60'
            );
            button.classList.add('border-slate-200', 'text-slate-600');
            if (index === activeIndex) {
              button.classList.remove('border-slate-200', 'text-slate-600');
              button.classList.add('bg-brand', 'text-slate-900', 'border-brand');
              button.setAttribute('aria-pressed', 'true');
            } else if (index < activeIndex) {
              button.classList.remove('border-slate-200', 'text-slate-600');
              button.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
              button.setAttribute('aria-pressed', 'false');
            } else {
              button.setAttribute('aria-pressed', 'false');
            }
          });
        }

        function setTransportProgress(stageId, stepIndex, stepId) {
          const state = ensureStageState(stageId);
          state.data = state.data || {};
          const card = getStageCard(stageId);
          const definition = getStageDefinition(stageId);
          const steps = definition && Array.isArray(definition.progress_steps) ? definition.progress_steps : [];
          if (!steps.length) {
            state.data.progress = { stepIndex: -1, stepId: null };
            markStageSaved(stageId);
            updateTransportButtons(stageId);
            updateTransportStatusLabel(stageId);
            return;
          }
          const clampedIndex = Math.max(0, Math.min(stepIndex, steps.length - 1));
          const targetStep = steps[clampedIndex] || null;
          state.data.progress = {
            stepIndex: clampedIndex,
            stepId: stepId || (targetStep ? targetStep.id : null),
          };

          if (steps.length && clampedIndex === steps.length - 1) {
            markStageCompleted(stageId);
          } else {
            markStageSaved(stageId);
          }

          updateTransportButtons(stageId);
          updateTransportStatusLabel(stageId);

          const progressUrl = card ? card.getAttribute('data-egg-stage-progress-url') || '' : '';
          if (progressUrl && state.data.progress && state.data.progress.stepId && csrfToken) {
            fetch(progressUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
              },
              body: JSON.stringify({ step: state.data.progress.stepId }),
            }).catch(function (error) {
              console.info('No se pudo actualizar el estado del transporte:', error);
            });
          }

          if (telegram && typeof telegram.sendData === 'function') {
            try {
              telegram.sendData(
                JSON.stringify({
                  action: 'egg-stage-progress',
                  stage: stageId,
                  step: state.data.progress.stepId,
                  step_index: state.data.progress.stepIndex,
                  label: targetStep ? targetStep.label : null,
                })
              );
            } catch (error) {
              console.info('No se pudo enviar el progreso de transporte a Telegram:', error);
            }
          } else {
            console.info('Progreso transporte:', stageId, state.data.progress);
          }
        }

        function getStageCard(stageId) {
          if (!stageId) {
            return null;
          }
          return document.querySelector('[data-egg-stage-card][data-egg-stage="' + stageId + '"]');
        }

        function clearStageHighlight() {
          if (typeof window !== 'undefined' && stageHighlightResetTimer) {
            window.clearTimeout(stageHighlightResetTimer);
          }
          stageHighlightResetTimer = null;
          if (!highlightedStageId) {
            return;
          }
          const previousCard = getStageCard(highlightedStageId);
          if (previousCard) {
            previousCard.classList.remove('ring-2', 'ring-offset-2', 'ring-amber-300', 'shadow-amber-200/70');
          }
          highlightedStageId = null;
        }

        function focusStageCard(stageId, options) {
          if (!stageId) {
            return;
          }
          const card = getStageCard(stageId);
          if (!card) {
            return;
          }

          clearStageHighlight();
          card.classList.add('ring-2', 'ring-offset-2', 'ring-amber-300', 'shadow-amber-200/70');
          highlightedStageId = stageId;

          if (!options || options.scroll !== false) {
            try {
              card.scrollIntoView({
                behavior: (options && options.scrollBehavior) || 'smooth',
                block: (options && options.scrollBlock) || 'start',
              });
            } catch (error) {
              card.scrollIntoView(true);
            }
          }

          if (options && options.focusFirstInput) {
            const focusTarget =
              card.querySelector('[data-classification-input]') || card.querySelector('input, textarea, select');
            if (focusTarget && typeof focusTarget.focus === 'function') {
              try {
                focusTarget.focus({ preventScroll: true });
              } catch (focusError) {
                focusTarget.focus();
              }
            }
          }

          if (typeof window !== 'undefined' && stageHighlightResetTimer) {
            window.clearTimeout(stageHighlightResetTimer);
          }
          const persistMs = options && typeof options.persist === 'number' ? options.persist : 2800;
          if (typeof window !== 'undefined') {
            stageHighlightResetTimer = window.setTimeout(function () {
              if (highlightedStageId === stageId) {
                clearStageHighlight();
              }
            }, persistMs);
          }
        }

        function ensureStageState(stageId) {
          if (!stageId) {
            return { data: {}, status: 'pending', completed: false };
          }
          if (!Object.prototype.hasOwnProperty.call(eggStageState, stageId)) {
            let defaultData;
            if (stageId === 'classification') {
              defaultData = { categories: {}, totals: { cartons: 0, eggs: 0 } };
            } else if (stageId === 'inspection') {
              defaultData = { categories: {}, totals: { sellable: 0, discarded: 0, expected_sellable: 0 } };
            } else if (stageId === 'transport') {
              defaultData = { progress: { stepIndex: -1, stepId: null } };
            } else {
              defaultData = {};
            }
            eggStageState[stageId] = {
              data: defaultData,
              status: 'pending',
              completed: false,
            };
          } else {
            const current = eggStageState[stageId];
            if (stageId === 'classification') {
              current.data = current.data || { categories: {}, totals: { cartons: 0, eggs: 0 } };
              current.data.categories = current.data.categories || {};
              current.data.totals = current.data.totals || { cartons: 0, eggs: 0 };
            } else if (stageId === 'inspection') {
              current.data = current.data || { categories: {}, totals: { sellable: 0, discarded: 0, expected_sellable: 0 } };
              current.data.categories = current.data.categories || {};
              current.data.totals = current.data.totals || { sellable: 0, discarded: 0, expected_sellable: 0 };
              if (typeof current.data.totals.sellable !== 'number') {
                current.data.totals.sellable = 0;
              }
              if (typeof current.data.totals.discarded !== 'number') {
                current.data.totals.discarded = 0;
              }
              if (typeof current.data.totals.expected_sellable !== 'number') {
                current.data.totals.expected_sellable = inspectionExpectedCartons || 0;
              }
            } else if (stageId === 'transport') {
              current.data = current.data || {};
              if (!current.data.progress) {
                current.data.progress = { stepIndex: -1, stepId: null };
              } else {
                if (typeof current.data.progress.stepIndex !== 'number') {
                  current.data.progress.stepIndex = -1;
                }
                if (!current.data.progress.hasOwnProperty('stepId')) {
                  current.data.progress.stepId = null;
                }
              }
            } else {
              current.data = current.data || {};
            }
            if (!current.status) {
              current.status = 'pending';
            }
            if (typeof current.completed !== 'boolean') {
              current.completed = false;
            }
          }
          return eggStageState[stageId];
        }

        function setStageVisualStatus(stageId, status) {
          const card = getStageCard(stageId);
          if (!card) {
            return;
          }
          const chip = card.querySelector('[data-egg-stage-chip]');
          const statusNode = card.querySelector('[data-egg-stage-status]');
          const banner = card.querySelector('[data-egg-stage-complete-banner]');
          const completeButton = card.querySelector('[data-egg-stage-complete]');

          if (status === 'completed') {
            if (chip) {
              chip.textContent = 'Lista';
            }
            if (statusNode) {
              statusNode.textContent = 'Etapa completada';
            }
            if (banner) {
              banner.classList.remove('hidden');
            }
            if (completeButton) {
              if (!completeButton.dataset.defaultLabel) {
                completeButton.dataset.defaultLabel = completeButton.textContent.trim();
              }
              completeButton.disabled = true;
              completeButton.classList.remove('bg-brand', 'hover:bg-brand-dark', 'text-slate-900');
              completeButton.classList.add('bg-emerald-500', 'text-white', 'hover:bg-emerald-600');
              completeButton.innerHTML = '<span aria-hidden="true">‚úÖ</span><span>Completada</span>';
            }
          } else {
            if (banner) {
              banner.classList.add('hidden');
            }
            if (statusNode) {
              statusNode.textContent = status === 'saved' ? 'Cambios guardados' : 'Esperando registro';
            }
            if (chip) {
              chip.textContent = status === 'saved' ? 'Guardada' : 'Pendiente';
            }
            if (completeButton) {
              const defaultLabel = completeButton.dataset.defaultLabel || 'Guardar';
              completeButton.disabled = false;
              completeButton.classList.remove('bg-emerald-500', 'text-white', 'hover:bg-emerald-600');
              completeButton.classList.add('bg-brand', 'text-slate-900', 'hover:bg-brand-dark');
              completeButton.textContent = defaultLabel;
            }
          }
        }

        function markStagePending(stageId) {
          const state = ensureStageState(stageId);
          state.status = 'pending';
          state.completed = false;
          setStageVisualStatus(stageId, 'pending');
          if (stageId === 'transport') {
            updateTransportButtons(stageId);
            updateTransportStatusLabel(stageId);
          }
        }

        function markStageSaved(stageId) {
          const state = ensureStageState(stageId);
          state.status = 'saved';
          state.completed = false;
          setStageVisualStatus(stageId, 'saved');
          if (stageId === 'transport') {
            updateTransportButtons(stageId);
            updateTransportStatusLabel(stageId);
          }
        }

        function markStageCompleted(stageId) {
          const state = ensureStageState(stageId);
          state.status = 'completed';
          state.completed = true;
          setStageVisualStatus(stageId, 'completed');
          if (stageId === 'transport') {
            updateTransportButtons(stageId);
            updateTransportStatusLabel(stageId);
          }
        }

        function buildStagePayload(stageId) {
          const state = ensureStageState(stageId);
          if (stageId === 'classification') {
            updateClassificationValues();
            return {
              categories: Object.assign({}, state.data.categories || {}),
              totals: Object.assign({}, state.data.totals || {}),
              expected_cartons: classificationExpectedCartons,
              expected_eggs: classificationExpectedEggs,
            };
          }

          const data = {};
          const card = getStageCard(stageId);
          const inputs = card ? Array.prototype.slice.call(card.querySelectorAll('[data-egg-stage-input]')) : [];
          inputs.forEach(function (input) {
            const field = input.getAttribute('data-field');
            if (!field) {
              return;
            }
            data[field] = input.value || '';
          });
          if (stageId === 'inspection') {
            updateInspectionValues();
            const categoryInputs = card
              ? Array.prototype.slice.call(card.querySelectorAll('[data-inspection-caliber-input]'))
              : [];
            const categories = {};
            let sellableTotal = 0;
            let discardedTotal = 0;
            categoryInputs.forEach(function (input) {
              const categoryId = input.getAttribute('data-category');
              const kind = input.getAttribute('data-kind') || 'sellable';
              const value = normalizeNumber(input.value);
              const cartonsValue = value !== null && value >= 0 ? value : 0;
              if (categoryId) {
                categories[categoryId] = cartonsValue;
              }
              if (kind === 'discard') {
                discardedTotal += cartonsValue;
              } else {
                sellableTotal += cartonsValue;
              }
            });
            data.categories = categories;
            data.totals = {
              sellable: sellableTotal,
              discarded: discardedTotal,
              expected_sellable: inspectionExpectedCartons,
            };
          }
          state.data = data;
          return data;
        }

        function updateClassificationValues() {
          if (!classificationPanel) {
            return;
          }
          const state = ensureStageState('classification');
          const categories = state.data.categories || {};
          let totalCartons = 0;
          let totalEggs = 0;

          classificationRows.forEach(function (row) {
            const categoryId = row.getAttribute('data-category-id');
            const input = row.querySelector('[data-classification-input]');
            const eggsNode = row.querySelector('[data-classification-eggs]');
            const eggsPerCarton = Number(row.getAttribute('data-eggs-per-carton')) || classificationEggsPerCarton || 0;
            const rawValue = input ? normalizeNumber(input.value) : null;
            const cartonsValue = rawValue !== null && rawValue >= 0 ? rawValue : 0;
            totalCartons += cartonsValue;
            const eggsValue = cartonsValue * eggsPerCarton;
            totalEggs += eggsValue;
            if (categoryId) {
              categories[categoryId] = cartonsValue;
            }
            if (eggsNode) {
              eggsNode.textContent = formatNumber(eggsValue) + ' huevos';
            }
          });

          state.data.categories = categories;
          state.data.totals = { cartons: totalCartons, eggs: totalEggs };

          if (classificationSummaryNode) {
            classificationSummaryNode.classList.remove('text-rose-600', 'text-emerald-700');
            classificationSummaryNode.textContent =
              'Totales registrados: ' +
              formatNumber(totalCartons) +
              ' cartones (' +
              formatNumber(totalEggs) +
              ' huevos)';
          }

          if (classificationFeedbackNode) {
            classificationFeedbackNode.classList.remove('text-rose-600', 'text-emerald-700', 'text-emerald-600');
            if (classificationExpectedCartons > 0) {
              if (totalCartons === classificationExpectedCartons) {
                classificationFeedbackNode.textContent = 'Totales equilibrados. Contin√∫a con la inspecci√≥n.';
                classificationFeedbackNode.classList.add('text-emerald-700');
                if (classificationSummaryNode) {
                  classificationSummaryNode.classList.add('text-emerald-700');
                }
              } else {
                const diff = totalCartons - classificationExpectedCartons;
                if (diff > 0) {
                  classificationFeedbackNode.textContent =
                    'Hay +' +
                    formatNumber(diff) +
                    ' cartones sobre lo esperado. Ajusta la clasificaci√≥n o registra el excedente.';
                } else {
                  classificationFeedbackNode.textContent =
                    'Faltan ' +
                    formatNumber(Math.abs(diff)) +
                    ' cartones para igualar el lote.';
                }
                classificationFeedbackNode.classList.add('text-rose-600');
                if (classificationSummaryNode) {
                  classificationSummaryNode.classList.add('text-rose-600');
                }
              }
            } else {
              classificationFeedbackNode.textContent =
                'Si hay diferencia, revisa los descartes o ajusta el transporte antes de liberar el lote.';
              classificationFeedbackNode.classList.add('text-emerald-600');
            }
          }
        }

        function updateInspectionValues() {
          if (!inspectionSummaryNode) {
            return;
          }

          let sellableTotal = 0;
          let discardedTotal = 0;

          inspectionInputs.forEach(function (input) {
            const kind = input.getAttribute('data-kind') || 'sellable';
            const value = normalizeNumber(input.value);
            const cartonsValue = value !== null && value >= 0 ? value : 0;
            if (kind === 'discard') {
              discardedTotal += cartonsValue;
            } else {
              sellableTotal += cartonsValue;
            }
          });

          if (inspectionSummaryTotalNode) {
            inspectionSummaryTotalNode.textContent =
              'Aptos confirmados: ' + formatNumber(sellableTotal) + ' cartones';
          }
          if (inspectionSummaryDiscardNode) {
            inspectionSummaryDiscardNode.textContent =
              'No aptos confirmados: ' + formatNumber(discardedTotal) + ' cartones';
          }
          if (inspectionSummaryFeedbackNode) {
            inspectionSummaryFeedbackNode.classList.remove('text-emerald-600', 'text-rose-600', 'text-amber-600');
            if (inspectionExpectedCartons > 0) {
              const diff = sellableTotal - inspectionExpectedCartons;
              if (diff === 0) {
                inspectionSummaryFeedbackNode.textContent = 'Totales alineados, listo para guardar.';
                inspectionSummaryFeedbackNode.classList.add('text-emerald-600');
              } else if (diff < 0) {
                inspectionSummaryFeedbackNode.textContent =
                  'Faltan ' + formatNumber(Math.abs(diff)) + ' cartones para igualar lo esperado.';
                inspectionSummaryFeedbackNode.classList.add('text-rose-600');
              } else {
                inspectionSummaryFeedbackNode.textContent =
                  'Hay ' + formatNumber(diff) + ' cartones adicionales. Confirma antes de guardar.';
                inspectionSummaryFeedbackNode.classList.add('text-amber-600');
              }
            } else {
              inspectionSummaryFeedbackNode.textContent =
                'Ingresa los totales por tipo para validar la disponibilidad.';
            }
          }
        }

      if (weightCard) {
        const weightLocationList = weightCard.querySelector('[data-weight-location-list]');
        const weightSelectedCounter = weightCard.querySelector('[data-weight-selected-counter]');
        const weightSelectionHint = weightCard.querySelector('[data-weight-selection-hint]');
        const weightIdleActions = weightCard.querySelector('[data-weight-idle-actions]');
        const weightStartButton = weightCard.querySelector('[data-weight-start]');
        const weightResumeButton = weightCard.querySelector('[data-weight-resume]');
        const weightPanel = weightCard.querySelector('[data-weight-panel]');
        const weightInput = weightCard.querySelector('[data-weight-input]');
        const weightAddButton = weightCard.querySelector('[data-weight-add]');
        const weightList = weightCard.querySelector('[data-weight-list]');
        const weightEmptyState = weightCard.querySelector('[data-weight-empty-state]');
        const weightSummary = weightCard.querySelector('[data-weight-summary]');
        const weightSampleWarning = weightCard.querySelector('[data-weight-sample-warning]');
        const weightAverageNode = weightCard.querySelector('[data-weight-average]');
        const weightUniformityNode = weightCard.querySelector('[data-weight-uniformity]');
        const weightVarianceNode = weightCard.querySelector('[data-weight-variance]');
        const weightRangeNode = weightCard.querySelector('[data-weight-range]');
        const weightTotalCountNode = weightCard.querySelector('[data-weight-total-count]');
        const weightActiveSalonsNode = weightCard.querySelector('[data-weight-active-salons]');
        const weightPauseButton = weightCard.querySelector('[data-weight-pause]');
        const weightFinishButton = weightCard.querySelector('[data-weight-finish]');
        const weightResetButton = weightCard.querySelector('[data-weight-reset]');
        const weightCopyButton = weightCard.querySelector('[data-weight-copy]');
        const weightStatusNode = weightCard.querySelector('[data-weight-status]');
        const weightCountNode = weightCard.querySelector('[data-weight-count]');
        const weightUnitLabel = weightCard.getAttribute('data-weight-unit') || 'g';
        const weightTolerancePercent = Number(weightCard.getAttribute('data-weight-tolerance')) || 10;
        const weightMinimumSample = Number(weightCard.getAttribute('data-weight-minimum')) || 30;
        const weightSelectedCounterDefault =
          weightSelectedCounter && weightSelectedCounter.textContent
            ? weightSelectedCounter.textContent
            : 'Sin sal√≥n activo';
        const weightStatusColorClasses = ['text-slate-400', 'text-emerald-600', 'text-amber-600', 'text-rose-600'];
        const weightActiveButtonClasses = [
          'border-emerald-500',
          'bg-emerald-50',
          'text-emerald-900',
          'shadow-emerald-200/80',
          'ring-1',
          'ring-emerald-200/70',
        ];
        const weightProgressButtonClasses = [
          'border-emerald-400',
          'bg-emerald-50/60',
          'text-emerald-800',
          'shadow-emerald-100/60',
        ];
        let isWeightPanelOpen = false;
        let weightLastMetrics = null;
        let weightStatusLockUntil = 0;

        function toSlug(value) {
          if (!value) {
            return 'anon';
          }
          return String(value)
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        }

        const weightStorageKey =
          'tm-weight-registry-v1:' +
          toSlug(
            (payload &&
              payload.user &&
              (payload.user.contact_handle || payload.user.display_name)) ||
              'anon'
          );

        const canUseLocalStorage = (function () {
          try {
            if (typeof window === 'undefined' || !window.localStorage) {
              return false;
            }
            const testKey = '__tm_weight_test__';
            window.localStorage.setItem(testKey, '1');
            window.localStorage.removeItem(testKey);
            return true;
          } catch (error) {
            return false;
          }
        })();

        const weightState = {
          activeSalonId: null,
          sessionOrder: [],
          sessions: {},
          dirty: false,
          lastSavedAt: null,
        };

        const weightLocations = collectWeightLocations();
        const weightCardBaseClass = weightCard ? weightCard.className : '';
        const weightLocationButtons = weightLocations.locations.map(function (location) {
          return location.button;
        });

        weightLocations.locations.forEach(function (location) {
          ensureSessionForLocation(location);
        });

        let weightInitialSessions = [];
        const weightSessionsNode = document.getElementById('weight-registry-sessions');
        if (weightSessionsNode) {
          try {
            weightInitialSessions = JSON.parse(weightSessionsNode.textContent || '[]');
          } catch (error) {
            console.warn('No se pudo cargar el registro de pesos guardado en el servidor.', error);
          }
        }

        function applyWeightCardTheme(mode) {
          if (!weightCard) {
            return;
          }
          const successClasses = [
            'border-emerald-200',
            'via-emerald-50/85',
            'to-emerald-100/85',
            'shadow-emerald-100/70',
          ];
          const baseToRemove = ['border-sky-200', 'via-sky-50/80', 'to-blue-100/80', 'shadow-sky-100/70'];
          weightCard.className = weightCardBaseClass;
          baseToRemove.forEach(function (cls) {
            weightCard.classList.remove(cls);
          });
          if (mode === 'success') {
            successClasses.forEach(function (cls) {
              weightCard.classList.add(cls);
            });
          } else {
            baseToRemove.forEach(function (cls) {
              if (weightCardBaseClass.split(/\s+/).indexOf(cls) === -1) {
                return;
              }
              weightCard.classList.add(cls);
            });
          }
        }
        let serverSessionLoaded = applyServerSessions(weightInitialSessions, { persist: false });

        function extractRoomId(identifier) {
          if (!identifier) {
            return null;
          }
          const match = /^room-(\d+)$/i.exec(String(identifier));
          if (match) {
            const value = Number(match[1]);
            return Number.isFinite(value) ? value : null;
          }
          return null;
        }

        function collectWeightLocations() {
          if (!weightLocationList) {
            return { locations: [], byId: new Map() };
          }
          const buttons = Array.prototype.slice.call(
            weightLocationList.querySelectorAll('[data-weight-location]')
          );
          const locations = [];
          const byId = new Map();
          buttons.forEach(function (button) {
            const id = button.getAttribute('data-weight-location');
            if (!id) {
              return;
            }
            const birdsValue = normalizeNumber(button.getAttribute('data-weight-location-birds'));
            const roomIdValue = normalizeNumber(button.getAttribute('data-weight-location-room-id'));
            const fallbackRoomId = Number.isFinite(roomIdValue) ? roomIdValue : extractRoomId(id);
            const location = {
              id: id,
              label: button.getAttribute('data-weight-location-label') || button.textContent.trim() || id,
              room: button.getAttribute('data-weight-location-room') || '',
              barn: button.getAttribute('data-weight-location-barn') || '',
              farm: button.getAttribute('data-weight-location-farm') || '',
              birds: Number.isFinite(birdsValue) ? birdsValue : null,
              roomId: Number.isFinite(roomIdValue) ? roomIdValue : fallbackRoomId,
              button: button,
              baseClass: button.className,
              nodes: {
                meta: button.querySelector('[data-weight-location-meta]') || null,
                birdsLabel: button.querySelector('[data-weight-location-birds-label]') || null,
                progress: button.querySelector('[data-weight-location-progress]') || null,
                check: button.querySelector('[data-weight-location-check]') || null,
              },
              farmNode: button.closest('[data-weight-farm]') || null,
              barnNode: button.closest('[data-weight-barn]') || null,
            };
            locations.push(location);
            byId.set(id, location);
          });
          return {
            locations: locations,
            byId: byId,
          };
        }

        function getLocationMeta(id) {
          if (!id) {
            return null;
          }
          return weightLocations.byId.get(id) || null;
        }

        function ensureSessionForLocation(location) {
          if (!location) {
            return null;
          }
          let session = weightState.sessions[location.id];
          if (!session) {
            session = {
              id: location.id,
              label: location.label,
              farm: location.farm,
              barn: location.barn,
              room: location.room || location.label,
              birds: location.birds,
              roomId: location.roomId || null,
              entries: [],
              status: 'idle',
              createdAt: new Date().toISOString(),
              updatedAt: null,
            };
            weightState.sessions[location.id] = session;
            if (weightState.sessionOrder.indexOf(location.id) === -1) {
              weightState.sessionOrder.push(location.id);
            }
          } else {
            if (!session.roomId && location.roomId) {
              session.roomId = location.roomId;
            }
            if (!Number.isFinite(session.birds) && Number.isFinite(location.birds)) {
              session.birds = location.birds;
            }
          }
          return session;
        }

        function applyServerSessions(sessionList, options) {
          if (!Array.isArray(sessionList)) {
            return false;
          }
          let hasEntries = false;
          sessionList.forEach(function (sessionData) {
            if (!sessionData || !sessionData.id) {
              return;
            }
            const roomIdFromSession = normalizeNumber(sessionData.room_id || sessionData.roomId);
            const roomIdFromIdentifier = extractRoomId(sessionData.id);
            const location =
              getLocationMeta(sessionData.id) ||
              {
                id: sessionData.id,
                label: sessionData.label || sessionData.id,
                farm: sessionData.farm || '',
                barn: sessionData.barn || '',
                room: sessionData.room || sessionData.label || sessionData.id,
                birds: Number.isFinite(sessionData.birds) ? sessionData.birds : null,
                roomId: Number.isFinite(roomIdFromSession)
                  ? roomIdFromSession
                  : Number.isFinite(roomIdFromIdentifier)
                  ? roomIdFromIdentifier
                  : null,
              };
            const session = ensureSessionForLocation(location);
            if (Number.isFinite(roomIdFromSession) && !session.roomId) {
              session.roomId = roomIdFromSession;
            } else if (!session.roomId && Number.isFinite(roomIdFromIdentifier)) {
              session.roomId = roomIdFromIdentifier;
            }
            if (Number.isFinite(sessionData.birds)) {
              session.birds = sessionData.birds;
            }
            const entriesRaw = Array.isArray(sessionData.entries)
              ? sessionData.entries
              : Array.isArray(sessionData.entries_grams)
              ? sessionData.entries_grams
              : [];
            session.entries = entriesRaw
              .filter(function (value) {
                return Number.isFinite(Number(value)) && Number(value) > 0;
              })
              .map(function (value) {
                return {
                  id: createEntryId(),
                  grams: Number(value),
                  createdAt: sessionData.created_at || session.createdAt || null,
                  updatedAt: sessionData.updated_at || sessionData.submitted_at || null,
                };
              });
            session.status = session.entries.length ? 'paused' : 'idle';
            session.createdAt = sessionData.created_at || session.createdAt;
            session.updatedAt = sessionData.updated_at || sessionData.submitted_at || session.updatedAt;
            hasEntries = hasEntries || session.entries.length > 0;
          });
          if (!weightState.activeSalonId) {
            const firstWithEntries = getSessionsWithEntries()[0];
            if (firstWithEntries) {
              weightState.activeSalonId = firstWithEntries.id;
            }
          }
          if (!options || options.persist !== false) {
            weightState.dirty = false;
          }
          return hasEntries;
        }

        function getActiveSession() {
          if (!weightState.activeSalonId) {
            return null;
          }
          return weightState.sessions[weightState.activeSalonId] || null;
        }

        function getSessionEntries(session) {
          const target = session || getActiveSession();
          if (!target || !Array.isArray(target.entries)) {
            return [];
          }
          return target.entries;
        }

        function getSessionsWithEntries() {
          return getAllSessions().filter(sessionHasEntries);
        }

        function getAllSessions() {
          return weightState.sessionOrder
            .map(function (id) {
              return weightState.sessions[id];
            })
            .filter(function (session) {
              return !!session;
            });
        }

        function sessionHasEntries(session) {
          return !!(session && Array.isArray(session.entries) && session.entries.length > 0);
        }

        function getTotalEntriesAcrossSessions() {
          return getSessionsWithEntries().reduce(function (accumulator, session) {
            return accumulator + session.entries.length;
          }, 0);
        }

        function formatSessionPath(session) {
          if (!session) {
            return '';
          }
          const parts = [];
          if (session.farm) {
            parts.push(session.farm);
          }
          if (session.barn) {
            parts.push(session.barn);
          }
          if (session.room) {
            parts.push(session.room);
          }
          if (parts.length) {
            return parts.join(' ¬∑ ');
          }
          return session.label || session.id;
        }

        function markActiveSessionPaused() {
          const current = getActiveSession();
          if (!current) {
            return;
          }
          if (current.entries.length > 0) {
            current.status = 'paused';
            current.updatedAt = new Date().toISOString();
          } else {
            current.status = 'idle';
          }
        }

        function setActiveSalon(id, options) {
          if (!id) {
            return;
          }
          if (weightState.activeSalonId && weightState.activeSalonId !== id) {
            markActiveSessionPaused();
          }
          const location = getLocationMeta(id);
          if (!location) {
            setStatus('No encontramos el sal√≥n seleccionado', 'error', { sticky: true });
            return;
          }
          const session = ensureSessionForLocation(location);
          weightState.activeSalonId = id;
          if (session.status === 'idle' && session.entries.length > 0) {
            session.status = 'paused';
          }
          updateActiveSalonsLabel();
          updateLocationButtons();
          updateLocationSummaries();
          updateSelectedCounter();
          updateStartButtonState();
          updateSelectionHint();
          if (isWeightPanelOpen && (!options || options.openPanel !== false)) {
            renderWeightEntries();
          } else if (!isWeightPanelOpen) {
            renderWeightEntries();
          }
          autoPersistState({ silent: true });
          if (options && options.openPanel !== false) {
            openWeightPanel({ focus: options && options.focus !== false });
          }
          if (!options || options.feedback !== false) {
            const roomLabel = session.room || session.label || 'Sal√≥n seleccionado';
            setStatus(roomLabel + ' listo para captura', 'info');
          }
        }

        function round(value, decimals) {
          if (!Number.isFinite(value)) {
            return null;
          }
          if (!decimals || decimals <= 0) {
            return Math.round(value);
          }
          const factor = Math.pow(10, decimals);
          return Math.round(value * factor) / factor;
        }

        function formatKgPlain(value) {
          if (!Number.isFinite(value)) {
            return '‚Äî';
          }
          if (weightFormatter) {
            return weightFormatter.format(value);
          }
          return value.toFixed(2);
        }

        function formatKg(value) {
          if (!Number.isFinite(value)) {
            return '‚Äî';
          }
          return formatKgPlain(value) + ' kg';
        }

        function formatKgLabel(grams) {
          return formatKg(grams / 1000);
        }

        function formatVariance(gramsSquared) {
          if (!Number.isFinite(gramsSquared)) {
            return '‚Äî';
          }
          const varianceKg = gramsSquared / 1000000;
          if (weightFormatter) {
            return weightFormatter.format(varianceKg) + ' kg¬≤';
          }
          return varianceKg.toFixed(3) + ' kg¬≤';
        }

        function formatRange(minGrams, maxGrams) {
          if (!Number.isFinite(minGrams) || !Number.isFinite(maxGrams)) {
            return '‚Äî';
          }
          return formatKg(minGrams / 1000) + ' ‚Äì ' + formatKg(maxGrams / 1000);
        }

        function formatCount(value) {
          if (!Number.isFinite(value)) {
            return '0';
          }
          if (integerFormatter) {
            return integerFormatter.format(value);
          }
          return String(Math.round(value));
        }

        function formatBirdCount(value) {
          const label = formatCount(value);
          return value === 1 ? label + ' ave' : label + ' aves';
        }

        function parseWeightInput(rawValue) {
          if (rawValue === null || rawValue === undefined) {
            return null;
          }
          const normalized = String(rawValue).trim().replace(',', '.');
          if (!normalized) {
            return null;
          }
          const numeric = Number(normalized);
          if (!Number.isFinite(numeric) || numeric <= 0) {
            return null;
          }
          let grams = numeric;
          if (numeric < 20) {
            grams = numeric * 1000;
          }
          return round(grams, 2);
        }

        function createEntryId() {
          return 'w-' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        }

        function setStatus(message, tone, options) {
          if (!weightStatusNode) {
            return;
          }
          const opts = options || {};
          const now = Date.now();
          const isStickyRequest = !!opts.sticky;
          const force = !!opts.force;
          const activeLock = weightStatusLockUntil > now;
          if (activeLock && !isStickyRequest && !force) {
            return;
          }
          weightStatusColorClasses.forEach(function (cls) {
            weightStatusNode.classList.remove(cls);
          });
          let toneClass = 'text-slate-400';
          if (tone === 'info') {
            toneClass = 'text-emerald-600';
          } else if (tone === 'success') {
            toneClass = 'text-emerald-600';
          } else if (tone === 'warning') {
            toneClass = 'text-amber-600';
          } else if (tone === 'error') {
            toneClass = 'text-rose-600';
          }
          weightStatusNode.classList.add(toneClass);
          weightStatusNode.textContent = message;
          if (isStickyRequest) {
            const duration = Number(opts.duration) || 6000;
            weightStatusLockUntil = now + duration;
          } else if (force) {
            weightStatusLockUntil = 0;
          } else if (!activeLock) {
            weightStatusLockUntil = 0;
          }
        }

        function updateSelectedCounter() {
          if (!weightSelectedCounter) {
            return;
          }
          const activeSession = getActiveSession();
          const pausedCount = getSessionsWithEntries().filter(function (session) {
            return !activeSession || session.id !== activeSession.id;
          }).length;
          if (!activeSession) {
            if (pausedCount > 0) {
              weightSelectedCounter.textContent =
                pausedCount === 1
                  ? '1 sal√≥n en pausa'
                  : formatCount(pausedCount) + ' salones en pausa';
            } else {
              weightSelectedCounter.textContent = weightSelectedCounterDefault || 'Sin sal√≥n activo';
            }
            return;
          }
          const baseLabel = activeSession.room || activeSession.label || 'Sal√≥n activo';
          if (pausedCount > 0) {
            weightSelectedCounter.textContent =
              baseLabel + ' ¬∑ +' + formatCount(pausedCount) + (pausedCount === 1 ? ' en pausa' : ' en pausa');
          } else {
            weightSelectedCounter.textContent = baseLabel;
          }
        }

        function getActiveSalonsLabel() {
          const activeSession = getActiveSession();
          if (!activeSession) {
            return 'Selecciona un sal√≥n';
          }
          return formatSessionPath(activeSession);
        }

        function updateActiveSalonsLabel() {
          if (!weightActiveSalonsNode) {
            return;
          }
          weightActiveSalonsNode.textContent = getActiveSalonsLabel();
        }

        function updateLocationButtons() {
          weightLocations.locations.forEach(function (location) {
            const button = location.button;
            if (!button) {
              return;
            }
            const session = weightState.sessions[location.id];
            const isActive = weightState.activeSalonId === location.id;
            const hasEntries = session && Array.isArray(session.entries) && session.entries.length > 0;
            let className = location.baseClass || button.className;
            if (isActive) {
              className += ' ' + weightActiveButtonClasses.join(' ');
            } else if (hasEntries) {
              className += ' ' + weightProgressButtonClasses.join(' ');
            }
            button.className = className;
            if (location.nodes.birdsLabel && Number.isFinite(location.birds)) {
              location.nodes.birdsLabel.textContent = formatBirdCount(location.birds);
            }
          });
        }

        function updateLocationSummaries() {
          // Summaries no longer needed; function kept for compatibility.
        }

        function updateStartButtonState() {
          if (!weightStartButton) {
            return;
          }
          const hasActive = Boolean(weightState.activeSalonId);
          const hasRecordedEntries = getTotalEntriesAcrossSessions() > 0;
          weightStartButton.disabled = !hasActive || hasRecordedEntries;
          weightStartButton.classList.toggle('opacity-60', !hasActive || hasRecordedEntries);
          weightStartButton.classList.toggle('pointer-events-none', !hasActive || hasRecordedEntries);
          weightStartButton.classList.toggle('hidden', hasRecordedEntries);
        }

        function updateResumeVisibility() {
          if (!weightResumeButton) {
            return;
          }
          const shouldShow = !isWeightPanelOpen && getTotalEntriesAcrossSessions() > 0;
          weightResumeButton.classList.toggle('hidden', !shouldShow);
        }

        function updateSelectionHint() {
          if (!weightSelectionHint) {
            return;
          }
          if (isWeightPanelOpen) {
            weightSelectionHint.classList.add('hidden');
            return;
          }
          const activeSession = getActiveSession();
          const totalEntries = getTotalEntriesAcrossSessions();
          weightSelectionHint.classList.remove('hidden');
          if (!activeSession && totalEntries === 0) {
            weightSelectionHint.textContent = 'Selecciona un sal√≥n para comenzar.';
            return;
          }
          if (!activeSession && totalEntries > 0) {
            weightSelectionHint.textContent = 'Registro pausado, toca un sal√≥n para continuar.';
            return;
          }
          const activeEntries = activeSession ? activeSession.entries.length : 0;
          const pausedSessions = getSessionsWithEntries().filter(function (session) {
            return session.id !== (activeSession ? activeSession.id : null);
          }).length;
          if (activeEntries === 0) {
            weightSelectionHint.textContent =
              'Listo para iniciar muestreo en ' + (activeSession.room || activeSession.label || 'este sal√≥n') + '.';
          } else if (pausedSessions > 0) {
            weightSelectionHint.textContent = 'Tienes salones en pausa, toca uno para continuar.';
          } else {
            weightSelectionHint.textContent = 'Registro pausado, toca continuar cuando retomes.';
          }
        }

        function openWeightPanel(options) {
          if (!weightPanel) {
            return;
          }
          if (!weightState.activeSalonId) {
            setStatus('Selecciona un sal√≥n para iniciar.', 'warning');
            return;
          }
          if (!isWeightPanelOpen) {
            isWeightPanelOpen = true;
            weightPanel.classList.remove('hidden');
            if (weightIdleActions) {
              weightIdleActions.classList.add('hidden');
            }
          }
          updateActiveSalonsLabel();
          renderWeightEntries();
          updateResumeVisibility();
          updateSelectionHint();
          if (options && options.focus && weightInput) {
            setTimeout(function () {
              weightInput.focus();
            }, 30);
          }
        }

        function closeWeightPanel() {
          if (!weightPanel) {
            return;
          }
          if (!isWeightPanelOpen) {
            return;
          }
          isWeightPanelOpen = false;
          weightPanel.classList.add('hidden');
          if (weightIdleActions) {
            weightIdleActions.classList.remove('hidden');
          }
          updateResumeVisibility();
          updateSelectionHint();
        }

        function autoPersistState(options) {
          if (!canUseLocalStorage) {
            return;
          }
          try {
            const serializedSessions = weightState.sessionOrder
              .map(function (id) {
                return weightState.sessions[id];
              })
              .filter(function (session) {
                return !!session;
              })
              .map(function (session) {
                return {
                  id: session.id,
                  label: session.label,
                  farm: session.farm,
                  barn: session.barn,
                  room: session.room,
                  birds: session.birds,
                  roomId: session.roomId || null,
                  status: session.status,
                  createdAt: session.createdAt,
                  updatedAt: session.updatedAt,
                  entries: Array.isArray(session.entries)
                    ? session.entries.map(function (entry) {
                        return {
                          id: entry.id,
                          grams: entry.grams,
                          createdAt: entry.createdAt || null,
                          updatedAt: entry.updatedAt || null,
                        };
                      })
                    : [],
                };
              });
            const payloadToStore = {
              version: 2,
              activeSalonId: weightState.activeSalonId,
              sessions: serializedSessions,
              updatedAt: new Date().toISOString(),
            };
            window.localStorage.setItem(weightStorageKey, JSON.stringify(payloadToStore));
            weightState.lastSavedAt = Date.now();
            if (options && options.feedback === 'explicit') {
              weightState.dirty = false;
            setStatus('Registro guardado en el dispositivo', 'success', { sticky: true, duration: 4000 });
            }
          } catch (error) {
            console.warn('No se pudo guardar el registro de pesos.', error);
            if (options && options.feedback === 'explicit') {
            setStatus('No pudimos guardar localmente', 'error', { sticky: true, duration: 5000 });
            }
          }
          updateResumeVisibility();
        }

        function clearStoredState() {
          if (!canUseLocalStorage) {
            return;
          }
          try {
            window.localStorage.removeItem(weightStorageKey);
          } catch (error) {
            console.warn('No se pudo limpiar el registro de pesos.', error);
          }
        }

        function resetSessionState() {
          weightState.sessions = {};
          weightState.sessionOrder = [];
          weightState.activeSalonId = null;
          weightState.dirty = false;
          weightState.lastSavedAt = null;
          weightLastMetrics = null;
          weightStatusLockUntil = 0;
          weightLocations.locations.forEach(function (location) {
            ensureSessionForLocation(location);
          });
          applyWeightCardTheme('base');
        }

        function computeWeightMetrics(entries) {
          const total = Array.isArray(entries) ? entries.length : 0;
          if (!total) {
            return {
              count: 0,
              gramsAverage: null,
              varianceGrams: null,
              minGrams: null,
              maxGrams: null,
              uniformityPercent: null,
              withinTolerance: 0,
              tolerancePercent: weightTolerancePercent,
            };
          }
          let sum = 0;
          let min = entries[0].grams;
          let max = entries[0].grams;
          entries.forEach(function (entry) {
            const value = entry.grams;
            sum += value;
            if (value < min) {
              min = value;
            }
            if (value > max) {
              max = value;
            }
          });
          const average = sum / total;
          const toleranceValue = average * (weightTolerancePercent / 100);
          const lower = average - toleranceValue;
          const upper = average + toleranceValue;
          let withinTolerance = 0;
          let varianceAccumulator = 0;
          entries.forEach(function (entry) {
            const value = entry.grams;
            varianceAccumulator += Math.pow(value - average, 2);
            if (value >= lower && value <= upper) {
              withinTolerance += 1;
            }
          });
          const variance = varianceAccumulator / total;
          const uniformity = total ? (withinTolerance / total) * 100 : null;
          return {
            count: total,
            gramsAverage: average,
            varianceGrams: variance,
            minGrams: min,
            maxGrams: max,
            uniformityPercent: uniformity,
            withinTolerance: withinTolerance,
            tolerancePercent: weightTolerancePercent,
          };
        }

        function updateWeightSummary(entries) {
          if (!weightSummary) {
            return;
          }
          const sourceEntries = Array.isArray(entries) ? entries : getSessionEntries();
          weightLastMetrics = computeWeightMetrics(sourceEntries);
          if (!weightLastMetrics || !weightLastMetrics.count) {
            weightSummary.classList.add('hidden');
            if (weightSampleWarning) {
              weightSampleWarning.classList.add('hidden');
            }
            if (weightAverageNode) {
              weightAverageNode.textContent = '‚Äî';
            }
            if (weightUniformityNode) {
              weightUniformityNode.textContent = '‚Äî';
            }
            if (weightVarianceNode) {
              weightVarianceNode.textContent = '‚Äî';
            }
            if (weightRangeNode) {
              weightRangeNode.textContent = '‚Äî';
            }
            if (weightTotalCountNode) {
              weightTotalCountNode.textContent = '0 aves';
            }
            if (weightCountNode) {
              weightCountNode.textContent = '0 aves';
            }
            return;
          }
          weightSummary.classList.remove('hidden');
          if (weightCountNode) {
            weightCountNode.textContent = formatBirdCount(weightLastMetrics.count);
          }
          if (weightAverageNode) {
            weightAverageNode.textContent = formatKg(weightLastMetrics.gramsAverage / 1000);
          }
          if (weightUniformityNode) {
            weightUniformityNode.textContent = formatPercentage(weightLastMetrics.uniformityPercent);
          }
          if (weightVarianceNode) {
            weightVarianceNode.textContent = formatVariance(weightLastMetrics.varianceGrams);
          }
          if (weightRangeNode) {
            weightRangeNode.textContent = formatRange(weightLastMetrics.minGrams, weightLastMetrics.maxGrams);
          }
          if (weightTotalCountNode) {
            weightTotalCountNode.textContent = formatBirdCount(weightLastMetrics.count);
          }
          if (weightSampleWarning) {
            if (weightLastMetrics.count < weightMinimumSample) {
              weightSampleWarning.textContent =
                'Llevas ' +
                formatCount(weightLastMetrics.count) +
                ' aves de ' +
                formatCount(weightMinimumSample) +
                ' sugeridas.';
              weightSampleWarning.classList.remove('hidden');
            } else {
              weightSampleWarning.classList.add('hidden');
            }
          }
        }

        function renderWeightEntries() {
          if (!weightList || !weightEmptyState) {
            return;
          }
          const entries = getSessionEntries();
          weightList.innerHTML = '';
          if (!weightState.activeSalonId) {
            weightEmptyState.classList.remove('hidden');
            weightList.classList.add('hidden');
            updateWeightSummary([]);
            if (weightTotalCountNode) {
              weightTotalCountNode.textContent = '0 aves';
            }
            if (weightCountNode) {
              weightCountNode.textContent = '0 aves';
            }
            weightLastMetrics = null;
            updateResumeVisibility();
            updateSelectionHint();
            updateLocationButtons();
            updateLocationSummaries();
            updateSelectedCounter();
            return;
          }
          if (!entries.length) {
            weightEmptyState.classList.remove('hidden');
            weightList.classList.add('hidden');
            updateWeightSummary([]);
          } else {
            weightEmptyState.classList.add('hidden');
            entries
              .slice()
              .reverse()
              .forEach(function (entry) {
                const badge = document.createElement('div');
                badge.className =
                  'inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white px-3 py-1 text-xs font-semibold text-emerald-700 shadow-sm shadow-emerald-100/60';
                const valueButton = document.createElement('button');
                valueButton.type = 'button';
                valueButton.className =
                  'text-emerald-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-200/70';
                valueButton.setAttribute('data-weight-edit', entry.id);
                valueButton.textContent = formatKgLabel(entry.grams);
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className =
                  'inline-flex h-6 w-6 items-center justify-center rounded-full border border-transparent bg-emerald-50 text-[11px] font-bold text-emerald-600 transition hover:border-emerald-200 hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-200/70';
                removeButton.setAttribute('data-weight-remove', entry.id);
                removeButton.setAttribute('aria-label', 'Eliminar peso');
                removeButton.textContent = '√ó';
                badge.appendChild(valueButton);
                badge.appendChild(removeButton);
                weightList.appendChild(badge);
              });
            weightList.classList.remove('hidden');
            weightList.scrollTop = 0;
            updateWeightSummary(entries);
          }
          if (weightTotalCountNode) {
            weightTotalCountNode.textContent = formatBirdCount(entries.length);
          }
          if (weightCountNode) {
            weightCountNode.textContent = formatBirdCount(entries.length);
          }
          updateResumeVisibility();
          updateSelectionHint();
          updateLocationButtons();
          updateLocationSummaries();
          updateSelectedCounter();
        }

        function getWeightsClipboardPayload() {
          const entries = getSessionEntries();
          if (!entries.length) {
            return '';
          }
          return entries
            .slice()
            .reverse()
            .map(function (entry) {
              return String(Math.round(entry.grams));
            })
            .join('\n');
        }

        function copyWeightsToClipboard() {
          const clipboardPayload = getWeightsClipboardPayload();
          if (!clipboardPayload) {
            return Promise.reject(new Error('empty'));
          }
          if (
            typeof navigator !== 'undefined' &&
            navigator.clipboard &&
            typeof navigator.clipboard.writeText === 'function'
          ) {
            return navigator.clipboard.writeText(clipboardPayload);
          }
          return new Promise(function (resolve, reject) {
            let textarea = null;
            try {
              textarea = document.createElement('textarea');
              textarea.value = clipboardPayload;
              textarea.setAttribute('readonly', '');
              textarea.style.position = 'fixed';
              textarea.style.top = '-9999px';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              textarea.setSelectionRange(0, textarea.value.length);
              const didCopy = document.execCommand('copy');
              document.body.removeChild(textarea);
              if (!didCopy) {
                reject(new Error('copy-failed'));
                return;
              }
              resolve();
            } catch (error) {
              if (textarea && textarea.parentNode) {
                textarea.parentNode.removeChild(textarea);
              }
              reject(error);
            }
          });
        }

        function addWeightEntry(grams) {
          if (!Number.isFinite(grams) || grams <= 0) {
            return false;
          }
          const session = getActiveSession();
          if (!session) {
            setStatus('Selecciona un sal√≥n antes de registrar pesos', 'warning');
            return false;
          }
          const nowIso = new Date().toISOString();
          session.entries.push({
            id: createEntryId(),
            grams: grams,
            createdAt: nowIso,
          });
          session.status = 'in-progress';
          session.updatedAt = nowIso;
          if (!session.createdAt) {
            session.createdAt = nowIso;
          }
          weightState.dirty = true;
          renderWeightEntries();
          autoPersistState({ silent: true });
          return true;
        }

        function removeWeightEntry(entryId) {
          const session = getActiveSession();
          if (!session) {
            return;
          }
          const index = session.entries.findIndex(function (entry) {
            return entry.id === entryId;
          });
          if (index === -1) {
            return;
          }
          session.entries.splice(index, 1);
          session.updatedAt = new Date().toISOString();
          if (!session.entries.length) {
            session.status = 'idle';
          }
          weightState.dirty = true;
          renderWeightEntries();
          autoPersistState({ silent: true });
          setStatus('Peso eliminado', 'warning');
        }

        function editWeightEntry(entryId) {
          const session = getActiveSession();
          if (!session) {
            return;
          }
          const entry = session.entries.find(function (item) {
            return item.id === entryId;
          });
          if (!entry) {
            return;
          }
          const defaultValue = formatKgPlain(entry.grams / 1000).replace(/\s*kg$/, '');
          const updated = window.prompt('Actualiza el peso', defaultValue);
          if (updated === null) {
            return;
          }
          const parsed = parseWeightInput(updated);
          if (!Number.isFinite(parsed) || parsed <= 0) {
            setStatus('Ingresa un peso v√°lido', 'error', { sticky: true, duration: 4000 });
            return;
          }
          entry.grams = parsed;
          entry.updatedAt = new Date().toISOString();
          session.updatedAt = entry.updatedAt;
          session.status = 'in-progress';
          weightState.dirty = true;
          renderWeightEntries();
          autoPersistState({ silent: true });
          setStatus('Peso actualizado', 'info');
        }

        function loadWeightState() {
          if (!canUseLocalStorage) {
            return;
          }
          try {
            const raw = window.localStorage.getItem(weightStorageKey);
            if (!raw) {
              return;
            }
            const saved = JSON.parse(raw);
            let hasEntries = false;
            if (saved && saved.version === 2 && Array.isArray(saved.sessions)) {
              saved.sessions.forEach(function (sessionData) {
                if (!sessionData || !sessionData.id) {
                  return;
                }
            const roomIdFromSession = normalizeNumber(sessionData.roomId);
            const roomIdFallback = normalizeNumber(sessionData.room_id);
            const idRoomExtract = extractRoomId(sessionData.id);
            const location =
              getLocationMeta(sessionData.id) ||
              {
                id: sessionData.id,
                label: sessionData.label || sessionData.id,
                farm: sessionData.farm || '',
                barn: sessionData.barn || '',
                room: sessionData.room || sessionData.label || sessionData.id,
                birds: Number.isFinite(sessionData.birds) ? sessionData.birds : null,
                roomId: Number.isFinite(roomIdFromSession)
                  ? roomIdFromSession
                  : Number.isFinite(roomIdFallback)
                  ? roomIdFallback
                  : Number.isFinite(idRoomExtract)
                  ? idRoomExtract
                  : null,
              };
            const session = ensureSessionForLocation(location);
            if (!session.roomId) {
              if (Number.isFinite(roomIdFromSession)) {
                session.roomId = roomIdFromSession;
              } else if (Number.isFinite(roomIdFallback)) {
                session.roomId = roomIdFallback;
              } else if (Number.isFinite(idRoomExtract)) {
                session.roomId = idRoomExtract;
              }
            }
                session.entries = Array.isArray(sessionData.entries)
                  ? sessionData.entries
                      .filter(function (entry) {
                        return entry && Number.isFinite(Number(entry.grams)) && Number(entry.grams) > 0;
                      })
                      .map(function (entry) {
                        return {
                          id: entry.id || createEntryId(),
                          grams: Number(entry.grams),
                          createdAt: entry.createdAt || null,
                          updatedAt: entry.updatedAt || null,
                        };
                      })
                  : [];
                session.status = sessionData.status || (session.entries.length ? 'paused' : 'idle');
                session.createdAt = sessionData.createdAt || session.createdAt;
                session.updatedAt = sessionData.updatedAt || null;
                hasEntries = hasEntries || session.entries.length > 0;
              });
              if (saved.activeSalonId && weightState.sessions[saved.activeSalonId]) {
                weightState.activeSalonId = saved.activeSalonId;
              }
              weightState.lastSavedAt = saved.updatedAt ? Date.parse(saved.updatedAt) : null;
            } else if (saved && (Array.isArray(saved.salons) || Array.isArray(saved.entries))) {
              const legacySalons = Array.isArray(saved.salons)
                ? saved.salons.filter(function (salon) {
                    return salon && salon.id;
                  })
                : [];
              const legacyEntries = Array.isArray(saved.entries)
                ? saved.entries.filter(function (entry) {
                    return entry && Number.isFinite(Number(entry.grams)) && Number(entry.grams) > 0;
                  })
                : [];
              if (legacySalons.length && legacyEntries.length) {
                const primary = legacySalons[0];
                const legacyRoomId = normalizeNumber(primary.roomId || primary.room_id);
            const location =
              getLocationMeta(primary.id) ||
              {
                id: primary.id,
                label: primary.label || primary.id,
                farm: primary.farm || '',
                barn: primary.barn || '',
                room: primary.room || primary.label || primary.id,
                birds: Number.isFinite(primary.birds) ? primary.birds : null,
                roomId: Number.isFinite(legacyRoomId) ? legacyRoomId : extractRoomId(primary.id),
              };
            const session = ensureSessionForLocation(location);
            if (!session.roomId && Number.isFinite(legacyRoomId)) {
              session.roomId = legacyRoomId;
            } else if (!session.roomId) {
              const parsed = extractRoomId(primary.id);
              if (Number.isFinite(parsed)) {
                session.roomId = parsed;
              }
            }
                session.entries = legacyEntries.map(function (entry) {
                  return {
                    id: entry.id || createEntryId(),
                    grams: Number(entry.grams),
                    createdAt: entry.createdAt || null,
                    updatedAt: entry.updatedAt || null,
                  };
                });
                session.status = session.entries.length ? 'paused' : 'idle';
                session.createdAt = saved.updatedAt || session.createdAt;
                session.updatedAt = saved.updatedAt || null;
                weightState.activeSalonId = session.id;
                hasEntries = session.entries.length > 0;
              }
              weightState.lastSavedAt = saved && saved.updatedAt ? Date.parse(saved.updatedAt) : null;
            }
            weightState.dirty = false;
            if (!weightState.activeSalonId) {
              const firstWithEntries = getSessionsWithEntries()[0];
              if (firstWithEntries) {
                weightState.activeSalonId = firstWithEntries.id;
              }
            }
            if (hasEntries) {
            setStatus('Registro listo para continuar', 'info');
            }
            serverSessionLoaded = serverSessionLoaded || hasEntries;
          } catch (error) {
            console.warn('No se pudo cargar el registro de pesos.', error);
          }
        }

        function handleAddWeight(valueOverride) {
          const grams = Number.isFinite(valueOverride) ? valueOverride : parseWeightInput(weightInput ? weightInput.value : '');
          if (!Number.isFinite(grams) || grams <= 0) {
            setStatus('Ingresa un peso v√°lido', 'error', { sticky: true, duration: 4000 });
            if (!Number.isFinite(valueOverride) && weightInput) {
              weightInput.focus();
            }
            return;
          }
          if (addWeightEntry(grams) && weightInput) {
            weightInput.value = '';
            weightInput.focus();
          }
          setStatus('Peso agregado', 'info');
          if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.impactOccurred) {
            telegram.HapticFeedback.impactOccurred('soft');
          }
        }

        function handlePause() {
          const session = getActiveSession();
          if (!session || !session.entries.length) {
            setStatus('Sin pesos pendientes por guardar', 'warning');
            return;
          }
          if (!canUseLocalStorage) {
            setStatus('Mant√©n la app abierta, no pudimos guardar localmente', 'error', { sticky: true, duration: 5000 });
            return;
          }
          session.status = 'paused';
          session.updatedAt = new Date().toISOString();
          autoPersistState({ feedback: 'explicit' });
          closeWeightPanel();
          updateLocationButtons();
          updateLocationSummaries();
          updateSelectedCounter();
          if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
            telegram.HapticFeedback.notificationOccurred('success');
          }
        }

        async function handleFinish() {
          const allSessions = getAllSessions();
          if (!allSessions.length) {
            setStatus('Agrega pesos antes de enviar', 'error', { sticky: true });
            if (weightInput) {
              weightInput.focus();
            }
            return;
          }
          const resolvedSessions = allSessions
            .map(function (session) {
              const meta = getLocationMeta(session.id);
              let roomId = Number.isFinite(session.roomId) ? session.roomId : extractRoomId(session.id);
              if (!Number.isFinite(roomId) && meta && Number.isFinite(meta.roomId)) {
                roomId = meta.roomId;
              }
              if (Number.isFinite(roomId)) {
                session.roomId = roomId;
              }
              return {
                session: session,
                meta: meta,
                roomId: Number.isFinite(roomId) ? roomId : null,
              };
            })
            .filter(function (item) {
              return item.meta && Number.isFinite(item.roomId);
            });

          if (!resolvedSessions.length) {
            setStatus('Los salones registrados no coinciden con tu turno actual. Revisa la selecci√≥n.', 'error', {
              sticky: true,
              duration: 6000,
            });
            return;
          }

          const skippedCount = allSessions.length - resolvedSessions.length;
          if (skippedCount > 0) {
            setStatus(
              formatCount(skippedCount) +
                ' salones no est√°n disponibles en tu turno actual y se omitieron del env√≠o.',
              'warning'
            );
          }

          const sessionsWithEntries = resolvedSessions.filter(function (item) {
            return sessionHasEntries(item.session);
          });
          if (!sessionsWithEntries.length) {
            setStatus('Agrega pesos antes de enviar', 'error', { sticky: true });
            if (weightInput) {
              weightInput.focus();
            }
            return;
          }

          const belowMinimum = sessionsWithEntries.filter(function (item) {
            return item.session.entries.length < weightMinimumSample;
          });
          if (belowMinimum.length) {
            const first = belowMinimum[0].session;
            setStatus(
              'Enviando ' +
                (first.room || first.label || first.id || 'sal√≥n') +
                ' con ' +
                formatCount(first.entries.length) +
                ' aves (m√≠nimo sugerido ' +
                formatCount(weightMinimumSample) +
                ').',
              'warning',
              { sticky: true, duration: 4000 }
            );
          }
          const sessionDetails = resolvedSessions.map(function (item) {
            const session = item.session;
            const metrics = computeWeightMetrics(session.entries);
            const averageGrams = round(metrics.gramsAverage, 2);
            const varianceGrams = round(metrics.varianceGrams, 2);
            const minGrams = round(metrics.minGrams, 2);
            const maxGrams = round(metrics.maxGrams, 2);
            const uniformityPercent = round(metrics.uniformityPercent, 2);
            const sessionMetrics = {
              count: metrics.count,
              average_grams: averageGrams,
              average_kg: Number.isFinite(metrics.gramsAverage) ? round(metrics.gramsAverage / 1000, 3) : null,
              variance_grams: varianceGrams,
              variance_kg: Number.isFinite(metrics.varianceGrams) ? round(metrics.varianceGrams / 1000000, 4) : null,
              min_grams: minGrams,
              max_grams: maxGrams,
              uniformity_percent: uniformityPercent,
              within_tolerance: metrics.withinTolerance,
              tolerance_percent: metrics.tolerancePercent,
            };
            return {
              id: session.id,
              label: session.label,
              farm: session.farm,
              barn: session.barn,
              room: session.room,
              birds: session.birds,
              room_id: item.roomId,
              metrics: sessionMetrics,
              entries_grams: session.entries.map(function (entry) {
                return round(entry.grams, 2);
              }),
            };
          });
          const aggregatedEntries = sessionsWithEntries.reduce(function (accumulator, item) {
            return accumulator.concat(item.session.entries.slice());
          }, []);
          const overallMetrics = computeWeightMetrics(aggregatedEntries);
          const serverSessionsPayload = sessionDetails.map(function (session) {
            return {
              id: session.id,
              room_id: session.room_id,
              entries: session.entries_grams.slice(),
            };
          });
          const payloadToSend = {
            action: 'weight-registry',
            unit: weightUnitLabel,
            tolerance_percent: weightTolerancePercent,
            minimum_sample: weightMinimumSample,
            salons: sessionDetails.map(function (session) {
              return {
                id: session.id,
                label: session.label,
                farm: session.farm,
                barn: session.barn,
                room: session.room,
                birds: session.birds,
                room_id: session.room_id,
                sample_size: session.metrics.count,
              };
            }),
            session_details: sessionDetails,
            metrics: {
              count: overallMetrics.count,
              average_grams: round(overallMetrics.gramsAverage, 2),
              average_kg: Number.isFinite(overallMetrics.gramsAverage)
                ? round(overallMetrics.gramsAverage / 1000, 3)
                : null,
              variance_grams: round(overallMetrics.varianceGrams, 2),
              variance_kg: Number.isFinite(overallMetrics.varianceGrams)
                ? round(overallMetrics.varianceGrams / 1000000, 4)
                : null,
              min_grams: round(overallMetrics.minGrams, 2),
              max_grams: round(overallMetrics.maxGrams, 2),
              uniformity_percent: round(overallMetrics.uniformityPercent, 2),
              within_tolerance: overallMetrics.withinTolerance,
              tolerance_percent: overallMetrics.tolerancePercent,
            },
            entries_grams: aggregatedEntries.map(function (entry) {
              return round(entry.grams, 2);
            }),
            saved_at: new Date().toISOString(),
          };

          let serverRegistryPayload = null;
          if (weightSubmitUrl) {
            setButtonLoading(weightFinishButton, true, 'Enviando...');
            try {
              const response = await fetch(weightSubmitUrl, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign(
                  { 'Content-Type': 'application/json' },
                  csrfToken ? { 'X-CSRFToken': csrfToken } : {}
                ),
                body: JSON.stringify({
                  date: weightDate || null,
                  unit: weightUnitLabel,
                  tolerance_percent: weightTolerancePercent,
                  minimum_sample: weightMinimumSample,
                  sessions: serverSessionsPayload,
                }),
              });
              const result = await parseJsonResponse(response);
              if (result.status === 401 || result.status === 403) {
                redirectToLogin();
                return;
              }
              if (!result.ok || (result.data && result.data.error)) {
                const errorMessage =
                  (result.data && result.data.error) || 'No fue posible guardar los pesos. Intenta de nuevo.';
                setStatus(errorMessage, 'error', { sticky: true, duration: 6000 });
                applyWeightCardTheme('base');
                if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                  telegram.HapticFeedback.notificationOccurred('error');
                }
                return;
              }
              serverRegistryPayload = result.data ? result.data.weight_registry : null;
            } catch (error) {
              console.warn('No se pudo guardar el registro de pesos:', error);
              setStatus('No fue posible guardar los pesos. Intenta de nuevo.', 'error', { sticky: true, duration: 6000 });
              applyWeightCardTheme('base');
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                telegram.HapticFeedback.notificationOccurred('error');
              }
              return;
            } finally {
              setButtonLoading(weightFinishButton, false);
            }
          }

          try {
            if (telegram && typeof telegram.sendData === 'function') {
              telegram.sendData(JSON.stringify(payloadToSend));
            }
          } catch (error) {
            console.info('No se pudo enviar el registro de pesos a Telegram:', error);
          }
          console.info('Registro de pesos', payloadToSend);
          if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
            telegram.HapticFeedback.notificationOccurred('success');
          }
          applyWeightCardTheme('success');
          setStatus('Pesos sincronizados exitosamente. ¬°Turno al d√≠a!', 'success', { sticky: true, duration: 6000 });
          clearStoredState();
          resetSessionState();
          if (serverRegistryPayload && Array.isArray(serverRegistryPayload.sessions)) {
            applyServerSessions(serverRegistryPayload.sessions, { persist: true });
            serverSessionLoaded = true;
          } else if (serverSessionsPayload.length) {
            applyServerSessions(serverSessionsPayload, { persist: true });
          }
          autoPersistState({ silent: true });
          weightState.lastSavedAt = Date.now();
          weightState.dirty = false;
          weightLastMetrics = null;
          closeWeightPanel();
          renderWeightEntries();
          updateActiveSalonsLabel();
          updateLocationButtons();
          updateLocationSummaries();
          updateSelectedCounter();
          updateStartButtonState();
          updateResumeVisibility();
          updateSelectionHint();
          const totalAfterSave = getTotalEntriesAcrossSessions();
          if (!totalAfterSave && Date.now() > weightStatusLockUntil) {
            setStatus('Sin cambios', 'muted', { force: true });
          }
        }

        applyWeightCardTheme('base');
        loadWeightState();
        updateLocationButtons();
        updateLocationSummaries();
        updateSelectedCounter();
        updateStartButtonState();
        updateActiveSalonsLabel();
        renderWeightEntries();
        updateResumeVisibility();
        updateSelectionHint();
        const totalEntries = getTotalEntriesAcrossSessions();
        if (serverSessionLoaded && totalEntries) {
          setStatus('Registro listo para continuar', 'info');
        } else if (!totalEntries) {
          setStatus('Sin cambios', 'muted', { force: true });
        }
        if (!canUseLocalStorage) {
          setStatus('Mant√©n la app abierta, no guardaremos autom√°ticamente', 'warning', {
            sticky: true,
            duration: 5000,
          });
        }

        if (weightLocationButtons.length) {
          weightLocationButtons.forEach(function (button) {
            button.addEventListener('click', function () {
              const id = button.getAttribute('data-weight-location');
              if (!id) {
                return;
              }
              setActiveSalon(id, { openPanel: true, focus: true });
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
                telegram.HapticFeedback.selectionChanged();
              }
            });
          });
        }

        if (weightStartButton) {
          weightStartButton.addEventListener('click', function () {
            if (!weightState.activeSalonId) {
              setStatus('Selecciona un sal√≥n para iniciar.', 'warning');
              return;
            }
            openWeightPanel({ focus: true });
            if (isWeightPanelOpen) {
              setStatus('Registro en progreso', 'info');
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
                telegram.HapticFeedback.selectionChanged();
              }
            }
          });
        }

        if (weightResumeButton) {
          weightResumeButton.addEventListener('click', function () {
            if (!weightState.activeSalonId) {
              setStatus('Selecciona un sal√≥n para continuar.', 'warning');
              return;
            }
            openWeightPanel({ focus: true });
            if (isWeightPanelOpen) {
              setStatus('Registro retomado', 'info');
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
                telegram.HapticFeedback.selectionChanged();
              }
            }
          });
        }

        if (weightAddButton) {
          weightAddButton.addEventListener('click', function () {
            handleAddWeight();
          });
        }

        if (weightInput) {
          weightInput.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
              event.preventDefault();
              handleAddWeight();
            }
          });
        }


        if (weightList) {
          weightList.addEventListener('click', function (event) {
            const targetButton = event.target.closest('[data-weight-remove], [data-weight-edit]');
            if (!targetButton) {
              return;
            }
            event.preventDefault();
            const removeId = targetButton.getAttribute('data-weight-remove');
            const editId = targetButton.getAttribute('data-weight-edit');
            if (removeId) {
              removeWeightEntry(removeId);
            } else if (editId) {
              editWeightEntry(editId);
            }
          });
        }

        if (weightResetButton) {
          weightResetButton.addEventListener('click', function () {
            const session = getActiveSession();
            if (!session || !session.entries.length) {
              return;
            }
            const roomLabel = session.room || session.label || 'este sal√≥n';
            const proceed = window.confirm('¬øVaciar la lista de pesos de ' + roomLabel + '?');
            if (!proceed) {
              return;
            }
            session.entries = [];
            session.status = 'idle';
            session.updatedAt = new Date().toISOString();
            weightState.dirty = true;
            renderWeightEntries();
            autoPersistState({ silent: true });
            updateLocationButtons();
            updateLocationSummaries();
            setStatus('Lista reiniciada', 'warning');
          });
        }

        if (weightCopyButton) {
          weightCopyButton.addEventListener('click', function () {
            const entries = getSessionEntries();
            if (!entries.length) {
              setStatus('No hay pesos para copiar', 'warning');
              return;
            }
            copyWeightsToClipboard()
              .then(function () {
                setStatus('Pesos copiados al portapapeles', 'success');
                if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                  telegram.HapticFeedback.notificationOccurred('success');
                }
              })
              .catch(function () {
                setStatus('No pudimos copiar los pesos', 'error');
              });
          });
        }

        if (weightPauseButton) {
          weightPauseButton.addEventListener('click', function () {
            handlePause();
          });
        }

        if (weightFinishButton) {
          weightFinishButton.addEventListener('click', function () {
            handleFinish();
          });
        }
      }

        dispatchCreateTriggers.forEach(function (button) {
          button.addEventListener('click', function (event) {
            event.preventDefault();
            showDispatchForm('new');
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
              telegram.HapticFeedback.selectionChanged();
            }
          });
        });

        dispatchEditTriggers.forEach(function (button) {
          button.addEventListener('click', function (event) {
            event.preventDefault();
            const dispatchId = button.getAttribute('data-dispatch-id');
            if (dispatchId) {
              showDispatchForm(dispatchId);
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
                telegram.HapticFeedback.selectionChanged();
              }
            }
          });
        });

        dispatchDetailTriggers.forEach(function (button) {
          button.addEventListener('click', function (event) {
            event.preventDefault();
            const dispatchId = button.getAttribute('data-dispatch-id');
            if (dispatchId) {
              showDispatchDetail(dispatchId);
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
                telegram.HapticFeedback.selectionChanged();
              }
            }
          });
        });

        dispatchCloseTriggers.forEach(function (button) {
          button.addEventListener('click', function (event) {
            event.preventDefault();
            const formCard = button.closest('[data-dispatch-form-card]');
            const detailCard = button.closest('[data-dispatch-detail-card]');
            const cardNode = formCard || detailCard;
            if (cardNode) {
              closeDispatchCard(cardNode);
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.impactOccurred) {
                telegram.HapticFeedback.impactOccurred('soft');
              }
            }
          });
        });

        dispatchSubmitButtons.forEach(function (button) {
          button.addEventListener('click', function (event) {
            event.preventDefault();
            if (typeof button.blur === 'function') {
              button.blur();
            }
            const formPanel = button.closest('[data-dispatch-form]');
            const dispatchId = formPanel ? formPanel.getAttribute('data-dispatch-id') || 'new' : 'new';
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
              telegram.HapticFeedback.notificationOccurred('success');
            }
            console.info('Despacho guardado (simulado):', dispatchId);
          });
        });

        dispatchConfirmButtons.forEach(function (button) {
          button.addEventListener('click', function (event) {
            event.preventDefault();
            if (typeof button.blur === 'function') {
              button.blur();
            }
            const detailPanel = button.closest('[data-dispatch-detail]');
            const dispatchId = detailPanel ? detailPanel.getAttribute('data-dispatch-id') || '' : '';
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
              telegram.HapticFeedback.notificationOccurred('success');
            }
            console.info('Despacho confirmado (simulado):', dispatchId);
          });
        });

        dispatchStatusSelects.forEach(function (select) {
          const dispatchId = select.getAttribute('data-dispatch-id');
          if (dispatchId) {
            applyDispatchStatusVisuals(dispatchId, select.value);
          }
          select.addEventListener('change', function () {
            const currentId = select.getAttribute('data-dispatch-id');
            if (currentId) {
              applyDispatchStatusVisuals(currentId, select.value);
            }
          });
        });

        const dispatchInputNodes = Array.prototype.slice.call(document.querySelectorAll('[data-dispatch-input]'));
        dispatchInputNodes.forEach(function (input) {
          input.addEventListener('input', function () {
            const panel =
              input.closest('[data-dispatch-form]') || input.closest('[data-dispatch-detail]');
            updateDispatchPanelTotals(panel);
          });
        });

        updateAllDispatchTotals();

        if (transportCard && transportForm) {
          if (expectedDateField && !expectedDateField.value && transportDefaultDate) {
            expectedDateField.value = transportDefaultDate;
          }

          transportProductionInputs.forEach(function (input) {
            input.addEventListener('change', function () {
              hideTransportMessages();
              updateTransportSelectionSummary();
            });
          });

          if (transporterField) {
            transporterField.addEventListener('change', function () {
              hideTransportMessages();
              updateTransportSelectionSummary();
            });
          }

          if (expectedDateField) {
            expectedDateField.addEventListener('change', function () {
              hideTransportMessages();
              updateTransportSelectionSummary();
            });
          }

          transportForm.addEventListener('submit', function (event) {
            event.preventDefault();
            hideTransportMessages();
            const totals = computeTransportTotals();
            if (!totals.productions.length) {
              showTransportFeedback('Selecciona al menos una producci√≥n para autorizar.');
              return;
            }
            if (!transporterField || !transporterField.value) {
              showTransportFeedback('Indica el transportador asignado.');
              return;
            }
            if (!expectedDateField || !expectedDateField.value) {
              showTransportFeedback('Define la fecha estimada de transporte.');
              return;
            }
            if (!transportSubmitUrl) {
              showTransportFeedback('No podemos autorizar el transporte en este momento.');
              return;
            }

            const transporterOption = transporterField.options[transporterField.selectedIndex];
            const transporterLabel = transporterOption ? transporterOption.textContent.trim() : transporterField.value;
            const expectedDateValue = expectedDateField.value;
            const expectedDateLabel = formatDateLabel(expectedDateValue);
            const productionsPayload = totals.productions.map(function (production) {
              return {
                id: production.id,
                label: production.label,
                cartons: production.cartons,
                production_date: production.productionDate,
                production_date_label: production.productionDateLabel,
              };
            });

            if (transportAuthorizeButton) {
              transportAuthorizeButton.disabled = true;
            }

            const requestPayload = {
              production_ids: totals.productions.map(function (production) {
                return production.id;
              }),
              transporter_id: transporterField.value,
              expected_date: expectedDateValue,
            };

            fetch(transportSubmitUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || '',
              },
              body: JSON.stringify(requestPayload),
            })
              .then(function (response) {
                return response.json().then(function (data) {
                  if (!response.ok || (data && data.error)) {
                    const message = data && data.error ? data.error : 'No se pudo autorizar el transporte.';
                    throw new Error(message);
                  }
                  return data;
                });
              })
              .then(function () {
                totals.inputs.forEach(function (input) {
                  input.checked = false;
                  input.disabled = false;
                  input.removeAttribute('disabled');
                  const row = input.closest('[data-transport-production-row]');
                  if (row) {
                    row.dataset.state = 'authorized';
                    const statusBadge = row.querySelector('[data-transport-production-status]');
                    if (statusBadge) {
                      statusBadge.classList.remove('hidden');
                      statusBadge.textContent = 'Autorizada';
                    }
                  }
                });

                const productionNames = totals.productions.map(function (production) {
                  return production.label;
                });
                const successMessage =
                  (productionNames.length === 1
                    ? 'Producci√≥n ' + productionNames[0]
                    : productionNames.length + ' producciones autorizadas') +
                  ' ¬∑ Transporte: ' +
                  transporterLabel +
                  ' ¬∑ Salida estimada: ' +
                  expectedDateLabel +
                  '.';

                showTransportSuccess(successMessage);
                updateTransportSelectionSummary();
                if (transportAuthorizeButton) {
                  transportAuthorizeButton.blur();
                }

                if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                  telegram.HapticFeedback.notificationOccurred('success');
                }
                if (telegram && typeof telegram.sendData === 'function') {
                  try {
                    telegram.sendData(
                      JSON.stringify({
                        action: 'authorize-transport',
                        transporter_id: transporterField.value,
                        transporter_label: transporterLabel,
                        expected_date: expectedDateValue,
                        productions: productionsPayload,
                      })
                    );
                  } catch (error) {
                    console.info('No se pudo enviar la autorizaci√≥n de transporte a Telegram:', error);
                  }
                } else {
                  console.info('Transporte autorizado:', {
                    transporter: transporterField.value,
                    expected_date: expectedDateValue,
                    productions: productionsPayload,
                  });
                }
              })
              .catch(function (error) {
                showTransportFeedback(error.message || 'Ocurri√≥ un error al autorizar el transporte.');
              })
              .finally(function () {
                if (transportAuthorizeButton) {
                  transportAuthorizeButton.disabled = false;
                }
              });
          });

          updateTransportSelectionSummary();
        }

        if (transportConfirmForm && transportConfirmInputs.length) {
          const hideTransportConfirmFeedback = function () {
            if (!transportConfirmFeedback) {
              return;
            }
            transportConfirmFeedback.classList.add('hidden');
            transportConfirmFeedback.classList.remove('text-rose-600', 'text-emerald-600');
            transportConfirmFeedback.textContent = '';
          };

          const showTransportConfirmFeedback = function (message, tone) {
            if (!transportConfirmFeedback) {
              return;
            }
            transportConfirmFeedback.textContent = message || '';
            transportConfirmFeedback.classList.remove('hidden');
            if (tone === 'success') {
              transportConfirmFeedback.classList.add('text-emerald-600');
              transportConfirmFeedback.classList.remove('text-rose-600');
            } else {
              transportConfirmFeedback.classList.add('text-rose-600');
              transportConfirmFeedback.classList.remove('text-emerald-600');
            }
          };

          const updateTransportConfirmButton = function () {
            if (!transportConfirmButton) {
              return;
            }
            const ready = transportConfirmInputs.every(function (input) {
              return input && input.value !== '';
            });
            transportConfirmButton.disabled = !ready;
          };

          transportConfirmInputs.forEach(function (input) {
            input.addEventListener('input', function () {
              hideTransportConfirmFeedback();
              updateTransportConfirmButton();
            });
          });
          updateTransportConfirmButton();

          transportConfirmForm.addEventListener('submit', function (event) {
            event.preventDefault();
            hideTransportConfirmFeedback();
            if (!transportConfirmUrl) {
              showTransportConfirmFeedback('No podemos registrar la confirmaci√≥n en este momento.', 'error');
              return;
            }
            const entries = [];
            let hasError = false;
            transportConfirmInputs.forEach(function (input) {
              const entryId = input.getAttribute('data-entry-id');
              if (!entryId) {
                return;
              }
              const value = input.value;
              if (value === '') {
                hasError = true;
                return;
              }
              const cartons = Number(value);
              if (Number.isNaN(cartons) || cartons < 0) {
                hasError = true;
                return;
              }
              entries.push({ id: Number(entryId), cartons: cartons });
            });
            if (hasError) {
              showTransportConfirmFeedback('Revisa que los cartones sean n√∫meros v√°lidos.', 'error');
              return;
            }
            if (!entries.length) {
              showTransportConfirmFeedback('No hay lotes seleccionados para confirmar.', 'error');
              return;
            }

            if (transportConfirmButton) {
              transportConfirmButton.disabled = true;
            }

            fetch(transportConfirmUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || '',
              },
              body: JSON.stringify({ entries: entries }),
            })
              .then(function (response) {
                return response.json().then(function (data) {
                  if (!response.ok || (data && data.error)) {
                    const message = data && data.error ? data.error : 'No se pudo registrar el cargue.';
                    throw new Error(message);
                  }
                  return data;
                });
              })
              .then(function () {
                showTransportConfirmFeedback('Cargue registrado correctamente.', 'success');
                if (transportConfirmButton) {
                  transportConfirmButton.blur();
                }
                if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                  telegram.HapticFeedback.notificationOccurred('success');
                }
              })
              .catch(function (error) {
                showTransportConfirmFeedback(error.message || 'No se pudo registrar el cargue.', 'error');
              })
              .finally(function () {
                updateTransportConfirmButton();
              });
          });
        }

        if (pendingClassificationStageButtons.length) {
          pendingClassificationStageButtons.forEach(function (button) {
            button.addEventListener('click', function () {
              const targetStage = button.getAttribute('data-select-egg-stage');
              if (!targetStage) {
                return;
              }
              focusStageCard(targetStage, { focusFirstInput: targetStage === 'classification' });
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
                telegram.HapticFeedback.selectionChanged();
              }
            });
          });
        }

        if (eggStageCards.length) {
          eggStageCards.forEach(function (card) {
            const stageId = card.getAttribute('data-egg-stage');
            if (!stageId) {
              return;
            }
            const defaultProgressIndexAttr = card.getAttribute('data-egg-stage-progress-index');
            const defaultProgressIdAttr = card.getAttribute('data-egg-stage-progress-id');
            const state = ensureStageState(stageId);
            if (
              stageId === 'transport' &&
              state.data &&
              state.data.progress &&
              typeof state.data.progress.stepIndex === 'number' &&
              state.data.progress.stepIndex < 0
            ) {
              const parsedIndex = Number(defaultProgressIndexAttr);
              if (!Number.isNaN(parsedIndex) && parsedIndex >= 0) {
                state.data.progress.stepIndex = parsedIndex;
              }
              if (defaultProgressIdAttr) {
                state.data.progress.stepId = defaultProgressIdAttr;
              }
            }
            const completeButton = card.querySelector('[data-egg-stage-complete]');
            if (completeButton && !completeButton.dataset.defaultLabel) {
              completeButton.dataset.defaultLabel = completeButton.textContent.trim();
            }
            const progressContainer = card.querySelector('[data-egg-stage-progress]');
            if (progressContainer) {
              const buttons = Array.prototype.slice.call(
                progressContainer.querySelectorAll('[data-egg-stage-progress-step]')
              );
              stageProgressContainers[stageId] = {
                container: progressContainer,
                buttons: buttons,
              };
              buttons.forEach(function (button) {
                button.addEventListener('click', function () {
                  const index = Number(button.getAttribute('data-step-index')) || 0;
                  const stepId = button.getAttribute('data-step-id') || '';
                  setTransportProgress(stageId, index, stepId);
                  if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.selectionChanged) {
                    telegram.HapticFeedback.selectionChanged();
                  }
                });
              });
            }
            setStageVisualStatus(stageId, ensureStageState(stageId).status || 'pending');
            updateTransportButtons(stageId);
            updateTransportStatusLabel(stageId);
          });

          eggStageInputs.forEach(function (input) {
            const stageId = input.getAttribute('data-stage');
            if (!stageId) {
              return;
            }
            input.addEventListener('input', function () {
              const field = input.getAttribute('data-field');
              const state = ensureStageState(stageId);
              if (field) {
                state.data[field] = input.value || '';
              }
              markStagePending(stageId);
            });
          });

          if (classificationInputs.length) {
            classificationInputs.forEach(function (input) {
              input.addEventListener('input', function () {
                updateClassificationValues();
                markStagePending('classification');
              });
            });
            updateClassificationValues();
          }

          if (inspectionInputs.length) {
            inspectionInputs.forEach(function (input) {
              input.addEventListener('input', function () {
                updateInspectionValues();
                markStagePending('inspection');
              });
            });
            updateInspectionValues();
          }

          eggStageSaveButtons.forEach(function (button) {
            button.addEventListener('click', function () {
              const stageId = button.getAttribute('data-stage');
              if (!stageId) {
                return;
              }
              const payload = buildStagePayload(stageId);
              const completesStage = button.hasAttribute('data-completes-stage');
              if (completesStage) {
                markStageCompleted(stageId);
              } else {
                markStageSaved(stageId);
              }
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.impactOccurred) {
                telegram.HapticFeedback.impactOccurred(completesStage ? 'medium' : 'soft');
              }
              if (telegram && typeof telegram.sendData === 'function') {
                try {
                  telegram.sendData(
                    JSON.stringify({
                      action: completesStage ? 'egg-stage-complete' : 'egg-stage-save',
                      stage: stageId,
                      data: payload,
                    })
                  );
                } catch (error) {
                  console.info('No se pudo enviar la etapa guardada a Telegram:', error);
                }
              } else {
                if (completesStage) {
                  console.info('Etapa completada:', stageId, payload);
                } else {
                  console.info('Etapa guardada:', stageId, payload);
                }
              }
            });
          });

          eggStageCompleteButtons.forEach(function (button) {
            button.addEventListener('click', function () {
              const stageId = button.getAttribute('data-stage');
              if (!stageId) {
                return;
              }
              const payload = buildStagePayload(stageId);
              if (stageId === 'classification') {
                const totals = (payload && payload.totals) || { cartons: 0 };
                if (classificationExpectedCartons > 0 && totals.cartons !== classificationExpectedCartons) {
                  if (classificationSummaryNode) {
                    classificationSummaryNode.classList.remove('text-emerald-700');
                    classificationSummaryNode.classList.add('text-rose-600');
                  }
                  if (classificationFeedbackNode) {
                    classificationFeedbackNode.classList.remove('text-emerald-700', 'text-emerald-600');
                    classificationFeedbackNode.classList.add('text-rose-600');
                    classificationFeedbackNode.textContent =
                      'Debes igualar los ' + formatNumber(classificationExpectedCartons) + ' cartones antes de cerrar.';
                  }
                  if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                    telegram.HapticFeedback.notificationOccurred('error');
                  }
                  return;
                }
              }

              const isVerificationStage = stageId === 'verification';
              if (isVerificationStage) {
                markStageSaved(stageId);
                if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.impactOccurred) {
                  telegram.HapticFeedback.impactOccurred('soft');
                }
                if (telegram && typeof telegram.sendData === 'function') {
                  try {
                    telegram.sendData(
                      JSON.stringify({
                        action: 'egg-stage-save',
                        stage: stageId,
                        data: payload,
                      })
                    );
                  } catch (error) {
                    console.info('No se pudo enviar la etapa guardada a Telegram:', error);
                  }
                } else {
                  console.info('Etapa guardada:', stageId, payload);
                }
              }

              markStageCompleted(stageId);
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                telegram.HapticFeedback.notificationOccurred('success');
              }
              if (telegram && typeof telegram.sendData === 'function') {
                try {
                  telegram.sendData(
                    JSON.stringify({
                      action: 'egg-stage-complete',
                      stage: stageId,
                      data: payload,
                    })
                  );
                } catch (error) {
                  console.info('No se pudo enviar la confirmacion de etapa a Telegram:', error);
                }
              } else {
                console.info('Etapa completada:', stageId, payload);
              }
            });
          });
        }

        if (verificationForm) {
          const toggleVerificationFeedback = function (message, tone) {
            if (!verificationFeedback) {
              return;
            }
            verificationFeedback.textContent = message || '';
            if (message) {
              verificationFeedback.classList.remove('hidden');
              if (tone === 'success') {
                verificationFeedback.classList.add('text-emerald-600');
                verificationFeedback.classList.remove('text-rose-600');
              } else {
                verificationFeedback.classList.add('text-rose-600');
                verificationFeedback.classList.remove('text-emerald-600');
              }
            } else {
              verificationFeedback.classList.add('hidden');
              verificationFeedback.classList.remove('text-emerald-600', 'text-rose-600');
            }
          };

          verificationInputs.forEach(function (input) {
            input.addEventListener('input', function () {
              toggleVerificationFeedback('', null);
            });
          });

          verificationForm.addEventListener('submit', function (event) {
            event.preventDefault();
            toggleVerificationFeedback('', null);
            if (!verificationSubmitUrl) {
              toggleVerificationFeedback('No podemos registrar la verificaci√≥n en este momento.', 'error');
              return;
            }

            const entries = [];
            let hasError = false;
            verificationInputs.forEach(function (input) {
              const entryId = input.getAttribute('data-entry-id');
              if (!entryId) {
                return;
              }
              const value = input.value;
              const cartons = Number(value);
              if (Number.isNaN(cartons) || cartons < 0) {
                hasError = true;
                return;
              }
              entries.push({ id: Number(entryId), cartons: cartons });
            });

            if (hasError) {
              toggleVerificationFeedback('Verifica que los cartones sean n√∫meros v√°lidos.', 'error');
              return;
            }

            if (!entries.length) {
              toggleVerificationFeedback('No hay producciones para verificar.', 'error');
              return;
            }

            const submitButton = verificationForm.querySelector('[data-egg-verification-submit]');
            if (submitButton) {
              submitButton.disabled = true;
            }

            fetch(verificationSubmitUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || '',
              },
              body: JSON.stringify({ entries: entries }),
            })
              .then(function (response) {
                return response.json().then(function (data) {
                  if (!response.ok || (data && data.error)) {
                    const message = data && data.error ? data.error : 'No se pudo registrar la verificaci√≥n.';
                    throw new Error(message);
                  }
                  return data;
                });
              })
              .then(function () {
                toggleVerificationFeedback('Verificaci√≥n registrada.', 'success');
                verificationInputs.forEach(function (input) {
                  input.disabled = true;
                });
              })
              .catch(function (error) {
                toggleVerificationFeedback(error.message || 'No se pudo registrar la verificaci√≥n.', 'error');
              })
              .finally(function () {
                if (submitButton) {
                  submitButton.disabled = false;
                }
              });
          });
        }
        const taskCards = Array.prototype.slice.call(document.querySelectorAll('[data-task-card]'));
        const BADGE_THEME_CLASS_MAP = {
          brand: 'border-amber-300 bg-amber-50 text-amber-700',
          amber: 'border-amber-300 bg-amber-50 text-amber-700',
          critical: 'border-rose-300 bg-rose-50 text-rose-700',
          rose: 'border-rose-300 bg-rose-50 text-rose-700',
          success: 'border-emerald-300 bg-emerald-50 text-emerald-700',
          emerald: 'border-emerald-300 bg-emerald-50 text-emerald-700',
          sky: 'border-sky-300 bg-sky-50 text-sky-700',
          neutral: 'border-slate-300 bg-slate-100 text-slate-700',
        };

        function applyBadgeTheme(badge, theme) {
          if (!badge) {
            return;
          }
          const classes = BADGE_THEME_CLASS_MAP[theme] || BADGE_THEME_CLASS_MAP.neutral;
          badge.className = 'rounded-full border px-2 py-0.5 ' + classes;
        }

        function formatIsoDateLabel(isoDate) {
          if (!isoDate) {
            return '';
          }
          const date = new Date(isoDate);
          if (Number.isNaN(date.getTime())) {
            return isoDate;
          }
          return date.toLocaleDateString(undefined, {
            weekday: 'short',
            day: 'numeric',
            month: 'short',
          });
        }

        function applyCompletedCardStyles(card, completedOn, noteValue) {
          if (!card) {
            return;
          }
          card.setAttribute('data-task-status', 'completed');
          if (completedOn) {
            card.setAttribute('data-task-completed-on', completedOn);
          }
          card.classList.remove('bg-white');
          card.classList.add('bg-emerald-50/80', 'border-emerald-200');
          toggleCompleteButton(card, false);
          const statusDetails = card.querySelector('[data-task-status-details]');
          if (statusDetails) {
            const label = completedOn ? formatIsoDateLabel(completedOn) : 'hoy';
            statusDetails.textContent = 'Marcada ' + label;
          }
          const badgeContainer = card.querySelector('[data-task-badges]');
          if (badgeContainer) {
            const badgeNodes = badgeContainer.querySelectorAll('span');
            if (badgeNodes.length) {
              const statusBadge = badgeNodes[badgeNodes.length - 1];
              statusBadge.textContent = 'Completada';
              applyBadgeTheme(statusBadge, 'emerald');
            }
          }
          ensureResetButton(card);
          setNoteFieldState(card, true, noteValue);
        }

        function ensureResetButton(card) {
          if (!card) {
            return null;
          }
          let resetButton = card.querySelector('[data-task-action="reset"]');
          if (resetButton) {
            resetButton.removeAttribute('disabled');
            resetButton.setAttribute('data-task-disabled', 'false');
            return resetButton;
          }
          const actionList = card.querySelector('[data-task-action-list]');
          if (!actionList) {
            return null;
          }
          resetButton = document.createElement('button');
          resetButton.type = 'button';
          resetButton.className =
            'rounded-full px-3 py-1 text-xs font-semibold transition bg-brand text-slate-900 shadow shadow-amber-200/70 hover:bg-brand-dark';
          resetButton.setAttribute('data-task-action', 'reset');
          resetButton.setAttribute('data-task-disabled', 'false');
          resetButton.textContent = card.getAttribute('data-task-reset-label') || 'Marcar como No Completada';
          actionList.prepend(resetButton);
          bindTaskActionButton(resetButton);
          return resetButton;
        }

        function toggleCompleteButton(card, visible) {
          const button = card ? card.querySelector('[data-task-action="complete"]') : null;
          if (!button) {
            return;
          }
          if (visible) {
            button.classList.remove('hidden');
            button.disabled = false;
            button.setAttribute('data-task-disabled', 'false');
          } else {
            button.classList.add('hidden');
            button.disabled = true;
            button.setAttribute('data-task-disabled', 'true');
          }
        }

        function setNoteFieldState(card, locked, noteValue) {
          if (!card) {
            return;
          }
          const noteInput = card.querySelector('[data-task-note-input]');
          if (!noteInput) {
            return;
          }
          if (typeof noteValue === 'string') {
            noteInput.value = noteValue;
          }
          noteInput.readOnly = !!locked;
          noteInput.classList.toggle('cursor-not-allowed', !!locked);
          noteInput.classList.toggle('bg-emerald-50/70', !!locked);
          noteInput.classList.toggle('border-emerald-200', !!locked);
        }

        function applyPendingCardStyles(card, noteValue) {
          if (!card) {
            return;
          }
          card.setAttribute('data-task-status', 'pending');
          card.removeAttribute('data-task-completed-on');
          card.classList.remove('bg-emerald-50/80', 'border-emerald-200');
          if (!card.classList.contains('bg-white')) {
            card.classList.add('bg-white');
          }
          const statusDetails = card.querySelector('[data-task-status-details]');
          const defaultDetails = card.getAttribute('data-initial-status-details') || '';
          if (statusDetails) {
            statusDetails.textContent = defaultDetails;
          }
          const badgeContainer = card.querySelector('[data-task-badges]');
          if (badgeContainer) {
            const badgeNodes = badgeContainer.querySelectorAll('span');
            if (badgeNodes.length) {
              const statusBadge = badgeNodes[badgeNodes.length - 1];
              const originalLabel = card.getAttribute('data-task-status-label') || statusBadge.textContent;
              const originalTheme = card.getAttribute('data-task-status-theme') || 'neutral';
              statusBadge.textContent = originalLabel;
              applyBadgeTheme(statusBadge, originalTheme);
            }
          }
          toggleCompleteButton(card, true);
          setNoteFieldState(card, false, noteValue || '');
        }

        function sendTaskAction(action, title, extra) {
          const payload = Object.assign({ action: action, title: title || '' }, extra || {});
          if (telegram && typeof telegram.sendData === 'function') {
            try {
              telegram.sendData(JSON.stringify(payload));
            } catch (error) {
              console.info('No se pudo enviar la acci√≥n a Telegram:', error);
            }
            return;
          }
          if (payload.section) {
            console.info('Accion seleccionada:', payload.action, payload.title, 'Secci√≥n:', payload.section);
          } else {
            console.info('Accion seleccionada:', payload.action, payload.title, extra || '');
          }
        }
        tmMiniApp.sendTaskAction = sendTaskAction;

        function showTaskFeedback(card, message, tone) {
          if (!card) {
            return;
          }
          const feedback = card.querySelector('[data-task-feedback]');
          if (!feedback) {
            if (tone === 'error') {
              console.warn(message);
            } else {
              console.info(message);
            }
            return;
          }
          feedback.textContent = message;
          feedback.classList.remove('hidden', 'text-emerald-600', 'text-rose-600');
          feedback.classList.add(tone === 'error' ? 'text-rose-600' : 'text-emerald-600');
          if (card.__feedbackTimeout) {
            window.clearTimeout(card.__feedbackTimeout);
          }
          card.__feedbackTimeout = window.setTimeout(function () {
            feedback.classList.add('hidden');
          }, 4500);
        }
        tmMiniApp.showTaskFeedback = showTaskFeedback;

        function setButtonLoading(button, isLoading, loadingLabel) {
          if (!button) {
            return;
          }
          if (isLoading) {
            if (!button.dataset.originalHtml) {
              button.dataset.originalHtml = button.innerHTML;
            }
            if (!button.dataset.originalLabel) {
              button.dataset.originalLabel = button.textContent.trim();
            }
            button.disabled = true;
            if (loadingLabel) {
              button.innerHTML = '<span class="animate-pulse">' + loadingLabel + '</span>';
            }
            button.classList.add('opacity-70', 'pointer-events-none');
          } else {
            button.disabled = false;
            if (button.dataset.originalHtml) {
              button.innerHTML = button.dataset.originalHtml;
            } else {
              const originalLabel = button.dataset.originalLabel || button.textContent.trim();
              button.textContent = originalLabel;
            }
            button.classList.remove('opacity-70', 'pointer-events-none');
            const productionRefresh =
              window.tmMiniApp && typeof window.tmMiniApp.refreshProductionButtonState === 'function'
                ? window.tmMiniApp.refreshProductionButtonState
                : null;
            if (productionRefresh && button.hasAttribute('data-production-submit-button')) {
              productionRefresh();
            }
          }
        }
        tmMiniApp.setButtonLoading = setButtonLoading;

        function updateEvidenceSummary(card, evidenceCount, requiresEvidence) {
          if (!card) {
            return;
          }
          const summary = card.querySelector('[data-task-evidence-summary]');
          if (!summary) {
            return;
          }
          const count = typeof evidenceCount === 'number' ? evidenceCount : parseInt(card.getAttribute('data-task-evidence-count') || '0', 10);
          const requires = typeof requiresEvidence === 'boolean'
            ? requiresEvidence
            : card.getAttribute('data-task-requires-evidence') === 'true';
          card.setAttribute('data-task-evidence-count', String(count));
          card.setAttribute('data-task-requires-evidence', requires ? 'true' : 'false');
          let badgeLabel = '';
          let summaryText = '';
          let badgeTheme = 'neutral';
          if (count > 0) {
            badgeLabel = count + ' evidencia' + (count === 1 ? '' : 's');
            summaryText = badgeLabel + ' adjunta';
            if (requires) {
              summaryText += ' ¬∑ requisito cumplido';
            }
            badgeTheme = 'emerald';
          } else if (requires) {
            badgeLabel = 'Sin evidencia';
            summaryText = 'Requiere evidencia ¬∑ sin adjuntos';
            badgeTheme = 'critical';
          } else {
            badgeLabel = 'Sin evidencia';
            summaryText = 'Sin evidencia adjunta';
          }
          summary.textContent = summaryText;
          const evidenceBadge = card.querySelector('[data-task-evidence-badge]');
          if (evidenceBadge) {
            evidenceBadge.textContent = badgeLabel;
            applyBadgeTheme(evidenceBadge, badgeTheme);
          }
        }

        taskCards.forEach(function (card) {
          updateEvidenceSummary(card);
          const statusDetails = card.querySelector('[data-task-status-details]');
          if (statusDetails && !card.hasAttribute('data-initial-status-details')) {
            card.setAttribute('data-initial-status-details', statusDetails.textContent || '');
          }
          const noteValue = card.getAttribute('data-task-note-value') || '';
          if (card.getAttribute('data-task-status') === 'completed') {
            applyCompletedCardStyles(card, card.getAttribute('data-task-completed-on') || null, noteValue);
          } else {
            setNoteFieldState(card, false, noteValue);
          }
        });

        function parseJsonResponse(response) {
          return response
            .json()
            .catch(function () {
              return {};
            })
            .then(function (data) {
              return { ok: response.ok, status: response.status, data: data };
            });
        }
        tmMiniApp.parseJsonResponse = parseJsonResponse;

        function handleTaskComplete(card, button, title) {
          if (!card) {
            return;
          }
          const completeUrl = card.getAttribute('data-task-complete-url');
          if (!completeUrl) {
            showTaskFeedback(card, 'No encontramos la ruta para marcarla como completada.', 'error');
            return;
          }
          const requiresEvidence = card.getAttribute('data-task-requires-evidence') === 'true';
          const evidenceCount = parseInt(card.getAttribute('data-task-evidence-count') || '0', 10);
          if (requiresEvidence && !evidenceCount) {
            showTaskFeedback(card, 'Adjunta evidencia antes de completar la tarea.', 'error');
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
              telegram.HapticFeedback.notificationOccurred('error');
            }
            return;
          }
          const noteInput = card.querySelector('[data-task-note-input]');
          const noteValue = noteInput ? noteInput.value.trim() : '';
          const payload = noteInput ? { note: noteValue } : {};
          setButtonLoading(button, true, 'Procesando...');
          fetch(completeUrl, {
            method: 'POST',
            credentials: 'include',
            headers: Object.assign(
              { 'Content-Type': 'application/json' },
              csrfToken ? { 'X-CSRFToken': csrfToken } : {}
            ),
            body: JSON.stringify(payload),
          })
            .then(parseJsonResponse)
            .then(function (result) {
              if (!result.ok) {
                const errorMessage =
                  (result.data && result.data.error) || 'No se pudo completar la tarea. Intenta de nuevo.';
                showTaskFeedback(card, errorMessage, 'error');
                if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                  telegram.HapticFeedback.notificationOccurred('error');
                }
                return;
              }
              const data = result.data || {};
              const assignmentId = card.getAttribute('data-task-id') || data.assignment_id || null;
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                telegram.HapticFeedback.notificationOccurred('success');
              }
              showTaskFeedback(card, '¬°Tarea marcada como completada!', 'success');
              const completedOn = data.completed_on || null;
              const savedNote = typeof data.completion_note === 'string' ? data.completion_note : noteValue;
              const extra = { completedOn: completedOn, state: 'completed', note: savedNote };
              if (assignmentId) {
                extra.assignmentId = assignmentId;
              }
              if (completedOn) {
                card.setAttribute('data-task-completed-on', completedOn);
              }
              if (typeof data.reset_url === 'string') {
                card.setAttribute('data-task-reset-url', data.reset_url);
              }
              card.setAttribute('data-task-note-value', savedNote);
              applyCompletedCardStyles(card, completedOn, savedNote);
              sendTaskAction('complete', title, extra);
            })
            .catch(function (error) {
              console.warn('No se pudo completar la tarea:', error);
              showTaskFeedback(card, 'No se pudo completar la tarea. Intenta de nuevo.', 'error');
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                telegram.HapticFeedback.notificationOccurred('error');
              }
            })
            .finally(function () {
              setButtonLoading(button, false);
            });
        }

        function handleTaskReset(card, button, title) {
          if (!card) {
            return;
          }
          const resetUrl = card.getAttribute('data-task-reset-url');
          if (!resetUrl) {
            showTaskFeedback(card, 'No encontramos la ruta para reabrir la tarea.', 'error');
            return;
          }
          setButtonLoading(button, true, 'Procesando...');
          fetch(resetUrl, {
            method: 'POST',
            credentials: 'include',
            headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {},
            body: JSON.stringify({}),
          })
            .then(parseJsonResponse)
            .then(function (result) {
              if (!result.ok) {
                const errorMessage =
                  (result.data && result.data.error) || 'No se pudo reabrir la tarea. Intenta de nuevo.';
                showTaskFeedback(card, errorMessage, 'error');
                if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                  telegram.HapticFeedback.notificationOccurred('error');
                }
                return;
              }
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                telegram.HapticFeedback.notificationOccurred('success');
              }
              showTaskFeedback(card, 'La tarea volvi√≥ a estado pendiente.', 'success');
              const extra = { state: 'pending' };
              const assignmentId = card.getAttribute('data-task-id') || (result.data && result.data.assignment_id) || null;
              if (assignmentId) {
                extra.assignmentId = assignmentId;
              }
              const resetNoteValue =
                result.data && typeof result.data.completion_note === 'string' ? result.data.completion_note : '';
              card.setAttribute('data-task-note-value', resetNoteValue);
              applyPendingCardStyles(card, resetNoteValue);
              sendTaskAction('reset', title, extra);
            })
            .catch(function (error) {
              console.warn('No se pudo reabrir la tarea:', error);
              showTaskFeedback(card, 'No se pudo reabrir la tarea. Intenta de nuevo.', 'error');
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                telegram.HapticFeedback.notificationOccurred('error');
              }
            })
            .finally(function () {
              setButtonLoading(button, false);
            });
        }

        function handleEvidenceUpload(card, input) {
          if (!card || !input) {
            return;
          }
          const files = Array.prototype.slice.call(input.files || []);
          if (!files.length) {
            return;
          }
          const evidenceUrl = card.getAttribute('data-task-evidence-url');
          if (!evidenceUrl) {
            showTaskFeedback(card, 'No encontramos la ruta para subir la evidencia.', 'error');
            input.value = '';
            return;
          }
          const formData = new FormData();
          files.forEach(function (file) {
            formData.append('evidence', file);
          });
          if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
          }
          const evidenceButton = card.querySelector('[data-task-action="evidence"]');
          setButtonLoading(evidenceButton, true, 'Subiendo...');
          fetch(evidenceUrl, {
            method: 'POST',
            credentials: 'include',
            headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {},
            body: formData,
          })
            .then(parseJsonResponse)
            .then(function (result) {
              if (!result.ok) {
                const errorMessage =
                  (result.data && result.data.error) || 'No se pudo cargar la evidencia. Intenta de nuevo.';
                showTaskFeedback(card, errorMessage, 'error');
                if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                  telegram.HapticFeedback.notificationOccurred('error');
                }
                return;
              }
              const data = result.data || {};
              const previousCount = parseInt(card.getAttribute('data-task-evidence-count') || '0', 10);
              const evidenceCount =
                typeof data.evidence_count === 'number' ? data.evidence_count : previousCount + files.length;
              const requiresEvidence =
                typeof data.requires_evidence === 'boolean'
                  ? data.requires_evidence
                  : card.getAttribute('data-task-requires-evidence') === 'true';
              card.setAttribute('data-task-evidence-count', evidenceCount);
              card.setAttribute('data-task-requires-evidence', requiresEvidence ? 'true' : 'false');
              updateEvidenceSummary(card, evidenceCount, requiresEvidence);
              showTaskFeedback(card, '¬°Evidencia cargada!', 'success');
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                telegram.HapticFeedback.notificationOccurred('success');
              }
              const assignmentId = card.getAttribute('data-task-id') || data.assignment_id || null;
              const extra = { evidenceCount: evidenceCount };
              if (assignmentId) {
                extra.assignmentId = assignmentId;
              }
              if (data.files) {
                extra.files = data.files;
              }
              sendTaskAction('evidence', card.getAttribute('data-task-title') || '', extra);
            })
            .catch(function (error) {
              console.warn('No se pudo cargar la evidencia:', error);
              showTaskFeedback(card, 'No se pudo cargar la evidencia. Intenta nuevamente.', 'error');
              if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
                telegram.HapticFeedback.notificationOccurred('error');
              }
            })
            .finally(function () {
              setButtonLoading(evidenceButton, false);
              input.value = '';
            });
        }

        taskCards.forEach(function (card) {
          const evidenceInput = card.querySelector('[data-task-evidence-input]');
          if (evidenceInput) {
            evidenceInput.addEventListener('change', function () {
              handleEvidenceUpload(card, evidenceInput);
            });
          }
        });

        function bindTaskActionButton(button) {
          if (!button || button.__tmMiniAppActionBound) {
            return;
          }
          button.__tmMiniAppActionBound = true;
          button.addEventListener('click', function (event) {
            const action = event.currentTarget.getAttribute('data-task-action');
            const card = event.currentTarget.closest('[data-task-card]');
            const title = card ? card.getAttribute('data-task-title') : '';
            const isDisabled =
              event.currentTarget.disabled || event.currentTarget.getAttribute('data-task-disabled') === 'true';
            if (isDisabled) {
              event.preventDefault();
              return;
            }
            if (action === 'complete') {
              event.preventDefault();
              handleTaskComplete(card, event.currentTarget, title);
              return;
            }
            if (action === 'reset') {
              event.preventDefault();
              handleTaskReset(card, event.currentTarget, title);
              return;
            }
            if (action === 'evidence') {
              event.preventDefault();
              const input = card ? card.querySelector('[data-task-evidence-input]') : null;
              if (input) {
                input.click();
              }
              return;
            }
            let section = null;
            if (action === 'complete-production') {
              event.preventDefault();
              const submitProduction =
                window.tmMiniApp && typeof window.tmMiniApp.submitProduction === 'function'
                  ? window.tmMiniApp.submitProduction
                  : null;
              if (submitProduction) {
                submitProduction(event.currentTarget);
              }
              return;
            }
            if (action === 'log-production') {
              section = event.currentTarget.getAttribute('data-production-section') || 'consumption';
            }
            if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.impactOccurred) {
              telegram.HapticFeedback.impactOccurred('soft');
            }
            const extra = section ? { section: section } : undefined;
            sendTaskAction(action, title, extra);
          });
        }
        document.querySelectorAll('[data-task-action]').forEach(bindTaskActionButton);

        function clearShiftConfirmationState() {
          if (
            window.__miniAppShiftConfirmation &&
            typeof window.__miniAppShiftConfirmation.clear === 'function'
          ) {
            window.__miniAppShiftConfirmation.clear();
          }
        }

        function redirectToLogin() {
          clearShiftConfirmationState();
          if (loginUrl) {
            window.location.assign(loginUrl);
          } else {
            window.location.reload();
          }
        }
        tmMiniApp.redirectToLogin = redirectToLogin;

        function performLogout() {
          if (!logoutUrl) {
            return Promise.resolve();
          }

          const formData = new FormData();
          if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
          }

          return fetch(logoutUrl, {
            method: 'POST',
            credentials: 'include',
            headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {},
            body: formData,
          })
            .then(function (response) {
              if (!response.ok) {
                throw new Error('Logout request failed with status ' + response.status);
              }
            })
            .catch(function (error) {
              console.warn('No se pudo cerrar sesi√≥n mediante fetch.', error);
              clearShiftConfirmationState();
              if (logoutForm) {
                logoutForm.submit();
              } else if (logoutUrl) {
                window.location.assign(logoutUrl);
              }
              throw error;
            });
        }

        function updateTelegramMainButtonLoading(isLoading) {
          if (!mainButton) {
            return;
          }
          try {
            if (isLoading) {
              if (typeof mainButton.showProgress === 'function') {
                mainButton.showProgress();
              }
              if (typeof mainButton.disable === 'function') {
                mainButton.disable();
              }
            } else {
              if (typeof mainButton.hideProgress === 'function') {
                mainButton.hideProgress();
              }
              if (typeof mainButton.enable === 'function') {
                mainButton.enable();
              }
              if (typeof mainButton.show === 'function') {
                mainButton.show();
              }
            }
          } catch (error) {
            console.info('No se pudo actualizar el bot√≥n principal de Telegram.', error);
          }
        }

        function hideConfirmError() {
          if (confirmErrorNode) {
            confirmErrorNode.textContent = '';
            confirmErrorNode.classList.add('hidden');
          }
        }

        function showConfirmError(message) {
          if (confirmErrorNode) {
            confirmErrorNode.textContent = message;
            confirmErrorNode.classList.remove('hidden');
          }
          if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
            telegram.HapticFeedback.notificationOccurred('error');
          }
        }

        function setConfirmLoading(isLoading) {
          if (!confirmDialog) {
            return;
          }
          confirmDialog.setAttribute('aria-busy', isLoading ? 'true' : 'false');

          if (confirmAcceptButton) {
            confirmAcceptButton.disabled = isLoading;
            confirmAcceptButton.classList.toggle('opacity-70', isLoading);
            confirmAcceptButton.classList.toggle('cursor-not-allowed', isLoading);
            confirmAcceptButton.textContent = isLoading ? 'Cerrando tu turno...' : confirmAcceptDefaultLabel;
          }

          if (confirmCancelButton) {
            confirmCancelButton.disabled = isLoading;
            confirmCancelButton.classList.toggle('opacity-60', isLoading);
            confirmCancelButton.classList.toggle('cursor-not-allowed', isLoading);
            confirmCancelButton.textContent = confirmCancelDefaultLabel;
          }

          if (confirmStatusNode) {
            confirmStatusNode.classList.toggle('hidden', !isLoading);
          }

          updateTelegramMainButtonLoading(isLoading);
        }

        function closeDialogs() {
          if (!dialogRoot) {
            return;
          }
          activeDialog = null;
          dialogRoot.classList.add('hidden');
          dialogRoot.setAttribute('aria-hidden', 'true');
          if (confirmDialog) {
            confirmDialog.classList.add('hidden');
            confirmDialog.setAttribute('aria-hidden', 'true');
          }
          if (gratitudeDialog) {
            gratitudeDialog.classList.add('hidden');
            gratitudeDialog.setAttribute('aria-hidden', 'true');
          }
          if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
            lastFocusedElement.focus();
          }
          lastFocusedElement = null;
        }

        function openDialog(type) {
          if (!dialogRoot) {
            return false;
          }
          activeDialog = type;
          dialogRoot.classList.remove('hidden');
          dialogRoot.setAttribute('aria-hidden', 'false');
          if (!dialogRoot.classList.contains('flex')) {
            dialogRoot.classList.add('flex');
          }

          if (confirmDialog) {
            const isConfirm = type === 'confirm';
            confirmDialog.classList.toggle('hidden', !isConfirm);
            confirmDialog.setAttribute('aria-hidden', isConfirm ? 'false' : 'true');
          }

          if (gratitudeDialog) {
            const isGratitude = type === 'gratitude';
            gratitudeDialog.classList.toggle('hidden', !isGratitude);
            gratitudeDialog.setAttribute('aria-hidden', isGratitude ? 'false' : 'true');
          }

          window.requestAnimationFrame(function () {
            if (type === 'confirm' && confirmAcceptButton) {
              confirmAcceptButton.focus();
            } else if (type === 'gratitude' && gratitudeAcceptButton) {
              gratitudeAcceptButton.focus();
            }
          });

          return true;
        }

        function resetConfirmDialog() {
          hideConfirmError();
          setConfirmLoading(false);
        }

        function openConfirmDialog() {
          if (!confirmDialog || !dialogRoot) {
            return false;
          }
          lastFocusedElement = document.activeElement;
          resetConfirmDialog();
          const opened = openDialog('confirm');
          if (opened && telegram && telegram.HapticFeedback && telegram.HapticFeedback.impactOccurred) {
            telegram.HapticFeedback.impactOccurred('soft');
          }
          return opened;
        }

        function openGratitudeDialog() {
          if (!gratitudeDialog || !dialogRoot) {
            redirectToLogin();
            return;
          }
          openDialog('gratitude');
          if (telegram && telegram.HapticFeedback && telegram.HapticFeedback.notificationOccurred) {
            telegram.HapticFeedback.notificationOccurred('success');
          }
        }

        function beginLogoutFlow() {
          if (isProcessingMainAction) {
            return;
          }
          isProcessingMainAction = true;
          hideConfirmError();
          setConfirmLoading(true);

          Promise.resolve()
            .then(function () {
              return performLogout();
            })
            .then(function () {
              isProcessingMainAction = false;
              setConfirmLoading(false);
              clearShiftConfirmationState();
              openGratitudeDialog();
            })
            .catch(function (error) {
              isProcessingMainAction = false;
              setConfirmLoading(false);
              showConfirmError('No pudimos cerrar tu turno. Int√©ntalo nuevamente.');
              console.warn('Ocurri√≥ un problema al completar el turno.', error);
            });
        }

        function handleCompleteShift() {
          if (openConfirmDialog()) {
            return;
          }

          const proceed = function () {
            beginLogoutFlow();
          };

          if (telegram && typeof telegram.showConfirm === 'function') {
            telegram.showConfirm(confirmMessageText, function (accepted) {
              if (accepted) {
                proceed();
              }
            });
            return;
          }

          if (window.confirm(confirmMessageText)) {
            proceed();
          }
        }

        function setupTelegramMainButton() {
          if (!mainButton) {
            return;
          }

          try {
            if (typeof mainButton.setParams === 'function') {
              mainButton.setParams({
                text: 'Finalizar mi turno',
                color: '#fcd34d',
                text_color: '#0f172a',
                is_active: true,
                is_visible: true,
              });
            } else {
              if (typeof mainButton.setText === 'function') {
                mainButton.setText('Finalizar mi turno');
              }
              if ('color' in mainButton) {
                mainButton.color = '#fcd34d';
              }
              if ('textColor' in mainButton) {
                mainButton.textColor = '#0f172a';
              }
            }
            if (typeof mainButton.show === 'function') {
              mainButton.show();
            }
            if (typeof mainButton.onClick === 'function') {
              mainButton.onClick(handleCompleteShift);
            }
          } catch (error) {
            console.info('No se pudo configurar el bot√≥n principal de Telegram.', error);
            return;
          }

          if (fallbackActionContainer) {
            fallbackActionContainer.setAttribute('aria-hidden', 'true');
            fallbackActionContainer.classList.add('pointer-events-none', 'opacity-0', 'hidden');
          } else if (mainAction) {
            mainAction.setAttribute('tabindex', '-1');
            mainAction.setAttribute('aria-hidden', 'true');
            mainAction.classList.add('pointer-events-none', 'opacity-0', 'hidden');
          }
        }

        finishTriggers.forEach(function (trigger) {
          trigger.addEventListener('click', function (event) {
            if (event && typeof event.preventDefault === 'function') {
              event.preventDefault();
              event.stopPropagation();
            }
            handleCompleteShift();
          });
        });

        if (confirmAcceptButton) {
          confirmAcceptButton.addEventListener('click', function () {
            beginLogoutFlow();
          });
        }

        if (confirmCancelButton) {
          confirmCancelButton.addEventListener('click', function () {
            if (!isProcessingMainAction) {
              closeDialogs();
            }
          });
        }

        if (dialogRoot) {
          dialogRoot.addEventListener('click', function (event) {
            if (event.target === dialogRoot && activeDialog === 'confirm' && !isProcessingMainAction) {
              closeDialogs();
            }
          });

          document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape' && activeDialog === 'confirm' && !isProcessingMainAction) {
              event.preventDefault();
              closeDialogs();
            }
          });
        }

        if (gratitudeAcceptButton) {
          gratitudeAcceptButton.addEventListener('click', function () {
            gratitudeAcceptButton.disabled = true;
            gratitudeAcceptButton.classList.add('opacity-80');
            gratitudeAcceptButton.textContent = 'Redirigiendo...';
            redirectToLogin();
          });
        }

        setupTelegramMainButton();
      })();
    </script>
    <script>
      (function () {
        const pushButton = document.querySelector('[data-enable-push]');
        if (!pushButton) {
          return;
        }

        const hasBrowserSupport = 'Notification' in window && 'serviceWorker' in navigator;
        const labelNode = pushButton.querySelector('[data-push-label]');
        const pushIcon = pushButton.querySelector('[data-push-icon]');
        const disableButton = document.querySelector('[data-disable-push]');
        const defaultAnnouncement = (labelNode && labelNode.textContent) || 'Notificaciones desactivadas';
        const variantButtonClasses = [
          'text-rose-600',
          'text-emerald-600',
          'text-amber-600',
          'border-rose-200',
          'border-emerald-200',
          'border-amber-200',
          'shadow-rose-100/70',
          'shadow-emerald-100/70',
          'shadow-amber-100/70',
          'hover:border-rose-300',
          'hover:border-emerald-200',
          'hover:border-amber-200',
          'hover:text-rose-700',
          'hover:text-emerald-700',
          'hover:text-amber-700',
        ];
        const variantIconClasses = ['text-rose-600', 'text-emerald-600', 'text-amber-600'];
        const stateStyles = {
          idle: {
            button: ['text-rose-600', 'border-rose-200', 'shadow-rose-100/70', 'hover:border-rose-300', 'hover:text-rose-700'],
            icon: 'text-rose-600',
            announce: 'Notificaciones desactivadas. Pulsa para activarlas.',
            disabled: false,
          },
          loading: {
            button: ['text-amber-600', 'border-amber-200', 'shadow-amber-100/70', 'hover:border-amber-200', 'hover:text-amber-700'],
            icon: 'text-amber-600',
            announce: 'Activando notificaciones‚Ä¶',
            disabled: true,
          },
          active: {
            button: ['text-emerald-600', 'border-emerald-200', 'shadow-emerald-100/70', 'hover:border-emerald-200', 'hover:text-emerald-700'],
            icon: 'text-emerald-600',
            announce: 'Notificaciones activadas.',
            disabled: true,
          },
          error: {
            button: ['text-rose-600', 'border-rose-200', 'shadow-rose-100/70', 'hover:border-rose-300', 'hover:text-rose-700'],
            icon: 'text-rose-600',
            announce: 'No se pudo activar. Intenta nuevamente.',
            disabled: false,
          },
        };

        function applyVisualState(stateKey, overrideAnnouncement) {
          const style = stateStyles[stateKey] || stateStyles.idle;
          pushButton.classList.remove(...variantButtonClasses);
          pushButton.classList.add(...style.button);
          if (pushIcon) {
            pushIcon.classList.remove(...variantIconClasses);
            pushIcon.classList.add(style.icon);
          }
          const announcement = overrideAnnouncement || style.announce || defaultAnnouncement;
          if (labelNode) {
            labelNode.textContent = announcement;
          }
          pushButton.disabled = Boolean(style.disabled);
          if (disableButton) {
            disableButton.hidden = stateKey !== 'active';
          }
        }

        function waitForBridge() {
          return new Promise((resolve, reject) => {
            if (window.PWABridge && typeof window.PWABridge.ensurePushSubscription === 'function') {
              resolve(window.PWABridge);
              return;
            }
            const handler = function () {
              if (window.PWABridge && typeof window.PWABridge.ensurePushSubscription === 'function') {
                resolve(window.PWABridge);
              } else {
                reject(new Error('Bridge no disponible'));
              }
            };
            window.addEventListener('pwa:service-worker-registered', handler, { once: true });
            setTimeout(() => reject(new Error('Timeout esperando el Service Worker')), 8000);
          });
        }

        async function ensureSubscription() {
          applyVisualState('loading');
          try {
            const bridge = await waitForBridge();
            await bridge.ensurePushSubscription();
            applyVisualState('active');
          } catch (error) {
            console.error('No se pudo registrar la suscripci√≥n push.', error);
            applyVisualState('error');
          }
        }

        async function requestPermission() {
          if (!hasBrowserSupport) {
            applyVisualState('error', 'Este dispositivo no soporta notificaciones.');
            return;
          }
          if (Notification.permission === 'granted') {
            ensureSubscription();
            return;
          }
          let permission;
          try {
            permission = await Notification.requestPermission();
          } catch (error) {
            console.error('No se pudo solicitar el permiso de notificaciones.', error);
            applyVisualState('error', 'No pudimos solicitar permisos autom√°ticamente.');
            return;
          }
          if (permission === 'granted') {
            ensureSubscription();
            return;
          }
          if (permission === 'denied') {
            applyVisualState('error', 'Debes permitir notificaciones en el navegador.');
          } else {
            applyVisualState('idle', 'Permiso pendiente. Vuelve a intentarlo.');
          }
        }

        function bootstrapPushRegistration() {
          if (!hasBrowserSupport) {
            applyVisualState('error', 'Notificaciones no soportadas.');
            return;
          }

          if (Notification.permission === 'granted') {
            applyVisualState('loading', 'Verificando suscripci√≥n‚Ä¶');
            ensureSubscription();
            return;
          }

          if (Notification.permission === 'default') {
            applyVisualState('loading', 'Solicitando permiso para notificaciones‚Ä¶');
            requestPermission();
            return;
          }

          applyVisualState('error', 'Debes permitir notificaciones en el navegador.');
        }

        bootstrapPushRegistration();

        pushButton.addEventListener('click', function () {
          requestPermission();
        });

        if (disableButton) {
          disableButton.addEventListener('click', async function () {
            if (!hasBrowserSupport) {
              return;
            }
            pushButton.disabled = true;
            if (labelNode) {
              labelNode.textContent = 'Desactivando notificaciones‚Ä¶';
            }
            try {
              const registration = await navigator.serviceWorker.ready;
              const current = await registration.pushManager.getSubscription();
              if (current) {
                await current.unsubscribe();
              }
              applyVisualState('idle');
            } catch (error) {
              console.warn('No se pudo cancelar la suscripci√≥n push.', error);
              applyVisualState('error', 'No pudimos suspenderla. Intenta nuevamente.');
            }
          });
        }
      })();
    </script>
    <script src="{% static 'task_manager/js/night_mortality_card.js' %}" defer></script>
    <script src="{% static 'task_manager/js/production_card.js' %}" defer></script>
    <script src="{% static 'task_manager/js/purchase_cards.js' %}" defer></script>
    {% endif %}
    <script>
      window.PWAPushConfig = Object.assign(window.PWAPushConfig || {}, {
        debug: {% if mini_app_pwa_config.debug %}true{% else %}false{% endif %},
        vapidPublicKey: "{{ mini_app_pwa_config.vapid_public_key|default_if_none:''|escapejs }}",
        subscriptionEndpoint: "{{ mini_app_pwa_config.subscription_endpoint|default_if_none:''|escapejs }}",
      });
    </script>
    <script src="{% static 'task_manager/pwa/pwa-init.js' %}" defer></script>
  </body>
</html>
