{% extends "calendario/base.html" %}

{% block title %}Gestor de tareas{% endblock %}

{% block content %}
  <style>
    [data-task-description] {
      display: none;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .tm-description-popover {
      position: absolute;
      z-index: 70;
      display: none;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background-color: #fff;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18), 0 4px 12px rgba(15, 23, 42, 0.1);
      padding: 1rem 1.25rem;
      color: rgb(71, 85, 105);
      font-size: 0.9rem;
      line-height: 1.6;
      max-width: 90vw;
      white-space: pre-wrap;
      word-break: break-word;
      transform-origin: top center;
    }

    .tm-description-popover::before {
      content: '';
      position: absolute;
      top: -6px;
      left: var(--tm-popover-arrow-left, 56px);
      width: 12px;
      height: 12px;
      background: #fff;
      border-left: 1px solid rgba(148, 163, 184, 0.35);
      border-top: 1px solid rgba(148, 163, 184, 0.35);
      transform: rotate(45deg);
      box-shadow: -2px -2px 6px rgba(15, 23, 42, 0.08);
    }

    .tm-description-popover p:not(:last-child) {
      margin-bottom: 0.75rem;
    }

    .tm-description-popover[data-placement='top']::before {
      top: auto;
      bottom: -6px;
      border-top: none;
      border-left: none;
      border-right: 1px solid rgba(148, 163, 184, 0.35);
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 2px 2px 6px rgba(15, 23, 42, 0.08);
    }

    .tm-filter-picker {
      position: relative;
      width: 100%;
    }

    .tm-filter-picker[data-open='true'] {
      z-index: 80;
    }

    .tm-filter-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      width: 100%;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background-color: rgba(255, 255, 255, 0.96);
      padding: 0.65rem 0.95rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: rgb(71, 85, 105);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      transition: border-color 150ms ease, box-shadow 150ms ease, color 150ms ease;
      cursor: pointer;
    }

    .tm-filter-trigger:hover,
    .tm-filter-trigger[data-hover='true'] {
      border-color: rgba(59, 130, 246, 0.45);
      color: rgb(15, 23, 42);
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.08);
    }

    .tm-filter-picker[data-disabled='true'] .tm-filter-trigger,
    .tm-filter-trigger[disabled] {
      cursor: not-allowed;
      border-color: rgba(148, 163, 184, 0.35);
      background-color: rgba(248, 250, 252, 0.85);
      color: rgba(71, 85, 105, 0.6);
      box-shadow: none;
      opacity: 0.75;
    }

    .tm-filter-picker[data-disabled='true'] .tm-filter-trigger:hover,
    .tm-filter-trigger[disabled]:hover,
    .tm-filter-picker[data-disabled='true'] .tm-filter-trigger[data-hover='true'] {
      border-color: rgba(148, 163, 184, 0.35);
      color: rgba(71, 85, 105, 0.6);
      box-shadow: none;
    }

    .tm-filter-trigger:focus-visible {
      outline: none;
      border-color: rgba(59, 130, 246, 0.55);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    .tm-filter-trigger-text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.2rem;
    }

    .tm-filter-trigger-label {
      color: inherit;
      font-weight: 600;
    }

    .tm-filter-trigger-description {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(100, 116, 139, 0.75);
    }

    .tm-filter-panel {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 0.55rem);
      z-index: 60;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background-color: rgba(255, 255, 255, 0.98);
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.18), 0 6px 16px rgba(15, 23, 42, 0.12);
      backdrop-filter: blur(6px);
      overflow: hidden;
    }

    .tm-filter-search {
      padding: 0.55rem 0.85rem 0.4rem;
      background-color: rgba(241, 245, 249, 0.65);
      border-bottom: 1px solid rgba(226, 232, 240, 0.7);
    }

    .tm-filter-search-field {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 0.85rem;
      border: 1px solid rgba(203, 213, 225, 0.6);
      background-color: #fff;
      padding: 0.45rem 0.75rem;
      font-size: 0.8rem;
      color: rgba(71, 85, 105, 0.9);
    }

    .tm-filter-search-field:focus-within {
      border-color: rgba(59, 130, 246, 0.45);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.12);
    }

    .tm-filter-search-input {
      width: 100%;
      border: 0;
      outline: 0;
      background: transparent;
      font-size: 0.8rem;
      color: inherit;
    }

    .tm-sort-trigger {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      width: 100%;
      padding: 0;
      margin: 0;
      border: 0;
      background: transparent;
      font: inherit;
      color: inherit;
      letter-spacing: inherit;
      text-transform: inherit;
      text-align: left;
      cursor: pointer;
    }

    .tm-sort-trigger:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
      border-radius: 9999px;
    }

    .tm-sort-trigger[data-active='true'] {
      color: rgb(15, 23, 42);
    }

    .tm-sort-icon {
      width: 0.75rem;
      height: 0.75rem;
      opacity: 0;
      transform: rotate(0deg);
      transition: opacity 150ms ease, transform 150ms ease;
    }

    [data-sort-state='asc'] .tm-sort-icon,
    [data-sort-state='desc'] .tm-sort-icon {
      opacity: 1;
    }

    [data-sort-state='desc'] .tm-sort-icon {
      transform: rotate(180deg);
    }

    .tm-sort-trigger:hover .tm-sort-icon {
      opacity: 1;
    }

    .tm-row-handle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      flex-shrink: 0;
      border-radius: 9999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background-color: rgba(248, 250, 252, 0.95);
      color: rgba(100, 116, 139, 0.9);
      cursor: grab;
      transition: border-color 150ms ease, background-color 150ms ease, color 150ms ease, box-shadow 150ms ease;
      touch-action: none;
    }

    .tm-row-handle:hover,
    .tm-row-handle:focus-visible {
      border-color: rgba(59, 130, 246, 0.55);
      background-color: rgba(59, 130, 246, 0.12);
      color: rgb(37, 99, 235);
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
    }

    .tm-row-handle:active,
    .tm-row-handle[data-dragging='true'] {
      cursor: grabbing;
      border-color: rgba(59, 130, 246, 0.65);
      color: rgb(29, 78, 216);
      background-color: rgba(59, 130, 246, 0.2);
    }

    .tm-row-handle-icon {
      display: inline-flex;
      flex-direction: column;
      gap: 0.18rem;
    }

    .tm-row-handle-icon span {
      display: block;
      width: 0.3rem;
      height: 0.3rem;
      border-radius: 9999px;
      background-color: currentColor;
    }

    tr[data-task-definition-row] {
      transition: transform 180ms ease, box-shadow 180ms ease, background-color 180ms ease, border-color 180ms ease;
    }

    tr[data-task-definition-row][data-row-dragging='true'] {
      transform: scale(1.01);
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.18);
      background-color: rgba(59, 130, 246, 0.08);
      border-color: rgba(59, 130, 246, 0.4);
    }

    tr[data-task-definition-row][data-row-just-dropped='true'] {
      animation: tmRowDropFlash 1100ms ease-out 1;
    }

    @keyframes tmRowDropFlash {
      0% {
        background-color: rgba(59, 130, 246, 0.2);
        box-shadow: 0 18px 36px rgba(59, 130, 246, 0.18);
      }
      40% {
        background-color: rgba(59, 130, 246, 0.1);
        box-shadow: 0 12px 28px rgba(59, 130, 246, 0.12);
      }
      100% {
        background-color: transparent;
        box-shadow: none;
      }
    }

    .tm-reorder-tooltip {
      position: absolute;
      z-index: 160;
      padding: 0.45rem 0.75rem;
      border-radius: 0.75rem;
      background-color: rgb(15, 23, 42);
      color: #fff;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      pointer-events: none;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.24);
      opacity: 0;
      transform: translateY(-6px);
      animation: tmTooltipFade 180ms ease forwards;
    }

    @keyframes tmTooltipFade {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    body.tm-no-select {
      user-select: none;
    }

    .tm-filter-options {
      max-height: 18rem;
      overflow-y: auto;
      padding: 0.4rem 0.5rem 0.6rem;
    }

    .tm-filter-group {
      padding: 0.45rem 0.35rem;
    }

    .tm-filter-group-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(100, 116, 139, 0.75);
      padding: 0 0.7rem 0.35rem;
    }

    .tm-filter-options-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.25rem;
    }

    .tm-filter-option {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.15rem;
      border: 0;
      border-radius: 0.85rem;
      padding: 0.55rem 0.85rem;
      background: transparent;
      color: rgb(71, 85, 105);
      font-size: 0.9rem;
      font-weight: 500;
      text-align: left;
      transition: background-color 120ms ease, color 120ms ease, box-shadow 120ms ease;
      cursor: pointer;
    }

    .tm-filter-option:hover,
    .tm-filter-option:focus-visible {
      outline: none;
      background-color: rgba(59, 130, 246, 0.08);
      color: rgb(30, 64, 175);
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.08);
    }

    .tm-filter-option.is-selected {
      background-color: rgba(59, 130, 246, 0.12);
      color: rgb(30, 64, 175);
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.14);
    }

    .tm-filter-option-label {
      font-weight: 600;
    }

    .tm-filter-option-description {
      font-size: 0.75rem;
      color: rgba(100, 116, 139, 0.75);
    }

    .tm-filter-empty {
      padding: 0.9rem 1.1rem;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(148, 163, 184, 0.8);
    }

    .tm-filter-chevron-rotated {
      transform: rotate(180deg);
    }

    tr[data-task-group-row] > td {
      padding: 0;
      border-top: 1px solid rgba(226, 232, 240, 0.85);
    }

    tr[data-task-group-row]:first-child > td {
      border-top: none;
    }

    tr[data-task-group-row][data-group-level='primary'] > td {
      background: linear-gradient(90deg, rgba(248, 250, 252, 0.96), rgba(241, 245, 249, 0.9));
    }

    tr[data-task-group-row][data-group-level='secondary'] > td {
      background: linear-gradient(90deg, rgba(248, 250, 252, 0.9), rgba(241, 245, 249, 0.85));
      border-left: 2px solid rgba(59, 130, 246, 0.14);
    }

    .tm-group-toggle {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      width: 100%;
      border: 0;
      background: none;
      padding: 0.7rem 1rem;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 600;
      color: rgb(71, 85, 105);
      cursor: pointer;
      transition: background-color 150ms ease, color 150ms ease, box-shadow 150ms ease;
    }

    .tm-group-toggle:hover,
    .tm-group-toggle:focus-visible {
      background-color: rgba(59, 130, 246, 0.08);
      color: rgb(30, 41, 59);
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.08);
    }

    .tm-group-toggle-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 9999px;
      background-color: rgba(15, 23, 42, 0.08);
      color: rgba(15, 23, 42, 0.6);
      transition: transform 180ms ease, background-color 180ms ease, color 180ms ease;
      flex-shrink: 0;
    }

    .tm-group-toggle-icon svg {
      width: 0.75rem;
      height: 0.75rem;
      transition: transform 180ms ease;
    }

    tr[data-task-group-row][data-group-collapsed='false'] .tm-group-toggle-icon {
      background-color: rgba(59, 130, 246, 0.14);
      color: rgba(30, 64, 175, 0.95);
    }

    tr[data-task-group-row][data-group-collapsed='false'] .tm-group-toggle-icon svg {
      transform: rotate(90deg);
    }

    .tm-group-text {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      flex: 1 1 auto;
    }

    .tm-group-dimension {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(100, 116, 139, 0.75);
    }

    .tm-group-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: rgb(15, 23, 42);
    }

    .tm-group-subtitle {
      font-size: 0.75rem;
      color: rgba(71, 85, 105, 0.85);
    }

    .tm-group-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.65rem;
      border-radius: 9999px;
      background-color: rgba(59, 130, 246, 0.12);
      color: rgba(30, 64, 175, 0.95);
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    tr[data-task-group-row][data-group-level='secondary'] .tm-group-toggle {
      padding-left: 2.25rem;
    }

    @media (max-width: 640px) {
      .tm-filter-panel {
        max-width: min(100vw - 2rem, 22rem);
      }
      .tm-group-toggle {
        padding-inline: 0.75rem;
      }
      tr[data-task-group-row][data-group-level='secondary'] .tm-group-toggle {
        padding-left: 1.8rem;
      }
      .tm-group-label {
        font-size: 0.85rem;
      }
      .tm-group-count {
        font-size: 0.7rem;
      }
    }
  </style>
  <div class="space-y-10">
    <section data-tm-tabs class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <nav class="flex flex-wrap items-center gap-2 text-sm font-medium text-slate-500">
        <button data-tm-tab="tareas" class="tab-button rounded-full bg-slate-900 px-4 py-2 text-white shadow-sm transition hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand" aria-selected="true">Tareas</button>
        <button data-tm-tab="asignaciones" class="tab-button rounded-full px-4 py-2 text-slate-400 bg-slate-100 opacity-60 cursor-not-allowed pointer-events-none" aria-selected="false" disabled aria-disabled="true">Asignaciones diarias</button>
        <button data-tm-tab="seguimiento" class="tab-button rounded-full px-4 py-2 text-slate-400 bg-slate-100 opacity-60 cursor-not-allowed pointer-events-none" aria-selected="false" disabled aria-disabled="true">Seguimiento &amp; análisis</button>
        <a href="{% url 'task_manager:telegram-mini-app' %}" target="_blank" rel="noopener noreferrer" class="tab-button rounded-full px-4 py-2 transition hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand">Vista operario</a>
      </nav>

      <div class="space-y-12">
        <article id="tm-tareas" data-tm-panel="tareas" class="space-y-10">
          <section class="space-y-6">
            <header class="flex flex-wrap items-center justify-between gap-4">
            </header>
            <form method="get" class="flex flex-col gap-6 rounded-2xl border border-slate-200 bg-white/80 p-5 text-sm text-slate-600 shadow-sm backdrop-blur" data-task-definition-filter-form>
              <input type="hidden" name="tm_tab" value="tareas" />
              {% if request.GET.tm_task %}
                <input type="hidden" name="tm_task" value="{{ request.GET.tm_task }}" />
              {% endif %}
              <section class="flex flex-col gap-4 rounded-xl border border-slate-200 bg-slate-50/60 p-4" aria-labelledby="tm-task-filters-heading">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div class="flex flex-wrap items-center gap-2">
                    <span class="tm-badge-neutral">Filtros</span>
                    <span id="tm-task-filters-heading" class="text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-slate-400"></span>
                    {% if task_definition_filters_applied %}
                      <div class="flex flex-wrap items-center gap-2 text-xs font-semibold text-slate-500">
                        {% for filter in task_definition_active_filters %}
                          <a
                            href="{{ filter.remove_url }}"
                            class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600 shadow-sm transition hover:border-brand hover:text-brand"
                          >
                            <span>{{ filter.label }}:</span>
                            <span class="text-slate-900">{{ filter.display_value }}</span>
                            <span aria-hidden="true" class="text-slate-400">&times;</span>
                            <span class="sr-only">Quitar filtro {{ filter.label }}</span>
                          </a>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <a
                    href="{{ task_definition_clear_filters_url }}"
                    class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-[0.7rem] font-semibold uppercase tracking-wide text-slate-500 shadow-sm transition hover:border-brand hover:text-brand {% if not task_definition_filters_applied %}pointer-events-none opacity-60{% endif %}"
                    {% if not task_definition_filters_applied %}aria-disabled="true" tabindex="-1"{% endif %}
                  >
                    Limpiar filtros
                  </a>
                </div>
                <div class="grid gap-4 sm:gap-5 grid-cols-1 md:grid-cols-2 lg:grid-cols-6">
                  <fieldset class="space-y-3">
                    <legend class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-400">Estado</legend>
                    {% with config=task_manager_status_filter %}
                      {% include "task_manager/includes/filter_picker.html" with name="status" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                    {% endwith %}
                  </fieldset>

                  <fieldset class="space-y-3">
                    <legend class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-400">Categoría</legend>
                    {% with config=task_manager_category_filter %}
                      {% include "task_manager/includes/filter_picker.html" with name="category" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                    {% endwith %}
                  </fieldset>

                  <fieldset class="space-y-3">
                    <legend class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-400">Cobertura</legend>
                    {% with config=task_manager_scope_filter %}
                      {% include "task_manager/includes/filter_picker.html" with name="scope" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                    {% endwith %}
                  </fieldset>

                  <fieldset class="space-y-3">
                    <legend class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-400">Responsable sugerido</legend>
                    {% with config=task_manager_responsible_filter %}
                      {% include "task_manager/includes/filter_picker.html" with name="responsible" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                    {% endwith %}
                  </fieldset>

                  <fieldset class="space-y-3">
                    <legend class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-400">Fecha programada</legend>
                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3">
                      <label class="flex flex-1 items-center gap-2 text-xs font-semibold uppercase tracking-[0.18em] text-slate-400">
                        <span class="whitespace-nowrap">Desde</span>
                        <input
                          type="date"
                          name="scheduled_start"
                          value="{{ task_manager_schedule_filter.start_value }}"
                          class="flex-1 h-11 rounded-full border border-slate-200 bg-white px-3 text-sm font-normal uppercase tracking-normal text-slate-600 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/20"
                          data-schedule-filter-start
                        />
                      </label>
                      <label class="flex flex-1 items-center gap-2 text-xs font-semibold uppercase tracking-[0.18em] text-slate-400">
                        <span class="whitespace-nowrap">Hasta</span>
                        <input
                          type="date"
                          name="scheduled_end"
                          value="{{ task_manager_schedule_filter.end_value }}"
                          class="flex-1 h-11 rounded-full border border-slate-200 bg-white px-3 text-sm font-normal uppercase tracking-normal text-slate-600 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/20"
                          data-schedule-filter-end
                        />
                      </label>
                    </div>
                  </fieldset>
                </div>
              </section>

              <div class="border-t border-dashed border-slate-200/70"></div>

              <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2 text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-slate-400">
                  <span class="tm-badge-neutral">Agrupación</span>
                </div>
                <fieldset class="flex min-w-[170px] basis-[220px] flex-none flex-col gap-1 self-stretch justify-center">
                  {% with config=task_manager_group_primary_filter %}
                    {% include "task_manager/includes/filter_picker.html" with name="group_primary" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                  {% endwith %}
                </fieldset>

                <fieldset class="flex min-w-[170px] basis-[220px] flex-none flex-col gap-1 self-stretch justify-center" data-group-secondary-fieldset>
                  {% with config=task_manager_group_secondary_filter %}
                    {% include "task_manager/includes/filter_picker.html" with name="group_secondary" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                  {% endwith %}
                </fieldset>

                <fieldset class="flex min-w-[220px] flex-1 flex-col gap-2 self-stretch justify-center">
                  <div class="flex h-full flex-wrap items-center gap-2">
                    <button
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-slate-500 shadow-sm transition hover:border-brand hover:text-brand"
                      data-group-preset="status-responsible"
                    >
                      Estado → Responsable
                    </button>
                    <button
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-slate-500 shadow-sm transition hover:border-brand hover:text-brand"
                      data-group-preset="category-scope"
                    >
                      Categoría → Lugar
                    </button>
                    <button
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-slate-500 shadow-sm transition hover:border-brand hover:text-brand"
                      data-group-preset="scope-task_type"
                    >
                      Lugar → Planificación
                    </button>
                  </div>
                </fieldset>

                <div class="ml-auto flex-none self-center">
                  <button
                    type="button"
                    class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-[0.7rem] font-semibold uppercase tracking-wide text-slate-500 shadow-sm transition hover:border-brand hover:text-brand"
                    data-group-clear
                    data-disabled-label="true"
                  >
                    Limpiar agrupación
                  </button>
                </div>
              </div>
            </form>

            <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
                <table class="min-w-full divide-y divide-slate-200 text-sm leading-6 sm:text-[0.95rem]">
                  <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
                    <tr>
                      <th scope="col" class="px-5 py-4 text-left" data-sort-key="name" aria-sort="none">
                        <button type="button" class="tm-sort-trigger" data-sort-trigger>
                          <span>Tarea</span>
                          <svg class="tm-sort-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path
                              fill-rule="evenodd"
                              d="M10 6.75a.75.75 0 01.53.22l4 4a.75.75 0 11-1.06 1.06L10 8.31l-3.47 3.72a.75.75 0 11-1.06-1.06l4-4A.75.75 0 0110 6.75z"
                              clip-rule="evenodd"
                            ></path>
                          </svg>
                        </button>
                      </th>
                      <th scope="col" class="px-5 py-4 text-left" data-sort-key="scope" aria-sort="none">
                        <button type="button" class="tm-sort-trigger" data-sort-trigger>
                          <span>Lugar</span>
                          <svg class="tm-sort-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path
                              fill-rule="evenodd"
                              d="M10 6.75a.75.75 0 01.53.22l4 4a.75.75 0 11-1.06 1.06L10 8.31l-3.47 3.72a.75.75 0 11-1.06-1.06l4-4A.75.75 0 0110 6.75z"
                              clip-rule="evenodd"
                            ></path>
                          </svg>
                        </button>
                      </th>
                      <th scope="col" class="px-5 py-4 text-left" data-sort-key="schedule" aria-sort="none">
                        <button type="button" class="tm-sort-trigger" data-sort-trigger>
                          <span>Programación</span>
                          <svg class="tm-sort-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path
                              fill-rule="evenodd"
                              d="M10 6.75a.75.75 0 01.53.22l4 4a.75.75 0 11-1.06 1.06L10 8.31l-3.47 3.72a.75.75 0 11-1.06-1.06l4-4A.75.75 0 0110 6.75z"
                              clip-rule="evenodd"
                            ></path>
                          </svg>
                        </button>
                      </th>
                      <th scope="col" class="px-5 py-4 text-left" data-sort-key="responsible" aria-sort="none">
                        <button type="button" class="tm-sort-trigger" data-sort-trigger>
                          <span>Responsable sugerido</span>
                          <svg class="tm-sort-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path
                              fill-rule="evenodd"
                              d="M10 6.75a.75.75 0 01.53.22l4 4a.75.75 0 11-1.06 1.06L10 8.31l-3.47 3.72a.75.75 0 11-1.06-1.06l4-4A.75.75 0 0110 6.75z"
                              clip-rule="evenodd"
                            ></path>
                          </svg>
                        </button>
                      </th>
                      <th scope="col" class="px-5 py-4 text-left">Controles</th>
                    </tr>
                  </thead>
                  <tbody
                    class="divide-y divide-slate-100 text-slate-700"
                    data-task-definition-list
                    data-fetch-url="{% url 'task_manager:definition-rows' %}"
                    data-querystring="{{ task_definition_querystring }}"
                    data-current-page="{{ task_definition_page_obj.number }}"
                    data-next-page="{% if task_definition_page_obj.has_next %}{{ task_definition_page_obj.next_page_number }}{% endif %}"
                    data-has-next="{{ task_definition_page_obj.has_next|yesno:'true,false' }}"
                    data-total-count="{{ task_definition_total_count }}"
                    data-start-index="{{ task_definition_page_start }}"
                    data-end-index="{{ task_definition_page_end }}"
                    data-page-size="{{ task_definition_paginator.per_page }}"
                    data-group-primary="{{ task_definition_group_primary|default:'none' }}"
                    data-group-secondary="{{ task_definition_group_secondary|default:'none' }}"
                    data-column-count="5"
                    data-default-sort-key="order"
                    data-default-sort-direction="asc"
                    data-sort-key="order"
                    data-sort-direction="asc"
                    data-reorder-url="{% url 'task_manager:definition-reorder' %}"
                  >
                    {% if task_definition_rows %}
                      {% include "task_manager/includes/task_definition_rows.html" with rows=task_definition_rows %}
                    {% else %}
                      <tr data-task-definition-empty>
                        <td colspan="5" class="px-4 py-12 text-center text-sm text-slate-500">
                          Aún no has creado tareas.
                        </td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
                <div class="flex flex-col gap-3 border-t border-slate-200 bg-slate-50/80 px-5 py-4 text-xs text-slate-500 sm:flex-row sm:items-center sm:justify-between sm:text-sm">
                  <p
                    data-task-definition-summary
                    data-total-count="{{ task_definition_total_count }}"
                    data-summary-start="{{ task_definition_page_start }}"
                    data-summary-end="{{ task_definition_page_end }}"
                  >
                    {% if task_definition_total_count %}
                      Mostrando <span data-task-summary-start>{{ task_definition_page_start }}</span>&ndash;<span data-task-summary-end>{{ task_definition_page_end }}</span> de <span data-task-summary-total>{{ task_definition_total_count }}</span> tareas.
                    {% else %}
                      No hay tareas para mostrar.
                    {% endif %}
                  </p>
                  <span class="hidden items-center gap-2 text-xs font-semibold text-slate-500 sm:inline-flex" data-task-definition-loader>
                    <svg class="h-4 w-4 animate-spin text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <circle class="opacity-25" cx="12" cy="12" r="10"></circle>
                      <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke-linecap="round"></path>
                    </svg>
                    Cargando más tareas…
                  </span>
                </div>
                <div data-task-definition-sentinel class="h-1 w-full"></div>
              </div>
            </section>
          </div>
        </article>

        <article id="tm-asignaciones" data-tm-panel="asignaciones" class="hidden space-y-8">
          <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-lg font-semibold text-slate-900">Planificador de asignaciones</h2>
              <p class="text-sm text-slate-500">Organiza quién ejecuta cada tarea por día y posición, sincronizado con el calendario operativo.</p>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-xs font-semibold text-slate-500">
              <button type="button" class="rounded-full border border-slate-200 px-3 py-1 hover:border-brand hover:text-brand">Importar desde CSV</button>
              <button type="button" class="rounded-full border border-slate-200 px-3 py-1 hover:border-brand hover:text-brand">Generar automáticamente</button>
              <button type="button" class="rounded-full border border-slate-200 px-3 py-1 hover:border-brand hover:text-brand">Validar conflictos</button>
              <button type="button" class="rounded-full bg-brand px-3 py-1 text-white hover:bg-brand-dark">Publicar semana</button>
            </div>
          </header>

          <section class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
            <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
              <div class="flex flex-wrap items-center gap-3 text-sm text-slate-600">
                <label class="flex items-center gap-2 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">
                  <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">Semana</span>
                  <input type="date" class="rounded border border-slate-200 px-2 py-1 text-sm focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/20" value="2025-11-03" />
                </label>
                <div class="min-w-[220px]">
                  <span class="mb-1 block text-[0.68rem] font-semibold uppercase tracking-[0.18em] text-slate-400">Granja</span>
                  {% with config=task_manager_assignment_farm_filter %}
                    {% include "task_manager/includes/filter_picker.html" with name="assignment_farm" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                  {% endwith %}
                </div>
                <div class="min-w-[220px]">
                  <span class="mb-1 block text-[0.68rem] font-semibold uppercase tracking-[0.18em] text-slate-400">Galpón</span>
                  {% with config=task_manager_assignment_house_filter %}
                    {% include "task_manager/includes/filter_picker.html" with name="assignment_house" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                  {% endwith %}
                </div>
                <div class="min-w-[220px]">
                  <span class="mb-1 block text-[0.68rem] font-semibold uppercase tracking-[0.18em] text-slate-400">Estado</span>
                  {% with config=task_manager_assignment_state_filter %}
                    {% include "task_manager/includes/filter_picker.html" with name="assignment_state" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                  {% endwith %}
                </div>
              </div>
              <div class="flex items-center gap-2 text-xs text-slate-500">
                <button type="button" class="rounded-full border border-slate-200 px-3 py-1 font-semibold hover:border-brand hover:text-brand">Turno diurno</button>
                <button type="button" class="rounded-full border border-slate-200 px-3 py-1 font-semibold hover:border-brand hover:text-brand">Turno nocturno</button>
                <button type="button" class="rounded-full border border-brand bg-brand px-3 py-1 font-semibold text-white hover:bg-brand-dark">Ver ambos</button>
              </div>
            </div>

            <div class="mt-6 overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
                  <tr>
                    <th class="min-w-[220px] px-4 py-3 text-left font-semibold">Posición</th>
                    <th class="px-4 py-3 text-left font-semibold">Lun 03</th>
                    <th class="px-4 py-3 text-left font-semibold">Mar 04</th>
                    <th class="px-4 py-3 text-left font-semibold">Mié 05</th>
                    <th class="px-4 py-3 text-left font-semibold">Jue 06</th>
                    <th class="px-4 py-3 text-left font-semibold">Vie 07</th>
                    <th class="px-4 py-3 text-left font-semibold">Sáb 08</th>
                    <th class="px-4 py-3 text-left font-semibold">Dom 09</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  <tr class="bg-white">
                    <td class="px-4 py-3">
                      <div class="font-semibold text-slate-900">Supervisor Bioseguridad</div>
                      <p class="text-xs text-slate-500">Prioridad máxima · Turno diurno</p>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-brand/10">
                        <p class="font-semibold text-slate-900">Control de acceso</p>
                        <p class="text-xs text-slate-500">Diana Bustos</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Reasignar</button>
                          <button type="button">Ver detalle</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-emerald-50">
                        <p class="font-semibold text-slate-900">Control de acceso</p>
                        <p class="text-xs text-slate-500">Diana Bustos</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Reasignar</button>
                          <button type="button">Registrar descanso</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-slate-100">
                        <p class="font-semibold text-slate-900">Control de acceso</p>
                        <p class="text-xs text-slate-500">Disponible</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Asignar</button>
                          <button type="button">Buscar sugeridos</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-rose-100">
                        <p class="font-semibold text-slate-900">Control de acceso</p>
                        <p class="text-xs text-rose-600">Conflicto: descanso automático</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Resolver</button>
                          <button type="button">Reprogramar</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-brand/10">
                        <p class="font-semibold text-slate-900">Control de acceso</p>
                        <p class="text-xs text-slate-500">Diana Bustos</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Reasignar</button>
                          <button type="button">Marcar descanso</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-slate-50">
                        <p class="font-semibold text-slate-900">Control de acceso</p>
                        <p class="text-xs text-slate-500">Disponible</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Asignar</button>
                          <button type="button">Duplicar</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-emerald-50">
                        <p class="font-semibold text-slate-900">Control de acceso</p>
                        <p class="text-xs text-slate-500">Automático</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Confirmar</button>
                          <button type="button">Bloquear</button>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <tr class="bg-white">
                    <td class="px-4 py-3">
                      <div class="font-semibold text-slate-900">Auxiliar Operativo · Galpón 3</div>
                      <p class="text-xs text-slate-500">Turno nocturno</p>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-slate-50">
                        <p class="font-semibold text-slate-900">Revisión de bebederos</p>
                        <p class="text-xs text-slate-500">Luis Ariza</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Reasignar</button>
                          <button type="button">Ver historial</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-slate-50">
                        <p class="font-semibold text-slate-900">Revisión de bebederos</p>
                        <p class="text-xs text-slate-500">Luis Ariza</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Reasignar</button>
                          <button type="button">Registrar descanso</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-rose-100">
                        <p class="font-semibold text-slate-900">Revisión de bebederos</p>
                        <p class="text-xs text-rose-600">Descanso obligatorio</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Liberar</button>
                          <button type="button">Buscar reemplazo</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-slate-100">
                        <p class="font-semibold text-slate-900">Revisión de bebederos</p>
                        <p class="text-xs text-slate-500">Disponible</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Asignar</button>
                          <button type="button">Sugeridos</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell">
                      <div class="tm-assignment-card bg-slate-100">
                        <p class="font-semibold text-slate-900">Revisión de bebederos</p>
                        <p class="text-xs text-slate-500">Disponible</p>
                        <div class="tm-assignment-actions">
                          <button type="button">Asignar</button>
                          <button type="button">Duplicar</button>
                        </div>
                      </div>
                    </td>
                    <td class="alignment-cell tm-blank">
                      <div class="rounded-lg border border-dashed border-slate-200 bg-slate-50/60 p-3 text-xs text-slate-400">
                        Arrastra una tarea o genera sugerencia automática.
                      </div>
                    </td>
                    <td class="alignment-cell tm-blank">
                      <div class="rounded-lg border border-dashed border-slate-200 bg-slate-50/60 p-3 text-xs text-slate-400">
                        Arrastra una tarea o genera sugerencia automática.
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-6 grid gap-4 md:grid-cols-3">
              <div class="rounded-lg border border-slate-200 bg-slate-50/70 p-4 text-sm text-slate-600">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Conflictos detectados</p>
                <p class="mt-1 text-lg font-semibold text-rose-600">4 asignaciones</p>
                <p class="mt-2 text-xs text-slate-500">Resuelve solapamientos de posiciones, descansos obligatorios y tareas duplicadas.</p>
              </div>
              <div class="rounded-lg border border-slate-200 bg-slate-50/70 p-4 text-sm text-slate-600">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Colaboradores con sobrecarga</p>
                <p class="mt-1 text-lg font-semibold text-amber-600">2 personas</p>
                <p class="mt-2 text-xs text-slate-500">Rotación día/noche sugerida para balancear rachas de turnos.</p>
              </div>
              <div class="rounded-lg border border-slate-200 bg-slate-50/70 p-4 text-sm text-slate-600">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Tareas sin responsable</p>
                <p class="mt-1 text-lg font-semibold text-slate-900">5 pendientes</p>
                <p class="mt-2 text-xs text-slate-500">Utiliza la búsqueda inteligente para sugerir nominados según historial.</p>
              </div>
            </div>
          </section>

          <section class="grid gap-6 lg:grid-cols-[minmax(0,1fr),22rem]">
            <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
              <header class="flex items-center justify-between">
                <div>
                  <h3 class="text-base font-semibold text-slate-900">Bandeja de sugerencias automáticas</h3>
                  <p class="text-sm text-slate-500">Basadas en historial de asignaciones y descansos programados.</p>
                </div>
                <button type="button" class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-brand hover:text-brand">Aplicar todo</button>
              </header>
              <ul class="mt-5 space-y-4 text-sm text-slate-600">
                <li class="tm-suggestion">
                  <div>
                    <p class="font-semibold text-slate-900">Asignar limpieza profunda</p>
                    <p class="text-xs text-slate-500">Se sugiere a <strong>Gabriela Melo</strong> por especialidad y descanso reciente.</p>
                  </div>
                  <div class="tm-suggestion-actions">
                    <button type="button">Revisar</button>
                    <button type="button">Aplicar</button>
                  </div>
                </li>
                <li class="tm-suggestion">
                  <div>
                    <p class="font-semibold text-slate-900">Mover reporte de mortalidad</p>
                    <p class="text-xs text-slate-500">Conflicto con capacitación, sugiera trasladar a <strong>Jesús Prada</strong>.</p>
                  </div>
                  <div class="tm-suggestion-actions">
                    <button type="button">Ver conflicto</button>
                    <button type="button">Reasignar</button>
                  </div>
                </li>
                <li class="tm-suggestion">
                  <div>
                    <p class="font-semibold text-slate-900">Agregar descanso compensatorio</p>
                    <p class="text-xs text-slate-500">Luis Ariza acumula 6 días consecutivos. Sugerido descanso el jueves.</p>
                  </div>
                  <div class="tm-suggestion-actions">
                    <button type="button">Ver racha</button>
                    <button type="button">Programar</button>
                  </div>
                </li>
              </ul>
            </div>
            <aside class="space-y-4 rounded-xl border border-slate-100 bg-slate-50/40 p-5 text-sm text-slate-600">
              <div>
                <h4 class="text-sm font-semibold text-slate-900">Resumen por colaborador</h4>
                <ul class="mt-3 space-y-3">
                  <li class="flex items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2">
                    <div>
                      <p class="font-semibold text-slate-800">Diana Bustos</p>
                      <p class="text-xs text-slate-500">4 tareas · 1 descanso</p>
                    </div>
                    <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-semibold text-emerald-700">Balanceado</span>
                  </li>
                  <li class="flex items-center justify-between rounded-lg border border-amber-200 bg-white px-3 py-2">
                    <div>
                      <p class="font-semibold text-slate-800">Luis Ariza</p>
                      <p class="text-xs text-amber-600">6 días consecutivos</p>
                    </div>
                    <span class="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700">Atención</span>
                  </li>
                  <li class="flex items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2">
                    <div>
                      <p class="font-semibold text-slate-800">María Perdomo</p>
                      <p class="text-xs text-slate-500">3 tareas · 2 descansos</p>
                    </div>
                    <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600">Rotación sugerida</span>
                  </li>
                </ul>
              </div>
              <div>
                <h4 class="text-sm font-semibold text-slate-900">Tareas en espera</h4>
                <ul class="mt-3 space-y-2">
                  <li class="rounded-lg border border-dashed border-slate-300 bg-white px-3 py-2 text-xs text-slate-500">
                    Desinfección salas — asignar antes del viernes.
                  </li>
                  <li class="rounded-lg border border-dashed border-slate-300 bg-white px-3 py-2 text-xs text-slate-500">
                    Auditoría inventario alimento — requiere líder disponible sábado.
                  </li>
                  <li class="rounded-lg border border-dashed border-slate-300 bg-white px-3 py-2 text-xs text-slate-500">
                    Revisión cámaras seguridad — pendiente confirmación proveedor.
                  </li>
                </ul>
              </div>
            </aside>
          </section>
        </article>

        <article id="tm-seguimiento" data-tm-panel="seguimiento" class="hidden space-y-10">
          <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-lg font-semibold text-slate-900">Seguimiento &amp; análisis</h2>
              <p class="text-sm text-slate-500">Controla estados, evidencia, reactivaciones y puntajes de cumplimiento.</p>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-xs font-semibold text-slate-500">
              <button type="button" class="rounded-full border border-slate-200 px-3 py-1 hover:border-brand hover:text-brand">Ver modo tablero</button>
              <button type="button" class="rounded-full border border-slate-200 px-3 py-1 hover:border-brand hover:text-brand">Comparar vs semana anterior</button>
              <button type="button" class="rounded-full border border-brand bg-brand px-3 py-1 text-white hover:bg-brand-dark">Generar PDF</button>
            </div>
          </header>

          <section class="grid gap-6 xl:grid-cols-[minmax(0,1.2fr),minmax(0,1fr)]">
            <div class="space-y-6 rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
              <header class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Estado de cumplimiento</p>
                  <p class="text-3xl font-bold text-slate-900">78% en curso</p>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-500">
                  <div class="flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1">
                    <span>Periodo</span>
                    <div class="min-w-[180px]">
                  {% with config=task_manager_followup_period_filter %}
                    {% include "task_manager/includes/filter_picker.html" with name="followup_period" default_value=config.default_value default_label=config.default_label groups=config.groups search_enabled=config.search_enabled neutral_value=config.neutral_value %}
                  {% endwith %}
                    </div>
                  </div>
                </div>
              </header>

              <div class="grid gap-4 md:grid-cols-2">
                <div class="rounded-lg border border-slate-100 bg-slate-50/60 p-4 text-sm text-slate-600">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Completadas</p>
                  <p class="mt-1 text-xl font-bold text-emerald-600">284 tareas</p>
                  <p class="mt-3 text-xs text-slate-500">El 60% con evidencia aprobada, 40% en revisión.</p>
                </div>
                <div class="rounded-lg border border-slate-100 bg-slate-50/60 p-4 text-sm text-slate-600">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">En proceso</p>
                  <p class="mt-1 text-xl font-bold text-amber-600">62 tareas</p>
                  <p class="mt-3 text-xs text-slate-500">Esperan cierre antes de medianoche o prueba fotográfica.</p>
                </div>
                <div class="rounded-lg border border-slate-100 bg-slate-50/60 p-4 text-sm text-slate-600">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Postergadas</p>
                  <p class="mt-1 text-xl font-bold text-blue-600">18 tareas</p>
                  <p class="mt-3 text-xs text-slate-500">Necesitan justificativo y nueva fecha antes de 24h.</p>
                </div>
                <div class="rounded-lg border border-slate-100 bg-slate-50/60 p-4 text-sm text-slate-600">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Reactivadas</p>
                  <p class="mt-1 text-xl font-bold text-rose-600">9 tareas</p>
                  <p class="mt-3 text-xs text-slate-500">Regresaron al backlog con anotaciones específicas.</p>
                </div>
              </div>

              <div class="overflow-hidden rounded-lg border border-slate-200">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                  <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
                    <tr>
                      <th scope="col" class="px-4 py-3 text-left font-semibold">Tarea</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold">Asignado a</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold">Estado</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold">Evidencia</th>
                      <th scope="col" class="px-4 py-3 text-left font-semibold">Acciones</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 bg-white text-slate-700">
                    <tr class="hover:bg-slate-50/80">
                      <td class="px-4 py-4">
                        <p class="font-semibold text-slate-900">Informe semanal de mortalidad</p>
                        <p class="text-xs text-slate-500">Granja Altamira · Proceso general</p>
                      </td>
                      <td class="px-4 py-4 text-xs text-slate-600">
                        <div class="font-semibold text-slate-800">María Perdomo</div>
                        <p>Turno diurno · Posición coordinador</p>
                      </td>
                      <td class="px-4 py-4">
                        <span class="rounded-full bg-amber-100 px-3 py-1 text-xs font-semibold text-amber-700">En revisión</span>
                      </td>
                      <td class="px-4 py-4 text-xs text-slate-600">
                        <p>Documento cargado · Comentario pendiente</p>
                        <button type="button" class="mt-2 inline-flex items-center gap-2 text-xs font-semibold text-brand hover:text-brand-dark">
                          Solicitar aclaración
                          <span aria-hidden="true">→</span>
                        </button>
                      </td>
                      <td class="px-4 py-4">
                        <div class="flex flex-wrap gap-2 text-xs font-semibold">
                          <button type="button" class="rounded-full border border-slate-200 px-3 py-1 text-slate-600 hover:border-brand hover:text-brand">Validar</button>
                          <button type="button" class="rounded-full border border-slate-200 px-3 py-1 text-slate-600 hover:border-brand hover:text-brand">Reactivar</button>
                        </div>
                      </td>
                    </tr>
                    <tr class="hover:bg-slate-50/80">
                      <td class="px-4 py-4">
                        <p class="font-semibold text-slate-900">Desinfección de equipos</p>
                        <p class="text-xs text-slate-500">Galpón 4 · El Guadual</p>
                      </td>
                      <td class="px-4 py-4 text-xs text-slate-600">
                        <div class="font-semibold text-slate-800">Jhon Vergara</div>
                        <p>Turno nocturno · Auxiliar Operativo</p>
                      </td>
                      <td class="px-4 py-4">
                        <span class="rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">Completada</span>
                      </td>
                      <td class="px-4 py-4 text-xs text-slate-600">
                        <p>Foto verificada · Nota de cierre agregada</p>
                        <button type="button" class="mt-2 inline-flex items-center gap-2 text-xs font-semibold text-brand hover:text-brand-dark">
                          Ver evidencia
                          <span aria-hidden="true">→</span>
                        </button>
                      </td>
                      <td class="px-4 py-4">
                        <div class="flex flex-wrap gap-2 text-xs font-semibold">
                          <button type="button" class="rounded-full border border-slate-200 px-3 py-1 text-slate-600 hover:border-brand hover:text-brand">Reconocer</button>
                          <button type="button" class="rounded-full border border-slate-200 px-3 py-1 text-slate-600 hover:border-brand hover:text-brand">Duplicar</button>
                        </div>
                      </td>
                    </tr>
                    <tr class="hover:bg-slate-50/80">
                      <td class="px-4 py-4">
                        <p class="font-semibold text-slate-900">Inspección fitosanitaria</p>
                        <p class="text-xs text-slate-500">Granja La Rivera · Galpón 1</p>
                      </td>
                      <td class="px-4 py-4 text-xs text-slate-600">
                        <div class="font-semibold text-slate-800">Gabriela Melo</div>
                        <p>Turno diurno · Supervisora</p>
                      </td>
                      <td class="px-4 py-4">
                        <span class="rounded-full bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-700">Reactivada</span>
                      </td>
                      <td class="px-4 py-4 text-xs text-slate-600">
                        <p>Observación: hallazgos sin corregir.</p>
                        <button type="button" class="mt-2 inline-flex items-center gap-2 text-xs font-semibold text-brand hover:text-brand-dark">
                          Ver comentarios
                          <span aria-hidden="true">→</span>
                        </button>
                      </td>
                      <td class="px-4 py-4">
                        <div class="flex flex-wrap gap-2 text-xs font-semibold">
                          <button type="button" class="rounded-full border border-slate-200 px-3 py-1 text-slate-600 hover:border-brand hover:text-brand">Reasignar</button>
                          <button type="button" class="rounded-full border border-slate-200 px-3 py-1 text-slate-600 hover:border-brand hover:text-brand">Cerrar con nota</button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <aside class="space-y-6 rounded-xl border border-slate-100 bg-slate-50/40 p-6 text-sm text-slate-600">
              <section>
                <h3 class="text-sm font-semibold text-slate-900">Rendimiento por granja</h3>
                <ul class="mt-3 space-y-3">
                  <li class="rounded-lg border border-slate-200 bg-white p-4">
                    <div class="flex items-center justify-between">
                      <span class="font-semibold text-slate-800">El Guadual</span>
                      <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-semibold text-emerald-700">95%</span>
                    </div>
                    <p class="mt-2 text-xs text-slate-500">Foco en tareas recurrentes · 2 reactivadas.</p>
                  </li>
                  <li class="rounded-lg border border-slate-200 bg-white p-4">
                    <div class="flex items-center justify-between">
                      <span class="font-semibold text-slate-800">Altamira</span>
                      <span class="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700">81%</span>
                    </div>
                    <p class="mt-2 text-xs text-slate-500">Alto volumen de evidencias pendientes.</p>
                  </li>
                  <li class="rounded-lg border border-slate-200 bg-white p-4">
                    <div class="flex items-center justify-between">
                      <span class="font-semibold text-slate-800">La Rivera</span>
                      <span class="rounded-full bg-rose-100 px-2 py-0.5 text-xs font-semibold text-rose-700">69%</span>
                    </div>
                    <p class="mt-2 text-xs text-slate-500">Requiere soporte en bioseguridad y capacitación.</p>
                  </li>
                </ul>
              </section>
              <section>
                <h3 class="text-sm font-semibold text-slate-900">Puntos y consistencia</h3>
                <ul class="mt-3 space-y-3">
                  <li class="flex items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2">
                    <div>
                      <p class="font-semibold text-slate-800">María Perdomo</p>
                      <p class="text-xs text-slate-500">Puntos: 185 · Racha: 12 días cumplidos</p>
                    </div>
                    <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-semibold text-emerald-700">Excelente</span>
                  </li>
                  <li class="flex items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2">
                    <div>
                      <p class="font-semibold text-slate-800">Luis Ariza</p>
                      <p class="text-xs text-slate-500">Puntos: 122 · Racha: 6 días</p>
                    </div>
                    <span class="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700">Atención</span>
                  </li>
                  <li class="flex items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2">
                    <div>
                      <p class="font-semibold text-slate-800">Gabriela Melo</p>
                      <p class="text-xs text-slate-500">Puntos: 138 · Racha: 9 días</p>
                    </div>
                    <span class="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-semibold text-blue-700">Bueno</span>
                  </li>
                </ul>
              </section>
              <section>
                <h3 class="text-sm font-semibold text-slate-900">Insights inmediatos</h3>
                <div class="mt-3 space-y-2 text-xs text-slate-500">
                  <p>• Incrementar revisiones sorpresa en galpones con bajo cumplimiento.</p>
                  <p>• Conectar reactivaciones con nuevas capacitaciones específicas.</p>
                  <p>• Activar campaña de reconocimiento a mejores puntajes mensuales.</p>
                </div>
              </section>
            </aside>
          </section>
        </article>

      </div>
    </section>
  </div>

  <style>
    [data-tm-tabs] .tab-button[aria-selected="true"] {
      background-color: rgb(15 23 42);
      color: #fff;
    }
    .alignment-cell {
      min-width: 180px;
      padding: 0.75rem 1rem;
      vertical-align: top;
    }
    .alignment-cell.tm-blank {
      background-color: rgba(248, 250, 252, 0.75);
    }
    .tm-assignment-card {
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      position: relative;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    .tm-assignment-card .tm-assignment-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.75rem;
    }
    .tm-assignment-card .tm-assignment-actions button {
      border-radius: 9999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 0.25rem 0.75rem;
      font-weight: 600;
      color: rgb(71 85 105);
    }
    .tm-assignment-card .tm-assignment-actions button:hover {
      border-color: rgba(245, 158, 11, 0.9);
      color: rgb(245 158 11);
    }
    .tm-suggestion {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background-color: rgba(255, 255, 255, 0.9);
      padding: 1rem;
    }
    .tm-suggestion-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .tm-suggestion-actions button {
      border-radius: 9999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 0.25rem 0.75rem;
      color: rgb(71 85 105);
    }
    .tm-suggestion-actions button:hover {
      border-color: rgba(245, 158, 11, 0.9);
      color: rgb(245 158 11);
    }
    .tm-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 9999px;
      padding: 0.1rem 0.65rem;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .tm-badge-brand {
      background-color: rgba(245, 158, 11, 0.12);
      color: rgb(217, 119, 6);
    }
    .tm-badge-neutral {
      background-color: rgba(148, 163, 184, 0.15);
      color: rgb(71, 85, 105);
    }
    .tm-badge-critical {
      background-color: rgba(248, 113, 113, 0.2);
      color: rgb(185, 28, 28);
    }
    .tm-badge-success {
      background-color: rgba(134, 239, 172, 0.2);
      color: rgb(22, 101, 52);
    }
    .tm-task-row-highlight {
      animation: tm-task-row-glow 3s ease-out forwards;
    }
    @keyframes tm-task-row-glow {
      0% {
        box-shadow: 0 0 0 rgba(245, 158, 11, 0.25);
        background-color: rgba(245, 158, 11, 0.35);
      }
      40% {
        box-shadow: 0 0 24px rgba(245, 158, 11, 0.2);
        background-color: rgba(245, 158, 11, 0.22);
      }
      100% {
        box-shadow: 0 0 0 rgba(245, 158, 11, 0);
        background-color: inherit;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var getCsrfToken = function () {
        var match = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : '';
      };

      var initializeFilterPickers = function () {
        var pickers = Array.prototype.slice.call(document.querySelectorAll('[data-filter-picker]'));
        if (!pickers.length) {
          return;
        }

        var activePicker = null;
        var panelRegistry = new WeakMap();
        var panelOrigins = new WeakMap();
        var pickerControllers = new Map();

        var getPanel = function (picker) {
          return panelRegistry.get(picker) || null;
        };

        var storePanelOrigin = function (panel) {
          if (!panel || panelOrigins.has(panel)) {
            return;
          }
          panelOrigins.set(panel, {
            parent: panel.parentNode,
            nextSibling: panel.nextSibling,
          });
        };

        var restorePanelOrigin = function (panel) {
          if (!panel) {
            return;
          }
          var origin = panelOrigins.get(panel);
          if (origin && origin.parent) {
            if (panel.parentNode !== origin.parent) {
              if (origin.nextSibling && origin.nextSibling.parentNode === origin.parent) {
                origin.parent.insertBefore(panel, origin.nextSibling);
              } else {
                origin.parent.appendChild(panel);
              }
            }
          }
          panel.style.position = '';
          panel.style.left = '';
          panel.style.top = '';
          panel.style.width = '';
          panel.style.maxHeight = '';
          panel.style.zIndex = '';
        };

        var positionPanel = function (picker) {
          var panel = getPanel(picker);
          var trigger = picker.querySelector('[data-filter-trigger]');
          if (!panel || !trigger) {
            return;
          }
          storePanelOrigin(panel);
          if (panel.parentNode !== document.body) {
            document.body.appendChild(panel);
          }
          panel.style.maxHeight = '';
          var rect = trigger.getBoundingClientRect();
          var viewportWidth = document.documentElement.clientWidth || window.innerWidth;
          var viewportHeight = window.innerHeight || document.documentElement.clientHeight;
          var gap = 8;
          var left = rect.left;
          if (left + rect.width > viewportWidth - 16) {
            left = Math.max(16, viewportWidth - rect.width - 16);
          }
          panel.style.position = 'fixed';
          panel.style.width = rect.width + 'px';
          panel.style.left = left + 'px';
          var panelHeight = panel.offsetHeight || 0;
          var top = rect.bottom + gap;
          if (panelHeight && top + panelHeight > viewportHeight - 16) {
            var altTop = rect.top - gap - panelHeight;
            if (altTop >= 16) {
              top = altTop;
            } else {
              top = Math.max(16, top);
            }
          }
          panel.style.top = top + 'px';
          var availableHeight = viewportHeight - top - 16;
          if (availableHeight > 0) {
            panel.style.maxHeight = availableHeight + 'px';
          }
          panel.style.zIndex = '1200';
        };

        var closePicker = function (picker, options) {
          if (!picker) {
            return;
          }
          var panel = getPanel(picker);
          var trigger = picker.querySelector('[data-filter-trigger]');
          var chevron = picker.querySelector('[data-filter-chevron]');
          if (panel) {
            panel.classList.add('hidden');
            restorePanelOrigin(panel);
          }
          picker.setAttribute('data-open', 'false');
          if (trigger) {
            trigger.setAttribute('aria-expanded', 'false');
          }
          if (chevron) {
            chevron.classList.remove('tm-filter-chevron-rotated');
          }
          if (options && options.focusTrigger && trigger) {
            trigger.focus();
          }
          if (activePicker === picker) {
            activePicker = null;
          }
        };

        var filterOptions = function (picker, term) {
          var panel = getPanel(picker);
          if (!panel) {
            return;
          }
          var normalized = (term || '').trim().toLowerCase();
          var groups = Array.prototype.slice.call(panel.querySelectorAll('[data-filter-group]'));
          var hasVisible = false;

          groups.forEach(function (group) {
            var groupVisible = false;
            var buttons = Array.prototype.slice.call(group.querySelectorAll('[data-filter-option]'));
            buttons.forEach(function (button) {
              var wrapper = button.parentElement;
              if (!wrapper) {
                return;
              }
              var searchable = (button.getAttribute('data-search-text') || '').toLowerCase();
              var match = !normalized || searchable.indexOf(normalized) !== -1;
              wrapper.classList.toggle('hidden', !match);
              if (match) {
                groupVisible = true;
                hasVisible = true;
              }
            });
            group.classList.toggle('hidden', !groupVisible);
          });

          var emptyState = panel.querySelector('[data-filter-empty]');
          if (emptyState) {
            emptyState.classList.toggle('hidden', hasVisible);
          }
        };

        var highlightOption = function (picker, optionButton) {
          var panel = getPanel(picker);
          var root = panel || picker;
          var buttons = Array.prototype.slice.call(root.querySelectorAll('[data-filter-option]'));
          buttons.forEach(function (button) {
            if (button === optionButton) {
              button.classList.add('is-selected');
              button.setAttribute('aria-selected', 'true');
            } else {
              button.classList.remove('is-selected');
              button.setAttribute('aria-selected', 'false');
            }
          });
        };

        var applySelection = function (picker, optionButton, silent) {
          if (!optionButton) {
            return;
          }
          var hidden = picker.querySelector('[data-filter-value]');
          var labelEl = picker.querySelector('[data-filter-current-label]');
          var descriptionEl = picker.querySelector('[data-filter-current-description]');
          var value = optionButton.getAttribute('data-value') || '';
          var label = optionButton.getAttribute('data-label') || optionButton.textContent.trim();
          var description = optionButton.getAttribute('data-description') || '';

          if (hidden) {
            hidden.value = value;
          }
          if (labelEl) {
            labelEl.textContent = label;
          }
          if (descriptionEl) {
            if (description) {
              descriptionEl.textContent = description;
              descriptionEl.classList.remove('hidden');
            } else {
              descriptionEl.textContent = '';
              descriptionEl.classList.add('hidden');
            }
          }

          highlightOption(picker, optionButton);
          picker.setAttribute('data-selected-value', value);
          picker.setAttribute('data-selected-label', label);
          picker.setAttribute('data-filter-current-value', value);

          if (!silent) {
            closePicker(picker, { focusTrigger: true });
            var changeEvent = new CustomEvent('tm-filter-change', {
              bubbles: true,
              detail: {
                name: picker.getAttribute('data-filter-name') || '',
                value: value,
                label: label,
              },
            });
            picker.dispatchEvent(changeEvent);
          }
        };

        var openPicker = function (picker) {
          if (activePicker && activePicker !== picker) {
            closePicker(activePicker);
          }
          var panel = getPanel(picker);
          var trigger = picker.querySelector('[data-filter-trigger]');
          var chevron = picker.querySelector('[data-filter-chevron]');
          var searchInput = panel ? panel.querySelector('[data-filter-search]') : null;

          if (panel) {
            panel.classList.remove('hidden');
            positionPanel(picker);
          }
          picker.setAttribute('data-open', 'true');
          if (trigger) {
            trigger.setAttribute('aria-expanded', 'true');
          }
          if (chevron) {
            chevron.classList.add('tm-filter-chevron-rotated');
          }

          if (searchInput) {
            searchInput.value = '';
            filterOptions(picker, '');
            window.requestAnimationFrame(function () {
              searchInput.focus();
            });
          } else {
            filterOptions(picker, '');
            var selected = panel ? panel.querySelector('[data-filter-option].is-selected') : null;
            if (selected && selected.scrollIntoView) {
              selected.scrollIntoView({ block: 'nearest' });
            }
          }

          activePicker = picker;
        };

        pickers.forEach(function (picker, index) {
          var pickerName = picker.getAttribute('data-filter-name');
          if (!picker.id) {
            picker.id = 'tm-filter-picker-' + index;
          }
          var trigger = picker.querySelector('[data-filter-trigger]');
          var panel = picker.querySelector('[data-filter-panel]');
          if (panel) {
            panelRegistry.set(picker, panel);
            storePanelOrigin(panel);
          }
          var searchInput = panel ? panel.querySelector('[data-filter-search]') : null;
          var optionButtons = Array.prototype.slice.call((panel || picker).querySelectorAll('[data-filter-option]'));
          var defaultValue = picker.getAttribute('data-filter-default-value') || '';
          var initialValue = picker.getAttribute('data-filter-current-value') || defaultValue;
          var initialButton =
            optionButtons.find(function (button) {
              return button.getAttribute('data-value') === initialValue;
            }) ||
            optionButtons.find(function (button) {
              return button.classList.contains('is-selected');
            }) ||
            optionButtons[0];

          if (initialButton) {
            applySelection(picker, initialButton, true);
          }

          if (pickerName) {
            pickerControllers.set(pickerName, {
              element: picker,
              select: function (value, options) {
                var targetValue = typeof value === 'string' ? value : '';
                if (!targetValue) {
                  targetValue = picker.getAttribute('data-filter-default-value') || '';
                }
                var currentValue =
                  picker.getAttribute('data-selected-value') ||
                  picker.getAttribute('data-filter-current-value') ||
                  '';
                if (currentValue === targetValue) {
                  return false;
                }
                var scopePanel = getPanel(picker);
                var root = scopePanel || picker;
                var buttons = Array.prototype.slice.call(root.querySelectorAll('[data-filter-option]'));
                var targetButton = buttons.find(function (button) {
                  return button.getAttribute('data-value') === targetValue;
                });
                if (!targetButton) {
                  return false;
                }
                var silent = true;
                if (options && Object.prototype.hasOwnProperty.call(options, 'silent')) {
                  silent = !!options.silent;
                }
                applySelection(picker, targetButton, silent);
                if (silent) {
                  closePicker(picker);
                }
                return true;
              },
              getValue: function () {
                return (
                  picker.getAttribute('data-selected-value') ||
                  picker.getAttribute('data-filter-current-value') ||
                  ''
                );
              },
            });
          }

          if (trigger) {
            trigger.addEventListener('click', function (event) {
              if (trigger.hasAttribute('disabled') || picker.getAttribute('data-disabled') === 'true') {
                event.preventDefault();
                event.stopPropagation();
                return;
              }
              event.preventDefault();
              var isOpen = picker.getAttribute('data-open') === 'true';
              if (isOpen) {
                closePicker(picker);
              } else {
                openPicker(picker);
              }
            });
          }

          if (panel) {
            panel.addEventListener('click', function (event) {
              event.stopPropagation();
            });
          }

          optionButtons.forEach(function (button) {
            button.addEventListener('click', function (event) {
              event.preventDefault();
              applySelection(picker, button, false);
            });
          });

          if (searchInput) {
            searchInput.addEventListener('input', function () {
              filterOptions(picker, searchInput.value);
            });
          }
        });

        document.addEventListener('click', function (event) {
          if (!activePicker) {
            return;
          }
          if (activePicker.contains(event.target)) {
            return;
          }
          var activePanel = getPanel(activePicker);
          if (activePanel && activePanel.contains(event.target)) {
            return;
          }
          closePicker(activePicker);
        });

        document.addEventListener('keydown', function (event) {
          if (event.key === 'Escape' && activePicker) {
            closePicker(activePicker, { focusTrigger: true });
          }
        });

        window.addEventListener(
          'scroll',
          function (event) {
            if (!activePicker) {
              return;
            }
            var panel = getPanel(activePicker);
            if (panel && event && event.target && panel.contains(event.target)) {
              return;
            }
            closePicker(activePicker);
          },
          true
        );

        window.addEventListener('resize', function () {
          if (activePicker) {
            positionPanel(activePicker);
          }
        });

        window.tmFilterPickers = {
          select: function (name, value, options) {
            if (!name) {
              return false;
            }
            var controller = pickerControllers.get(String(name));
            if (!controller) {
              return false;
            }
            return controller.select(value, options);
          },
          getValue: function (name) {
            if (!name) {
              return null;
            }
            var controller = pickerControllers.get(String(name));
            if (!controller) {
              return null;
            }
            return controller.getValue();
          },
          getPicker: function (name) {
            if (!name) {
              return null;
            }
            var controller = pickerControllers.get(String(name));
            return controller ? controller.element : null;
          },
          close: function (name) {
            if (!name) {
              return false;
            }
            var controller = pickerControllers.get(String(name));
            if (!controller) {
              return false;
            }
            closePicker(controller.element);
            return true;
          },
        };
      };

      var setupTaskDefinitionGrouping = function () {
        var list = document.querySelector('[data-task-definition-list]');
        if (!list) {
          window.tmTaskGrouping = null;
          return null;
        }

        var GROUP_DIMENSIONS = {
          status: { label: 'Estado', emptyLabel: 'Sin estado' },
          category: { label: 'Categoría', emptyLabel: 'Sin categoría' },
          scope: { label: 'Lugar', emptyLabel: 'Cobertura general' },
          responsible: { label: 'Responsable sugerido', emptyLabel: 'Sin responsable' },
          task_type: { label: 'Tipo de planificación', emptyLabel: 'Sin tipo definido' },
          evidence: { label: 'Requisito de evidencia', emptyLabel: 'Sin requisito' },
        };

        var collapsedKeys = new Set();
        var columnCount = parseInt(list.getAttribute('data-column-count') || '5', 10);
        if (!isFinite(columnCount) || columnCount <= 0) {
          columnCount = 5;
        }

        var readGroupValue = function (row, dimension) {
          if (!row || !dimension) {
            return { key: dimension + ':__none__', label: '', subtitle: '' };
          }
          var base = 'data-group-' + dimension.replace(/_/g, '-');
          var key = row.getAttribute(base + '-key') || '';
          var label = row.getAttribute(base + '-label') || '';
          var subtitle = row.getAttribute(base + '-subtitle') || '';
          var meta = GROUP_DIMENSIONS[dimension] || {};
          if (!label) {
            label = meta.emptyLabel || 'Sin datos';
          }
          if (!key) {
            var slug = label
              .toLowerCase()
              .replace(/\s+/g, '-')
              .replace(/[^a-z0-9\-]/g, '');
            if (!slug) {
              slug = 'grupo';
            }
            key = dimension + ':' + slug;
          }
          return {
            key: key,
            label: label,
            subtitle: subtitle || '',
          };
        };

        var formatCount = function (count) {
          var value = typeof count === 'number' && !isNaN(count) ? count : 0;
          return value === 1 ? '1 tarea' : value + ' tareas';
        };

        var createGroupHeaderRow = function (level, dimension, value, count, groupKey, parentKey) {
          var tr = document.createElement('tr');
          tr.setAttribute('data-task-group-row', '');
          tr.setAttribute('data-group-level', level);
          tr.setAttribute('data-group-key', groupKey || value.key || '');
          tr.setAttribute('data-group-dimension', dimension);
          tr.setAttribute('data-group-collapsed', 'false');
          if (parentKey) {
            tr.setAttribute('data-parent-group', parentKey);
          }

          var td = document.createElement('td');
          td.setAttribute('colspan', String(columnCount));

          var button = document.createElement('button');
          button.type = 'button';
          button.className = 'tm-group-toggle';
          button.setAttribute('data-task-group-toggle', '');
          button.setAttribute('aria-expanded', 'true');
          button.setAttribute('data-group-key', groupKey || value.key || '');

          var icon = document.createElement('span');
          icon.className = 'tm-group-toggle-icon';
          icon.innerHTML =
            '<svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 5.23a.75.75 0 011.06.02L12.5 9.5l-4.23 4.24a.75.75 0 11-1.08-1.04L10.19 9.5 7.23 6.27a.75.75 0 01-.02-1.04z" clip-rule="evenodd"></path></svg>';
          button.appendChild(icon);

          var text = document.createElement('span');
          text.className = 'tm-group-text';

          var dimLabel = document.createElement('span');
          dimLabel.className = 'tm-group-dimension';
          dimLabel.textContent = (GROUP_DIMENSIONS[dimension] && GROUP_DIMENSIONS[dimension].label) || dimension;
          text.appendChild(dimLabel);

          var valueLabel = document.createElement('span');
          valueLabel.className = 'tm-group-label';
          valueLabel.textContent = value.label;
          text.appendChild(valueLabel);

          if (value.subtitle) {
            var subtitle = document.createElement('span');
            subtitle.className = 'tm-group-subtitle';
            subtitle.textContent = value.subtitle;
            text.appendChild(subtitle);
          }

          button.appendChild(text);

          var counter = document.createElement('span');
          counter.className = 'tm-group-count';
          counter.textContent = formatCount(count);
          button.appendChild(counter);

          td.appendChild(button);
          tr.appendChild(td);
          return tr;
        };

        var shouldBreak = function (level, nextLevel) {
          if (level === 'primary') {
            return nextLevel === 'primary';
          }
          if (level === 'secondary') {
            return nextLevel === 'primary' || nextLevel === 'secondary';
          }
          return false;
        };

        var hideDescendants = function (header) {
          if (!header) {
            return;
          }
          var level = header.getAttribute('data-group-level');
          var next = header.nextElementSibling;
          while (next) {
            if (next.hasAttribute('data-task-group-row')) {
              var nextLevel = next.getAttribute('data-group-level');
              if (shouldBreak(level, nextLevel)) {
                break;
              }
              next.classList.add('hidden');
              hideDescendants(next);
            } else if (next.hasAttribute('data-task-definition-row')) {
              next.classList.add('hidden');
            }
            next = next.nextElementSibling;
          }
        };

        var applyAllGroupVisibility = function () {
          var allRows = Array.prototype.slice.call(
            list.querySelectorAll('[data-task-group-row], [data-task-definition-row]')
          );
          allRows.forEach(function (row) {
            row.classList.remove('hidden');
          });
          var headers = Array.prototype.slice.call(list.querySelectorAll('[data-task-group-row]'));
          headers.forEach(function (header) {
            var key = header.getAttribute('data-group-key');
            var collapsed = collapsedKeys.has(key);
            header.setAttribute('data-group-collapsed', collapsed ? 'true' : 'false');
            var toggle = header.querySelector('[data-task-group-toggle]');
            if (toggle) {
              toggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
            }
          });
          headers.forEach(function (header) {
            var key = header.getAttribute('data-group-key');
            if (collapsedKeys.has(key)) {
              hideDescendants(header);
            }
          });
        };

        var clearRowState = function (row) {
          row.classList.remove('hidden');
          row.removeAttribute('data-parent-group');
          row.removeAttribute('data-group-path');
        };

        var applyGrouping = function (options) {
          var preserveState = !!(options && options.preserveState);
          var retainedCollapsed = preserveState ? new Set(collapsedKeys) : new Set();
          var headerRows = Array.prototype.slice.call(list.querySelectorAll('[data-task-group-row]'));
          headerRows.forEach(function (header) {
            header.parentNode.removeChild(header);
          });

          var rows = Array.prototype.slice.call(list.querySelectorAll('[data-task-definition-row]'));
          if (!rows.length) {
            collapsedKeys = new Set();
            applyAllGroupVisibility();
            return;
          }
          rows.forEach(clearRowState);

          var primary = (list.getAttribute('data-group-primary') || 'none').trim() || 'none';
          var secondary = (list.getAttribute('data-group-secondary') || 'none').trim() || 'none';
          if (!Object.prototype.hasOwnProperty.call(GROUP_DIMENSIONS, primary)) {
            primary = 'none';
          }
          if (!Object.prototype.hasOwnProperty.call(GROUP_DIMENSIONS, secondary) || secondary === primary) {
            secondary = 'none';
          }

          var fragment = document.createDocumentFragment();
          var validKeys = new Set();

          if (primary === 'none') {
            rows.forEach(function (row) {
              fragment.appendChild(row);
            });
            list.appendChild(fragment);
            collapsedKeys = new Set();
            applyAllGroupVisibility();
            return;
          }

          var primaryIndex = Object.create(null);
          var primaryGroups = [];

          rows.forEach(function (row) {
            var primaryValue = readGroupValue(row, primary);
            var primaryKey = primaryValue.key;
            if (!Object.prototype.hasOwnProperty.call(primaryIndex, primaryKey)) {
              primaryIndex[primaryKey] = {
                key: primaryKey,
                dimension: primary,
                value: primaryValue,
                rows: [],
                secondaryIndex: Object.create(null),
                secondaryGroups: [],
              };
              primaryGroups.push(primaryIndex[primaryKey]);
            }
            var primaryGroup = primaryIndex[primaryKey];
            if (secondary !== 'none') {
              var secondaryValue = readGroupValue(row, secondary);
              var secondaryKey = secondaryValue.key;
              if (!Object.prototype.hasOwnProperty.call(primaryGroup.secondaryIndex, secondaryKey)) {
                primaryGroup.secondaryIndex[secondaryKey] = {
                  key: primaryKey + '||' + secondaryKey,
                  ownKey: secondaryKey,
                  dimension: secondary,
                  value: secondaryValue,
                  rows: [],
                };
                primaryGroup.secondaryGroups.push(primaryGroup.secondaryIndex[secondaryKey]);
              }
              primaryGroup.secondaryIndex[secondaryKey].rows.push(row);
            } else {
              primaryGroup.rows.push(row);
            }
          });

          var compareByLabel = function (a, b) {
            var labelA = a && a.value && a.value.label ? String(a.value.label) : '';
            var labelB = b && b.value && b.value.label ? String(b.value.label) : '';
            return labelA.localeCompare(labelB, undefined, { sensitivity: 'base' });
          };

          primaryGroups.sort(compareByLabel);
          if (secondary !== 'none') {
            primaryGroups.forEach(function (group) {
              group.secondaryGroups.sort(compareByLabel);
            });
          }

          primaryGroups.forEach(function (group) {
            var count = 0;
            if (secondary === 'none') {
              count = group.rows.length;
            } else {
              group.secondaryGroups.forEach(function (subGroup) {
                subGroup.count = subGroup.rows.length;
                count += subGroup.count;
              });
            }
            group.count = count;
          });

          primaryGroups.forEach(function (group) {
            validKeys.add(group.key);
          var header = createGroupHeaderRow('primary', group.dimension, group.value, group.count, group.key, null);
            fragment.appendChild(header);
            if (secondary === 'none') {
              group.rows.forEach(function (row) {
                row.setAttribute('data-parent-group', group.key);
                row.setAttribute('data-group-path', group.key);
                fragment.appendChild(row);
              });
            } else {
              group.secondaryGroups.forEach(function (subGroup) {
                validKeys.add(subGroup.key);
                var secondaryHeader = createGroupHeaderRow(
                  'secondary',
                  subGroup.dimension,
                  subGroup.value,
                  subGroup.count,
                  subGroup.key,
                  group.key
                );
                fragment.appendChild(secondaryHeader);
                subGroup.rows.forEach(function (row) {
                  row.setAttribute('data-parent-group', subGroup.key);
                  row.setAttribute('data-group-path', subGroup.key);
                  fragment.appendChild(row);
                });
              });
            }
          });

          list.appendChild(fragment);

          var filteredCollapsed = new Set();
          retainedCollapsed.forEach(function (key) {
            if (validKeys.has(key)) {
              filteredCollapsed.add(key);
            }
          });
          collapsedKeys = filteredCollapsed;
          applyAllGroupVisibility();
        };

        list.addEventListener('click', function (event) {
          var toggle = event.target.closest('[data-task-group-toggle]');
          if (!toggle) {
            return;
          }
          event.preventDefault();
          var header = toggle.closest('[data-task-group-row]');
          if (!header) {
            return;
          }
          var key = header.getAttribute('data-group-key');
          if (!key) {
            return;
          }
          if (collapsedKeys.has(key)) {
            collapsedKeys.delete(key);
          } else {
            collapsedKeys.add(key);
          }
          applyAllGroupVisibility();
        });

        var api = {
          apply: function () {
            collapsedKeys = new Set();
            applyGrouping({ preserveState: false });
          },
          reapply: function () {
            applyGrouping({ preserveState: true });
          },
        };

        window.tmTaskGrouping = api;
        applyGrouping({ preserveState: false });
        return api;
      };

      var setupTaskDefinitionSorting = function () {
        var list = document.querySelector('[data-task-definition-list]');
        if (!list) {
          window.tmTaskSorting = null;
          return null;
        }

        var table = list.closest('table');
        if (!table) {
          window.tmTaskSorting = null;
          return null;
        }

        var headers = Array.prototype.slice.call(table.querySelectorAll('thead [data-sort-key]'));
        if (!headers.length) {
          window.tmTaskSorting = null;
          return null;
        }

        var DEFAULT_KEY = (list.getAttribute('data-default-sort-key') || 'name').trim() || 'name';
        var DEFAULT_DIRECTION = (list.getAttribute('data-default-sort-direction') || 'asc').trim() === 'desc' ? 'desc' : 'asc';
        var state = {
          key: (list.getAttribute('data-sort-key') || DEFAULT_KEY).trim() || DEFAULT_KEY,
          direction:
            (list.getAttribute('data-sort-direction') || DEFAULT_DIRECTION).trim() === 'desc' ? 'desc' : 'asc',
        };

        var normalizeValue = function (value) {
          if (value === null || value === undefined) {
            return '';
          }
          return String(value).trim();
        };

        var getRowValue = function (row, key) {
          if (!row || !key) {
            return '';
          }
          var attr = row.getAttribute('data-sort-' + key);
          if (attr !== null && attr !== undefined) {
            return attr;
          }
          return '';
        };

        var compareText = function (a, b) {
          var first = normalizeValue(a);
          var second = normalizeValue(b);
          return first.localeCompare(second, undefined, { sensitivity: 'base', numeric: true });
        };

        var compareRows = function (left, right, key) {
          var result = compareText(getRowValue(left, key), getRowValue(right, key));
          if (result !== 0) {
            return result;
          }
          result = compareText(getRowValue(left, DEFAULT_KEY), getRowValue(right, DEFAULT_KEY));
          if (result !== 0) {
            return result;
          }
          var idLeft = parseInt(left.getAttribute('data-task-definition-row'), 10) || 0;
          var idRight = parseInt(right.getAttribute('data-task-definition-row'), 10) || 0;
          if (idLeft < idRight) {
            return -1;
          }
          if (idLeft > idRight) {
            return 1;
          }
          return 0;
        };

        var updateHeaderState = function () {
          headers.forEach(function (header) {
            var key = (header.getAttribute('data-sort-key') || '').trim();
            var isActive = key === state.key;
            var direction = isActive ? state.direction : 'none';
            header.setAttribute('data-sort-state', direction);
            header.setAttribute(
              'aria-sort',
              direction === 'asc' ? 'ascending' : direction === 'desc' ? 'descending' : 'none'
            );
            var trigger = header.querySelector('[data-sort-trigger]');
            if (trigger) {
              trigger.setAttribute('data-active', isActive ? 'true' : 'false');
            }
          });
          list.setAttribute('data-sort-key', state.key);
          list.setAttribute('data-sort-direction', state.direction);
        };

        var applySort = function () {
          var rows = Array.prototype.slice.call(list.querySelectorAll('[data-task-definition-row]'));
          if (!rows.length) {
            return;
          }
          var activeKey = state.key || DEFAULT_KEY;
          var direction = state.direction === 'desc' ? 'desc' : 'asc';
          rows.sort(function (a, b) {
            var comparison = compareRows(a, b, activeKey);
            if (direction === 'desc') {
              comparison = -comparison;
            }
            return comparison;
          });
          var fragment = document.createDocumentFragment();
          rows.forEach(function (row) {
            fragment.appendChild(row);
          });
          list.appendChild(fragment);
          if (window.tmTaskGrouping && typeof window.tmTaskGrouping.reapply === 'function') {
            window.tmTaskGrouping.reapply();
          }
        };

        var cycleSort = function (key) {
          if (!key) {
            return;
          }
          if (state.key !== key) {
            state.key = key;
            state.direction = 'asc';
          } else if (state.direction === 'asc') {
            state.direction = 'desc';
          } else {
            state.key = DEFAULT_KEY;
            state.direction = DEFAULT_DIRECTION;
          }
          updateHeaderState();
          applySort();
        };

        headers.forEach(function (header) {
          var key = (header.getAttribute('data-sort-key') || '').trim();
          if (!key) {
            return;
          }
          var trigger = header.querySelector('[data-sort-trigger]') || header;
          trigger.addEventListener('click', function (event) {
            event.preventDefault();
            cycleSort(key);
          });
        });

        updateHeaderState();

        var defaultState = function () {
          return { key: DEFAULT_KEY, direction: DEFAULT_DIRECTION };
        };

        var isDefaultState = function () {
          return state.key === DEFAULT_KEY && state.direction === DEFAULT_DIRECTION;
        };

        var api = {
          getState: function () {
            return { key: state.key, direction: state.direction };
          },
          getDefaultState: function () {
            return defaultState();
          },
          resetToDefault: function (options) {
            state.key = DEFAULT_KEY;
            state.direction = DEFAULT_DIRECTION;
            updateHeaderState();
            if (!options || !options.silent) {
              applySort();
            }
          },
          isDefaultState: function () {
            return isDefaultState();
          },
          applyCurrentSort: function () {
            updateHeaderState();
            applySort();
          },
          handleRowsAppended: function () {
            if (isDefaultState()) {
              if (window.tmTaskGrouping && typeof window.tmTaskGrouping.reapply === 'function') {
                window.tmTaskGrouping.reapply();
              }
              return;
            }
            updateHeaderState();
            applySort();
          },
        };

        window.tmTaskSorting = api;

        if (!isDefaultState()) {
          applySort();
        }

        return api;
      };

      var setupTaskDefinitionDragReorder = function () {
        var list = document.querySelector('[data-task-definition-list]');
        if (!list) {
          window.tmTaskReorder = null;
          return null;
        }

        var reorderUrl = list.getAttribute('data-reorder-url');
        if (!reorderUrl) {
          window.tmTaskReorder = null;
          return null;
        }

        var tooltipNode = null;
        var tooltipTimer = null;
        var draggingState = null;

        var destroyTooltip = function () {
          if (tooltipTimer) {
            window.clearTimeout(tooltipTimer);
            tooltipTimer = null;
          }
          if (tooltipNode) {
            tooltipNode.remove();
            tooltipNode = null;
          }
        };

        var showTooltip = function (anchor, message) {
          if (!anchor || !message) {
            return;
          }
          destroyTooltip();
          var tooltip = document.createElement('div');
          tooltip.className = 'tm-reorder-tooltip';
          tooltip.textContent = message;
          document.body.appendChild(tooltip);
          var rect = anchor.getBoundingClientRect();
          var top = rect.top + window.scrollY - tooltip.offsetHeight - 10;
          if (top < window.scrollY + 12) {
            top = rect.bottom + window.scrollY + 12;
          }
          var left = rect.left + window.scrollX + rect.width / 2 - tooltip.offsetWidth / 2;
          var minLeft = window.scrollX + 12;
          var maxLeft = window.scrollX + (document.documentElement.clientWidth || window.innerWidth) - tooltip.offsetWidth - 12;
          if (left < minLeft) {
            left = minLeft;
          }
          if (left > maxLeft) {
            left = maxLeft;
          }
          tooltip.style.top = top + 'px';
          tooltip.style.left = left + 'px';
          tooltipNode = tooltip;
          tooltipTimer = window.setTimeout(destroyTooltip, 2200);
        };

        var getRows = function () {
          return Array.prototype.slice.call(list.querySelectorAll('[data-task-definition-row]'));
        };

        var getRowGroupKey = function (row) {
          if (!row) {
            return '';
          }
          return row.getAttribute('data-parent-group') || '';
        };

        var isGroupingActive = function () {
          var primary = (list.getAttribute('data-group-primary') || 'none').trim();
          var secondary = (list.getAttribute('data-group-secondary') || 'none').trim();
          return primary !== 'none' || secondary !== 'none';
        };

        var isSortDefault = function () {
          if (!window.tmTaskSorting || typeof window.tmTaskSorting.isDefaultState !== 'function') {
            return true;
          }
          return !!window.tmTaskSorting.isDefaultState();
        };

        var restoreOriginalOrder = function (snapshot) {
          if (!snapshot || !snapshot.length) {
            return;
          }
          var ordered = snapshot.slice().sort(function (a, b) {
            return a.order - b.order;
          });
          var fragment = document.createDocumentFragment();
          ordered.forEach(function (item) {
            if (!item || !item.element) {
              return;
            }
            item.element.setAttribute('data-display-order', String(item.order));
            item.element.setAttribute('data-sort-order', String(item.order));
            fragment.appendChild(item.element);
          });
          list.appendChild(fragment);
          if (isGroupingActive() && window.tmTaskGrouping && typeof window.tmTaskGrouping.reapply === 'function') {
            window.tmTaskGrouping.reapply();
          }
        };

        var markJustDropped = function (row) {
          if (!row) {
            return;
          }
          row.setAttribute('data-row-just-dropped', 'true');
          window.setTimeout(function () {
            row.removeAttribute('data-row-just-dropped');
          }, 1200);
        };

        var persistOrder = function (assignments, onSuccess, onError) {
          if (!assignments || !assignments.length) {
            if (typeof onSuccess === 'function') {
              onSuccess();
            }
            return;
          }
          list.setAttribute('data-reordering-active', 'true');
          fetch(reorderUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
              order: assignments.map(function (item) {
                return { id: item.id, order: item.order };
              }),
            }),
          })
            .then(function (response) {
              if (!response.ok) {
                throw new Error('No se pudo guardar el nuevo orden.');
              }
              return response.json();
            })
            .then(function () {
              if (typeof onSuccess === 'function') {
                onSuccess();
              }
            })
            .catch(function (error) {
              console.error(error);
              if (typeof onError === 'function') {
                onError(error);
              }
            })
            .finally(function () {
              list.removeAttribute('data-reordering-active');
            });
        };

        var finalizeDrag = function (options) {
          if (!draggingState) {
            return;
          }
          document.removeEventListener('pointermove', onPointerMove);
          document.removeEventListener('pointerup', onPointerUp);
          document.removeEventListener('pointercancel', onPointerCancel);
          if (draggingState.handle) {
            draggingState.handle.removeAttribute('data-dragging');
          }
          if (draggingState.row) {
            draggingState.row.removeAttribute('data-row-dragging');
          }
          document.body.classList.remove('tm-no-select');
          destroyTooltip();

          if (options && options.cancelled) {
            restoreOriginalOrder(draggingState.startSnapshot);
            draggingState = null;
            return;
          }

          var rows = getRows();
          if (!rows.length) {
            draggingState = null;
            return;
          }

          var orderValues = draggingState.sortedOrders;
          if (!orderValues || orderValues.length !== rows.length) {
            orderValues = rows
              .map(function (row) {
                return parseInt(row.getAttribute('data-display-order'), 10) || 0;
              })
              .sort(function (a, b) {
                return a - b;
              });
          }

          var originalOrderMap = new Map();
          draggingState.startSnapshot.forEach(function (item) {
            originalOrderMap.set(item.id, item.order);
          });

          var assignments = [];
          rows.forEach(function (row, index) {
            var id = parseInt(row.getAttribute('data-task-definition-row'), 10) || 0;
            if (!id) {
              return;
            }
            var newOrder = orderValues[index] !== undefined ? orderValues[index] : orderValues.length + index + 1;
            var previous = originalOrderMap.get(id);
            row.setAttribute('data-display-order', String(newOrder));
            row.setAttribute('data-sort-order', String(newOrder));
            if (previous !== newOrder) {
              assignments.push({ id: id, order: newOrder, element: row, previous: previous });
            }
          });

          if (!assignments.length) {
            draggingState = null;
            return;
          }

          persistOrder(
            assignments,
            function () {
              assignments.forEach(function (item) {
                markJustDropped(item.element);
              });
              if (isGroupingActive() && window.tmTaskGrouping && typeof window.tmTaskGrouping.reapply === 'function') {
                window.tmTaskGrouping.reapply();
              }
              if (window.tmTaskSorting && typeof window.tmTaskSorting.resetToDefault === 'function') {
                window.tmTaskSorting.resetToDefault({ silent: true });
              }
              draggingState = null;
            },
            function () {
              restoreOriginalOrder(draggingState.startSnapshot);
              if (window.tmTaskSorting && typeof window.tmTaskSorting.applyCurrentSort === 'function') {
                window.tmTaskSorting.applyCurrentSort();
              }
              if (draggingState && draggingState.handle) {
                showTooltip(draggingState.handle, 'No se pudo guardar el nuevo orden.');
              }
              draggingState = null;
            }
          );
        };

        var onPointerMove = function (event) {
          if (!draggingState) {
            return;
          }
          event.preventDefault();
          var target = document.elementFromPoint(event.clientX, event.clientY);
          if (!target) {
            return;
          }
          var targetRow = target.closest('[data-task-definition-row]');
          if (!targetRow || targetRow === draggingState.row) {
            return;
          }
          var activeGroupKey = draggingState.groupKey;
          if (activeGroupKey === undefined || activeGroupKey === null) {
            activeGroupKey = getRowGroupKey(draggingState.row);
          }
          activeGroupKey = activeGroupKey || '';
          var targetGroupKey = getRowGroupKey(targetRow) || '';
          if (targetGroupKey !== activeGroupKey) {
            return;
          }
          var rect = targetRow.getBoundingClientRect();
          var before = event.clientY < rect.top + rect.height / 2;
          if (before) {
            list.insertBefore(draggingState.row, targetRow);
          } else {
            var next = targetRow.nextElementSibling;
            if (next) {
              list.insertBefore(draggingState.row, next);
            } else {
              list.appendChild(draggingState.row);
            }
          }
        };

        var onPointerUp = function (event) {
          if (event) {
            event.preventDefault();
          }
          finalizeDrag({});
        };

        var onPointerCancel = function () {
          finalizeDrag({ cancelled: true });
        };

        var startDrag = function (handle, event) {
          if (draggingState) {
            return;
          }
          if (event.button !== 0 && event.pointerType !== 'touch') {
            return;
          }
          var row = handle.closest('[data-task-definition-row]');
          if (!row) {
            return;
          }
          var rows = getRows();
          if (rows.length <= 1) {
            showTooltip(handle, 'Agrega más tareas para reordenar.');
            return;
          }
          if (!isSortDefault()) {
            showTooltip(handle, 'Restablece el orden de columnas antes de arrastrar.');
            return;
          }
          var groupKey = getRowGroupKey(row);
          if (isGroupingActive()) {
            var groupRows = rows.filter(function (item) {
              return getRowGroupKey(item) === groupKey;
            });
            if (groupRows.length <= 1) {
              showTooltip(handle, 'No hay más tareas en este grupo para reordenar.');
              return;
            }
          }
          event.preventDefault();
          destroyTooltip();
          var snapshot = rows.map(function (item) {
            return {
              element: item,
              id: parseInt(item.getAttribute('data-task-definition-row'), 10) || 0,
              order: parseInt(item.getAttribute('data-display-order'), 10) || 0,
            };
          });
          var orderValues = snapshot
            .map(function (item) {
              return item.order;
            })
            .sort(function (a, b) {
              return a - b;
            });
          draggingState = {
            row: row,
            handle: handle,
            startSnapshot: snapshot,
            sortedOrders: orderValues,
            groupKey: groupKey,
          };
          row.setAttribute('data-row-dragging', 'true');
          handle.setAttribute('data-dragging', 'true');
          document.body.classList.add('tm-no-select');
          document.addEventListener('pointermove', onPointerMove);
          document.addEventListener('pointerup', onPointerUp);
          document.addEventListener('pointercancel', onPointerCancel);
        };

        var bindHandle = function (handle) {
          if (!handle || handle.getAttribute('data-reorder-bound') === 'true') {
            return;
          }
          handle.setAttribute('data-reorder-bound', 'true');
          handle.addEventListener('pointerdown', function (event) {
            startDrag(handle, event);
          });
        };

        var bindHandles = function (scope) {
          var context = scope || list;
          var handles = context.querySelectorAll('[data-task-drag-handle]');
          Array.prototype.forEach.call(handles, function (handle) {
            bindHandle(handle);
          });
        };

        bindHandles(list);

        var api = {
          bindRows: function (rows) {
            if (!rows) {
              bindHandles(list);
              return;
            }
            var collection = Array.isArray(rows) ? rows : Array.prototype.slice.call(rows);
            collection.forEach(function (row) {
              var handle = row.querySelector ? row.querySelector('[data-task-drag-handle]') : null;
              if (handle) {
                bindHandle(handle);
              }
            });
          },
          cancel: function () {
            finalizeDrag({ cancelled: true });
          },
        };

        window.tmTaskReorder = api;
        return api;
      };

      initializeFilterPickers();
      setupTaskDefinitionGrouping();
      setupTaskDefinitionSorting();
      setupTaskDefinitionDragReorder();

      var filterForm = document.querySelector('[data-task-definition-filter-form]');
      if (filterForm) {
        var applyTaskDefinitionFilters = function () {
          var params = new URLSearchParams(window.location.search);
          params.set('tm_tab', 'tareas');
          params.delete('page');

          var pickers = filterForm.querySelectorAll('[data-filter-picker]');
          pickers.forEach(function (picker) {
            var name = picker.getAttribute('data-filter-name');
            if (!name) {
              return;
            }
            var defaultValue = picker.getAttribute('data-filter-default-value') || '';
            var selectedValue = picker.getAttribute('data-selected-value');
            if (!selectedValue) {
              selectedValue = picker.getAttribute('data-filter-current-value') || defaultValue;
            }
            if (!selectedValue || selectedValue === defaultValue) {
              params.delete(name);
            } else {
              params.set(name, selectedValue);
            }
          });

          var scheduleStartInput = filterForm.querySelector('[data-schedule-filter-start]');
          var scheduleEndInput = filterForm.querySelector('[data-schedule-filter-end]');
          var scheduleStartValue = '';
          var scheduleEndValue = '';

          if (scheduleStartInput) {
            scheduleStartValue = (scheduleStartInput.value || '').trim();
            if (scheduleStartValue) {
              params.set('scheduled_start', scheduleStartValue);
            } else {
              params.delete('scheduled_start');
            }
          } else {
            params.delete('scheduled_start');
          }

          if (scheduleEndInput) {
            scheduleEndValue = (scheduleEndInput.value || '').trim();
            if (scheduleEndValue) {
              params.set('scheduled_end', scheduleEndValue);
            } else {
              params.delete('scheduled_end');
            }
          } else {
            params.delete('scheduled_end');
          }

          var query = params.toString();
          var target = window.location.pathname + (query ? '?' + query : '') + '#tm-tareas';
          window.location.assign(target);
        };

        filterForm.addEventListener('tm-filter-change', function () {
          applyTaskDefinitionFilters();
        });

        var scheduleInputs = filterForm.querySelectorAll('[data-schedule-filter-start], [data-schedule-filter-end]');
        if (scheduleInputs.length) {
          scheduleInputs.forEach(function (input) {
            input.addEventListener('change', function () {
              applyTaskDefinitionFilters();
            });
          });
        }

        var presetButtons = filterForm.querySelectorAll('[data-group-preset]');
        var clearGroupingButton = filterForm.querySelector('[data-group-clear]');
        var secondaryFieldset = filterForm.querySelector('[data-group-secondary-fieldset]');

        var updateGroupingClearState = function () {
          if (!clearGroupingButton) {
            return;
          }
          var currentPrimary =
            (window.tmFilterPickers && typeof window.tmFilterPickers.getValue === 'function'
              ? window.tmFilterPickers.getValue('group_primary')
              : null) || '';
          var currentSecondary =
            (window.tmFilterPickers && typeof window.tmFilterPickers.getValue === 'function'
              ? window.tmFilterPickers.getValue('group_secondary')
              : null) || '';
          var hasGrouping =
            (currentPrimary && currentPrimary !== 'none') || (currentSecondary && currentSecondary !== 'none');
          clearGroupingButton.classList.toggle('pointer-events-none', !hasGrouping);
          clearGroupingButton.classList.toggle('opacity-60', !hasGrouping);
          clearGroupingButton.toggleAttribute('disabled', !hasGrouping);
        };

        var updateSecondaryGroupingState = function () {
          var filtersApi = window.tmFilterPickers;
          if (!filtersApi || typeof filtersApi.getValue !== 'function') {
            return;
          }
          var primaryValue = filtersApi.getValue('group_primary') || '';
          var shouldDisable = !primaryValue || primaryValue === 'none';
          if (shouldDisable && filtersApi && typeof filtersApi.select === 'function') {
            filtersApi.select('group_secondary', 'none', { silent: true });
          }
          if (shouldDisable && filtersApi && typeof filtersApi.close === 'function') {
            filtersApi.close('group_secondary');
          }
          var secondaryPicker =
            filtersApi && typeof filtersApi.getPicker === 'function'
              ? filtersApi.getPicker('group_secondary')
              : null;
          if (!secondaryPicker) {
            return;
          }
          if (shouldDisable) {
            secondaryPicker.setAttribute('data-disabled', 'true');
          } else {
            secondaryPicker.removeAttribute('data-disabled');
          }
          var trigger = secondaryPicker.querySelector('[data-filter-trigger]');
          if (trigger) {
            trigger.toggleAttribute('disabled', shouldDisable);
            if (shouldDisable) {
              trigger.setAttribute('aria-disabled', 'true');
            } else {
              trigger.removeAttribute('aria-disabled');
            }
          }
          if (secondaryFieldset) {
            secondaryFieldset.classList.toggle('opacity-60', shouldDisable);
          }
        };

        var handleGroupingPreset = function (preset) {
          if (!preset) {
            return;
          }
          var parts = preset.split('-');
          var primaryValue = parts[0] || 'none';
          var secondaryValue = parts.length > 1 ? parts[1] : 'none';
          if (secondaryValue === primaryValue) {
            secondaryValue = 'none';
          }
          var filtersApi = window.tmFilterPickers;
          if (!filtersApi || typeof filtersApi.select !== 'function') {
            return;
          }
          var primaryChanged = filtersApi.select('group_primary', primaryValue, { silent: true });
          var secondaryChanged = filtersApi.select('group_secondary', secondaryValue, { silent: true });
          updateGroupingClearState();
          updateSecondaryGroupingState();
          if (primaryChanged || secondaryChanged) {
            applyTaskDefinitionFilters();
          }
        };

        if (presetButtons.length) {
          presetButtons.forEach(function (button) {
            button.addEventListener('click', function (event) {
              event.preventDefault();
              var preset = (button.getAttribute('data-group-preset') || '').trim();
              handleGroupingPreset(preset);
            });
          });
        }

        if (clearGroupingButton) {
          clearGroupingButton.addEventListener('click', function (event) {
            event.preventDefault();
            var filtersApi = window.tmFilterPickers;
            if (!filtersApi || typeof filtersApi.select !== 'function') {
              return;
            }
            var primaryCleared = filtersApi.select('group_primary', 'none', { silent: true });
            var secondaryCleared = filtersApi.select('group_secondary', 'none', { silent: true });
            updateGroupingClearState();
            updateSecondaryGroupingState();
            if (primaryCleared || secondaryCleared) {
              applyTaskDefinitionFilters();
            }
          });
          filterForm.addEventListener('tm-filter-change', function (event) {
            if (!event || !event.detail) {
              return;
            }
            if (event.detail.name === 'group_primary' || event.detail.name === 'group_secondary') {
              updateGroupingClearState();
              updateSecondaryGroupingState();
            }
          });
          updateGroupingClearState();
          updateSecondaryGroupingState();
        }

        updateGroupingClearState();
        updateSecondaryGroupingState();
      }

      var popover = document.createElement('div');
      popover.setAttribute('data-task-description-popover', '');
      popover.setAttribute('role', 'tooltip');
      popover.className = 'tm-description-popover';
      document.body.appendChild(popover);

      var activeToggle = null;
      var activeDesc = null;
      var activeIcon = null;

      var closePopover = function () {
        if (activeDesc) {
          activeDesc.setAttribute('data-state', 'collapsed');
        }
        if (activeToggle) {
          activeToggle.setAttribute('aria-expanded', 'false');
        }
        if (activeIcon) {
          activeIcon.classList.remove('rotate-180');
        }
        popover.style.display = 'none';
        popover.style.visibility = '';
        popover.innerHTML = '';
        activeToggle = null;
        activeDesc = null;
        activeIcon = null;
      };

      window.addEventListener(
        'scroll',
        function () {
          if (popover.style.display === 'block') {
            closePopover();
          }
        },
        true
      );

      window.addEventListener('resize', function () {
        if (popover.style.display === 'block') {
          closePopover();
        }
      });

      var initializeTaskDescriptionToggles = function (root) {
        var scope = root || document;
        var descriptions = scope.querySelectorAll('[data-task-description]');
        descriptions.forEach(function (desc) {
          if (desc.getAttribute('data-description-bound') === 'true') {
            return;
          }
          var toggleSelector = '[data-task-description-toggle][data-target="' + desc.id + '"]';
          var toggle = (scope === document ? document : scope).querySelector(toggleSelector);
          if (!toggle) {
            toggle = document.querySelector(toggleSelector);
          }
          if (!toggle) {
            return;
          }
          if (!desc.textContent || !desc.textContent.trim()) {
            return;
          }
          var toggleText = toggle.querySelector('[data-toggle-text]');
          var toggleIcon = toggle.querySelector('[data-toggle-icon]');
          var row = toggle.closest('tr');

          toggle.classList.remove('hidden');
          toggle.setAttribute('aria-expanded', 'false');
          if (toggleText) {
            toggleText.textContent = 'Descripción';
          }
          desc.setAttribute('data-state', 'collapsed');
          desc.setAttribute('data-description-bound', 'true');

          var showPopover = function () {
            if (activeToggle === toggle) {
              return;
            }
            closePopover();
            activeToggle = toggle;
            activeDesc = desc;
            activeIcon = toggleIcon;
            toggle.setAttribute('aria-expanded', 'true');
            desc.setAttribute('data-state', 'expanded');
            if (toggleIcon) {
              toggleIcon.classList.add('rotate-180');
            }

            popover.innerHTML = desc.innerHTML;
            popover.style.display = 'block';
            popover.style.visibility = 'hidden';
            popover.style.width = '';
            popover.style.setProperty('--tm-popover-arrow-left', '56px');
            popover.setAttribute('data-placement', 'bottom');

            var referenceRect = row ? row.getBoundingClientRect() : toggle.getBoundingClientRect();
            var scrollY = window.pageYOffset || document.documentElement.scrollTop;
            var scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            var viewportWidth = document.documentElement.clientWidth;
            var maxWidth = Math.min(referenceRect.width, viewportWidth - 32);
            popover.style.width = maxWidth + 'px';

            var left = referenceRect.left + scrollX;
            var viewportLeft = scrollX + 16;
            if (left < viewportLeft) {
              left = viewportLeft;
            }
            var rightBoundary = scrollX + viewportWidth - 16;
            if (left + maxWidth > rightBoundary) {
              left = Math.max(viewportLeft, rightBoundary - maxWidth);
            }
            popover.style.left = left + 'px';

            var top = referenceRect.bottom + scrollY + 6;
            popover.style.top = top + 'px';
            popover.style.visibility = 'visible';

            var popRect = popover.getBoundingClientRect();
            if (popRect.bottom > window.innerHeight - 16) {
              var alternateTop = referenceRect.top + scrollY - popRect.height - 12;
              if (alternateTop > scrollY + 16) {
                popover.style.top = alternateTop + 'px';
                popover.setAttribute('data-placement', 'top');
              }
            }
            popRect = popover.getBoundingClientRect();
            var toggleRect = toggle.getBoundingClientRect();
            var arrowLeft = toggleRect.left + toggleRect.width / 2 - popRect.left;
            arrowLeft = Math.max(12, Math.min(popRect.width - 24, arrowLeft));
            popover.style.setProperty('--tm-popover-arrow-left', arrowLeft + 'px');
          };

          toggle.addEventListener('click', function (event) {
            event.preventDefault();
            if (activeToggle === toggle && popover.style.display === 'block') {
              closePopover();
            } else {
              showPopover();
            }
          });

          toggle.addEventListener('blur', function () {
            if (activeToggle === toggle) {
              closePopover();
            }
          });
        });
      };

      initializeTaskDescriptionToggles(document);
      window.tmInitializeTaskDescriptions = initializeTaskDescriptionToggles;

      var setupTaskDefinitionAutoload = function () {
        var list = document.querySelector('[data-task-definition-list]');
        var sentinel = document.querySelector('[data-task-definition-sentinel]');
        if (!list || !sentinel) {
          return;
        }
        var fetchUrl = list.getAttribute('data-fetch-url');
        if (!fetchUrl) {
          return;
        }

        var loader = document.querySelector('[data-task-definition-loader]');
        var summary = document.querySelector('[data-task-definition-summary]');
        var summaryStart = summary ? summary.querySelector('[data-task-summary-start]') : null;
        var summaryEnd = summary ? summary.querySelector('[data-task-summary-end]') : null;
        var summaryTotal = summary ? summary.querySelector('[data-task-summary-total]') : null;

        var baseQuery = list.getAttribute('data-querystring') || '';
        if (baseQuery && baseQuery.charAt(0) === '?') {
          baseQuery = baseQuery.slice(1);
        }

        var parseIntAttr = function (element, attribute) {
          if (!element) {
            return 0;
          }
          var raw = element.getAttribute(attribute);
          if (!raw) {
            return 0;
          }
          var value = parseInt(raw, 10);
          return Number.isNaN(value) ? 0 : value;
        };

        var toggleLoader = function (show) {
          if (!loader) {
            return;
          }
          if (show) {
            loader.classList.remove('hidden');
          } else {
            loader.classList.add('hidden');
          }
        };

        var hasNext = list.getAttribute('data-has-next') === 'true';
        var nextPage = parseIntAttr(list, 'data-next-page');
        var currentPage = parseIntAttr(list, 'data-current-page') || 1;
        if (!nextPage && hasNext) {
          nextPage = currentPage + 1;
        }
        var isLoading = false;

        var updateSummary = function (payload) {
          if (!summary) {
            return;
          }
          var total = typeof payload.count === 'number' ? payload.count : parseIntAttr(summary, 'data-total-count');
          var startIndex = parseIntAttr(summary, 'data-summary-start');
          var endIndex = parseIntAttr(summary, 'data-summary-end');

          if (typeof payload.start_index === 'number' && payload.start_index > 0) {
            if (!startIndex || payload.start_index < startIndex) {
              startIndex = payload.start_index;
            }
          }

          if (typeof payload.end_index === 'number' && payload.end_index > 0) {
            if (!endIndex || payload.end_index > endIndex) {
              endIndex = payload.end_index;
            }
          }

          summary.setAttribute('data-total-count', String(total));
          summary.setAttribute('data-summary-start', String(startIndex || 0));
          summary.setAttribute('data-summary-end', String(endIndex || 0));

          if (summaryStart) {
            summaryStart.textContent = startIndex ? String(startIndex) : '0';
          }
          if (summaryEnd) {
            summaryEnd.textContent = endIndex ? String(endIndex) : '0';
          }
          if (summaryTotal) {
            summaryTotal.textContent = String(total || 0);
          }
        };

        var refreshHighlight = function () {
          if (typeof highlightTaskDefinitionRow !== 'function' || !document.body) {
            return;
          }
          var highlightId = document.body.getAttribute('data-task-highlight-id');
          if (!highlightId) {
            return;
          }
          var applied = highlightTaskDefinitionRow(highlightId);
          if (applied) {
            document.body.setAttribute('data-task-highlight-id', '');
          }
        };

        var rebindNewRows = function (rows) {
          if (!rows || !rows.length) {
            return;
          }
          rows.forEach(function (row) {
            if (typeof window.tmInitializeTaskDescriptions === 'function') {
              window.tmInitializeTaskDescriptions(row);
            }
            if (typeof attachConfirmation === 'function') {
              var confirmationForms = row.querySelectorAll('[data-confirmation]');
              Array.prototype.forEach.call(confirmationForms, function (form) {
                attachConfirmation(form);
              });
            }
          });
          if (typeof setupTaskDefinitionActions === 'function') {
            setupTaskDefinitionActions();
          }
          if (window.tmTaskReorder && typeof window.tmTaskReorder.bindRows === 'function') {
            window.tmTaskReorder.bindRows(rows);
          }
          if (window.tmTaskSorting && typeof window.tmTaskSorting.handleRowsAppended === 'function') {
            window.tmTaskSorting.handleRowsAppended();
          } else if (window.tmTaskGrouping && typeof window.tmTaskGrouping.reapply === 'function') {
            window.tmTaskGrouping.reapply();
          }
        };

        var buildRequestUrl = function (page) {
          var params = baseQuery ? new URLSearchParams(baseQuery) : new URLSearchParams();
          params.set('page', String(page));
          return fetchUrl + '?' + params.toString();
        };

        var observer = new IntersectionObserver(
          function (entries) {
            if (!entries || !entries.length) {
              return;
            }
            entries.forEach(function (entry) {
              if (!entry.isIntersecting) {
                return;
              }
              if (isLoading || !hasNext || !nextPage) {
                return;
              }
              fetchNext();
            });
          },
          {
            root: null,
            rootMargin: '0px 0px 320px 0px',
            threshold: 0,
          }
        );

        var fetchNext = function () {
          if (isLoading || !hasNext || !nextPage) {
            return;
          }
          isLoading = true;
          toggleLoader(true);
          var requestUrl = buildRequestUrl(nextPage);
          var finalize = function () {
            isLoading = false;
            toggleLoader(false);
          };

          fetch(requestUrl, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          })
            .then(function (response) {
              if (!response.ok) {
                throw new Error('No fue posible cargar más tareas.');
              }
              return response.json();
            })
            .then(function (payload) {
              if (payload && payload.rows_html) {
                var wrapper = document.createElement('tbody');
                wrapper.innerHTML = payload.rows_html;
                var newRows = Array.prototype.slice.call(wrapper.children);
                if (newRows.length) {
                  var emptyRow = list.querySelector('[data-task-definition-empty]');
                  if (emptyRow) {
                    emptyRow.remove();
                  }
                  newRows.forEach(function (row) {
                    list.appendChild(row);
                  });
                  rebindNewRows(newRows);
                }
              }

              if (payload && typeof payload.page === 'number') {
                list.setAttribute('data-current-page', String(payload.page));
              }
              if (payload && typeof payload.start_index === 'number') {
                var currentStart = parseIntAttr(list, 'data-start-index');
                if (!currentStart || payload.start_index < currentStart) {
                  currentStart = payload.start_index;
                }
                list.setAttribute('data-start-index', String(currentStart));
              }
              if (payload && typeof payload.end_index === 'number') {
                list.setAttribute('data-end-index', String(payload.end_index));
              }
              if (payload && typeof payload.count === 'number') {
                list.setAttribute('data-total-count', String(payload.count));
              }

              hasNext = !!(payload && payload.has_next);
              nextPage = payload && payload.next_page ? payload.next_page : null;
              list.setAttribute('data-has-next', hasNext ? 'true' : 'false');
              list.setAttribute('data-next-page', nextPage ? String(nextPage) : '');

              updateSummary(payload || {});
              refreshHighlight();

              if (!hasNext && observer) {
                observer.unobserve(sentinel);
              }
            })
            .catch(function (error) {
              console.error(error);
            })
            .then(finalize, finalize);
        };

        if (hasNext) {
          observer.observe(sentinel);
        }

        refreshHighlight();
      };

      setupTaskDefinitionAutoload();

      document.addEventListener('click', function (event) {
        if (popover.style.display !== 'block') {
          return;
        }
        if (popover.contains(event.target)) {
          return;
        }
        if (activeToggle && activeToggle.contains(event.target)) {
          return;
        }
        closePopover();
      });

      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && popover.style.display === 'block') {
          closePopover();
        }
      });
    });
  </script>
  <script>
    (function () {
      var tabContainer = document.querySelector('[data-tm-tabs]');
      if (!tabContainer) {
        return;
      }
      var buttons = Array.prototype.slice.call(tabContainer.querySelectorAll('.tab-button[data-tm-tab]'));
      var panels = Array.prototype.slice.call(tabContainer.querySelectorAll('[data-tm-panel]'));
      function findButton(tabId) {
        return buttons.find(function (button) {
          return button.getAttribute('data-tm-tab') === tabId;
        });
      }
      function isDisabled(button) {
        return !!(button && (button.disabled || button.getAttribute('aria-disabled') === 'true'));
      }
      function activate(tabId, options) {
        var shouldFocus = true;
        if (options && Object.prototype.hasOwnProperty.call(options, 'focus')) {
          shouldFocus = !!options.focus;
        }
        panels.forEach(function (panel) {
          var isActive = panel.getAttribute('data-tm-panel') === tabId;
          panel.classList.toggle('hidden', !isActive);
        });
        buttons.forEach(function (button) {
          var isActive = button.getAttribute('data-tm-tab') === tabId;
          button.setAttribute('aria-selected', isActive ? 'true' : 'false');
          button.classList.toggle('bg-slate-900', isActive);
          button.classList.toggle('text-white', isActive);
        });
        var target = tabContainer.querySelector('[data-tm-panel="' + tabId + '"]');
        if (shouldFocus && target) {
          target.setAttribute('tabindex', '-1');
          target.focus();
          target.removeAttribute('tabindex');
        }
      }
      function tryActivate(tabId, options) {
        if (!tabId) {
          return false;
        }
        var targetButton = findButton(tabId);
        if (!targetButton || isDisabled(targetButton)) {
          return false;
        }
        activate(tabId, options);
        return true;
      }
      buttons.forEach(function (button) {
        if (isDisabled(button)) {
          button.setAttribute('aria-disabled', 'true');
          button.setAttribute('tabindex', '-1');
          return;
        }
        button.addEventListener('click', function () {
          activate(button.getAttribute('data-tm-tab'));
        });
      });
      var params = new URLSearchParams(window.location.search);
      var tabFromQuery = params.get('tm_tab');
      if (tryActivate(tabFromQuery, { focus: false })) {
        return;
      }
      var hash = window.location.hash;
      if (hash && hash.indexOf('#tm-') === 0) {
        var tabId = hash.slice(4);
        if (tryActivate(tabId, { focus: false })) {
          return;
        }
      }
      activate('tareas', { focus: false });
    })();
  </script>
{% endblock %}
