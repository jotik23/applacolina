{% extends 'calendario/base.html' %}

{% block title %}Detalle calendario | {{ calendar.name|default:'Sin título' }}{% endblock %}

{% block content %}
<script>
  if (typeof document !== 'undefined' && document.body) {
    document.body.dataset.calendarCurrentId = '{{ calendar.id }}';
  }
</script>
<style>
  th[data-calendar-highlight="true"],
  td[data-calendar-highlight="true"] {
    position: relative;
  }

  td[data-calendar-highlight="true"]::after,
  th[data-calendar-highlight="true"]::after {
    content: '';
    position: absolute;
    inset: 0.35rem;
    border-radius: 0.75rem;
    background-color: rgba(79, 70, 229, 0.12);
    pointer-events: none;
    transition: opacity 200ms ease;
    opacity: 1;
    z-index: 0;
  }

  th[data-calendar-highlight="true"]::after {
    inset: 0.25rem 0.35rem 0 0.35rem;
    border-radius: 0.75rem 0.75rem 0 0;
    background-color: rgba(79, 70, 229, 0.18);
  }

  td[data-calendar-highlight="true"] > *,
  th[data-calendar-highlight="true"] > * {
    position: relative;
    z-index: 1;
  }

  th[data-calendar-highlight="true"] span {
    color: #3730a3;
  }
</style>
<div class="flex flex-col gap-6 min-w-0">
  <section class="rounded-2xl bg-white shadow-sm">
    <div class="flex flex-col gap-6 px-4 py-6 sm:px-6 lg:px-8">
      <div class="flex flex-col gap-4 lg:gap-6">
        <h1 class="sr-only">Detalle calendario {{ calendar.name|default:"sin título" }}</h1>
        <div
          class="flex w-full flex-col items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50/80 p-4 sm:flex-row sm:items-center sm:gap-4 lg:rounded-none lg:border-0 lg:bg-transparent lg:p-0"
          data-calendar-navigator
          data-current-calendar-id="{{ calendar.id }}"
        >
          <div class="flex w-full justify-center gap-2 sm:w-auto sm:justify-start">
            <button
              type="button"
              class="inline-flex w-full items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand focus-visible:ring-offset-2 sm:w-auto"
              data-calendar-nav="prev"
            >
              <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path
                  fill-rule="evenodd"
                  d="M12.78 4.22a.75.75 0 010 1.06L8.56 9.5l4.22 4.22a.75.75 0 01-1.06 1.06l-4.75-4.75a.75.75 0 010-1.06l4.75-4.75a.75.75 0 011.06 0z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>Anterior</span>
            </button>
            <button
              type="button"
              class="inline-flex w-full items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand focus-visible:ring-offset-2 sm:w-auto"
              data-calendar-nav="next"
            >
              <span>Siguiente</span>
              <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path
                  fill-rule="evenodd"
                  d="M7.22 4.22a.75.75 0 011.06 0l4.75 4.75a.75.75 0 010 1.06l-4.75 4.75a.75.75 0 01-1.06-1.06L10.94 10 7.22 6.28a.75.75 0 010-1.06z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
          <div class="flex w-full justify-center sm:flex-1">
            <div class="relative w-full sm:min-w-[320px] sm:max-w-lg lg:max-w-2xl" data-calendar-picker>
              <button
                type="button"
                class="flex w-full items-center justify-between gap-4 rounded-2xl border border-slate-200 bg-white px-5 py-4 text-left shadow-sm transition hover:border-brand/40 hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand focus-visible:ring-offset-2"
                data-calendar-picker-trigger
                aria-haspopup="true"
                aria-expanded="false"
              >
                <div class="min-w-0 flex-1">
                  <span class="flex items-center gap-2 text-xl font-semibold leading-tight text-slate-900">
                    <span class="truncate" data-calendar-picker-label>{{ calendar.name|default:"Calendario sin título" }}</span>
                    {% if calendar.status == 'draft' %}
                      <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-600">Borrador</span>
                    {% elif calendar.status == 'approved' %}
                      <span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Aprobado</span>
                    {% elif calendar.status == 'modified' %}
                      <span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-amber-700">Modificado</span>
                    {% else %}
                      <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-600">{{ calendar.get_status_display|default:calendar.status }}</span>
                    {% endif %}
                    {% if calendar_latest_modification %}
                      <span class="inline-flex items-center gap-1.5 rounded-full border border-slate-200 bg-white px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                        <svg class="h-3.5 w-3.5 text-slate-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-12.25a.75.75 0 00-1.5 0v4.5c0 .199.079.39.22.53l2.25 2.25a.75.75 0 101.06-1.06l-2.03-2.03V5.75z"
                            clip-rule="evenodd"
                          />
                        </svg>
                        Último cambio
                        {{ calendar_latest_modification|date:"d/m/Y H:i" }}
                      </span>
                    {% endif %}
                  </span>
                  <span class="mt-1 block text-xs text-slate-500" data-calendar-picker-range>{{ calendar.start_date }} → {{ calendar.end_date }}</span>
                </div>
                <svg class="h-4 w-4 flex-none text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path
                    fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 11.208l3.71-3.978a.75.75 0 111.08 1.04l-4.24 4.54a.75.75 0 01-1.08 0l-4.24-4.54a.75.75 0 01.02-1.06z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div
                class="invisible absolute left-0 top-full z-30 mt-2 w-full max-h-80 overflow-hidden rounded-xl border border-slate-200 bg-white opacity-0 shadow-lg shadow-slate-900/10 transition duration-150 ease-out"
                data-calendar-picker-panel
              >
                <div class="border-b border-slate-100 bg-slate-50/70 px-4 py-3">
                  <label class="flex items-center gap-2 rounded-lg bg-white px-3 py-2 text-xs text-slate-500 focus-within:ring-2 focus-within:ring-brand focus-within:ring-offset-2 focus-within:ring-offset-white">
                    <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path
                        fill-rule="evenodd"
                        d="M9 3.5a5.5 5.5 0 014.384 8.776l3.17 3.17a.75.75 0 11-1.06 1.06l-3.17-3.17A5.5 5.5 0 119 3.5zm0 1.5a4 4 0 100 8 4 4 0 000-8z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <input
                      type="search"
                      class="flex-1 border-0 bg-transparent text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none"
                      placeholder="Filtrar por nombre o fecha…"
                      data-calendar-picker-search
                    />
                  </label>
                </div>
                <div class="max-h-64 overflow-y-auto" data-calendar-picker-list>
                  <div class="px-4 py-3 text-xs text-slate-400">Cargando calendarios…</div>
                </div>
              </div>
            </div>
          </div>
          <div class="flex w-full flex-col items-center gap-2 sm:w-52 sm:flex-none sm:items-end sm:ml-auto">
            <div class="flex w-full flex-col gap-2 sm:flex-row">
              {% if calendar.status != 'approved' %}
                <form method="post" class="w-full sm:flex-1" data-confirmation>
                  {% csrf_token %}
                  <input type="hidden" name="action" value="approve" />
                  <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-brand px-5 py-2.5 text-sm font-semibold text-white shadow hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2" data-confirmation-trigger>
                    Aprobar calendario
                  </button>
                  <div class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-confirmation-overlay>
                    <div class="w-full max-w-sm rounded-xl border border-slate-200 bg-white p-4 text-left text-sm shadow-lg">
                      <p class="font-semibold text-slate-900">¿Aprobar este calendario?</p>
                      <p class="mt-1 text-xs text-slate-500">Se publicará para uso operativo.</p>
                      <div class="mt-3 flex justify-end gap-2">
                        <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-confirmation-cancel data-confirmation-focus>Cancelar</button>
                        <button type="button" class="inline-flex items-center rounded-full bg-brand px-3 py-1.5 text-xs font-semibold text-white shadow hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-1" data-confirmation-confirm>Aprobar</button>
                      </div>
                    </div>
                  </div>
                </form>
              {% else %}
                <div class="flex w-full flex-col gap-1 text-xs items-center sm:items-end sm:flex-1">
                  <div class="flex flex-col items-start gap-2 text-sm font-medium text-slate-500 sm:items-end w-full">
                    <span class="w-full text-center sm:text-right">
                      {% if calendar.approved_by %}
                        Aprobado por {{ calendar.approved_by.get_full_name|default:calendar.approved_by }} el {{ calendar.approved_at|date:"d/m/Y H:i" }}
                      {% else %}
                        Aprobado el {{ calendar.approved_at|date:"d/m/Y H:i" }}
                      {% endif %}
                    </span>
                    <form method="post" class="contents">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="mark-modified" />
                      <button type="submit" class="inline-flex w-full items-center justify-between gap-2 rounded-lg border border-slate-200 bg-white/80 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 hover:border-brand hover:text-brand focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-1">
                        <span>Marcar modificada</span>
                        <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 11-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                      </button>
                    </form>
                  </div>
                </div>
              {% endif %}
              <div class="flex w-full flex-wrap items-center gap-2">
                {% if calendar_share_public_url %}
                  <button
                    type="button"
                    class="inline-flex w-full items-center justify-center gap-2 rounded-2xl border border-emerald-300 bg-white px-5 py-2.5 text-sm font-semibold text-emerald-700 shadow hover:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:ring-offset-2 sm:w-auto"
                    data-whatsapp-share
                    data-whatsapp-link="{{ calendar_share_public_url|escapejs }}"
                    {% if calendar_whatsapp_message %}
                      data-whatsapp-message="{{ calendar_whatsapp_message|escapejs }}"
                    {% endif %}
                    aria-label="Compartir calendario por WhatsApp"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" class="h-5 w-5" aria-hidden="true">
                      <path
                        fill="#25d366"
                        d="M16 3C9.38 3 4 8.25 4 14.71c0 2.87.98 5.51 2.63 7.62L4 29l6.91-2.25c1.81.99 3.9 1.56 6.09 1.56 6.62 0 12-5.25 12-11.71S22.62 3 16 3z"
                      />
                      <path
                        fill="#fff"
                        d="M24.38 20.5c-.34.96-1.69 1.77-2.38 1.84-.61.06-1.4.09-2.26-.14-.52-.13-1.19-.39-2.05-.76-3.61-1.56-5.94-5.14-6.12-5.38-.18-.24-1.44-1.93-1.44-3.68s.91-2.61 1.23-2.96c.34-.35.74-.44.99-.44h.72c.23 0 .55-.08.86.65.34.79 1.08 2.73 1.17 2.93.09.2.14.44.03.68-.12.24-.18.39-.35.6-.18.21-.37.47-.53.63-.18.18-.37.38-.16.75.21.35.94 1.53 2.02 2.48 1.39 1.23 2.57 1.62 2.96 1.8.37.18.58.15.79-.09.21-.24.92-1.08 1.17-1.45.24-.35.49-.3.82-.18.34.12 2.13 1.01 2.5 1.2.37.18.61.27.7.41.1.14.1.84-.24 1.8z"
                      />
                    </svg>
                    Compartir
                  </button>
                {% endif %}
                {% if calendar_share_options %}
                  <div class="relative inline-flex" data-calendar-share-panel>
                    <button
                      type="button"
                      class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-slate-600 shadow-sm transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand focus-visible:ring-offset-2"
                      data-share-panel-trigger
                      aria-haspopup="true"
                      aria-expanded="false"
                    >
                      <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path
                          fill-rule="evenodd"
                          d="M10 3a.75.75 0 01.75.75V6.5h2.75a.75.75 0 010 1.5H10.75v5h2.75a.75.75 0 010 1.5H10.75v2.75a.75.75 0 01-1.5 0V14.5H6.5a.75.75 0 010-1.5h2.75v-5H6.5a.75.75 0 010-1.5h2.75V3.75A.75.75 0 0110 3z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      <span class="hidden sm:inline">Texto personalizado</span>
                      <span class="sm:hidden">Opciones</span>
                    </button>
                    <div
                      class="invisible absolute right-0 top-full z-30 mt-2 w-80 origin-top-right rounded-2xl border border-slate-200 bg-white p-4 text-left text-sm opacity-0 shadow-2xl transition data-[open='true']:visible data-[open='true']:opacity-100"
                      data-share-panel-content
                      data-open="false"
                      role="dialog"
                      aria-hidden="true"
                    >
                      <div class="flex items-center justify-between gap-2">
                        <p class="text-sm font-semibold text-slate-900">Compartir por WhatsApp</p>
                        <button type="button" class="rounded-full p-1 text-slate-500 hover:bg-slate-100" data-share-panel-close>
                          <span class="sr-only">Cerrar panel</span>
                          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 6l8 8m0-8l-8 8" />
                          </svg>
                        </button>
                      </div>
                      <p class="mt-1 text-xs text-slate-500">El mensaje incluye turnos asignados y descansos en el rango seleccionado.</p>
                      <form
                        class="mt-4 flex flex-col gap-3 text-sm"
                        data-calendar-share-form
                        data-share-url="{{ calendar_share_options.url }}"
                      >
                        <div class="grid grid-cols-2 gap-2">
                          <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-500">
                            Desde
                            <input
                              type="date"
                              name="start_date"
                              value="{{ calendar.start_date|date:'Y-m-d' }}"
                              min="{{ calendar.start_date|date:'Y-m-d' }}"
                              max="{{ calendar.end_date|date:'Y-m-d' }}"
                              class="rounded-lg border border-slate-200 px-3 py-1.5 text-sm text-slate-700 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/30"
                              data-share-start
                            />
                          </label>
                          <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-500">
                            Hasta
                            <input
                              type="date"
                              name="end_date"
                              value="{{ calendar.end_date|date:'Y-m-d' }}"
                              min="{{ calendar.start_date|date:'Y-m-d' }}"
                              max="{{ calendar.end_date|date:'Y-m-d' }}"
                              class="rounded-lg border border-slate-200 px-3 py-1.5 text-sm text-slate-700 focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/30"
                              data-share-end
                            />
                          </label>
                        </div>
                        <div>
                          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Áreas a incluir</p>
                          <div class="mt-2 flex flex-wrap gap-1.5" role="group" aria-label="Áreas disponibles">
                            {% for option in calendar_share_options.job_types %}
                              <button
                                type="button"
                                class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-600 transition data-[active='true']:border-brand data-[active='true']:bg-brand/5 data-[active='true']:text-brand"
                                data-share-job-type="{{ option.value }}"
                                data-active="true"
                                aria-pressed="true"
                                title="Incluir {{ option.label }}"
                              >
                                {{ option.short_label }}
                              </button>
                            {% endfor %}
                          </div>
                        </div>
                        <button
                          type="button"
                          class="inline-flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 px-3 py-1.5 text-xs font-semibold text-slate-600 transition data-[active='true']:border-emerald-300 data-[active='true']:bg-emerald-50 data-[active='true']:text-emerald-700"
                          data-share-rest-only
                          data-active="false"
                          aria-pressed="false"
                        >
                          Solo descansos
                          <span class="rounded-full border border-current px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide" data-share-rest-indicator>
                            off
                          </span>
                        </button>
                        <p class="hidden text-xs font-medium text-red-600" data-share-feedback></p>
                        <button
                          type="button"
                          class="inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 focus-visible:ring-offset-2"
                          data-share-submit
                        >
                          <span>Enviar por WhatsApp</span>
                          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path d="M3 10a.75.75 0 01.75-.75h8.638L9.7 6.11a.75.75 0 111.06-1.06l4.243 4.242a.75.75 0 010 1.061l-4.243 4.243a.75.75 0 11-1.06-1.06l2.686-2.686H3.75A.75.75 0 013 10z" />
                          </svg>
                        </button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="flex w-full justify-end gap-2 text-xs">
              {% if calendar.status != 'approved' %}
                <form method="post" class="contents" data-confirmation>
                  {% csrf_token %}
                  <input type="hidden" name="action" value="regenerate" />
                  <button type="submit" class="inline-flex items-center gap-1.5 rounded-lg border border-amber-200 bg-white/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-amber-700 hover:border-amber-300 hover:text-amber-800 focus:outline-none focus:ring-2 focus:ring-amber-200 focus:ring-offset-1" data-confirmation-trigger>
                    <span>Regenerar</span>
                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M3.172 7.172a4 4 0 015.656 0l.172.172.172-.172a4 4 0 115.656 5.656l-5.15 5.15a.75.75 0 01-1.06 0l-5.15-5.15a4 4 0 010-5.656z" clip-rule="evenodd" />
                    </svg>
                  </button>
                  <div class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-confirmation-overlay>
                    <div class="w-full max-w-sm rounded-xl border border-slate-200 bg-white p-4 text-left text-sm shadow-lg">
                      <p class="font-semibold text-slate-900">¿Regenerar este calendario?</p>
                      <p class="mt-1 text-xs text-slate-500">Se reemplazarán las asignaciones actuales por una nueva versión sugerida.</p>
                      <div class="mt-3 flex justify-end gap-2">
                        <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-confirmation-cancel data-confirmation-focus>Cancelar</button>
                        <button type="button" class="inline-flex items-center rounded-full bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-1" data-confirmation-confirm>Regenerar</button>
                      </div>
                    </div>
                  </div>
                </form>
              {% endif %}
              <div class="relative" data-double-confirm>
                <button type="button" class="inline-flex items-center gap-1.5 rounded-lg border border-red-200 bg-white/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-red-600 hover:border-red-300 hover:text-red-700 focus:outline-none focus:ring-2 focus:ring-red-200 focus:ring-offset-1" data-double-confirm-trigger>
                  <span>Eliminar</span>
                  <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M6.28 5.22a.75.75 0 011.06 0L10 7.939l2.66-2.72a.75.75 0 111.08 1.04L11.09 9l2.65 2.74a.75.75 0 11-1.08 1.04L10 10.06l-2.66 2.72a.75.75 0 11-1.08-1.04L8.91 9 6.25 6.26a.75.75 0 010-1.04z" clip-rule="evenodd" />
                  </svg>
                </button>
                <div class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-double-confirm-panel>
                  <div class="w-full max-w-sm rounded-xl border border-slate-200 bg-white p-4 text-left text-sm shadow-lg">
                    <p class="font-semibold text-slate-900">¿Eliminar este calendario?</p>
                    <p class="mt-1 text-xs text-slate-500">Se eliminarán todas las asignaciones relacionadas.</p>
                    <div class="mt-3 flex justify-end gap-2">
                      <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-double-confirm-cancel data-double-confirm-focus>Cancelar</button>
                      <button type="button" class="inline-flex items-center rounded-full bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400" data-double-confirm-continue>Confirmar</button>
                    </div>
                  </div>
                </div>
                <form method="post" action="{% url 'personal:calendar-delete' calendar.pk %}" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-double-confirm-final>
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ calendar_home_url }}" />
                  <div class="w-full max-w-sm rounded-xl border border-red-200 bg-white p-4 text-left shadow-lg">
                    <p class="text-sm font-semibold text-red-700">Confirmación final</p>
                    <p class="mt-1 text-xs text-slate-500">Esta acción es irreversible.</p>
                    <div class="mt-3 flex justify-end gap-2">
                      <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-double-confirm-cancel>Cancelar</button>
                      <button type="submit" class="inline-flex items-center rounded-full bg-red-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300" data-double-confirm-final-submit data-double-confirm-focus>Eliminar definitivamente</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        {% if calendar.base_calendar %}
          <div class="flex justify-center text-xs text-slate-500">
            <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1 font-medium text-slate-600">Modifica: #{{ calendar.base_calendar_id }}</span>
          </div>
        {% endif %}
      </div>
    </div>
  </section>


  <section class="rounded-2xl bg-white shadow-sm min-w-0">
    <div class="flex flex-col gap-6 px-4 py-6 sm:px-6 lg:px-8">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-slate-900">Asignaciones</h2>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
          {% if can_override and has_manual_choices %}
            <span class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-indigo-700">
              <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M2.879 2.879a3 3 0 014.242 0L10 5.757l2.879-2.878a3 3 0 014.242 4.242L14.243 10l2.878 2.879a3 3 0 11-4.242 4.242L10 14.243l-2.879 2.878a3 3 0 01-4.242-4.242L5.757 10 2.879 7.121a3 3 0 010-4.242z" clip-rule="evenodd" />
              </svg>
              Reasignación manual activa
            </span>
          {% elif can_override %}
            <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-slate-600">
              <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2H3V4zm0 4h14v8a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm4 2a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
              </svg>
              Edición supervisada
            </span>
          {% endif %}
        </div>
      </div>

      {{ rest_summary|json_script:"rest-summary-data" }}
      {{ position_groups.group_map|json_script:"position-group-map" }}
      {{ position_groups.position_to_group|json_script:"position-to-group-map" }}
      <div
        class="hidden"
        data-rest-config
        data-rest-enabled="{{ can_override|yesno:'true,false' }}"
        data-rest-create-url="{% url 'personal-api:calendar-rest-periods' %}"
        data-rest-detail-url-template="{% url 'personal-api:calendar-rest-period-detail' 0 %}"
        data-calendar-id="{{ calendar.id }}"
      ></div>

      <div class="flex flex-col gap-6 min-w-0">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-stretch min-w-0" data-assignments-sidebar>
          <div class="rounded-2xl border border-indigo-100 bg-indigo-50/70 p-4 text-sm text-slate-700 shadow-sm lg:basis-1/5 lg:max-w-sm" data-rest-panel>
            <div class="flex h-full flex-col gap-4">
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div class="min-w-0">
                  <span class="text-xs uppercase tracking-wide text-indigo-600">Descansos del colaborador</span>
                  <p class="mt-1 text-sm font-semibold text-slate-900" data-rest-operator-title>Selecciona un colaborador para ver sus descansos.</p>
                  <p class="text-xs text-slate-500" data-rest-employment></p>
                </div>
              </div>
              <dl class="grid gap-4 text-sm">
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Último descanso</dt>
                  <dd class="mt-1 font-medium text-slate-900" data-rest-recent>Sin registro</dd>
                </div>
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Descanso vigente</dt>
                  <dd class="mt-1 font-medium text-slate-900" data-rest-current>Sin descanso vigente</dd>
                </div>
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Próximo descanso</dt>
                  <dd class="mt-1 font-medium text-slate-900" data-rest-upcoming>Sin programación futura</dd>
                </div>
              </dl>
            </div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600 lg:basis-4/5 lg:flex-1 min-w-0">
            {% with assignment_issues|default_if_none:""|length as issue_count %}
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Estados y alertas</h3>
                {% if issue_count %}
                  <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                    {{ issue_count }} alerta{{ issue_count|pluralize:"s" }}
                  </span>
                {% endif %}
              </div>
            {% endwith %}
            <div class="mt-3 max-h-[220px] overflow-auto sm:max-h-[240px]" data-alerts-scroll>
              <ul class="grid min-w-full gap-3 pr-1 sm:grid-cols-2 xl:grid-cols-3">
                {% if assignment_issues %}
                  {% for issue in assignment_issues %}
                    <li class="flex flex-col gap-2 rounded-xl border border-white bg-white/70 p-3 shadow-sm xl:flex-row xl:items-start xl:gap-3">
                      <div class="flex items-center gap-2 xl:flex-none">
                        <span class="inline-flex h-2.5 w-2.5 flex-none rounded-full {{ issue.indicator_class }}"></span>
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide {{ issue.badge_class }}">{{ issue.severity_label }}</span>
                      </div>
                      <div class="min-w-0">
                        <p class="text-sm font-semibold text-slate-900">{{ issue.title }}</p>
                        {% if issue.detail %}
                          <p class="mt-1 text-xs text-slate-500 leading-4">{{ issue.detail }}</p>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                {% else %}
                  <li class="col-span-full flex items-center gap-3 rounded-xl border border-emerald-200 bg-emerald-50/70 px-3 py-3 text-sm text-emerald-700">
                    <span class="inline-flex h-2.5 w-2.5 flex-none rounded-full bg-emerald-500"></span>
                    <span>No se detectan incumplimientos de reglas en este calendario.</span>
                  </li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>

        <div class="flex min-h-[420px] flex-col gap-4 min-w-0">
          <div class="flex flex-wrap items-center justify-between gap-3 text-xs uppercase tracking-wide text-slate-500">
            <div class="flex flex-wrap items-center gap-3">
              <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1">{{ rows|length }} posiciones</span>
              <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1">{{ date_columns|length }} días visibles</span>
            </div>
            <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1">Turnos registrados: {{ stats.total_assignments }}</span>
          </div>

          <div class="relative flex-1 overflow-hidden rounded-2xl border border-slate-200 bg-white min-w-0">
            <div class="flex h-full flex-col min-w-0">
              <div class="flex flex-wrap items-center gap-3 border-b border-slate-200 bg-slate-50 px-4 py-3 text-xs font-medium uppercase tracking-wide text-slate-500">
                <span>Vista operativa</span>
                <span class="inline-flex items-center gap-1 text-[11px] text-slate-400">
                  <svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M4 3a1 1 0 011-1h2a1 1 0 01.894.553L8.618 4H16a1 1 0 011 1v2H3V3zm-1 6h16v8a1 1 0 01-1 1H4a1 1 0 01-1-1V9zm5 2a1 1 0 100 2h6a1 1 0 100-2H8z" clip-rule="evenodd" />
                  </svg>
                  Horizontal scroll para más días
                </span>
              </div>
              <div class="flex-1 overflow-x-auto" data-rest-scope>
                {% if can_override %}
                  <div class="sticky top-0 z-10 mb-3 hidden rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-[11px] font-semibold text-red-700" data-rest-message></div>
                {% endif %}
                <table class="w-max min-w-full divide-y divide-slate-100 text-xs sm:text-sm">
                  <tbody class="divide-y divide-slate-100">
                    {% for row in rows %}
                      {% with group=row.display_group %}
                        {% ifchanged group.key %}
                          <tr class="bg-white text-xs font-semibold uppercase tracking-wide text-slate-500" data-group-header="true" data-group-key="{{ group.key|default:'' }}" data-group-type="{{ group.type|default:'' }}">
                            <th class="sticky left-0 z-20 w-60 min-w-[15rem] bg-white px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                              Posición
                            </th>
                            {% for day in date_columns %}
                              <th
                                class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500"
                                data-calendar-column-header
                                data-calendar-col-index="{{ forloop.counter0 }}"
                                data-calendar-day="{{ day|date:'Y-m-d' }}"
                              >
                                <span class="block text-[11px] font-medium text-slate-400">{{ day|date:"d/M" }}</span>
                                <span class="block text-sm font-semibold text-slate-700">{{ day|date:"l"|capfirst }}</span>
                              </th>
                            {% endfor %}
                          </tr>
                        {% endifchanged %}
                        {% with row_color=group.color_class|default:'bg-white' %}
                          <tr class="{{ row_color }} hover:bg-white/60" data-group-key="{{ group.key|default:'' }}" data-group-type="{{ group.type|default:'' }}" data-group-label="{{ group.label|default:'' }}" {% if row.position %}data-position-id="{{ row.position.id }}"{% endif %}>
                        <th class="sticky left-0 z-20 {{ row_color }} px-6 py-4 text-left align-top text-sm font-semibold text-slate-900 shadow-[1px_0_0_rgba(15,23,42,0.08)]">
                          <span class="block text-xs uppercase tracking-wide text-slate-400">{{ row.position.farm.name }}</span>
                          <p class="text-base font-semibold text-slate-900">{{ row.position.name }}</p>
                          <span class="block text-xs text-slate-500">{{ row.position.get_category_display }}</span>
                        </th>
                        {% for cell in row.cells %}
                          <td
                            class="px-4 py-4 align-top"
                            data-calendar-col-index="{{ forloop.counter0 }}"
                            data-calendar-day="{{ cell.date|date:'Y-m-d' }}"
                          >
                            {% if cell.is_position_active %}
                              {% if cell.assignment %}
                                <div class="relative flex h-full flex-col gap-4 rounded-xl border border-slate-200 bg-white p-3 shadow-sm transition hover:shadow-lg ring-1 {% if cell.alert == 'critical' %}ring-red-200{% elif cell.alert == 'warn' %}ring-amber-200{% else %}ring-emerald-200{% endif %} {% if cell.is_overtime %}ring-offset-2 ring-offset-slate-100{% endif %}" data-operator-card data-operator-id="{{ cell.assignment.operator_id }}" data-operator-name="{{ cell.assignment.operator.get_full_name|default:cell.assignment.operator.nombres|default:cell.assignment.operator.apellidos|escape }}">
                                  {% if can_override and cell.choices %}
                                    <form method="post" class="flex flex-col gap-4">
                                      {% csrf_token %}
                                      <input type="hidden" name="action" value="update-assignment" />
                                      <input type="hidden" name="assignment_id" value="{{ cell.assignment.id }}" />
                                      <input type="hidden" name="force_override" value="1" />
                                      <div class="flex flex-col gap-3">
                                        <div class="flex items-start gap-3">
                                          <div class="flex flex-1 flex-wrap items-center gap-2">
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Colaborador asignado</p>
                                            {% if cell.alert or cell.skill_gap_message or cell.is_overtime %}
                                              <div class="flex flex-wrap items-center gap-1 text-xs text-slate-500">
                                                {% include 'calendario/partials/assignment_alert_icons.html' with cell=cell %}
                                              </div>
                                            {% endif %}
                                          </div>
                                          <span class="ml-auto inline-flex items-center gap-2 rounded-full px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {% if cell.alert == 'critical' %}border border-red-200 bg-red-50 text-red-700{% elif cell.alert == 'warn' %}border border-amber-200 bg-amber-50 text-amber-700{% else %}border border-emerald-200 bg-emerald-50 text-emerald-700{% endif %}">
                                            <span class="h-2.5 w-2.5 rounded-full {% if cell.alert == 'critical' %}bg-red-500{% elif cell.alert == 'warn' %}bg-amber-400{% else %}bg-emerald-400{% endif %}"></span>
                                          </span>
                                        </div>
                                        <div class="flex items-start gap-2">
                                          <div class="min-w-0 flex-1">
                                            <label class="sr-only" for="assignment-operator-{{ cell.assignment.id }}">Selecciona un colaborador para este turno</label>
                                            <select id="assignment-operator-{{ cell.assignment.id }}" name="operator_id" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 focus:border-brand focus:ring-brand">
                                              {% for option in cell.choices %}
                                                <option value="{{ option.id }}" {% if option.id == cell.assignment.operator_id %}selected{% endif %} {% if option.disabled %}disabled{% endif %}>
                                                  {{ option.label }}
                                                </option>
                                              {% endfor %}
                                            </select>
                                            {% with role=cell.assignment.operator.roles.first %}
                                              {% if role %}
                                                <p class="mt-1 text-xs text-slate-500">{{ role.get_name_display }}</p>
                                              {% endif %}
                                            {% endwith %}
                                          </div>
                                          <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-slate-300 px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-white shadow transition hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2">
                                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                                              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                            </svg>
                                          </button>
                                        </div>
                                      </div>
                                      <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                                        {% if not cell.alert and not cell.skill_gap_message and not cell.is_overtime %}
                                          <span class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600">Sin alertas registradas</span>
                                        {% endif %}
                                      </div>
                                    </form>
                                  {% else %}
                                    <div class="flex flex-col gap-3">
                                      <div class="flex items-start gap-3">
                                        <div class="min-w-0">
                                          <p class="truncate text-sm font-semibold text-slate-900">{{ cell.assignment.operator.get_full_name }}</p>
                                          {% with role=cell.assignment.operator.roles.first %}
                                            {% if role %}
                                              <p class="text-xs text-slate-500">{{ role.get_name_display }}</p>
                                            {% endif %}
                                          {% endwith %}
                                        </div>
                                        {% if cell.alert or cell.skill_gap_message or cell.is_overtime %}
                                          <div class="flex flex-shrink-0 flex-wrap items-center gap-1 text-xs text-slate-500">
                                            {% include 'calendario/partials/assignment_alert_icons.html' with cell=cell %}
                                          </div>
                                        {% endif %}
                                        <span class="ml-auto inline-flex items-center gap-2 rounded-full px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {% if cell.alert == 'critical' %}border border-red-200 bg-red-50 text-red-700{% elif cell.alert == 'warn' %}border border-amber-200 bg-amber-50 text-amber-700{% else %}border border-emerald-200 bg-emerald-50 text-emerald-700{% endif %}">
                                          <span class="h-2.5 w-2.5 rounded-full {% if cell.alert == 'critical' %}bg-red-500{% elif cell.alert == 'warn' %}bg-amber-400{% else %}bg-emerald-400{% endif %}"></span>
                                        </span>
                                      </div>
                                      <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                                        {% if not cell.alert and not cell.skill_gap_message and not cell.is_overtime %}
                                          <span class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600">Sin alertas registradas</span>
                                        {% endif %}
                                      </div>
                                    </div>
                                  {% endif %}
                                </div>
                              {% else %}
                                <div class="relative flex h-full flex-col gap-3 rounded-xl border border-red-200 bg-red-50/80 p-3 text-red-700 shadow-sm ring-1 ring-red-200" data-assignment-state="unassigned">
                                  <div class="flex flex-wrap items-start justify-between gap-3">
                                    <div class="min-w-0">
                                      <p class="text-[11px] font-semibold uppercase tracking-wide text-red-800">Sin colaborador</p>
                                    </div>
                                    <span class="inline-flex items-center gap-2 rounded-full border border-red-200 bg-white/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-red-700">
                                      <span class="h-2.5 w-2.5 rounded-full bg-red-500"></span>
                                    </span>
                                  </div>
                                  {% if can_override %}
                                    {% if cell.choices %}
                                      <form method="post" class="flex flex-col gap-3">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="create-assignment" />
                                        <input type="hidden" name="position_id" value="{{ row.position.id }}" />
                                        <input type="hidden" name="date" value="{{ cell.date|date:'Y-m-d' }}" />
                                        <input type="hidden" name="force_override" value="1" />
                                        <div class="flex items-start gap-2">
                                          <div class="min-w-0 flex-1">
                                            <label class="sr-only" for="assignment-create-{{ row.position.id }}-{{ cell.date|date:'Ymd' }}">Selecciona un colaborador para este turno</label>
                                            <select id="assignment-create-{{ row.position.id }}-{{ cell.date|date:'Ymd' }}" name="operator_id" class="w-full rounded-lg border border-red-200 bg-white px-3 py-2 text-sm font-medium text-red-700 focus:border-red-500 focus:ring-red-500" required>
                                              <option value="" disabled selected>Selecciona</option>
                                              {% for option in cell.choices %}
                                                <option value="{{ option.id }}" {% if option.disabled %}disabled{% endif %}>{{ option.label }}</option>
                                              {% endfor %}
                                            </select>
                                          </div>
                                          <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-red-600 px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-white shadow transition hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                                              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                            </svg>
                                          </button>
                                        </div>
                                      </form>
                                    {% else %}
                                      <p class="text-xs font-medium text-red-600">No hay colaboradores disponibles.</p>
                                    {% endif %}
                                  {% else %}
                                    <p class="text-xs font-medium text-red-600">Reabre el calendario para asignar manualmente este turno.</p>
                                  {% endif %}
                                </div>
                              {% endif %}
                            {% else %}
                              <div class="rounded-xl border border-slate-200 bg-white p-3 text-sm text-slate-500 shadow-sm">
                                <div class="flex items-center justify-between">
                                  <span>—</span>
                                  <span class="rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-medium uppercase tracking-wide text-slate-500">Fuera de vigencia</span>
                                </div>
                              </div>
                            {% endif %}
                          </td>
                        {% endfor %}
                          </tr>
                        {% endwith %}
                      {% endwith %}
                    {% endfor %}
                    {% if rest_rows %}
                      {% for rest_row in rest_rows %}
                        {% with rest_group=rest_row.display_group %}
                          {% if forloop.first %}
                            <tr class="bg-white text-xs font-semibold uppercase tracking-wide text-slate-500" data-group-header="true" data-group-key="{{ rest_group.key|default:'' }}" data-group-type="{{ rest_group.type|default:'' }}">
                              <th class="sticky left-0 z-20 w-60 min-w-[15rem] bg-white px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                                Colaborador
                              </th>
                              {% for day in date_columns %}
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                                  <span class="block text-[11px] font-medium text-slate-400">{{ day|date:"d/M" }}</span>
                                  <span class="block text-sm font-semibold text-slate-700">{{ day|date:"l"|capfirst }}</span>
                                </th>
                              {% endfor %}
                            </tr>
                          {% endif %}
                          {% with rest_color=rest_group.color_class|default:'bg-slate-50' %}
                        <tr class="{{ rest_color }}" data-group-key="{{ rest_group.key|default:'' }}" data-group-type="{{ rest_group.type|default:'' }}" data-group-label="{{ rest_group.label|default:'' }}">
                          <th class="sticky left-0 z-20 {{ rest_color }} px-6 py-4 text-left align-top text-sm font-semibold text-slate-900 shadow-[1px_0_0_rgba(15,23,42,0.08)]">
                            <span class="block text-xs uppercase tracking-wide text-slate-400">{{ rest_row.label }}</span>
                            <p class="text-base font-semibold text-slate-900">{{ rest_row.slot }}</p>
                            <span class="block text-xs text-slate-500">Descansos y sin asignación</span>
                          </th>
                          {% for cell in rest_row.cells %}
                            <td class="px-4 py-4 align-top">
                              {% if cell.state == 'rest' %}
                                <div class="relative rounded-xl border border-emerald-200 bg-white p-3 shadow-sm" data-operator-card data-operator-id="{{ cell.operator_id }}" data-operator-name="{{ cell.name|escape }}" data-rest-state="rest" data-rest-date="{{ cell.date }}" data-rest-label="{{ cell.date_display }}" data-rest-period-id="{{ cell.rest_period_id|default_if_none:'' }}" data-rest-source="{{ cell.rest_source|default:'' }}">
                                  <div class="flex items-start justify-between gap-2">
                                    <div>
                                      <p class="text-sm font-semibold text-slate-900">{{ cell.name }}</p>
                                      {% if cell.role %}
                                        <span class="block text-xs text-slate-500">{{ cell.role }}</span>
                                      {% endif %}
                                    </div>
                                    <div class="flex items-center gap-2">
                                      {% if cell.status_label %}
                                        <span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-emerald-700">{{ cell.status_label }}</span>
                                      {% endif %}
                                      {% if can_override and cell.rest_period_id %}
                                        <button type="button" title="Eliminar descanso" class="inline-flex items-center justify-center rounded-full border border-red-200 bg-white p-1 text-red-600 transition hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-300 focus:ring-offset-2" data-rest-action="delete" data-rest-period-id="{{ cell.rest_period_id }}" data-rest-operator-id="{{ cell.operator_id }}" data-rest-date="{{ cell.date }}" data-rest-label="{{ cell.date_display }}" data-operator-name="{{ cell.name|default:''|escape }}">
                                          <span class="sr-only">Eliminar descanso</span>
                                          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-2.28-9.53a.75.75 0 011.06 0L10 9.69l1.22-1.22a.75.75 0 111.06 1.06L11.06 10.75l1.22 1.22a.75.75 0 11-1.06 1.06L10 11.81l-1.22 1.22a.75.75 0 01-1.06-1.06l1.22-1.22-1.22-1.22a.75.75 0 010-1.06z" clip-rule="evenodd" />
                                          </svg>
                                        </button>
                                      {% endif %}
                                    </div>
                                  </div>
                                  {% if cell.reason %}
                                    <div class="mt-2 flex items-center gap-2 text-xs text-slate-500">
                                      <span class="inline-flex h-7 w-7 shrink-0 items-center justify-center rounded-full border border-slate-200 bg-slate-50 text-slate-500" role="img" aria-label="Motivo de descanso">
                                        <svg aria-hidden="true" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.75-11.25a.75.75 0 101.5 0 .75.75 0 00-1.5 0zm.75 2.25a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                                        </svg>
                                      </span>
                                      <span class="text-left font-medium">{{ cell.reason }}</span>
                                    </div>
                                  {% endif %}
                                </div>
                              {% elif cell.state == 'unassigned' %}
                                <div class="rounded-xl border border-sky-300 bg-sky-50 p-3 text-sky-800 shadow-sm" data-operator-card data-operator-id="{{ cell.operator_id }}" data-operator-name="{{ cell.name|escape }}" data-rest-state="unassigned" data-rest-date="{{ cell.date }}" data-rest-label="{{ cell.date_display }}">
                                  <div class="flex items-start justify-between gap-2">
                                    <div>
                                      <p class="text-sm font-semibold text-sky-900">{{ cell.name }}</p>
                                      {% if cell.role %}
                                        <span class="block text-xs text-sky-700">{{ cell.role }}</span>
                                      {% endif %}
                                    </div>
                                    {% if cell.status_label %}
                                      <span class="inline-flex items-center rounded-full border border-sky-200 bg-white px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-sky-700">{{ cell.status_label }}</span>
                                    {% endif %}
                                  </div>
                                  {% if can_override and cell.operator_id %}
                                    <button type="button" title="Programar descanso manual" class="mt-3 inline-flex w-full items-center justify-center gap-2 rounded-full border border-sky-300 bg-white px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-sky-700 transition hover:bg-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2" data-rest-action="create" data-rest-operator-id="{{ cell.operator_id }}" data-rest-date="{{ cell.date }}" data-rest-label="{{ cell.date_display }}" data-operator-name="{{ cell.name|default:''|escape }}">
                                      <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 010 2h-5v5a1 1 0 01-2 0v-5H4a1 1 0 010-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                      </svg>
                                      <span>Agregar descanso</span>
                                    </button>
                                  {% endif %}
                                </div>
                              {% elif cell.state == 'assigned' %}
                                <div class="flex h-full items-center justify-center rounded-xl border-2 border-dashed border-slate-200 bg-white p-3 text-center" data-operator-card data-operator-id="{{ cell.operator_id }}" data-operator-name="{{ cell.name|escape }}" data-rest-state="assigned" data-rest-date="{{ cell.date }}" data-rest-label="{{ cell.date_display }}">
                                  {% if can_override and cell.operator_id %}
                                    <button type="button" title="Programar descanso manual" class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-1.5 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-1" data-rest-action="create" data-rest-operator-id="{{ cell.operator_id }}" data-rest-date="{{ cell.date }}" data-rest-label="{{ cell.date_display }}" data-operator-name="{{ cell.name|default:''|escape }}">
                                      <span class="text-base leading-none font-semibold">+</span>
                                      <span>Agregar descanso</span>
                                    </button>
                                  {% else %}
                                    <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-300">—</span>
                                  {% endif %}
                                </div>
                              {% else %}
                                <div class="rounded-xl border-2 border-dashed border-slate-200 bg-white p-3 text-center text-[11px] font-semibold uppercase tracking-wide text-slate-300" data-operator-card data-operator-id="{{ cell.operator_id|default_if_none:'' }}" data-operator-name="{{ cell.name|default:''|escape }}" data-rest-state="inactive" data-rest-date="{{ cell.date }}" data-rest-label="{{ cell.date_display }}">—</div>
                              {% endif %}
                            </td>
                          {% endfor %}
                        </tr>
                          {% endwith %}
                        {% endwith %}
                      {% endfor %}
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          var highlightClasses = ['outline', 'outline-2', 'outline-offset-2', 'outline-indigo-500', 'bg-indigo-50', 'shadow-lg'];
          var cards = Array.prototype.slice.call(document.querySelectorAll('[data-operator-id]'));
          var groupMapEl = document.getElementById('position-group-map');
          var positionGroupEl = document.getElementById('position-to-group-map');
          var groupMap = {};
          var positionToGroup = {};
          if (groupMapEl) {
            try {
              groupMap = JSON.parse(groupMapEl.textContent || '{}');
            } catch (error) {
              groupMap = {};
            }
          }
          if (positionGroupEl) {
            try {
              positionToGroup = JSON.parse(positionGroupEl.textContent || '{}');
            } catch (error) {
              positionToGroup = {};
            }
          }
          var restSummaryDataEl = document.getElementById('rest-summary-data');
          var restSummary = {};
          if (restSummaryDataEl) {
            try {
              restSummary = JSON.parse(restSummaryDataEl.textContent);
            } catch (error) {
              restSummary = {};
            }
          }
          var restConfigEl = document.querySelector('[data-rest-config]');
          var restScope = document.querySelector('[data-rest-scope]');
          var restMessageEl = restScope ? restScope.querySelector('[data-rest-message]') : null;
          var restActionsEnabled = restConfigEl ? restConfigEl.dataset.restEnabled === 'true' : false;
          var restCreateUrl = restConfigEl ? restConfigEl.dataset.restCreateUrl || '' : '';
          var restDetailTemplate = restConfigEl ? restConfigEl.dataset.restDetailUrlTemplate || '' : '';
          var restCalendarId = restConfigEl ? restConfigEl.dataset.calendarId || '' : '';
          var restBusy = false;
          var csrfSafeMethods = { GET: true, HEAD: true, OPTIONS: true, TRACE: true };

          function getCookie(name) {
            if (typeof document === 'undefined') {
              return '';
            }
            var cookies = document.cookie ? document.cookie.split('; ') : [];
            for (var i = 0; i < cookies.length; i += 1) {
              if (cookies[i].startsWith(name + '=')) {
                return decodeURIComponent(cookies[i].slice(name.length + 1));
              }
            }
            return '';
          }

          function getCsrfToken() {
            return getCookie('csrftoken');
          }

          function apiRequest(url, options) {
            var settings = options || {};
            var method = (settings.method || 'GET').toUpperCase();
            var headers = { 'X-Requested-With': 'XMLHttpRequest' };
            if (!csrfSafeMethods[method]) {
              var token = getCsrfToken();
              if (token) {
                headers['X-CSRFToken'] = token;
              }
            }
            if (settings.headers) {
              Object.keys(settings.headers).forEach(function (key) {
                headers[key] = settings.headers[key];
              });
            }
            var fetchOptions = {
              method: method,
              headers: headers,
              credentials: 'same-origin',
            };
            if (settings.body !== undefined) {
              fetchOptions.body = JSON.stringify(settings.body);
              fetchOptions.headers['Content-Type'] = 'application/json';
            }
            return fetch(url, fetchOptions);
          }

          function clearRestMessage() {
            if (!restMessageEl) {
              return;
            }
            restMessageEl.textContent = '';
            restMessageEl.classList.add('hidden');
          }

          function showRestError(message) {
            if (restMessageEl) {
              restMessageEl.textContent = message || 'No fue posible completar la acción.';
              restMessageEl.classList.remove('hidden');
            } else if (message) {
              window.alert(message);
            }
          }

          function setButtonLoading(button, isLoading) {
            if (!button) {
              return;
            }
            if (isLoading) {
              button.disabled = true;
              button.classList.add('opacity-60', 'cursor-wait');
            } else {
              button.disabled = false;
              button.classList.remove('opacity-60', 'cursor-wait');
            }
          }

          function parseIntSafe(value) {
            if (value === null || value === undefined || value === '') {
              return null;
            }
            var parsed = Number.parseInt(value, 10);
            if (Number.isNaN(parsed)) {
              return null;
            }
            return parsed;
          }

          function padNumber(value) {
            var number = Number(value);
            if (Number.isNaN(number)) {
              return '';
            }
            return number < 10 ? '0' + number : String(number);
          }

          function formatDateToISO(dateObject) {
            if (!(dateObject instanceof Date) || Number.isNaN(dateObject.getTime())) {
              return '';
            }
            return [dateObject.getFullYear(), padNumber(dateObject.getMonth() + 1), padNumber(dateObject.getDate())].join('-');
          }

          function parseDateValue(value) {
            if (!value) {
              return null;
            }
            var parts = value.split('-');
            if (parts.length !== 3) {
              return null;
            }
            var year = Number.parseInt(parts[0], 10);
            var month = Number.parseInt(parts[1], 10);
            var day = Number.parseInt(parts[2], 10);
            if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {
              return null;
            }
            return new Date(year, month - 1, day);
          }

          function highlightNearestCalendarColumn() {
            if (!restScope) {
              return;
            }
            var headerNodes = restScope.querySelectorAll('[data-calendar-column-header]');
            if (!headerNodes.length) {
              return;
            }
            var previousHighlights = restScope.querySelectorAll('[data-calendar-highlight]');
            Array.prototype.forEach.call(previousHighlights, function (node) {
              node.removeAttribute('data-calendar-highlight');
              node.classList.remove('text-indigo-900');
            });
            var headers = Array.prototype.slice.call(headerNodes);
            var today = new Date();
            var todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            var todayTimestamp = todayDate.getTime();
            var todayFormatted = formatDateToISO(todayDate);
            var selectedHeader = null;
            var selectedTimestamp = null;
            var smallestDiff = Infinity;

            headers.forEach(function (header) {
              var dateStr = header.dataset.calendarDay || '';
              var columnIndex = header.dataset.calendarColIndex;
              if (!dateStr || columnIndex === undefined) {
                return;
              }
              var headerDate = parseDateValue(dateStr);
              if (!headerDate) {
                return;
              }
              var headerTimestamp = headerDate.getTime();
              if (dateStr === todayFormatted) {
                selectedHeader = header;
                selectedTimestamp = headerTimestamp;
                smallestDiff = 0;
                return;
              }
              var diff = Math.abs(headerTimestamp - todayTimestamp);
              var shouldSelect = false;
              if (diff < smallestDiff) {
                shouldSelect = true;
              } else if (diff === smallestDiff) {
                var headerIsFuture = headerTimestamp >= todayTimestamp;
                var selectedIsFuture = selectedTimestamp !== null ? selectedTimestamp >= todayTimestamp : null;
                if (headerIsFuture && !selectedIsFuture) {
                  shouldSelect = true;
                } else if (headerIsFuture === selectedIsFuture) {
                  if (selectedTimestamp === null || headerTimestamp < selectedTimestamp) {
                    shouldSelect = true;
                  }
                }
              }
              if (shouldSelect) {
                selectedHeader = header;
                selectedTimestamp = headerTimestamp;
                smallestDiff = diff;
              }
            });

            if (!selectedHeader) {
              return;
            }
            var targetIndex = selectedHeader.dataset.calendarColIndex;
            if (targetIndex === undefined) {
              return;
            }
            var columnCells = restScope.querySelectorAll('[data-calendar-col-index="' + targetIndex + '"]');
            if (!columnCells.length) {
              return;
            }
            Array.prototype.forEach.call(columnCells, function (cell) {
              cell.setAttribute('data-calendar-highlight', 'true');
              if (cell.tagName === 'TH') {
                cell.classList.add('text-indigo-900');
              }
            });

            window.requestAnimationFrame(function () {
              if (!restScope) {
                return;
              }
              var desiredScroll = selectedHeader.offsetLeft - restScope.clientWidth / 2 + selectedHeader.clientWidth / 2;
              if (desiredScroll < 0) {
                desiredScroll = 0;
              }
              if (typeof restScope.scrollTo === 'function') {
                restScope.scrollTo({ left: desiredScroll, behavior: 'smooth' });
              } else {
                restScope.scrollLeft = desiredScroll;
              }
            });
          }

          highlightNearestCalendarColumn();

          function resolveRestDetailUrl(restPeriodId) {
            if (!restDetailTemplate) {
              return '';
            }
            var id = String(restPeriodId);
            if (restDetailTemplate.endsWith('/0/')) {
              return restDetailTemplate.slice(0, -2) + id + '/';
            }
            if (restDetailTemplate.endsWith('/0')) {
              return restDetailTemplate.slice(0, -1) + id;
            }
            var lastIndex = restDetailTemplate.lastIndexOf('0');
            if (lastIndex === -1) {
              return '';
            }
            return restDetailTemplate.slice(0, lastIndex) + id + restDetailTemplate.slice(lastIndex + 1);
          }

          function sendRestRequest(url, method, payload, button) {
            if (!url) {
              showRestError('No encontramos la ruta para completar la acción.');
              return;
            }
            if (restBusy) {
              return;
            }
            restBusy = true;
            setButtonLoading(button, true);
            clearRestMessage();
            var options = { method: method };
            if (payload !== undefined) {
              options.body = payload;
            }
            apiRequest(url, options)
              .then(function (response) {
                if (!response.ok) {
                  return response
                    .json()
                    .catch(function () {
                      return {};
                    })
                    .then(function (data) {
                      var message = data && data.error ? data.error : 'No fue posible completar la acción.';
                      throw new Error(message);
                    });
                }
                return response.json().catch(function () {
                  return null;
                });
              })
              .then(function () {
                window.location.reload();
              })
              .catch(function (error) {
                restBusy = false;
                setButtonLoading(button, false);
                showRestError(error.message || 'No fue posible completar la acción.');
              })
              .finally(function () {
                if (!restBusy) {
                  return;
                }
                restBusy = false;
                setButtonLoading(button, false);
              });
          }

          function handleRestCreate(button) {
            if (!restActionsEnabled) {
              return;
            }
            var operatorId = parseIntSafe(button ? button.dataset.restOperatorId : null);
            var dateValue = button ? button.dataset.restDate || '' : '';
            if (!operatorId || !dateValue) {
              showRestError('No fue posible identificar al colaborador y la fecha seleccionados.');
              return;
            }
            var payload = {
              operator: operatorId,
              start_date: dateValue,
              end_date: dateValue,
              status: 'planned',
              source: 'manual',
            };
            var calendarId = parseIntSafe(restCalendarId);
            if (calendarId) {
              payload.calendar = calendarId;
            }
            sendRestRequest(restCreateUrl, 'POST', payload, button);
          }

          function handleRestDelete(button) {
            if (!restActionsEnabled) {
              return;
            }
            var restPeriodId = parseIntSafe(button ? button.dataset.restPeriodId : null);
            if (!restPeriodId) {
              showRestError('No encontramos el descanso seleccionado.');
              return;
            }
            var label = button ? button.dataset.restLabel || '' : '';
            var operatorName = button ? button.dataset.operatorName || '' : '';
            var confirmationLabel = '¿Eliminar el descanso';
            if (operatorName) {
              confirmationLabel += ' de ' + operatorName;
            }
            if (label) {
              confirmationLabel += label ? ' (' + label + ')' : '';
            }
            confirmationLabel += '?';
            if (!window.confirm(confirmationLabel)) {
              return;
            }
            var url = resolveRestDetailUrl(restPeriodId);
            if (!url) {
              showRestError('No encontramos la ruta para eliminar el descanso.');
              return;
            }
            sendRestRequest(url, 'DELETE', undefined, button);
          }

          if (restActionsEnabled && restScope) {
            restScope.addEventListener('click', function (event) {
              var button = event.target.closest('[data-rest-action]');
              if (!button) {
                return;
              }
              event.preventDefault();
              event.stopPropagation();
              var action = button.dataset.restAction;
              if (action === 'create') {
                handleRestCreate(button);
              } else if (action === 'delete') {
                handleRestDelete(button);
              }
            });
          }
          function applyGroupHighlighting() {
            if (!groupMap || Object.keys(groupMap).length === 0) {
              return;
            }
            var rows = Array.prototype.slice.call(document.querySelectorAll('tbody tr'));
            rows.forEach(function (row) {
              var groupKey = row.getAttribute('data-group-key');
              if (!groupKey) {
                var positionId = row.getAttribute('data-position-id');
                if (positionId && positionToGroup && positionToGroup[positionId]) {
                  groupKey = positionToGroup[positionId];
                  row.setAttribute('data-group-key', groupKey);
                }
              }
              if (!groupKey) {
                return;
              }
              var meta = groupMap[groupKey];
              if (!meta) {
                return;
              }
              var colorClass = meta.color_class || '';
              if (colorClass) {
                row.classList.add(colorClass);
                var headerCell = row.querySelector('th.sticky');
                if (headerCell && !headerCell.classList.contains(colorClass)) {
                  headerCell.classList.add(colorClass);
                }
              }
              if (!row.getAttribute('data-group-label') && meta.label) {
                row.setAttribute('data-group-label', meta.label);
              }
              if (!row.getAttribute('data-group-type') && meta.type) {
                row.setAttribute('data-group-type', meta.type);
              }
            });
          }

          applyGroupHighlighting();
          var restPanel = document.querySelector('[data-rest-panel]');
          var restOperatorTitle = restPanel ? restPanel.querySelector('[data-rest-operator-title]') : null;
          var restEmployment = restPanel ? restPanel.querySelector('[data-rest-employment]') : null;
          var restCurrent = restPanel ? restPanel.querySelector('[data-rest-current]') : null;
          var restRecent = restPanel ? restPanel.querySelector('[data-rest-recent]') : null;
          var restUpcoming = restPanel ? restPanel.querySelector('[data-rest-upcoming]') : null;
          var restClear = restPanel ? restPanel.querySelector('[data-rest-clear]') : null;

          function formatDate(isoString) {
            if (!isoString) {
              return '';
            }
            var parts = isoString.split('-');
            if (parts.length !== 3) {
              return isoString;
            }
            return parts[2] + '/' + parts[1] + '/' + parts[0];
          }

          function describePeriod(period) {
            if (!period) {
              return null;
            }
            var startLabel = formatDate(period.start);
            var endLabel = formatDate(period.end);
            var rangeLabel = startLabel === endLabel || !endLabel ? startLabel : startLabel + ' → ' + endLabel;
            var qualifiers = [];
            if (period.status_label) {
              qualifiers.push(period.status_label);
            }
            if (period.source_label) {
              qualifiers.push(period.source_label);
            }
            if (qualifiers.length) {
              rangeLabel += ' · ' + qualifiers.join(' · ');
            }
            return rangeLabel;
          }

          function clearRestPanel() {
            if (!restPanel) {
              return;
            }
            if (restOperatorTitle) {
              restOperatorTitle.textContent = 'Selecciona un colaborador para ver sus descansos.';
            }
            if (restEmployment) {
              restEmployment.textContent = '';
            }
            if (restCurrent) {
              restCurrent.textContent = 'Sin descanso vigente';
            }
            if (restRecent) {
              restRecent.textContent = 'Sin registro';
            }
            if (restUpcoming) {
              restUpcoming.textContent = 'Sin programación futura';
            }
          }

          function updateRestPanel(operatorId, sourceCard) {
            if (!restPanel || !restOperatorTitle || !restCurrent || !restRecent || !restUpcoming) {
              return;
            }

            var summary = restSummary[operatorId];
            if (!summary) {
              restOperatorTitle.textContent = 'Sin información de descansos para este colaborador.';
              if (restEmployment) {
                restEmployment.textContent = '';
              }
              restCurrent.textContent = 'Sin datos';
              restRecent.textContent = 'Sin datos';
              restUpcoming.textContent = 'Sin datos';
              return;
            }

            var operatorName = sourceCard ? (sourceCard.dataset.operatorName || '') : '';
            if (!operatorName && summary.name) {
              operatorName = summary.name;
            }
            if (!operatorName) {
              operatorName = 'Colaborador seleccionado';
            }
            restOperatorTitle.textContent = operatorName;

            if (restEmployment) {
              if (summary.employment_start && summary.employment_end) {
                restEmployment.textContent = summary.employment_start + ' → ' + summary.employment_end;
              } else if (summary.employment_start) {
                restEmployment.textContent = 'Ingreso: ' + summary.employment_start;
              } else {
                restEmployment.textContent = '';
              }
            }

            var currentLabel = describePeriod(summary.current);
            restCurrent.textContent = currentLabel || 'Sin descanso vigente';

            var recentLabel = describePeriod(summary.recent);
            restRecent.textContent = recentLabel || 'Sin registro';

            var upcomingLabel = describePeriod(summary.upcoming);
            restUpcoming.textContent = upcomingLabel || 'Sin programación futura';
          }

          var highlightedOperator = null;
          var highlightedCards = [];

          function clearHighlight() {
            highlightedCards.forEach(function (card) {
              highlightClasses.forEach(function (cls) {
                card.classList.remove(cls);
              });
            });
            highlightedCards = [];
            highlightedOperator = null;
          }

          function setHighlight(operatorId, sourceCard) {
            clearHighlight();
            highlightedOperator = operatorId;
            highlightedCards = cards.filter(function (card) {
              return card.dataset.operatorId === operatorId;
            });
            highlightedCards.forEach(function (card) {
              highlightClasses.forEach(function (cls) {
                card.classList.add(cls);
              });
            });
            updateRestPanel(operatorId, sourceCard);
          }

          function clearHighlightIfUnlocked(operatorId) {
            if (operatorId !== highlightedOperator) {
              return;
            }
            setTimeout(function () {
              if (document.activeElement && document.activeElement.closest('[data-operator-id="' + operatorId + '"]')) {
                return;
              }
              clearHighlight();
              clearRestPanel();
            }, 100);
          }

          if (restClear) {
            restClear.addEventListener('click', function () {
              clearHighlight();
              clearRestPanel();
            });
          }

          clearRestPanel();

          cards.forEach(function (card) {
            var operatorId = card.dataset.operatorId;
            if (!operatorId) {
              return;
            }

            card.addEventListener('click', function (event) {
              if (event.detail > 1) {
                return;
              }
              if (highlightedOperator === operatorId) {
                clearHighlight();
                clearRestPanel();
              } else {
                setHighlight(operatorId, card);
              }
            });

            card.addEventListener('focusin', function () {
              setHighlight(operatorId, card);
            });

            card.addEventListener('focusout', function (event) {
              if (highlightedOperator === operatorId && !card.contains(event.relatedTarget)) {
                clearHighlightIfUnlocked(operatorId);
              }
            });
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          var shareButtons = Array.prototype.slice.call(document.querySelectorAll('[data-whatsapp-share]'));
          shareButtons.forEach(function (button) {
            if (!button) {
              return;
            }
            button.addEventListener('click', function () {
              var linkValue = button.getAttribute('data-whatsapp-link') || '';
              var message = button.getAttribute('data-whatsapp-message') || '';
              var payload = linkValue || message;
              if (!payload || !payload.replace(/\s+/g, '').length) {
                return;
              }
              var shareUrl = 'https://wa.me/?text=' + encodeURIComponent(payload);
              var popup = window.open(shareUrl, '_blank', 'noopener');
              if (popup) {
                popup.focus();
              }
            });
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          var panelNodes = Array.prototype.slice.call(document.querySelectorAll('[data-calendar-share-panel]'));
          if (!panelNodes.length) {
            return;
          }

          var activePanel = null;

          function setPanelState(panel, open) {
            if (!panel) {
              return;
            }
            var trigger = panel.querySelector('[data-share-panel-trigger]');
            var content = panel.querySelector('[data-share-panel-content]');
            if (!trigger || !content) {
              return;
            }
            content.setAttribute('data-open', open ? 'true' : 'false');
            content.setAttribute('aria-hidden', open ? 'false' : 'true');
            trigger.setAttribute('aria-expanded', open ? 'true' : 'false');
            if (open) {
              activePanel = panel;
            } else if (activePanel === panel) {
              activePanel = null;
            }
          }

          function closeActivePanel(target) {
            if (!activePanel) {
              return;
            }
            if (target && activePanel.contains(target)) {
              return;
            }
            setPanelState(activePanel, false);
          }

          document.addEventListener('click', function (event) {
            closeActivePanel(event.target);
          });

          panelNodes.forEach(function (panel) {
            var trigger = panel.querySelector('[data-share-panel-trigger]');
            var content = panel.querySelector('[data-share-panel-content]');
            var closeButton = panel.querySelector('[data-share-panel-close]');
            var form = panel.querySelector('[data-calendar-share-form]');
            if (!trigger || !content || !form) {
              return;
            }

            trigger.addEventListener('click', function (event) {
              event.preventDefault();
              event.stopPropagation();
              var isOpen = content.getAttribute('data-open') === 'true';
              setPanelState(panel, !isOpen);
            });

            if (closeButton) {
              closeButton.addEventListener('click', function (event) {
                event.preventDefault();
                event.stopPropagation();
                setPanelState(panel, false);
              });
            }

            content.addEventListener('click', function (event) {
              event.stopPropagation();
            });

            var restToggle = panel.querySelector('[data-share-rest-only]');
            var restIndicator = restToggle ? restToggle.querySelector('[data-share-rest-indicator]') : null;
            var jobTypeButtons = Array.prototype.slice.call(panel.querySelectorAll('[data-share-job-type]'));
            var startInput = panel.querySelector('[data-share-start]');
            var endInput = panel.querySelector('[data-share-end]');
            var submitButton = panel.querySelector('[data-share-submit]');
            var feedback = panel.querySelector('[data-share-feedback]');
            var shareUrl = form.getAttribute('data-share-url') || '';

            function updateJobTypeState(button, forceActive) {
              if (!button) {
                return;
              }
              var nextState =
                typeof forceActive === 'boolean' ? forceActive : button.getAttribute('data-active') !== 'true';
              button.setAttribute('data-active', nextState ? 'true' : 'false');
              button.setAttribute('aria-pressed', nextState ? 'true' : 'false');
            }

            jobTypeButtons.forEach(function (button) {
              button.addEventListener('click', function () {
                updateJobTypeState(button);
              });
            });

            function setRestState(active) {
              if (!restToggle) {
                return;
              }
              var nextState = typeof active === 'boolean' ? active : restToggle.getAttribute('data-active') !== 'true';
              restToggle.setAttribute('data-active', nextState ? 'true' : 'false');
              restToggle.setAttribute('aria-pressed', nextState ? 'true' : 'false');
              if (restIndicator) {
                restIndicator.textContent = nextState ? 'on' : 'off';
              }
            }

            if (restToggle) {
              setRestState(restToggle.getAttribute('data-active') === 'true');
              restToggle.addEventListener('click', function () {
                setRestState();
              });
            }

            function showFeedback(message, variant) {
              if (!feedback) {
                return;
              }
              if (!message) {
                feedback.classList.add('hidden');
                feedback.textContent = '';
                return;
              }
              feedback.textContent = message;
              feedback.classList.remove('hidden');
              if (variant === 'success') {
                feedback.classList.remove('text-red-600');
                feedback.classList.add('text-emerald-600');
              } else {
                feedback.classList.remove('text-emerald-600');
                feedback.classList.add('text-red-600');
              }
            }

            function toggleBusy(state) {
              if (!submitButton) {
                return;
              }
              if (state) {
                submitButton.setAttribute('data-busy', 'true');
                submitButton.classList.add('opacity-70', 'cursor-wait');
                submitButton.disabled = true;
              } else {
                submitButton.removeAttribute('data-busy');
                submitButton.classList.remove('opacity-70', 'cursor-wait');
                submitButton.disabled = false;
              }
            }

            if (submitButton) {
              submitButton.addEventListener('click', function () {
                if (!shareUrl) {
                  return;
                }
                var startValue = startInput && startInput.value ? startInput.value : '';
                var endValue = endInput && endInput.value ? endInput.value : '';
                if (!startValue || !endValue) {
                  showFeedback('Selecciona el rango completo.', 'error');
                  return;
                }
                var params = new URLSearchParams();
                params.set('start_date', startValue);
                params.set('end_date', endValue);
                var selectedJobTypes = jobTypeButtons
                  .filter(function (button) {
                    return button.getAttribute('data-active') === 'true';
                  })
                  .map(function (button) {
                    return button.getAttribute('data-share-job-type');
                  })
                  .filter(Boolean);
                selectedJobTypes.forEach(function (value) {
                  params.append('job_types[]', value);
                });
                if (restToggle && restToggle.getAttribute('data-active') === 'true') {
                  params.append('rests_only', '1');
                }
                showFeedback('', 'success');
                toggleBusy(true);
                var targetUrl = shareUrl + (shareUrl.indexOf('?') === -1 ? '?' : '&') + params.toString();
                fetch(targetUrl, {
                  credentials: 'same-origin',
                  headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                  },
                })
                  .then(function (response) {
                    return response
                      .json()
                      .then(function (payload) {
                        return { status: response.status, body: payload };
                      })
                      .catch(function () {
                        return { status: response.status, body: null };
                      });
                  })
                  .then(function (result) {
                    toggleBusy(false);
                    if (!result || result.status >= 400 || !result.body || result.body.success === false) {
                      var errorMessage =
                        result && result.body && result.body.error
                          ? result.body.error
                          : 'No se pudo generar el mensaje.';
                      showFeedback(errorMessage, 'error');
                      return;
                    }
                    var message = result.body.message || '';
                    if (!message.trim()) {
                      showFeedback('No hay información para compartir en este rango.', 'error');
                      return;
                    }
                    var waUrl = 'https://wa.me/?text=' + encodeURIComponent(message);
                    var popup = window.open(waUrl, '_blank', 'noopener');
                    if (popup) {
                      popup.focus();
                    }
                    showFeedback('Mensaje generado. Si no ves WhatsApp, revisa el bloqueador de ventanas.', 'success');
                    setPanelState(panel, false);
                  })
                  .catch(function () {
                    toggleBusy(false);
                    showFeedback('Hubo un problema al preparar el mensaje.', 'error');
                  });
              });
            }
          });
        });
      </script>
    </div>
  </section>

</div>
{% endblock %}
