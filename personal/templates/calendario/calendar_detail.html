{% extends 'calendario/base.html' %}

{% block title %}Detalle calendario | {{ calendar.name|default:'Sin título' }}{% endblock %}

{% block content %}
<script>
  if (typeof document !== 'undefined' && document.body) {
    document.body.dataset.calendarCurrentId = '{{ calendar.id }}';
  }
</script>
<style>
  th[data-calendar-highlight="true"],
  td[data-calendar-highlight="true"] {
    position: relative;
  }

  td[data-calendar-highlight="true"]::after,
  th[data-calendar-highlight="true"]::after {
    content: '';
    position: absolute;
    inset: 0.35rem;
    border-radius: 0.75rem;
    background-color: rgba(79, 70, 229, 0.12);
    pointer-events: none;
    transition: opacity 200ms ease;
    opacity: 1;
    z-index: 0;
  }

  th[data-calendar-highlight="true"]::after {
    inset: 0.25rem 0.35rem 0 0.35rem;
    border-radius: 0.75rem 0.75rem 0 0;
    background-color: rgba(79, 70, 229, 0.18);
  }

  td[data-calendar-highlight="true"] > *,
  th[data-calendar-highlight="true"] > * {
    position: relative;
    z-index: 1;
  }

  th[data-calendar-highlight="true"] span {
    color: #3730a3;
  }

  .calendar-sheet-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 0.75rem;
  }

  .calendar-sheet__toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .calendar-sheet__status {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #475569;
    font-weight: 600;
  }

  .calendar-sheet__actions {
    display: flex;
    gap: 0.5rem;
  }

  .calendar-sheet__actions button {
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.4rem 0.9rem;
    border-radius: 999px;
    border: 1px solid #cbd5f5;
    background-color: #fff;
    color: #312e81;
    transition: background-color 120ms ease, color 120ms ease;
  }

  .calendar-sheet__actions button[data-variant="primary"] {
    background-color: #4338ca;
    border-color: #4338ca;
    color: #fff;
  }

  .calendar-sheet__actions button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .calendar-sheet__feedback {
    font-size: 0.82rem;
    font-weight: 500;
  }

  .calendar-sheet__feedback[data-variant="error"] {
    color: #b91c1c;
  }

  .calendar-sheet__feedback[data-variant="success"] {
    color: #047857;
  }

  .calendar-sheet__table-wrapper {
    overflow: auto;
  }

  .calendar-sheet {
    min-width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.85rem;
  }

  .calendar-sheet th,
  .calendar-sheet td {
    border: 1px solid #e2e8f0;
    background-color: #fff;
  }

  .calendar-sheet tr[data-group-header="true"] {
    --group-divider-color: #f4f6fb;
  }

  .calendar-sheet tr[data-group-header="true"] th {
    background-color: var(--group-divider-color, #f4f6fb);
    border-bottom: 1px solid rgba(148, 163, 184, 0.45);
    color: #475569;
  }

  .calendar-sheet__row {
    --group-color: #f1f5f9;
    --cell-color: #f8fafc;
  }

  .calendar-sheet__row-header {
    min-width: 14rem;
    background-color: var(--group-color, #f1f5f9);
  }

  .calendar-sheet__cell {
    min-width: 11rem;
    background-color: var(--cell-color, #f8fafc);
    padding: 0.35rem;
  }

  .calendar-sheet__cell-content {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    border-radius: 0.65rem;
    border: 1px solid #e2e8f0;
    background-color: var(--group-card-color, #fff);
    padding: 0.45rem 0.6rem;
    position: relative;
    transition: box-shadow 120ms ease, background-color 120ms ease;
  }

  .calendar-sheet__cell-content[data-cell-state="empty"] {
    background-color: #f8fafc;
  }

  .calendar-sheet__cell-content[data-cell-state="inactive"] {
    background-color: #f1f5f9;
    color: #94a3b8;
  }

  .calendar-sheet__cell-content[data-cell-dirty="true"] {
    box-shadow: 0 0 0 2px rgba(67, 56, 202, 0.25);
  }

  .calendar-sheet__indicator {
    width: 0.55rem;
    height: 0.55rem;
    border-radius: 999px;
    background-color: #cbd5f5;
  }

  [data-alert-level="critical"] .calendar-sheet__indicator {
    background-color: #dc2626;
  }

  [data-alert-level="warn"] .calendar-sheet__indicator {
    background-color: #f59e0b;
  }

  [data-alert-level="none"] .calendar-sheet__indicator {
    background-color: #16a34a;
  }

  .calendar-sheet__label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #0f172a;
    line-height: 1.3;
  }

  .calendar-sheet__placeholder {
    color: #94a3b8;
    font-weight: 500;
  }

  .calendar-sheet__editor select {
    width: 100%;
    border: 1px solid #cbd5f5;
    border-radius: 0.45rem;
    font-size: 0.78rem;
    padding: 0.25rem 0.35rem;
    background-color: #f8fafc;
    color: #0f172a;
  }

  .calendar-sheet__editor {
    min-width: 9.5rem;
  }

  .calendar-sheet__note {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
  }

  .calendar-sheet__note[data-variant="danger"] {
    color: #b91c1c;
  }

  .calendar-sheet__note[data-variant="warn"] {
    color: #c2410c;
  }

  .calendar-sheet__note[data-variant="info"] {
    color: #0369a1;
  }

  .calendar-sheet__action-btn {
    width: 2rem;
    height: 2rem;
    border: 1px solid #cbd5f5;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: #fff;
    color: #475569;
    transition: color 150ms ease, border-color 150ms ease, background-color 150ms ease;
  }

  .calendar-sheet__action-btn:hover,
  .calendar-sheet__action-btn:focus-visible {
    border-color: #a5b4fc;
    color: #4338ca;
    outline: none;
  }

  .calendar-sheet__rest-tag {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border-radius: 999px;
    padding: 0.15rem 0.45rem;
    border: 1px solid rgba(15, 23, 42, 0.12);
  }
</style>
<div class="flex flex-col gap-6 min-w-0">
  <section class="rounded-2xl bg-white shadow-sm">
    <div class="flex flex-col gap-6 px-4 py-6 sm:px-6 lg:px-8">
      <div class="flex flex-col gap-4 lg:gap-6">
        <h1 class="sr-only">Detalle calendario {{ calendar.name|default:"sin título" }}</h1>
        <div
          class="flex w-full flex-col items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50/80 p-4 sm:flex-row sm:items-center sm:gap-4 lg:rounded-none lg:border-0 lg:bg-transparent lg:p-0"
          data-calendar-navigator
          data-current-calendar-id="{{ calendar.id }}"
        >
          <div class="flex w-full justify-center gap-2 sm:w-auto sm:justify-start">
            <button
              type="button"
              class="inline-flex w-full items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand focus-visible:ring-offset-2 sm:w-auto"
              data-calendar-nav="prev"
            >
              <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path
                  fill-rule="evenodd"
                  d="M12.78 4.22a.75.75 0 010 1.06L8.56 9.5l4.22 4.22a.75.75 0 01-1.06 1.06l-4.75-4.75a.75.75 0 010-1.06l4.75-4.75a.75.75 0 011.06 0z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>Anterior</span>
            </button>
            <button
              type="button"
              class="inline-flex w-full items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-600 transition hover:border-brand hover:text-brand focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand focus-visible:ring-offset-2 sm:w-auto"
              data-calendar-nav="next"
            >
              <span>Siguiente</span>
              <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path
                  fill-rule="evenodd"
                  d="M7.22 4.22a.75.75 0 011.06 0l4.75 4.75a.75.75 0 010 1.06l-4.75 4.75a.75.75 0 01-1.06-1.06L10.94 10 7.22 6.28a.75.75 0 010-1.06z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
          <div class="flex w-full justify-center sm:flex-1">
            <div class="relative w-full sm:min-w-[320px] sm:max-w-lg lg:max-w-2xl" data-calendar-picker>
              <button
                type="button"
                class="flex w-full items-center justify-between gap-4 rounded-2xl border border-slate-200 bg-white px-5 py-4 text-left shadow-sm transition hover:border-brand/40 hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand focus-visible:ring-offset-2"
                data-calendar-picker-trigger
                aria-haspopup="true"
                aria-expanded="false"
              >
                <div class="min-w-0 flex-1">
                  <span class="flex items-center gap-2 text-xl font-semibold leading-tight text-slate-900">
                    <span class="truncate" data-calendar-picker-label>{{ calendar.name|default:"Calendario sin título" }}</span>
                    {% if calendar.status == 'draft' %}
                      <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-600">Borrador</span>
                    {% elif calendar.status == 'approved' %}
                      <span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Aprobado</span>
                    {% elif calendar.status == 'modified' %}
                      <span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-amber-700">Modificado</span>
                    {% else %}
                      <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-600">{{ calendar.get_status_display|default:calendar.status }}</span>
                    {% endif %}
                    {% if calendar_latest_modification %}
                      <span class="inline-flex items-center gap-1.5 rounded-full border border-slate-200 bg-white px-2.5 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-slate-600">
                        <svg class="h-3.5 w-3.5 text-slate-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-12.25a.75.75 0 00-1.5 0v4.5c0 .199.079.39.22.53l2.25 2.25a.75.75 0 101.06-1.06l-2.03-2.03V5.75z"
                            clip-rule="evenodd"
                          />
                        </svg>
                        Último cambio
                        {{ calendar_latest_modification|date:"d/m/Y H:i" }}
                      </span>
                    {% endif %}
                  </span>
                  <span class="mt-1 block text-xs text-slate-500" data-calendar-picker-range>{{ calendar.start_date }} → {{ calendar.end_date }}</span>
                </div>
                <svg class="h-4 w-4 flex-none text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path
                    fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 11.208l3.71-3.978a.75.75 0 111.08 1.04l-4.24 4.54a.75.75 0 01-1.08 0l-4.24-4.54a.75.75 0 01.02-1.06z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div
                class="invisible absolute left-0 top-full z-30 mt-2 w-full max-h-80 overflow-hidden rounded-xl border border-slate-200 bg-white opacity-0 shadow-lg shadow-slate-900/10 transition duration-150 ease-out"
                data-calendar-picker-panel
              >
                <div class="border-b border-slate-100 bg-slate-50/70 px-4 py-3">
                  <label class="flex items-center gap-2 rounded-lg bg-white px-3 py-2 text-xs text-slate-500 focus-within:ring-2 focus-within:ring-brand focus-within:ring-offset-2 focus-within:ring-offset-white">
                    <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path
                        fill-rule="evenodd"
                        d="M9 3.5a5.5 5.5 0 014.384 8.776l3.17 3.17a.75.75 0 11-1.06 1.06l-3.17-3.17A5.5 5.5 0 119 3.5zm0 1.5a4 4 0 100 8 4 4 0 000-8z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <input
                      type="search"
                      class="flex-1 border-0 bg-transparent text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none"
                      placeholder="Filtrar por nombre o fecha…"
                      data-calendar-picker-search
                    />
                  </label>
                </div>
                <div class="max-h-64 overflow-y-auto" data-calendar-picker-list>
                  <div class="px-4 py-3 text-xs text-slate-400">Cargando calendarios…</div>
                </div>
              </div>
            </div>
          </div>
          <div class="flex w-full flex-col items-center gap-2 sm:w-auto sm:flex-none sm:items-end sm:justify-end sm:gap-2 sm:ml-auto">
            <div class="flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center sm:justify-end sm:gap-2">
              {% if calendar.status != 'approved' %}
                <form method="post" class="w-full sm:w-auto sm:flex-none" data-confirmation>
                  {% csrf_token %}
                  <input type="hidden" name="action" value="approve" />
                  <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-brand px-5 py-2.5 text-sm font-semibold text-white shadow hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2 sm:w-auto" data-confirmation-trigger>
                    Aprobar calendario
                  </button>
                  <div class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-confirmation-overlay>
                    <div class="w-full max-w-sm rounded-xl border border-slate-200 bg-white p-4 text-left text-sm shadow-lg">
                      <p class="font-semibold text-slate-900">¿Aprobar este calendario?</p>
                      <p class="mt-1 text-xs text-slate-500">Se publicará para uso operativo.</p>
                      <div class="mt-3 flex justify-end gap-2">
                        <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-confirmation-cancel data-confirmation-focus>Cancelar</button>
                        <button type="button" class="inline-flex items-center rounded-full bg-brand px-3 py-1.5 text-xs font-semibold text-white shadow hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-1" data-confirmation-confirm>Aprobar</button>
                      </div>
                    </div>
                  </div>
                </form>
              {% else %}
                <div class="flex w-full flex-col gap-1 text-xs items-center sm:w-auto sm:items-end">
                  <div class="flex flex-col items-start gap-2 text-sm font-medium text-slate-500 sm:items-end w-full">
                    <span class="w-full text-center sm:text-right">
                      {% if calendar.approved_by %}
                        Aprobado por {{ calendar.approved_by.get_full_name|default:calendar.approved_by }} el {{ calendar.approved_at|date:"d/m/Y H:i" }}
                      {% else %}
                        Aprobado el {{ calendar.approved_at|date:"d/m/Y H:i" }}
                      {% endif %}
                    </span>
                    <form method="post" class="contents">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="mark-modified" />
                      <button type="submit" class="inline-flex w-full items-center justify-between gap-2 rounded-lg border border-slate-200 bg-white/80 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-600 hover:border-brand hover:text-brand focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-1">
                        <span>Marcar modificada</span>
                        <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 11-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                      </button>
                    </form>
                  </div>
                </div>
              {% endif %}
            </div>
            <div class="flex w-full justify-end gap-2 text-xs sm:w-auto sm:flex-row sm:items-center">
              {% if calendar.status != 'approved' %}
                <form method="post" class="contents" data-confirmation>
                  {% csrf_token %}
                  <input type="hidden" name="action" value="regenerate" />
                  <button type="submit" class="inline-flex items-center gap-1.5 rounded-lg border border-amber-200 bg-white/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-amber-700 hover:border-amber-300 hover:text-amber-800 focus:outline-none focus:ring-2 focus:ring-amber-200 focus:ring-offset-1" data-confirmation-trigger>
                    <span>Regenerar</span>
                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M3.172 7.172a4 4 0 015.656 0l.172.172.172-.172a4 4 0 115.656 5.656l-5.15 5.15a.75.75 0 01-1.06 0l-5.15-5.15a4 4 0 010-5.656z" clip-rule="evenodd" />
                    </svg>
                  </button>
                  <div class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-confirmation-overlay>
                    <div class="w-full max-w-sm rounded-xl border border-slate-200 bg-white p-4 text-left text-sm shadow-lg">
                      <p class="font-semibold text-slate-900">¿Regenerar este calendario?</p>
                      <p class="mt-1 text-xs text-slate-500">Se reemplazarán las asignaciones actuales por una nueva versión sugerida.</p>
                      <div class="mt-3 flex justify-end gap-2">
                        <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-confirmation-cancel data-confirmation-focus>Cancelar</button>
                        <button type="button" class="inline-flex items-center rounded-full bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-1" data-confirmation-confirm>Regenerar</button>
                      </div>
                    </div>
                  </div>
                </form>
              {% endif %}
              <div class="relative w-full sm:w-auto" data-double-confirm>
                <button type="button" class="inline-flex items-center gap-1.5 rounded-lg border border-red-200 bg-white/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-red-600 hover:border-red-300 hover:text-red-700 focus:outline-none focus:ring-2 focus:ring-red-200 focus:ring-offset-1" data-double-confirm-trigger>
                  <span>Eliminar</span>
                  <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M6.28 5.22a.75.75 0 011.06 0L10 7.939l2.66-2.72a.75.75 0 111.08 1.04L11.09 9l2.65 2.74a.75.75 0 11-1.08 1.04L10 10.06l-2.66 2.72a.75.75 0 11-1.08-1.04L8.91 9 6.25 6.26a.75.75 0 010-1.04z" clip-rule="evenodd" />
                  </svg>
                </button>
                <div class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-double-confirm-panel>
                  <div class="w-full max-w-sm rounded-xl border border-slate-200 bg-white p-4 text-left text-sm shadow-lg">
                    <p class="font-semibold text-slate-900">¿Eliminar este calendario?</p>
                    <p class="mt-1 text-xs text-slate-500">Se eliminarán todas las asignaciones relacionadas.</p>
                    <div class="mt-3 flex justify-end gap-2">
                      <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-double-confirm-cancel data-double-confirm-focus>Cancelar</button>
                      <button type="button" class="inline-flex items-center rounded-full bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400" data-double-confirm-continue>Confirmar</button>
                    </div>
                  </div>
                </div>
                <form method="post" action="{% url 'personal:calendar-delete' calendar.pk %}" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-double-confirm-final>
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ calendar_home_url }}" />
                  <div class="w-full max-w-sm rounded-xl border border-red-200 bg-white p-4 text-left shadow-lg">
                    <p class="text-sm font-semibold text-red-700">Confirmación final</p>
                    <p class="mt-1 text-xs text-slate-500">Esta acción es irreversible.</p>
                    <div class="mt-3 flex justify-end gap-2">
                      <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-double-confirm-cancel>Cancelar</button>
                      <button type="submit" class="inline-flex items-center rounded-full bg-red-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300" data-double-confirm-final-submit data-double-confirm-focus>Eliminar definitivamente</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        {% if calendar.base_calendar %}
          <div class="flex justify-center text-xs text-slate-500">
            <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1 font-medium text-slate-600">Modifica: #{{ calendar.base_calendar_id }}</span>
          </div>
        {% endif %}
      </div>
    </div>
  </section>


  <section class="rounded-2xl bg-white shadow-sm min-w-0">
    <div class="flex flex-col gap-6 px-4 py-6 sm:px-6 lg:px-8">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-slate-900">Asignaciones</h2>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
          {% if can_override and has_manual_choices %}
            <span class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-indigo-700">
              <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M2.879 2.879a3 3 0 014.242 0L10 5.757l2.879-2.878a3 3 0 014.242 4.242L14.243 10l2.878 2.879a3 3 0 11-4.242 4.242L10 14.243l-2.879 2.878a3 3 0 01-4.242-4.242L5.757 10 2.879 7.121a3 3 0 010-4.242z" clip-rule="evenodd" />
              </svg>
              Reasignación manual activa
            </span>
          {% elif can_override %}
            <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-slate-600">
              <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2H3V4zm0 4h14v8a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm4 2a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
              </svg>
              Edición supervisada
            </span>
          {% endif %}
        </div>
      </div>

      {{ rest_summary|json_script:"rest-summary-data" }}
      {{ position_groups.group_map|json_script:"position-group-map" }}
      {{ position_groups.position_to_group|json_script:"position-to-group-map" }}
      <div
        class="hidden"
        data-rest-config
        data-rest-enabled="{{ can_override|yesno:'true,false' }}"
        data-rest-create-url="{% url 'personal-api:calendar-rest-periods' %}"
        data-rest-detail-url-template="{% url 'personal-api:calendar-rest-period-detail' 0 %}"
        data-calendar-id="{{ calendar.id }}"
      ></div>

      <div class="flex flex-col gap-6 min-w-0">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-stretch min-w-0" data-assignments-sidebar>
          <div class="rounded-2xl border border-indigo-100 bg-indigo-50/70 p-4 text-sm text-slate-700 shadow-sm lg:basis-1/5 lg:max-w-sm" data-rest-panel>
            <div class="flex h-full flex-col gap-4">
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div class="min-w-0">
                  <span class="text-xs uppercase tracking-wide text-indigo-600">Descansos del colaborador</span>
                  <p class="mt-1 text-sm font-semibold text-slate-900" data-rest-operator-title>Selecciona un colaborador para ver sus descansos.</p>
                  <p class="text-xs text-slate-500" data-rest-employment></p>
                </div>
              </div>
              <dl class="grid gap-4 text-sm">
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Último descanso</dt>
                  <dd class="mt-1 font-medium text-slate-900" data-rest-recent>Sin registro</dd>
                </div>
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Descanso vigente</dt>
                  <dd class="mt-1 font-medium text-slate-900" data-rest-current>Sin descanso vigente</dd>
                </div>
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Próximo descanso</dt>
                  <dd class="mt-1 font-medium text-slate-900" data-rest-upcoming>Sin programación futura</dd>
                </div>
              </dl>
            </div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600 lg:basis-4/5 lg:flex-1 min-w-0">
            {% with assignment_issues|default_if_none:""|length as issue_count %}
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Estados y alertas</h3>
                {% if issue_count %}
                  <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                    {{ issue_count }} alerta{{ issue_count|pluralize:"s" }}
                  </span>
                {% endif %}
              </div>
            {% endwith %}
            <div class="mt-3 max-h-[220px] overflow-auto sm:max-h-[240px]" data-alerts-scroll>
              <ul class="grid min-w-full gap-3 pr-1 sm:grid-cols-2 xl:grid-cols-3">
                {% if assignment_issues %}
                  {% for issue in assignment_issues %}
                    <li class="flex flex-col gap-2 rounded-xl border border-white bg-white/70 p-3 shadow-sm xl:flex-row xl:items-start xl:gap-3">
                      <div class="flex items-center gap-2 xl:flex-none">
                        <span class="inline-flex h-2.5 w-2.5 flex-none rounded-full {{ issue.indicator_class }}"></span>
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide {{ issue.badge_class }}">{{ issue.severity_label }}</span>
                      </div>
                      <div class="min-w-0">
                        <p class="text-sm font-semibold text-slate-900">{{ issue.title }}</p>
                        {% if issue.detail %}
                          <p class="mt-1 text-xs text-slate-500 leading-4">{{ issue.detail }}</p>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                {% else %}
                  <li class="col-span-full flex items-center gap-3 rounded-xl border border-emerald-200 bg-emerald-50/70 px-3 py-3 text-sm text-emerald-700">
                    <span class="inline-flex h-2.5 w-2.5 flex-none rounded-full bg-emerald-500"></span>
                    <span>No se detectan incumplimientos de reglas en este calendario.</span>
                  </li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>

        <div class="flex min-h-[420px] flex-col gap-4 min-w-0">
          <div class="flex flex-wrap items-center justify-between gap-3 text-xs uppercase tracking-wide text-slate-500">
            <div class="flex flex-wrap items-center gap-3">
              <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1">{{ rows|length }} posiciones</span>
              <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1">{{ date_columns|length }} días visibles</span>
            </div>
            <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1">Turnos registrados: {{ stats.total_assignments }}</span>
          </div>

          <div class="relative flex-1 overflow-hidden rounded-2xl border border-slate-200 bg-white min-w-0">
            <div class="flex h-full flex-col min-w-0">
              <div class="flex flex-wrap items-center gap-3 border-b border-slate-200 bg-slate-50 px-4 py-3 text-xs font-medium uppercase tracking-wide text-slate-500">
                <span>Vista operativa</span>
                <span class="inline-flex items-center gap-1 text-[11px] text-slate-400">
                  <svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M4 3a1 1 0 011-1h2a1 1 0 01.894.553L8.618 4H16a1 1 0 011 1v2H3V3zm-1 6h16v8a1 1 0 01-1 1H4a1 1 0 01-1-1V9zm5 2a1 1 0 100 2h6a1 1 0 100-2H8z" clip-rule="evenodd" />
                  </svg>
                  Horizontal scroll para más días
                </span>
              </div>
              <div class="flex-1 overflow-x-auto" data-rest-scope>
                {% if can_override %}
                  <div class="sticky top-0 z-10 mb-3 hidden rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-[11px] font-semibold text-red-700" data-rest-message></div>
                {% endif %}
                <div
                  class="calendar-sheet-wrapper"
                  data-assignment-grid
                  data-save-url="{{ calendar_bulk_update_url }}"
                  data-can-edit="{{ can_override|yesno:'true,false' }}"
                >
                  {% if can_override %}
                    <div class="calendar-sheet__toolbar">
                      <p class="calendar-sheet__status" data-grid-status>Sin cambios pendientes</p>
                      <div class="calendar-sheet__actions">
                        <button type="button" data-grid-discard disabled>Descartar</button>
                        <button type="button" data-grid-save data-variant="primary" disabled>Guardar cambios</button>
                      </div>
                    </div>
                    <div class="calendar-sheet__feedback hidden" data-grid-feedback></div>
                  {% endif %}
                  <div class="calendar-sheet__table-wrapper">
                    <table class="calendar-sheet text-xs sm:text-sm">
                      <tbody>
                        {% for row in rows %}
                          {% with group=row.display_group %}
                            {% ifchanged group.key %}
                              {% with header_color=group.color_value|default:'#f4f6fb' %}
                              <tr class="bg-white" data-group-header="true" data-group-key="{{ group.key|default:'' }}" data-group-type="{{ group.type|default:'' }}" style="--group-divider-color: {{ header_color }};">
                                <th class="calendar-sheet__row-header sticky left-0 z-20 px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                                  Posición
                                </th>
                                {% for day in date_columns %}
                                  <th
                                    class="px-3 py-2 text-left"
                                    data-calendar-column-header
                                    data-calendar-col-index="{{ forloop.counter0 }}"
                                    data-calendar-day="{{ day|date:'Y-m-d' }}"
                                  >
                                    <span class="block text-[11px] font-medium text-slate-400">{{ day|date:"d/M" }}</span>
                                    <span class="block text-sm font-semibold text-slate-700">{{ day|date:"l"|capfirst }}</span>
                                  </th>
                                {% endfor %}
                              </tr>
                              {% endwith %}
                            {% endifchanged %}
                            {% with row_color=group.color_class|default:'bg-white' %}
                              {% with group_color=group.color_value|default:'#f8fafc' %}
                                {% with card_color=group.card_color_value|default:group_color %}
                                <tr class="calendar-sheet__row {{ row_color }}" data-group-key="{{ group.key|default:'' }}" data-group-type="{{ group.type|default:'' }}" data-group-label="{{ group.label|default:'' }}" {% if row.position %}data-position-id="{{ row.position.id }}"{% endif %} style="--group-color: {{ group_color }}; --cell-color: {{ group_color }}; --group-card-color: {{ card_color }};">
                                <th class="calendar-sheet__row-header sticky left-0 z-20 px-4 py-3 text-left align-top text-sm font-semibold text-slate-900 shadow-[1px_0_0_rgba(15,23,42,0.08)]">
                                  <span class="block text-xs uppercase tracking-wide text-slate-400">{{ row.position.farm.name }}</span>
                                  <span class="block text-base font-semibold text-slate-900">{{ row.position.name }}</span>
                                  <span class="block text-xs text-slate-500">{{ row.position.get_category_display }}</span>
                                </th>
                                {% for cell in row.cells %}
                                  <td
                                    class="calendar-sheet__cell align-top"
                                    data-calendar-col-index="{{ forloop.counter0 }}"
                                    data-calendar-day="{{ cell.date|date:'Y-m-d' }}"
                                  >
                                    {% if cell.is_position_active %}
                                      {% with assignment=cell.assignment %}
                                        {% if assignment %}
                                          {% if can_override and assignment.operator_id %}
                                            {% with show_rest_action=assignment.operator_id %}
                                              <div
                                                class="calendar-sheet__cell-content"
                                                data-assignment-cell
                                              data-cell-key="{{ row.position.id }}-{{ cell.date|date:'Ymd' }}"
                                              data-position-id="{{ row.position.id }}"
                                              data-date="{{ cell.date|date:'Y-m-d' }}"
                                              data-assignment-id="{{ assignment.id|default_if_none:'' }}"
                                              data-initial-value="{{ assignment.operator_id|default_if_none:'' }}"
                                              data-alert-level="{{ cell.alert }}"
                                              data-operator-id="{{ assignment.operator_id|default_if_none:'' }}"
                                              data-operator-name="{% if assignment.operator %}{{ assignment.operator.get_full_name|default:assignment.operator.nombres|default:assignment.operator.apellidos|default:'Colaborador sin nombre'|escape }}{% endif %}"
                                              data-cell-state="assigned"
                                              data-operator-card
                                              tabindex="0"
                                            >
                                              {% if can_override and cell.choices %}
                                                <div class="flex items-center gap-2">
                                                <span class="calendar-sheet__indicator"></span>
                                                  <div class="calendar-sheet__editor flex-1">
                                                    <label class="sr-only" for="assignment-cell-{{ row.position.id }}-{{ cell.date|date:'Ymd' }}">Selecciona un colaborador para este turno</label>
                                                    <select
                                                      id="assignment-cell-{{ row.position.id }}-{{ cell.date|date:'Ymd' }}"
                                                      data-assignment-input
                                                    >
                                                      <option value="">Sin asignación</option>
                                                      {% for option in cell.choices %}
                                                        <option value="{{ option.id }}" {% if option.id == assignment.operator_id %}selected{% endif %} {% if option.disabled %}disabled{% endif %}>
                                                          {{ option.label }}
                                                        </option>
                                                      {% endfor %}
                                                    </select>
                                                  </div>
                                                  {% if show_rest_action %}
                                                    <button
                                                      type="button"
                                                      class="calendar-sheet__action-btn"
                                                      data-rest-action="create"
                                                      data-rest-operator-id="{{ assignment.operator_id }}"
                                                      data-rest-date="{{ cell.date|date:'Y-m-d' }}"
                                                      data-rest-label="{{ cell.date|date:'d/M' }}"
                                                      data-operator-name="{% if assignment.operator %}{{ assignment.operator.get_full_name|default:assignment.operator.nombres|default:assignment.operator.apellidos|default:'Colaborador sin nombre'|escape }}{% endif %}"
                                                    >
                                                      <span class="sr-only">Programar descanso</span>
                                                      <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                        <path fill-rule="evenodd" d="M3.5 5A1.5 1.5 0 002 6.5V9h-.75a.75.75 0 000 1.5H2V15h-.75a.75.75 0 000 1.5h17.5a.75.75 0 000-1.5H18V9.75a1.25 1.25 0 00-1.25-1.25H12V6.5A1.5 1.5 0 0010.5 5h-7z" clip-rule="evenodd" />
                                                        <path d="M6.75 10.75a1.75 1.75 0 103.5 0 1.75 1.75 0 00-3.5 0z" />
                                                      </svg>
                                                    </button>
                                                  {% endif %}
                                                </div>
                                              {% else %}
                                                <div class="flex items-center justify-between gap-2">
                                                  <span class="calendar-sheet__indicator"></span>
                                                  <p class="truncate text-sm font-semibold text-slate-900">
                                                    {% if assignment.operator %}
                                                      {{ assignment.operator.get_full_name|default:assignment.operator.nombres|default:assignment.operator.apellidos }}
                                                    {% else %}
                                                      Colaborador sin nombre
                                                    {% endif %}
                                                  </p>
                                                  <div class="flex items-center gap-2">
                                                  {% if show_rest_action %}
                                                    <button
                                                      type="button"
                                                      class="calendar-sheet__action-btn"
                                                      data-rest-action="create"
                                                        data-rest-operator-id="{{ assignment.operator_id }}"
                                                        data-rest-date="{{ cell.date|date:'Y-m-d' }}"
                                                        data-rest-label="{{ cell.date|date:'d/M' }}"
                                                        data-operator-name="{% if assignment.operator %}{{ assignment.operator.get_full_name|default:assignment.operator.nombres|default:assignment.operator.apellidos|default:'Colaborador sin nombre'|escape }}{% endif %}"
                                                      >
                                                        <span class="sr-only">Programar descanso</span>
                                                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                                          <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" />
                                                        </svg>
                                                      </button>
                                                    {% endif %}
                                                  </div>
                                                </div>
                                              {% endif %}
                                              <div class="flex flex-wrap gap-2">
                                                {% if cell.is_overtime %}
                                                  <span class="calendar-sheet__note" data-variant="warn">{{ cell.overtime_message|default:"Horas extra" }}</span>
                                                {% endif %}
                                                {% if cell.skill_gap_message %}
                                                  <span class="calendar-sheet__note" data-variant="danger">{{ cell.skill_gap_message }}</span>
                                                {% endif %}
                                              </div>
                                            </div>
                                            {% endwith %}
                                          {% else %}
                                            <div
                                              class="calendar-sheet__cell-content"
                                              data-assignment-cell
                                              data-cell-key="{{ row.position.id }}-{{ cell.date|date:'Ymd' }}"
                                              data-position-id="{{ row.position.id }}"
                                              data-date="{{ cell.date|date:'Y-m-d' }}"
                                              data-assignment-id="{{ assignment.id|default_if_none:'' }}"
                                              data-initial-value="{{ assignment.operator_id|default_if_none:'' }}"
                                              data-alert-level="{{ cell.alert }}"
                                              data-operator-id="{{ assignment.operator_id|default_if_none:'' }}"
                                              data-operator-name="{% if assignment.operator %}{{ assignment.operator.get_full_name|default:assignment.operator.nombres|default:assignment.operator.apellidos|default:'Colaborador sin nombre'|escape }}{% endif %}"
                                              data-cell-state="assigned"
                                              data-operator-card
                                              tabindex="0"
                                            >
                                              <div class="flex items-center justify-between gap-2">
                                                <p class="truncate text-sm font-semibold text-slate-900">
                                                  {% if assignment.operator %}
                                                    {{ assignment.operator.get_full_name|default:assignment.operator.nombres|default:assignment.operator.apellidos }}
                                                  {% else %}
                                                    Colaborador sin nombre
                                                  {% endif %}
                                                </p>
                                                <span class="calendar-sheet__indicator"></span>
                                              </div>
                                              <div class="flex flex-wrap gap-2">
                                                {% if cell.is_overtime %}
                                                  <span class="calendar-sheet__note" data-variant="warn">{{ cell.overtime_message|default:"Horas extra" }}</span>
                                                {% endif %}
                                                {% if cell.skill_gap_message %}
                                                  <span class="calendar-sheet__note" data-variant="danger">{{ cell.skill_gap_message }}</span>
                                                {% endif %}
                                              </div>
                                            </div>
                                          {% endif %}
                                        {% else %}
                                          <div
                                            class="calendar-sheet__cell-content"
                                            data-assignment-cell
                                            data-cell-key="{{ row.position.id }}-{{ cell.date|date:'Ymd' }}"
                                            data-position-id="{{ row.position.id }}"
                                            data-date="{{ cell.date|date:'Y-m-d' }}"
                                            data-assignment-id=""
                                            data-initial-value=""
                                            data-alert-level="{{ cell.alert }}"
                                            data-operator-id=""
                                            data-operator-name=""
                                            data-cell-state="empty"
                                            data-operator-card
                                            tabindex="0"
                                          >
                                              {% if can_override and cell.choices %}
                                                <div class="flex items-center gap-2">
                                                  <div class="calendar-sheet__editor flex-1">
                                                    <label class="sr-only" for="assignment-cell-{{ row.position.id }}-{{ cell.date|date:'Ymd' }}">Selecciona un colaborador para este turno</label>
                                                    <select
                                                      id="assignment-cell-{{ row.position.id }}-{{ cell.date|date:'Ymd' }}"
                                                      data-assignment-input
                                                    >
                                                      <option value="" selected>Sin asignación</option>
                                                      {% for option in cell.choices %}
                                                        <option value="{{ option.id }}" {% if option.disabled %}disabled{% endif %}>
                                                          {{ option.label }}
                                                        </option>
                                                      {% endfor %}
                                                    </select>
                                                  </div>
                                                  <span class="calendar-sheet__indicator"></span>
                                                </div>
                                            {% elif not cell.choices %}
                                              <div class="flex items-center justify-between gap-2 text-xs text-slate-500">
                                                <p>Sin candidatos disponibles</p>
                                                <span class="calendar-sheet__indicator"></span>
                                              </div>
                                            {% else %}
                                              <div class="flex justify-end">
                                                <span class="calendar-sheet__indicator"></span>
                                              </div>
                                            {% endif %}
                                          </div>
                                        {% endif %}
                                      {% endwith %}
                                    {% else %}
                                      <div class="calendar-sheet__cell-content" data-cell-state="inactive">
                                        <span class="calendar-sheet__placeholder">Posición fuera de vigencia</span>
                                      </div>
                                    {% endif %}
                                  </td>
                                {% endfor %}
                              </tr>
                                {% endwith %}
                              {% endwith %}
                            {% endwith %}
                          {% endwith %}
                        {% endfor %}
                        {% if rest_matrix_rows %}
                          {% with rest_group=rest_matrix_rows.0.display_group %}
                            {% with rest_header_color=rest_group.color_value|default:'#f4f6fb' %}
                            <tr class="bg-white" data-group-header="true" data-group-key="{{ rest_group.key|default:'' }}" data-group-type="{{ rest_group.type|default:'' }}" style="--group-divider-color: {{ rest_header_color }};">
                              <th class="calendar-sheet__row-header sticky left-0 z-20 px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                                Descansos y libres
                              </th>
                              {% for day in date_columns %}
                                <th
                                  class="px-3 py-2 text-left"
                                  data-calendar-column-header
                                  data-calendar-col-index="{{ forloop.counter0 }}"
                                  data-calendar-day="{{ day|date:'Y-m-d' }}"
                                >
                                  <span class="block text-[11px] font-medium text-slate-400">{{ day|date:"d/M" }}</span>
                                  <span class="block text-sm font-semibold text-slate-700">{{ day|date:"l"|capfirst }}</span>
                                </th>
                              {% endfor %}
                            </tr>
                            {% endwith %}
                          {% endwith %}
                          {% for rest_row in rest_matrix_rows %}
                            {% with rest_group=rest_row.display_group %}
                              {% with rest_value=rest_group.color_value|default:'#f8fafc' %}
                                {% with rest_card=rest_group.card_color_value|default:rest_value %}
                                <tr class="calendar-sheet__row {{ rest_group.color_class|default:'bg-slate-50' }}" data-group-key="{{ rest_group.key|default:'' }}" data-group-type="{{ rest_group.type|default:'' }}" data-group-label="{{ rest_group.label|default:'' }}" style="--group-color: {{ rest_value }}; --cell-color: {{ rest_value }}; --group-card-color: {{ rest_card }};">
                                  <th class="calendar-sheet__row-header sticky left-0 z-20 px-4 py-3 text-left align-top text-sm font-semibold text-slate-900 shadow-[1px_0_0_rgba(15,23,42,0.08)]">
                                    <span class="block text-xs uppercase tracking-wide text-slate-400">{{ rest_row.label }}</span>
                                  </th>
                                  {% for cell in rest_row.cells %}
                                    <td
                                      class="calendar-sheet__cell align-top"
                                      data-calendar-col-index="{{ forloop.counter0 }}"
                                      data-calendar-day="{{ cell.date|date:'Y-m-d' }}"
                                    >
                                      <div class="calendar-sheet__cell-content">
                                        {% if cell.name %}
                                          <p class="text-sm font-semibold text-slate-900">{{ cell.name }}</p>
                                          {% if cell.reason %}
                                            <p class="text-xs text-slate-500">{{ cell.reason }}</p>
                                          {% endif %}
                                        {% else %}
                                          <span class="calendar-sheet__placeholder">—</span>
                                        {% endif %}
                                      </div>
                                    </td>
                                  {% endfor %}
                                </tr>
                                {% endwith %}
                              {% endwith %}
                            {% endwith %}
                          {% endfor %}
                        {% endif %}
                      </tbody>
                    </table>



      <script>
        document.addEventListener('DOMContentLoaded', function () {
          var highlightClasses = ['outline', 'outline-2', 'outline-offset-2', 'outline-indigo-500', 'bg-indigo-50', 'shadow-lg'];
          var cards = Array.prototype.slice.call(document.querySelectorAll('[data-operator-id]'));
          var groupMapEl = document.getElementById('position-group-map');
          var positionGroupEl = document.getElementById('position-to-group-map');
          var groupMap = {};
          var positionToGroup = {};
          if (groupMapEl) {
            try {
              groupMap = JSON.parse(groupMapEl.textContent || '{}');
            } catch (error) {
              groupMap = {};
            }
          }
          if (positionGroupEl) {
            try {
              positionToGroup = JSON.parse(positionGroupEl.textContent || '{}');
            } catch (error) {
              positionToGroup = {};
            }
          }
          var restSummaryDataEl = document.getElementById('rest-summary-data');
          var restSummary = {};
          if (restSummaryDataEl) {
            try {
              restSummary = JSON.parse(restSummaryDataEl.textContent);
            } catch (error) {
              restSummary = {};
            }
          }
          var restConfigEl = document.querySelector('[data-rest-config]');
          var restScope = document.querySelector('[data-rest-scope]');
          var restMessageEl = restScope ? restScope.querySelector('[data-rest-message]') : null;
          var restActionsEnabled = restConfigEl ? restConfigEl.dataset.restEnabled === 'true' : false;
          var restCreateUrl = restConfigEl ? restConfigEl.dataset.restCreateUrl || '' : '';
          var restDetailTemplate = restConfigEl ? restConfigEl.dataset.restDetailUrlTemplate || '' : '';
          var restCalendarId = restConfigEl ? restConfigEl.dataset.calendarId || '' : '';
          var restBusy = false;
          var csrfSafeMethods = { GET: true, HEAD: true, OPTIONS: true, TRACE: true };

          function getCookie(name) {
            if (typeof document === 'undefined') {
              return '';
            }
            var cookies = document.cookie ? document.cookie.split('; ') : [];
            for (var i = 0; i < cookies.length; i += 1) {
              if (cookies[i].startsWith(name + '=')) {
                return decodeURIComponent(cookies[i].slice(name.length + 1));
              }
            }
            return '';
          }

          function getCsrfToken() {
            return getCookie('csrftoken');
          }

          function apiRequest(url, options) {
            var settings = options || {};
            var method = (settings.method || 'GET').toUpperCase();
            var headers = { 'X-Requested-With': 'XMLHttpRequest' };
            if (!csrfSafeMethods[method]) {
              var token = getCsrfToken();
              if (token) {
                headers['X-CSRFToken'] = token;
              }
            }
            if (settings.headers) {
              Object.keys(settings.headers).forEach(function (key) {
                headers[key] = settings.headers[key];
              });
            }
            var fetchOptions = {
              method: method,
              headers: headers,
              credentials: 'same-origin',
            };
            if (settings.body !== undefined) {
              fetchOptions.body = JSON.stringify(settings.body);
              fetchOptions.headers['Content-Type'] = 'application/json';
            }
            return fetch(url, fetchOptions);
          }

          function clearRestMessage() {
            if (!restMessageEl) {
              return;
            }
            restMessageEl.textContent = '';
            restMessageEl.classList.add('hidden');
          }

          function showRestError(message) {
            if (restMessageEl) {
              restMessageEl.textContent = message || 'No fue posible completar la acción.';
              restMessageEl.classList.remove('hidden');
            } else if (message) {
              window.alert(message);
            }
          }

          function setButtonLoading(button, isLoading) {
            if (!button) {
              return;
            }
            if (isLoading) {
              button.disabled = true;
              button.classList.add('opacity-60', 'cursor-wait');
            } else {
              button.disabled = false;
              button.classList.remove('opacity-60', 'cursor-wait');
            }
          }

          function parseIntSafe(value) {
            if (value === null || value === undefined || value === '') {
              return null;
            }
            var parsed = Number.parseInt(value, 10);
            if (Number.isNaN(parsed)) {
              return null;
            }
            return parsed;
          }

          function padNumber(value) {
            var number = Number(value);
            if (Number.isNaN(number)) {
              return '';
            }
            return number < 10 ? '0' + number : String(number);
          }

          function formatDateToISO(dateObject) {
            if (!(dateObject instanceof Date) || Number.isNaN(dateObject.getTime())) {
              return '';
            }
            return [dateObject.getFullYear(), padNumber(dateObject.getMonth() + 1), padNumber(dateObject.getDate())].join('-');
          }

          function parseDateValue(value) {
            if (!value) {
              return null;
            }
            var parts = value.split('-');
            if (parts.length !== 3) {
              return null;
            }
            var year = Number.parseInt(parts[0], 10);
            var month = Number.parseInt(parts[1], 10);
            var day = Number.parseInt(parts[2], 10);
            if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {
              return null;
            }
            return new Date(year, month - 1, day);
          }

          function highlightNearestCalendarColumn() {
            if (!restScope) {
              return;
            }
            var headerNodes = restScope.querySelectorAll('[data-calendar-column-header]');
            if (!headerNodes.length) {
              return;
            }
            var previousHighlights = restScope.querySelectorAll('[data-calendar-highlight]');
            Array.prototype.forEach.call(previousHighlights, function (node) {
              node.removeAttribute('data-calendar-highlight');
              node.classList.remove('text-indigo-900');
            });
            var headers = Array.prototype.slice.call(headerNodes);
            var today = new Date();
            var todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            var todayTimestamp = todayDate.getTime();
            var todayFormatted = formatDateToISO(todayDate);
            var selectedHeader = null;
            var selectedTimestamp = null;
            var smallestDiff = Infinity;

            headers.forEach(function (header) {
              var dateStr = header.dataset.calendarDay || '';
              var columnIndex = header.dataset.calendarColIndex;
              if (!dateStr || columnIndex === undefined) {
                return;
              }
              var headerDate = parseDateValue(dateStr);
              if (!headerDate) {
                return;
              }
              var headerTimestamp = headerDate.getTime();
              if (dateStr === todayFormatted) {
                selectedHeader = header;
                selectedTimestamp = headerTimestamp;
                smallestDiff = 0;
                return;
              }
              var diff = Math.abs(headerTimestamp - todayTimestamp);
              var shouldSelect = false;
              if (diff < smallestDiff) {
                shouldSelect = true;
              } else if (diff === smallestDiff) {
                var headerIsFuture = headerTimestamp >= todayTimestamp;
                var selectedIsFuture = selectedTimestamp !== null ? selectedTimestamp >= todayTimestamp : null;
                if (headerIsFuture && !selectedIsFuture) {
                  shouldSelect = true;
                } else if (headerIsFuture === selectedIsFuture) {
                  if (selectedTimestamp === null || headerTimestamp < selectedTimestamp) {
                    shouldSelect = true;
                  }
                }
              }
              if (shouldSelect) {
                selectedHeader = header;
                selectedTimestamp = headerTimestamp;
                smallestDiff = diff;
              }
            });

            if (!selectedHeader) {
              return;
            }
            var targetIndex = selectedHeader.dataset.calendarColIndex;
            if (targetIndex === undefined) {
              return;
            }
            var columnCells = restScope.querySelectorAll('[data-calendar-col-index="' + targetIndex + '"]');
            if (!columnCells.length) {
              return;
            }
            Array.prototype.forEach.call(columnCells, function (cell) {
              cell.setAttribute('data-calendar-highlight', 'true');
              if (cell.tagName === 'TH') {
                cell.classList.add('text-indigo-900');
              }
            });

            window.requestAnimationFrame(function () {
              if (!restScope) {
                return;
              }
              var desiredScroll = selectedHeader.offsetLeft - restScope.clientWidth / 2 + selectedHeader.clientWidth / 2;
              if (desiredScroll < 0) {
                desiredScroll = 0;
              }
              if (typeof restScope.scrollTo === 'function') {
                restScope.scrollTo({ left: desiredScroll, behavior: 'smooth' });
              } else {
                restScope.scrollLeft = desiredScroll;
              }
            });
          }

          highlightNearestCalendarColumn();

          function resolveRestDetailUrl(restPeriodId) {
            if (!restDetailTemplate) {
              return '';
            }
            var id = String(restPeriodId);
            if (restDetailTemplate.endsWith('/0/')) {
              return restDetailTemplate.slice(0, -2) + id + '/';
            }
            if (restDetailTemplate.endsWith('/0')) {
              return restDetailTemplate.slice(0, -1) + id;
            }
            var lastIndex = restDetailTemplate.lastIndexOf('0');
            if (lastIndex === -1) {
              return '';
            }
            return restDetailTemplate.slice(0, lastIndex) + id + restDetailTemplate.slice(lastIndex + 1);
          }

          function sendRestRequest(url, method, payload, button) {
            if (!url) {
              showRestError('No encontramos la ruta para completar la acción.');
              return;
            }
            if (restBusy) {
              return;
            }
            restBusy = true;
            setButtonLoading(button, true);
            clearRestMessage();
            var options = { method: method };
            if (payload !== undefined) {
              options.body = payload;
            }
            apiRequest(url, options)
              .then(function (response) {
                if (!response.ok) {
                  return response
                    .json()
                    .catch(function () {
                      return {};
                    })
                    .then(function (data) {
                      var message = data && data.error ? data.error : 'No fue posible completar la acción.';
                      throw new Error(message);
                    });
                }
                return response.json().catch(function () {
                  return null;
                });
              })
              .then(function () {
                window.location.reload();
              })
              .catch(function (error) {
                restBusy = false;
                setButtonLoading(button, false);
                showRestError(error.message || 'No fue posible completar la acción.');
              })
              .finally(function () {
                if (!restBusy) {
                  return;
                }
                restBusy = false;
                setButtonLoading(button, false);
              });
          }

          function handleRestCreate(button) {
            if (!restActionsEnabled) {
              return;
            }
            var operatorId = parseIntSafe(button ? button.dataset.restOperatorId : null);
            var dateValue = button ? button.dataset.restDate || '' : '';
            if (!operatorId || !dateValue) {
              showRestError('No fue posible identificar al colaborador y la fecha seleccionados.');
              return;
            }
            var payload = {
              operator: operatorId,
              start_date: dateValue,
              end_date: dateValue,
              status: 'planned',
              source: 'manual',
            };
            var calendarId = parseIntSafe(restCalendarId);
            if (calendarId) {
              payload.calendar = calendarId;
            }
            sendRestRequest(restCreateUrl, 'POST', payload, button);
          }

          function handleRestDelete(button) {
            if (!restActionsEnabled) {
              return;
            }
            var restPeriodId = parseIntSafe(button ? button.dataset.restPeriodId : null);
            if (!restPeriodId) {
              showRestError('No encontramos el descanso seleccionado.');
              return;
            }
            var label = button ? button.dataset.restLabel || '' : '';
            var operatorName = button ? button.dataset.operatorName || '' : '';
            var confirmationLabel = '¿Eliminar el descanso';
            if (operatorName) {
              confirmationLabel += ' de ' + operatorName;
            }
            if (label) {
              confirmationLabel += label ? ' (' + label + ')' : '';
            }
            confirmationLabel += '?';
            if (!window.confirm(confirmationLabel)) {
              return;
            }
            var url = resolveRestDetailUrl(restPeriodId);
            if (!url) {
              showRestError('No encontramos la ruta para eliminar el descanso.');
              return;
            }
            sendRestRequest(url, 'DELETE', undefined, button);
          }

          if (restActionsEnabled && restScope) {
            restScope.addEventListener('click', function (event) {
              var button = event.target.closest('[data-rest-action]');
              if (!button) {
                return;
              }
              event.preventDefault();
              event.stopPropagation();
              var action = button.dataset.restAction;
              if (action === 'create') {
                handleRestCreate(button);
              } else if (action === 'delete') {
                handleRestDelete(button);
              }
            });
          }
          function applyGroupHighlighting() {
            if (!groupMap || Object.keys(groupMap).length === 0) {
              return;
            }
            var rows = Array.prototype.slice.call(document.querySelectorAll('tbody tr'));
            rows.forEach(function (row) {
              var groupKey = row.getAttribute('data-group-key');
              if (!groupKey) {
                var positionId = row.getAttribute('data-position-id');
                if (positionId && positionToGroup && positionToGroup[positionId]) {
                  groupKey = positionToGroup[positionId];
                  row.setAttribute('data-group-key', groupKey);
                }
              }
              if (!groupKey) {
                return;
              }
              var meta = groupMap[groupKey];
              if (!meta) {
                return;
              }
              var colorClass = meta.color_class || '';
              if (colorClass) {
                row.classList.add(colorClass);
                var headerCell = row.querySelector('th.sticky');
                if (headerCell && !headerCell.classList.contains(colorClass)) {
                  headerCell.classList.add(colorClass);
                }
              }
              if (!row.getAttribute('data-group-label') && meta.label) {
                row.setAttribute('data-group-label', meta.label);
              }
              if (!row.getAttribute('data-group-type') && meta.type) {
                row.setAttribute('data-group-type', meta.type);
              }
            });
          }

          applyGroupHighlighting();
          var restPanel = document.querySelector('[data-rest-panel]');
          var restOperatorTitle = restPanel ? restPanel.querySelector('[data-rest-operator-title]') : null;
          var restEmployment = restPanel ? restPanel.querySelector('[data-rest-employment]') : null;
          var restCurrent = restPanel ? restPanel.querySelector('[data-rest-current]') : null;
          var restRecent = restPanel ? restPanel.querySelector('[data-rest-recent]') : null;
          var restUpcoming = restPanel ? restPanel.querySelector('[data-rest-upcoming]') : null;
          var restClear = restPanel ? restPanel.querySelector('[data-rest-clear]') : null;

          function formatDate(isoString) {
            if (!isoString) {
              return '';
            }
            var parts = isoString.split('-');
            if (parts.length !== 3) {
              return isoString;
            }
            return parts[2] + '/' + parts[1] + '/' + parts[0];
          }

          function describePeriod(period) {
            if (!period) {
              return null;
            }
            var startLabel = formatDate(period.start);
            var endLabel = formatDate(period.end);
            var rangeLabel = startLabel === endLabel || !endLabel ? startLabel : startLabel + ' → ' + endLabel;
            var qualifiers = [];
            if (period.status_label) {
              qualifiers.push(period.status_label);
            }
            if (period.source_label) {
              qualifiers.push(period.source_label);
            }
            if (qualifiers.length) {
              rangeLabel += ' · ' + qualifiers.join(' · ');
            }
            return rangeLabel;
          }

          function clearRestPanel() {
            if (!restPanel) {
              return;
            }
            if (restOperatorTitle) {
              restOperatorTitle.textContent = 'Selecciona un colaborador para ver sus descansos.';
            }
            if (restEmployment) {
              restEmployment.textContent = '';
            }
            if (restCurrent) {
              restCurrent.textContent = 'Sin descanso vigente';
            }
            if (restRecent) {
              restRecent.textContent = 'Sin registro';
            }
            if (restUpcoming) {
              restUpcoming.textContent = 'Sin programación futura';
            }
          }

          function updateRestPanel(operatorId, sourceCard) {
            if (!restPanel || !restOperatorTitle || !restCurrent || !restRecent || !restUpcoming) {
              return;
            }

            var summary = restSummary[operatorId];
            if (!summary) {
              restOperatorTitle.textContent = 'Sin información de descansos para este colaborador.';
              if (restEmployment) {
                restEmployment.textContent = '';
              }
              restCurrent.textContent = 'Sin datos';
              restRecent.textContent = 'Sin datos';
              restUpcoming.textContent = 'Sin datos';
              return;
            }

            var operatorName = sourceCard ? (sourceCard.dataset.operatorName || '') : '';
            if (!operatorName && summary.name) {
              operatorName = summary.name;
            }
            if (!operatorName) {
              operatorName = 'Colaborador seleccionado';
            }
            restOperatorTitle.textContent = operatorName;

            if (restEmployment) {
              if (summary.employment_start && summary.employment_end) {
                restEmployment.textContent = summary.employment_start + ' → ' + summary.employment_end;
              } else if (summary.employment_start) {
                restEmployment.textContent = 'Ingreso: ' + summary.employment_start;
              } else {
                restEmployment.textContent = '';
              }
            }

            var currentLabel = describePeriod(summary.current);
            restCurrent.textContent = currentLabel || 'Sin descanso vigente';

            var recentLabel = describePeriod(summary.recent);
            restRecent.textContent = recentLabel || 'Sin registro';

            var upcomingLabel = describePeriod(summary.upcoming);
            restUpcoming.textContent = upcomingLabel || 'Sin programación futura';
          }

          var highlightedOperator = null;
          var highlightedCards = [];

          function clearHighlight() {
            highlightedCards.forEach(function (card) {
              highlightClasses.forEach(function (cls) {
                card.classList.remove(cls);
              });
            });
            highlightedCards = [];
            highlightedOperator = null;
          }

          function setHighlight(operatorId, sourceCard) {
            clearHighlight();
            highlightedOperator = operatorId;
            highlightedCards = cards.filter(function (card) {
              return card.dataset.operatorId === operatorId;
            });
            highlightedCards.forEach(function (card) {
              highlightClasses.forEach(function (cls) {
                card.classList.add(cls);
              });
            });
            updateRestPanel(operatorId, sourceCard);
          }

          function clearHighlightIfUnlocked(operatorId) {
            if (operatorId !== highlightedOperator) {
              return;
            }
            setTimeout(function () {
              if (document.activeElement && document.activeElement.closest('[data-operator-id="' + operatorId + '"]')) {
                return;
              }
              clearHighlight();
              clearRestPanel();
            }, 100);
          }

          if (restClear) {
            restClear.addEventListener('click', function () {
              clearHighlight();
              clearRestPanel();
            });
          }

          clearRestPanel();

          cards.forEach(function (card) {
            var operatorId = card.dataset.operatorId;
            if (!operatorId) {
              return;
            }

            card.addEventListener('click', function (event) {
              if (event.detail > 1) {
                return;
              }
              if (highlightedOperator === operatorId) {
                clearHighlight();
                clearRestPanel();
              } else {
                setHighlight(operatorId, card);
              }
            });

            card.addEventListener('focusin', function () {
              setHighlight(operatorId, card);
            });

            card.addEventListener('focusout', function (event) {
              if (highlightedOperator === operatorId && !card.contains(event.relatedTarget)) {
                clearHighlightIfUnlocked(operatorId);
              }
            });
          });
        });
      </script>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var grid = document.querySelector('[data-assignment-grid]');
      if (!grid || grid.getAttribute('data-can-edit') !== 'true') {
        return;
      }
      var selects = Array.prototype.slice.call(grid.querySelectorAll('[data-assignment-input]'));
      var statusLabel = grid.querySelector('[data-grid-status]');
      var feedback = grid.querySelector('[data-grid-feedback]');
      var saveButton = grid.querySelector('[data-grid-save]');
      var discardButton = grid.querySelector('[data-grid-discard]');
      var pendingChanges = new Map();
      var isSaving = false;
      var saveUrl = grid.getAttribute('data-save-url') || '';

      function getCookie(name) {
        var cookies = document.cookie ? document.cookie.split('; ') : [];
        for (var i = 0; i < cookies.length; i += 1) {
          var parts = cookies[i].split('=');
          if (parts[0] === name) {
            return decodeURIComponent(parts.slice(1).join('='));
          }
        }
        return '';
      }

      function parseInteger(value) {
        var parsed = Number.parseInt(value, 10);
        return Number.isNaN(parsed) ? null : parsed;
      }

      function showFeedback(message, variant) {
        if (!feedback) {
          return;
        }
        if (!message) {
          feedback.classList.add('hidden');
          feedback.textContent = '';
          feedback.removeAttribute('data-variant');
          return;
        }
        feedback.textContent = message;
        feedback.setAttribute('data-variant', variant || 'error');
        feedback.classList.remove('hidden');
      }

      function updateStatus() {
        var count = pendingChanges.size;
        if (statusLabel) {
          statusLabel.textContent = count
            ? count + ' cambio' + (count === 1 ? ' pendiente' : 's pendientes')
            : 'Sin cambios pendientes';
        }
        var disableSave = count === 0 || isSaving;
        if (saveButton) {
          saveButton.disabled = disableSave;
        }
        if (discardButton) {
          discardButton.disabled = count === 0 || isSaving;
        }
      }

      function updateCellDisplay(cell, select, value) {
        if (!cell) {
          return;
        }
        if (value) {
          cell.dataset.cellState = 'assigned';
          cell.dataset.operatorId = value;
          var optionNode = select && select.options[select.selectedIndex];
          cell.dataset.operatorName = optionNode ? optionNode.textContent.trim() : '';
        } else {
          cell.dataset.cellState = 'empty';
          cell.dataset.operatorId = '';
          cell.dataset.operatorName = '';
        }
      }

      function removeCellChange(cellKey, cell) {
        pendingChanges.delete(cellKey);
        if (cell) {
          cell.removeAttribute('data-cell-dirty');
        }
        updateStatus();
      }

      function setCellChange(cellKey, payload, cell) {
        pendingChanges.set(cellKey, payload);
        if (cell) {
          cell.setAttribute('data-cell-dirty', 'true');
        }
        updateStatus();
      }

      function resetCell(cell) {
        if (!cell) {
          return;
        }
        var select = cell.querySelector('[data-assignment-input]');
        if (!select) {
          return;
        }
        var initialValue = cell.getAttribute('data-initial-value') || '';
        select.value = initialValue;
        updateCellDisplay(cell, select, initialValue);
        cell.removeAttribute('data-cell-dirty');
        cell.dataset.cellState = initialValue ? 'assigned' : 'empty';
        cell.dataset.operatorId = initialValue || '';
      }

      selects.forEach(function (select) {
        select.addEventListener('change', function () {
          var cell = select.closest('[data-assignment-cell]');
          if (!cell) {
            return;
          }
          var key = cell.getAttribute('data-cell-key') || '';
          if (!key) {
            return;
          }
          var newValue = select.value || '';
          var initialValue = cell.getAttribute('data-initial-value') || '';
          updateCellDisplay(cell, select, newValue);
          if (newValue === initialValue) {
            removeCellChange(key, cell);
            return;
          }
          var payload = {
            assignment_id: parseInteger(cell.getAttribute('data-assignment-id')),
            position_id: parseInteger(cell.getAttribute('data-position-id')),
            operator_id: newValue ? parseInteger(newValue) : null,
            date: cell.getAttribute('data-date') || null,
            force_override: true,
          };
          setCellChange(key, payload, cell);
        });
      });

      if (discardButton) {
        discardButton.addEventListener('click', function () {
          pendingChanges.forEach(function (_value, key) {
            var cell = grid.querySelector('[data-cell-key="' + key + '"]');
            resetCell(cell);
          });
          pendingChanges.clear();
          showFeedback('', '');
          updateStatus();
        });
      }

      if (saveButton) {
        saveButton.addEventListener('click', function () {
          if (isSaving || pendingChanges.size === 0 || !saveUrl) {
            return;
          }
          isSaving = true;
          updateStatus();
          showFeedback('Guardando cambios…', 'success');
          var changes = Array.from(pendingChanges.values());
          fetch(saveUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken'),
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ changes: changes }),
          })
            .then(function (response) {
              return response
                .json()
                .catch(function () {
                  return {};
                })
                .then(function (body) {
                  return { ok: response.ok, body: body };
                });
            })
            .then(function (result) {
              isSaving = false;
              updateStatus();
              if (!result || !result.ok || (result.body && result.body.success === false)) {
                var errorMessage =
                  (result && result.body && result.body.error) ||
                  'No fue posible guardar los cambios.';
                showFeedback(errorMessage, 'error');
                return;
              }
              pendingChanges.clear();
              showFeedback(
                (result.body && result.body.message) || 'Cambios guardados correctamente.',
                'success'
              );
              setTimeout(function () {
                window.location.reload();
              }, 900);
            })
            .catch(function () {
              isSaving = false;
              updateStatus();
              showFeedback('Ocurrió un error al guardar los cambios.', 'error');
            });
        });
      }

      updateStatus();
    });
  </script>
</div>
{% endblock %}
