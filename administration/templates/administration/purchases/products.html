{% extends "calendario/base.html" %}
{% load form_extras %}

{% block title %}Administración · Productos{% endblock %}

{% block content %}
  {% include "administration/_submenu.html" with active=administration_active_submenu %}

  <section class="space-y-6">
    <header class="flex flex-col gap-4 rounded-2xl bg-white/90 p-6 shadow-sm ring-1 ring-slate-200/70 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Administración</p>
        <h1 class="text-2xl font-semibold text-slate-900">Productos</h1>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <form method="get" class="flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2">
          <input
            type="search"
            name="search"
            value="{{ product_search }}"
            placeholder="Buscar por nombre o unidad"
            class="w-48 bg-transparent text-sm text-slate-600 placeholder:text-slate-400 focus:outline-none"
          >
          <button type="submit" class="text-xs font-semibold text-slate-500">Buscar</button>
        </form>
        <a
          href="?{% if product_search %}search={{ product_search|urlencode }}&{% endif %}panel=product"
          class="inline-flex items-center gap-2 rounded-full bg-brand px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-brand/90"
        >
          <span aria-hidden="true" class="text-base">＋</span>
          Nuevo producto
        </a>
      </div>
    </header>

    <div class="rounded-2xl border border-slate-200/70 bg-white/95 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-200/70 px-6 py-4 text-sm">
        <p class="text-slate-600">
          Mostrando
          <span class="font-semibold text-slate-900">{{ products_page.object_list|length }}</span>
          de
          <span class="font-semibold text-slate-900">{{ products_page.paginator.count }}</span>
          productos
          {% if product_search %}
            para <span class="font-semibold">“{{ product_search }}”</span>
          {% endif %}
        </p>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">
          Página {{ products_page.number }} · {{ products_page.paginator.num_pages }}
        </p>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
            <tr>
              <th class="px-6 py-3">Producto</th>
              <th class="px-6 py-3">Unidad</th>
              <th class="px-6 py-3">Actualizado</th>
              <th class="px-6 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white">
            {% for product in products_page %}
              <tr class="hover:bg-slate-50/70">
                <td class="px-6 py-4">
                  <p class="font-semibold text-slate-900">{{ product.name }}</p>
                  <p class="text-xs text-slate-500">ID · {{ product.pk }}</p>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">
                    {{ product.unit }}
                  </span>
                </td>
                <td class="px-6 py-4 text-xs text-slate-500">
                  {{ product.updated_at|date:"Y-m-d H:i" }}
                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-wrap items-center justify-end gap-2">
                    <a
                      href="?{% if product_search %}search={{ product_search|urlencode }}&{% endif %}panel=product&product={{ product.pk }}"
                      class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900"
                    >
                      Editar
                    </a>
                    <a
                      href="?{% if product_search %}search={{ product_search|urlencode }}&{% endif %}panel=product&product={{ product.pk }}&modal=delete"
                      class="rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600 hover:border-rose-300 hover:text-rose-700"
                    >
                      Eliminar
                    </a>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="px-6 py-16 text-center">
                  <p class="text-base font-semibold text-slate-900">No hay productos registrados</p>
                  <p class="text-sm text-slate-500">Crea el primero para reutilizarlo en solicitudes de compra.</p>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  {% if product_panel_open %}
    <div class="fixed inset-0 z-30 bg-slate-900/40"></div>
    <aside class="fixed inset-y-0 right-0 z-40 w-full max-w-md overflow-y-auto border-l border-slate-200 bg-white shadow-2xl">
      <div class="flex items-start justify-between border-b border-slate-200 px-5 py-4">
        <div>
          <p class="text-lg font-semibold text-slate-900">
            {% if product_instance %}Editar producto{% else %}Nuevo producto{% endif %}
          </p>
          {% if product_instance %}
            <p class="text-xs uppercase tracking-wide text-slate-500">ID · {{ product_instance.pk }}</p>
          {% endif %}
        </div>
        <a href="?{% if product_search %}search={{ product_search|urlencode }}&{% endif %}" class="text-sm font-medium text-slate-500 hover:text-slate-900">
          Cerrar
        </a>
      </div>
      <div class="p-5">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="form_action" value="product">
          <input type="hidden" name="product_id" value="{{ product_instance.pk|default:'' }}">
          <div class="space-y-4">
            {% if product_form.non_field_errors %}
              <div class="rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-xs font-semibold text-red-600">
                {% for error in product_form.non_field_errors %}
                  <p>{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            <label class="text-xs font-semibold text-slate-600">
              Nombre del producto
              {{ product_form.name|add_class:"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" }}
              {{ product_form.name.errors }}
            </label>
            <label class="text-xs font-semibold text-slate-600">
              Unidad
              {{ product_form.unit|add_class:"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" }}
              {{ product_form.unit.errors }}
            </label>
          </div>
          <div class="mt-6 flex justify-end gap-3 border-t border-slate-200 pt-4">
            <a href="?{% if product_search %}search={{ product_search|urlencode }}&{% endif %}" class="rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900">
              Cancelar
            </a>
            <button type="submit" class="rounded-full bg-brand px-5 py-2 text-sm font-semibold text-white hover:bg-brand/90">
              Guardar producto
            </button>
          </div>
        </form>
      </div>
    </aside>
  {% endif %}

  {% if delete_modal_open %}
    <div class="fixed inset-0 z-50 bg-slate-900/60"></div>
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-2xl bg-white p-6 text-sm text-slate-600 shadow-2xl">
        <h2 class="text-lg font-semibold text-slate-900">Eliminar producto</h2>
        <p class="mt-2 text-slate-500">
          Esta acción no se puede deshacer. ¿Seguro que deseas eliminar
          <span class="font-semibold">{{ product_instance.name }}</span>?
        </p>
        <form method="post" class="mt-6 flex items-center justify-end gap-3">
          {% csrf_token %}
          <input type="hidden" name="form_action" value="delete">
          <input type="hidden" name="product_id" value="{{ product_instance.pk }}">
          <a href="?{% if product_search %}search={{ product_search|urlencode }}&{% endif %}" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 hover:border-slate-300">
            Cancelar
          </a>
          <button type="submit" class="rounded-full bg-rose-600 px-4 py-2 text-xs font-semibold text-white hover:bg-rose-700">
            Eliminar
          </button>
        </form>
      </div>
    </div>
  {% endif %}
{% endblock %}
