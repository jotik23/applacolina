{% load static form_extras %}
{% with purchase=purchases_panel.purchase form=purchase_request_form field_errors=purchase_request_field_errors item_errors=purchase_request_item_errors %}
<section
  class="space-y-6 text-sm text-slate-700 w-full"
  data-purchase-request-form
  data-read-only="{{ form.read_only|yesno:'true,false' }}"
  data-unit-label="{{ form.unit_label|default:'Unidad' }}"
>
  {% if field_errors.non_field %}
    <div class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-xs font-medium text-red-700">
      {% for message in field_errors.non_field %}
        <p>{{ message }}</p>
      {% endfor %}
    </div>
  {% endif %}

  {% if form.read_only %}
    <div class="rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-xs font-semibold text-amber-800">
      Esta solicitud se encuentra en {{ purchase.get_status_display|default:"un estado no editable" }}. Los campos se muestran solo para consulta.
    </div>
  {% endif %}

  <fieldset class="space-y-6" {% if form.read_only %}disabled{% endif %}>
    {% with initial=form.initial scope=form.scope_values scope_code=form.scope_code %}
    <article class="space-y-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-5 w-full">
      <header>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Resumen</p>
        <h2 class="text-lg font-semibold text-slate-900">Solicitud de compra</h2>
        <p class="text-xs text-slate-500">Completa los metadatos del gasto para habilitar el flujo.</p>
      </header>
      <div class="space-y-4">
        <label class="text-xs font-semibold text-slate-500 block">
          Nombre del requerimiento
          <input
            type="text"
            name="summary"
            class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
            placeholder="Ej. Repuestos ventiladores granja 3"
            value="{{ initial.summary|default:'' }}"
          >
          {% if field_errors.summary %}
            <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.summary.0 }}</p>
          {% endif %}
        </label>
        <div class="grid gap-4 lg:grid-cols-2">
          <label class="text-xs font-semibold text-slate-500 block">
            Proveedor
            <select name="supplier" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm">
              <option value="">Selecciona un tercero</option>
              {% for supplier in form.suppliers %}
                <option value="{{ supplier.id }}" {% if supplier.id == initial.supplier_id %}selected{% endif %}>
                  {{ supplier.name }}
                </option>
              {% endfor %}
            </select>
            {% if field_errors.supplier %}
              <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.supplier.0 }}</p>
            {% endif %}
            {% if not form.suppliers %}
              <p class="mt-1 text-[11px] text-slate-500">Registra proveedores en la pestaña de administración antes de crear solicitudes.</p>
            {% endif %}
          </label>
          <label class="text-xs font-semibold text-slate-500 block">
            Categoría
            <select
              name="expense_type"
              class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
              data-category-select
            >
              <option value="">Selecciona una categoría</option>
              {% for category in form.categories %}
                <option
                  value="{{ category.id }}"
                  data-scope="{{ category.scope }}"
                  data-scope-label="{{ category.scope_label }}"
                  data-unit="{{ category.unit }}"
                  data-support-type-id="{{ category.support_type_id|default:'' }}"
                  {% if category.id == initial.expense_type_id %}selected{% endif %}
                >
                  {{ category.name }}
                </option>
              {% endfor %}
            </select>
            {% if field_errors.expense_type %}
              <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.expense_type.0 }}</p>
            {% endif %}
            {% if not form.categories %}
              <p class="mt-1 text-[11px] text-slate-500">Activa categorías en la configuración para habilitar este listado.</p>
            {% endif %}
          </label>
        </div>
        <label class="text-xs font-semibold text-slate-500 block">
          Tipo de soporte
          <select
            name="support_document_type"
            class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
            data-support-type-select
          >
            <option value="">Selecciona el tipo de soporte</option>
            {% for option in form.support_types %}
              <option value="{{ option.id }}" {% if option.id == initial.support_document_type_id %}selected{% endif %}>
                {{ option.name }} · {{ option.kind }}
              </option>
            {% endfor %}
          </select>
          {% if field_errors.support_document_type %}
            <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.support_document_type.0 }}</p>
          {% endif %}
          <p class="mt-1 text-[11px] text-slate-500">Se usará al momento de generar el soporte contable.</p>
          {% if not form.support_types %}
            <p class="mt-1 text-[11px] text-amber-600">Configura tipos de soporte en la pestaña de administración.</p>
          {% endif %}
        </label>
        <div class="space-y-3 rounded-2xl border border-dashed border-slate-300 p-4" data-scope-fields data-active-scope="{{ scope_code }}" data-scope-label="{{ form.scope_label|default:'' }}">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Ámbito de la categoría</p>
            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600" data-scope-pill>
              {% if scope_code %}
                {{ form.scope_label|default:"Ubicación general" }}
              {% else %}
                Selecciona una categoría
              {% endif %}
            </span>
          </div>
          <div class="grid gap-4 md:grid-cols-3">
            <label class="text-xs font-semibold text-slate-500 block" data-scope-field="farm" {% if not scope_code or scope_code == 'company' %}hidden{% endif %}>
              Granja
              <select
                name="scope_farm_id"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
                data-scope-farm
              >
                <option value="">General</option>
                {% for farm in form.farms %}
                  <option value="{{ farm.id }}" {% if farm.id == scope.farm_id %}selected{% endif %}>{{ farm.name }}</option>
                {% endfor %}
              </select>
              {% if field_errors.scope_farm_id %}
                <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.scope_farm_id.0 }}</p>
              {% endif %}
            </label>
            <label class="text-xs font-semibold text-slate-500 block" data-scope-field="house" {% if scope_code != 'house' %}hidden{% endif %}>
              Galpón
              <select
                name="scope_chicken_house_id"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
                data-scope-house
              >
                <option value="">General</option>
                {% for house in form.chicken_houses %}
                  <option
                    value="{{ house.id }}"
                    data-farm="{{ house.farm_id }}"
                    {% if house.id == scope.chicken_house_id %}selected{% endif %}
                  >
                    {{ house.name }}
                  </option>
                {% endfor %}
              </select>
              {% if field_errors.scope_chicken_house_id %}
                <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.scope_chicken_house_id.0 }}</p>
              {% endif %}
            </label>
            <label class="text-xs font-semibold text-slate-500 block" data-scope-field="batch" {% if scope_code != 'lot' %}hidden{% endif %}>
              Lote
              <input
                type="text"
                name="scope_batch_code"
                value="{{ scope.batch_code|default:'' }}"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
                placeholder="Ej. Q4-2025"
                data-scope-batch
              >
              {% if field_errors.scope_batch_code %}
                <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.scope_batch_code.0 }}</p>
              {% endif %}
            </label>
          </div>
          <p class="text-[11px] text-slate-500" data-scope-empty {% if scope_code %}hidden{% endif %}>
            Elige una categoría con ámbito de ubicación para habilitar estos campos.
          </p>
          <p class="text-[11px] text-slate-500" data-scope-helper {% if not scope_code %}hidden{% endif %}>
            Los valores predeterminados aplican a toda la solicitud.
          </p>
        </div>
      </div>
    </article>
    {% endwith %}

    <article class="space-y-4 rounded-2xl border border-slate-200 p-5 w-full">
      <header class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Detalle</p>
          <h2 class="text-lg font-semibold text-slate-900">Items de la solicitud</h2>
        </div>
        <button
          type="button"
          class="rounded-full border border-slate-200 px-4 py-1.5 text-xs font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-50"
          data-add-item
          {% if form.read_only %}disabled{% endif %}
        >
          Agregar item
        </button>
      </header>
      {% if field_errors.items %}
        <p class="text-[11px] font-semibold text-red-600">{{ field_errors.items.0 }}</p>
      {% endif %}
      <div class="space-y-4" data-purchase-items-root>
        {% for item in form.items %}
          {% with row_errors=item_errors|dict_get:forloop.counter0 %}
          <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm" data-item-row data-index="{{ forloop.counter0 }}">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
              <label class="text-xs font-semibold text-slate-500 flex-1">
                Descripción
                <textarea
                  name="items[{{ forloop.counter0 }}][description]"
                  data-field="description"
                  rows="2"
                  class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
                  placeholder="Describe el item"
                >{{ item.description|default:'' }}</textarea>
                <input type="hidden" name="items[{{ forloop.counter0 }}][id]" data-field="id" value="{{ item.id|default:'' }}">
                {% if row_errors.description %}
                  <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.description.0 }}</p>
                {% endif %}
              </label>
              <button
                type="button"
                class="self-start rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-30"
                data-remove-item
                {% if form.read_only %}disabled{% endif %}
              >
                Quitar
              </button>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <label class="text-xs font-semibold text-slate-500 block">
                Cantidad
                <div class="mt-1 flex items-center gap-2">
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    name="items[{{ forloop.counter0 }}][quantity]"
                    data-field="quantity"
                    value="{{ item.quantity|default:'' }}"
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
                    placeholder="0"
                  >
                  <span class="rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600" data-unit-chip>
                    {{ form.unit_label }}
                  </span>
                </div>
                {% if row_errors.quantity %}
                  <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.quantity.0 }}</p>
                {% endif %}
              </label>
              <label class="text-xs font-semibold text-slate-500 block">
                Valor
                <input
                  type="number"
                  step="0.01"
                  min="0"
                  name="items[{{ forloop.counter0 }}][estimated_amount]"
                  data-field="estimated_amount"
                  value="{{ item.estimated_amount|default:'' }}"
                  class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm text-right"
                  placeholder="0"
                >
                {% if row_errors.estimated_amount %}
                  <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.estimated_amount.0 }}</p>
                {% endif %}
              </label>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
      <p class="text-xs text-slate-500">Los valores se recalculan automáticamente cuando editas los montos de los items.</p>
    </article>

    <article class="grid gap-4 rounded-2xl border border-slate-200 bg-slate-50/60 p-5 lg:grid-cols-2 w-full">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Notas internas</p>
        <textarea
          name="notes"
          rows="4"
          class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
          placeholder="Contexto adicional para el aprobador"
        >{{ form.initial.notes|default:'' }}</textarea>
      </div>
      <dl class="space-y-3 text-sm">
        <div class="flex items-center justify-between border-t border-dashed border-slate-200 pt-3">
          <dt class="text-base font-semibold text-slate-900">Total estimado</dt>
          <dd class="text-base font-semibold text-slate-900" data-purchase-total>{{ form.initial.estimated_total|default:"0" }}</dd>
        </div>
      </dl>
    </article>
  </fieldset>

  <div class="mt-4 flex flex-wrap items-center justify-between gap-3 border-t border-slate-200 pt-4">
    <a href="?scope={{ purchases_scope.code }}" class="text-sm font-medium text-slate-500 hover:text-slate-900">Cancelar</a>
    <div class="flex gap-3">
      <button
        type="submit"
        name="intent"
        value="save_draft"
        class="rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-50"
        {% if form.read_only %}disabled{% endif %}
      >
        Guardar borrador
      </button>
      <button
        type="submit"
        name="intent"
        value="send_workflow"
        class="rounded-full bg-brand px-5 py-2 text-sm font-semibold text-white hover:bg-brand/90 disabled:cursor-not-allowed disabled:opacity-60"
        {% if form.read_only %}disabled{% endif %}
      >
        Enviar a aprobación
      </button>
    </div>
  </div>
</section>

<template id="purchase-item-row-template">
  <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm" data-item-row>
    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
      <label class="text-xs font-semibold text-slate-500 flex-1">
        Descripción
        <textarea
          name=""
          data-field="description"
          rows="2"
          class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
          placeholder="Describe el item"
        ></textarea>
        <input type="hidden" name="" data-field="id" value="">
      </label>
      <button type="button" class="self-start rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-900" data-remove-item>
        Quitar
      </button>
    </div>
    <div class="grid gap-4 sm:grid-cols-2">
      <label class="text-xs font-semibold text-slate-500 block">
        Cantidad
        <div class="mt-1 flex items-center gap-2">
          <input
            type="number"
            step="0.01"
            min="0"
            name=""
            data-field="quantity"
            value=""
            class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"
            placeholder="0"
          >
          <span class="rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600" data-unit-chip></span>
        </div>
      </label>
      <label class="text-xs font-semibold text-slate-500 block">
        Valor
        <input
          type="number"
          step="0.01"
          min="0"
          name=""
          data-field="estimated_amount"
          value=""
          class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm text-right"
          placeholder="0"
        >
      </label>
    </div>
  </div>
</template>

<script type="module" src="{% static 'administration/js/purchase-request-form.js' %}"></script>
{% endwith %}
