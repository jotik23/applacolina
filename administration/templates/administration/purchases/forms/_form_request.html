{% load static form_extras %}
{% with purchase=purchases_panel.purchase form=purchase_request_form field_errors=purchase_request_field_errors item_errors=purchase_request_item_errors %}
<section
  class="space-y-6 text-sm text-slate-700 w-full"
  data-purchase-request-form
  data-read-only="{{ form.read_only|yesno:'true,false' }}"
  data-unit-label="{{ form.unit_label|default:'Unidad' }}"
  data-supplier-create-url="{% url 'administration:purchases_supplier_quick_create' %}"
>
  {% if field_errors.non_field %}
    <div class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-xs font-medium text-red-700">
      {% for message in field_errors.non_field %}
        <p>{{ message }}</p>
      {% endfor %}
    </div>
  {% endif %}

  {% if form.read_only %}
    <div class="rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-xs font-semibold text-amber-800">
      Esta solicitud se encuentra en {{ purchase.get_status_display|default:"un estado no editable" }}. Los campos se muestran solo para consulta.
    </div>
    {% if form.can_reopen %}
      <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-dashed border-amber-200 bg-amber-50 px-4 py-3 text-[11px] text-amber-800">
        <p class="font-semibold">Si necesitas editarla, devuélvela a borrador y reinicia el flujo de aprobación.</p>
        <button
          type="submit"
          name="intent"
          value="reopen_request"
          class="inline-flex items-center gap-2 rounded-full border border-amber-300 bg-white px-4 py-1.5 text-xs font-semibold text-amber-800 hover:border-amber-400 hover:text-amber-900"
        >
          Modificar solicitud
        </button>
      </div>
    {% endif %}
  {% endif %}

  <fieldset class="space-y-6" {% if form.read_only %}disabled{% endif %}>
    {% with initial=form.initial scope=form.scope_values %}
    <article class="space-y-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-5 w-full">
      <header>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Resumen</p>
        <h2 class="text-lg font-semibold text-slate-900">Solicitud de compra</h2>
        <p class="text-xs text-slate-500">Completa los metadatos del gasto para habilitar el flujo.</p>
      </header>
      <div class="space-y-4">
        <div class="grid gap-4 lg:grid-cols-2">
          <label class="text-xs font-semibold text-slate-500 block">
            Nombre del requerimiento
            <input
              type="text"
              name="summary"
              class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
              placeholder="Ej. Repuestos ventiladores granja 3"
              value="{{ initial.summary|default:'' }}"
            >
            {% if field_errors.summary %}
              <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.summary.0 }}</p>
            {% endif %}
          </label>
          <label class="text-xs font-semibold text-slate-500 block">
            Categoría
            <select
              name="expense_type"
              class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
              data-category-select
            >
              <option value="">Selecciona una categoría</option>
              {% for category in form.categories %}
                <option
                  value="{{ category.id }}"
                  data-support-type-id="{{ category.support_type_id|default:'' }}"
                  {% if category.id == initial.expense_type_id %}selected{% endif %}
                >
                  {{ category.name }}
                </option>
              {% endfor %}
            </select>
            {% if field_errors.expense_type %}
              <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.expense_type.0 }}</p>
            {% endif %}
            {% if not form.categories %}
              <p class="mt-1 text-[11px] text-slate-500">Activa categorías en la configuración para habilitar este listado.</p>
            {% endif %}
          </label>
        </div>
        <label class="text-xs font-semibold text-slate-500 block">
          Proveedor
          <select
            name="supplier"
            class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm"
            data-supplier-select
          >
            <option value="">Selecciona un tercero</option>
            {% for supplier in form.suppliers %}
              <option value="{{ supplier.id }}" {% if supplier.id == initial.supplier_id %}selected{% endif %}>
                {{ supplier.name }}
              </option>
            {% endfor %}
          </select>
          {% if field_errors.supplier %}
            <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.supplier.0 }}</p>
          {% endif %}
          {% if not form.suppliers %}
            <p class="mt-1 text-[11px] text-slate-500">Registra proveedores en la pestaña de administración antes de crear solicitudes.</p>
          {% endif %}
        </label>
        {% if not form.read_only %}
            <details
              class="lg:col-span-2 rounded-2xl border border-emerald-200 bg-emerald-50/70 p-4 text-xs text-slate-600 shadow-sm"
              data-new-supplier-panel
            >
              <summary
                class="flex cursor-pointer items-center justify-between gap-4 text-sm font-semibold text-emerald-700"
                data-new-supplier-toggle
              >
                <span class="inline-flex items-center gap-2">
                  <span class="inline-flex size-6 items-center justify-center rounded-full bg-white text-base leading-none text-emerald-600">＋</span>
                  Registrar nuevo tercero
                </span>
                <span class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600">Sin salir de este formulario</span>
              </summary>
              <div class="mt-4 space-y-4">
                <header class="flex items-start justify-between gap-4">
                  <div>
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600">Nuevo tercero</p>
                    <p class="text-sm font-semibold text-slate-900">Registra datos básicos para continuar.</p>
                  </div>
                  <button
                    type="button"
                    class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700 hover:text-emerald-900"
                    data-new-supplier-cancel
                  >
                    Cerrar
                  </button>
                </header>
                <div class="space-y-4" data-new-supplier-form>
                  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" data-new-supplier-field>
                  <div class="grid gap-3 lg:grid-cols-2">
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Nombre / Razón social
                      <input
                        type="text"
                        name="name"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="Ej. Servicios Integrales SAS"
                      >
                    </label>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      NIT / CC
                      <input
                        type="text"
                        name="tax_id"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="900123456-7"
                      >
                    </label>
                  </div>
                  <div class="grid gap-3 lg:grid-cols-2">
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Contacto
                      <input
                        type="text"
                        name="contact_name"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="Nombre del contacto"
                      >
                    </label>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Correo
                      <input
                        type="email"
                        name="contact_email"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="contacto@email.com"
                      >
                    </label>
                  </div>
                  <div class="grid gap-3 lg:grid-cols-2">
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Teléfono
                      <input
                        type="text"
                        name="contact_phone"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="+57 300 000 0000"
                      >
                    </label>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Ciudad
                      <input
                        type="text"
                        name="city"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="Bogotá"
                      >
                    </label>
                  </div>
                  <div class="space-y-2 rounded-xl border border-emerald-100 bg-white/70 p-3">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Datos bancarios</p>
                    <div class="grid gap-3 lg:grid-cols-2">
                      <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        Identificación titular
                        <input
                          type="text"
                          name="account_holder_id"
                          data-new-supplier-field
                          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                          placeholder="CC/NIT titular"
                        >
                      </label>
                      <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        Nombre titular
                        <input
                          type="text"
                          name="account_holder_name"
                          data-new-supplier-field
                          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                          placeholder="Nombre del titular"
                        >
                      </label>
                    </div>
                    <div class="grid gap-3 lg:grid-cols-2">
                      <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        Tipo de cuenta
                        <select
                          name="account_type"
                          data-new-supplier-field
                          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                        >
                          <option value="">Selecciona el tipo</option>
                          <option value="ahorros">Ahorros</option>
                          <option value="corriente">Corriente</option>
                        </select>
                      </label>
                      <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        Número de cuenta
                        <input
                          type="text"
                          name="account_number"
                          data-new-supplier-field
                          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                          placeholder="000123456789"
                        >
                      </label>
                    </div>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Banco
                      <input
                        type="text"
                        name="bank_name"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="Banco"
                      >
                    </label>
                  </div>
                  <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                    Dirección
                    <input
                      type="text"
                      name="address"
                      data-new-supplier-field
                      class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                      placeholder="Calle 123 #45-67"
                    >
                  </label>
                  <div
                    class="rounded-xl border border-white/70 bg-white/80 px-3 py-2 text-[11px] font-semibold"
                    data-new-supplier-feedback
                    hidden
                  ></div>
                  <div class="flex flex-wrap items-center gap-3">
                    <button
                      type="button"
                      class="inline-flex items-center justify-center rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-700 disabled:opacity-60"
                      data-new-supplier-submit
                    >
                      Guardar y usar
                    </button>
                    <button
                      type="button"
                      class="text-sm font-semibold text-emerald-700 underline decoration-dotted underline-offset-4 hover:text-emerald-900"
                      data-new-supplier-reset
                    >
                      Limpiar campos
                    </button>
                  </div>
                </div>
              </div>
            </details>
          {% endif %}
        </div>
        <input type="hidden" name="scope_farm_id" value="{{ scope.farm_id|default:'' }}">
        <input type="hidden" name="scope_batch_code" value="{{ scope.batch_code|default:'' }}">
        <input type="hidden" name="scope_chicken_house_id" value="{{ scope.chicken_house_id|default:'' }}">
    </article>
    {% endwith %}

    <article class="space-y-4 rounded-2xl border border-slate-200 p-5 w-full xl:p-6">
      <header class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Detalle</p>
          <h2 class="text-lg font-semibold text-slate-900">Items de la solicitud</h2>
        </div>
        <button
          type="button"
          class="rounded-full border border-slate-200 px-4 py-1.5 text-xs font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-50"
          data-add-item
          {% if form.read_only %}disabled{% endif %}
        >
          Agregar item
        </button>
      </header>
      {% if field_errors.items %}
        <p class="text-[11px] font-semibold text-red-600">{{ field_errors.items.0 }}</p>
      {% endif %}
      <div class="overflow-x-auto rounded-2xl border border-slate-200" data-purchase-items-table>
        <table class="min-w-full divide-y divide-slate-200 text-xs">
          <thead class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
            <tr>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Item</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Cantidad</th>
              <th scope="col" class="px-3 py-2 text-center font-semibold">Unidad</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold">Valor</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold">Subtotal</th>
              <th scope="col" class="px-3 py-2 text-center font-semibold">Acción</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white" data-purchase-items-root>
            {% for item in form.items %}
              {% with row_errors=item_errors|dict_get:forloop.counter0 %}
              <tr data-item-row data-index="{{ forloop.counter0 }}">
                <td class="px-3 py-2 align-middle">
                  <div class="flex flex-col">
                    <input
                      type="text"
                      name="items[{{ forloop.counter0 }}][description]"
                      data-field="description"
                      value="{{ item.description|default:'' }}"
                      class="w-full rounded-lg border border-slate-200 px-3 py-1.5 text-xs shadow-sm focus:border-slate-400 focus:outline-none"
                      placeholder="Describe el item"
                      aria-label="Descripción del item"
                    >
                    <input type="hidden" name="items[{{ forloop.counter0 }}][id]" data-field="id" value="{{ item.id|default:'' }}">
                    {% if row_errors.description %}
                      <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.description.0 }}</p>
                    {% endif %}
                  </div>
                </td>
                <td class="px-3 py-2 align-middle">
                  <div class="flex flex-col">
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      max="99999"
                      name="items[{{ forloop.counter0 }}][quantity]"
                      data-field="quantity"
                      value="{{ item.quantity|default:'' }}"
                      class="w-24 rounded-lg border border-slate-200 px-2 py-1.5 text-center text-xs shadow-sm focus:border-slate-400 focus:outline-none"
                      placeholder="0"
                      aria-label="Cantidad"
                    >
                    {% if row_errors.quantity %}
                      <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.quantity.0 }}</p>
                    {% endif %}
                  </div>
                </td>
                <td class="px-3 py-2 text-center align-middle">
                  <span class="inline-flex min-w-[4rem] justify-center rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600" data-unit-chip>
                    {{ form.unit_label }}
                  </span>
                </td>
                <td class="px-3 py-2 align-middle">
                  <div class="flex flex-col">
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      name="items[{{ forloop.counter0 }}][estimated_amount]"
                      data-field="estimated_amount"
                      value="{{ item.estimated_amount|default:'' }}"
                      class="w-32 rounded-lg border border-slate-200 px-2 py-1.5 text-right text-xs shadow-sm focus:border-slate-400 focus:outline-none"
                      placeholder="0"
                      aria-label="Valor unitario"
                    >
                    {% if row_errors.estimated_amount %}
                      <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.estimated_amount.0 }}</p>
                    {% endif %}
                  </div>
                </td>
                <td class="align-top px-3 py-2">
                  <p class="text-right text-sm font-semibold text-slate-900" data-item-subtotal>
                    {{ item.quantity|default:0|multiply:item.estimated_amount|floatformat:2 }}
                  </p>
                </td>
                <td class="align-top px-3 py-2 text-center">
                  <button
                    type="button"
                    class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-30"
                    data-remove-item
                    {% if form.read_only %}disabled{% endif %}
                  >
                    Quitar
                  </button>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500">Los valores y subtotales se recalculan automáticamente al editar los items.</p>
      <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-900">
        <span>Total estimado</span>
        <span data-purchase-total>{{ form.initial.estimated_total|default:"0" }}</span>
      </div>
    </article>
  </fieldset>

  <div class="mt-4 flex flex-wrap items-center justify-between gap-3 border-t border-slate-200 pt-4">
    <a href="?scope={{ purchases_scope.code }}" class="text-sm font-medium text-slate-500 hover:text-slate-900">Cancelar</a>
    <div class="flex gap-3">
      <button
        type="submit"
        name="intent"
        value="save_draft"
        class="rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-50"
        {% if form.read_only %}disabled{% endif %}
      >
        Guardar borrador
      </button>
      <button
        type="submit"
        name="intent"
        value="send_workflow"
        class="rounded-full bg-brand px-5 py-2 text-sm font-semibold text-white hover:bg-brand/90 disabled:cursor-not-allowed disabled:opacity-60"
        {% if form.read_only %}disabled{% endif %}
      >
        Enviar a aprobación
      </button>
    </div>
  </div>
</section>

<template id="purchase-item-row-template">
  <tr data-item-row>
    <td class="px-3 py-2 align-middle">
      <div class="flex flex-col">
        <input
          type="text"
          name=""
          data-field="description"
          class="w-full rounded-lg border border-slate-200 px-3 py-1.5 text-xs shadow-sm focus:border-slate-400 focus:outline-none"
          placeholder="Describe el item"
          aria-label="Descripción del item"
        >
        <input type="hidden" name="" data-field="id" value="">
      </div>
    </td>
    <td class="px-3 py-2 align-middle">
      <div class="flex flex-col">
        <input
          type="number"
          step="0.01"
          min="0"
          max="99999"
          name=""
          data-field="quantity"
          value=""
          class="w-24 rounded-lg border border-slate-200 px-2 py-1.5 text-center text-xs shadow-sm focus:border-slate-400 focus:outline-none"
          placeholder="0"
          aria-label="Cantidad"
        >
      </div>
    </td>
    <td class="px-3 py-2 text-center align-middle">
      <span class="inline-flex min-w-[4rem] justify-center rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600" data-unit-chip></span>
    </td>
    <td class="px-3 py-2 align-middle">
      <div class="flex flex-col">
        <input
          type="number"
          step="0.01"
          min="0"
          name=""
          data-field="estimated_amount"
          value=""
          class="w-32 rounded-lg border border-slate-200 px-2 py-1.5 text-right text-xs shadow-sm focus:border-slate-400 focus:outline-none"
          placeholder="0"
          aria-label="Valor unitario"
        >
      </div>
    </td>
    <td class="align-top px-3 py-2">
      <p class="text-right text-sm font-semibold text-slate-900" data-item-subtotal>0</p>
    </td>
    <td class="align-top px-3 py-2 text-center">
      <button
        type="button"
        class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-900"
        data-remove-item
      >
        Quitar
      </button>
    </td>
  </tr>
</template>

<script type="module" src="{% static 'administration/js/purchase-request-form.js' %}"></script>
{% endwith %}
