{% load static form_extras %}
{% with purchase=purchases_panel.purchase form=purchase_request_form field_errors=purchase_request_field_errors item_errors=purchase_request_item_errors %}
<section
  class="space-y-6 text-sm text-slate-700 w-full"
  data-purchase-request-form
  data-read-only="{{ form.read_only|yesno:'true,false' }}"
  data-supplier-create-url="{% url 'administration:purchases_supplier_quick_create' %}"
>
{% if form.products %}
  {{ form.products|json_script:"purchase-products-data" }}
{% else %}
  <script id="purchase-products-data" type="application/json">[]</script>
{% endif %}
  {% if field_errors.non_field %}
    <div class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-xs font-medium text-red-700">
      {% for message in field_errors.non_field %}
        <p>{{ message }}</p>
      {% endfor %}
    </div>
  {% endif %}

  {% if form.read_only %}
    {% if form.can_reopen %}
      <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-dashed border-amber-200 bg-amber-50 px-4 py-3 text-[11px] text-amber-800">
        <p class="font-semibold">Si necesitas editarla, devuélvela a borrador y reinicia el flujo de aprobación.</p>
        <button
          type="submit"
          name="intent"
          value="reopen_request"
          class="inline-flex items-center gap-2 rounded-full border border-amber-300 bg-white px-4 py-1.5 text-xs font-semibold text-amber-800 hover:border-amber-400 hover:text-amber-900"
        >
          Modificar solicitud
        </button>
      </div>
    {% endif %}
  {% endif %}

  {% if form.rejection_alert %}
    <div class="space-y-3 rounded-2xl border border-red-200 bg-red-50 px-4 py-4 text-red-900">
      <p class="text-[11px] font-semibold uppercase tracking-wide text-red-600">Solicitud rechazada</p>
      <p class="text-sm">
        La solicitud fue rechazada por
        <span class="font-semibold text-red-800">{{ form.rejection_alert.role|default:"un aprobador" }}</span>
        y regresó a estado <span class="font-semibold">Borrador</span>.
      </p>
      {% if form.rejection_alert.note %}
        <div class="rounded-xl border border-red-200 bg-white/80 px-3 py-2 text-sm text-red-800">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-red-500">Nota registrada</p>
          <p class="mt-1">{{ form.rejection_alert.note }}</p>
        </div>
      {% endif %}
    </div>
  {% endif %}

  {% if form.purchase and form.purchase.latest_approval_note and form.purchase.status != 'borrador' %}
    <div class="rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-4 text-emerald-900">
      <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Nota de aprobación</p>
      <p class="mt-1 text-sm">{{ form.purchase.latest_approval_note }}</p>
    </div>
  {% endif %}

  {% if form.pending_approval %}
    <div class="space-y-4 rounded-2xl border border-emerald-200 bg-emerald-50/80 px-4 py-5 text-emerald-900">
      <div class="flex flex-col gap-1">
        <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Aprobación pendiente</p>
        <p class="text-sm">
          Te corresponde aprobar esta solicitud como
          <span class="font-semibold text-emerald-900">{{ form.pending_approval.role }}</span>.
          Registra tu decisión y agrega una nota si aplica.
        </p>
      </div>
      <label class="block text-xs font-semibold text-emerald-800">
        Gestor asignado
        <select
          name="assigned_manager"
          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm text-emerald-900 shadow-sm focus:border-emerald-400 focus:outline-none"
          {% if not form.manager_is_editable %}disabled{% endif %}
        >
          <option value="">Selecciona un gestor</option>
          {% for manager in form.manager_options %}
            <option value="{{ manager.id }}" {% if manager.id == form.initial.assigned_manager_id %}selected{% endif %}>
              {{ manager.name }}
            </option>
          {% endfor %}
        </select>
        {% if purchase_request_field_errors.assigned_manager %}
          <p class="mt-1 text-[11px] font-semibold text-red-600">{{ purchase_request_field_errors.assigned_manager.0 }}</p>
        {% endif %}
      </label>
      <label class="block text-xs font-semibold text-emerald-800">
        Nota (opcional)
        <textarea
          name="approval_note"
          rows="2"
          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm text-emerald-900 shadow-sm focus:border-emerald-400 focus:outline-none"
          placeholder="Comentarios para el solicitante"
        >{{ form.approval_note|default:'' }}</textarea>
      </label>
      <div class="flex flex-wrap gap-3">
        <button
          type="submit"
          name="intent"
          value="reject_request"
          class="inline-flex items-center justify-center rounded-full border border-red-200 px-5 py-2 text-sm font-semibold text-red-700 transition hover:border-red-300 hover:text-red-800"
        >
          Rechazar solicitud
        </button>
        <button
          type="submit"
          name="intent"
          value="approve_request"
          class="inline-flex items-center justify-center rounded-full bg-emerald-600 px-5 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700"
        >
          Aprobar solicitud
        </button>
      </div>
    </div>
  {% endif %}

  <fieldset class="space-y-6" {% if form.read_only %}disabled{% endif %}>
    {% with initial=form.initial scope=form.scope_values %}
    <article class="space-y-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-5 w-full">
      <header>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Resumen</p>
        <h2 class="text-lg font-semibold text-slate-900">Solicitud de compra</h2>
      </header>
      <div class="space-y-4">
        <div class="grid gap-4 lg:grid-cols-2">
          <label class="text-xs font-semibold text-slate-500 block">
            Nombre del requerimiento
            <input
              type="text"
              name="summary"
              class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-[14px] text-sm shadow-sm"
              placeholder="Ej. Repuestos ventiladores granja 3"
              value="{{ initial.summary|default:'' }}"
            >
            {% if field_errors.summary %}
              <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.summary.0 }}</p>
            {% endif %}
          </label>
          <div class="text-xs font-semibold text-slate-500">
            <span>Categoría</span>
            {% with picker=form.category_picker %}
              {% if picker.groups %}
                <div class="relative mt-1" data-select-picker data-select-placeholder="{{ picker.placeholder }}">
                  <input type="hidden" value="{{ picker.selected_value }}" data-select-input>
                  <div class="flex items-stretch gap-2">
                    <button
                      type="button"
                      class="flex h-full min-h-[3rem] w-full items-center justify-between gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-left text-sm font-semibold text-slate-600 shadow-sm focus:border-slate-400 focus:outline-none"
                      data-select-trigger
                      aria-haspopup="listbox"
                      aria-expanded="false"
                    >
                      <span class="flex flex-wrap items-center gap-2 text-left">
                        <span class="text-sm font-semibold text-slate-800" data-select-label>{{ picker.selected_label }}</span>
                        <span class="text-[11px] font-normal text-slate-500 {% if not picker.selected_description %}hidden{% endif %}" data-select-description>{{ picker.selected_description }}</span>
                      </span>
                      <svg class="h-4 w-4 text-slate-400 transition-transform duration-150" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-select-chevron>
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.21l3.71-3.98a.75.75 0 111.08 1.04l-4.24 4.54a.75.75 0 01-1.08 0L5.21 9.31a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                      </svg>
                    </button>
                    <button
                      type="button"
                      class="inline-flex items-center justify-center rounded-full border border-slate-200 px-2 text-xs font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-900 {% if not picker.selected_value %}hidden{% endif %}"
                      data-select-clear
                      aria-label="Limpiar selección"
                    >
                      &times;
                    </button>
                  </div>
                  <div class="absolute left-0 right-0 z-30 mt-2 hidden rounded-2xl border border-slate-200 bg-white shadow-xl" data-select-panel>
                    {% if picker.search_enabled %}
                      <div class="border-b border-slate-100 p-2">
                        <label class="flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 text-xs text-slate-500 focus-within:border-slate-400">
                          <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 014.384 8.776l3.17 3.17a.75.75 0 11-1.06 1.06l-3.17-3.17A5.5 5.5 0 119 3.5zm0 1.5a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" /></svg>
                          <input type="search" class="w-full border-none bg-transparent text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none" placeholder="Buscar categoría" data-select-search>
                        </label>
                      </div>
                    {% endif %}
                    <div class="max-h-64 overflow-y-auto py-2" data-select-list>
                      {% for group in picker.groups %}
                        <div class="py-1" data-select-group data-group-label="{{ group.label }}">
                          <p class="px-3 text-[11px] font-semibold uppercase tracking-wide text-slate-500">{{ group.label }}</p>
                          <ul class="mt-1 space-y-1">
                            {% for option in group.options %}
                              <li>
                                <button
                                  type="button"
                                  class="select-option-button flex w-full flex-col rounded-xl px-3 py-2 text-left text-sm font-semibold text-slate-600 hover:bg-slate-50"
                                  data-select-option
                                  data-value="{{ option.value }}"
                                  data-label="{{ option.label }}"
                                  data-description="{{ option.description }}"
                                  data-search-text="{{ option.search_text }}"
                                  {% if option.data_attrs %}
                                    {% for attr_key, attr_value in option.data_attrs.items %}
                                      data-{{ attr_key }}="{{ attr_value }}"
                                    {% endfor %}
                                  {% endif %}
                                  {% if option.value == picker.selected_value %}data-selected="true"{% endif %}
                                >
                                  <span>{{ option.label }}</span>
                                  {% if option.description %}
                                    <span class="text-[11px] font-normal text-slate-500">{{ option.description }}</span>
                                  {% endif %}
                                </button>
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% endfor %}
                      <div class="px-3 py-2 text-[11px] font-semibold text-slate-500 hidden" data-select-empty>Sin coincidencias.</div>
                    </div>
                  </div>
                  <select
                    name="{{ picker.name }}"
                    class="hidden"
                    data-native-select
                    data-category-select
                    aria-hidden="true"
                    tabindex="-1"
                  >
                    <option value="">{{ picker.placeholder }}</option>
                    {% for category in form.categories %}
                      <option
                        value="{{ category.id }}"
                        data-support-type-id="{{ category.support_type_id|default:'' }}"
                        {% if category.id == initial.expense_type_id %}selected{% endif %}
                      >
                        {{ category.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              {% else %}
                <div class="mt-1 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-500">Activa categorías en la configuración para habilitar este listado.</div>
              {% endif %}
            {% endwith %}
            {% if field_errors.expense_type %}
              <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.expense_type.0 }}</p>
            {% endif %}
          </div>
          <label class="text-xs font-semibold text-slate-500 block">
            Fecha de solicitud
            <input
              type="date"
              name="requested_date"
              class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-[14px] text-sm shadow-sm"
              value="{{ initial.requested_date|default:'' }}"
            >
            {% if field_errors.requested_date %}
              <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.requested_date.0 }}</p>
            {% endif %}
          </label>
        </div>
        <div class="grid gap-4 lg:grid-cols-2 items-stretch">
          <div class="text-xs font-semibold text-slate-500 flex flex-col h-full">
            <span>Proveedor</span>
            {% with picker=form.supplier_picker %}
              {% if picker.groups %}
                <div class="relative mt-1 flex-1" data-select-picker data-select-placeholder="{{ picker.placeholder }}">
                  <input type="hidden" value="{{ picker.selected_value }}" data-select-input>
                  <div class="flex items-stretch gap-2">
                    <button
                      type="button"
                      class="flex h-full min-h-[3rem] w-full items-center justify-between gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-left text-sm font-semibold text-slate-600 shadow-sm focus:border-slate-400 focus:outline-none"
                      data-select-trigger
                      aria-haspopup="listbox"
                      aria-expanded="false"
                    >
                      <span class="flex flex-wrap items-center gap-2 text-left">
                        <span class="text-sm font-semibold text-slate-800" data-select-label>{{ picker.selected_label }}</span>
                        <span class="text-[11px] font-normal text-slate-500 {% if not picker.selected_description %}hidden{% endif %}" data-select-description>{{ picker.selected_description }}</span>
                      </span>
                      <svg class="h-4 w-4 text-slate-400 transition-transform duration-150" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-select-chevron>
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.21l3.71-3.98a.75.75 0 111.08 1.04l-4.24 4.54a.75.75 0 01-1.08 0L5.21 9.31a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                      </svg>
                    </button>
                    <button
                      type="button"
                      class="inline-flex items-center justify-center rounded-full border border-slate-200 px-2 text-xs font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-900 {% if not picker.selected_value %}hidden{% endif %}"
                      data-select-clear
                      aria-label="Limpiar selección"
                    >
                      &times;
                    </button>
                  </div>
                <div class="absolute left-0 right-0 z-30 mt-2 hidden rounded-2xl border border-slate-200 bg-white shadow-xl" data-select-panel>
                  {% if picker.search_enabled %}
                    <div class="border-b border-slate-100 p-2">
                      <label class="flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 text-xs text-slate-500 focus-within:border-slate-400">
                        <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 014.384 8.776l3.17 3.17a.75.75 0 11-1.06 1.06l-3.17-3.17A5.5 5.5 0 119 3.5zm0 1.5a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" /></svg>
                        <input type="search" class="w-full border-none bg-transparent text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none" placeholder="Buscar proveedor" data-select-search>
                      </label>
                    </div>
                  {% endif %}
                  <div class="max-h-64 overflow-y-auto py-2" data-select-list>
                    {% for group in picker.groups %}
                      <div class="py-1" data-select-group data-group-label="{{ group.label }}">
                        <p class="px-3 text-[11px] font-semibold uppercase tracking-wide text-slate-500">{{ group.label }}</p>
                        <ul class="mt-1 space-y-1">
                          {% for option in group.options %}
                            <li>
                              <button
                                type="button"
                                class="select-option-button flex w-full flex-col rounded-xl px-3 py-2 text-left text-sm font-semibold text-slate-600 hover:bg-slate-50"
                              data-select-option
                              data-value="{{ option.value }}"
                              data-label="{{ option.label }}"
                              data-description="{{ option.description }}"
                              data-search-text="{{ option.search_text }}"
                              {% if option.data_attrs %}
                                {% for attr_key, attr_value in option.data_attrs.items %}
                                  data-{{ attr_key }}="{{ attr_value }}"
                                {% endfor %}
                              {% endif %}
                              {% if option.value == picker.selected_value %}data-selected="true"{% endif %}
                            >
                                <span>{{ option.label }}</span>
                              </button>
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endfor %}
                    <div class="px-3 py-2 text-[11px] font-semibold text-slate-500 hidden" data-select-empty>Sin coincidencias.</div>
                  </div>
                </div>
                <select
                  name="{{ picker.name }}"
                  class="hidden"
                  data-native-select
                  data-supplier-select
                  aria-hidden="true"
                  tabindex="-1"
                >
                  <option value="">{{ picker.placeholder }}</option>
                  {% for supplier in form.suppliers %}
                    <option value="{{ supplier.id }}" {% if supplier.id == initial.supplier_id %}selected{% endif %}>{{ supplier.name }}</option>
                  {% endfor %}
                </select>
              </div>
            {% else %}
              <div class="mt-1 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-500">Registra proveedores en la pestaña de administración antes de crear solicitudes.</div>
            {% endif %}
          {% endwith %}
          {% if field_errors.supplier %}
            <p class="mt-1 text-[11px] font-semibold text-red-600">{{ field_errors.supplier.0 }}</p>
          {% endif %}
        </div>
        {% if not form.pending_approval %}
        <label class="text-xs font-semibold text-slate-500 block">
          Gestor asignado
          <select
            name="assigned_manager"
            class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-slate-400 focus:outline-none"
            {% if not form.manager_is_editable %}disabled{% endif %}
          >
            <option value="">Selecciona un gestor</option>
            {% for manager in form.manager_options %}
              <option value="{{ manager.id }}" {% if manager.id == initial.assigned_manager_id %}selected{% endif %}>
                {{ manager.name }}
              </option>
            {% endfor %}
          </select>
          {% if purchase_request_field_errors.assigned_manager %}
            <p class="mt-1 text-[11px] font-semibold text-red-600">{{ purchase_request_field_errors.assigned_manager.0 }}</p>
          {% endif %}
        </label>
        {% endif %}
        </div>
        {% if not form.read_only %}
            <details
              class="lg:col-span-2 rounded-2xl border border-emerald-200 bg-emerald-50/70 p-4 text-xs text-slate-600 shadow-sm"
              data-new-supplier-panel
            >
              <summary
                class="flex cursor-pointer items-center justify-between gap-4 text-sm font-semibold text-emerald-700"
                data-new-supplier-toggle
              >
                <span class="inline-flex items-center gap-2">
                  <span class="inline-flex size-6 items-center justify-center rounded-full bg-white text-base leading-none text-emerald-600">＋</span>
                  Registrar nuevo tercero
                </span>
                <span class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600">Sin salir de este formulario</span>
              </summary>
              <div class="mt-4 space-y-4">
                <header class="flex items-start justify-between gap-4">
                  <div>
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600">Nuevo tercero</p>
                    <p class="text-sm font-semibold text-slate-900">Registra datos básicos para continuar.</p>
                  </div>
                  <button
                    type="button"
                    class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700 hover:text-emerald-900"
                    data-new-supplier-cancel
                  >
                    Cerrar
                  </button>
                </header>
                <div class="space-y-4" data-new-supplier-form>
                  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" data-new-supplier-field>
                  <div class="grid gap-3 lg:grid-cols-2">
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Nombre / Razón social
                      <input
                        type="text"
                        name="name"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="Ej. Servicios Integrales SAS"
                      >
                    </label>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      NIT / CC
                      <input
                        type="text"
                        name="tax_id"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="900123456-7"
                      >
                    </label>
                  </div>
                  <div class="grid gap-3 lg:grid-cols-2">
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Contacto
                      <input
                        type="text"
                        name="contact_name"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="Nombre del contacto"
                      >
                    </label>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Correo
                      <input
                        type="email"
                        name="contact_email"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="contacto@email.com"
                      >
                    </label>
                  </div>
                  <div class="grid gap-3 lg:grid-cols-2">
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Teléfono
                      <input
                        type="text"
                        name="contact_phone"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="+57 300 000 0000"
                      >
                    </label>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Ciudad
                      <input
                        type="text"
                        name="city"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="Bogotá"
                      >
                    </label>
                  </div>
                  <div class="space-y-2 rounded-xl border border-emerald-100 bg-white/70 p-3">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-700">Datos bancarios</p>
                    <div class="grid gap-3 lg:grid-cols-2">
                      <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        Identificación titular
                        <input
                          type="text"
                          name="account_holder_id"
                          data-new-supplier-field
                          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                          placeholder="CC/NIT titular"
                        >
                      </label>
                      <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        Nombre titular
                        <input
                          type="text"
                          name="account_holder_name"
                          data-new-supplier-field
                          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                          placeholder="Nombre del titular"
                        >
                      </label>
                    </div>
                    <div class="grid gap-3 lg:grid-cols-2">
                      <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        Tipo de cuenta
                        <select
                          name="account_type"
                          data-new-supplier-field
                          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                        >
                          <option value="">Selecciona el tipo</option>
                          <option value="ahorros">Ahorros</option>
                          <option value="corriente">Corriente</option>
                        </select>
                      </label>
                      <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        Número de cuenta
                        <input
                          type="text"
                          name="account_number"
                          data-new-supplier-field
                          class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                          placeholder="000123456789"
                        >
                      </label>
                    </div>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                      Banco
                      <input
                        type="text"
                        name="bank_name"
                        data-new-supplier-field
                        class="mt-1 w-full rounded-xl border border-emerald-200 bg-white px-3 py-2 text-sm shadow-sm"
                        placeholder="Banco"
                      >
                    </label>
                  </div>
                  <label class="block text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                    Dirección
                    <input
                      type="text"
                      name="address"
                      data-new-supplier-field
                      class="mt-1 w-full rounded-xl border border-white/60 bg-white px-3 py-2 text-sm shadow-sm"
                      placeholder="Calle 123 #45-67"
                    >
                  </label>
                  <div
                    class="rounded-xl border border-white/70 bg-white/80 px-3 py-2 text-[11px] font-semibold"
                    data-new-supplier-feedback
                    hidden
                  ></div>
                  <div class="flex flex-wrap items-center gap-3">
                    <button
                      type="button"
                      class="inline-flex items-center justify-center rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-700 disabled:opacity-60"
                      data-new-supplier-submit
                    >
                      Guardar y usar
                    </button>
                    <button
                      type="button"
                      class="text-sm font-semibold text-emerald-700 underline decoration-dotted underline-offset-4 hover:text-emerald-900"
                      data-new-supplier-reset
                    >
                      Limpiar campos
                    </button>
                  </div>
                </div>
              </div>
            </details>
          {% endif %}
        </div>
        <input type="hidden" name="scope_batch_code" value="{{ scope.batch_code|default:'' }}">

    </article>
    {% endwith %}

    <article class="space-y-4 rounded-2xl border border-slate-200 p-5 w-full xl:p-6">
      <header class="flex flex-col items-center justify-between gap-3 text-center sm:flex-row sm:text-left">
        <div class="flex-1 text-center sm:text-left">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Detalle</p>
          <h2 class="text-lg font-semibold text-slate-900">Items de la solicitud</h2>
        </div>
        <div class="sm:text-right">
          <button
            type="button"
            class="rounded-full border border-slate-200 px-4 py-1.5 text-xs font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-50"
            data-add-item
            {% if form.read_only %}disabled{% endif %}
          >
            Agregar item
          </button>
        </div>
      </header>
      {% if field_errors.items %}
        <p class="text-[11px] font-semibold text-red-600">{{ field_errors.items.0 }}</p>
      {% endif %}
      <div class="overflow-x-auto rounded-2xl border border-slate-200" data-purchase-items-table>
        <table class="min-w-full divide-y divide-slate-200 text-xs table-fixed">
          <colgroup>
            <col style="width:42%;">
            <col style="width:18%;">
            <col style="width:14%;">
            <col style="width:12%;">
            <col style="width:10%;">
            <col style="width:4%;">
          </colgroup>
          <thead class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
            <tr>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Item</th>
              <th scope="col" class="px-3 py-2 text-left font-semibold">Área</th>
              <th scope="col" class="px-3 py-2 text-center font-semibold">Cantidad</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold align-middle w-32">Valor</th>
              <th scope="col" class="px-3 py-2 text-right font-semibold">Subtotal</th>
              <th scope="col" class="px-3 py-2 text-center font-semibold">Acción</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white" data-purchase-items-root>
            {% for item in form.items %}
              {% with row_errors=item_errors|dict_get:forloop.counter0 %}
              <tr data-item-row data-index="{{ forloop.counter0 }}">
                <td class="px-3 py-2 align-middle">
                  <div class="flex flex-col gap-1">
                    <div class="relative" data-product-picker>
                      <input
                        type="text"
                        name="items[{{ forloop.counter0 }}][description]"
                        data-field="description"
                        data-product-input
                        value="{{ item.description|default:'' }}"
                        class="h-11 w-full rounded-lg border border-slate-200 px-3 pr-10 text-xs shadow-sm focus:border-slate-400 focus:outline-none"
                        placeholder="Describe el item"
                        autocomplete="off"
                        aria-label="Descripción del item"
                      >
                      <button
                        type="button"
                        class="absolute right-1.5 top-1/2 -translate-y-1/2 rounded-full border border-transparent bg-transparent p-2 text-slate-400 transition hover:text-slate-600 focus:border-slate-300 focus:outline-none"
                        data-product-toggle
                        aria-label="Mostrar productos"
                        {% if form.read_only %}disabled{% endif %}
                      >
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M5.22 7.22a.75.75 0 011.06 0L10 10.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 8.28a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                      </button>
                    </div>
                    <input type="hidden" name="items[{{ forloop.counter0 }}][id]" data-field="id" value="{{ item.id|default:'' }}">
                    <input type="hidden" name="items[{{ forloop.counter0 }}][product_id]" data-field="product_id" data-product-id-input value="{{ item.product_id|default:'' }}">
                    {% if row_errors.description %}
                      <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.description.0 }}</p>
                    {% endif %}
                  </div>
                </td>
                <td class="px-3 py-2 align-middle">
                  <div class="flex flex-col gap-1">
                    <select
                      name="items[{{ forloop.counter0 }}][scope_value]"
                      data-field="scope_value"
                      class="h-11 w-full rounded-lg border border-slate-200 px-3 text-xs shadow-sm focus:border-slate-400 focus:outline-none"
                    >
                      {% for group in form.area_option_groups %}
                        <optgroup label="{{ group.label }}">
                          {% for option in group.options %}
                            <option value="{{ option.value }}" {% if option.value == item.scope_value %}selected{% endif %}>
                              {{ option.label }}{% if option.description %} · {{ option.description }}{% endif %}
                            </option>
                          {% endfor %}
                        </optgroup>
                      {% endfor %}
                    </select>
                    {% if row_errors.scope %}
                      <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.scope.0 }}</p>
                    {% endif %}
                  </div>
                </td>
                <td class="px-3 py-2 align-middle">
                  <div class="flex flex-col gap-1">
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      max="99999"
                      name="items[{{ forloop.counter0 }}][quantity]"
                      data-field="quantity"
                      value="{{ item.quantity|default:'' }}"
                      class="h-11 w-24 rounded-lg border border-slate-200 px-3 text-center text-xs shadow-sm focus:border-slate-400 focus:outline-none"
                      placeholder="0"
                      aria-label="Cantidad"
                    >
                    {% if row_errors.quantity %}
                      <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.quantity.0 }}</p>
                    {% endif %}
                  </div>
                </td>
                <td class="px-3 py-2 text-center align-middle">
                  <div class="flex flex-col gap-1">
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      name="items[{{ forloop.counter0 }}][estimated_amount]"
                      data-field="estimated_amount"
                      value="{{ item.estimated_amount|default:'' }}"
                      class="h-11 w-32 rounded-lg border border-slate-200 px-3 text-right text-xs shadow-sm focus:border-slate-400 focus:outline-none"
                      placeholder="0"
                      aria-label="Valor unitario"
                    >
                    {% if row_errors.estimated_amount %}
                      <p class="mt-1 text-[11px] font-semibold text-red-600">{{ row_errors.estimated_amount.0 }}</p>
                    {% endif %}
                  </div>
                </td>
                <td class="align-top px-3 py-2">
                  <p class="text-right text-sm font-semibold text-slate-900" data-item-subtotal>
                    {{ item.quantity|default:0|multiply:item.estimated_amount|floatformat:2 }}
                  </p>
                </td>
                <td class="align-top px-3 py-2 text-center">
                  <button
                    type="button"
                    class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-30"
                    data-remove-item
                    {% if form.read_only %}disabled{% endif %}
                  >
                    Quitar
                  </button>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-900">
        <span>Total estimado</span>
        <span data-purchase-total>{{ form.initial.estimated_total|default:"0" }}</span>
      </div>
    </article>
  </fieldset>

  <div class="sticky bottom-0 left-0 right-0 z-10 mt-4 flex flex-wrap items-center justify-between gap-3 border-t border-slate-200 bg-white pt-4">
    <a href="?scope={{ purchases_scope.code }}" class="text-sm font-medium text-slate-500 hover:text-slate-900">Cancelar</a>
    {% if not form.pending_approval %}
      <div class="flex gap-3">
        <button
          type="submit"
          name="intent"
          value="save_draft"
          class="rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-50"
          {% if form.read_only %}disabled{% endif %}
        >
          Guardar borrador
        </button>
        <button
          type="submit"
          name="intent"
          value="send_workflow"
          class="rounded-full bg-brand px-5 py-2 text-sm font-semibold text-white hover:bg-brand/90 disabled:cursor-not-allowed disabled:opacity-60"
          {% if form.read_only %}disabled{% endif %}
        >
          Enviar a aprobación
        </button>
      </div>
    {% endif %}
  </div>
</section>

<template id="purchase-item-row-template">
  <tr data-item-row>
    <td class="px-3 py-2 align-middle">
      <div class="flex flex-col gap-1">
        <div class="relative" data-product-picker>
          <input
            type="text"
            name=""
            data-field="description"
            data-product-input
            class="h-11 w-full rounded-lg border border-slate-200 px-3 pr-10 text-xs shadow-sm focus:border-slate-400 focus:outline-none"
            placeholder="Describe el item"
            autocomplete="off"
            aria-label="Descripción del item"
          >
          <button
            type="button"
            class="absolute right-1.5 top-1/2 -translate-y-1/2 rounded-full border border-transparent bg-transparent p-2 text-slate-400 transition hover:text-slate-600 focus:border-slate-300 focus:outline-none"
            data-product-toggle
            aria-label="Mostrar productos"
          >
            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.22 7.22a.75.75 0 011.06 0L10 10.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 8.28a.75.75 0 010-1.06z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
        <input type="hidden" name="" data-field="id" value="">
        <input type="hidden" name="" data-field="product_id" data-product-id-input value="">
      </div>
    </td>
    <td class="px-3 py-2 align-middle">
      <div class="flex flex-col gap-1">
        <select
          name=""
          data-field="scope_value"
          class="h-11 w-full rounded-lg border border-slate-200 px-3 text-xs shadow-sm focus:border-slate-400 focus:outline-none"
        >
          {% for group in form.area_option_groups %}
            <optgroup label="{{ group.label }}">
              {% for option in group.options %}
                <option value="{{ option.value }}">{{ option.label }}{% if option.description %} · {{ option.description }}{% endif %}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
      </div>
    </td>
    <td class="px-3 py-2 align-middle">
      <div class="flex flex-col gap-1">
        <input
          type="number"
          step="0.01"
          min="0"
          max="99999"
          name=""
          data-field="quantity"
          value=""
          class="h-11 w-24 rounded-lg border border-slate-200 px-3 text-center text-xs shadow-sm focus:border-slate-400 focus:outline-none"
          placeholder="0"
          aria-label="Cantidad"
        >
      </div>
    </td>
    <td class="px-3 py-2 align-middle">
      <div class="flex flex-col gap-1">
        <input
          type="number"
          step="0.01"
          min="0"
          name=""
          data-field="estimated_amount"
          value=""
          class="h-11 w-32 rounded-lg border border-slate-200 px-3 text-right text-xs shadow-sm focus:border-slate-400 focus:outline-none"
          placeholder="0"
          aria-label="Valor unitario"
        >
      </div>
    </td>
    <td class="align-top px-3 py-2">
      <p class="text-right text-sm font-semibold text-slate-900" data-item-subtotal>0</p>
    </td>
    <td class="align-top px-3 py-2 text-center">
      <button
        type="button"
        class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold text-slate-500 hover:border-slate-300 hover:text-slate-900"
        data-remove-item
      >
        Quitar
      </button>
    </td>
  </tr>
</template>

<script type="module" src="{% static 'administration/js/purchase-request-form.js' %}"></script>
{% endwith %}
