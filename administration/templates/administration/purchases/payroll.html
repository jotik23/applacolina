{% extends "calendario/base.html" %}
{% load form_extras %}

{% block title %}Administración · Nómina{% endblock %}

{% block content %}
  {% include "administration/_submenu.html" with active=administration_active_submenu %}

  <section class="space-y-6">
    <header class="flex flex-col gap-4 rounded-2xl bg-white/90 p-6 shadow-sm ring-1 ring-slate-200/70 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Administración</p>
        <h1 class="text-2xl font-semibold text-slate-900">Nómina</h1>
        <p class="mt-1 text-sm text-slate-500">Genera la liquidación quincenal agrupada por tipos de puesto y granjas.</p>
      </div>
      <form method="get" class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-600 shadow-sm lg:flex-row lg:items-end">
        <label class="flex flex-col gap-1 text-xs font-semibold text-slate-500">
          Rango inicial
          {{ period_form.start_date|add_class:"rounded-xl border border-slate-200 px-3 py-2 text-sm" }}
          {% if period_form.start_date.errors %}
            <span class="text-[11px] font-semibold text-rose-600">{{ period_form.start_date.errors|join:', ' }}</span>
          {% endif %}
        </label>
        <label class="flex flex-col gap-1 text-xs font-semibold text-slate-500">
          Rango final
          {{ period_form.end_date|add_class:"rounded-xl border border-slate-200 px-3 py-2 text-sm" }}
          {% if period_form.end_date.errors %}
            <span class="text-[11px] font-semibold text-rose-600">{{ period_form.end_date.errors|join:', ' }}</span>
          {% endif %}
        </label>
        <button type="submit" class="rounded-full bg-brand px-6 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-brand/90">
          Actualizar rango
        </button>
      </form>
    </header>

    {% if period_form.non_field_errors %}
      <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm font-semibold text-rose-700">
        {% for error in period_form.non_field_errors %}
          <p>{{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  {% if payroll_summary %}
    {% if payroll_summary.entries %}
      <section class="mt-6 space-y-6">
        <div class="grid gap-4 md:grid-cols-3">
          <article class="rounded-2xl border border-slate-200 bg-white/95 p-5 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-slate-500">Periodo</p>
            <p class="mt-1 text-xl font-semibold text-slate-900">{{ payroll_summary.period.half_label }}</p>
            <p class="text-sm text-slate-500">{{ payroll_summary.period.label|capfirst }}</p>
          </article>
          <article class="rounded-2xl border border-slate-200 bg-white/95 p-5 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-slate-500">Colaboradores</p>
            <p class="mt-2 text-3xl font-semibold text-slate-900">{{ payroll_summary.entries|length }}</p>
            <p class="text-sm text-slate-500">Agrupados automáticamente por tipo de puesto base.</p>
          </article>
          <article class="rounded-2xl border border-emerald-200 bg-emerald-50/80 p-5 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-emerald-700">Total quincena</p>
            <p class="mt-2 text-3xl font-semibold text-emerald-900">$ {{ payroll_summary.overall_total|cop_currency }}</p>
            <p class="text-sm text-emerald-700">Incluye todos los ajustes manuales.</p>
          </article>
        </div>

        <form method="post" class="space-y-8">
          {% csrf_token %}
          <input type="hidden" name="start_date" value="{{ period_form.start_date.value|default_if_none:'' }}">
          <input type="hidden" name="end_date" value="{{ period_form.end_date.value|default_if_none:'' }}">

          <div class="rounded-2xl border border-slate-200 bg-white/90 p-5 shadow-sm">
            <div class="flex flex-col gap-2 border-b border-slate-100 pb-4 md:flex-row md:items-center md:justify-between">
              <div>
                <p class="text-xs uppercase tracking-wider text-slate-500">Generación de soportes por:</p>
                <p class="text-sm text-slate-500">Descarga los archivos agrupados por tipo de puesto o por granja.</p>
              </div>
            </div>
            <div class="mt-4 grid gap-6 md:grid-cols-2">
              <div class="space-y-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Tipo de puesto</p>
                <div class="flex flex-wrap gap-3">
                  {% for job_total in payroll_summary.totals_by_job_type %}
                    <div class="flex flex-col gap-2 rounded-xl border border-slate-200/80 px-4 py-3 text-sm">
                      <div>
                        <p class="font-semibold text-slate-900">{{ job_total.job_type_label }}</p>
                      <p class="text-xs text-slate-500">{{ job_total.collaborator_count }} colab. · $ {{ job_total.total_amount|cop_currency }}</p>
                      </div>
                      {% with identifier=job_total.job_type|default_if_none:'none' %}
                        <button type="submit" name="form_action" value="export-jobtype-{{ identifier }}" class="inline-flex items-center justify-center rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold text-slate-600">
                          Descargar
                        </button>
                      {% endwith %}
                    </div>
                  {% empty %}
                    <p class="text-sm text-slate-500">No hay tipos registrados en esta quincena.</p>
                  {% endfor %}
                </div>
              </div>
              <div class="space-y-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Granja</p>
                <div class="flex flex-wrap gap-3">
                  {% for farm_total in payroll_summary.totals_by_farm %}
                    <div class="flex flex-col gap-2 rounded-xl border border-slate-200/80 px-4 py-3 text-sm">
                      <div>
                        <p class="font-semibold text-slate-900">{{ farm_total.farm_label }}</p>
                        <p class="text-xs text-slate-500">{{ farm_total.collaborator_count }} colab. · $ {{ farm_total.total_amount|cop_currency }}</p>
                      </div>
                      {% with identifier=farm_total.farm_id|default_if_none:'none' %}
                        <button type="submit" name="form_action" value="export-farm-{{ identifier }}" class="inline-flex items-center justify-center rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold text-slate-600">
                          Descargar
                        </button>
                      {% endwith %}
                    </div>
                  {% empty %}
                    <p class="text-sm text-slate-500">No hay granjas con pagos en este periodo.</p>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          {% regroup payroll_summary.entries by job_type_label as payroll_by_job_type %}
          {% for group in payroll_by_job_type %}
            <section class="space-y-4 rounded-3xl border border-slate-200 bg-white/95 p-6 shadow-sm">
              <header class="flex flex-col gap-3 border-b border-slate-200 pb-4 md:flex-row md:items-center md:justify-between">
                <div>
                  <p class="text-xs uppercase tracking-wide text-slate-500">Tipo de puesto</p>
                  <h2 class="text-xl font-semibold text-slate-900">{{ group.grouper }}</h2>
                  <p class="text-sm text-slate-500">{{ group.list|length }} colaboradores · marca los descansos extra detectados según su salario.</p>
                </div>
                {% with first_entry=group.list|first %}
                  {% if first_entry %}
                    {% with identifier=first_entry.job_type|default_if_none:'none' %}
                      <button type="submit" name="form_action" value="export-jobtype-{{ identifier }}" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600">
                        Generar resumen del tipo
                      </button>
                    {% endwith %}
                  {% else %}
                    <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-400" disabled>
                      Sin datos disponibles
                    </button>
                  {% endif %}
                {% endwith %}
              </header>

              <div class="space-y-6">
                {% for entry in group.list %}
                  <article class="space-y-4 rounded-2xl border border-slate-200/80 p-5">
                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                      <div>
                        <p class="text-sm font-semibold text-slate-900">{{ entry.operator.get_full_name }}</p>
                        <p class="text-xs text-slate-500">Pago {{ entry.payment_type_label }} · Salario base $ {{ entry.salary_amount|cop_currency }}</p>
                        <p class="text-xs text-slate-400">Puesto {{ entry.job_type_label }} · Granja {{ entry.farm_label }}</p>
                      </div>
                      <div class="flex flex-wrap gap-2 text-xs">
                        <span class="rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">{{ entry.worked_days }} días trabajados</span>
                        <span class="rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">{{ entry.rest_days }} descansos</span>
                        {% if entry.extra_rest_count %}
                          <span class="rounded-full bg-amber-100 px-3 py-1 font-semibold text-amber-600">{{ entry.discounted_extra_count }} desc. descontados</span>
                          {% if entry.bonified_extra_count %}
                            <span class="rounded-full bg-emerald-100 px-3 py-1 font-semibold text-emerald-600">{{ entry.bonified_extra_count }} desc. bonificados</span>
                          {% endif %}
                        {% endif %}
                        {% if entry.non_worked_count %}
                          <span class="rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">{{ entry.non_worked_count }} días sin laborar</span>
                          {% if entry.discounted_non_worked_count %}
                            <span class="rounded-full bg-amber-100 px-3 py-1 font-semibold text-amber-600">{{ entry.discounted_non_worked_count }} NL descontados</span>
                          {% endif %}
                          {% if entry.bonified_non_worked_count %}
                            <span class="rounded-full bg-emerald-100 px-3 py-1 font-semibold text-emerald-600">{{ entry.bonified_non_worked_count }} NL bonificados</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </div>

                    <div class="grid gap-4 lg:grid-cols-3">
                      <div class="rounded-2xl border border-slate-100/80 p-4">
                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Turnos</p>
                        <ol class="mt-3 space-y-1 text-sm text-slate-600">
                          {% for shift in entry.shift_details %}
                            <li class="flex items-start justify-between gap-3">
                              <span>{{ shift.date|date:"d M" }}</span>
                              <span class="flex-1 text-right">{{ shift.position_label }}</span>
                            </li>
                          {% empty %}
                            <li class="text-xs text-slate-400">Sin turnos registrados.</li>
                          {% endfor %}
                        </ol>
                      </div>
                      <div class="rounded-2xl border border-slate-100/80 p-4">
                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Descansos</p>
                        <ol class="mt-3 space-y-2 text-sm">
                          {% for rest in entry.rest_details %}
                            <li class="flex items-center justify-between gap-2 rounded-xl border px-3 py-2 text-slate-600 {% if rest.is_extra and not rest.is_bonified %}border-amber-200 bg-amber-50{% elif rest.is_bonified %}border-emerald-200 bg-emerald-50{% else %}border-slate-100 bg-white{% endif %}">
                              <div>
                                <p class="text-xs font-semibold text-slate-500">{{ rest.date|date:"d M" }}</p>
                                <p class="text-xs text-slate-500">{{ rest.status }}{% if rest.notes %} · {{ rest.notes }}{% endif %}</p>
                              </div>
                              {% if rest.is_extra %}
                                <label class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                  <input type="checkbox" name="bonified_rest_ids" value="{{ rest.token }}" class="h-4 w-4 rounded border-slate-300" {% if rest.is_bonified %}checked{% endif %}>
                                  Incluir en liquidación
                                </label>
                              {% else %}
                                <span class="rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-500">Incluido</span>
                              {% endif %}
                            </li>
                          {% empty %}
                            <li class="text-xs text-slate-400">Sin descansos registrados.</li>
                          {% endfor %}
                        </ol>
                        <div class="mt-4 rounded-xl border border-slate-100 bg-white p-3 text-sm">
                          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Días no laborados</p>
                          <ol class="mt-2 space-y-2">
                            {% for idle in entry.non_worked_details %}
                              <li class="flex items-center justify-between gap-2 rounded-lg border px-3 py-2 text-slate-600 {% if idle.is_bonified %}border-emerald-200 bg-emerald-50{% else %}border-slate-100 bg-white{% endif %}">
                                <div>
                                  <p class="text-xs font-semibold text-slate-500">{{ idle.date|date:"d M" }}</p>
                                  <p class="text-[11px] text-slate-500">Sin actividad registrada</p>
                                </div>
                                <label class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                  <input type="checkbox" name="bonified_idle_ids" value="{{ idle.token }}" class="h-4 w-4 rounded border-slate-300" {% if idle.is_bonified %}checked{% endif %}>
                                  Incluir en liquidación
                                </label>
                              </li>
                            {% empty %}
                              <li class="text-xs text-slate-400">Todos los días tienen actividad o descanso.</li>
                            {% endfor %}
                          </ol>
                        </div>
                      </div>
                      <div class="space-y-3 rounded-2xl border border-slate-100/80 p-4">
                        <div>
                          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Monto sugerido</p>
                          <p class="mt-1 text-2xl font-semibold text-slate-900">$ {{ entry.suggested_amount|cop_currency }}</p>
                          <p class="text-xs text-slate-500">Base $ {{ entry.base_amount|cop_currency }} · Deducción $ {{ entry.deduction_amount|cop_currency }}</p>
                        </div>
                        <label class="text-xs font-semibold text-slate-500">
                          Valor final
                          <input type="number" step="0.01" min="0" name="override_amount__{{ entry.operator.id }}" value="{{ entry.override_amount|default_if_none:'' }}" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="{{ entry.suggested_amount|cop_currency }}">
                        </label>
                        <label class="text-xs font-semibold text-slate-500">
                          Nota de justificación
                          <textarea name="override_note__{{ entry.operator.id }}" rows="2" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Ej: Bonificación por meta cumplida">{{ entry.override_note }}</textarea>
                        </label>
                        <div class="rounded-xl bg-slate-50 px-3 py-2 text-xs text-slate-500">
                          <p>Pago final sugerido:</p>
                          <p class="text-lg font-semibold text-slate-900">$ {{ entry.final_amount|cop_currency }}</p>
                        </div>
                        <button type="submit" name="form_action" value="export-operator-{{ entry.operator.id }}" class="w-full rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600">
                          Generar liquidación individual
                        </button>
                      </div>
                    </div>
                  </article>
                {% endfor %}
              </div>
            </section>
          {% empty %}
            <p class="rounded-2xl border border-slate-200 bg-white/90 p-6 text-sm text-slate-500">No hay información para los tipos de puesto en el rango seleccionado.</p>
          {% endfor %}

          <div class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-white/90 p-5 shadow-sm md:flex-row md:items-center md:justify-between">
            <div>
              <p class="text-sm font-semibold text-slate-900">Total por liquidar</p>
              <p class="text-xs text-slate-500">Incluye ajustes y descansos bonificados.</p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
              <span class="text-2xl font-semibold text-slate-900">$ {{ payroll_summary.overall_total|cop_currency }}</span>
              <button type="submit" name="form_action" value="export-overall" class="rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600">Descargar resumen</button>
              <button type="submit" name="form_action" value="apply" class="rounded-full bg-brand px-6 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-brand/90">Guardar ajustes</button>
            </div>
          </div>
        </form>
      </section>
    {% else %}
      <div class="mt-10 rounded-3xl border border-slate-200 bg-white/95 p-10 text-center text-sm text-slate-500">
        <p class="text-base font-semibold text-slate-900">Sin actividades registradas</p>
        <p class="mt-2">No encontramos turnos ni descansos para la quincena seleccionada.</p>
      </div>
    {% endif %}
  {% else %}
    <div class="mt-10 rounded-3xl border border-slate-200 bg-white/95 p-10 text-center text-sm text-slate-500">
      <p class="text-base font-semibold text-slate-900">Selecciona un rango válido</p>
      <p class="mt-2">Recuerda que las liquidaciones son quincenales (1‑15 o 16‑fin de mes).</p>
    </div>
  {% endif %}
{% endblock %}
