{% extends "calendario/base.html" %}
{% load humanize form_extras %}

{% block title %}Despachos de huevo{% endblock %}

{% block content %}
  {% include "administration/_submenu.html" with active=administration_active_submenu %}

  <div class="space-y-6">
    <header class="flex flex-wrap items-center justify-between gap-6 rounded-2xl border border-slate-200/70 bg-white px-5 py-4 shadow-sm">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600">Cadena logística</p>
        <h1 class="text-2xl font-semibold text-slate-900">Despachos de huevo</h1>
        <p class="text-sm text-slate-500">
          Controla los cartones que salen de clasificación antes de que se registren ventas y mantén sincronizado el inventario disponible.
        </p>
      </div>
      <dl class="grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
        <div class="rounded-xl border border-emerald-100 bg-emerald-50/70 px-4 py-3">
          <dt class="font-semibold uppercase tracking-wide text-emerald-700">
            Despachado {{ selected_month|date:"F Y" }}
          </dt>
          <dd class="mt-1 text-2xl font-semibold text-emerald-900">
            {{ dispatch_total|cartons }} <span class="text-xs font-semibold text-emerald-600">cart</span>
          </dd>
        </div>
        <div class="rounded-xl border border-sky-100 bg-sky-50/70 px-4 py-3">
          <dt class="font-semibold uppercase tracking-wide text-sky-600">Inventario disponible</dt>
          <dd class="mt-1 text-2xl font-semibold text-sky-900">
            {{ inventory_total|cartons }} <span class="text-xs font-semibold text-sky-600">cart</span>
          </dd>
        </div>
      </dl>
    </header>

    <div class="flex flex-wrap items-center justify-between gap-4 rounded-2xl border border-slate-200/70 bg-white px-4 py-3 shadow-sm">
      <form method="get" class="flex items-center gap-3 text-sm text-slate-600">
        <label for="month" class="font-semibold text-slate-700">Mes:</label>
        <input
          type="month"
          id="month"
          name="month"
          value="{{ month_query }}"
          class="rounded-lg border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 shadow-inner focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-100"
        >
        <button
          type="submit"
          class="inline-flex items-center gap-2 rounded-lg border border-emerald-100 bg-emerald-50 px-3 py-1.5 text-sm font-semibold text-emerald-700 transition hover:border-emerald-200 hover:bg-emerald-100"
        >
          Aplicar
        </button>
        <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
          <a
            href="?month={{ prev_month_param }}"
            class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-slate-600 transition hover:border-emerald-200 hover:text-emerald-700"
          >
            ← Mes anterior
          </a>
          {% if has_next_month %}
            <a
              href="?month={{ next_month_param }}"
              class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-slate-600 transition hover:border-emerald-200 hover:text-emerald-700"
            >
              Próximo mes →
            </a>
          {% endif %}
        </div>
      </form>
      <a
        href="{% url 'administration:egg-dispatch-create' %}"
        class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500"
      >
        Registrar despacho
      </a>
    </div>

    <section class="grid gap-6 lg:grid-cols-12">
      <article class="rounded-2xl border border-slate-200/80 bg-white/95 p-5 shadow-sm lg:col-span-5">
        <header class="flex items-center justify-between border-b border-slate-100 pb-3">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Destino</p>
            <h2 class="text-lg font-semibold text-slate-900">Resumen mensual</h2>
          </div>
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">
            {{ dispatches|length }} despacho{{ dispatches|length|pluralize }}
          </span>
        </header>
        {% if destination_summary %}
          <ul class="divide-y divide-slate-100 text-sm text-slate-600">
            {% for row in destination_summary %}
              {% if row.cartons > 0 %}
                <li class="flex items-center justify-between py-3">
                  <div class="font-semibold text-slate-800">{{ row.label }}</div>
                  <div class="text-right font-semibold text-emerald-700">{{ row.cartons|cartons }} cart</div>
                </li>
              {% endif %}
            {% empty %}
              <li class="py-4 text-center text-sm text-slate-500">Sin despachos registrados.</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="py-4 text-center text-sm text-slate-500">Sin despachos registrados.</p>
        {% endif %}
        {% if type_summary %}
          <footer class="mt-4 rounded-xl bg-slate-50/70 px-4 py-3">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Composición del mes</p>
            <div class="mt-2 flex flex-wrap gap-3 text-xs font-semibold text-slate-700">
              {% for row in type_summary %}
                {% if row.cartons > 0 %}
                  <span class="inline-flex items-center gap-1 rounded-full bg-white px-3 py-1 shadow-sm">
                    {{ row.label }} <span class="text-emerald-700">{{ row.cartons|cartons }} cart</span>
                  </span>
                {% endif %}
              {% endfor %}
            </div>
          </footer>
        {% endif %}
      </article>
      <article class="rounded-2xl border border-slate-200/80 bg-white/95 p-5 shadow-sm lg:col-span-7">
        <header class="flex items-center justify-between border-b border-slate-100 pb-3">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Inventario clasificado</p>
            <h2 class="text-lg font-semibold text-slate-900">Disponibilidad por tipo</h2>
          </div>
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{ inventory_total|cartons }} cart</span>
        </header>
        {% if inventory_rows %}
          <div class="overflow-x-auto">
            <table class="mt-3 w-full border-collapse text-sm text-slate-600">
              <thead>
                <tr class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                  <th class="px-3 py-2 text-left">Tipo</th>
                  <th class="px-3 py-2 text-right">Cartones disponibles</th>
                  <th class="px-3 py-2 text-right">Última clasificación</th>
                </tr>
              </thead>
              <tbody>
                {% for row in inventory_rows %}
                  <tr class="border-t border-slate-100">
                    <td class="px-3 py-2 font-semibold text-slate-900">{{ row.label }}</td>
                    <td class="px-3 py-2 text-right font-semibold text-slate-800">{{ row.cartons|cartons }}</td>
                    <td class="px-3 py-2 text-right text-xs text-slate-500">
                      {% if row.last_classified_at %}
                        {{ row.last_classified_at|date:"d M" }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="py-4 text-center text-sm text-slate-500">Aún no hay inventario clasificado.</p>
        {% endif %}
      </article>
    </section>

    <section class="rounded-2xl border border-slate-200/80 bg-white/95 shadow-sm">
      <header class="flex items-center justify-between border-b border-slate-100 px-5 py-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Control operativo</p>
          <h2 class="text-lg font-semibold text-slate-900">Despachos registrados</h2>
        </div>
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">
          {{ dispatches|length }} registro{{ dispatches|length|pluralize }}
        </span>
      </header>
      {% if dispatches %}
        <ul class="divide-y divide-slate-100">
          {% for dispatch in dispatches %}
            <li class="px-5 py-4">
              <div class="grid gap-4 lg:grid-cols-[minmax(0,1.7fr)_minmax(0,1.2fr)_auto] lg:items-start">
                <div class="space-y-1">
                  <p class="text-sm font-semibold text-slate-900">
                    {{ dispatch.date|date:"l d \\d\\e F" }} · {{ dispatch.get_destination_display }}
                  </p>
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    Total despachado: {{ dispatch.total_cartons|cartons }} cart
                  </p>
                </div>
                <dl class="mt-3 grid gap-3 text-sm text-slate-600 sm:grid-cols-2 lg:mt-0">
                  <div>
                    <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Conductor</dt>
                    <dd class="mt-1 font-semibold text-slate-800">{{ dispatch.driver_name }}</dd>
                  </div>
                  <div>
                    <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Vendedor</dt>
                    <dd class="mt-1 font-semibold text-slate-800">{{ dispatch.seller_name }}</dd>
                  </div>
                  {% if dispatch.notes %}
                    <div class="sm:col-span-2">
                      <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Notas</dt>
                      <dd class="mt-1 text-slate-600">{{ dispatch.notes }}</dd>
                    </div>
                  {% endif %}
                </dl>
                <div class="flex gap-2 text-xs font-semibold text-slate-500 lg:justify-self-end">
                  <a
                    href="{% url 'administration:egg-dispatch-update' dispatch.pk %}"
                    class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1 transition hover:border-emerald-200 hover:text-emerald-700"
                  >
                    Editar
                  </a>
                  <a
                    href="{% url 'administration:egg-dispatch-delete' dispatch.pk %}"
                    class="inline-flex items-center rounded-full border border-rose-200 px-3 py-1 text-rose-600 transition hover:border-rose-300 hover:bg-rose-50"
                  >
                    Eliminar
                  </a>
                </div>
              </div>
              <div class="mt-3 rounded-xl bg-slate-50/70 px-4 py-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Detalle por tipo</p>
                <div class="mt-2 flex flex-wrap gap-2 text-xs font-semibold text-slate-700">
                  {% for item in dispatch.items.all %}
                    <span class="inline-flex items-center gap-1 rounded-full bg-white/90 px-3 py-1 shadow-sm">
                      {{ item.get_egg_type_display }} · <span class="text-emerald-700">{{ item.cartons|cartons }} cart</span>
                    </span>
                  {% empty %}
                    <span class="text-slate-500">Sin detalle</span>
                  {% endfor %}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="px-5 py-6 text-center text-sm text-slate-500">
          No hay despachos registrados en el mes seleccionado.
        </p>
      {% endif %}
    </section>
  </div>
{% endblock %}
