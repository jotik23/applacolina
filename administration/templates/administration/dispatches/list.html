{% extends "calendario/base.html" %}
{% load humanize form_extras %}

{% block title %}Despachos de huevo{% endblock %}

{% block content %}
  {% include "administration/_submenu.html" with active=administration_active_submenu %}

  <div class="space-y-6">
    <header class="flex flex-wrap items-center justify-between gap-6 rounded-2xl border border-slate-200/70 bg-white px-5 py-4 shadow-sm">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600">Cadena logística</p>
        <h1 class="text-2xl font-semibold text-slate-900">Despachos de huevo</h1>
        <p class="text-sm text-slate-500">
          Controla los cartones que salen de clasificación antes de que se registren ventas y mantén sincronizado el inventario disponible.
        </p>
      </div>
      <dl class="grid gap-3 text-xs text-slate-600 sm:grid-cols-2">
        <div class="rounded-xl border border-emerald-100 bg-emerald-50/70 px-4 py-3">
          <dt class="font-semibold uppercase tracking-wide text-emerald-700">
            Despachado {{ selected_month|date:"F Y" }}
          </dt>
          <dd class="mt-1 text-2xl font-semibold text-emerald-900">
            {{ dispatch_total|cartons }} <span class="text-xs font-semibold text-emerald-600">cart</span>
          </dd>
        </div>
        <div class="rounded-xl border border-sky-100 bg-sky-50/70 px-4 py-3">
          <dt class="font-semibold uppercase tracking-wide text-sky-600">Inventario disponible</dt>
          <dd class="mt-1 text-2xl font-semibold text-sky-900">
            {{ inventory_total|cartons }} <span class="text-xs font-semibold text-sky-600">cart</span>
          </dd>
        </div>
      </dl>
    </header>

    <div class="flex flex-wrap items-center justify-between gap-4 rounded-2xl border border-slate-200/70 bg-white px-4 py-3 shadow-sm">
      <form method="get" class="flex flex-wrap items-center gap-3 text-sm text-slate-600">
        <div class="flex items-center gap-2">
          <label for="month" class="font-semibold text-slate-700">Mes:</label>
          <input
            type="month"
            id="month"
            name="month"
            value="{{ month_query }}"
            class="rounded-lg border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 shadow-inner focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-100"
          >
        </div>
        <div class="flex items-center gap-2">
          <label for="destination" class="font-semibold text-slate-700">Destino:</label>
          <select
            id="destination"
            name="destination"
            class="rounded-lg border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 shadow-inner focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-100"
          >
            <option value="">Todos</option>
            {% for value, label in dispatch_destination_choices %}
              <option value="{{ value }}" {% if value == dispatch_destination_filter %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label for="seller" class="font-semibold text-slate-700">Vendedor:</label>
          <select
            id="seller"
            name="seller"
            class="rounded-lg border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 shadow-inner focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-100"
          >
            <option value="">Todos</option>
            {% for seller in dispatch_seller_options %}
              <option value="{{ seller.id }}" {% if seller.id == dispatch_seller_filter %}selected{% endif %}>{{ seller.name }}</option>
            {% endfor %}
          </select>
        </div>
        <button
          type="submit"
          class="inline-flex items-center gap-2 rounded-lg border border-emerald-100 bg-emerald-50 px-3 py-1.5 text-sm font-semibold text-emerald-700 transition hover:border-emerald-200 hover:bg-emerald-100"
        >
          Aplicar
        </button>
        {% if dispatch_destination_filter or dispatch_seller_filter %}
          <a
            href="?month={{ month_query }}"
            class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-800"
          >
            Limpiar
          </a>
        {% endif %}
        <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
          <a
            href="?month={{ prev_month_param }}{% if dispatch_destination_filter %}&destination={{ dispatch_destination_filter }}{% endif %}{% if dispatch_seller_filter %}&seller={{ dispatch_seller_filter }}{% endif %}"
            class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-slate-600 transition hover:border-emerald-200 hover:text-emerald-700"
          >
            ← Mes anterior
          </a>
          {% if has_next_month %}
            <a
              href="?month={{ next_month_param }}{% if dispatch_destination_filter %}&destination={{ dispatch_destination_filter }}{% endif %}{% if dispatch_seller_filter %}&seller={{ dispatch_seller_filter }}{% endif %}"
              class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-slate-600 transition hover:border-emerald-200 hover:text-emerald-700"
            >
              Próximo mes →
            </a>
          {% endif %}
        </div>
      </form>
      <a
        href="{% url 'administration:egg-dispatch-create' %}"
        class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500"
        data-dispatch-panel-open-trigger
      >
        Registrar despacho
      </a>
    </div>

    <section class="rounded-2xl border border-slate-200/80 bg-white/95 shadow-sm">
      <header class="flex items-center justify-between border-b border-slate-100 px-5 py-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Control operativo</p>
          <h2 class="text-lg font-semibold text-slate-900">Despachos registrados</h2>
        </div>
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">
          {{ dispatches|length }} registro{{ dispatches|length|pluralize }}
        </span>
      </header>
      {% if dispatch_rows %}
        <div class="overflow-x-auto">
          <table class="min-w-full border-collapse text-sm text-slate-600">
            <thead>
              <tr class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                <th class="px-3 py-3 text-left">Fecha</th>
                <th class="px-3 py-3 text-left">Destino</th>
                <th class="px-3 py-3 text-right">Total despachado</th>
                {% for header in egg_type_headers %}
                  <th class="px-3 py-3 text-right">{{ header.label }}</th>
                {% endfor %}
                <th class="px-3 py-3 text-left">Conductor</th>
                <th class="px-3 py-3 text-left">Vendedor</th>
                <th class="px-3 py-3 text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for row in dispatch_rows %}
                {% with dispatch=row.dispatch %}
                  <tr class="border-t border-slate-100 hover:bg-slate-50/60">
                    <td class="px-3 py-3 font-semibold text-slate-900">
                      {{ dispatch.date|date:"d M Y" }}
                    </td>
                    <td class="px-3 py-3 font-semibold text-slate-900">
                      {{ dispatch.get_destination_display }}
                    </td>
                    <td class="px-3 py-3 text-right font-semibold text-emerald-700">
                      {{ dispatch.total_cartons|cartons }} cart
                    </td>
                    {% for cell in row.type_breakdown %}
                      <td class="px-3 py-3 text-right font-semibold text-slate-900">
                        {% if cell.cartons > 0 %}
                          {{ cell.cartons|cartons }}
                        {% else %}
                          <span class="text-slate-400">—</span>
                        {% endif %}
                      </td>
                    {% endfor %}
                    <td class="px-3 py-3 font-semibold text-slate-900">
                      {{ dispatch.driver_name }}
                    </td>
                    <td class="px-3 py-3 font-semibold text-slate-900">
                      {{ dispatch.seller_name }}
                    </td>
                    <td class="px-3 py-3">
                      <div class="flex justify-center gap-2 text-xs font-semibold text-slate-500">
                        <a
                          href="{% url 'administration:egg-dispatch-update' dispatch.pk %}"
                          class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1 transition hover:border-emerald-200 hover:text-emerald-700"
                        >
                          Editar
                        </a>
                        <a
                          href="{% url 'administration:egg-dispatch-delete' dispatch.pk %}"
                          class="inline-flex items-center rounded-full border border-rose-200 px-3 py-1 text-rose-600 transition hover:border-rose-300 hover:bg-rose-50"
                        >
                          Eliminar
                        </a>
                      </div>
                    </td>
                  </tr>
                  {% if dispatch.notes %}
                    <tr class="border-t border-slate-100 bg-slate-50/70">
                      <td class="px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-500" colspan="{{ egg_type_headers|length|add:'6' }}">
                        Notas: <span class="ml-1 font-normal normal-case text-slate-600">{{ dispatch.notes }}</span>
                      </td>
                    </tr>
                  {% endif %}
                {% endwith %}
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="border-t-2 border-slate-200 bg-slate-50 font-semibold text-slate-900">
                <td class="px-3 py-3" colspan="2">Total del periodo</td>
                <td class="px-3 py-3 text-right text-emerald-700">{{ dispatch_total|cartons }} cart</td>
                {% for summary in type_summary %}
                  <td class="px-3 py-3 text-right">
                    {% if summary.cartons > 0 %}
                      {{ summary.cartons|cartons }}
                    {% else %}
                      <span class="text-slate-400">—</span>
                    {% endif %}
                  </td>
                {% endfor %}
                <td class="px-3 py-3 text-center" colspan="3"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      {% else %}
        <p class="px-5 py-6 text-center text-sm text-slate-500">
          No hay despachos registrados en el mes seleccionado.
        </p>
      {% endif %}
    </section>
  </div>
  {% with panel_open=dispatch_panel_open panel_embedded=True panel_title=dispatch_panel_title panel_subtitle=dispatch_panel_subtitle panel_form_action=dispatch_form_action panel_submit_label=dispatch_panel_submit_label panel_cancel_url=dispatch_panel_cancel_url form=dispatch_form type_rows=dispatch_form_type_rows inventory_total=inventory_total dispatch=dispatch_form.instance %}
    {% include "administration/dispatches/includes/panel.html" %}
  {% endwith %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var panel = document.querySelector('[data-dispatch-panel][data-dispatch-panel-embedded="true"]');
      if (!panel) {
        return;
      }
      var openButtons = document.querySelectorAll('[data-dispatch-panel-open-trigger]');
      var closeButtons = panel.querySelectorAll('[data-dispatch-panel-close]');
      var backdrop = panel.querySelector('[data-dispatch-panel-backdrop]');
      var lastTrigger = null;

      var focusPanel = function () {
        var target =
          panel.querySelector('[data-dispatch-panel-focus]') ||
          panel.querySelector('input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])');
        if (target && typeof target.focus === 'function') {
          target.focus();
        }
      };

      var openPanel = function (trigger) {
        if (!panel.classList.contains('hidden')) {
          focusPanel();
          return;
        }
        panel.classList.remove('hidden');
        panel.setAttribute('data-dispatch-panel-open', 'true');
        lastTrigger = trigger || null;
        focusPanel();
      };

      var closePanel = function (focusTrigger) {
        if (panel.classList.contains('hidden')) {
          return;
        }
        panel.classList.add('hidden');
        panel.setAttribute('data-dispatch-panel-open', 'false');
        if (focusTrigger && lastTrigger && typeof lastTrigger.focus === 'function') {
          lastTrigger.focus();
        }
      };

      openButtons.forEach(function (button) {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          openPanel(button);
        });
      });
      closeButtons.forEach(function (button) {
        button.addEventListener('click', function (event) {
          event.preventDefault();
          closePanel(true);
        });
      });
      if (backdrop) {
        backdrop.addEventListener('click', function (event) {
          if (event.target === backdrop) {
            closePanel(true);
          }
        });
      }
      panel.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
          event.preventDefault();
          closePanel(true);
        }
      });
      if (panel.getAttribute('data-dispatch-panel-open') === 'true') {
        focusPanel();
      }
    });
  </script>
{% endblock %}
