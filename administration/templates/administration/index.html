{% extends "calendario/base.html" %}
{% load static %}

{% block title %}Administración · Compras{% endblock %}

{% block content %}
  {% if home_active_tab %}
    {% include "home/_submenu.html" with active=home_active_tab %}
  {% else %}
    {% include "administration/_submenu.html" with active=administration_active_submenu %}
  {% endif %}

  <section class="space-y-8">
    <header class="flex flex-col gap-4 rounded-2xl bg-white/90 p-6 shadow-sm ring-1 ring-slate-200/70 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Administración</p>
        <h1 class="text-2xl font-semibold text-slate-900">Compras</h1>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <a
          href="?scope={{ purchases_scope.code }}{{ purchases_filter_suffix }}&export=excel"
          class="inline-flex items-center gap-2 rounded-full border border-slate-200/80 bg-white px-4 py-2 text-sm font-medium text-slate-600 transition hover:border-slate-300 hover:text-slate-900"
        >
          Exportar Excel
        </a>
        {% if purchases_panel %}
          <a
            href="?scope={{ purchases_scope.code }}{{ purchases_filter_suffix_with_page }}"
            class="inline-flex items-center gap-2 rounded-full border border-slate-200/80 bg-white px-4 py-2 text-sm font-medium text-slate-600 transition hover:border-slate-300 hover:text-slate-900"
          >
            <span aria-hidden="true" class="size-1.5 rounded-full bg-slate-400"></span>
            Cerrar formulario
          </a>
        {% endif %}
        <a
          href="?scope={{ purchases_scope.code }}{{ purchases_filter_suffix_with_page }}&panel=request"
          class="inline-flex items-center gap-2 rounded-full bg-brand px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-brand/90"
        >
          <span aria-hidden="true" class="text-base">＋</span>
          Nueva compra
        </a>
      </div>
    </header>

    <form
      method="get"
      action=""
      class="flex flex-col gap-2 rounded-2xl border border-slate-200/80 bg-slate-50/80 px-3 py-3 text-[11px] text-slate-600 shadow-inner"
    >
      <input type="hidden" name="scope" value="{{ purchases_scope.code }}">
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex w-64 flex-col gap-1">
          <span class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Categorías</span>
          <details class="relative w-full" data-filter-dropdown>
            <summary class="flex cursor-pointer items-center justify-between rounded-lg border border-slate-200 bg-white/80 px-3 py-1.5 text-[12px] font-semibold text-slate-600 shadow-sm transition hover:border-slate-300">
              <span>Selecciona categorías</span>
              <span class="inline-flex items-center gap-1 text-[11px] text-slate-400">
                {% if purchases_category_filters %}
                  {{ purchases_category_filters|length }} seleccionadas
                {% else %}
                  Todas
                {% endif %}
                <svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.207l3.71-3.975a.75.75 0 011.08 1.04l-4.24 4.54a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
              </span>
            </summary>
            <div class="absolute z-20 mt-2 w-64 rounded-2xl border border-slate-200 bg-white/95 p-3 text-[12px] text-slate-600 shadow-xl">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Filtra por categoría</p>
              <label class="mt-3 flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50/70 px-3 py-2 text-[11px] text-slate-500 shadow-inner focus-within:border-emerald-400">
                <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 103.473 9.8l3.613 3.614a.75.75 0 101.06-1.06l-3.613-3.615A5.5 5.5 0 009 3.5zm-4 5.5a4 4 0 118 0 4 4 0 01-8 0z" clip-rule="evenodd" />
                </svg>
                <input
                  type="search"
                  class="w-full border-none bg-transparent text-[12px] font-medium text-slate-700 placeholder:text-slate-400 outline-none"
                  placeholder="Buscar categoría..."
                  data-filter-search
                >
              </label>
              <div class="mt-2 grid max-h-56 gap-2 overflow-y-auto pr-1" data-filter-options>
                {% for option in purchase_category_options %}
                  <label class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-medium text-slate-600" data-filter-label="{{ option.label|lower }}">
                    <input
                      type="checkbox"
                      name="category"
                      value="{{ option.id }}"
                      class="h-3.5 w-3.5 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                      {% if option.id in purchases_category_filters %}checked{% endif %}
                    >
                    <span>{{ option.label }}</span>
                  </label>
                {% empty %}
                  <p class="text-[11px] text-slate-400">No hay categorías disponibles.</p>
                {% endfor %}
              </div>
              <p class="mt-2 text-[11px] text-slate-400 hidden" data-filter-empty>No encontramos coincidencias.</p>
            </div>
          </details>
        </div>
        <div class="flex w-64 flex-col gap-1">
          <span class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Proveedores</span>
          <details class="relative w-full" data-filter-dropdown>
            <summary class="flex cursor-pointer items-center justify-between rounded-lg border border-slate-200 bg-white/80 px-3 py-1.5 text-[12px] font-semibold text-slate-600 shadow-sm transition hover:border-slate-300">
              <span>Selecciona proveedores</span>
              <span class="inline-flex items-center gap-1 text-[11px] text-slate-400">
                {% if purchases_supplier_filters %}
                  {{ purchases_supplier_filters|length }} seleccionados
                {% else %}
                  Todos
                {% endif %}
                <svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.207l3.71-3.975a.75.75 0 011.08 1.04l-4.24 4.54a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
              </span>
            </summary>
            <div class="absolute z-20 mt-2 w-64 rounded-2xl border border-slate-200 bg-white/95 p-3 text-[12px] text-slate-600 shadow-xl">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Filtra por proveedor</p>
              <label class="mt-3 flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50/70 px-3 py-2 text-[11px] text-slate-500 shadow-inner focus-within:border-emerald-400">
                <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 103.473 9.8l3.613 3.614a.75.75 0 101.06-1.06l-3.613-3.615A5.5 5.5 0 009 3.5zm-4 5.5a4 4 0 118 0 4 4 0 01-8 0z" clip-rule="evenodd" />
                </svg>
                <input
                  type="search"
                  class="w-full border-none bg-transparent text-[12px] font-medium text-slate-700 placeholder:text-slate-400 outline-none"
                  placeholder="Buscar proveedor..."
                  data-filter-search
                >
              </label>
              <div class="mt-2 grid max-h-64 gap-2 overflow-y-auto pr-1" data-filter-options>
                {% for option in purchase_supplier_options %}
                  <label class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-medium text-slate-600" data-filter-label="{{ option.label|lower }}">
                    <input
                      type="checkbox"
                      name="supplier"
                      value="{{ option.id }}"
                      class="h-3.5 w-3.5 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                      {% if option.id in purchases_supplier_filters %}checked{% endif %}
                    >
                    <span>{{ option.label }}</span>
                  </label>
                {% empty %}
                  <p class="text-[11px] text-slate-400">No hay proveedores para filtrar.</p>
                {% endfor %}
              </div>
              <p class="mt-2 text-[11px] text-slate-400 hidden" data-filter-empty>No encontramos coincidencias.</p>
            </div>
          </details>
        </div>
        <div class="flex w-64 flex-col gap-1">
          <span class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Gestor asignado</span>
          <details class="relative w-full" data-filter-dropdown>
            <summary class="flex cursor-pointer items-center justify-between rounded-lg border border-slate-200 bg-white/80 px-3 py-1.5 text-[12px] font-semibold text-slate-600 shadow-sm transition hover:border-slate-300">
              <span>Selecciona gestores</span>
              <span class="inline-flex items-center gap-1 text-[11px] text-slate-400">
                {% if purchases_manager_filters %}
                  {{ purchases_manager_filters|length }} seleccionados
                {% else %}
                  Todos
                {% endif %}
                <svg class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.207l3.71-3.975a.75.75 0 011.08 1.04l-4.24 4.54a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
              </span>
            </summary>
            <div class="absolute z-20 mt-2 w-64 rounded-2xl border border-slate-200 bg-white/95 p-3 text-[12px] text-slate-600 shadow-xl">
              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Filtra por gestor</p>
              <label class="mt-3 flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50/70 px-3 py-2 text-[11px] text-slate-500 shadow-inner focus-within:border-emerald-400">
                <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 103.473 9.8l3.613 3.614a.75.75 0 101.06-1.06l-3.613-3.615A5.5 5.5 0 009 3.5zm-4 5.5a4 4 0 118 0 4 4 0 01-8 0z" clip-rule="evenodd" />
                </svg>
                <input
                  type="search"
                  class="w-full border-none bg-transparent text-[12px] font-medium text-slate-700 placeholder:text-slate-400 outline-none"
                  placeholder="Buscar gestor..."
                  data-filter-search
                >
              </label>
              <div class="mt-2 grid max-h-64 gap-2 overflow-y-auto pr-1" data-filter-options>
                {% for option in purchase_manager_options %}
                  <label class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-2 py-1 text-[11px] font-medium text-slate-600" data-filter-label="{{ option.label|lower }}">
                    <input
                      type="checkbox"
                      name="manager"
                      value="{{ option.id }}"
                      class="h-3.5 w-3.5 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                      {% if option.id in purchases_manager_filters %}checked{% endif %}
                    >
                    <span>{{ option.label }}</span>
                  </label>
                {% empty %}
                  <p class="text-[11px] text-slate-400">No hay gestores asignados.</p>
                {% endfor %}
              </div>
              <p class="mt-2 text-[11px] text-slate-400 hidden" data-filter-empty>No encontramos coincidencias.</p>
            </div>
          </details>
        </div>
        <label class="flex w-60 flex-col gap-1">
          <span class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Texto libre</span>
          <input
            type="search"
            name="search"
            value="{{ purchases_search }}"
            placeholder="Código, descripción o proveedor"
            class="h-8 rounded-lg border border-slate-200 bg-white/80 px-2 text-[12px] font-medium text-slate-700 focus:border-emerald-400 focus:outline-none focus:ring-1 focus:ring-emerald-400"
          >
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Fecha inicio</span>
          <input
            type="date"
            name="start_date"
            value="{{ purchases_start_date }}"
            class="h-8 rounded-lg border border-slate-200 bg-white/80 px-2 text-[12px] font-medium text-slate-700 focus:border-emerald-400 focus:outline-none focus:ring-1 focus:ring-emerald-400"
          >
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Fecha fin</span>
          <input
            type="date"
            name="end_date"
            value="{{ purchases_end_date }}"
            class="h-8 rounded-lg border border-slate-200 bg-white/80 px-2 text-[12px] font-medium text-slate-700 focus:border-emerald-400 focus:outline-none focus:ring-1 focus:ring-emerald-400"
          >
        </label>
        <div class="ml-auto flex items-center gap-2">
          <button
            type="submit"
            class="inline-flex items-center gap-2 rounded-lg bg-slate-900 px-3 py-1 text-xs font-semibold text-white shadow-sm transition hover:bg-slate-800"
          >
            Aplicar filtros
          </button>
          {% if purchases_has_active_filters %}
            <a
              href="?scope={{ purchases_scope.code }}"
              class="text-xs font-semibold text-slate-500 underline-offset-2 hover:text-slate-700 hover:underline"
            >
              Limpiar
            </a>
          {% endif %}
        </div>
      </div>
    </form>

    <div class="rounded-2xl bg-white/90 p-4 shadow-sm ring-1 ring-slate-200/70">
        <div class="flex flex-wrap gap-2 border-b border-slate-200/70 pb-4">
          {% for scope in purchases_scopes %}
            <a
              href="?scope={{ scope.code }}{{ purchases_filter_suffix }}"
              class="group inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-semibold transition {% if scope.code == purchases_scope.code %}border-slate-900 bg-slate-900 text-white shadow{% else %}border-slate-200 bg-white text-slate-600 hover:border-slate-300 hover:text-slate-900{% endif %}"
              aria-current="{% if scope.code == purchases_scope.code %}page{% else %}false{% endif %}"
            >
              <span class="inline-flex size-5 items-center justify-center rounded-full text-xs font-bold {% if scope.code == purchases_scope.code %}bg-white/20 text-white{% else %}bg-slate-100 text-slate-500 group-hover:bg-slate-200 group-hover:text-slate-700{% endif %}">
                {{ scope.count }}
            </span>
            {{ scope.label }}
          </a>
        {% endfor %}
      </div>

      <div class="mt-4 overflow-hidden rounded-2xl border border-slate-200/70">
        <div class="border-b border-slate-200/70 bg-white/90">
          <button
            type="button"
            class="flex w-full items-center justify-between gap-4 px-6 py-4 text-left"
            data-purchase-bulk-panel-toggle
            aria-expanded="false"
            >
              <div class="space-y-1">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Acciones masivas</p>
                <p
                  class="text-xs text-slate-500"
                  data-purchase-bulk-summary
                  data-empty-text="Selecciona compras para habilitar estas acciones."
                  data-selection-template="Seleccionaste __count__ compras."
                >
                  Selecciona compras para habilitar estas acciones.
                </p>
              </div>
              <div class="flex flex-col items-end gap-1 text-xs font-semibold text-slate-600 sm:flex-row sm:items-center sm:gap-4">
                <span class="text-slate-600">
                  Seleccionadas:
                  <span class="text-slate-900" data-purchase-bulk-count>0</span>
                </span>
                <span
                  class="text-[11px] font-semibold uppercase tracking-wide text-slate-500"
                  data-purchase-bulk-panel-state
                  data-collapsed-label="Mostrar acciones"
                  data-expanded-label="Ocultar acciones"
                >
                  Mostrar acciones
                </span>
                <svg
                  class="h-4 w-4 text-slate-500 transition-transform duration-150"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                  aria-hidden="true"
                  data-purchase-bulk-panel-icon
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
            </button>
            <div class="border-t border-slate-200/70 px-6 py-4" data-purchase-bulk-panel hidden>
              <form
                id="purchase-bulk-actions-form"
                method="post"
                action="{% url 'administration:purchases' %}"
                class="space-y-4"
                data-purchase-bulk-form
              >
                {% csrf_token %}
                <input type="hidden" name="scope" value="{{ purchases_scope.code }}">
                {% if purchases_search %}<input type="hidden" name="search" value="{{ purchases_search }}">{% endif %}
                {% if purchases_start_date %}<input type="hidden" name="start_date" value="{{ purchases_start_date }}">{% endif %}
                {% if purchases_end_date %}<input type="hidden" name="end_date" value="{{ purchases_end_date }}">{% endif %}
                {% for value in purchases_category_filters %}
                  <input type="hidden" name="category" value="{{ value }}">
                {% endfor %}
                {% for value in purchases_supplier_filters %}
                  <input type="hidden" name="supplier" value="{{ value }}">
                {% endfor %}
                {% for value in purchases_manager_filters %}
                  <input type="hidden" name="manager" value="{{ value }}">
                {% endfor %}
                {% if purchases_page %}<input type="hidden" name="page" value="{{ purchases_page.page_number }}">{% endif %}
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                  <div class="flex flex-col gap-3 rounded-2xl border border-slate-200/80 bg-slate-50/80 p-4 text-sm text-slate-600">
                    <div>
                      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Mover a otro estado</p>
                      <p class="text-xs text-slate-500">Actualiza el estado de todas las compras seleccionadas.</p>
                    </div>
                    <label class="text-xs font-semibold text-slate-500">
                      Nuevo estado
                      <select
                        name="target_status"
                        class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-slate-400 focus:outline-none"
                        data-purchase-bulk-requires-selection
                      >
                        <option value="">Selecciona un estado</option>
                        {% for value, label in purchase_status_options %}
                          <option value="{{ value }}" {% if purchase_status_default == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                      </select>
                    </label>
                    <button
                      type="submit"
                      name="bulk_action"
                      value="move_status"
                      class="inline-flex items-center justify-center rounded-full bg-brand px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-brand/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand focus-visible:ring-offset-2"
                      data-purchase-bulk-requires-selection
                    >
                      Actualizar estado
                    </button>
                  </div>
                  <div class="flex flex-col gap-3 rounded-2xl border border-slate-200/80 bg-slate-50/80 p-4 text-sm text-slate-600">
                    <div>
                      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Modificar fecha de solicitud</p>
                      <p class="text-xs text-slate-500">Ajusta la fecha de creación manteniendo la hora original.</p>
                    </div>
                    <label class="text-xs font-semibold text-slate-500">
                      Nueva fecha
                      <input
                        type="date"
                        name="bulk_requested_date"
                        class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-slate-400 focus:outline-none"
                        data-purchase-bulk-requires-selection
                      >
                    </label>
                    <button
                      type="submit"
                      name="bulk_action"
                      value="update_requested_date"
                      class="inline-flex items-center justify-center rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-400 hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2"
                      data-purchase-bulk-requires-selection
                    >
                      Actualizar fecha
                    </button>
                  </div>
                  <div class="flex flex-col gap-3 rounded-2xl border border-slate-200/80 bg-slate-50/80 p-4 text-sm text-slate-600">
                    <div>
                      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Agrupar solicitudes</p>
                      <p class="text-xs text-slate-500">Crea un único soporte para varias solicitudes en Gestionar soporte.</p>
                    </div>
                    <p class="text-[11px] text-slate-500">
                      Todas deben estar en estado <span class="font-semibold">Gestionar soporte</span> y no tener soportes previos.
                    </p>
                    <button
                      type="submit"
                      name="bulk_action"
                      value="group_support"
                      class="inline-flex items-center justify-center rounded-full border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-400 hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2"
                      data-purchase-bulk-requires-selection
                      data-purchase-bulk-group-button
                    >
                      Agrupar solicitudes
                    </button>
                    <p class="text-[11px] font-semibold text-amber-600" data-purchase-bulk-group-hint hidden>
                      Selecciona al menos dos compras en Gestionar soporte para habilitar esta acción.
                    </p>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 text-sm">
              <thead class="bg-white text-left text-xs uppercase tracking-wide text-slate-500">
                <tr>
                  <th scope="col" class="w-12 px-4 py-3 text-center">
                    <input
                      type="checkbox"
                      class="h-4 w-4 rounded border-slate-300 text-brand focus:ring-brand"
                      aria-label="Seleccionar todas las compras"
                      data-purchase-bulk-toggle
                    >
                  </th>
                  <th scope="col" class="px-6 py-3">Solicitud</th>
                  <th scope="col" class="px-6 py-3">Tercero</th>
                  <th scope="col" class="px-6 py-3">Categoría / Soporte</th>
                  {% if purchases_scope.code == 'aprobacion' %}
                    <th scope="col" class="px-6 py-3 text-center">Aprobaciones recibidas</th>
                    <th scope="col" class="px-6 py-3 text-center">Aprobaciones pendientes</th>
                  {% endif %}
                  <th scope="col" class="px-6 py-3 text-right">Monto</th>
                  <th scope="col" class="px-6 py-3 text-right">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100 bg-white">
                {% if purchases_list %}
                  {% for purchase in purchases_list %}
                    <tr class="align-top hover:bg-slate-50/70 {% if purchase.has_reception_mismatch %}bg-amber-50/60 ring-1 ring-amber-200{% endif %}">
                      <td class="px-4 py-4 align-middle">
                        <input
                          type="checkbox"
                          name="selected_purchases"
                          value="{{ purchase.pk }}"
                          form="purchase-bulk-actions-form"
                          class="h-4 w-4 rounded border-slate-300 text-brand focus:ring-brand"
                          aria-label="Seleccionar la compra {{ purchase.timeline_code }}"
                          data-purchase-bulk-checkbox
                          data-support-eligible="{% if purchase.status == 'factura' %}true{% else %}false{% endif %}"
                        >
                      </td>
                      <td class="px-6 py-4">
                        <div class="flex flex-col gap-1">
                          <div class="flex items-center gap-2">
                            <p class="text-sm font-semibold text-slate-900">{{ purchase.description }}</p>
                            <span class="inline-flex items-center rounded-full bg-{{ purchase.status_palette }}-100 px-2 py-0.5 text-[11px] font-semibold text-{{ purchase.status_palette }}-700">
                              {{ purchase.status_badge }}
                            </span>
                          </div>
                          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{ purchase.timeline_code }}</p>
                          {% if purchase.has_reception_mismatch %}
                            <span class="inline-flex w-fit items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-amber-700">
                              Diferencias en recepción
                            </span>
                          {% endif %}
                          <div class="text-xs text-slate-500">
                            <span class="font-semibold text-slate-700">{{ purchase.requester }}</span>
                            ·
                            {{ purchase.scope_label }}
                          </div>
                          {% if purchase.support_group_code %}
                            <p class="text-xs text-slate-500">
                              Grupo soporte {{ purchase.support_group_code }}
                              {% if purchase.is_support_group_leader %}
                                · Líder
                              {% else %}
                                · Gestionado desde {{ purchase.support_group_leader_code }}
                              {% endif %}
                            </p>
                          {% endif %}
                          <p class="text-xs text-slate-500">Área: {{ purchase.area_label }}</p>
                        </div>
                      </td>
                      <td class="px-6 py-4 align-middle">
                        <div class="text-sm font-semibold text-slate-900">{{ purchase.supplier }}</div>
                        <p class="text-xs text-slate-500">Creada {{ purchase.created_on|date:"M d" }}{% if purchase.eta %} · ETA {{ purchase.eta|date:"M d" }}{% endif %}</p>
                      </td>
                      <td class="px-6 py-4 align-middle">
                        <p class="text-sm font-semibold text-slate-900">{{ purchase.category_name }}</p>
                        {% if purchase.support_type_label %}
                          <p class="text-xs text-slate-500">{{ purchase.support_type_label }}</p>
                        {% else %}
                          <p class="text-xs text-slate-400">Sin tipo de soporte</p>
                        {% endif %}
                      </td>
                      {% if purchases_scope.code == 'aprobacion' %}
                        <td class="px-6 py-4 align-middle">
                          {% if purchase.approvals_received %}
                            <ul class="space-y-1 text-sm text-slate-700">
                              {% for approver in purchase.approvals_received %}
                                <li class="flex items-center gap-2">
                                  <span class="inline-flex size-5 items-center justify-center rounded-full bg-emerald-100 text-[10px] font-bold text-emerald-700">✓</span>
                                  <span class="font-medium">{{ approver }}</span>
                                </li>
                              {% endfor %}
                            </ul>
                          {% else %}
                            <p class="text-xs text-slate-400">Sin aprobaciones</p>
                          {% endif %}
                        </td>
                        <td class="px-6 py-4 align-middle">
                          {% if purchase.approvals_pending %}
                            <ul class="space-y-1 text-sm text-slate-700">
                              {% for approver in purchase.approvals_pending %}
                                <li class="flex items-center gap-2">
                                  <span class="inline-flex size-5 items-center justify-center rounded-full bg-amber-100 text-[10px] font-bold text-amber-700">•</span>
                                  <span class="font-medium">{{ approver }}</span>
                                </li>
                              {% endfor %}
                            </ul>
                          {% else %}
                            <p class="text-xs text-slate-400">Sin pendientes</p>
                          {% endif %}
                        </td>
                      {% endif %}
                      <td class="px-6 py-4 text-right align-middle">
                        {% if purchase.show_payment_breakdown %}
                          <div class="space-y-2 text-right">
                            <div>
                              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Monto aprobado</p>
                              <p class="text-sm font-semibold text-slate-900">{{ purchase.total_display }}</p>
                            </div>
                            <div>
                              <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Monto pagado</p>
                              <p class="text-sm font-semibold text-slate-900">{{ purchase.paid_display }}</p>
                            </div>
                          </div>
                        {% else %}
                          <p class="text-sm font-semibold text-slate-900">{{ purchase.total_display }}</p>
                        {% endif %}
                      </td>
                      <td class="px-6 py-4 text-right align-middle">
                        <div class="inline-flex flex-col gap-2 text-right">
                          {% if purchase.support_group_code and not purchase.is_support_group_leader and purchase.support_group_leader_id %}
                            <a
                              href="?scope={{ purchases_scope.code }}{{ purchases_filter_suffix_with_page }}&panel=invoice&purchase={{ purchase.support_group_leader_id }}"
                              class="inline-flex items-center justify-end gap-2 text-sm font-semibold text-brand hover:text-brand/80"
                            >
                              Ver soporte agrupado
                              <span aria-hidden="true">→</span>
                            </a>
                          {% elif purchase.action %}
                            <a
                              href="?scope={{ purchases_scope.code }}{{ purchases_filter_suffix_with_page }}&panel={{ purchase.action.panel }}&purchase={{ purchase.pk }}"
                              class="inline-flex items-center justify-end gap-2 text-sm font-semibold text-brand hover:text-brand/80"
                            >
                              {{ purchase.action.label }}
                              <span aria-hidden="true">→</span>
                            </a>
                          {% endif %}
                          <div class="relative inline-flex justify-end" data-double-confirm>
                            <button
                              type="button"
                              class="inline-flex items-center gap-1.5 rounded-full border border-red-200 bg-white/80 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-red-600 hover:border-red-300 hover:text-red-700 focus:outline-none focus:ring-2 focus:ring-red-200 focus:ring-offset-1"
                              data-double-confirm-trigger
                            >
                              <span>Eliminar</span>
                              <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M6.28 5.22a.75.75 0 011.06 0L10 7.939l2.66-2.72a.75.75 0 111.08 1.04L11.09 9l2.65 2.74a.75.75 0 11-1.08 1.04L10 10.06l-2.66 2.72a.75.75 0 11-1.08-1.04L8.91 9 6.25 6.26a.75.75 0 010-1.04z" clip-rule="evenodd" />
                              </svg>
                            </button>
                            <div class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-double-confirm-panel>
                              <div class="w-full max-w-sm rounded-xl border border-slate-200 bg-white p-4 text-left text-sm shadow-lg">
                                <p class="font-semibold text-slate-900">¿Eliminar la compra {{ purchase.timeline_code }}?</p>
                                <p class="mt-1 text-xs text-slate-500">Se eliminará todo su historial (items, aprobaciones y soportes).</p>
                                <div class="mt-3 flex justify-end gap-2">
                                  <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-double-confirm-cancel data-double-confirm-focus>Cancelar</button>
                                  <button type="button" class="inline-flex items-center rounded-full bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400" data-double-confirm-continue>Continuar</button>
                                </div>
                              </div>
                            </div>
                            <form method="post" action="{% url 'administration:purchases' %}" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-800/40 p-4" data-double-confirm-final>
                              {% csrf_token %}
                              <input type="hidden" name="panel" value="delete">
                              <input type="hidden" name="purchase" value="{{ purchase.pk }}">
                              <input type="hidden" name="scope" value="{{ purchases_scope.code }}">
                              {% if purchases_search %}<input type="hidden" name="search" value="{{ purchases_search }}">{% endif %}
                              {% if purchases_start_date %}<input type="hidden" name="start_date" value="{{ purchases_start_date }}">{% endif %}
                              {% if purchases_end_date %}<input type="hidden" name="end_date" value="{{ purchases_end_date }}">{% endif %}
                              {% for value in purchases_category_filters %}
                                <input type="hidden" name="category" value="{{ value }}">
                              {% endfor %}
                              {% for value in purchases_supplier_filters %}
                                <input type="hidden" name="supplier" value="{{ value }}">
                              {% endfor %}
                              {% for value in purchases_manager_filters %}
                                <input type="hidden" name="manager" value="{{ value }}">
                              {% endfor %}
                              {% if purchases_page %}<input type="hidden" name="page" value="{{ purchases_page.page_number }}">{% endif %}
                              <div class="w-full max-w-sm rounded-xl border border-red-200 bg-white p-4 text-left shadow-lg">
                                <p class="text-sm font-semibold text-red-700">Confirmación final</p>
                                <p class="mt-1 text-xs text-slate-500">Esta acción es irreversible y no podrás recuperar la solicitud.</p>
                                <div class="mt-3 flex justify-end gap-2">
                                  <button type="button" class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-100" data-double-confirm-cancel>Cancelar</button>
                                  <button type="submit" class="inline-flex items-center rounded-full bg-red-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300" data-double-confirm-final-submit data-double-confirm-focus>Eliminar definitivamente</button>
                                </div>
                              </div>
                            </form>
                          </div>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td
                      colspan="{% if purchases_scope.code == 'aprobacion' %}8{% else %}6{% endif %}"
                      class="px-6 py-16 text-center"
                    >
                      <div class="mx-auto max-w-lg space-y-2">
                        {% if purchases_search %}
                          <p class="text-base font-semibold text-slate-900">No encontramos coincidencias para “{{ purchases_search }}”</p>
                          <p class="text-sm text-slate-500">Intenta con otro término o limpia la búsqueda para ver todas las compras en este estado.</p>
                        {% elif purchases_start_date or purchases_end_date %}
                          <p class="text-base font-semibold text-slate-900">No hay compras en el rango seleccionado</p>
                          <p class="text-sm text-slate-500">Ajusta las fechas o limpia los filtros para ver más resultados.</p>
                        {% else %}
                          <p class="text-base font-semibold text-slate-900">Sin compras / gastos en este estado</p>
                          <p class="text-sm text-slate-500">Crea una nueva solicitud o ajusta el filtro para ver Compras / Gastos en otras etapas.</p>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          {% if purchases_page and purchases_page.num_pages > 1 %}
            <div class="flex flex-wrap items-center justify-between gap-3 border-t border-slate-200/70 bg-white/60 px-6 py-4 text-sm text-slate-500">
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                Página {{ purchases_page.page_number }} · {{ purchases_page.num_pages }}
              </p>
              <div class="flex flex-wrap items-center gap-2">
                {% if purchases_page.has_previous %}
                  <a
                    href="?scope={{ purchases_scope.code }}{{ purchases_filter_suffix }}&page={{ purchases_page.previous_page_number }}"
                    class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900"
                  >
                    ← Anterior
                  </a>
                {% else %}
                  <span class="rounded-full border border-transparent px-3 py-1 text-xs font-semibold text-slate-300">← Anterior</span>
                {% endif %}
                {% if purchases_page.has_next %}
                  <a
                    href="?scope={{ purchases_scope.code }}{{ purchases_filter_suffix }}&page={{ purchases_page.next_page_number }}"
                    class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-900"
                  >
                    Siguiente →
                  </a>
                {% else %}
                  <span class="rounded-full border border-transparent px-3 py-1 text-xs font-semibold text-slate-300">Siguiente →</span>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  {% if purchases_panel %}
    <div class="fixed inset-0 z-30 bg-slate-900/40"></div>
    <section
      class="fixed inset-y-0 right-0 z-40 flex h-full w-full max-w-[1380px] xl:max-w-[1500px] flex-col overflow-hidden border-l border-slate-200 bg-white shadow-2xl"
      role="dialog"
      aria-modal="true"
      aria-labelledby="side-panel-title"
    >
      <div class="flex flex-shrink-0 items-start justify-between border-b border-slate-200 px-6 py-4">
        <div>
          <p id="side-panel-title" class="text-lg font-semibold text-slate-900">{{ purchases_panel.panel.title }}</p>
          {% if purchases_panel.purchase %}
            <p class="text-xs uppercase tracking-wide text-slate-500">{{ purchases_panel.purchase.timeline_code }} · {{ purchases_panel.purchase.supplier }}</p>
          {% endif %}
        </div>
        <a
          href="?scope={{ purchases_scope.code }}{{ purchases_filter_suffix_with_page }}"
          class="text-sm font-medium text-slate-500 hover:text-slate-900"
        >
          Cerrar
        </a>
      </div>
      <div class="flex-1 overflow-y-auto p-6">
        <form method="post" action="{% url 'administration:purchases' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="scope" value="{{ purchases_scope.code }}">
          <input type="hidden" name="panel" value="{{ purchases_panel.panel.code }}">
          <input type="hidden" name="search" value="{{ purchases_search }}">
          <input type="hidden" name="start_date" value="{{ purchases_start_date }}">
          <input type="hidden" name="end_date" value="{{ purchases_end_date }}">
          {% for value in purchases_category_filters %}
            <input type="hidden" name="category" value="{{ value }}">
          {% endfor %}
          {% for value in purchases_supplier_filters %}
            <input type="hidden" name="supplier" value="{{ value }}">
          {% endfor %}
          {% for value in purchases_manager_filters %}
            <input type="hidden" name="manager" value="{{ value }}">
          {% endfor %}
          {% if purchases_page %}
            <input type="hidden" name="page" value="{{ purchases_page.page_number }}">
          {% endif %}
          {% if purchases_panel.purchase %}
            <input type="hidden" name="purchase" value="{{ purchases_panel.purchase.pk }}">
          {% endif %}
          {% include purchases_panel.panel.template_name %}
        </form>
      </div>
    </section>
  {% endif %}
  <script src="{% static 'administration/js/purchase-filters.js' %}" defer></script>
  <script type="module" src="{% static 'administration/js/purchase-bulk-actions.js' %}"></script>
{% endblock %}
