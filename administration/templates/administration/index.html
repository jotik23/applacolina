{% extends "calendario/base.html" %}

{% block title %}Administración · Compras{% endblock %}

{% block content %}
  {% include "administration/_submenu.html" with active=administration_active_submenu %}

  <section class="space-y-8">
    <header class="flex flex-col gap-4 rounded-2xl bg-white/90 p-6 shadow-sm ring-1 ring-slate-200/70 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Administración</p>
        <h1 class="text-2xl font-semibold text-slate-900">Compras</h1>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        {% if purchases_panel %}
          <a
            href="?scope={{ purchases_scope.code }}"
            class="inline-flex items-center gap-2 rounded-full border border-slate-200/80 bg-white px-4 py-2 text-sm font-medium text-slate-600 transition hover:border-slate-300 hover:text-slate-900"
          >
            <span aria-hidden="true" class="size-1.5 rounded-full bg-slate-400"></span>
            Cerrar formulario
          </a>
        {% endif %}
        <a
          href="?scope={{ purchases_scope.code }}&panel=request"
          class="inline-flex items-center gap-2 rounded-full bg-brand px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-brand/90"
        >
          <span aria-hidden="true" class="text-base">＋</span>
          Nueva compra
        </a>
      </div>
    </header>

    <div class="rounded-2xl bg-white/90 p-4 shadow-sm ring-1 ring-slate-200/70">
      <div class="flex flex-wrap gap-2 border-b border-slate-200/70 pb-4">
        {% for scope in purchases_scopes %}
          <a
            href="?scope={{ scope.code }}"
            class="group inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-semibold transition {% if scope.code == purchases_scope.code %}border-slate-900 bg-slate-900 text-white shadow{% else %}border-slate-200 bg-white text-slate-600 hover:border-slate-300 hover:text-slate-900{% endif %}"
            aria-current="{% if scope.code == purchases_scope.code %}page{% else %}false{% endif %}"
          >
            <span class="inline-flex size-5 items-center justify-center rounded-full text-xs font-bold {% if scope.code == purchases_scope.code %}bg-white/20 text-white{% else %}bg-slate-100 text-slate-500 group-hover:bg-slate-200 group-hover:text-slate-700{% endif %}">
              {{ scope.count }}
            </span>
            {{ scope.label }}
          </a>
        {% endfor %}
      </div>

      <div class="mt-4">
        <div class="overflow-hidden rounded-2xl border border-slate-200/70">
          <div class="flex items-center justify-between border-b border-slate-200/70 bg-slate-50/70 px-6 py-3">
            <div>
              <p class="text-sm font-semibold text-slate-900">{{ purchases_scope.label }}</p>
              <p class="text-xs text-slate-500">{{ purchases_scope.description }}</p>
            </div>
            <span class="text-xs font-semibold uppercase tracking-widest text-slate-400">Listado</span>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 text-sm">
              <thead class="bg-white text-left text-xs uppercase tracking-wide text-slate-500">
                <tr>
                  <th scope="col" class="px-6 py-3">Solicitud</th>
                  <th scope="col" class="px-6 py-3">Tercero</th>
                  <th scope="col" class="px-6 py-3">Categoría / Soporte</th>
                  {% if purchases_scope.code == 'aprobacion' %}
                    <th scope="col" class="px-6 py-3 text-center">Aprobaciones recibidas</th>
                    <th scope="col" class="px-6 py-3 text-center">Aprobaciones pendientes</th>
                  {% endif %}
                  <th scope="col" class="px-6 py-3 text-right">Monto</th>
                  <th scope="col" class="px-6 py-3 text-right">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100 bg-white">
                {% if purchases_list %}
                  {% for purchase in purchases_list %}
                    <tr class="align-top hover:bg-slate-50/70">
                      <td class="px-6 py-4">
                        <div class="flex flex-col gap-1">
                          <div class="flex items-center gap-2">
                            <p class="text-sm font-semibold text-slate-900">{{ purchase.description }}</p>
                            <span class="inline-flex items-center rounded-full bg-{{ purchase.status_palette }}-100 px-2 py-0.5 text-[11px] font-semibold text-{{ purchase.status_palette }}-700">
                              {{ purchase.status_badge }}
                            </span>
                          </div>
                          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{ purchase.timeline_code }}</p>
                          <div class="text-xs text-slate-500">
                            <span class="font-semibold text-slate-700">{{ purchase.requester }}</span>
                            ·
                            {{ purchase.scope_label }}
                          </div>
                          <p class="text-xs text-slate-500">Área: {{ purchase.area_label }}</p>
                        </div>
                      </td>
                      <td class="px-6 py-4 align-middle">
                        <div class="text-sm font-semibold text-slate-900">{{ purchase.supplier }}</div>
                        <p class="text-xs text-slate-500">Creada {{ purchase.created_on|date:"M d" }}{% if purchase.eta %} · ETA {{ purchase.eta|date:"M d" }}{% endif %}</p>
                      </td>
                      <td class="px-6 py-4 align-middle">
                        <p class="text-sm font-semibold text-slate-900">{{ purchase.category_name }}</p>
                        {% if purchase.support_type_label %}
                          <p class="text-xs text-slate-500">{{ purchase.support_type_label }}</p>
                        {% else %}
                          <p class="text-xs text-slate-400">Sin tipo de soporte</p>
                        {% endif %}
                      </td>
                      {% if purchases_scope.code == 'aprobacion' %}
                        <td class="px-6 py-4 align-middle">
                          {% if purchase.approvals_received %}
                            <ul class="space-y-1 text-sm text-slate-700">
                              {% for approver in purchase.approvals_received %}
                                <li class="flex items-center gap-2">
                                  <span class="inline-flex size-5 items-center justify-center rounded-full bg-emerald-100 text-[10px] font-bold text-emerald-700">✓</span>
                                  <span class="font-medium">{{ approver }}</span>
                                </li>
                              {% endfor %}
                            </ul>
                          {% else %}
                            <p class="text-xs text-slate-400">Sin aprobaciones</p>
                          {% endif %}
                        </td>
                        <td class="px-6 py-4 align-middle">
                          {% if purchase.approvals_pending %}
                            <ul class="space-y-1 text-sm text-slate-700">
                              {% for approver in purchase.approvals_pending %}
                                <li class="flex items-center gap-2">
                                  <span class="inline-flex size-5 items-center justify-center rounded-full bg-amber-100 text-[10px] font-bold text-amber-700">•</span>
                                  <span class="font-medium">{{ approver }}</span>
                                </li>
                              {% endfor %}
                            </ul>
                          {% else %}
                            <p class="text-xs text-slate-400">Sin pendientes</p>
                          {% endif %}
                        </td>
                      {% endif %}
                      <td class="px-6 py-4 text-right font-semibold text-slate-900 align-middle">
                        {{ purchase.total_display }}
                      </td>
                      <td class="px-6 py-4 text-right align-middle">
                        <div class="inline-flex flex-col gap-2 text-right">
                          {% if purchase.action %}
                            <a
                              href="?scope={{ purchases_scope.code }}&panel={{ purchase.action.panel }}&purchase={{ purchase.pk }}"
                              class="inline-flex items-center justify-end gap-2 text-sm font-semibold text-brand hover:text-brand/80"
                            >
                              {{ purchase.action.label }}
                              <span aria-hidden="true">→</span>
                            </a>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="{% if purchases_scope.code == 'aprobacion' %}7{% else %}5{% endif %}" class="px-6 py-16 text-center">
                      <div class="mx-auto max-w-lg space-y-2">
                        <p class="text-base font-semibold text-slate-900">Sin compras / gastos en este estado</p>
                        <p class="text-sm text-slate-500">Crea una nueva solicitud o ajusta el filtro para ver Compras / Gastos en otras etapas.</p>
                      </div>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  {% if purchases_panel %}
    <div class="fixed inset-0 z-30 bg-slate-900/40"></div>
    <section
      class="fixed inset-y-0 right-0 z-40 w-full max-w-4xl overflow-y-auto border-l border-slate-200 bg-white shadow-2xl"
      role="dialog"
      aria-modal="true"
      aria-labelledby="side-panel-title"
    >
      <div class="flex items-start justify-between border-b border-slate-200 px-6 py-4">
        <div>
          <p id="side-panel-title" class="text-lg font-semibold text-slate-900">{{ purchases_panel.panel.title }}</p>
          {% if purchases_panel.purchase %}
            <p class="text-xs uppercase tracking-wide text-slate-500">{{ purchases_panel.purchase.timeline_code }} · {{ purchases_panel.purchase.supplier }}</p>
          {% endif %}
        </div>
        <a href="?scope={{ purchases_scope.code }}" class="text-sm font-medium text-slate-500 hover:text-slate-900">Cerrar</a>
      </div>
      <div class="p-6">
        <form method="post" action="{% url 'administration:purchases' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="scope" value="{{ purchases_scope.code }}">
          <input type="hidden" name="panel" value="{{ purchases_panel.panel.code }}">
          {% if purchases_panel.purchase %}
            <input type="hidden" name="purchase" value="{{ purchases_panel.purchase.pk }}">
          {% endif %}
          {% include purchases_panel.panel.template_name %}
        </form>
      </div>
    </section>
  {% endif %}
{% endblock %}
