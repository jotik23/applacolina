{% extends "calendario/base.html" %}
{% load humanize form_extras %}

{% block title %}Ventas{% endblock %}

{% block content %}
  {% include "administration/_submenu.html" with active=administration_active_submenu %}

  <section class="space-y-4">
    <header class="flex flex-wrap items-center gap-4 rounded-2xl border border-slate-200/70 bg-white px-5 py-4 shadow-sm">
      <div class="min-w-[200px] grow">
        <p class="text-xs font-semibold uppercase tracking-wide text-sky-600">Cadena comercial</p>
        <h1 class="text-2xl font-semibold text-slate-900">Facturación</h1>
      </div>
      <form method="post" enctype="multipart/form-data" class="flex flex-col gap-1 rounded-2xl border border-dashed border-emerald-200/80 bg-emerald-50/70 px-3 py-2 text-xs font-semibold text-emerald-700 shadow-inner">
        {% csrf_token %}
        <input type="hidden" name="intent" value="import">
        <label class="sr-only" for="{{ import_form.workbook.id_for_label }}">{{ import_form.workbook.label }}</label>
        <div class="flex items-center gap-2">
          <span>Ventas y abonos (.xlsx)</span>
          {{ import_form.workbook|add_class:"block w-48 text-[11px] font-medium text-slate-700 file:mr-2 file:cursor-pointer file:rounded-lg file:border-0 file:bg-emerald-600 file:px-3 file:py-1 file:text-xs file:font-semibold file:text-white hover:file:bg-emerald-500" }}
          <button
            type="submit"
            class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-3 py-1 text-[11px] font-semibold text-white shadow-sm transition hover:bg-emerald-500"
          >
            Importar
          </button>
        </div>
        <p class="text-[10px] font-normal text-emerald-700/80">Ubica el archivo con hojas Ventas, Abonos y Terceros.</p>
        {% if import_form.workbook.errors %}
          <p class="text-[11px] text-rose-600">{{ import_form.workbook.errors|striptags }}</p>
        {% endif %}
      </form>
      <a
        href="{% url 'administration:sale-create' %}"
        class="inline-flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800"
      >
        Registrar venta
      </a>
    </header>

    <div class="overflow-x-auto rounded-2xl border border-slate-200/70 bg-white shadow-sm">
      <table class="min-w-full divide-y divide-slate-100 text-sm text-slate-700">
        <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
          <tr>
            <th class="px-4 py-3 text-left">Fecha</th>
            <th class="px-4 py-3 text-left">Cliente</th>
            <th class="px-4 py-3 text-left">Estado</th>
            <th class="px-4 py-3 text-left">Condición</th>
            <th class="px-4 py-3 text-right">Total</th>
            <th class="px-4 py-3 text-right">Abonos</th>
            <th class="px-4 py-3 text-right">Saldo</th>
            <th class="px-4 py-3 text-left">Bodega</th>
            <th class="px-4 py-3 text-left">Vendedor</th>
            <th class="px-4 py-3 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for sale in sales %}
            <tr class="align-top">
              <td class="px-4 py-3 text-sm font-semibold text-slate-900">{{ sale.date|date:"d/m/Y" }}</td>
              <td class="px-4 py-3">
                <p class="font-semibold text-slate-900">{{ sale.customer.name }}</p>
                {% if sale.notes %}
                  <p class="mt-1 text-xs text-slate-500">{{ sale.notes }}</p>
                {% endif %}
              </td>
              <td class="px-4 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500">{{ sale.get_status_display }}</td>
              <td class="px-4 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500">{{ sale.get_payment_condition_display }}</td>
              <td class="px-4 py-3 text-right font-semibold text-slate-900">{{ sale.total_amount|money_co }}</td>
              <td class="px-4 py-3 text-right text-slate-600">{{ sale.payments_total|money_co }}</td>
              <td class="px-4 py-3 text-right font-semibold {% if sale.balance_due > 0 %}text-rose-600{% else %}text-emerald-600{% endif %}">
                {{ sale.balance_due|money_co }}
              </td>
              <td class="px-4 py-3">
                {{ sale.inventory_destination_label|default:"—" }}
              </td>
              <td class="px-4 py-3">
                {{ sale.seller.get_full_name|default:sale.seller.get_username }}
              </td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2 text-sm">
                  <a
                    href="{% url 'administration:sale-update' sale.pk %}"
                    class="inline-flex items-center justify-center rounded-md border border-slate-200 px-2.5 py-1.5 text-slate-600 transition hover:border-slate-400 hover:text-slate-800"
                    title="Gestionar venta y abonos"
                  >
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path d="M4 13.5V16h2.5L15.29 7.21a1 1 0 000-1.42l-1.08-1.08a1 1 0 00-1.42 0L4 13.5zm9.71-8.79l1.08 1.08-1.08 1.08-1.08-1.08 1.08-1.08zM3 17a1 1 0 001 1h12a1 1 0 100-2H5a1 1 0 00-1 1z" />
                    </svg>
                  </a>
                  <form
                    method="post"
                    action="{% url 'administration:sales' %}"
                    class="inline-flex"
                    onsubmit="return confirm('¿Seguro que deseas eliminar la venta #{{ sale.pk }}? Esta acción no se puede deshacer.');"
                  >
                    {% csrf_token %}
                    <input type="hidden" name="intent" value="delete">
                    <input type="hidden" name="sale_id" value="{{ sale.pk }}">
                    <button
                      type="submit"
                      class="inline-flex items-center justify-center rounded-md border border-rose-200 px-2.5 py-1.5 text-rose-600 transition hover:border-rose-400 hover:text-rose-700"
                      title="Eliminar venta"
                    >
                      <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M8.257 3.099c.366-.446.943-.699 1.543-.699h.4c.6 0 1.177.253 1.543.699L12.414 4H15a1 1 0 010 2h-.25l-.916 10.082A2 2 0 0111.84 18H8.16a2 2 0 01-1.994-1.918L5.25 6H5a1 1 0 110-2h2.586l.671-.901zM7.257 6l.75 9h4.086l.75-9H7.257z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="10" class="px-4 py-6 text-center text-sm text-slate-500">
                Registra una venta para empezar a monitorear facturación y abonos.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}
