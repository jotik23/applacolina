{% extends "calendario/base.html" %}
{% load static form_extras humanize %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
  {% include "administration/_submenu.html" with active=administration_active_submenu %}

  <div class="relative">
    <div class="fixed inset-0 z-30 bg-slate-900/60 backdrop-blur-sm"></div>
    <section class="fixed inset-y-0 right-0 z-40 flex max-w-full pl-4 sm:pl-8 lg:pl-16">
      <div class="pointer-events-auto w-screen max-w-5xl">
        <div class="flex h-full flex-col overflow-hidden rounded-l-[2.4rem] bg-white shadow-2xl ring-1 ring-slate-200/80">
          <header class="border-b border-slate-100 bg-gradient-to-r from-white via-emerald-50/80 to-white px-5 py-5">
            <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
              <div class="space-y-2 max-w-2xl">
                <p class="text-xs font-semibold uppercase tracking-wide text-emerald-500">
                  {{ current_customer_name }}
                </p>
                <h1 class="text-3xl font-semibold text-slate-900">{{ page_title }}</h1>
              </div>
              <div class="flex flex-col gap-3 lg:min-w-[640px]">
                <div class="flex flex-wrap items-start gap-3">
                  {% with summary=financial_snapshot %}
                  <div
                    class="grid gap-3 rounded-2xl border border-slate-200 bg-white/80 px-4 py-3 text-[10px] font-semibold uppercase tracking-wide text-slate-500 shadow-sm shadow-slate-200/70 sm:grid-cols-3 lg:grid-cols-5"
                    data-sale-summary-container
                  >
                    <div class="text-left">
                      <dt class="text-[10px] text-slate-500">Descuento</dt>
                      <dd class="mt-1 text-base font-semibold text-slate-900" data-sale-summary="discount">{{ summary.discount|money_co }}</dd>
                    </div>
                    <div class="text-left">
                      <dt class="text-[10px] text-slate-500">Autorretención</dt>
                      <dd class="mt-1 text-base font-semibold text-slate-900" data-sale-summary="withholding">{{ summary.withholding|money_co }}</dd>
                    </div>
                    <div class="text-left">
                      <dt class="text-[10px] text-slate-500">Total neto</dt>
                      <dd class="mt-1 text-base font-semibold text-slate-900" data-sale-summary="total">{{ summary.total|money_co }}</dd>
                    </div>
                    {% if sale %}
                      <div class="text-left">
                        <dt class="text-[10px] text-slate-500">Abonos</dt>
                        <dd class="mt-1 text-base font-semibold text-slate-900">{{ sale.payments_total|money_co }}</dd>
                      </div>
                      <div class="text-left">
                        <dt class="text-[10px] text-slate-500">Saldo</dt>
                        <dd class="mt-1 text-base font-semibold {% if sale.balance_due > 0 %}text-rose-600{% else %}text-emerald-600{% endif %}">
                          {{ sale.balance_due|money_co }}
                        </dd>
                      </div>
                    {% endif %}
                  </div>
                {% endwith %}
                  <a
                    href="{{ cancel_url }}"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition hover:border-slate-400 hover:text-slate-700"
                  >
                    <span class="sr-only">Cerrar panel</span>
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.22 5.22a.75.75 0 011.06 0L10 8.94l3.72-3.72a.75.75 0 111.06 1.06L11.06 10l3.72 3.72a.75.75 0 11-1.06 1.06L10 11.06l-3.72 3.72a.75.75 0 11-1.06-1.06L8.94 10 5.22 6.28a.75.75 0 010-1.06z" clip-rule="evenodd" />
                    </svg>
                  </a>
                </div>
              </div>
            </div>
          </header>

          <div
            class="flex-1 overflow-y-auto bg-gradient-to-b from-white via-white to-slate-50"
            data-sale-tabs
            data-sale-active-tab="{{ active_tab }}"
          >
            {% if form.non_field_errors %}
              <div class="border-b border-rose-200 bg-rose-50/80 px-5 py-3 text-sm text-rose-700">
                {% for error in form.non_field_errors %}
                  <p>{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}
            {% if sale %}
              <div class="sticky top-0 z-30 bg-white/95 px-5 pb-2 pt-3 shadow-sm shadow-slate-200/60 ring-1 ring-slate-100">
                <div class="inline-flex gap-1 rounded-full bg-slate-100 p-1 text-sm font-semibold">
                  <button
                    type="button"
                    data-sale-tab-trigger="form"
                    class="rounded-full border px-4 py-1.5 {% if active_tab == 'form' %}border-emerald-200 bg-emerald-50 text-emerald-700{% else %}border-transparent text-slate-500{% endif %}"
                    aria-controls="sale-tab-form"
                    data-sale-selected="{% if active_tab == 'form' %}true{% else %}false{% endif %}"
                  >
                    Detalle de venta
                  </button>
                  <button
                    type="button"
                    data-sale-tab-trigger="payments"
                    class="rounded-full border px-4 py-1.5 {% if active_tab == 'payments' %}border-emerald-200 bg-emerald-50 text-emerald-700{% else %}border-transparent text-slate-500{% endif %}"
                    aria-controls="sale-tab-payments"
                    data-sale-selected="{% if active_tab == 'payments' %}true{% else %}false{% endif %}"
                  >
                    Gestión de abonos
                  </button>
                </div>
              </div>
            {% endif %}
            <div data-sale-tab-panel="form" id="sale-tab-form" class="{% if active_tab != 'form' %}hidden{% endif %}">
              <form method="post" class="space-y-6 px-5 pb-6" novalidate data-sale-form-panel>
              {% csrf_token %}
              <section class="space-y-3 rounded-2xl border border-slate-200/70 bg-white/95 p-4 shadow-sm">
                <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-4">
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
                    {{ form.date|add_class:"mt-1" }}
                    {% if form.date.errors %}
                      <p class="text-xs text-rose-600">{{ form.date.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.customer.id_for_label }}">{{ form.customer.label }}</label>
                    {{ form.customer|add_class:"mt-1" }}
                    {% if form.customer.errors %}
                      <p class="text-xs text-rose-600">{{ form.customer.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.payment_condition.id_for_label }}">{{ form.payment_condition.label }}</label>
                    {{ form.payment_condition|add_class:"mt-1" }}
                    {% if form.payment_condition.errors %}
                      <p class="text-xs text-rose-600">{{ form.payment_condition.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.payment_due_date.id_for_label }}">{{ form.payment_due_date.label }}</label>
                    {{ form.payment_due_date|add_class:"mt-1" }}
                    {% if form.payment_due_date.errors %}
                      <p class="text-xs text-rose-600">{{ form.payment_due_date.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.warehouse_destination.id_for_label }}">{{ form.warehouse_destination.label }}</label>
                    {{ form.warehouse_destination|add_class:"mt-1" }}
                    {% if form.warehouse_destination.errors %}
                      <p class="text-xs text-rose-600">{{ form.warehouse_destination.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
                    {{ form.status|add_class:"mt-1" }}
                    {% if form.status.errors %}
                      <p class="text-xs text-rose-600">{{ form.status.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.seller.id_for_label }}">{{ form.seller.label }}</label>
                    {{ form.seller|add_class:"mt-1" }}
                    {% if form.seller.errors %}
                      <p class="text-xs text-rose-600">{{ form.seller.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.invoice_number.id_for_label }}">{{ form.invoice_number.label }}</label>
                    {{ form.invoice_number|add_class:"mt-1" }}
                    {% if form.invoice_number.errors %}
                      <p class="text-xs text-rose-600">{{ form.invoice_number.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.sent_to_dian.id_for_label }}">{{ form.sent_to_dian.label }}</label>
                    <div class="mt-1 flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2">
                      {{ form.sent_to_dian }}
                      <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">Marcala si ya se envió.</span>
                    </div>
                    {% if form.sent_to_dian.errors %}
                      <p class="text-xs text-rose-600">{{ form.sent_to_dian.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.discount_amount.id_for_label }}">{{ form.discount_amount.label }}</label>
                    {{ form.discount_amount|add_class:"mt-1" }}
                    {% if form.discount_amount.errors %}
                      <p class="text-xs text-rose-600">{{ form.discount_amount.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div class="md:col-span-2 lg:col-span-4">
                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                    {{ form.notes|add_class:"mt-1" }}
                    {% if form.notes.errors %}
                      <p class="text-xs text-rose-600">{{ form.notes.errors|striptags }}</p>
                    {% endif %}
                  </div>
                </div>
              </section>

              <section class="space-y-3 rounded-2xl border border-slate-200/70 bg-white/95 p-4 shadow-sm">
                <header class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-100 pb-3">
                  <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Detalle de productos</p>

                  </div>
                  <p class="text-xs text-slate-500">Los cálculos se actualizan conforme escribes.</p>
                </header>
                <div class="overflow-x-auto">
                  <table class="mt-2 w-full min-w-[640px] border-collapse text-sm text-slate-600">
                    <thead>
                      <tr class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                        <th class="px-3 py-2 text-left">Producto</th>
                        <th class="px-3 py-2 text-left">Inventario</th>
                        <th class="px-3 py-2 text-right">Cantidad (cart)</th>
                        <th class="px-3 py-2 text-right">Precio unitario (COP)</th>
                        <th class="px-3 py-2 text-right">Subtotal</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in form.product_rows %}
                        {% with available=product_inventory_map|dict_get:row.code %}
                          <tr
                            class="border-t border-slate-100"
                            data-sale-product-row="{{ row.code }}"
                            data-sale-quantity-name="{{ row.quantity_field.name }}"
                            data-sale-price-name="{{ row.price_field.name }}"
                            data-sale-available="{{ available|default_if_none:'' }}"
                          >
                            <td class="px-3 py-3 font-semibold text-slate-900">{{ row.label }}</td>
                            <td class="px-3 py-3 text-xs">
                              <p class="font-semibold text-slate-900" data-sale-inventory-available>
                                {% if available is not None %}
                                  {{ available|cartons }} cart disponibles
                                {% else %}
                                  —
                                {% endif %}
                              </p>
                              <p class="text-slate-500" data-sale-inventory-remaining>Saldo tras pedido: —</p>
                            </td>
                            <td class="px-3 py-3">
                              {{ row.quantity_field|add_class:"text-right" }}
                              {% if row.quantity_field.errors %}
                                <p class="text-xs text-rose-600">{{ row.quantity_field.errors|striptags }}</p>
                              {% endif %}
                            </td>
                            <td class="px-3 py-3">
                              {{ row.price_field|add_class:"text-right" }}
                              {% if row.price_field.errors %}
                                <p class="text-xs text-rose-600">{{ row.price_field.errors|striptags }}</p>
                              {% endif %}
                            </td>
                            <td class="px-3 py-3 text-right font-semibold text-slate-900" data-sale-subtotal>—</td>
                          </tr>
                        {% endwith %}
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </section>

              <div class="flex flex-wrap items-center justify-between gap-3">
                <a href="{{ cancel_url }}" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300">Cancelar</a>
                <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500">
                  {{ submit_label }}
                </button>
              </div>
              </form>
            </div>

            {% if sale %}
            <div
              data-sale-tab-panel="payments"
              id="sale-tab-payments"
              class="space-y-5 border-t border-slate-100 bg-white/80 px-5 py-6 {% if active_tab != 'payments' %}hidden{% endif %}"
            >
                <article class="rounded-2xl border border-slate-200/70 bg-white p-4 shadow-sm">
                  <header class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-100 pb-3">
                    <div>
                      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Historial de abonos</p>
                      <h2 class="text-lg font-semibold text-slate-900">Abonos registrados</h2>
                    </div>
                    <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{ payments|length }} registro{{ payments|length|pluralize }}</span>
                  </header>
                  {% if payments %}
                    <ul class="divide-y divide-slate-100">
                      {% for payment in payments %}
                        <li class="flex items-center justify-between py-3 text-sm text-slate-600">
                          <div>
                            <p class="font-semibold text-slate-900">{{ payment.date|date:"d/m/Y" }} · {{ payment.get_method_display }}</p>
                            {% if payment.notes %}
                              <p class="text-xs text-slate-500">{{ payment.notes }}</p>
                            {% endif %}
                          </div>
                          <p class="font-semibold text-slate-900">{{ payment.amount|floatformat:0|intcomma }} COP</p>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="py-4 text-sm text-slate-500">Cuando registres abonos aparecerán aquí para tener trazabilidad inmediata.</p>
                  {% endif %}
                </article>
                <article class="rounded-2xl border border-slate-200/70 bg-white p-4 shadow-sm">
                  <header class="border-b border-slate-100 pb-3">
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Registrar abono</p>
                    <h2 class="text-lg font-semibold text-slate-900">Control de cartera</h2>
                    <p class="text-xs text-slate-500">Registra pagos parciales o totales para mantener el saldo actualizado.</p>
                  </header>
                  {% if payment_form.non_field_errors %}
                    <div class="mt-3 rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700">
                      {% for error in payment_form.non_field_errors %}
                        <p>{{ error }}</p>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <form method="post" class="mt-4 space-y-3" novalidate>
                    {% csrf_token %}
                    <input type="hidden" name="intent" value="payment">
                    <div class="grid gap-3 md:grid-cols-3">
                      <div>
                        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ payment_form.date.id_for_label }}">{{ payment_form.date.label }}</label>
                        {{ payment_form.date|add_class:"mt-1" }}
                        {% if payment_form.date.errors %}
                          <p class="text-xs text-rose-600">{{ payment_form.date.errors|striptags }}</p>
                        {% endif %}
                      </div>
                      <div>
                        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ payment_form.amount.id_for_label }}">{{ payment_form.amount.label }}</label>
                        {{ payment_form.amount|add_class:"mt-1" }}
                        {% if payment_form.amount.errors %}
                          <p class="text-xs text-rose-600">{{ payment_form.amount.errors|striptags }}</p>
                        {% endif %}
                      </div>
                      <div>
                        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ payment_form.method.id_for_label }}">{{ payment_form.method.label }}</label>
                        {{ payment_form.method|add_class:"mt-1" }}
                        {% if payment_form.method.errors %}
                          <p class="text-xs text-rose-600">{{ payment_form.method.errors|striptags }}</p>
                        {% endif %}
                      </div>
                    </div>
                    <div class="md:col-span-3">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="{{ payment_form.notes.id_for_label }}">{{ payment_form.notes.label }}</label>
                      {{ payment_form.notes|add_class:"mt-1" }}
                      {% if payment_form.notes.errors %}
                        <p class="text-xs text-rose-600">{{ payment_form.notes.errors|striptags }}</p>
                      {% endif %}
                    </div>
                    <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800">
                      Registrar abono
                    </button>
                  </form>
                </article>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </section>
  </div>

  <script src="{% static 'administration/js/sales-form.js' %}" defer></script>
{% endblock %}
